<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä¿®å¤ Conda å¯¼è‡´çš„ PowerShell å¯åŠ¨ç¼“æ…¢</title>
      <link href="/2025/12/12/TechnicalNotes/PowerShellCondaFix/"/>
      <url>/2025/12/12/TechnicalNotes/PowerShellCondaFix/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¿®å¤-conda-å¯¼è‡´çš„-powershell-å¯åŠ¨ç¼“æ…¢">ä¿®å¤ Conda å¯¼è‡´çš„PowerShell å¯åŠ¨ç¼“æ…¢</h1><h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h2><p>æ¯æ¬¡å¯åŠ¨ PowerShellæ—¶éƒ½æœ‰æ˜æ˜¾çš„å¡é¡¿ï¼Œå¯åŠ¨æ—¶é—´é•¿è¾¾æ•°ç§’ã€‚ç»è¿‡æ’æŸ¥ï¼Œå‘ç°è¿™æ˜¯ç”±äº Condaçš„åˆå§‹åŒ–è„šæœ¬å¯¼è‡´çš„ã€‚</p><h2 id="åŸå› ">åŸå› </h2><p>åœ¨ä½¿ç”¨ <code>conda init</code> å‘½ä»¤é…ç½® PowerShell ç¯å¢ƒæ—¶ï¼ŒCondaä¼šå‘é…ç½®æ–‡ä»¶ï¼ˆProfileï¼‰ä¸­æ³¨å…¥ä¸€æ®µåˆå§‹åŒ–ä»£ç ã€‚è¿™æ®µä»£ç ä¼šåœ¨æ¯æ¬¡å¯åŠ¨PowerShell æ—¶ç«‹å³æ‰§è¡Œï¼ŒåŠ è½½æ•´ä¸ª Conda ç¯å¢ƒï¼Œä»è€Œæ‹–æ…¢å¯åŠ¨é€Ÿåº¦ã€‚</p><h2 id="æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹</h2><ol type="1"><li><p><strong>æµ‹è¯•å½“å‰å¯åŠ¨æ—¶é—´</strong> ä½¿ç”¨<code>Measure-Command</code> æµ‹è¯•åŠ è½½é…ç½®æ–‡ä»¶çš„å¯åŠ¨è€—æ—¶ï¼š</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Measure-Command</span> <span class="token punctuation">&#123;</span> pwsh<span class="token punctuation">.</span>exe <span class="token operator">-</span>Command <span class="token string">"exit"</span> <span class="token punctuation">&#125;</span></code></pre><p>æµ‹è¯•ç»“æœæ˜¾ç¤ºéœ€è¦çº¦ 5 ç§’ã€‚</p></li><li><p><strong>æµ‹è¯•è£¸å¯åŠ¨æ—¶é—´</strong>æµ‹è¯•ä¸åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆ<code>-NoProfile</code>ï¼‰çš„å¯åŠ¨è€—æ—¶ï¼š</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Measure-Command</span> <span class="token punctuation">&#123;</span> pwsh<span class="token punctuation">.</span>exe <span class="token operator">-</span>NoProfile <span class="token operator">-</span>Command <span class="token string">"exit"</span> <span class="token punctuation">&#125;</span></code></pre><p>ç»“æœä»…éœ€ 0.5ç§’å·¦å³ã€‚å·¨å¤§çš„æ—¶é—´å·®å¼‚è¯å®äº†é—®é¢˜å‡ºåœ¨é…ç½®æ–‡ä»¶ï¼ˆProfileï¼‰çš„åŠ è½½è¿‡ç¨‹ä¸­ã€‚</p></li><li><p><strong>å®šä½é…ç½®æ–‡ä»¶</strong></p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$PROFILE</span> <span class="token punctuation">|</span> <span class="token function">Get-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty</code></pre></li><li><p><strong>åˆ†æé…ç½®æ–‡ä»¶å†…å®¹</strong> æ‰“å¼€é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯<code>CurrentUserAllHosts</code>ï¼‰ï¼Œæ‰¾åˆ° Conda æ³¨å…¥çš„ä»£ç å—ï¼š</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment">#region conda initialize</span><span class="token comment"># !! Contents within this block are managed by 'conda init' !!</span><span class="token keyword">If</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token string">"xx\Scripts\conda.exe"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">(</span>&amp; <span class="token string">"xx\Scripts\conda.exe"</span> <span class="token string">"shell.powershell"</span> <span class="token string">"hook"</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-String</span> <span class="token punctuation">|</span> ?<span class="token punctuation">&#123;</span><span class="token variable">$_</span><span class="token punctuation">&#125;</span> <span class="token punctuation">|</span> <span class="token function">Invoke-Expression</span><span class="token punctuation">&#125;</span><span class="token comment">#endregion</span></code></pre></li><li><p><strong>éªŒè¯å‡è®¾</strong>ä¸´æ—¶æ³¨é‡Šæ‰ä¸Šè¿°ä»£ç å—åï¼Œå†æ¬¡æµ‹è¯•å¯åŠ¨æ—¶é—´ï¼š</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Measure-Command</span> <span class="token punctuation">&#123;</span> pwsh<span class="token punctuation">.</span>exe <span class="token operator">-</span>Command <span class="token string">"exit"</span> <span class="token punctuation">&#125;</span><span class="token function">Measure-Command</span> <span class="token punctuation">&#123;</span> pwsh<span class="token punctuation">.</span>exe <span class="token operator">-</span>NoProfile <span class="token operator">-</span>Command <span class="token string">"exit"</span> <span class="token punctuation">&#125;</span></code></pre><p>å‘ç°ä¸è£¸å¯åŠ¨æ—¶é—´åŸºæœ¬æŒå¹³ï¼Œç¡®è®¤è¯¥æ®µä»£ç æ˜¯æ€§èƒ½ç“¶é¢ˆçš„æ ¹æºã€‚</p></li></ol><h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2><p>ç›´æ¥æ³¨é‡Šæ‰ä»£ç è™½ç„¶èƒ½è§£å†³å¯åŠ¨æ…¢çš„é—®é¢˜ï¼Œä½†ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨<code>conda</code> å‘½ä»¤ã€‚æ›´å¥½çš„æ–¹æ¡ˆæ˜¯å°†åŒæ­¥åˆå§‹åŒ–æ”¹ä¸º<strong>æ‡’åŠ è½½ï¼ˆLazyLoadingï¼‰</strong>ï¼šä»…åœ¨é¦–æ¬¡è¾“å…¥ <code>conda</code>å‘½ä»¤æ—¶æ‰æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚</p><p>æ³¨ï¼šåªéœ€å°†è„šæœ¬ä¸­çš„ xx.exe æ›¿æ¢ä¸ºä½ å®é™…çš„ conda å®‰è£…è·¯å¾„å³å¯ã€‚</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment">#region conda initialize</span><span class="token comment"># ===== é…ç½®ï¼šğŸ›‘ æ”¹ä¸ºå®é™…çš„ conda.exe è·¯å¾„ =====</span><span class="token variable">$script</span>:CondaExePath = <span class="token string">'xx\Scripts\conda.exe'</span><span class="token comment"># ===== ä¸»é€»è¾‘ =====</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token operator">-</span>LiteralPath <span class="token variable">$script</span>:CondaExePath <span class="token operator">-</span>PathType Leaf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment"># çŠ¶æ€æ ‡è®°ï¼šé˜²æ­¢é€’å½’è°ƒç”¨</span>    <span class="token variable">$script</span>:CondaInitialized = <span class="token boolean">$false</span>        <span class="token comment"># å®šä¹‰æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘</span>    <span class="token keyword">function</span> Global:<span class="token function">Invoke-CondaInit</span> <span class="token punctuation">&#123;</span>                <span class="token comment"># åªæœ‰æœªåˆå§‹åŒ–æ—¶æ‰æ‰§è¡Œ hook é€»è¾‘</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$script</span>:CondaInitialized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">Write-Host</span> <span class="token string">"ğŸ”„ Condaå°šæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ– Conda..."</span> <span class="token operator">-</span>ForegroundColor Cyan            <span class="token variable">$script</span>:CondaInitialized = <span class="token boolean">$true</span>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token comment"># 1. è·å– Hook è„šæœ¬ (å±è”½ stderr è­¦å‘Š)</span>                <span class="token variable">$hookOutput</span> = &amp; <span class="token variable">$script</span>:CondaExePath <span class="token string">'shell.powershell'</span> <span class="token string">'hook'</span> 2><span class="token variable">$null</span>                <span class="token variable">$exitCode</span> = <span class="token variable">$LASTEXITCODE</span>                                <span class="token comment"># 2. ä¸¥æ ¼æ£€æŸ¥ï¼šä»»ä½•å¼‚å¸¸ç›´æ¥æŠ¥é”™</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exitCode</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token string">"Conda hook è¿›ç¨‹é€€å‡ºç å¼‚å¸¸: <span class="token variable">$exitCode</span>"</span> <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token namespace">[string]</span>::IsNullOrWhiteSpace<span class="token punctuation">(</span><span class="token variable">$hookOutput</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token string">"Conda hook è¿”å›ç©ºå†…å®¹"</span> <span class="token punctuation">&#125;</span>                                <span class="token comment"># 3. æ‰§è¡Œå®˜æ–¹ Hook</span>                <span class="token function">Invoke-Expression</span> <span class="token punctuation">(</span><span class="token variable">$hookOutput</span> <span class="token punctuation">|</span> <span class="token function">Out-String</span><span class="token punctuation">)</span>                                <span class="token comment"># 4. åŒé‡ä¿é™©ï¼šç¡®ä¿ Global ä½œç”¨åŸŸç”Ÿæ•ˆ</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token variable">$fn</span> = <span class="token function">Get-Command</span> conda <span class="token operator">-</span>CommandType <span class="token keyword">Function</span> <span class="token operator">-</span>ErrorAction Stop                    <span class="token function">Set-Item</span> <span class="token operator">-</span>Path <span class="token keyword">Function</span>:\Global:conda <span class="token operator">-</span>Value <span class="token variable">$fn</span><span class="token punctuation">.</span>ScriptBlock <span class="token operator">-</span>Force                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">throw</span> <span class="token string">"Hook æ‰§è¡Œåæœªæ£€æµ‹åˆ° conda å‡½æ•°ï¼Œç¯å¢ƒå¯èƒ½å·²æŸå"</span>                <span class="token punctuation">&#125;</span>                                <span class="token function">Write-Host</span> <span class="token string">"âœ“ Conda åˆå§‹åŒ–æˆåŠŸï¼Œè¯·é‡æ–°è¾“å…¥ conda å‘½ä»¤"</span> <span class="token operator">-</span>ForegroundColor Green            <span class="token punctuation">&#125;</span>            <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>                <span class="token comment"># å¤±è´¥å¤„ç†ï¼šé‡ç½®çŠ¶æ€å¹¶ç›´æ¥æŠ›å‡ºè‡´å‘½é”™è¯¯</span>                <span class="token variable">$script</span>:CondaInitialized = <span class="token boolean">$false</span>                <span class="token function">Write-Error</span> <span class="token string">"Conda åˆå§‹åŒ–å¤±è´¥: <span class="token function">$<span class="token punctuation">(</span><span class="token variable">$_</span><span class="token punctuation">.</span>Exception<span class="token punctuation">.</span>Message<span class="token punctuation">)</span></span>"</span> <span class="token operator">-</span>ErrorAction Stop            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment"># å®šä¹‰ä»£ç†è„šæœ¬å—</span>    <span class="token variable">$proxyScript</span> = <span class="token punctuation">&#123;</span> <span class="token function">Invoke-CondaInit</span> <span class="token punctuation">&#125;</span>        <span class="token comment"># åº”ç”¨ä»£ç†ï¼šæ‹¦æˆªé¦–æ¬¡è°ƒç”¨</span>    <span class="token function">Set-Item</span> <span class="token keyword">Function</span>:\Global:conda <span class="token operator">-</span>Value <span class="token variable">$proxyScript</span> <span class="token operator">-</span>Force    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment"># è·¯å¾„é…ç½®é”™è¯¯çš„æŠ¥é”™é€»è¾‘</span>    <span class="token function">Write-Warning</span> <span class="token string">"æœªæ‰¾åˆ° Conda: <span class="token variable">$script</span>:CondaExePath"</span>        <span class="token keyword">function</span> Global:conda <span class="token punctuation">&#123;</span>        <span class="token function">Write-Error</span> <span class="token string">"Conda é…ç½®è·¯å¾„æ— æ•ˆ: <span class="token variable">$script</span>:CondaExePath"</span> <span class="token operator">-</span>ErrorAction Stop    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">#endregion</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>DNSã€ç«¯å£ã€å®‰å…¨ç»„ä¸åå‘ä»£ç†</title>
      <link href="/2025/12/10/Web/DNS%20%E7%AB%AF%E5%8F%A3%20%E5%AE%89%E5%85%A8%E7%BB%84%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
      <url>/2025/12/10/Web/DNS%20%E7%AB%AF%E5%8F%A3%20%E5%AE%89%E5%85%A8%E7%BB%84%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="dnsç«¯å£å®‰å…¨ç»„ä¸åå‘ä»£ç†">DNSã€ç«¯å£ã€å®‰å…¨ç»„ä¸åå‘ä»£ç†</h1><h2 id="dnsåªè´Ÿè´£åŸŸå-ip-çš„æ˜ å°„">1. DNSï¼šåªè´Ÿè´£â€œåŸŸå â†’ IP çš„æ˜ å°„â€</h2><p>DNSï¼ˆåŸŸåè§£æï¼‰åªåšä¸€ä»¶äº‹ï¼š</p><pre class="language-none"><code class="language-none">xx.example.com â†’ æœåŠ¡å™¨å…¬ç½‘ IP</code></pre><p>å®ƒ<strong>ä¸æ¶‰åŠç«¯å£ã€ä¸æ¶‰åŠé˜²ç«å¢™ã€ä¸æ¶‰åŠå®‰å…¨ç­–ç•¥</strong>ã€‚ä½ åªæ˜¯å‘Šè¯‰å…¨çƒçš„ DNS æœåŠ¡å™¨ï¼š</p><blockquote><p>â€œè®¿é—®è¿™ä¸ªåŸŸåï¼Œè¯·å»æ‰¾è¿™å°æœåŠ¡å™¨ã€‚â€</p></blockquote><hr /><h2 id="ç«¯å£æœåŠ¡ç›‘å¬çš„ä½ç½®">2. ç«¯å£ï¼šæœåŠ¡ç›‘å¬çš„ä½ç½®</h2><p>æœåŠ¡å™¨ä¸Šçš„æ¯ä¸€ä¸ªæœåŠ¡ï¼Œéƒ½éœ€è¦ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œä¾‹å¦‚ï¼š</p><table><thead><tr><th>æœåŠ¡</th><th>é»˜è®¤ç«¯å£</th><th>æ˜¯å¦éœ€å¯¹å¤–å¼€æ”¾ï¼Ÿ</th></tr></thead><tbody><tr><td>HTTP</td><td>80</td><td>âœ” é€šå¸¸å¼€æ”¾</td></tr><tr><td>HTTPS</td><td>443</td><td>âœ” é€šå¸¸å¼€æ”¾</td></tr><tr><td>xx åç«¯</td><td>1234</td><td>âŒ ä¸éœ€è¦å¼€æ”¾</td></tr></tbody></table><p>å¦‚æœä½ çš„ xx è¿è¡Œåœ¨ï¼š<code>127.0.0.1:1234</code>ï¼Œé‚£ä¹ˆå®ƒåªå…è®¸<strong>æœ¬æœºè®¿é—®</strong>ã€‚å¤–ç½‘æ— è®ºå¦‚ä½•éƒ½æ— æ³•è®¿é—®è¿™ä¸ªç«¯å£ï¼Œå³ä½¿å®‰å…¨ç»„æ”¾è¡Œäº† 1234 ç«¯å£ã€‚</p><p>å¦‚æœä½ çš„ xx è¿è¡Œåœ¨ï¼š<code>0.0.0.0:1234</code>ï¼Œé‚£ä¹ˆå®ƒå…è®¸<strong>æ‰€æœ‰ IP è®¿é—®</strong>ã€‚ä½†æ˜¯ï¼Œæ˜¯å¦èƒ½ä»å¤–ç½‘è®¿é—®ï¼Œè¿˜è¦çœ‹å®‰å…¨ç»„ä¸­æ˜¯å¦æ”¾è¡Œäº† 1234 ç«¯å£ã€‚</p><hr /><h2 id="å®‰å…¨ç»„å†³å®šå¤–ç½‘èƒ½å¦è®¿é—®æŸä¸ªç«¯å£">3.å®‰å…¨ç»„ï¼šå†³å®šå¤–ç½‘èƒ½å¦è®¿é—®æŸä¸ªç«¯å£</h2><p>å®‰å…¨ç»„æ˜¯äº‘å‚å•†æä¾›çš„<strong>å…¥å£é˜²ç«å¢™</strong>ï¼Œå†³å®šå“ªäº›ç«¯å£å¯ä»¥ä»å¤–ç½‘è®¿é—®ã€‚ä¾‹å¦‚ï¼š</p><table><thead><tr><th>ç«¯å£</th><th>å®‰å…¨ç»„æ”¾è¡Œï¼Ÿ</th><th>å¤–ç½‘èƒ½è®¿é—®å—ï¼Ÿ</th></tr></thead><tbody><tr><td>80</td><td>âœ”</td><td>èƒ½</td></tr><tr><td>443</td><td>âœ”</td><td>èƒ½</td></tr><tr><td>1234</td><td>âŒ</td><td>ä¸èƒ½</td></tr></tbody></table><blockquote><p><strong>åªè¦ä½ çš„å®‰å…¨ç»„æ²¡æœ‰æ”¾è¡Œ 1234ï¼Œå³ä¾¿æœåŠ¡ç›‘å¬äº†0.0.0.0:1234ï¼Œå¤–ç½‘ä»ç„¶æ— æ³•è®¿é—®ã€‚</strong></p></blockquote><hr /><h2 id="åå‘ä»£ç†nginxæŠŠå¤–ç½‘è¯·æ±‚è½¬å‘ç»™å†…éƒ¨æœåŠ¡">4.åå‘ä»£ç†ï¼ˆNginxï¼‰ï¼šæŠŠå¤–ç½‘è¯·æ±‚è½¬å‘ç»™å†…éƒ¨æœåŠ¡</h2><p>åä»£è´Ÿè´£å°† 80/443 çš„è®¿é—®è½¬å‘åˆ°å†…éƒ¨ç«¯å£ï¼Œå¦‚ï¼š</p><pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;xx.example.com       â†“Nginxï¼ˆç›‘å¬ 80&#x2F;443ï¼‰       â†“127.0.0.1:1234ï¼ˆxx åç«¯ï¼‰</code></pre><p>åå‘ä»£ç†çš„æ„ä¹‰æ˜¯ï¼š</p><ul><li>å¤–ç½‘ç”¨æˆ·åªéœ€è¦è®¿é—®åŸŸåï¼ˆ80/443ï¼‰</li><li>å†…éƒ¨æœåŠ¡å¯ä»¥éšè—åœ¨ä»»æ„ç«¯å£</li><li>åç«¯ç«¯å£æ— éœ€æš´éœ²ç»™å¤–ç½‘ï¼ˆæ›´å®‰å…¨ï¼‰</li></ul><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<strong>åç«¯ç«¯å£ä¸ç”¨å¼€æ”¾</strong>ã€‚</p><hr /><h2 id="å¸¸è§é—®é¢˜">5. å¸¸è§é—®é¢˜</h2><p><strong>Q: é…ç½®äº†åä»£åï¼Œæˆ‘éœ€è¦åœ¨äº‘æœåŠ¡å™¨åå°å¼€å¯ 1234ç«¯å£å—ï¼Ÿ</strong></p><p><strong>A:</strong> <strong>å®Œå…¨ä¸éœ€è¦</strong>ã€‚ å› ä¸ºæµé‡æ˜¯å…ˆåˆ°è¾¾Nginx (443ç«¯å£)ï¼Œç„¶åç”± Nginx åœ¨æœåŠ¡å™¨<strong>å†…éƒ¨</strong>é€šè¿‡<code>localhost</code> è½¬å‘ç»™1234ã€‚å¤–éƒ¨é˜²ç«å¢™æ ¹æœ¬çœ‹ä¸åˆ°è¿™ä¸ªå†…éƒ¨è½¬å‘è¿‡ç¨‹ï¼Œæ‰€ä»¥ 1234ç«¯å£åº”å½“ä¿æŒå…³é—­çŠ¶æ€ã€‚</p><p><strong>Q:å¦‚ä½•æ£€æµ‹æˆ‘çš„æœåŠ¡æ˜¯å¦åªç›‘å¬åœ¨æœ¬åœ°ä»¥åŠæ˜¯å¦å¼€å¯ï¼Ÿ</strong></p><p><strong>A:</strong> <strong>ä½¿ç”¨ <code>netstat</code> æˆ–<code>ss</code> å‘½ä»¤æŸ¥çœ‹ç«¯å£ç›‘å¬çŠ¶æ€ï¼š</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä½¿ç”¨ netstat</span><span class="token function">sudo</span> <span class="token function">netstat</span> <span class="token parameter variable">-ltn</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">1234</span><span class="token comment"># ä½¿ç”¨ ss</span><span class="token function">sudo</span> ss <span class="token parameter variable">-ltn</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">1234</span><span class="token comment"># æ­£ç¡®çš„çŠ¶æ€ (åªå…è®¸æœ¬åœ°)</span>tcp  <span class="token number">0</span>  <span class="token number">0</span>  <span class="token number">127.0</span>.0.1:1234   <span class="token number">0.0</span>.0.0:* LISTEN<span class="token comment"># å±é™©çš„çŠ¶æ€ (å…è®¸æ‰€æœ‰ IP)</span>tcp  <span class="token number">0</span>  <span class="token number">0</span>  <span class="token number">0.0</span>.0.0:1234     <span class="token number">0.0</span>.0.0:* LISTEN</code></pre><h2 id="æ€»ç»“">6. æ€»ç»“</h2><p>ä¸€å¼ ç®€å•çš„å…³ç³»å›¾</p><pre class="language-none"><code class="language-none">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚        ç”¨æˆ·è®¿é—®åŸŸå           â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â†“        DNSï¼šè§£æåŸŸå â†’ æœåŠ¡å™¨ IP                â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚     Nginxï¼ˆç›‘å¬ 80 &#x2F; 443ï¼‰     â”‚â”‚  è´Ÿè´£æ¥æ”¶å¤–ç½‘è¯·æ±‚å¹¶åšåå‘ä»£ç† â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â†“     å†…éƒ¨æœåŠ¡ï¼ˆå¦‚ 127.0.0.1:1234ï¼‰</code></pre><p>å¦‚æœä½ ä½¿ç”¨ Nginx ä¸º xx æˆ–å…¶ä»–åç«¯ç¨‹åºåšåä»£ï¼š</p><ul><li>âœ” <strong>å¿…é¡»å¼€æ”¾çš„ç«¯å£ï¼š80 / 443</strong></li><li>âŒ <strong>ä¸éœ€è¦å¼€æ”¾çš„ç«¯å£ï¼š1234 ç­‰å†…éƒ¨ç«¯å£</strong></li><li>âœ” å†…éƒ¨æœåŠ¡ä¿æŒç›‘å¬ 127.0.0.1 æˆ– 0.0.0.0 å³å¯</li><li>âœ” <strong>åªè¦åšäº†åä»£ï¼Œåç«¯ç«¯å£å°±ä¸éœ€è¦å¼€æ”¾ï¼</strong></li></ul><p>ç”¨ä¸€å¥è¯æ€»ç»“ï¼š</p><blockquote><p><strong>DNSè´Ÿè´£æ‰¾æœåŠ¡å™¨ï¼Œå®‰å…¨ç»„æ§åˆ¶å¤–ç½‘è®¿é—®æƒé™ï¼Œç«¯å£å†³å®šæœåŠ¡ä½ç½®ï¼Œåä»£è´Ÿè´£æŠŠå¤–éƒ¨è¯·æ±‚è½¬å‘åˆ°å†…éƒ¨æœåŠ¡ã€‚å› æ­¤ï¼Œåä»£åçš„åç«¯ç«¯å£æ— éœ€å¯¹å¤–å¼€æ”¾ã€‚</strong></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythonç³»åˆ—ä¹‹logging</title>
      <link href="/2025/03/18/Python/logging/"/>
      <url>/2025/03/18/Python/logging/</url>
      
        <content type="html"><![CDATA[<h1 id="logging">logging</h1><p>Pythonçš„loggingæ¨¡å—æä¾›äº†çµæ´»çš„æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œå¯ç”¨äºè°ƒè¯•å’Œè®°å½•ç¨‹åºè¿è¡Œä¿¡æ¯ã€‚</p><h2 id="åŸºæœ¬é…ç½®">1 åŸºæœ¬é…ç½®</h2><p>å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°Pythonæ–‡ä»¶ä¸­ï¼Œä»¥é…ç½®æ—¥å¿—è®°å½•ï¼š</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logging<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path<span class="token comment"># é…ç½®æ—¥å¿—æ–‡ä»¶è·¯å¾„</span>script_dir <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>parent  <span class="token comment"># è·å–å½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•</span>log_file_path <span class="token operator">=</span> script_dir <span class="token operator">/</span> <span class="token string">'log_file.log'</span>  <span class="token comment"># åœ¨è„šæœ¬ç›®å½•ä¸‹åˆ›å»ºæ—¥å¿—æ–‡ä»¶</span><span class="token comment"># é…ç½®æ—¥å¿—</span>logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span>  <span class="token comment"># è®¾ç½®æ—¥å¿—çº§åˆ«</span>    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">,</span>  <span class="token comment"># è®¾ç½®æ—¥å¿—æ ¼å¼</span>    handlers<span class="token operator">=</span><span class="token punctuation">[</span>        logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># è¾“å‡ºåˆ°æ§åˆ¶å°</span>        logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span>log_file_path<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>  <span class="token comment"># åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span>logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>  <span class="token comment"># è·å–å½“å‰æ¨¡å—çš„logger</span><span class="token comment"># ä½¿ç”¨ç¤ºä¾‹ï¼šä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•</span>logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯è°ƒè¯•ä¿¡æ¯"</span><span class="token punctuation">)</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯ä¸€èˆ¬ä¿¡æ¯"</span><span class="token punctuation">)</span> logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯è­¦å‘Šä¿¡æ¯"</span><span class="token punctuation">)</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯é”™è¯¯ä¿¡æ¯"</span><span class="token punctuation">)</span>logger<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯ä¸¥é‡é”™è¯¯ä¿¡æ¯"</span><span class="token punctuation">)</span></code></pre><h2 id="é«˜çº§é…ç½®">2 é«˜çº§é…ç½®</h2><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„æ—¥å¿—é…ç½®ç¤ºä¾‹ï¼Œä½œä¸ºæ¨¡å—ä½¿ç”¨ã€‚è¯¥ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªé€šç”¨çš„æ—¥å¿—é…ç½®ç±»ï¼Œæ”¯æŒå¤šæ¨¡å—å…±äº«æ—¥å¿—è®¾ç½®ã€æŒ‰å¤§å°è½®è½¬ã€å‹ç¼©æ—§æ—¥å¿—ã€ä¸åŒçº§åˆ«æ—¥å¿—åˆ†æ–‡ä»¶ã€æ§åˆ¶å°è¾“å‡ºå’Œè‡ªå®šä¹‰è¿‡æ»¤å™¨ã€‚</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logging<span class="token keyword">import</span> os<span class="token keyword">import</span> gzip<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> List<span class="token keyword">import</span> shutil<span class="token keyword">class</span> <span class="token class-name">CompressedRotatingFileHandler</span><span class="token punctuation">(</span>RotatingFileHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""æ”¯æŒå‹ç¼©çš„æ—¥å¿—è½®è½¬å¤„ç†å™¨"""</span>    <span class="token keyword">def</span> <span class="token function">doRollover</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""é‡å†™doRolloveræ–¹æ³•æ¥æ·»åŠ å‹ç¼©åŠŸèƒ½"""</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>stream<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>stream <span class="token operator">=</span> <span class="token boolean">None</span>        <span class="token comment"># å¦‚æœå¤‡ä»½æ–‡ä»¶å·²å­˜åœ¨ï¼Œéœ€è¦å…ˆè½®è½¬è¿™äº›æ–‡ä»¶</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>backupCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token comment"># åˆ é™¤æœ€æ—§çš„ä¸€ä¸ªæ–‡ä»¶(å¦‚æœå­˜åœ¨)</span>            oldest_backup <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>backupCount<span class="token punctuation">&#125;</span></span><span class="token string">.gz"</span></span>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>oldest_backup<span class="token punctuation">)</span><span class="token punctuation">:</span>                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>oldest_backup<span class="token punctuation">)</span>            <span class="token comment"># è½®è½¬ç°æœ‰çš„å¤‡ä»½æ–‡ä»¶</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>backupCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                source <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">.gz"</span></span>                dest <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">.gz"</span></span>                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">:</span>                        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>dest<span class="token punctuation">)</span>                    os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>source<span class="token punctuation">,</span> dest<span class="token punctuation">)</span>            <span class="token comment"># å‹ç¼©å½“å‰æ—¥å¿—ä¸ºç¬¬ä¸€ä¸ªå¤‡ä»½</span>            dest <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">&#125;</span></span><span class="token string">.1.gz"</span></span>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f_in<span class="token punctuation">:</span>                    <span class="token keyword">with</span> gzip<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f_out<span class="token punctuation">:</span>                        shutil<span class="token punctuation">.</span>copyfileobj<span class="token punctuation">(</span>f_in<span class="token punctuation">,</span> f_out<span class="token punctuation">)</span>                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>self<span class="token punctuation">.</span>baseFilename<span class="token punctuation">)</span>        <span class="token comment"># åˆ›å»ºæ–°çš„ç©ºæ—¥å¿—æ–‡ä»¶</span>        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token string">'w'</span>        self<span class="token punctuation">.</span>stream <span class="token operator">=</span> self<span class="token punctuation">.</span>_open<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">KeywordFilter</span><span class="token punctuation">(</span>logging<span class="token punctuation">.</span>Filter<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> keyword<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>keyword <span class="token operator">=</span> keyword    <span class="token keyword">def</span> <span class="token function">filter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> record<span class="token punctuation">:</span> logging<span class="token punctuation">.</span>LogRecord<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>        <span class="token comment"># ä»…å½“æ—¥å¿—æ¶ˆæ¯åŒ…å«ç‰¹å®šå…³é”®è¯æ—¶è¿”å› True</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>keyword <span class="token keyword">in</span> record<span class="token punctuation">.</span>msg<span class="token keyword">class</span> <span class="token class-name">LoggerConfig</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    é€šç”¨æ—¥å¿—é…ç½®ç±»ï¼Œæ”¯æŒå¤šæ¨¡å—å…±äº«æ—¥å¿—è®¾ç½®    ç‰¹æ€§ï¼š    1. æŒ‰å¤§å°è½®è½¬    2. æ—¥å¿—å‹ç¼©    3. ä¸åŒçº§åˆ«æ—¥å¿—åˆ†æ–‡ä»¶    4. æ”¯æŒæ§åˆ¶å°è¾“å‡º    5. æ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤å™¨    """</span>    _instance <span class="token operator">=</span> <span class="token boolean">None</span>    _initialized <span class="token operator">=</span> <span class="token boolean">False</span>    _loggers<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> logging<span class="token punctuation">.</span>Logger<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>_instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            cls<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>LoggerConfig<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instance    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>                 log_dir<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">'./logs'</span><span class="token punctuation">,</span>                 log_level<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>                 max_bytes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token comment"># é»˜è®¤5MB</span>                 backup_count<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>                 enable_console<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>                 compress_logs<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>                 custom_filters<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>                 extra_handlers<span class="token punctuation">:</span> List<span class="token punctuation">[</span>logging<span class="token punctuation">.</span>Handler<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        åˆå§‹åŒ–æ—¥å¿—é…ç½®        Args:            log_dir: æ—¥å¿—ç›®å½•            log_level: åŸºç¡€æ—¥å¿—çº§åˆ«            max_bytes: å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å­—èŠ‚æ•°            backup_count: ä¿ç•™çš„å¤‡ä»½æ–‡ä»¶æ•°é‡            enable_console: æ˜¯å¦å¯ç”¨æ§åˆ¶å°è¾“å‡º            compress_logs: æ˜¯å¦å‹ç¼©æ—§æ—¥å¿—            custom_filters: è‡ªå®šä¹‰è¿‡æ»¤å™¨åˆ—è¡¨            extra_handlers: é¢å¤–çš„å¤„ç†å™¨åˆ—è¡¨        """</span>        <span class="token comment"># å•ä¾‹æ¨¡å¼ï¼šç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_initialized<span class="token punctuation">:</span>            <span class="token keyword">return</span>        self<span class="token punctuation">.</span>log_dir <span class="token operator">=</span> log_dir        self<span class="token punctuation">.</span>log_level <span class="token operator">=</span> log_level        self<span class="token punctuation">.</span>max_bytes <span class="token operator">=</span> max_bytes        self<span class="token punctuation">.</span>backup_count <span class="token operator">=</span> backup_count        self<span class="token punctuation">.</span>enable_console <span class="token operator">=</span> enable_console        self<span class="token punctuation">.</span>compress_logs <span class="token operator">=</span> compress_logs        self<span class="token punctuation">.</span>custom_filters <span class="token operator">=</span> custom_filters <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>extra_handlers <span class="token operator">=</span> extra_handlers <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment"># åˆ›å»ºæ—¥å¿—ç›®å½•</span>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>log_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment"># é»˜è®¤æ ¼å¼åŒ–å™¨</span>        self<span class="token punctuation">.</span>default_formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span>            <span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_initialized <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token keyword">def</span> <span class="token function">get_logger</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> formatter<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> logging<span class="token punctuation">.</span>Logger<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        è·å–æˆ–åˆ›å»ºlogger        Args:            name: loggeråç§°            formatter: è‡ªå®šä¹‰æ ¼å¼åŒ–å™¨        Returns:            logging.Logger: é…ç½®å¥½çš„logger        """</span>        <span class="token comment"># å¦‚æœå·²å­˜åœ¨è¯¥loggerï¼Œç›´æ¥è¿”å›</span>        <span class="token keyword">if</span> name <span class="token keyword">in</span> self<span class="token punctuation">.</span>_loggers<span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_loggers<span class="token punctuation">[</span>name<span class="token punctuation">]</span>        <span class="token comment"># åˆ›å»ºlogger</span>        logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>name<span class="token punctuation">)</span>        <span class="token comment"># æ¸…ç†å¯èƒ½å­˜åœ¨çš„handlers</span>        <span class="token keyword">if</span> logger<span class="token punctuation">.</span>hasHandlers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            logger<span class="token punctuation">.</span>handlers<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># è®¾ç½®æ—¥å¿—çº§åˆ«</span>        logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>log_level<span class="token punctuation">)</span>        formatter <span class="token operator">=</span> formatter <span class="token keyword">or</span> self<span class="token punctuation">.</span>default_formatter        <span class="token comment"># æ·»åŠ æ§åˆ¶å°å¤„ç†å™¨</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>enable_console<span class="token punctuation">:</span>            console_handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>            console_handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>            logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>console_handler<span class="token punctuation">)</span>        <span class="token comment"># ä¸ºä¸åŒçº§åˆ«åˆ›å»ºå•ç‹¬çš„æ—¥å¿—æ–‡ä»¶</span>        log_levels <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">(</span>logging<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">(</span>logging<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">(</span>logging<span class="token punctuation">.</span>CRITICAL<span class="token punctuation">,</span> <span class="token string">'critical'</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>        <span class="token keyword">for</span> level<span class="token punctuation">,</span> level_name <span class="token keyword">in</span> log_levels<span class="token punctuation">:</span>            <span class="token keyword">if</span> level <span class="token operator">>=</span> self<span class="token punctuation">.</span>log_level<span class="token punctuation">:</span>                handler <span class="token operator">=</span> self<span class="token punctuation">.</span>_create_rotating_handler<span class="token punctuation">(</span>                    os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>log_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"LOG_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>level_name<span class="token punctuation">&#125;</span></span><span class="token string">.log"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    formatter<span class="token punctuation">,</span>                    level                <span class="token punctuation">)</span>                logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>        <span class="token comment"># æ·»åŠ é¢å¤–çš„å¤„ç†å™¨</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>extra_handlers<span class="token punctuation">:</span>            <span class="token keyword">for</span> handler <span class="token keyword">in</span> self<span class="token punctuation">.</span>extra_handlers<span class="token punctuation">:</span>                handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>                logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>        <span class="token comment"># æ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤å™¨</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>custom_filters<span class="token punctuation">:</span>            <span class="token keyword">for</span> filter_config <span class="token keyword">in</span> self<span class="token punctuation">.</span>custom_filters<span class="token punctuation">:</span>                filter_class <span class="token operator">=</span> filter_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'filter_class'</span><span class="token punctuation">)</span>                args <span class="token operator">=</span> filter_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'args'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> filter_class<span class="token punctuation">:</span>                    filter_instance <span class="token operator">=</span> filter_class<span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span>                    logger<span class="token punctuation">.</span>addFilter<span class="token punctuation">(</span>filter_instance<span class="token punctuation">)</span>        <span class="token comment"># ç¦æ­¢å‘çˆ¶loggerä¼ é€’æ—¥å¿—</span>        logger<span class="token punctuation">.</span>propagate <span class="token operator">=</span> <span class="token boolean">False</span>        <span class="token comment"># ç¼“å­˜loggerå®ä¾‹</span>        self<span class="token punctuation">.</span>_loggers<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> logger        <span class="token keyword">return</span> logger    <span class="token keyword">def</span> <span class="token function">_create_rotating_handler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>                                 filename<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>                                 formatter<span class="token punctuation">:</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">,</span>                                 level<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> RotatingFileHandler<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        åˆ›å»ºè½®è½¬å¤„ç†å™¨        Args:            filename: æ—¥å¿—æ–‡ä»¶å            formatter: æ ¼å¼åŒ–å™¨            level: æ—¥å¿—çº§åˆ«        Returns:            RotatingFileHandler: é…ç½®å¥½çš„å¤„ç†å™¨        """</span>        handler_class <span class="token operator">=</span> CompressedRotatingFileHandler <span class="token keyword">if</span> self<span class="token punctuation">.</span>compress_logs <span class="token keyword">else</span> RotatingFileHandler        handler <span class="token operator">=</span> handler_class<span class="token punctuation">(</span>            filename<span class="token punctuation">,</span>            maxBytes<span class="token operator">=</span>self<span class="token punctuation">.</span>max_bytes<span class="token punctuation">,</span>            backupCount<span class="token operator">=</span>self<span class="token punctuation">.</span>backup_count<span class="token punctuation">,</span>            encoding<span class="token operator">=</span><span class="token string">'utf-8'</span>        <span class="token punctuation">)</span>        handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>level<span class="token punctuation">)</span>        handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>        <span class="token keyword">return</span> handler<span class="token keyword">def</span> <span class="token function">setLogConfig</span><span class="token punctuation">(</span>module_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                 log_dir<span class="token operator">=</span><span class="token string">'./logs'</span><span class="token punctuation">,</span>                 log_level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span>                 max_bytes<span class="token operator">=</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token comment"># 5MB</span>                 backup_count<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>                 enable_console<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                 compress_logs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                 custom_filters<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                 extra_handlers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    å¿«é€Ÿè®¾ç½®å¹¶è·å–loggerçš„ä¾¿æ·å‡½æ•°    Args:        module_name: æ¨¡å—åç§°ï¼Œç”¨äºæ ‡è¯†æ—¥å¿—æ¥æº        log_dir: æ—¥å¿—ä¿å­˜ç›®å½•        log_level: æ—¥å¿—çº§åˆ«        max_bytes: å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å­—èŠ‚æ•°        backup_count: ä¿ç•™çš„å¤‡ä»½æ–‡ä»¶æ•°é‡        enable_console: æ˜¯å¦å¯ç”¨æ§åˆ¶å°è¾“å‡º        compress_logs: æ˜¯å¦å‹ç¼©æ—§æ—¥å¿—        custom_filters: è‡ªå®šä¹‰è¿‡æ»¤å™¨åˆ—è¡¨ï¼Œä¾‹å¦‚custom_filters=[&#123;'filter_class': KeywordFilter, 'args': &#123;'keyword': 'critical'&#125;&#125;]        extra_handlers: é¢å¤–çš„å¤„ç†å™¨åˆ—è¡¨    Returns:        logging.Logger: é…ç½®å¥½çš„loggerå®ä¾‹    """</span>    <span class="token comment"># åˆå§‹åŒ–æ—¥å¿—é…ç½®</span>    log_config <span class="token operator">=</span> LoggerConfig<span class="token punctuation">(</span>        log_dir<span class="token operator">=</span>log_dir<span class="token punctuation">,</span>        log_level<span class="token operator">=</span>log_level<span class="token punctuation">,</span>        max_bytes<span class="token operator">=</span>max_bytes<span class="token punctuation">,</span>        backup_count<span class="token operator">=</span>backup_count<span class="token punctuation">,</span>        enable_console<span class="token operator">=</span>enable_console<span class="token punctuation">,</span>        compress_logs<span class="token operator">=</span>compress_logs<span class="token punctuation">,</span>        custom_filters<span class="token operator">=</span>custom_filters<span class="token punctuation">,</span>        extra_handlers<span class="token operator">=</span>extra_handlers    <span class="token punctuation">)</span>    <span class="token comment"># è‡ªåŠ¨è·å–è°ƒç”¨è€…çš„æ¨¡å—åç§°</span>    <span class="token keyword">if</span> module_name <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token keyword">import</span> inspect        caller_frame <span class="token operator">=</span> inspect<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        module_name <span class="token operator">=</span> caller_frame<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">'__name__'</span><span class="token punctuation">]</span>        <span class="token comment"># å¦‚æœæ²¡æœ‰æä¾›module_nameï¼Œåˆ™é€šè¿‡è°ƒç”¨æ ˆè·å–è°ƒç”¨è€…çš„__name__</span>    <span class="token keyword">return</span> log_config<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span>name<span class="token operator">=</span>module_name<span class="token punctuation">,</span> formatter<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    logger <span class="token operator">=</span> setLogConfig<span class="token punctuation">(</span><span class="token string">'test_module'</span><span class="token punctuation">)</span>    <span class="token comment"># ä½¿ç”¨logger</span>    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'è¿™æ˜¯ä¸€æ¡è°ƒè¯•æ—¥å¿—'</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'è¿™æ˜¯ä¸€æ¡ä¿¡æ¯æ—¥å¿—'</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'è¿™æ˜¯ä¸€æ¡è­¦å‘Šæ—¥å¿—'</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'è¿™æ˜¯ä¸€æ¡é”™è¯¯æ—¥å¿—'</span><span class="token punctuation">)</span>    logger<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'è¿™æ˜¯ä¸€æ¡ä¸¥é‡é”™è¯¯æ—¥å¿—'</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>åšå®¢èµ„æºæ‰˜ç®¡æ–¹æ¡ˆ</title>
      <link href="/2025/03/03/Web/assets/"/>
      <url>/2025/03/03/Web/assets/</url>
      
        <content type="html"><![CDATA[<h1 id="åšå®¢èµ„æºæ‰˜ç®¡æ–¹æ¡ˆ">åšå®¢èµ„æºæ‰˜ç®¡æ–¹æ¡ˆ</h1><h2 id="èµ„æºæ‰˜ç®¡æ–¹æ¡ˆ">èµ„æºæ‰˜ç®¡æ–¹æ¡ˆ</h2><p>åœ¨æ­å»ºåšå®¢æ—¶ï¼Œé€šå¸¸ä¼šæ¶‰åŠåˆ°ä¸€äº›é™æ€èµ„æºçš„æ‰˜ç®¡é—®é¢˜ï¼Œæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ç­‰ã€‚è¿™é‡Œåˆ—å‡ºå‡ ç§å¸¸è§çš„èµ„æºæ‰˜ç®¡æ–¹æ¡ˆï¼Œä¾›å‚è€ƒï¼š</p><table><colgroup><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /></colgroup><thead><tr><th>æ ‡å·</th><th>æ–¹æ¡ˆ</th><th>å…·ä½“æ–¹æ³•</th><th>æ¨èæŒ‡æ•°</th></tr></thead><tbody><tr><td>1</td><td>æœ¬åœ°</td><td>æ”¾åœ¨åšå®¢sourceæ–‡ä»¶å¤¹ä¸‹ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè·Ÿéšåšå®¢åŒæ­¥åˆ°githubä»“åº“</td><td>â˜…â˜…</td></tr><tr><td>2</td><td>github repo</td><td>å°†assetsèµ„æºæ”¾åœ¨å•ç‹¬çš„githubä»“åº“ç®¡ç†ï¼Œå¹¶æ‰“tag</td><td>â˜…â˜…â˜…</td></tr><tr><td>3</td><td>äº‘æœåŠ¡å™¨</td><td>å°†assetsæ”¾åœ¨äº‘æœåŠ¡å™¨é™æ€ç½‘é¡µä¸Š</td><td>â˜…â˜…â˜…â˜…</td></tr><tr><td>4</td><td>npm</td><td>å°†assetså‘å¸ƒåˆ°npmï¼Œç»è¿‡ unpkg/jsDelivr CDNä½¿ç”¨</td><td>â˜…â˜…â˜…â˜…</td></tr></tbody></table><h2 id="ä¼˜ç¼ºç‚¹åˆ†æ">ä¼˜ç¼ºç‚¹åˆ†æ</h2><h3 id="æœ¬åœ°">1 æœ¬åœ°</h3><ul><li>ä¼˜ç‚¹ï¼š<ul><li>æ–¹ä¾¿ï¼Œç›´æ¥æ”¾åœ¨åšå®¢çš„sourceæ–‡ä»¶å¤¹ä¸‹ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„å¼•ç”¨å³å¯ã€‚</li><li>ä¸éœ€è¦é¢å¤–çš„é…ç½®å’Œç®¡ç†ã€‚</li><li>è·Ÿéšåšå®¢åŒæ­¥åˆ°githubä»“åº“ï¼Œæ–¹ä¾¿å¤‡ä»½å’Œç‰ˆæœ¬æ§åˆ¶ã€‚</li></ul></li><li>ç¼ºç‚¹ï¼š<ul><li>èµ„æºæ–‡ä»¶è¾ƒå¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åšå®¢ä»“åº“è¿‡å¤§ï¼Œå½±å“å…‹éš†å’Œä¸‹è½½é€Ÿåº¦ã€‚</li><li>ä»“åº“å®¹é‡æœ‰é™ï¼Œè¶…è¿‡é™åˆ¶åä¹Ÿéš¾ä»¥æ¸…ç†ã€‚</li></ul></li></ul><h3 id="github-repo">2 github repo</h3><p>ä¸€èˆ¬é…åˆjsDelivrä½¿ç”¨ï¼ŒcdnåŠ é€Ÿã€‚</p><ul><li>ä¼˜ç‚¹ï¼š<ul><li>å¯ä»¥å°†assetsèµ„æºæ”¾åœ¨å•ç‹¬çš„githubä»“åº“ç®¡ç†ï¼Œé¿å…å½±å“åšå®¢ä»“åº“çš„å¤§å°ã€‚</li><li>å¯ä»¥ä½¿ç”¨githubçš„ç‰ˆæœ¬æ§åˆ¶å’Œå¤‡ä»½åŠŸèƒ½ï¼Œæ–¹ä¾¿ç®¡ç†å’Œç»´æŠ¤ã€‚</li></ul></li><li>ç¼ºç‚¹ï¼š<ul><li>éœ€è¦é¢å¤–çš„é…ç½®å’Œç®¡ç†ï¼Œå¢åŠ äº†å¤æ‚æ€§ã€‚</li><li>å¹¶ä¸æ¨ègithubåšèµ„æºæ‰˜ç®¡ï¼Œé™åˆ¶å¤§æ–‡ä»¶å’Œé«˜æµé‡è®¿é—®ï¼Œå°¤å…¶æ˜¯ç›´æ¥è°ƒç”¨raw.githubusercontent.comçš„èµ„æºã€‚</li></ul></li></ul><h3 id="äº‘æœåŠ¡å™¨">3 äº‘æœåŠ¡å™¨</h3><ul><li>ä¼˜ç‚¹ï¼š<ul><li>å¯ä»¥å°†assetsæ”¾åœ¨äº‘æœåŠ¡å™¨é™æ€ç½‘é¡µä¸Šï¼Œæ–¹ä¾¿ç®¡ç†å’Œç»´æŠ¤ã€‚</li><li>èµ„æºå®Œå…¨è‡ªç”±æŒæ§ï¼Œå¯ä»¥è®¾ç½®è®¿é—®æƒé™å’Œæµé‡é™åˆ¶ï¼Œéšç§æ€§æœ€å¥½ã€‚</li><li>å®¹é‡å’Œå¸¦å®½å–å†³äºäº‘æœåŠ¡å™¨çš„é…ç½®ã€‚</li></ul></li><li>ç¼ºç‚¹ï¼š<ul><li>éœ€è¦é¢å¤–çš„é…ç½®å’Œç®¡ç†ï¼Œå¢åŠ äº†å¤æ‚æ€§ã€‚</li><li>éœ€è¦æ”¯ä»˜äº‘æœåŠ¡å™¨çš„è´¹ç”¨ï¼Œå¢åŠ äº†æˆæœ¬ã€‚</li></ul></li></ul><h3 id="npm">4 npm</h3><ul><li>ä¼˜ç‚¹ï¼š<ul><li>å¯ä»¥å°†assetså‘å¸ƒåˆ°npmï¼Œç»è¿‡ unpkg/jsDelivr CDNä½¿ç”¨ï¼Œæ–¹ä¾¿å¿«æ·ã€‚</li><li>å¯ä»¥ä½¿ç”¨npmçš„ç‰ˆæœ¬æ§åˆ¶å’Œå¤‡ä»½åŠŸèƒ½ï¼Œæ–¹ä¾¿ç®¡ç†å’Œç»´æŠ¤ã€‚</li></ul></li><li>ç¼ºç‚¹ï¼š<ul><li>éœ€è¦é¢å¤–çš„é…ç½®å’Œç®¡ç†ï¼Œå¢åŠ äº†å¤æ‚æ€§ã€‚</li><li>èµ„æºæ›´æ–°åéœ€è¦é‡æ–°å‘å¸ƒåˆ°npm</li><li>åŒ…çš„å®¹é‡æœ‰é™åˆ¶</li></ul></li></ul><h3 id="æ€»ç»“">æ€»ç»“</h3><p>å°†èµ„æºåˆ†å¼€ç®¡ç†</p><ol type="1"><li>å°†é…ç½®æ–‡ä»¶æ”¾åœ¨sourceæ–‡ä»¶å¤¹ä¸‹ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„å¼•ç”¨ã€‚</li><li>å°†ä¸å¸¸å˜åŠ¨çš„èµ„æºæ‰“åŒ…ä¸ºassetsï¼Œä¾æ®å–œå¥½æ”¾äºäº‘æœåŠ¡å™¨æˆ–è€…npm(ä½¿ç”¨jsDelivr/unpkgCDN)ã€‚</li><li>ç»å¸¸å˜åŠ¨çš„èµ„æºå¦‚æœè¾ƒå¤§ï¼Œæ”¾åœ¨äº‘æœåŠ¡å™¨æˆ–è€…githubrepo(ä½¿ç”¨jsDelivr)ä¸Šï¼Œå¦‚æœè¾ƒå°ï¼Œæ”¾åœ¨sourceæ–‡ä»¶å¤¹ä¸‹ã€‚</li><li>ååˆ†æ¨èä¸ºåšå®¢(å’Œäº‘æœåŠ¡å™¨ï¼Œå¦‚æœä½¿ç”¨çš„è¯)æ·»åŠ CloudflareCDNåŠ é€Ÿï¼Œå…è´¹ç‰ˆè¶³å¤Ÿä½¿ç”¨ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å†…å®¹åˆ†å‘ç½‘ç»œ (CDN)</title>
      <link href="/2025/02/26/TechnicalNotes/CDN/"/>
      <url>/2025/02/26/TechnicalNotes/CDN/</url>
      
        <content type="html"><![CDATA[<h2 id="å†…å®¹åˆ†å‘ç½‘ç»œ-cdn">å†…å®¹åˆ†å‘ç½‘ç»œ (CDN)</h2><p>CDNï¼Œå…¨ç§° Content DeliveryNetworkï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ï¼Œæ˜¯ä¸€ç§é€šè¿‡åˆ†å¸ƒå¼éƒ¨ç½²çš„æœåŠ¡å™¨ç½‘ç»œæ¥åŠ é€Ÿå’Œä¼˜åŒ–å†…å®¹ä¼ è¾“çš„æŠ€æœ¯ã€‚å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯è®©ç”¨æˆ·èƒ½å¤Ÿå°±è¿‘è·å–æ‰€éœ€çš„ç½‘é¡µã€è§†é¢‘ã€å›¾ç‰‡ã€è„šæœ¬ç­‰å†…å®¹ï¼Œä»è€Œæå‡è®¿é—®é€Ÿåº¦å’Œä½“éªŒï¼ŒåŒæ—¶å‡è½»æºç«™æœåŠ¡å™¨çš„å‹åŠ›ã€‚</p><h3 id="åŸç†">1 åŸç†</h3><ol type="1"><li>å†…å®¹ç¼“å­˜ä¸åˆ†å‘ (Caching &amp; Distribution):è¿™æ˜¯CDNæœ€åŸºç¡€ä¹Ÿæ˜¯æœ€å…³é”®çš„æŠ€æœ¯ã€‚CDNä¼šå°†ç½‘ç«™çš„é™æ€å†…å®¹ï¼ˆå¦‚å›¾ç‰‡ã€è§†é¢‘ã€CSS/JSæ–‡ä»¶ç­‰ï¼‰ä¸»åŠ¨æˆ–è¢«åŠ¨åœ°ä»æºç«™æœåŠ¡å™¨ç¼“å­˜åˆ°éå¸ƒå…¨çƒçš„è¾¹ç¼˜èŠ‚ç‚¹æœåŠ¡å™¨ä¸Šã€‚å½“ç”¨æˆ·å‘èµ·è®¿é—®è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä¼šè¢«å¼•å¯¼è‡³ç¦»ç”¨æˆ·åœ°ç†ä½ç½®æœ€è¿‘ã€ç½‘ç»œå»¶è¿Ÿæœ€ä½çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹ä¼šç›´æ¥å°†ç¼“å­˜çš„å†…å®¹å“åº”ç»™ç”¨æˆ·ï¼Œé¿å…äº†å¯¹æºç«™çš„ç›´æ¥è®¿é—®ï¼Œæå¤§åœ°ç¼©çŸ­äº†ç‰©ç†è·ç¦»å’Œæ•°æ®ä¼ è¾“æ—¶é—´ã€‚</li><li>è´Ÿè½½å‡è¡¡ä¸æ™ºèƒ½è°ƒåº¦ (Load Balancing &amp; Intelligent Scheduling):CDNæ‹¥æœ‰ä¸€ä¸ªæ™ºèƒ½çš„â€œå¤§è„‘â€â€”â€”å…¨å±€è´Ÿè½½å‡è¡¡ï¼ˆGSLBï¼‰ç³»ç»Ÿã€‚è¿™ä¸ªç³»ç»Ÿä¼šå®æ—¶ç›‘æ§æ‰€æœ‰è¾¹ç¼˜èŠ‚ç‚¹çš„å¥åº·çŠ¶å†µã€è´Ÿè½½æƒ…å†µä»¥åŠåˆ°ç”¨æˆ·çš„ç½‘ç»œé“¾è·¯è´¨é‡ã€‚å½“ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶ï¼ŒGSLBä¼šç»¼åˆåˆ†æç”¨æˆ·çš„IPåœ°å€ã€åœ°ç†ä½ç½®ã€è¿è¥å•†ç½‘ç»œç­‰ä¿¡æ¯ï¼Œé€šè¿‡DNSè§£ææˆ–HTTPé‡å®šå‘ç­‰æŠ€æœ¯ï¼Œå°†ç”¨æˆ·çš„è¯·æ±‚â€œè°ƒåº¦â€åˆ°æœ€ä¼˜çš„è¾¹ç¼˜èŠ‚ç‚¹ä¸Šï¼Œç¡®ä¿ç”¨æˆ·è·å¾—æœ€å¿«ã€æœ€ç¨³å®šçš„è®¿é—®ä½“éªŒã€‚</li></ol><h3 id="å·¥ä½œæµç¨‹">2 å·¥ä½œæµç¨‹</h3><p>ç”¨æˆ·ä½¿ç”¨CDNæœåŠ¡è®¿é—®ä¸€ä¸ªç½‘ç«™çš„å®Œæ•´æµç¨‹ï¼Œå¯ä»¥åˆ†è§£ä¸ºä»¥ä¸‹å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š</p><p><strong>å‰æï¼š</strong>ç½‘ç«™ä¸»å·²ç»å°†å…¶åŸŸåæ¥å…¥CDNæœåŠ¡ï¼Œå¹¶åœ¨DNSæœåŠ¡å•†å¤„å°†åŸŸåè§£ææŒ‡å‘CDNæœåŠ¡å•†æä¾›çš„CNAMEè®°å½•ã€‚</p><ol type="1"><li><strong>ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼š</strong> å½“ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ç½‘å€ï¼ˆä¾‹å¦‚<code>www.example.com</code>ï¼‰åï¼Œè®¡ç®—æœºä¼šå‘æœ¬åœ°DNSæœåŠ¡å™¨ï¼ˆLocalDNSï¼‰å‘èµ·åŸŸåè§£æè¯·æ±‚ã€‚</li><li><strong>CNAMEè§£æè‡³CDNçš„DNSè°ƒåº¦ç³»ç»Ÿï¼š</strong> LocalDNSä»åŸŸåçš„æƒå¨DNSæœåŠ¡å™¨è·å–åˆ°è¯¥åŸŸåè¢«é…ç½®äº†ä¸€æ¡CNAMEè®°å½•ï¼ŒæŒ‡å‘äº†CDNæœåŠ¡å•†çš„åŸŸåï¼ˆä¾‹å¦‚<code>www.example.com.cdn.cloudflare.net</code>ï¼‰ã€‚äºæ˜¯ï¼ŒLocalDNSä¼šå†æ¬¡å‘CDNçš„DNSè°ƒåº¦ç³»ç»Ÿå‘èµ·è¯·æ±‚ã€‚</li><li><strong>æ™ºèƒ½è°ƒåº¦ï¼Œè¿”å›æœ€ä¼˜èŠ‚ç‚¹IPï¼š</strong>CDNçš„DNSè°ƒåº¦ç³»ç»Ÿï¼ˆå³GSLBï¼‰æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ ¹æ®ä¸€ç³»åˆ—ç­–ç•¥è¿›è¡Œæ™ºèƒ½å†³ç­–ï¼š<ul><li><strong>åœ°ç†ä½ç½®åˆ¤æ–­ï¼š</strong>åˆ†æç”¨æˆ·çš„IPåœ°å€ï¼Œåˆ¤æ–­å…¶æ‰€åœ¨çš„åœ°ç†ä½ç½®å’Œè¿è¥å•†ç½‘ç»œã€‚</li><li><strong>èŠ‚ç‚¹å¥åº·åº¦æ£€æµ‹ï¼š</strong>æ’é™¤æ‰æ•…éšœæˆ–è´Ÿè½½è¿‡é«˜çš„è¾¹ç¼˜èŠ‚ç‚¹ã€‚</li><li><strong>ç½‘ç»œè´¨é‡æ¢æµ‹ï¼š</strong>è¯„ä¼°å„ä¸ªèŠ‚ç‚¹åˆ°ç”¨æˆ·çš„ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡ã€‚</li><li>ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œé€‰æ‹©å‡ºä¸€ä¸ªå¯¹è¯¥ç”¨æˆ·æ¥è¯´â€œæœ€ä¼˜â€çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶IPåœ°å€è¿”å›ç»™LocalDNSã€‚</li></ul></li><li><strong>è·å–æœ€ä¼˜èŠ‚ç‚¹IPï¼š</strong> LocalDNSå°†è·å–åˆ°çš„æœ€ä¼˜è¾¹ç¼˜èŠ‚ç‚¹çš„IPåœ°å€è¿”å›ç»™ç”¨æˆ·çš„è®¡ç®—æœºã€‚</li><li><strong>ç”¨æˆ·ä¸è¾¹ç¼˜èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼š</strong>ç”¨æˆ·çš„æµè§ˆå™¨å‘è¿™ä¸ªæœ€ä¼˜çš„è¾¹ç¼˜èŠ‚ç‚¹IPåœ°å€å‘èµ·HTTP/HTTPSè¯·æ±‚ï¼Œè¯·æ±‚è·å–å…·ä½“çš„ç½‘é¡µå†…å®¹ï¼ˆå¦‚ä¸€å¼ å›¾ç‰‡ï¼‰ã€‚</li><li><strong>è¾¹ç¼˜èŠ‚ç‚¹å“åº”ï¼š</strong><ul><li><strong>ç¼“å­˜å‘½ä¸­ï¼ˆCache Hitï¼‰ï¼š</strong>å¦‚æœè¯¥è¾¹ç¼˜èŠ‚ç‚¹å·²ç»ç¼“å­˜äº†ç”¨æˆ·è¯·æ±‚çš„å†…å®¹ï¼Œå¹¶ä¸”ç¼“å­˜å°šæœªè¿‡æœŸï¼Œå®ƒä¼šç›´æ¥å°†å†…å®¹å‘é€ç»™ç”¨æˆ·ã€‚è¿™æ˜¯æœ€ç†æƒ³ã€æœ€å¿«é€Ÿçš„æƒ…å†µã€‚</li><li><strong>ç¼“å­˜æœªå‘½ä¸­ï¼ˆCache Missï¼‰ï¼š</strong>å¦‚æœè¯¥èŠ‚ç‚¹æ²¡æœ‰ç¼“å­˜è¯¥å†…å®¹ï¼Œæˆ–è€…ç¼“å­˜å·²ç»è¿‡æœŸï¼Œå®ƒä¼šä»£è¡¨ç”¨æˆ·å‘æºç«™æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œè·å–æœ€æ–°çš„å†…å®¹ã€‚</li></ul></li><li><strong>å›æºä¸ç¼“å­˜ï¼š</strong>è¾¹ç¼˜èŠ‚ç‚¹ä»æºç«™è·å–åˆ°å†…å®¹åï¼Œä¸€æ–¹é¢å°†å…¶å‘é€ç»™ç”¨æˆ·ï¼Œå¦ä¸€æ–¹é¢ä¼šæŒ‰ç…§é¢„è®¾çš„ç¼“å­˜ç­–ç•¥ï¼ˆå¦‚ç¼“å­˜æ—¶é—´ã€ç¼“å­˜è§„åˆ™ç­‰ï¼‰å°†å†…å®¹å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä»¥ä¾¿åç»­æœ‰ç›¸åŒè¯·æ±‚æ—¶å¯ä»¥ç›´æ¥å“åº”ã€‚</li></ol><p>é€šè¿‡è¿™æ ·ä¸€å¥—å®Œæ•´ã€è‡ªåŠ¨åŒ–çš„æµç¨‹ï¼ŒCDNæˆåŠŸåœ°å°†ç”¨æˆ·è®¿é—®æµé‡åˆ†æ•£åˆ°äº†å„ä¸ªè¾¹ç¼˜èŠ‚ç‚¹ï¼Œæ—¢å‡è½»äº†æºç«™æœåŠ¡å™¨çš„å‹åŠ›ï¼Œåˆæ˜¾è‘—æå‡äº†ç»ˆç«¯ç”¨æˆ·çš„è®¿é—®é€Ÿåº¦å’Œä½“éªŒã€‚</p><h3 id="ä¼˜åŠ¿">3 ä¼˜åŠ¿</h3><p>å‡­å€Ÿå…¶ç‹¬ç‰¹çš„æŠ€æœ¯åŸç†ï¼ŒCDNè¢«å¹¿æ³›åº”ç”¨äºå„ç§äº’è”ç½‘ä¸šåŠ¡åœºæ™¯ï¼Œå…¶ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p><ul><li><strong>åŠ é€Ÿç½‘ç«™è®¿é—®ï¼š</strong>æ˜¾è‘—å‡å°‘ç½‘é¡µåŠ è½½æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼Œé™ä½ç”¨æˆ·æµå¤±ç‡ã€‚</li><li><strong>åˆ†æ‹…æºç«™å‹åŠ›ï¼š</strong>å¤§éƒ¨åˆ†ç”¨æˆ·è¯·æ±‚ç”±CDNè¾¹ç¼˜èŠ‚ç‚¹å¤„ç†ï¼Œå¤§å¹…é™ä½æºç«™æœåŠ¡å™¨çš„è´Ÿè½½å’Œå¸¦å®½æ¶ˆè€—æˆæœ¬ã€‚</li><li><strong>æå‡å¯ç”¨æ€§ä¸å¯é æ€§ï¼š</strong>å•ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹çš„æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªæœåŠ¡çš„å¯ç”¨æ€§ï¼ŒCDNçš„åˆ†å¸ƒå¼æ¶æ„æä¾›äº†å¤©ç„¶çš„å†—ä½™ã€‚</li><li><strong>å¢å¼ºå®‰å…¨æ€§ï¼š</strong>CDNå¯ä»¥éšè—æºç«™IPï¼Œå¹¶æä¾›DDoSæ”»å‡»é˜²æŠ¤ã€WAFï¼ˆWebåº”ç”¨é˜²ç«å¢™ï¼‰ç­‰å®‰å…¨åŠŸèƒ½ï¼Œä¿æŠ¤æºç«™å…å—ç½‘ç»œæ”»å‡»ã€‚</li><li><strong>æ”¯æŒå¤§è§„æ¨¡åˆ†å‘ï¼š</strong>å°¤å…¶é€‚ç”¨äºè§†é¢‘ç‚¹æ’­ã€ç›´æ’­ã€å¤§æ–‡ä»¶ä¸‹è½½ã€æ¸¸æˆåŠ é€Ÿç­‰éœ€è¦å¤„ç†æµ·é‡å¹¶å‘è¯·æ±‚å’Œé«˜å¸¦å®½æµé‡çš„åœºæ™¯ã€‚</li></ul><p>CDNå·²ç»æˆä¸ºç°ä»£äº’è”ç½‘ä¸å¯æˆ–ç¼ºçš„åŸºç¡€è®¾æ–½ï¼Œå®ƒé€šè¿‡æ™ºèƒ½çš„è°ƒåº¦å’Œåˆ†å¸ƒå¼çš„ç¼“å­˜ï¼Œæœ‰æ•ˆåœ°è§£å†³äº†å› åœ°ç†è·ç¦»å’Œç½‘ç»œæ‹¥å¡å¸¦æ¥çš„è®¿é—®å»¶è¿Ÿé—®é¢˜ï¼Œä¸ºå…¨çƒç”¨æˆ·æä¾›äº†æ›´å¿«é€Ÿã€æ›´å¯é ã€æ›´å®‰å…¨çš„ç½‘ç»œè®¿é—®ä½“éªŒã€‚</p><h3 id="ä½¿ç”¨">4 ä½¿ç”¨</h3><p>å¸¸è§çš„ CDN æœåŠ¡æœ‰ <strong>cdnjs</strong>ã€<strong>unpkg</strong> å’Œ<strong>jsDelivr</strong>ï¼Œå®ƒä»¬å„è‡ªæœ‰ä¸åŒçš„ç‰¹ç‚¹å’ŒåŠŸèƒ½ã€‚</p><ol type="1"><li>unpkgç±»å‹ï¼šåªæ”¯æŒ npm åŒ…ï¼Œnpm åŒ…åŠ é€Ÿ<ul><li>æä¾›æ–¹<ul><li>unpkgå®˜æ–¹: <code>https://unpkg.com</code></li></ul></li><li>ç¤ºä¾‹:<code>{url}/@{organization}/{package-name}@{version}/path/to/file</code></li></ul></li><li>jsdelivrç±»å‹ï¼šæ”¯æŒ npm åŒ… å’Œ GitHub ä»“åº“ï¼Œnpm åŒ… å’Œ GitHub ä»“åº“åŠ é€Ÿ<ul><li>æä¾›æ–¹<ul><li>jsdelivrå®˜æ–¹: <code>https://cdn.jsdelivr.net</code></li><li>fastly: <code>https://fastly.jsdelivr.net</code></li><li>cloudflare: <code>https://testingcf.jsdelivr.net</code></li><li>gcore: <code>gcore.jsdelivr.net</code></li></ul></li><li>npm:<code>{url}/npm/@{organization}/{package-name}@{version}/path/to/file</code></li><li>GitHub:<code>{url}/gh/{organization}/{repository}@{version}/path/to/file</code></li></ul></li><li>cdnjsç±»å‹ï¼šåªæ”¯æŒå·²åŠ å…¥çš„å¼€æºåº“ï¼ŒJavaScript/CSS åº“åŠ é€Ÿ<ul><li>åŸºç¡€URL: <code>https://cdnjs.cloudflare.com/ajax/libs/</code></li><li>ç¤ºä¾‹:<code>https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js</code></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>git</title>
      <link href="/2025/02/25/TechnicalNotes/Git/"/>
      <url>/2025/02/25/TechnicalNotes/Git/</url>
      
        <content type="html"><![CDATA[<h2 id="gitignore">1. gitignore</h2><p><code>.gitignore</code> æ–‡ä»¶ç”¨äºæŒ‡å®šå“ªäº›æ–‡ä»¶æˆ–ç›®å½•åœ¨ Gitç‰ˆæœ¬æ§åˆ¶ä¸­è¢«å¿½ç•¥ã€‚å®ƒå¯ä»¥é¿å…å°†ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆå¦‚ç¼–è¯‘äº§ç‰©ã€ä¸´æ—¶æ–‡ä»¶ç­‰ï¼‰æäº¤åˆ°ç‰ˆæœ¬åº“ä¸­ã€‚</p><pre class="language-ignore" data-language="ignore"><code class="language-ignore"><span class="token comment"># å¿½ç•¥ç‰¹å®šæ–‡ä»¶</span><span class="token entry string">secret.txt</span><span class="token comment"># å¿½ç•¥ç‰¹å®šç›®å½•</span><span class="token entry string">temp<span class="token punctuation">/</span></span><span class="token comment"># å¿½ç•¥ç‰¹å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶(ä½†ä¿ç•™tempç›®å½•æœ¬èº«)</span><span class="token comment"># å¦‚æœ temp/ ç›®å½•æ˜¯ç©ºçš„ï¼ŒGit é»˜è®¤ä¸ä¼šè¿½è¸ªç©ºç›®å½•ï¼Œé€šå¸¸è¦ç”¨ .gitkeep ä¹‹ç±»çš„æ–‡ä»¶å¼ºåˆ¶ä¿ç•™</span><span class="token entry string">temp<span class="token punctuation">/</span><span class="token operator">*</span></span><span class="token comment"># å¿½ç•¥ç‰¹å®šç›®å½•ä¸‹çš„æ‰€æœ‰ .tmp æ–‡ä»¶</span><span class="token entry string">temp<span class="token punctuation">/</span><span class="token operator">*</span>.tmp</span><span class="token comment"># å¿½ç•¥ç‰¹å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ï¼Œä½†ä¿ç•™æŸä¸ªæ–‡ä»¶</span><span class="token entry string">temp<span class="token punctuation">/</span><span class="token operator">*</span></span><span class="token entry string"><span class="token operator">!</span>temp<span class="token punctuation">/</span>keep.txt</span><span class="token comment"># å¿½ç•¥ç‰¹å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ï¼Œä½†ä¿ç•™æŸä¸ªç›®å½•</span><span class="token entry string">temp<span class="token punctuation">/</span><span class="token operator">*</span></span><span class="token entry string"><span class="token operator">!</span>temp<span class="token punctuation">/</span>keep<span class="token punctuation">/</span></span></code></pre><h2 id="æ¸…é™¤å·²è·Ÿè¸ªçš„æ–‡ä»¶">2. æ¸…é™¤å·²è·Ÿè¸ªçš„æ–‡ä»¶</h2><p>ä¸ä¼šåˆ é™¤ Git æäº¤å†å²ä¸­çš„æ–‡ä»¶ï¼Œå®ƒ åªåˆ é™¤å·¥ä½œåŒºï¼ˆworkingdirectoryï¼‰å’Œæœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼Œä¸ä¼šå½±å“ Git ç‰ˆæœ¬åº“çš„æäº¤è®°å½•:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clean <span class="token parameter variable">-n</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-x</span>  <span class="token comment"># é¢„è§ˆå³å°†åˆ é™¤çš„æ–‡ä»¶</span><span class="token function">git</span> clean <span class="token parameter variable">-f</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-x</span>  <span class="token comment"># ç¡®è®¤æ— è¯¯åæ‰§è¡Œåˆ é™¤</span></code></pre><h2 id="å›é€€ä»¥å‰çš„æäº¤">3. å›é€€ä»¥å‰çš„æäº¤</h2><h3 id="reset-ç¡¬å›é€€">3.1 reset ç¡¬å›é€€</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> reset <span class="token parameter variable">--hard</span> commit <span class="token function">id</span></code></pre><p>æ­¤æ—¶å†æ¨åˆ°è¿œç¨‹ä»“åº“ç”¨ <code>git push</code> ä¼šæŠ¥é”™ï¼Œéœ€è¦ç”¨<code>git push -f</code> å¼ºæ¨ä¸Šå»</p><h3 id="revert-è½¯å›é€€">3.2 revert è½¯å›é€€</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> revert <span class="token parameter variable">-n</span> commit <span class="token function">id</span></code></pre><p>æ­¤æ—¶ä¼šåœ¨å½“å‰åˆ†æ”¯ä¸Šç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤ï¼Œå†…å®¹æ˜¯å°†æŒ‡å®šçš„æäº¤å›é€€åˆ°å½“å‰åˆ†æ”¯çš„çŠ¶æ€ã€‚æ³¨æ„ï¼š<code>-n</code>é€‰é¡¹è¡¨ç¤ºä¸ä¼šç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤ï¼Œè€Œæ˜¯å°†å˜æ›´æ”¾å…¥æš‚å­˜åŒº</p><h2 id="æäº¤è§„èŒƒ">4. æäº¤è§„èŒƒ</h2><h3 id="æäº¤ä¿¡æ¯çš„åŸºæœ¬ç»“æ„">4.1 æäº¤ä¿¡æ¯çš„åŸºæœ¬ç»“æ„</h3><p>ä¸€ä¸ªæ ‡å‡†çš„ Git æäº¤ä¿¡æ¯é€šå¸¸åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š</p><pre class="language-none"><code class="language-none">&lt;ç±»å‹&gt;(&lt;èŒƒå›´&gt;): &lt;ç®€çŸ­æè¿°&gt;&lt;è¯¦ç»†æè¿°&gt;&lt;é¡µè„šæ³¨é‡Š&gt;</code></pre><ul><li><strong>ç±»å‹ (Type)</strong>ï¼šæè¿°æäº¤çš„ç±»åˆ«ï¼ŒæŒ‡æ˜æäº¤çš„æ€§è´¨ã€‚</li><li><strong>èŒƒå›´ (Scope)</strong>ï¼šæŒ‡å®šå˜æ›´çš„å…·ä½“æ¨¡å—ã€åŠŸèƒ½æˆ–æ–‡ä»¶ã€‚</li><li><strong>ç®€çŸ­æè¿°</strong>ï¼šå¯¹æœ¬æ¬¡æäº¤çš„ç®€è¦æ€»ç»“ã€‚</li><li><strong>è¯¦ç»†æè¿°</strong>ï¼ˆå¯é€‰ï¼‰ï¼šæä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œè§£é‡Šä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªæäº¤ã€å¦‚ä½•åšçš„ã€è§£å†³äº†ä»€ä¹ˆé—®é¢˜ç­‰ã€‚</li><li><strong>é¡µè„šæ³¨é‡Š</strong>ï¼ˆå¯é€‰ï¼‰ï¼šé“¾æ¥åˆ°é¡¹ç›®ç®¡ç†å·¥å…·ä¸­çš„ä»»åŠ¡ã€bugæˆ–æ•…äº‹ç­‰ã€‚</li></ul><h3 id="å¸¸è§çš„æäº¤ç±»å‹">4.2 <strong>å¸¸è§çš„æäº¤ç±»å‹</strong></h3><p>è¿™äº›ç±»å‹é€šå¸¸æ˜¯é‡‡ç”¨ <ahref="https://www.conventionalcommits.org/zh-hans">ConventionalCommits</a> æ ‡å‡†çš„å¸¸è§å€¼ï¼Œç›®çš„æ˜¯ä½¿æäº¤ä¿¡æ¯ä¸€è‡´ä¸”å…·æœ‰ç»“æ„åŒ–ã€‚</p><ol type="1"><li><code>fix</code>: ç±»å‹ ä¸º fix çš„æäº¤è¡¨ç¤ºåœ¨ä»£ç åº“ä¸­ä¿®å¤äº†ä¸€ä¸ªbugã€‚</li><li><code>feat</code>: ç±»å‹ ä¸º featçš„æäº¤è¡¨ç¤ºåœ¨ä»£ç åº“ä¸­æ–°å¢äº†ä¸€ä¸ªåŠŸèƒ½ã€‚</li><li><code>BREAKING CHANGE</code>: åœ¨è„šæ³¨ä¸­åŒ…å« BREAKING CHANGE: æˆ–<ç±»å‹>(èŒƒå›´) åé¢æœ‰ä¸€ä¸ª ! çš„æäº¤ï¼Œè¡¨ç¤ºå¼•å…¥äº†ç ´åæ€§ API å˜æ›´ã€‚ç ´åæ€§å˜æ›´å¯ä»¥æ˜¯ä»»æ„<em>ç±»å‹</em>æäº¤çš„ä¸€éƒ¨åˆ†ã€‚</li><li><code>build</code>:ç”¨äºä¿®æ”¹é¡¹ç›®æ„å»ºç³»ç»Ÿï¼Œä¾‹å¦‚ä¿®æ”¹ä¾èµ–åº“ã€å¤–éƒ¨æ¥å£æˆ–è€…å‡çº§ Nodeç‰ˆæœ¬ç­‰ï¼›</li><li><code>chore</code>:ç”¨äºå¯¹éä¸šåŠ¡æ€§ä»£ç è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚ä¿®æ”¹æ„å»ºæµç¨‹æˆ–è€…å·¥å…·é…ç½®ç­‰ï¼›</li><li><code>ci</code>: ç”¨äºä¿®æ”¹æŒç»­é›†æˆæµç¨‹ï¼Œä¾‹å¦‚ä¿®æ”¹ Travisã€Jenkinsç­‰å·¥ä½œæµé…ç½®ï¼›</li><li><code>docs</code>: ç”¨äºä¿®æ”¹æ–‡æ¡£ï¼Œä¾‹å¦‚ä¿®æ”¹ README æ–‡ä»¶ã€APIæ–‡æ¡£ç­‰ï¼›</li><li><code>style</code>:ç”¨äºä¿®æ”¹ä»£ç çš„æ ·å¼ï¼Œä¾‹å¦‚è°ƒæ•´ç¼©è¿›ã€ç©ºæ ¼ã€ç©ºè¡Œç­‰ï¼›</li><li><code>refactor</code>:ç”¨äºé‡æ„ä»£ç ï¼Œä¾‹å¦‚ä¿®æ”¹ä»£ç ç»“æ„ã€å˜é‡åã€å‡½æ•°åç­‰ä½†ä¸ä¿®æ”¹åŠŸèƒ½é€»è¾‘ï¼›</li><li><code>perf</code>:ç”¨äºä¼˜åŒ–æ€§èƒ½ï¼Œä¾‹å¦‚æå‡ä»£ç çš„æ€§èƒ½ã€å‡å°‘å†…å­˜å ç”¨ç­‰ï¼›</li><li><code>test</code>:ç”¨äºä¿®æ”¹æµ‹è¯•ç”¨ä¾‹ï¼Œä¾‹å¦‚æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ä»£ç çš„æµ‹è¯•ç”¨ä¾‹ç­‰ã€‚</li></ol><p>æ¯æ¬¡æäº¤åº”è¯¥åªåŒ…å«ä¸€ä¸ªé€»è¾‘å˜æ›´ï¼Œé¿å…æ··åˆå¤šä¸ªä¸ç›¸å…³çš„ä¿®æ”¹ã€‚</p><h2 id="gitå…¨å±€é…ç½®æ¨è">5. gitå…¨å±€é…ç½®æ¨è</h2><pre class="language-gitconfig" data-language="gitconfig"><code class="language-gitconfig">[user]    name &#x3D; xx    email &#x3D; xx@xx.com[http &quot;https:&#x2F;&#x2F;github.com&quot;]    proxy &#x3D; 127.0.0.1:7890       # GitHub ä»£ç†ï¼Œå¯æ ¹æ®å®é™…ç½‘ç»œç¯å¢ƒä¿®æ”¹[core]    autocrlf &#x3D; true              # è‡ªåŠ¨è½¬æ¢æ¢è¡Œç¬¦ï¼ŒWindows æ¨è trueï¼ŒmacOS&#x2F;Linux æ¨è input    quotepath &#x3D; false            # ä¸­æ–‡è·¯å¾„ä¸å†è½¬ä¹‰æ˜¾ç¤ºä¸º \uXXXX    editor &#x3D; code --wait         # é»˜è®¤ç¼–è¾‘å™¨ VSCodeï¼Œå¯æ”¹ä¸º notepad æˆ– vim    preloadindex &#x3D; true          # åŠ å¿« git status é€Ÿåº¦    fscache &#x3D; true               # Windows ä¸‹ç¼“å­˜æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼Œæé«˜æ€§èƒ½    untrackedCache &#x3D; true        # åŠ é€Ÿæœªè·Ÿè¸ªæ–‡ä»¶æ£€æµ‹ï¼Œç‰¹åˆ«æ˜¯å¤§ä»“åº“[color]    ui &#x3D; auto                    # Git å‘½ä»¤è¾“å‡ºè‡ªåŠ¨å½©è‰²æ˜¾ç¤ºï¼ˆlogã€diff ç­‰ï¼‰[alias]    st &#x3D; status                  # git st â†’ git status    co &#x3D; checkout                # git co â†’ git checkout    br &#x3D; branch                  # git br â†’ git branch    ci &#x3D; commit                  # git ci â†’ git commit    df &#x3D; diff                     # git df â†’ git diff    lg &#x3D; log --graph --decorate --pretty&#x3D;format:&#39;%C(yellow)%h%Creset -%C(cyan)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#39; --abbrev-commit --date&#x3D;relative                                  # ç¾è§‚çš„æäº¤å†å²ï¼Œå¸¦åˆ†æ”¯ã€æ ‡ç­¾ã€å›¾å½¢åŒ–æ˜¾ç¤º    last &#x3D; log -1 HEAD           # æŸ¥çœ‹æœ€åä¸€æ¬¡æäº¤    unstage &#x3D; reset HEAD --      # å–æ¶ˆæš‚å­˜åŒºæ–‡ä»¶    amend &#x3D; commit --amend --no-edit  # ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ä½†ä¸æ›´æ”¹æäº¤ä¿¡æ¯[diff]    tool &#x3D; vscode    algorithm &#x3D; histogram        # æ›´æ™ºèƒ½çš„ diff ç®—æ³•ï¼Œå¤„ç†å¤§æ–‡ä»¶å’Œç§»åŠ¨ä»£ç å—æ›´å‡†ç¡®    colorMoved &#x3D; plain           # å¯ç”¨ç§»åŠ¨ä»£ç å—æ£€æµ‹ï¼Œæ˜¾ç¤ºæ›´ç›´è§‚    mnemonicPrefix &#x3D; true        # diff å‰ç¼€æ›´æ˜“ç†è§£    renames &#x3D; true               # è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶é‡å‘½å    indentHeuristic &#x3D; true       # æ›´æ™ºèƒ½çš„ diff å—åˆ’åˆ†    compactionHeuristic &#x3D; true   # ä¼˜åŒ– diff è¾“å‡ºå¯è¯»æ€§[difftool &quot;vscode&quot;]    cmd &#x3D; code --wait --diff $LOCAL $REMOTE  # ä½¿ç”¨ VSCode ä½œä¸º diff å·¥å…·[merge]    tool &#x3D; vscode[mergetool &quot;vscode&quot;]    cmd &#x3D; code --wait $MERGED                 # ä½¿ç”¨ VSCode ä½œä¸º merge å·¥å…·[pull]    rebase &#x3D; false              # é¿å…é»˜è®¤ rebaseï¼Œå¯æ ¹æ®ä¸ªäººä¹ æƒ¯æ”¹ true[push]    default &#x3D; simple            # é¿å…æ¨é€åˆ°é”™è¯¯åˆ†æ”¯    autoSetupRemote &#x3D; true      # æ–°å»ºåˆ†æ”¯æ—¶è‡ªåŠ¨è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯    followTags &#x3D; true           # æ¨é€ commit æ—¶è‡ªåŠ¨æ¨é€å…³è”çš„ tag[init]    defaultBranch &#x3D; master      # åˆå§‹åŒ–ä»“åº“é»˜è®¤åˆ†æ”¯åï¼Œå¯æ”¹ä¸º main[column]    ui &#x3D; auto                   # åˆ—è¡¨å‘½ä»¤è‡ªåŠ¨å¯¹é½è¾“å‡º[branch]    sort &#x3D; -committerdate       # åˆ†æ”¯åˆ—è¡¨æŒ‰æœ€è¿‘æäº¤æ—¶é—´æ’åº[tag]    sort &#x3D; version:refname      # æ ‡ç­¾åˆ—è¡¨æŒ‰ç‰ˆæœ¬å·æ’åº[fetch]    prune &#x3D; true                # è‡ªåŠ¨åˆ é™¤è¿œç¨‹å·²åˆ é™¤çš„åˆ†æ”¯    pruneTags &#x3D; true            # è‡ªåŠ¨åˆ é™¤è¿œç¨‹å·²åˆ é™¤çš„æ ‡ç­¾    # fetch.all å¯é€‰ï¼Œæ ¹æ®é¡¹ç›®æ˜¯å¦å¤šè¿œç¨‹å†³å®šæ˜¯å¦å¼€å¯    # git config --global fetch.all true[help]    autocorrect &#x3D; prompt        # è¾“å…¥å‘½ä»¤æœ‰è¯¯æ—¶æç¤ºçº æ­£ï¼Œé¿å…è¯¯æ“ä½œ[commit]    verbose &#x3D; true              # æäº¤æ—¶æ˜¾ç¤º diff å†…å®¹ï¼Œæ–¹ä¾¿æ£€æŸ¥[rerere]    enabled &#x3D; true              # å¯ç”¨å†²çªé‡ç”¨åŠŸèƒ½    autoupdate &#x3D; true           # è‡ªåŠ¨åº”ç”¨å·²è§£å†³çš„å†²çª[rebase]    autoStash &#x3D; true            # rebase å‰è‡ªåŠ¨ stashï¼Œå®Œæˆåè‡ªåŠ¨ pop    autoSquash &#x3D; true           # è‡ªåŠ¨å¤„ç† fixup!&#x2F;squash! æäº¤    missingCommitsCheck &#x3D; warn  # ä¸¢å¤±æäº¤æ—¶è­¦å‘Š[stash]    showPatch &#x3D; true            # stash show é»˜è®¤æ˜¾ç¤º diff[status]    submoduleSummary &#x3D; true     # æ˜¾ç¤ºå­æ¨¡å—å˜æ›´æ‘˜è¦    showStash &#x3D; true            # æ˜¾ç¤º stash æ•°é‡    aheadBehind &#x3D; true          # æ˜¾ç¤ºåˆ†æ”¯é¢†å…ˆ&#x2F;è½åä¿¡æ¯[index]    threads &#x3D; true              # å¤šçº¿ç¨‹åŠ é€Ÿç´¢å¼•æ“ä½œ</code></pre>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Live2D Widgetä½¿ç”¨è¯´æ˜</title>
      <link href="/2024/11/20/TechnicalNotes/live2d/"/>
      <url>/2024/11/20/TechnicalNotes/live2d/</url>
      
        <content type="html"><![CDATA[<h1 id="live2d-widget-ä½¿ç”¨è¯´æ˜">Live2D Widget ä½¿ç”¨è¯´æ˜</h1><p>åœ¨ç½‘é¡µä¸­æ·»åŠ  Live2D çœ‹æ¿å¨˜ã€‚å…¼å®¹ PJAXï¼Œæ”¯æŒæ— åˆ·æ–°åŠ è½½ã€‚(æ³¨ï¼šå·²ä¸å†éœ€è¦é…ç½®ä¾èµ– jQuery å’Œ Font Awesome)</p><p>ä»£ç ï¼š <ahref="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a><a href="https://github.com/fghrsh/live2d_api">live2d_api</a></p><p>åšæ–‡ï¼š<br /><a href="https://www.fghrsh.net/post/123.html">ç½‘é¡µæ·»åŠ  Live2Dçœ‹æ¿å¨˜</a> <a href="https://www.fghrsh.net/post/170.html">Live2D çœ‹æ¿å¨˜API è¿ç§»å…¬å‘Š</a></p><h2 id="ç®€å•é…ç½®">1 ç®€å•é…ç½®</h2><p>åªéœ€è¦æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆåªç”¨å°†è¿™ä¸€è¡Œä»£ç åŠ å…¥ html é¡µé¢çš„<code>head</code> æˆ– <code>body</code> ä¸­ï¼Œå³å¯åŠ è½½çœ‹æ¿å¨˜ï¼š</p><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><ol type="1"><li>æ·»åŠ ä»£ç çš„ä½ç½®å–å†³äºä½ çš„ç½‘ç«™çš„æ„å»ºæ–¹å¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ <ahref="https://hexo.io">Hexo</a>ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ä¸»é¢˜çš„æ¨¡ç‰ˆæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸Šä»£ç ã€‚å¯¹äºç”¨å„ç§æ¨¡ç‰ˆå¼•æ“ç”Ÿæˆçš„é¡µé¢ï¼Œä¿®æ”¹æ–¹æ³•ç±»ä¼¼ã€‚<br /></li><li>å¦‚æœç½‘ç«™å¯ç”¨äº† PJAXï¼Œç”±äºçœ‹æ¿å¨˜ä¸å¿…æ¯é¡µåˆ·æ–°ï¼Œéœ€è¦æ³¨æ„å°†è¯¥è„šæœ¬æ”¾åˆ°PJAX åˆ·æ–°åŒºåŸŸä¹‹å¤–ã€‚</li></ol><h2 id="è¿›é˜¶é…ç½®">2 è¿›é˜¶é…ç½®</h2><h3 id="ä¿®æ”¹autoload.jsæ–‡ä»¶">2.1 ä¿®æ”¹<code>autoload.js</code>æ–‡ä»¶</h3><p>ä¸‹è½½<ahref="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a>æºç ï¼Œæ‰¾åˆ°å…¶ä¸­çš„<code>autoload.js</code>æ–‡ä»¶ï¼Œä¿®æ”¹å…¶ä¸­çš„é…ç½®é¡¹ã€‚</p><p><code>autoload.js</code>ä¼šè‡ªåŠ¨åŠ è½½ä¸‰ä¸ªæ–‡ä»¶ï¼š<code>waifu.css</code>ï¼Œ<code>live2d.min.js</code>å’Œ <code>waifu-tips.js</code>ã€‚<code>waifu-tips.js</code> ä¼šåˆ›å»º<code>initWidget</code>å‡½æ•°ï¼Œè¿™å°±æ˜¯åŠ è½½çœ‹æ¿å¨˜çš„ä¸»å‡½æ•°ã€‚<code>initWidget</code> å‡½æ•°æ¥æ”¶ä¸€ä¸ªObject ç±»å‹çš„å‚æ•°ï¼Œä½œä¸ºçœ‹æ¿å¨˜çš„é…ç½®ã€‚ä»¥ä¸‹æ˜¯é…ç½®é€‰é¡¹ï¼š</p><table><colgroup><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /></colgroup><thead><tr><th>é€‰é¡¹</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>live2d_path</code></td><td><code>string</code></td><td><code>https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/</code></td><td>live2d-widget è·¯å¾„ï¼Œè·¯å¾„æœ«å°¾çš„ <code>/</code> ä¸€å®šè¦åŠ ä¸Š</td></tr><tr><td><code>apiPath</code></td><td><code>string</code></td><td><code>https://live2d.fghrsh.net/api/</code></td><td>API è·¯å¾„ï¼Œè·¯å¾„æœ«å°¾çš„ <code>/</code> ä¸€å®šè¦åŠ ä¸Š</td></tr><tr><td><code>cdnPath</code></td><td><code>string</code></td><td><code>https://fastly.jsdelivr.net/gh/fghrsh/live2d_api@latest/</code></td><td>CDN è·¯å¾„ï¼Œè·¯å¾„æœ«å°¾çš„ <code>/</code> ä¸€å®šè¦åŠ ä¸Š</td></tr><tr><td><code>tools</code></td><td><code>string[]</code></td><td>è§ <code>autoload.js</code></td><td>åŠ è½½çš„å°å·¥å…·æŒ‰é’®ï¼Œå¯é€‰å‚æ•°</td></tr></tbody></table><p>1ï¸âƒ£ <code>live2d_path</code> æ˜¯ live2d-widgetçš„èµ„æºè·¯å¾„ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ã€‚</p><p>ä¸‹è½½<ahref="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a></p><ol type="1"><li>æœ¬åœ°å­˜æ”¾ï¼šå°†ä¸‹è½½çš„ä»“åº“æ”¾åœ¨æœ¬åœ°ç›®å½•ä¸‹ï¼ŒæŒ‡å‘æœ¬åœ°è·¯å¾„ï¼Œä¾‹å¦‚<code>/assets/live2d-widget/</code>ã€‚å¦‚hexoï¼Œæ”¾åœ¨åšå®¢æºæ–‡ä»¶ç›®å½•ä¸‹ï¼ˆ<code>source</code> ç›®å½•ï¼‰ï¼Œéœ€è¦è®¾ç½® <code>skip_render</code>ã€‚</li><li>äº‘ç«¯å­˜æ”¾ï¼šå°†ä¸‹è½½çš„ä»“åº“ä¸Šä¼ åˆ°äº‘ç«¯ï¼ŒæŒ‡å‘äº‘ç«¯è·¯å¾„<ul><li>githubï¼šä½¿ç”¨ <code>jsdelivr</code>ï¼Œä¾‹å¦‚<code>https://cdn.jsdelivr.net/gh/username/live2d-widget@latest/</code>ï¼Œéœ€è¦åˆ›å»ºæ–°çš„git tag å¹¶æ¨é€è‡³ GitHub ä»“åº“ä¸­ï¼Œå¦åˆ™æ­¤å¤„çš„ <code>@latest</code>ä»ç„¶æŒ‡å‘æ›´æ–°å‰çš„æ–‡ä»¶ã€‚</li><li>npmï¼šä½¿ç”¨ <code>unpkg</code>æˆ–è€…<code>jsdelivr</code>ï¼Œä¾‹å¦‚<code>https://unpkg.com/[package_name]/@latest/</code> æˆ–<code>https://cdn.jsdelivr.net/npm/[package_name]/@latest/</code></li><li>äº‘æœåŠ¡å™¨: æ–°å»º<strong>é™æ€</strong>é¡¹ç›®ï¼Œä¾‹å¦‚<code>https://example.com/path/to/live2d-widget/</code></li></ul></li></ol><p>2ï¸âƒ£ <code>apiPath</code> å’Œ <code>cdnPath</code>ä¸¤ä¸ªå‚æ•°è®¾ç½®å…¶ä¸­ä¸€é¡¹å³å¯ã€‚</p><p>ä¸‹è½½<a href="https://github.com/fghrsh/live2d_api">live2d_api</a></p><ul><li><code>apiPath</code> æ˜¯åç«¯ API çš„ URLï¼Œå¯ä»¥è‡ªè¡Œæ­å»ºï¼Œå¹¶å¢åŠ æ¨¡å‹ã€‚<ul><li>éœ€è¦æ”¯æŒ <code>GET</code> è¯·æ±‚ï¼Œå› æ­¤éœ€è¦å»ºç«™ï¼Œä»¥å®å¡”é¢æ¿ä¸ºä¾‹ï¼š<ul><li>é¦–å…ˆï¼Œåœ¨å®å¡”é¢æ¿åˆ›å»ºæ–°ç«™ç‚¹ï¼Œè®¾ç½®å¥½ PHP ç‰ˆæœ¬ï¼ˆä¸æ˜¯çº¯é™æ€ï¼‰ï¼Œå¹¶æ·»åŠ ä¸ŠSSL è¯ä¹¦ã€‚</li><li>ç„¶åï¼Œåˆ å»ç½‘ç«™æ ¹ç›®å½• /www/wwwroot/api/ä¸‹é»˜è®¤æ·»åŠ åˆ›å»ºçš„æ‰€æœ‰æ–‡ä»¶ã€‚</li><li>æ‰“å¼€ SSH ç»ˆç«¯ï¼ŒæŠŠ Live2D API æºä»£ç æ”¾åˆ°ç½‘ç«™ live2d/ ç›®å½•</li></ul></li></ul></li><li><code>cdnPath</code> åˆ™æ˜¯ç±»ä¼¼äº <code>live2d_path</code>çš„è·¯å¾„ï¼Œç”¨äºåŠ è½½æ¨¡å‹æ–‡ä»¶ã€‚<ul><li>æœ¬åœ°å­˜æ”¾å’Œäº‘ç«¯å­˜æ”¾åŒä¸Šã€‚</li></ul></li></ul><h3 id="æ·»åŠ autoload.jsæ–‡ä»¶">2.2 æ·»åŠ <code>autoload.js</code>æ–‡ä»¶</h3><p>ä¿®æ”¹<code>live2d_path</code>åå°†è¿™ä¸€è¡Œä»£ç åŠ å…¥ html é¡µé¢çš„<code>head</code> æˆ– <code>body</code> ä¸­ï¼Œå³å¯åŠ è½½çœ‹æ¿å¨˜ï¼š</p><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;live2d_path&#125;/autoload.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><h3 id="æµ‹è¯•">2.3 æµ‹è¯•</h3><p>ä¸å¦¨è¯•è¯•èƒ½å¦æ­£å¸¸åœ°é€šè¿‡æµè§ˆå™¨æ‰“å¼€ <code>autoload.js</code> å’Œ<code>live2d.min.js</code>ç­‰æ–‡ä»¶ï¼Œå¹¶ç¡®è®¤è¿™äº›æ–‡ä»¶çš„å†…å®¹æ˜¯å®Œæ•´å’Œæ­£ç¡®çš„ã€‚</p><h2 id="é«˜çº§é…ç½®">3 é«˜çº§é…ç½®</h2><p>ä¿®æ”¹æ ·å¼å’Œæ¨¡å‹ï¼šè‡ªè¡ŒæŸ¥é˜…ä¸¤ä¸ªä»“åº“çš„README.mdæ–‡ä»¶å’Œæºç ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Twikooè¯„è®ºç³»ç»Ÿé…ç½®</title>
      <link href="/2024/11/20/Web/Twikoo/"/>
      <url>/2024/11/20/Web/Twikoo/</url>
      
        <content type="html"><![CDATA[<h1 id="twikoo-è¯„è®ºç³»ç»Ÿé…ç½®">Twikoo è¯„è®ºç³»ç»Ÿé…ç½®</h1><p>ç›®å‰å¾ˆå¤šé¢æ¿æ”¯æŒä¸€é”®é…ç½®ï¼Œä»¥ä¸‹æ˜¯ç§æœ‰éƒ¨ç½²æ–¹å¼ä»‹ç»</p><h2 id="äº‘ç«¯éƒ¨ç½²">äº‘ç«¯éƒ¨ç½²</h2><ol type="1"><li>åœ¨ <a href="https://twikoo.js.org/">TwiKoo å®˜ç½‘</a>æ‰¾åˆ°äº‘å‡½æ•°éƒ¨ç½²çš„ç§æœ‰éƒ¨ç½²æ–¹å¼ï¼ŒæŒ‰ç…§æ–‡æ¡£è¿›è¡Œé…ç½®ã€‚</li><li><a href="https://nodejs.org/zh-cn/download">ä¸‹è½½nodejs</a>é€‰æ‹©æœ€æ–°çš„LTSç‰ˆæœ¬ï¼ŒLinuxï¼Œnvmï¼Œnpmã€‚æŒ‰ç…§å‘½ä»¤å®‰è£…ã€‚</li><li>æŒ‡å®šé•œåƒæºï¼š<code>npm config set registry https://registry.npmmirror.com</code></li><li>å®‰è£… Twikoo server:<code>npm i -g tkserver</code>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š<code>npm ls tkserver -g</code></li><li>é…ç½®ç¯å¢ƒå˜é‡ï¼Œä¸»è¦å…³æ³¨ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼š<ul><li><code>TWIKOO_DATA</code>ï¼šlokijs æ•°æ®åº“å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤æ˜¯<code>./data</code>ã€‚</li><li><code>TWIKOO_PORT</code>ï¼šæœåŠ¡ç«¯å£ï¼Œé»˜è®¤æ˜¯ <code>8080</code></li><li><code>TWIKOO_IP_HEADERS</code>ï¼šåœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ï¼Œå¦‚ä½¿ç”¨äº†CloudFlare CDN å®ƒä¼šå°†è¯·æ±‚ IP å†™åˆ°è¯·æ±‚å¤´çš„ cf-connecting-ipå­—æ®µä¸Šï¼Œä¸ºäº†èƒ½å¤Ÿæ­£ç¡®çš„è·å–è¯·æ±‚ IP ä½ å¯ä»¥å†™æˆ[â€œheaders.cf-connecting-ipâ€]ï¼Œé»˜è®¤æ˜¯ []</li></ul></li><li>å¯åŠ¨æœåŠ¡<ul><li>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¦‚<code>/www/wwwroot/twikoo</code>ï¼Œ<strong>åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹</strong>æ‰§è¡Œå¯åŠ¨å‘½ä»¤å³å¯å°†æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹</li><li><code>export TWIKOO_DATA=/www/wwwroot/twikoo/data</code></li><li><code>export TWIKOO_PORT=xxxx</code></li><li><code>export TWIKOO_IP_HEADERS=["headers.cf-connecting-ip"]</code></li><li><code>source ~/.bashrc</code></li><li>æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®æˆåŠŸ(æ³¨æ„ï¼šæœ‰æ—¶è®¾ç½®ä¸æˆåŠŸï¼Œå¯ä»¥ç›´æ¥æ·»åŠ åˆ°/root/.bashrcä¸­)ï¼š<ul><li><code>export | grep TWIKOO</code></li><li>ç²—ç•¥å¯åŠ¨æœåŠ¡<code>tkserver</code>å¹¶è®¿é—®<code>http://ip:xxxx</code>æŸ¥çœ‹æ˜¯å¦æˆåŠŸï¼ˆ<strong>æ³¨1</strong>ï¼‰</li></ul></li></ul></li><li>åœ¨<strong>æ–°æ–‡ä»¶å¤¹</strong>ä¸‹<code>nohup tkserver &gt;&gt; tkserver.log 2&gt;&amp;1 &amp;</code>å‘½ä»¤åå°å¯åŠ¨ï¼Œè®¿é—®<a href="http://æœåŠ¡ç«¯IP:ç«¯å£å·" class="uri">http://æœåŠ¡ç«¯IP:ç«¯å£å·</a>æµ‹è¯•æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸã€‚ä½†æ˜¯æ¦‚ç‡å­˜åœ¨ä½¿ç”¨<code>nohup &amp;</code>å‘½ä»¤è¿è¡Œshellè„šæœ¬ï¼Œå…³é—­ç»ˆç«¯ä»ç„¶é€€å‡º(å¯ä»¥è¯•è¯•exitå‘½ä»¤æ³¨é”€ç»ˆç«¯)â€¦â€¦</li><li>é…ç½®ä»£ç†å®ç° HTTPS è®¿é—®:<ul><li>æ·»åŠ çº¯é™æ€ç«™ç‚¹ï¼šPHPé¡¹ç›®ï¼Œtwikoo.{åŸŸå}</li><li>é…ç½®sslè¯ä¹¦:letâ€™s encrypt æ‰‹åŠ¨è§£æ é€šé…ç¬¦ä¿®æ”¹å¯¹åº”çš„é˜¿é‡Œäº‘å’Œcloudflareçš„DNSè§£æï¼Œä¹Ÿå¯èƒ½åªéœ€è¦ä¿®æ”¹cloudflareçš„DNSè§£æ</li><li>æ·»åŠ åå‘ä»£ç†: ä»£ç†åç§°ï¼štwikooï¼Œç›®æ ‡URLï¼š<ahref="http://127.0.0.1:%7Bç«¯å£%7D"class="uri">http://127.0.0.1:{ç«¯å£}</a>ï¼Œä»£ç†åŸŸåï¼š$host</li></ul></li><li>æœ€ç»ˆè®¿é—®åœ°å€ä¸ºï¼š<a href="https://twikoo.%7BåŸŸå%7D"class="uri">https://twikoo.{åŸŸå}</a></li><li>æ³¨æ„å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</li></ol><h2 id="å‰ç«¯é…ç½®">å‰ç«¯é…ç½®</h2><p>åˆ°åšå®¢é…ç½®æ–‡ä»¶ä¸­é…ç½® envId ä¸º https:// åŠ åŸŸåï¼ˆä¾‹å¦‚ <ahref="https://twikoo.yourdomain.comï¼‰"class="uri">https://twikoo.yourdomain.comï¼‰</a></p><h2 id="æ›´æ–°äº‘ç«¯">æ›´æ–°äº‘ç«¯</h2><ol type="1"><li>åœæ­¢æ—§ç‰ˆæœ¬<code>kill $(ps -ef | grep tkserver | grep -v 'grep' | awk '{print $2}')</code></li><li>æ‹‰å–æ–°ç‰ˆæœ¬ <code>npm i -g tkserver@latest</code></li><li>å›åˆ°ä¸Šæ–‡ç¬¬7æ­¥é‡æ–°å¯åŠ¨æœåŠ¡</li></ol><p>æ³¨1ï¼šå‰ææ˜¯éœ€è¦åœ¨<strong>æœåŠ¡å™¨å®‰å…¨ç»„</strong>å’Œ<strong>å®å¡”é¢æ¿</strong>ä¸­å¼€æ”¾è¯¥ç«¯å£ï¼Œç”¨å®Œ<strong>å…³é—­</strong>è¿™ä¸¤ä¸ªç«¯å£ã€‚æˆ–è€…å…ˆé…ç½®åå‘ä»£ç†ï¼Œç›´æ¥è®¿é—®åŸŸåã€‚å°±ä¸éœ€è¦å¼€æ”¾ç«¯å£äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€” A åŸºäºå€¼å‡½æ•°vsåŸºäºç­–ç•¥æ–¹æ³•</title>
      <link href="/2024/09/19/RL/A%20%E5%9F%BA%E4%BA%8E%E5%80%BC%E5%87%BD%E6%95%B0vs%E5%9F%BA%E4%BA%8E%E7%AD%96%E7%95%A5%E6%96%B9%E6%B3%95/"/>
      <url>/2024/09/19/RL/A%20%E5%9F%BA%E4%BA%8E%E5%80%BC%E5%87%BD%E6%95%B0vs%E5%9F%BA%E4%BA%8E%E7%AD%96%E7%95%A5%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºäºå€¼å‡½æ•°-vs-åŸºäºç­–ç•¥æ–¹æ³•">1. åŸºäºå€¼å‡½æ•° vs åŸºäºç­–ç•¥æ–¹æ³•</h2><p>å¼ºåŒ–å­¦ä¹ è§£å†³å†³ç­–é—®é¢˜çš„æ€è·¯å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šä¸€ç±»æ˜¯â€è¯„ä¼°ä»·å€¼åå†³ç­–â€ï¼Œå¦ä¸€ç±»æ˜¯â€ç›´æ¥ä¼˜åŒ–å†³ç­–â€ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<strong>åŸºäºå€¼å‡½æ•°çš„æ–¹æ³•</strong>å’Œ<strong>åŸºäºç­–ç•¥çš„æ–¹æ³•</strong>ã€‚</p><h3 id="åŸºäºå€¼å‡½æ•°çš„æ–¹æ³•å…ˆè¯„ä¼°å†å†³ç­–">1.1åŸºäºå€¼å‡½æ•°çš„æ–¹æ³•ï¼šå…ˆè¯„ä¼°ï¼Œå†å†³ç­–</h3><p>æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªä¸‹æ£‹çš„æ–°æ‰‹ï¼Œå¦‚ä½•æé«˜æ£‹è‰ºï¼Ÿä¸€ä¸ªç›´è§‚çš„æƒ³æ³•æ˜¯ï¼šå­¦ä¼šè¯„ä¼°æ¯ä¸ªå±€é¢çš„å¥½åï¼Œç„¶åé€‰æ‹©èƒ½è¾¾åˆ°æœ€å¥½å±€é¢çš„èµ°æ³•ã€‚è¿™å°±æ˜¯åŸºäºå€¼å‡½æ•°æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³ã€‚</p><h4 id="æ ¸å¿ƒç†å¿µ">æ ¸å¿ƒç†å¿µ</h4><p>åŸºäºå€¼å‡½æ•°çš„æ–¹æ³•é€šè¿‡å­¦ä¹ <strong>ä»·å€¼è¯„ä¼°å‡½æ•°</strong>æ¥æŒ‡å¯¼å†³ç­–ï¼š</p><ul><li><strong>å€¼å‡½æ•°è¯„ä¼°</strong>ï¼šåŸºäºå€¼å‡½æ•°çš„æ–¹æ³•ä¸»è¦é€šè¿‡ä¼°è®¡çŠ¶æ€å€¼å‡½æ•°( V(s) ) æˆ–åŠ¨ä½œä»·å€¼å‡½æ•° ( Q(s, a) )æ¥è¯„ä¼°æ¯ä¸ªçŠ¶æ€æˆ–çŠ¶æ€-åŠ¨ä½œå¯¹çš„ä¼˜åŠ£ã€‚è¿™é‡Œï¼Œ( V(s) ) è¡¨ç¤ºåœ¨çŠ¶æ€ ( s )ä¸‹èƒ½è·å¾—çš„æœŸæœ›ç´¯è®¡å¥–åŠ±ï¼Œè€Œ ( Q(s, a) ) åˆ™è¡¨ç¤ºåœ¨çŠ¶æ€ ( s ) é‡‡å–åŠ¨ä½œ ( a )åçš„æœŸæœ›ç´¯è®¡å¥–åŠ±ã€‚</li><li><strong>ç­–ç•¥é—´æ¥å¯¼å‡º</strong>ï¼šè¿™äº›æ–¹æ³•é€šå¸¸ä¸ç›´æ¥è¡¨ç¤ºç­–ç•¥ï¼Œè€Œæ˜¯é€šè¿‡ä¼˜åŒ–å€¼å‡½æ•°ï¼Œç„¶åä»ä¸­æ¨å¯¼å‡ºæœ€ä¼˜ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œåœ¨ç»™å®š( Q(s, a) ) çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡é€‰æ‹©ä½¿ ( Q(s, a) )æœ€å¤§çš„åŠ¨ä½œæ¥è·å¾—æœ€ä¼˜ç­–ç•¥ã€‚</li><li><strong>çŠ¶æ€ä»·å€¼å‡½æ•°</strong> <spanclass="math inline">\(V(s)\)</span>ï¼šè¯„ä¼°â€åœ¨çŠ¶æ€sä¸‹ï¼ŒæŒ‰ç…§å½“å‰ç­–ç•¥èƒ½è·å¾—å¤šå°‘é•¿æœŸå¥–åŠ±â€</li><li><strong>åŠ¨ä½œä»·å€¼å‡½æ•°</strong> <spanclass="math inline">\(Q(s,a)\)</span>ï¼šè¯„ä¼°â€åœ¨çŠ¶æ€sä¸‹é‡‡å–åŠ¨ä½œaï¼Œèƒ½è·å¾—å¤šå°‘é•¿æœŸå¥–åŠ±â€</li></ul><p>æœ‰äº†è¿™äº›ä»·å€¼è¯„ä¼°ï¼Œç­–ç•¥å°±æ°´åˆ°æ¸ æˆäº†â€”â€”æ€»æ˜¯é€‰æ‹©ä»·å€¼æœ€é«˜çš„åŠ¨ä½œã€‚</p><h4 id="å…¸å‹ç®—æ³•">å…¸å‹ç®—æ³•</h4><p><strong>Qå­¦ä¹ (Q-Learning)</strong>ï¼šæœ€ç»å…¸çš„å€¼å‡½æ•°æ–¹æ³•</p><ul><li>ç›´æ¥å­¦ä¹ æœ€ä¼˜åŠ¨ä½œä»·å€¼å‡½æ•° <spanclass="math inline">\(Q^*(s,a)\)</span></li><li>é‡‡ç”¨â€æ—¶é—´å·®åˆ†â€çš„æ€æƒ³é€æ­¥æ”¹è¿›Qå€¼ä¼°è®¡</li><li>å±äºoff-policyç®—æ³•ï¼Œå¯ä»¥ä»ä»»æ„è¡Œä¸ºç­–ç•¥ä¸­å­¦ä¹ </li></ul><p><strong>æ·±åº¦Qç½‘ç»œ(DQN)</strong>ï¼šQå­¦ä¹ çš„æ·±åº¦å­¦ä¹ ç‰ˆæœ¬</p><ul><li>ç”¨ç¥ç»ç½‘ç»œè¿‘ä¼¼Qå‡½æ•°ï¼Œå¤„ç†é«˜ç»´çŠ¶æ€ç©ºé—´</li><li>å¼•å…¥ç»éªŒå›æ”¾å’Œç›®æ ‡ç½‘ç»œç­‰æŠ€å·§æé«˜ç¨³å®šæ€§</li></ul><h3 id="åŸºäºç­–ç•¥çš„æ–¹æ³•ç›´æ¥ä¼˜åŒ–å†³ç­–">1.2åŸºäºç­–ç•¥çš„æ–¹æ³•ï¼šç›´æ¥ä¼˜åŒ–å†³ç­–</h3><p>å¦‚æœè¯´å€¼å‡½æ•°æ–¹æ³•æ˜¯â€ä¸‰æ€è€Œåè¡Œâ€ï¼Œé‚£ä¹ˆç­–ç•¥æ–¹æ³•å°±æ˜¯â€ç†Ÿèƒ½ç”Ÿå·§â€â€”â€”ç›´æ¥ç»ƒä¹ å†³ç­–è¿‡ç¨‹æœ¬èº«ï¼Œé€šè¿‡ä¸æ–­è¯•é”™æ¥æ”¹è¿›ç­–ç•¥ã€‚</p><h4 id="æ ¸å¿ƒç†å¿µ-1">æ ¸å¿ƒç†å¿µ</h4><p>åŸºäºç­–ç•¥çš„æ–¹æ³•å°†ç­–ç•¥å‚æ•°åŒ–ä¸º <spanclass="math inline">\(\pi_\theta(a|s)\)</span>ï¼Œç›´æ¥ä¼˜åŒ–ç­–ç•¥å‚æ•° <spanclass="math inline">\(\theta\)</span>ï¼š</p><ul><li><strong>ç›®æ ‡æ˜ç¡®</strong>ï¼šæœ€å¤§åŒ–æœŸæœ›ç´¯ç§¯å¥–åŠ± <spanclass="math inline">\(J(\theta) = \mathbb{E}_{\tau \sim\pi_\theta}[R(\tau)]\)</span></li><li><strong>æ¢¯åº¦ä¸Šå‡</strong>ï¼šåˆ©ç”¨ç­–ç•¥æ¢¯åº¦å®šç†è®¡ç®—å‚æ•°æ›´æ–°æ–¹å‘</li><li><strong>è‡ªç„¶æ¢ç´¢</strong>ï¼šéšæœºç­–ç•¥å¤©ç„¶å…·å¤‡æ¢ç´¢èƒ½åŠ›</li></ul><h4 id="ç­–ç•¥æ¢¯åº¦å®šç†">ç­–ç•¥æ¢¯åº¦å®šç†</h4><p>ç­–ç•¥ä¼˜åŒ–çš„æ•°å­¦åŸºç¡€æ¥è‡ªäºè‘—åçš„ç­–ç•¥æ¢¯åº¦å®šç†ï¼š</p><p><span class="math display">\[\nabla_\theta J(\theta) =\mathbb{E}_{\pi_\theta}[\nabla_\theta \log \pi_\theta(a|s) \cdotQ^{\pi_\theta}(s,a)]\]</span></p><p>è¿™ä¸ªå…¬å¼å‘Šè¯‰æˆ‘ä»¬ï¼šå¦‚æœæŸä¸ªåŠ¨ä½œçš„ä»·å€¼é«˜ï¼Œå°±å¢åŠ é€‰æ‹©å®ƒçš„æ¦‚ç‡ï¼›åä¹‹åˆ™é™ä½æ¦‚ç‡ã€‚</p><h4 id="å…¸å‹ç®—æ³•-1">å…¸å‹ç®—æ³•</h4><p><strong>REINFORCEç®—æ³•</strong>ï¼šæœ€åŸºç¡€çš„ç­–ç•¥æ¢¯åº¦æ–¹æ³•</p><ul><li>ä½¿ç”¨è’™ç‰¹å¡æ´›æ–¹æ³•ä¼°è®¡å›æŠ¥</li><li>ç®€å•ç›´æ¥ï¼Œä½†æ–¹å·®è¾ƒå¤§</li></ul><p><strong>PPO(Proximal PolicyOptimization)</strong>ï¼šç°ä»£ç­–ç•¥ä¼˜åŒ–çš„ä»£è¡¨</p><ul><li>é€šè¿‡â€ä¿¡ä»»åŒºåŸŸâ€æ€æƒ³æ§åˆ¶ç­–ç•¥æ›´æ–°å¹…åº¦</li><li>åœ¨æ ·æœ¬æ•ˆç‡å’Œç¨³å®šæ€§é—´å–å¾—è‰¯å¥½å¹³è¡¡</li></ul><h2 id="ä¸¤ç§æ–¹æ³•çš„æ·±åº¦å¯¹æ¯”">1.3 ä¸¤ç§æ–¹æ³•çš„æ·±åº¦å¯¹æ¯”</h2><table><thead><tr><th>ç»´åº¦</th><th>åŸºäºå€¼å‡½æ•°</th><th>åŸºäºç­–ç•¥</th></tr></thead><tbody><tr><td><strong>åŠ¨ä½œç©ºé—´</strong></td><td>é€‚åˆç¦»æ•£åŠ¨ä½œ</td><td>å¤©ç„¶æ”¯æŒè¿ç»­åŠ¨ä½œ</td></tr><tr><td><strong>ç­–ç•¥å¤æ‚åº¦</strong></td><td>ç®€å•ç¡®å®šæ€§ç­–ç•¥</td><td>æ”¯æŒå¤æ‚éšæœºç­–ç•¥</td></tr><tr><td><strong>æ ·æœ¬æ•ˆç‡</strong></td><td>é€šå¸¸è¾ƒé«˜</td><td>ç›¸å¯¹è¾ƒä½</td></tr><tr><td><strong>æ¢ç´¢æœºåˆ¶</strong></td><td>éœ€è¦é¢å¤–è®¾è®¡(å¦‚Îµ-è´ªå¿ƒ)</td><td>ç­–ç•¥æœ¬èº«åŒ…å«æ¢ç´¢</td></tr></tbody></table><h4 id="å€¼å‡½æ•°æ–¹æ³•çš„ç‰¹ç‚¹">å€¼å‡½æ•°æ–¹æ³•çš„ç‰¹ç‚¹</h4><ul><li>æ ·æœ¬æ•ˆç‡é«˜ï¼Œèƒ½ä»æœ‰é™ç»éªŒä¸­é«˜æ•ˆå­¦ä¹ </li><li>ç†è®ºåŸºç¡€æ‰å®ï¼ŒåŸºäºè´å°”æ›¼æ–¹ç¨‹</li><li>åœ¨ç¦»æ•£åŠ¨ä½œç©ºé—´ä¸­è¡¨ç°ä¼˜å¼‚</li><li>éš¾ä»¥å¤„ç†è¿ç»­æˆ–é«˜ç»´åŠ¨ä½œç©ºé—´</li><li>éœ€è¦é¢å¤–æœºåˆ¶å¹³è¡¡æ¢ç´¢ä¸åˆ©ç”¨</li><li>å‡½æ•°è¿‘ä¼¼å¯èƒ½å¯¼è‡´ä¸ç¨³å®š</li></ul><h4 id="ç­–ç•¥æ–¹æ³•çš„ç‰¹ç‚¹">ç­–ç•¥æ–¹æ³•çš„ç‰¹ç‚¹</h4><ul><li>è‡ªç„¶å¤„ç†è¿ç»­åŠ¨ä½œç©ºé—´</li><li>ç­–ç•¥è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œå¯å­¦ä¹ å¤æ‚è¡Œä¸º</li><li>æ”¶æ•›æ€§ä¿è¯è¾ƒå¥½ï¼ˆåœ¨åˆé€‚æ¡ä»¶ä¸‹ï¼‰</li><li>æ ·æœ¬éœ€æ±‚é‡å¤§</li><li>æ¢¯åº¦ä¼°è®¡æ–¹å·®é«˜ï¼Œéœ€è¦é™æ–¹å·®æŠ€å·§</li><li>å®¹æ˜“é™·å…¥å±€éƒ¨æœ€ä¼˜</li></ul><h3 id="èåˆä¹‹é“actor-criticæ–¹æ³•">1.4 èåˆä¹‹é“ï¼šActor-Criticæ–¹æ³•</h3><p>æ—¢ç„¶ä¸¤ç§æ–¹æ³•å„æœ‰æ‰€é•¿ï¼Œè‡ªç„¶æœ‰äººæƒ³åˆ°å°†å®ƒä»¬ç»“åˆèµ·æ¥ã€‚è¿™å°±æ˜¯<strong>Actor-Criticæ–¹æ³•</strong>çš„æ ¸å¿ƒæ€æƒ³ï¼š</p><ul><li><strong>Actor(æ¼”å‘˜)</strong>ï¼šåŸºäºç­–ç•¥çš„ç»„ä»¶ï¼Œè´Ÿè´£é€‰æ‹©åŠ¨ä½œ</li><li><strong>Critic(è¯„è®ºå®¶)</strong>ï¼šåŸºäºå€¼å‡½æ•°çš„ç»„ä»¶ï¼Œè´Ÿè´£è¯„ä¼°åŠ¨ä½œä»·å€¼</li></ul><p>è¿™ç§ç»“åˆå¸¦æ¥äº†æ˜¾è‘—ä¼˜åŠ¿ï¼š</p><ol type="1"><li>Criticå¸®åŠ©Actorå‡å°‘æ¢¯åº¦æ–¹å·®</li><li>Actorä¸ºCriticæä¾›æ›´å¥½çš„æ¢ç´¢ç­–ç•¥</li><li>ä¸¤è€…ç›¸äº’ä¿ƒè¿›ï¼ŒåŠ é€Ÿæ”¶æ•›</li></ol><h2 id="åŠ¨æ€è§„åˆ’ä¸­çš„ç»å…¸å¯¹å†³ç­–ç•¥è¿­ä»£-vs-ä»·å€¼è¿­ä»£">2.åŠ¨æ€è§„åˆ’ä¸­çš„ç»å…¸å¯¹å†³ï¼šç­–ç•¥è¿­ä»£ vs ä»·å€¼è¿­ä»£</h2><p>åœ¨åŸºäºå€¼å‡½æ•°çš„æ–¹æ³•ä¸­ï¼ŒåŠ¨æ€è§„åˆ’æä¾›äº†ä¸¤ç§ç»å…¸çš„æ±‚è§£æ€è·¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç­–ç•¥è¿­ä»£å’Œä»·å€¼è¿­ä»£éƒ½å±äº<strong>åŸºäºå€¼å‡½æ•°</strong>çš„æ–¹æ³•ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºå¦‚ä½•åˆ©ç”¨å€¼å‡½æ•°æ¥ä¼˜åŒ–ç­–ç•¥ã€‚</p><h3 id="ç­–ç•¥è¿­ä»£">2.1 ç­–ç•¥è¿­ä»£</h3><p>ç­–ç•¥è¿­ä»£æ˜¯ä¸€ç§é€šè¿‡ä¸æ–­äº¤æ›¿æ‰§è¡Œ<strong>ç­–ç•¥è¯„ä¼°</strong>å’Œ<strong>ç­–ç•¥æ”¹è¿›</strong>æ¥æ‰¾åˆ°æœ€ä¼˜ç­–ç•¥çš„æ–¹æ³•ã€‚</p><ul><li><strong>ç­–ç•¥è¯„ä¼°</strong>ï¼šå›ºå®šå½“å‰ç­–ç•¥ï¼Œè®¡ç®—è¯¥ç­–ç•¥ä¸‹æ‰€æœ‰çŠ¶æ€çš„å€¼å‡½æ•°(V^(s))ï¼Œå³è¯„ä¼°åœ¨å½“å‰ç­–ç•¥ä¸‹ï¼Œæ¯ä¸ªçŠ¶æ€çš„é•¿æœŸå¥–åŠ±ã€‚</li><li><strong>ç­–ç•¥æ”¹è¿›</strong>ï¼šåˆ©ç”¨è¯„ä¼°å‡ºçš„å€¼å‡½æ•°ï¼Œæ”¹è¿›å½“å‰ç­–ç•¥ï¼Œå³åœ¨æ¯ä¸ªçŠ¶æ€ä¸‹é€‰æ‹©ä½¿å€¼å‡½æ•°æœ€å¤§çš„åŠ¨ä½œã€‚</li></ul><p>ç­–ç•¥è¿­ä»£çš„æ­¥éª¤æ˜¯ï¼š</p><ol type="1"><li>åˆå§‹åŒ–ç­–ç•¥ (_0)ã€‚</li><li>å¯¹ç­–ç•¥ (_i) è¿›è¡Œç­–ç•¥è¯„ä¼°ï¼Œè®¡ç®—å¯¹åº”çš„å€¼å‡½æ•° (V^{_i}(s))ã€‚</li><li>åŸºäº (V^{<em>i}(s)) æ”¹è¿›ç­–ç•¥ï¼Œå¾—åˆ°æ–°çš„ç­–ç•¥ (</em>{i+1})ã€‚</li><li>é‡å¤æ­¥éª¤ 2 å’Œ 3ï¼Œç›´åˆ°ç­–ç•¥æ”¶æ•›åˆ°æœ€ä¼˜ç­–ç•¥ (^*)ã€‚</li></ol><h3 id="ä»·å€¼è¿­ä»£">2.2 ä»·å€¼è¿­ä»£</h3><p>ä»·å€¼è¿­ä»£é€šè¿‡ç›´æ¥æ›´æ–°å€¼å‡½æ•°çš„æ–¹å¼æ¥è¿­ä»£é€¼è¿‘æœ€ä¼˜å€¼å‡½æ•°(V^*(s))ï¼Œç„¶åé€šè¿‡å€¼å‡½æ•°å¯¼å‡ºç­–ç•¥ã€‚</p><ul><li>æ¯ä¸€æ­¥éƒ½ä¼šå¯¹æ¯ä¸ªçŠ¶æ€ (s) æ›´æ–°å…¶å€¼å‡½æ•°ä¸ºæœ€å¤§åŒ–é¢„æœŸå¥–åŠ±çš„å€¼</li><li>é€šè¿‡ä¸æ–­æ›´æ–°å€¼å‡½æ•°ï¼Œé€æ­¥é€¼è¿‘æœ€ä¼˜å€¼å‡½æ•°ã€‚å½“å€¼å‡½æ•°æ”¶æ•›æ—¶ï¼Œå¯ä»¥é€šè¿‡é€‰æ‹©æœ€å¤§åŒ–å€¼å‡½æ•°çš„åŠ¨ä½œæ¥è·å¾—æœ€ä¼˜ç­–ç•¥ã€‚</li></ul><p>ä»·å€¼è¿­ä»£çš„æ­¥éª¤æ˜¯ï¼š</p><ol type="1"><li>åˆå§‹åŒ–å€¼å‡½æ•° (V_0(s))ã€‚</li><li>å¯¹æ¯ä¸ªçŠ¶æ€ (s)ï¼Œæ›´æ–°å€¼å‡½æ•° (V_{i+1}(s))ï¼Œä½¿å…¶æœ€å¤§åŒ–é¢„æœŸå›æŠ¥ã€‚</li><li>é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°å€¼å‡½æ•°æ”¶æ•›ã€‚</li><li>å½“å€¼å‡½æ•°æ”¶æ•›åï¼Œé€šè¿‡é€‰æ‹©ä½¿ (V(s)) æœ€å¤§çš„åŠ¨ä½œ(a)ï¼Œå¯¼å‡ºæœ€ä¼˜ç­–ç•¥ã€‚</li></ol><h3 id="ç­–ç•¥è¿­ä»£-vs-ä»·å€¼è¿­ä»£">2.3 ç­–ç•¥è¿­ä»£ vs ä»·å€¼è¿­ä»£</h3><ul><li><strong>ç­–ç•¥è¿­ä»£</strong>ï¼šäº¤æ›¿æ‰§è¡Œå®Œæ•´çš„ç­–ç•¥è¯„ä¼°å’Œç­–ç•¥æ”¹è¿›ï¼Œè®¡ç®—è¾ƒç²¾ç¡®çš„ç­–ç•¥æ›´æ–°ï¼Œé€šå¸¸æ”¶æ•›è¾ƒå¿«ï¼Œä½†æ¯æ¬¡è¯„ä¼°éœ€è¦èŠ±è´¹è¾ƒå¤šæ—¶é—´ã€‚</li><li><strong>ä»·å€¼è¿­ä»£</strong>ï¼šåœ¨æ›´æ–°å€¼å‡½æ•°çš„åŒæ—¶éšå¼ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯æ¬¡æ›´æ–°çš„ç²’åº¦è¾ƒå°ï¼Œè™½ç„¶æ›´æ–°é€Ÿåº¦å¿«ï¼Œä½†å¯èƒ½éœ€è¦æ›´å¤šè¿­ä»£æ¬¡æ•°æ‰èƒ½è¾¾åˆ°æ”¶æ•›ã€‚</li></ul><table><thead><tr><th style="text-align: center;">ç‰¹æ€§</th><th style="text-align: center;">ç­–ç•¥è¿­ä»£</th><th style="text-align: center;">ä»·å€¼è¿­ä»£</th></tr></thead><tbody><tr><td style="text-align: center;">è¿­ä»£æ­¥éª¤</td><td style="text-align: center;">ç­–ç•¥è¯„ä¼° + ç­–ç•¥æ”¹è¿›</td><td style="text-align: center;">å€¼å‡½æ•°æ›´æ–°</td></tr><tr><td style="text-align: center;">æ¯æ¬¡è¿­ä»£æˆæœ¬</td><td style="text-align: center;">é«˜</td><td style="text-align: center;">ä½</td></tr><tr><td style="text-align: center;">è¿­ä»£æ¬¡æ•°</td><td style="text-align: center;">å°‘</td><td style="text-align: center;">å¤š</td></tr><tr><td style="text-align: center;">æ”¶æ•›é€Ÿåº¦</td><td style="text-align: center;">å¿«</td><td style="text-align: center;">æ…¢</td></tr><tr><td style="text-align: center;">é€‚ç”¨åœºæ™¯</td><td style="text-align: center;">å°å‹ MDPï¼Œéœ€ç²¾ç¡®è§£</td><td style="text-align: center;">å¤§å‹ MDPï¼Œéœ€å¿«é€Ÿè¿‘ä¼¼</td></tr><tr><td style="text-align: center;">ç¨³å®šæ€§</td><td style="text-align: center;">é«˜</td><td style="text-align: center;">å¯èƒ½éœ‡è¡ï¼Œéœ€è¦è°ƒèŠ‚å‚æ•°</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€” 12 DDPGç®—æ³•</title>
      <link href="/2024/09/17/RL/12%20DDPG%E7%AE%97%E6%B3%95/"/>
      <url>/2024/09/17/RL/12%20DDPG%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="ddpgç®—æ³•">12 DDPGç®—æ³•</h2><p>æ·±åº¦ç¡®å®šæ€§ç­–ç•¥æ¢¯åº¦æ˜¯åœ¨åŠ¨ä½œç©ºé—´æ— é™çš„ç¯å¢ƒä½¿ç”¨off-policyçš„actor-criticç®—æ³•ã€‚å®ƒå®ƒçš„actoræ˜¯ä¸€ä¸ªç¡®å®šæ€§ç­–ç•¥ï¼Œé€šè¿‡æ¢¯åº¦ä¸Šå‡æ³•æ¥æœ€å¤§åŒ–Qå€¼ï¼›å®ƒçš„criticæ˜¯ä¸€ä¸ªQç½‘ç»œï¼Œé€šè¿‡æ¢¯åº¦ä¸‹é™æ³•æ¥æœ€å°åŒ–Qå€¼çš„TDè¯¯å·®ã€‚</p><h3 id="ddpgç®—æ³•-1">12.1 DDPGç®—æ³•</h3><h4 id="ç®—æ³•å¼•å‡º">12.1.1 ç®—æ³•å¼•å‡º</h4><ol type="1"><li>TRPOå’ŒPPOæ˜¯on-policyçš„actor-criticç®—æ³•ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åªèƒ½åœ¨å½“å‰ç­–ç•¥ä¸Šè¿›è¡Œæ›´æ–°ï¼Œæ ·æœ¬æ•ˆç‡è¾ƒä½ã€‚</li><li>DQNæ˜¯off-policyçš„Q-learningç®—æ³•ï¼Œç›´æ¥ä¼°è®¡Qå€¼ï¼Œæ ·æœ¬æ•ˆç‡è¾ƒé«˜ï¼Œä½†æ˜¯ä½†æ˜¯å®ƒåªèƒ½å¤„ç†åŠ¨ä½œç©ºé—´æœ‰é™çš„ç¯å¢ƒï¼Œè¿™æ˜¯å› ä¸ºå®ƒéœ€è¦ä»æ‰€æœ‰åŠ¨ä½œä¸­æŒ‘é€‰ä¸€ä¸ª<spanclass="math inline">\(Q\)</span>å€¼æœ€å¤§çš„åŠ¨ä½œã€‚è™½ç„¶å¯ä»¥å°†å°†åŠ¨ä½œç©ºé—´ç¦»æ•£åŒ–ï¼Œä½†è¿™æ¯”è¾ƒç²—ç³™ï¼Œæ— æ³•ç²¾ç»†æ§åˆ¶ã€‚</li><li>TRPOå’ŒPPOå­¦ä¹ çš„æ˜¯éšæœºç­–ç•¥ï¼Œè€ŒDDPGå­¦ä¹ çš„ç¡®å®šæ€§ç­–ç•¥ã€‚éšæœºç­–ç•¥å¯ä»¥è¡¨ç¤ºä¸º<spanclass="math inline">\(a\sim\pi_\theta(a|s)\)</span>ï¼Œç¡®å®šæ€§ç­–ç•¥å¯ä»¥è¡¨ç¤ºä¸º<spanclass="math inline">\(a=\mu_\theta(s)\)</span>ã€‚</li></ol><h4 id="ç®—æ³•å…¬å¼">12.1.2 ç®—æ³•å…¬å¼</h4><p>ç¡®å®šæ€§ç­–ç•¥æ¢¯åº¦å®šç†ï¼š</p><p><span class="math display">\[\nabla_\theta J(\mu_\theta)=\mathbb{E}_{s\sim \rho_\mu,a\sim\mu_\theta}[\nabla_\theta \mu_\theta(s)\nabla_aQ_\phi(s,a)|_{a=\mu_\theta(s)}]\]</span></p><p><strong>è¿™ä¸ªå…¬å¼å¯ä»¥ç†è§£ä¸º</strong>ï¼šå‡å®šç°åœ¨å·²æœ‰å‡½æ•°<spanclass="math inline">\(Q\)</span>ï¼Œç»™å®šä¸€ä¸ªçŠ¶æ€<spanclass="math inline">\(s\)</span>ï¼Œä½†ç”±äºç°åœ¨åŠ¨ä½œç©ºé—´æ˜¯æ— é™çš„ï¼Œæ‰€ä»¥æ— æ³•éå†æ‰€æœ‰åŠ¨ä½œæ¥å¾—åˆ°æœ€å¤§çš„<spanclass="math inline">\(Q\)</span>å€¼ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ç­–ç•¥<spanclass="math inline">\(\mu_\theta(s)\)</span>æ¥æ‰¾åˆ°ä¸€ä¸ªåŠ¨ä½œ<spanclass="math inline">\(a\)</span>ï¼Œä½¿å¾—<spanclass="math inline">\(Q(s,a)\)</span>æœ€å¤§ã€‚æ­¤æ—¶ï¼Œ<spanclass="math inline">\(Q\)</span>å°±æ˜¯critic,<spanclass="math inline">\(\mu_\theta(s)\)</span>å°±æ˜¯actorã€‚</p><h4 id="ç®—æ³•æè¿°">12.1.3 ç®—æ³•æè¿°</h4><p>DDPGè¦ç”¨åˆ°4ä¸ªç½‘ç»œï¼š<spanclass="math inline">\(\mu,\mu&#39;,Q,Q&#39;\)</span>ã€‚å…¶ä¸­<spanclass="math inline">\(\mu\)</span>æ˜¯actorï¼Œ<spanclass="math inline">\(Q\)</span>æ˜¯criticï¼Œ<spanclass="math inline">\(\mu&#39;\)</span>æ˜¯actorçš„targetç½‘ç»œï¼Œ<spanclass="math inline">\(Q&#39;\)</span>æ˜¯criticçš„targetç½‘ç»œã€‚</p><p>ç›®æ ‡ç½‘ç»œçš„çš„æ›´æ–°æ–¹å¼æ˜¯<strong>è½¯æ›´æ–°</strong>ï¼š <spanclass="math display">\[\omega^-=\tau\omega+(1-\tau)\omega^-\]</span> å…¶ä¸­<spanclass="math inline">\(\tau\)</span>æ˜¯æ›´æ–°ç³»æ•°ï¼Œé€šå¸¸å¾ˆå°çš„ä¸€ä¸ªæ•°ã€‚å½“<spanclass="math inline">\(\tau = 1\)</span>æ—¶ï¼Œå°±å’ŒDQNæ›´æ–°æ–¹å¼ä¸€æ ·äº†ã€‚</p><p>å¦å¤–ï¼Œç”±äºå‡½æ•°<span class="math inline">\(Q\)</span>å­˜åœ¨<spanclass="math inline">\(Q\)</span>å€¼ä¼°å€¼è¿‡é«˜çš„é—®é¢˜ï¼ŒDDPG é‡‡ç”¨äº† Double DQNä¸­çš„æŠ€æœ¯æ¥æ›´æ–°<span class="math inline">\(Q\)</span>ç½‘ç»œã€‚ ä½†æ˜¯ï¼Œç”±äºDDPGé‡‡ç”¨çš„æ˜¯ç¡®å®šæ€§ç­–ç•¥ï¼Œå®ƒæœ¬èº«çš„æ¢ç´¢ä»ç„¶ååˆ†æœ‰é™ã€‚ä½œä¸ºä¸€ç§ç¦»çº¿ç­–ç•¥çš„ç®—æ³•ï¼ŒDDPGåœ¨è¡Œä¸ºç­–ç•¥ä¸Š<strong>å¼•å…¥ä¸€ä¸ªéšæœºå™ªå£°<spanclass="math inline">\(\mathcal{N}\)</span>æ¥è¿›è¡Œæ¢ç´¢</strong>ã€‚</p><h4 id="ç®—æ³•æµç¨‹">12.1.4 ç®—æ³•æµç¨‹</h4><ol type="1"><li>éšæœºåˆå§‹åŒ–actorå’Œcriticçš„ç½‘ç»œå‚æ•°<spanclass="math inline">\(\theta\)</span>å’Œ<spanclass="math inline">\(\omega\)</span>ï¼Œåˆå§‹åŒ–å™ªå£°è¿‡ç¨‹<spanclass="math inline">\(\mathcal{N}\)</span>ã€‚</li><li>å¤åˆ¶<span class="math inline">\(\theta\)</span>å’Œ<spanclass="math inline">\(\omega\)</span>åˆ°<spanclass="math inline">\(\theta^-\)</span>å’Œ<spanclass="math inline">\(\omega^-\)</span>ï¼Œåˆå§‹åŒ–ç›®æ ‡ç½‘ç»œã€‚</li><li>åˆå§‹åŒ–ç»éªŒå›æ”¾æ± <spanclass="math inline">\(\mathcal{D}\)</span>ã€‚</li><li>for è½®æ¬¡<span class="math inline">\(episode=1,2,...,E\)</span> do<ul><li>åˆå§‹åŒ–éšæœºè¿‡ç¨‹<spanclass="math inline">\(\mathcal{N}\)</span>ç”¨æ¥æ¢ç´¢ã€‚</li><li>è·å–ç¯å¢ƒåˆå§‹çŠ¶æ€<span class="math inline">\(s_1\)</span>ã€‚</li><li>for æ—¶é—´æ­¥ t=1,2,â€¦,T do<ul><li>æ ¹æ®å½“å‰ç­–ç•¥å’Œå™ªå£°é€‰æ‹©åŠ¨ä½œ<span class="math inline">\(a_t =\mu_\theta(s_t)+\mathcal{N}\)</span>ã€‚</li><li>æ‰§è¡ŒåŠ¨ä½œ<span class="math inline">\(a_t\)</span>ï¼Œå¾—åˆ°æ–°çŠ¶æ€<spanclass="math inline">\(s_{t+1}\)</span>ï¼Œå¥–åŠ±<spanclass="math inline">\(r_t\)</span>ã€‚</li><li>å°†<spanclass="math inline">\((s_t,a_t,r_t,s_{t+1})\)</span>å­˜å…¥<spanclass="math inline">\(\mathcal{D}\)</span>ã€‚</li><li>ä»<span class="math inline">\(\mathcal{D}\)</span>ä¸­éšæœºé‡‡æ ·<spanclass="math inline">\(N\)</span>ä¸ªæ ·æœ¬<spanclass="math inline">\({(s_i,a_i,r_i,s_{i+1})}_{i=1,2,...,N}\)</span>ã€‚</li><li>å¯¹æ¯ä¸ªæ ·æœ¬<spanclass="math inline">\(i\)</span>ï¼Œç”¨ç›®æ ‡ç½‘ç»œè®¡ç®—<spanclass="math inline">\(y_i=r_i+\gammaQ_\phi(s_{i+1},\mu_\theta(s_{i+1}))\)</span>ã€‚</li><li>æœ€å°åŒ–ç›®æ ‡æŸå¤±å‡½æ•°<spanclass="math inline">\(L(\omega)=\frac{1}{N}\sum_i(y_i-Q_\omega(s_i,a_i))^2\)</span>ï¼Œæ›´æ–°å½“å‰criticç½‘ç»œå‚æ•°<spanclass="math inline">\(\omega\)</span>ã€‚</li><li>è®¡ç®—é‡‡æ ·çš„<spanclass="math inline">\(N\)</span>ä¸ªåŠ¨ä½œçš„ç­–ç•¥æ¢¯åº¦ï¼Œæ›´æ–°å½“å‰actorç½‘ç»œå‚æ•°<spanclass="math inline">\(\theta\)</span>ã€‚<spanclass="math inline">\(\nabla_\theta J \approx\frac{1}{N}\sum_i\nabla_\theta \mu_\theta(s_i)\nabla_aQ_\phi(s_i,a_i)|_{a=\mu_\theta(s_i)}\)</span></li><li>æ›´æ–°ç›®æ ‡ç½‘ç»œã€‚<spanclass="math inline">\(\omega^-=\tau\omega+(1-\tau)\omega^-,\theta^-=\tau\theta+(1-\tau)\theta^-\)</span>ã€‚</li></ul></li><li>end for</li></ul></li><li>end for</li></ol>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€” 9 Actor-Criticç®—æ³•</title>
      <link href="/2024/09/17/RL/9%20Actor-Critic%E7%AE%97%E6%B3%95/"/>
      <url>/2024/09/17/RL/9%20Actor-Critic%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="actor-criticç®—æ³•">9 Actor-Criticç®—æ³•</h2><p>Actor-Criticç®—æ³•æ˜¯åŸºäº<strong>å€¼å‡½æ•°çš„æ–¹æ³•å’ŒåŸºäºç­–ç•¥çš„æ–¹æ³•çš„å åŠ </strong>ã€‚ä»·å€¼æ¨¡å—Critic åœ¨<strong>ç­–ç•¥æ¨¡å— Actoré‡‡æ ·çš„æ•°æ®</strong>ä¸­å­¦ä¹ åˆ†è¾¨ä»€ä¹ˆæ˜¯å¥½çš„åŠ¨ä½œï¼Œä»€ä¹ˆä¸æ˜¯å¥½çš„åŠ¨ä½œï¼Œè¿›è€Œ<strong>æŒ‡å¯¼Actor è¿›è¡Œç­–ç•¥æ›´æ–°</strong>ã€‚éšç€ Actorçš„è®­ç»ƒçš„è¿›è¡Œï¼Œå…¶ä¸ç¯å¢ƒäº¤äº’æ‰€äº§ç”Ÿçš„æ•°æ®åˆ†å¸ƒä¹Ÿå‘ç”Ÿæ”¹å˜ï¼Œè¿™éœ€è¦ Criticå°½å¿«é€‚åº”æ–°çš„æ•°æ®åˆ†å¸ƒå¹¶ç»™å‡ºå¥½çš„åˆ¤åˆ«ã€‚</p><h3 id="actor-criticç®—æ³•-1">9.1 Actor-Criticç®—æ³•</h3><p>Actor-Criticç®—æ³•æ—¢å­¦ä¹ ä»·å€¼å‡½æ•°ï¼Œåˆå­¦ä¹ ç­–ç•¥å‡½æ•°ã€‚ä¸è¿‡æœ¬è´¨ä¸Šæ˜¯åŸºäºç­–ç•¥çš„ç®—æ³•ï¼Œå› ä¸ºè¿™ä¸€ç³»åˆ—ç®—æ³•çš„ç›®æ ‡éƒ½æ˜¯ä¼˜åŒ–ä¸€ä¸ªå¸¦å‚æ•°çš„ç­–ç•¥ï¼Œåªæ˜¯ä¼šé¢å¤–å­¦ä¹ ä»·å€¼å‡½æ•°ï¼Œä»è€Œå¸®åŠ©ç­–ç•¥å‡½æ•°æ›´å¥½åœ°å­¦ä¹ ã€‚</p><p>åœ¨ REINFORCEç®—æ³•ä¸­ï¼Œç›®æ ‡å‡½æ•°çš„æ¢¯åº¦ä¸­æœ‰ä¸€é¡¹è½¨è¿¹å›æŠ¥ï¼Œç”¨äºæŒ‡å¯¼ç­–ç•¥çš„æ›´æ–°ã€‚REINFOCEç®—æ³•ç”¨è’™ç‰¹å¡æ´›æ–¹æ³•æ¥ä¼°è®¡<spanclass="math inline">\(Q^{\pi_\theta}(s,a)\)</span>ï¼Œèƒ½ä¸èƒ½è€ƒè™‘<strong>æ‹Ÿåˆä¸€ä¸ªå€¼å‡½æ•°æ¥</strong>æŒ‡å¯¼ç­–ç•¥è¿›è¡Œå­¦ä¹ å‘¢ï¼Ÿè¿™æ­£æ˜¯Actor-Critic ç®—æ³•æ‰€åšçš„ã€‚</p><p>Actor-Critic ç®—æ³•ä¼°<strong>è®¡ä¸€ä¸ªåŠ¨ä½œä»·å€¼å‡½æ•°<spanclass="math inline">\(Q\)</span>ï¼Œä»£æ›¿è’™ç‰¹å¡æ´›é‡‡æ ·å¾—åˆ°çš„å›æŠ¥</strong>ã€‚</p><p>REINFORCEç®—æ³•åŸºäºè’™ç‰¹å¡æ´›é‡‡æ ·ï¼Œåªèƒ½åœ¨åºåˆ—ç»“æŸåè¿›è¡Œæ›´æ–°ï¼Œè¿™åŒæ—¶ä¹Ÿè¦æ±‚ä»»åŠ¡å…·æœ‰æœ‰é™çš„æ­¥æ•°ï¼›è€ŒActor-Criticç®—æ³•åˆ™å¯ä»¥åœ¨<strong>æ¯ä¸€æ­¥ä¹‹åéƒ½è¿›è¡Œæ›´æ–°</strong>ï¼Œå¹¶ä¸”ä¸å¯¹ä»»åŠ¡çš„æ­¥æ•°åšé™åˆ¶ã€‚</p><h3 id="actor-criticç®—æ³•æè¿°">9.2 Actor-Criticç®—æ³•æè¿°</h3><p>Actor-Critic ç®—æ³•åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>ç­–ç•¥ç½‘ç»œï¼ˆActorï¼‰ï¼šè¦åšçš„æ˜¯<strong>ä¸ç¯å¢ƒäº¤äº’</strong>ï¼Œå¹¶åœ¨ Criticä»·å€¼å‡½æ•°çš„æŒ‡å¯¼ä¸‹ç”¨ç­–ç•¥æ¢¯åº¦å­¦ä¹ ä¸€ä¸ªæ›´å¥½çš„ç­–ç•¥ã€‚</li><li>ä»·å€¼ç½‘ç»œï¼ˆCriticï¼‰ï¼šè¦åšçš„æ˜¯<strong>é€šè¿‡ Actorä¸ç¯å¢ƒäº¤äº’æ”¶é›†çš„æ•°æ®å­¦ä¹ ä¸€ä¸ªä»·å€¼å‡½æ•°</strong>ï¼Œè¿™ä¸ªä»·å€¼å‡½æ•°ä¼šç”¨äºåˆ¤æ–­åœ¨å½“å‰çŠ¶æ€ä»€ä¹ˆåŠ¨ä½œæ˜¯å¥½çš„ï¼Œä»€ä¹ˆåŠ¨ä½œä¸æ˜¯å¥½çš„ï¼Œè¿›è€Œå¸®åŠ©Actor è¿›è¡Œç­–ç•¥æ›´æ–°ã€‚</li></ul><p>æ›´æ–°æ–¹å¼ï¼š</p><ul><li>Actoré‡‡ç”¨ç­–ç•¥æ¢¯åº¦æ›´æ–°</li><li>Criticé‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•æ›´æ–°</li></ul><h3 id="actor-criticç®—æ³•æµç¨‹">9.3 Actor-Criticç®—æ³•æµç¨‹</h3><ol type="1"><li>åˆå§‹åŒ–ç­–ç•¥ç½‘ç»œå‚æ•°<spanclass="math inline">\(\theta\)</span>å’Œä»·å€¼ç½‘ç»œå‚æ•°<spanclass="math inline">\(\omega\)</span>ã€‚</li><li>for è½®æ¬¡<span class="math inline">\(episode=1,2,...,E\)</span> do<ul><li>ç”¨å½“å‰ç­–ç•¥<spanclass="math inline">\(\pi_\theta\)</span>ä¸ç¯å¢ƒäº¤äº’ï¼Œå¾—åˆ°è½¨è¿¹<spanclass="math inline">\({s_1,a_1,r_1,s_2,a_2,r_2,...,s_T,a_T,r_T}\)</span>ã€‚</li><li>ä¸ºæ¯ä¸€æ­¥æ•°æ®è®¡ç®—æ—¶åºå·®åˆ†æ®‹å·®ï¼š<span class="math inline">\(\delta_t =r_t + \gamma V_w(s_{t+1}) - V_w(s_t)\)</span>ã€‚</li><li>æ›´æ–°ä»·å€¼ç½‘ç»œå‚æ•°<span class="math inline">\(\omega\)</span>ï¼š<spanclass="math inline">\(\omega \leftarrow \omega + \alpha_\omega \delta_t\nabla_w V_w(s_t)\)</span>ã€‚</li><li>æ›´æ–°ç­–ç•¥ç½‘ç»œå‚æ•°<span class="math inline">\(\theta\)</span>ï¼š<spanclass="math inline">\(\theta \leftarrow \theta + \alpha_\theta \delta_t\nabla_\theta \log \pi_\theta(s_t,a_t)\)</span>ã€‚</li></ul></li><li>end for</li></ol>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€” 8 ç­–ç•¥æ¢¯åº¦ç®—æ³•</title>
      <link href="/2024/09/17/RL/8%20%E7%AD%96%E7%95%A5%E6%A2%AF%E5%BA%A6%E7%AE%97%E6%B3%95/"/>
      <url>/2024/09/17/RL/8%20%E7%AD%96%E7%95%A5%E6%A2%AF%E5%BA%A6%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="ç­–ç•¥æ¢¯åº¦ç®—æ³•">8 ç­–ç•¥æ¢¯åº¦ç®—æ³•</h2><p>æœ¬ç« ä»‹ç»åŸºäº<strong>ç­–ç•¥</strong>ï¼ˆpolicy-basedï¼‰çš„æ–¹æ³•ï¼Œè€Œç­–ç•¥æ¢¯åº¦æ˜¯åŸºäºç­–ç•¥çš„æ–¹æ³•çš„åŸºç¡€ã€‚</p><h3 id="åŸºäºä»·å€¼å’ŒåŸºäºç­–ç•¥">8.1 åŸºäºä»·å€¼å’ŒåŸºäºç­–ç•¥</h3><p>Q-learningã€DQN åŠ DQNæ”¹è¿›ç®—æ³•éƒ½æ˜¯åŸºäº<strong>ä»·å€¼</strong>ï¼ˆvalue-basedï¼‰çš„æ–¹æ³•ï¼Œå…¶ä¸­Q-learning æ˜¯å¤„ç†<strong>æœ‰é™çŠ¶æ€</strong>çš„ç®—æ³•ï¼Œè€Œ DQNå¯ä»¥ç”¨æ¥è§£å†³<strong>è¿ç»­çŠ¶æ€</strong>çš„é—®é¢˜ã€‚</p><p><strong>åŸºäºå€¼å‡½æ•°çš„æ–¹æ³•ä¸»è¦æ˜¯å­¦ä¹ å€¼å‡½æ•°ï¼Œç„¶åæ ¹æ®å€¼å‡½æ•°å¯¼å‡ºä¸€ä¸ªç­–ç•¥ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­å¹¶ä¸å­˜åœ¨ä¸€ä¸ªæ˜¾å¼çš„ç­–ç•¥ï¼›è€ŒåŸºäºç­–ç•¥çš„æ–¹æ³•åˆ™æ˜¯ç›´æ¥æ˜¾å¼åœ°å­¦ä¹ ä¸€ä¸ªç›®æ ‡ç­–ç•¥ã€‚</strong></p><h3 id="ç­–ç•¥æ¢¯åº¦">8.2 ç­–ç•¥æ¢¯åº¦</h3><p>åŸºäºç­–ç•¥çš„æ–¹æ³•é¦–å…ˆéœ€è¦å°†ç­–ç•¥å‚æ•°åŒ–ã€‚ å‡è®¾ç›®æ ‡ç­–ç•¥<spanclass="math inline">\(\pi_{\theta}\)</span>æ˜¯ä¸€ä¸ªéšæœºæ€§ç­–ç•¥ï¼Œå¹¶ä¸”å¤„å¤„å¯å¾®ï¼Œå…¶ä¸­<spanclass="math inline">\(\theta\)</span>æ˜¯å¯¹åº”çš„å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªçº¿æ€§æ¨¡å‹æˆ–è€…ç¥ç»ç½‘ç»œæ¨¡å‹æ¥ä¸ºè¿™æ ·ä¸€ä¸ª<strong>ç­–ç•¥å‡½æ•°</strong>å»ºæ¨¡ï¼Œ<strong>è¾“å…¥æŸä¸ªçŠ¶æ€ï¼Œç„¶åè¾“å‡ºä¸€ä¸ªåŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒ</strong>ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦å¯»æ‰¾ä¸€ä¸ªæœ€ä¼˜ç­–ç•¥å¹¶æœ€å¤§åŒ–è¿™ä¸ªç­–ç•¥åœ¨ç¯å¢ƒä¸­çš„æœŸæœ›å›æŠ¥ã€‚</p><p>ç­–ç•¥å­¦ä¹ çš„ç›®æ ‡å‡½æ•°ï¼š <span class="math display">\[J(\theta)=E_{s_0}[V^{\pi_{\theta}}(s_0)]\]</span> å…¶ä¸­<spanclass="math inline">\(V^{\pi_{\theta}}(s_0)\)</span>æ˜¯åˆå§‹çŠ¶æ€ä¸º<spanclass="math inline">\(s_0\)</span>æ—¶ï¼Œä½¿ç”¨ç­–ç•¥<spanclass="math inline">\(\pi_{\theta}\)</span>å¾—åˆ°çš„æœŸæœ›å›æŠ¥ã€‚</p><p>æœ‰äº†ç›®æ ‡å‡½æ•°ï¼Œå¯ä»¥å°†ç›®æ ‡å‡½æ•°å¯¹å‚æ•°<spanclass="math inline">\(\theta\)</span>æ±‚å¯¼ï¼Œå¾—åˆ°å¯¼æ•°åï¼Œå¯ä»¥æŒ‰ç…§æ¢¯åº¦ä¸Šå‡çš„æ–¹æ³•æ¥æœ€å¤§åŒ–è¿™ä¸ªç›®æ ‡å‡½æ•°ï¼Œä»è€Œå¾—åˆ°æœ€ä¼˜ç­–ç•¥ã€‚<strong>ç›´è§‚ç†è§£å°±æ˜¯ï¼Œæ¢¯åº¦çš„ä¿®æ”¹æ˜¯è®©ç­–ç•¥æ›´å¤šåœ°å»é‡‡æ ·åˆ°å¸¦æ¥è¾ƒé«˜<spanclass="math inline">\(Q\)</span>å€¼çš„åŠ¨ä½œï¼Œæ›´å°‘åœ°å»é‡‡æ ·åˆ°å¸¦æ¥è¾ƒä½<spanclass="math inline">\(Q\)</span>å€¼çš„åŠ¨ä½œã€‚</strong></p><p><strong>æ³¨æ„</strong>ï¼šç­–ç•¥æ¢¯åº¦ç®—æ³•æ˜¯<strong>on-policy</strong>çš„ç®—æ³•ï¼Œå³<strong>å¿…é¡»ä½¿ç”¨å½“å‰ç­–ç•¥é‡‡æ ·å¾—åˆ°çš„æ•°æ®æ¥è®¡ç®—æ¢¯åº¦</strong>ã€‚</p><p>åœ¨è®¡ç®—ç­–ç•¥æ¢¯åº¦çš„å…¬å¼ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°<spanclass="math inline">\(Q^{\pi_\theta}(s,a)\)</span>ï¼Œå¯ä»¥é‡‡ç”¨å¤šç§æ–¹æ³•å¯¹å…¶è¿›è¡Œä¼°è®¡ã€‚ä¾‹å¦‚Reinforceç®—æ³•ã€‚</p><h3 id="reinforceç®—æ³•">8.3 Reinforceç®—æ³•</h3><p>Reinforceç®—æ³•æ˜¯ç­–ç•¥æ¢¯åº¦ç®—æ³•ä¸­éå¸¸ç»å…¸çš„ä¸€ä¸ªç®—æ³•ï¼Œå®ƒä½¿ç”¨<strong>è’™ç‰¹å¡æ´›æ–¹æ³•</strong>æ¥ä¼°è®¡åŠ¨ä½œä»·å€¼å‡½æ•°<spanclass="math inline">\(Q^{\pi_\theta}(s,a)\)</span>ã€‚</p><p>Reinforceç®—æ³•çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol type="1"><li>åˆå§‹åŒ–ç­–ç•¥å‚æ•°<spanclass="math inline">\(\theta\)</span>ï¼Œå¹¶è®¾å®šå­¦ä¹ ç‡<spanclass="math inline">\(\alpha\)</span>ï¼›</li><li>for è½®æ¬¡<span class="math inline">\(episode=1,2,...\)</span> do<ul><li>ç”¨å½“å‰ç­–ç•¥<spanclass="math inline">\(\pi_{\theta}\)</span>é‡‡æ ·ä¸€æ¡è½¨è¿¹<spanclass="math inline">\({s_1,a_1,r_1,s_2,a_2,r_2,...,s_T,a_T,r_T}\)</span>ï¼›</li><li>è®¡ç®—å½“å‰è½¨è¿¹æ¯ä¸ªæ—¶åˆ»<spanclass="math inline">\(t\)</span>å¾€åçš„å›æŠ¥<spanclass="math inline">\(\sum_{k=t}^T\gamma^{k-t}r_k\)</span>ï¼Œè®°ä¸º<spanclass="math inline">\(G_t\)</span>ï¼›</li><li>å¯¹<span class="math inline">\(\theta\)</span>è¿›è¡Œæ›´æ–°ï¼Œ<spanclass="math inline">\(\theta\leftarrow\theta+\alpha\sum_{t}^T\nabla_\theta\log\pi_\theta(a_t|s_t)G_t\)</span>ã€‚</li></ul></li><li>end for</li></ol><h3 id="æ€»ç»“">8.4 æ€»ç»“</h3><p>REINFORCEç®—æ³•æ˜¯ç­–ç•¥æ¢¯åº¦ä¹ƒè‡³å¼ºåŒ–å­¦ä¹ çš„å…¸å‹ä»£è¡¨ï¼Œæ™ºèƒ½ä½“<strong>æ ¹æ®å½“å‰ç­–ç•¥ç›´æ¥å’Œç¯å¢ƒäº¤äº’</strong>ï¼Œé€šè¿‡<strong>é‡‡æ ·å¾—åˆ°çš„è½¨è¿¹æ•°æ®</strong>ç›´æ¥<strong>è®¡ç®—å‡ºç­–ç•¥å‚æ•°çš„æ¢¯åº¦</strong>ï¼Œè¿›è€Œæ›´æ–°å½“å‰ç­–ç•¥ï¼Œä½¿å…¶å‘æœ€å¤§åŒ–ç­–ç•¥æœŸæœ›å›æŠ¥çš„ç›®æ ‡é è¿‘ã€‚</p><p>è¿™ç§å­¦ä¹ æ–¹å¼æ˜¯å…¸å‹çš„<strong>ä»äº¤äº’ä¸­å­¦ä¹ </strong>ï¼Œå¹¶ä¸”å…¶<strong>ä¼˜åŒ–çš„ç›®æ ‡ï¼ˆå³ç­–ç•¥æœŸæœ›å›æŠ¥ï¼‰æ­£æ˜¯æœ€ç»ˆæ‰€ä½¿ç”¨ç­–ç•¥çš„æ€§èƒ½</strong>ï¼Œè¿™æ¯”åŸºäºä»·å€¼çš„å¼ºåŒ–å­¦ä¹ ç®—æ³•çš„ä¼˜åŒ–ç›®æ ‡ï¼ˆä¸€èˆ¬æ˜¯æ—¶åºå·®åˆ†è¯¯å·®çš„æœ€å°åŒ–ï¼‰è¦æ›´åŠ ç›´æ¥ã€‚</p><p>REINFORCEç®—æ³•ç†è®ºä¸Šæ˜¯èƒ½ä¿è¯<strong>å±€éƒ¨æœ€ä¼˜</strong>çš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯<strong>å€ŸåŠ©è’™ç‰¹å¡æ´›æ–¹æ³•é‡‡æ ·è½¨è¿¹æ¥ä¼°è®¡åŠ¨ä½œä»·å€¼</strong>ï¼Œè¿™ç§åšæ³•çš„ä¸€å¤§ä¼˜ç‚¹æ˜¯å¯ä»¥å¾—åˆ°<strong>æ— åçš„æ¢¯åº¦</strong>ã€‚ä½†æ˜¯ï¼Œæ­£æ˜¯å› ä¸ºä½¿ç”¨äº†è’™ç‰¹å¡æ´›æ–¹æ³•ï¼ŒREINFORCEç®—æ³•çš„æ¢¯åº¦ä¼°è®¡çš„æ–¹å·®å¾ˆå¤§ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸º<strong>æ¯æ¡é‡‡æ ·è½¨è¿¹çš„å›æŠ¥å€¼æ³¢åŠ¨æ¯”è¾ƒå¤§</strong>ï¼Œå¯èƒ½ä¼šé€ æˆä¸€å®šç¨‹åº¦ä¸Šçš„ä¸ç¨³å®šï¼Œè¿™ä¹Ÿæ˜¯Actor-Critic ç®—æ³•è¦è§£å†³çš„é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€” 3 é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹</title>
      <link href="/2024/09/17/RL/3%20%E9%A9%AC%E5%B0%94%E5%8F%AF%E5%A4%AB%E5%86%B3%E7%AD%96%E8%BF%87%E7%A8%8B/"/>
      <url>/2024/09/17/RL/3%20%E9%A9%AC%E5%B0%94%E5%8F%AF%E5%A4%AB%E5%86%B3%E7%AD%96%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹">3 é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹</h2><p>å¦‚æœè¦ç”¨å¼ºåŒ–å­¦ä¹ å»è§£å†³ä¸€ä¸ªå®é™…é—®é¢˜ï¼Œç¬¬ä¸€æ­¥è¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠè¿™ä¸ªå®é™…é—®é¢˜æŠ½è±¡ä¸ºä¸€ä¸ªé©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ˜ç¡®é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹çš„å„ä¸ªç»„æˆè¦ç´ ã€‚</p><h3 id="é©¬å°”å¯å¤«è¿‡ç¨‹">3.1 é©¬å°”å¯å¤«è¿‡ç¨‹</h3><h4 id="éšæœºè¿‡ç¨‹">3.2.1 éšæœºè¿‡ç¨‹</h4><p>æ—¶åˆ»<span class="math inline">\(t+1\)</span>çš„çŠ¶æ€<spanclass="math inline">\(S_{t+1}\)</span>æ¦‚ç‡å¯ä»¥è¡¨ç¤ºä¸º<spanclass="math inline">\(P(S_{t+1}|S_1,S_2,...,S_t)\)</span>ï¼Œå³æœªæ¥çš„çŠ¶æ€å–å†³äºè¿‡å»çš„çŠ¶æ€ä»¥åŠå½“å‰çš„çŠ¶æ€ã€‚</p><h4 id="é©¬å°”å¯å¤«æ€§è´¨">3.2.2 é©¬å°”å¯å¤«æ€§è´¨</h4><p>å½“ä¸”ä»…å½“æœªæ¥çŠ¶æ€çš„æ¦‚ç‡åˆ†å¸ƒ<strong>åªä¾èµ–äºå½“å‰çŠ¶æ€</strong>æ—¶ï¼Œè¿™ä¸ªéšæœºè¿‡ç¨‹å…·æœ‰é©¬å°”å¯å¤«æ€§è´¨ã€‚å³ï¼š<spanclass="math inline">\(P(S_{t+1}|S_t)=P(S_{t+1}|S_1,S_2,...,S_t)\)</span></p><p><strong>ä½†æ˜¯å¹¶ä¸æ˜¯è¯´<spanclass="math inline">\(S_{t+1}\)</span>å’Œå†å²å®Œå…¨æ²¡æœ‰å…³ç³»</strong>ï¼Œå› ä¸º<spanclass="math inline">\(S_{t+1}\)</span>æ˜¯ç”±<spanclass="math inline">\(S_t\)</span>å†³å®šçš„ï¼Œè€Œ<spanclass="math inline">\(S_t\)</span>åˆæ˜¯ç”±<spanclass="math inline">\(S_{t-1}\)</span>å†³å®šçš„ï¼Œä»¥æ­¤ç±»æ¨ï¼Œ<spanclass="math inline">\(S_{t+1}\)</span>å’Œå†å²æ˜¯æœ‰å…³ç³»çš„ï¼Œåªæ˜¯è¯´<spanclass="math inline">\(S_{t+1}\)</span>å’Œå†å²çš„å…³ç³»å¯ä»¥é€šè¿‡å½“å‰çŠ¶æ€<spanclass="math inline">\(S_t\)</span>æ¥è¡¨ç¤ºã€‚</p><h4 id="é©¬å°”å¯å¤«è¿‡ç¨‹-1">3.2.3 é©¬å°”å¯å¤«è¿‡ç¨‹</h4><p>é©¬å°”å¯å¤«è¿‡ç¨‹(é©¬å°”ç§‘å¤«é“¾)æ˜¯æŒ‡å…·æœ‰<strong>é©¬å°”å¯å¤«æ€§è´¨</strong>çš„<strong>éšæœºè¿‡ç¨‹</strong>ã€‚</p><p>é€šå¸¸ç”¨å…ƒç»„<span class="math inline">\(\langleS,P\rangle\)</span>æ¥è¡¨ç¤ºé©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œå…¶ä¸­<spanclass="math inline">\(S\)</span>æ˜¯<strong>æœ‰é™æ•°é‡çš„çŠ¶æ€é›†</strong>ï¼Œ<spanclass="math inline">\(P\)</span>æ˜¯<strong>çŠ¶æ€è½¬ç§»çŸ©é˜µ</strong>ã€‚</p><p>å‡è®¾çŠ¶æ€é›†<span class="math inline">\(S\)</span>æœ‰<spanclass="math inline">\(n\)</span>ä¸ªçŠ¶æ€ï¼ŒçŠ¶æ€è½¬ç§»çŸ©é˜µ<spanclass="math inline">\(P\)</span>æ˜¯ä¸€ä¸ª<spanclass="math inline">\(n\times n\)</span>çš„çŸ©é˜µï¼š <spanclass="math display">\[P=\begin{bmatrix}P(s_1|s_1) &amp; P(s_2|s_1) &amp; ... &amp; P(s_n|s_1) \\P(s_1|s_2) &amp; P(s_2|s_2) &amp; ... &amp; P(s_n|s_2) \\... &amp; ... &amp; ... &amp; ... \\P(s_1|s_n) &amp; P(s_2|s_n) &amp; ... &amp; P(s_n|s_n) \\\end{bmatrix}\]</span> <span class="math inline">\(P(s_i|s_j)\)</span>è¡¨ç¤ºä»çŠ¶æ€<spanclass="math inline">\(s_j\)</span>è½¬ç§»åˆ°çŠ¶æ€<spanclass="math inline">\(s_i\)</span>çš„æ¦‚ç‡ï¼Œè¢«ç§°ä¸º<strong>çŠ¶æ€è½¬ç§»å‡½æ•°</strong>ã€‚<strong>ä»æŸä¸ªçŠ¶æ€å‡ºå‘ï¼Œåˆ°è¾¾å…¶ä»–çŠ¶æ€çš„æ¦‚ç‡å’Œå¿…é¡»ä¸º1ï¼Œå³çŠ¶æ€è½¬ç§»çŸ©é˜µçš„æ¯ä¸€è¡Œä¹‹å’Œä¸º1</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­å¦‚å›¾æ‰€ç¤ºï¼š <img src="./images/markov-process.webp#50x50"title="å›¾3.1: é©¬å°”å¯å¤«è¿‡ç¨‹çš„ä¸€ä¸ªç®€å•ä¾‹å­"alt="é©¬å°”å¯å¤«è¿‡ç¨‹çš„ä¸€ä¸ªç®€å•ä¾‹å­" /> å¯ä»¥å†™å‡ºå¦‚ä¸‹çš„çŠ¶æ€è½¬ç§»çŸ©é˜µï¼š <spanclass="math display">\[P=\begin{bmatrix}0.9 &amp; 0.1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\0.5 &amp; 0 &amp; 0.5 &amp; 0 &amp; 0 &amp; 0 \\0 &amp; 0 &amp; 0 &amp; 0.6 &amp; 0 &amp; 0.4 \\0 &amp; 0 &amp; 0 &amp; 0 &amp; 0.3 &amp; 0.7 \\0 &amp; 0.2 &amp; 0.3 &amp; 0.5 &amp; 0 &amp; 0 \\0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\\end{bmatrix}\]</span> å…¶ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªçŠ¶æ€(<spanclass="math inline">\(s_6\)</span>é€šå¸¸è¢«ç§°ä¸ºç»ˆæ­¢çŠ¶æ€)ã€‚</p><p>ç»™å®šä¸€ä¸ªé©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥<strong>ä»æŸä¸ªçŠ¶æ€</strong>å‡ºå‘ï¼Œæ ¹æ®å®ƒçš„<strong>çŠ¶æ€è½¬ç§»çŸ©é˜µ</strong>ç”Ÿæˆä¸€ä¸ª<strong>çŠ¶æ€åºåˆ—</strong>ï¼ˆepisodeï¼‰ï¼Œè¿™ä¸ªæ­¥éª¤ä¹Ÿè¢«å«åš<strong>é‡‡æ ·</strong>ï¼ˆsamplingï¼‰ã€‚ä¾‹å¦‚ï¼Œä»çŠ¶æ€<spanclass="math inline">\(s_1\)</span>å‡ºå‘ï¼Œæ ¹æ®çŠ¶æ€è½¬ç§»çŸ©é˜µ<spanclass="math inline">\(P\)</span>ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªçŠ¶æ€åºåˆ—<spanclass="math inline">\(s_1\rightarrow s_2\rightarrow s_3\rightarrows_6\)</span>ï¼Œä¹Ÿå¯ä»¥æ˜¯<span class="math inline">\(s_1\rightarrows_1\rightarrow s_2\rightarrow s_3\rightarrow s_4 \rightarrows_5\rightarrow s_3\rightarrows_6\)</span>ã€‚<strong>ç”Ÿæˆè¿™äº›åºåˆ—çš„æ¦‚ç‡å’ŒçŠ¶æ€è½¬ç§»çŸ©é˜µæœ‰å…³</strong>ã€‚</p><h3 id="é©¬å°”å¯å¤«å¥–åŠ±è¿‡ç¨‹">3.3 é©¬å°”å¯å¤«å¥–åŠ±è¿‡ç¨‹</h3>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€” 2 å¤šè‡‚è€è™æœº</title>
      <link href="/2024/09/17/RL/2%20%E5%A4%9A%E8%87%82%E8%80%81%E8%99%8E%E6%9C%BA/"/>
      <url>/2024/09/17/RL/2%20%E5%A4%9A%E8%87%82%E8%80%81%E8%99%8E%E6%9C%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="å¤šè‡‚è€è™æœº">2 å¤šè‡‚è€è™æœº</h2><p>å¤šè‡‚è€è™æœºä¸­çš„æ¢ç´¢ä¸åˆ©ç”¨ï¼ˆexplorationvs.Â exploitationï¼‰é—®é¢˜ä¸€ç›´ä»¥æ¥éƒ½æ˜¯ä¸€ä¸ªç‰¹åˆ«ç»å…¸çš„é—®é¢˜ï¼Œç†è§£å®ƒèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å­¦ä¹ å¼ºåŒ–å­¦ä¹ ã€‚ä¸å¼ºåŒ–å­¦ä¹ ä¸åŒï¼Œå¤šè‡‚è€è™æœºä¸å­˜åœ¨çŠ¶æ€ä¿¡æ¯ï¼Œåªæœ‰åŠ¨ä½œå’Œå¥–åŠ±ï¼Œç®—æ˜¯æœ€ç®€å•çš„â€œå’Œç¯å¢ƒäº¤äº’ä¸­çš„å­¦ä¹ â€çš„ä¸€ç§å½¢å¼ã€‚</p><h3 id="é—®é¢˜ä»‹ç»">2.1 é—®é¢˜ä»‹ç»</h3><h4 id="é—®é¢˜å®šä¹‰">2.1.1 é—®é¢˜å®šä¹‰</h4><p>æœ‰ä¸€ä¸ªæ‹¥æœ‰<spanclass="math inline">\(K\)</span>æ ¹æ‹‰æ†çš„è€è™æœºï¼Œæ‹‰åŠ¨æ¯ä¸€æ ¹æ‹‰æ†éƒ½å¯¹åº”ä¸€ä¸ªå…³äºå¥–åŠ±çš„æ¦‚ç‡åˆ†å¸ƒ<spanclass="math inline">\(R\)</span>ã€‚æˆ‘ä»¬éœ€è¦åœ¨â€œæ¢ç´¢æ‹‰æ†çš„è·å¥–æ¦‚ç‡â€å’Œâ€œæ ¹æ®ç»éªŒé€‰æ‹©è·å¥–æœ€å¤šçš„æ‹‰æ†â€ä¸­è¿›è¡Œæƒè¡¡ã€‚â€œé‡‡ç”¨æ€æ ·çš„æ“ä½œç­–ç•¥æ‰èƒ½ä½¿è·å¾—çš„ç´¯ç§¯å¥–åŠ±æœ€é«˜â€ä¾¿æ˜¯å¤šè‡‚è€è™æœºé—®é¢˜ã€‚</p><h4 id="å½¢å¼åŒ–æè¿°">2.1.2 å½¢å¼åŒ–æè¿°</h4><p>å¤šè‡‚è€è™æœºé—®é¢˜å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªå…ƒç»„ <span class="math inline">\((A,R)\)</span></p><ul><li><span class="math inline">\(A\)</span>è¡¨ç¤ºåŠ¨ä½œé›†åˆï¼Œä¸€ä¸ªåŠ¨ä½œè¡¨ç¤ºæ‹‰åŠ¨ä¸€æ ¹æ‹‰æ†ï¼Œ<span class="math inline">\(A =\{a_1, a_2, ..., a_K\}\)</span></li><li><span class="math inline">\(R\)</span> è¡¨ç¤ºå¥–åŠ±æ¦‚ç‡åˆ†å¸ƒï¼Œ<spanclass="math inline">\(R(r|a)\)</span> è¡¨ç¤ºå½“åŠ¨ä½œ<spanclass="math inline">\(a\)</span> ä½œç”¨åœ¨ç¯å¢ƒä¸Šåå¾—åˆ°çš„å¥–åŠ±<spanclass="math inline">\(r\)</span>çš„æ¦‚ç‡åˆ†å¸ƒ</li></ul><p>å¤šè‡‚è€è™æœºçš„ç›®æ ‡ä¸ºæœ€å¤§åŒ–ä¸€æ®µæ—¶é—´æ­¥å†…ç´¯ç§¯çš„å¥–åŠ±</p><h4 id="ç´¯è®¡æ‡Šæ‚”">2.1.3 ç´¯è®¡æ‡Šæ‚”</h4><p>è‡³å°‘å­˜åœ¨ä¸€æ ¹æ‹‰æ†ï¼Œå®ƒçš„æœŸæœ›å¥–åŠ±ä¸å°äºæ‹‰åŠ¨å…¶ä»–ä»»æ„ä¸€æ ¹æ‹‰æ†çš„æœŸæœ›å¥–åŠ±ã€‚æˆ‘ä»¬ç§°è¿™ä¸ªæ‹‰æ†ä¸ºæœ€ä¼˜æ‹‰æ†ï¼Œå¯¹åº”çš„æœŸæœ›å¥–åŠ±ä¸ºæœ€ä¼˜æœŸæœ›å¥–åŠ±ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ç´¯è®¡æ‡Šæ‚”ï¼ˆcumulativeregretï¼‰ä¸ºæˆ‘ä»¬åœ¨ä¸€æ®µæ—¶é—´å†…è·å¾—çš„å¥–åŠ±ä¸æœ€ä¼˜æœŸæœ›å¥–åŠ±ä¹‹é—´çš„å·®å€¼æ€»é¢ã€‚</p><p>MAB é—®é¢˜çš„ç›®æ ‡ä¸ºæœ€å¤§åŒ–ç´¯ç§¯å¥–åŠ±ï¼Œç­‰ä»·äºæœ€å°åŒ–ç´¯ç§¯æ‡Šæ‚”ã€‚</p><h4 id="ä¼°è®¡æœŸæœ›å¥–åŠ±">2.1.4 ä¼°è®¡æœŸæœ›å¥–åŠ±</h4><p>ä¸ºäº†çŸ¥é“æ‹‰åŠ¨å“ªä¸€æ ¹æ‹‰æ†èƒ½è·å¾—æ›´é«˜çš„å¥–åŠ±ï¼Œæˆ‘ä»¬éœ€è¦ä¼°è®¡æ‹‰åŠ¨è¿™æ ¹æ‹‰æ†çš„æœŸæœ›å¥–åŠ±ã€‚ç”±äºåªæ‹‰åŠ¨ä¸€æ¬¡æ‹‰æ†è·å¾—çš„å¥–åŠ±å­˜åœ¨éšæœºæ€§ï¼Œæ‰€ä»¥éœ€è¦å¤šæ¬¡æ‹‰åŠ¨ä¸€æ ¹æ‹‰æ†ï¼Œç„¶åè®¡ç®—å¾—åˆ°çš„å¤šæ¬¡å¥–åŠ±çš„æœŸæœ›ã€‚</p><p>æ›´æ–°æœŸæœ›å¥–åŠ±é€šå¸¸é‡‡ç”¨å¢é‡æ³•ï¼Œå³</p><p><span class="math display">\[Q_{t+1} = Q_t + \frac{1}{t+1} \left( r_t - Q_t \right)\]</span></p><p>å¦‚æœå°†æ‰€æœ‰æ•°æ±‚å’Œå†é™¤ä»¥æ¬¡æ•°ï¼Œå…¶ç¼ºç‚¹æ˜¯æ¯æ¬¡æ›´æ–°çš„æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦å‡ä¸º<spanclass="math inline">\(O(n)\)</span>ã€‚è€Œé‡‡ç”¨å¢é‡å¼æ›´æ–°ï¼Œæ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦å‡ä¸º<span class="math inline">\(O(1)\)</span>ã€‚</p><h3 id="æ¢ç´¢ä¸åˆ©ç”¨çš„æƒè¡¡">2.2 æ¢ç´¢ä¸åˆ©ç”¨çš„æƒè¡¡</h3><p>åœ¨å¤šè‡‚è€è™æœºé—®é¢˜ä¸­ï¼Œè®¾è®¡ç­–ç•¥æ—¶å°±éœ€è¦å¹³è¡¡æ¢ç´¢å’Œåˆ©ç”¨çš„æ¬¡æ•°ï¼Œä½¿å¾—ç´¯ç§¯å¥–åŠ±æœ€å¤§åŒ–ã€‚ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ€è·¯æ˜¯åœ¨å¼€å§‹æ—¶åšæ¯”è¾ƒå¤šçš„æ¢ç´¢ï¼Œåœ¨å¯¹æ¯æ ¹æ‹‰æ†éƒ½æœ‰æ¯”è¾ƒå‡†ç¡®çš„ä¼°è®¡åï¼Œå†è¿›è¡Œåˆ©ç”¨ã€‚ç›®å‰å·²æœ‰ä¸€äº›æ¯”è¾ƒç»å…¸çš„ç®—æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚<spanclass="math inline">\(\epsilon\)</span>-è´ªå©ªç®—æ³•ã€ä¸Šç½®ä¿¡ç•Œç®—æ³•å’Œæ±¤æ™®æ£®é‡‡æ ·ç®—æ³•ç­‰ã€‚</p><h3 id="epsilon-è´ªå©ªç®—æ³•">2.3 <spanclass="math inline">\(\epsilon\)</span>-è´ªå©ªç®—æ³•</h3><p><spanclass="math inline">\(\epsilon\)</span>-è´ªå©ªç®—æ³•å³åœ¨å®Œå…¨è´ªå©ªçš„åŸºç¡€ä¸Šæ·»åŠ äº†å™ªå£°ï¼Œä»¥<spanclass="math inline">\(\epsilon\)</span>çš„æ¦‚ç‡è¿›è¡Œæ¢ç´¢(éšæœºé€‰æ‹©ä¸€æ ¹æ‹‰æ†)ï¼Œä»¥<spanclass="math inline">\(1-\epsilon\)</span>çš„æ¦‚ç‡è¿›è¡Œåˆ©ç”¨(é€‰æ‹©ä»¥å¾€ç»éªŒä¸­æœŸæœ›å¥–åŠ±ä¼°å€¼æœ€å¤§çš„é‚£æ ¹æ‹‰æ†)ã€‚</p><p>éšç€æ¢ç´¢æ¬¡æ•°çš„å¢åŠ ï¼Œå¯ä»¥è®©<spanclass="math inline">\(\epsilon\)</span>é€æ¸å‡å°ï¼Œä»è€Œé€æ¸å¢åŠ åˆ©ç”¨çš„æ¬¡æ•°ã€‚å› ä¸ºéšç€æ¢ç´¢æ¬¡æ•°çš„å¢åŠ ï¼Œæˆ‘ä»¬å¯¹å„ä¸ªåŠ¨ä½œçš„è¯„ä¼°ä¼šè¶Šæ¥è¶Šå‡†ï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä¸å¿…å¤šæ¬¡å°è¯•åŒä¸€ä¸ªåŠ¨ä½œã€‚</p><p><strong>æ³¨æ„</strong>ï¼Œ<span class="math inline">\(\epsilon\)</span>ä¸ä¼šåœ¨æœ‰é™æ­¥æ•°å†…å‡å°åˆ°0(å› ä¸ºåŸºäºæœ‰é™æ­¥æ•°è§‚æµ‹çš„å®Œå…¨è´ªå©ªç®—æ³•ä»ç„¶æ˜¯ä¸€ä¸ªå±€éƒ¨ä¿¡æ¯çš„è´ªå©ªç®—æ³•ï¼Œæ°¸è¿œè·ç¦»æœ€ä¼˜è§£æœ‰ä¸€ä¸ªå›ºå®šçš„å·®è·)ã€‚</p><h3 id="ä¸Šç½®ä¿¡ç•Œç®—æ³•">2.4 ä¸Šç½®ä¿¡ç•Œç®—æ³•</h3><p>ä¸€æ ¹æ‹‰æ†è¢«æ‹‰å–çš„æ¬¡æ•°è¶Šå°‘ï¼Œå®ƒçš„ä¸ç¡®å®šæ€§å°±è¶Šå¤§ï¼›ä¸€æ ¹æ‹‰æ†çš„ä¸ç¡®å®šæ€§è¶Šå¤§ï¼Œå®ƒå°±è¶Šå…·æœ‰æ¢ç´¢çš„ä»·å€¼ï¼Œå› ä¸ºæ¢ç´¢ä¹‹åæˆ‘ä»¬å¯èƒ½å‘ç°å®ƒçš„æœŸæœ›å¥–åŠ±å¾ˆå¤§ã€‚å¼•å…¥ä¸ç¡®å®šæ€§åº¦é‡<span class="math inline">\(U(a)\)</span>ï¼Œå®ƒä¼šéšç€ä¸€ä¸ªåŠ¨ä½œè¢«å°è¯•æ¬¡æ•°çš„å¢åŠ è€Œå‡å°ã€‚</p><p>ä¸Šç½®ä¿¡ç•Œç®—æ³•ï¼ˆUpper Confidence Bound,UCBï¼‰æ˜¯ä¸€ç§ç»å…¸çš„<strong>åŸºäºä¸ç¡®å®šæ€§çš„ç­–ç•¥</strong>ç®—æ³•ï¼Œå®ƒçš„æ€æƒ³ç”¨åˆ°äº†ä¸€ä¸ªéå¸¸è‘—åçš„æ•°å­¦åŸç†ï¼šéœå¤«ä¸ä¸ç­‰å¼ã€‚</p><p>UCBç®—æ³•åœ¨æ¯æ¬¡é€‰æ‹©æ‹‰æ†å‰ï¼Œ<strong>å…ˆä¼°è®¡æ¯æ ¹æ‹‰æ†çš„æœŸæœ›å¥–åŠ±çš„ä¸Šç•Œ</strong>ï¼Œä½¿å¾—æ‹‰åŠ¨æ¯æ ¹æ‹‰æ†çš„æœŸæœ›å¥–åŠ±åªæœ‰ä¸€ä¸ªè¾ƒå°çš„æ¦‚ç‡è¶…è¿‡è¿™ä¸ªä¸Šç•Œï¼Œ<strong>æ¥ç€é€‰å‡ºæœŸæœ›å¥–åŠ±ä¸Šç•Œæœ€å¤§çš„æ‹‰æ†</strong>ï¼Œä»è€Œé€‰æ‹©æœ€æœ‰å¯èƒ½è·å¾—æœ€å¤§æœŸæœ›å¥–åŠ±çš„æ‹‰æ†ã€‚</p><h3 id="æ±¤æ™®æ£®é‡‡æ ·ç®—æ³•">2.5 æ±¤æ™®æ£®é‡‡æ ·ç®—æ³•</h3><p>æ±¤æ™®æ£®é‡‡æ ·ç®—æ³•ä½¿ç”¨é‡‡æ ·çš„æ–¹å¼ï¼Œå³æ ¹æ®å½“å‰æ¯ä¸ªåŠ¨ä½œ <spanclass="math inline">\(a\)</span>çš„å¥–åŠ±æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œä¸€è½®é‡‡æ ·ï¼Œå¾—åˆ°ä¸€ç»„å„æ ¹æ‹‰æ†çš„å¥–åŠ±æ ·æœ¬ï¼Œå†é€‰æ‹©æ ·æœ¬ä¸­å¥–åŠ±æœ€å¤§çš„åŠ¨ä½œã€‚</p><p>æ€æ ·å¾—åˆ°å½“å‰æ¯ä¸ªåŠ¨ä½œ<spanclass="math inline">\(a\)</span>çš„å¥–åŠ±æ¦‚ç‡åˆ†å¸ƒå¹¶ä¸”åœ¨è¿‡ç¨‹ä¸­è¿›è¡Œæ›´æ–°ï¼Ÿåœ¨å®é™…æƒ…å†µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨ Betaåˆ†å¸ƒå¯¹å½“å‰æ¯ä¸ªåŠ¨ä½œçš„å¥–åŠ±æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œå»ºæ¨¡ã€‚ä¾‹å¦‚è‹¥æŸä¸ªæ‹‰æ†è¢«æ‹‰å–äº† <spanclass="math inline">\(K\)</span> æ¬¡ï¼Œå…¶ä¸­ <spanclass="math inline">\(m_1\)</span> æ¬¡å¥–åŠ±ä¸º 1ï¼Œ<spanclass="math inline">\(m_2\)</span> æ¬¡å¥–åŠ±ä¸º0ï¼Œé‚£ä¹ˆè¯¥åŠ¨ä½œçš„å¥–åŠ±æœä»å‚æ•°ä¸º <span class="math inline">\((m_1+1,m_2+1)\)</span> çš„ Beta åˆ†å¸ƒã€‚</p><h3 id="æ€»ç»“">2.6 æ€»ç»“</h3><ol type="1"><li><spanclass="math inline">\(\epsilon\)</span>-è´ªå©ªç®—æ³•çš„ç´¯è®¡æ‡Šæ‚”æ˜¯éšæ—¶é—´çº¿æ€§å¢é•¿çš„ï¼Œè€Œ<spanclass="math inline">\(\epsilon\)</span>-è¡°å‡è´ªå¿ƒç®—æ³•ï¼Œä¸Šç½®ä¿¡ç•Œç®—æ³•ï¼Œæ±¤æ™®æ£®é‡‡æ ·ç®—æ³•ï¼Œç´¯è®¡æ‡Šæ‚”éƒ½æ˜¯å¯¹æ•°å½¢å¼å¢é•¿çš„ã€‚</li><li>MABå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª<strong>æ— çŠ¶æ€çš„å¼ºåŒ–å­¦ä¹ </strong>ï¼Œåœ¨äºå…¶ä¸ç¯å¢ƒçš„äº¤äº’å¹¶ä¸ä¼šæ”¹å˜ç¯å¢ƒï¼Œå³å¤šè‡‚è€è™æœºçš„æ¯æ¬¡äº¤äº’çš„ç»“æœå’Œä»¥å¾€çš„åŠ¨ä½œæ— å…³ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºåŒ–å­¦ä¹ â€”â€”  1 åˆæ¢å¼ºåŒ–å­¦ä¹ </title>
      <link href="/2024/09/17/RL/1%20%E5%88%9D%E6%8E%A2%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/09/17/RL/1%20%E5%88%9D%E6%8E%A2%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆæ¢å¼ºåŒ–å­¦ä¹ ">1 åˆæ¢å¼ºåŒ–å­¦ä¹ </h2><p>æœ¬ç¬”è®°åŸºäº<a href="https://hrl.boyuai.com/">åŠ¨æ‰‹å­¦å¼ºåŒ–å­¦ä¹ </a></p><p>å®ç°<strong>åºè´¯å†³ç­–</strong>çš„æœºå™¨å­¦ä¹ æ–¹æ³•å°±æ˜¯å½“å‰è®¨è®ºçš„ä¸»é¢˜â€”å¼ºåŒ–å­¦ä¹ </p><h3 id="ä»€ä¹ˆæ˜¯å¼ºåŒ–å­¦ä¹ ">1.1 ä»€ä¹ˆæ˜¯å¼ºåŒ–å­¦ä¹ </h3><p>å¼ºåŒ–å­¦ä¹ æ˜¯æœºå™¨é€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ¥å®ç°ç›®æ ‡çš„ä¸€ç§è®¡ç®—æ–¹æ³•ã€‚åœ¨æ¯ä¸€è½®äº¤äº’ä¸­ï¼Œæ™ºèƒ½ä½“æ„ŸçŸ¥åˆ°ç¯å¢ƒç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œç»è¿‡è‡ªèº«çš„è®¡ç®—ç»™å‡ºæœ¬è½®çš„åŠ¨ä½œï¼Œå°†å…¶ä½œç”¨åˆ°ç¯å¢ƒä¸­ï¼›ç¯å¢ƒå¾—åˆ°æ™ºèƒ½ä½“çš„åŠ¨ä½œåï¼Œäº§ç”Ÿç›¸åº”çš„å³æ—¶å¥–åŠ±ä¿¡å·å¹¶å‘ç”Ÿç›¸åº”çš„çŠ¶æ€è½¬ç§»ã€‚</p><p>æ™ºèƒ½ä½“æœ‰3ç§å…³é”®è¦ç´ ï¼Œå³<strong>æ„ŸçŸ¥ã€å†³ç­–å’Œå¥–åŠ±</strong>ã€‚</p><h3 id="ç¯å¢ƒ">1.2 ç¯å¢ƒ</h3><p>å¼ºåŒ–å­¦ä¹ çš„æ™ºèƒ½ä½“æ˜¯åœ¨å’Œä¸€ä¸ªåŠ¨æ€ç¯å¢ƒçš„äº¤äº’ä¸­å®Œæˆåºè´¯å†³ç­–çš„ã€‚å¯¹äºä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œå…¶æœ€å…³é”®çš„è¦ç´ å°±æ˜¯<strong>çŠ¶æ€</strong>ä»¥åŠ<strong>çŠ¶æ€è½¬ç§»çš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒ</strong>ã€‚è¿™å°±å¥½æ¯”ä¸€ä¸ªå¾®ç²’åœ¨æ°´ä¸­çš„å¸ƒæœ—è¿åŠ¨å¯ä»¥ç”±å®ƒçš„èµ·å§‹ä½ç½®ä»¥åŠä¸‹ä¸€åˆ»çš„ä½ç½®ç›¸å¯¹å½“å‰ä½ç½®çš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒæ¥åˆ»ç”»ã€‚</p><p>å¦‚æœåœ¨ç¯å¢ƒè¿™æ ·ä¸€ä¸ªè‡ªèº«æ¼”å˜çš„éšæœºè¿‡ç¨‹ä¸­åŠ å…¥ä¸€ä¸ªå¤–æ¥çš„å¹²æ‰°å› ç´ ï¼Œå³æ™ºèƒ½ä½“çš„åŠ¨ä½œï¼Œé‚£ä¹ˆç¯å¢ƒçš„<strong>ä¸‹ä¸€åˆ»çŠ¶æ€çš„æ¦‚ç‡åˆ†å¸ƒ</strong>å°†ç”±<strong>å½“å‰çŠ¶æ€</strong>å’Œ<strong>æ™ºèƒ½ä½“çš„åŠ¨ä½œ</strong>æ¥å…±åŒå†³å®šï¼Œç”¨æœ€ç®€å•çš„æ•°å­¦å…¬å¼è¡¨ç¤ºåˆ™æ˜¯ï¼š</p><p><span class="math display">\[ä¸‹ä¸€çŠ¶æ€=P(å½“å‰çŠ¶æ€,æ™ºèƒ½ä½“åŠ¨ä½œ)\]</span></p><h3 id="ç›®æ ‡">1.3 ç›®æ ‡</h3><p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å…³æ³¨<strong>å›æŠ¥çš„æœŸæœ›</strong>ï¼Œå¹¶å°†å…¶å®šä¹‰ä¸º<strong>ä»·å€¼ï¼ˆvalueï¼‰</strong>ï¼Œè¿™å°±æ˜¯å¼ºåŒ–å­¦ä¹ ä¸­æ™ºèƒ½ä½“å­¦ä¹ çš„ä¼˜åŒ–ç›®æ ‡ã€‚</p><h3 id="æ•°æ®">1.4 æ•°æ®</h3><p>æ•°æ®æ˜¯åœ¨æ™ºèƒ½ä½“ä¸ç¯å¢ƒäº¤äº’çš„è¿‡ç¨‹ä¸­å¾—åˆ°çš„ã€‚</p><h4 id="å ç”¨åº¦é‡">1.4.1 å ç”¨åº¦é‡</h4><p>å¼ºåŒ–å­¦ä¹ ä¸­æœ‰ä¸€ä¸ªå…³äºæ•°æ®åˆ†å¸ƒçš„æ¦‚å¿µï¼Œå«ä½œ<strong>å ç”¨åº¦é‡ï¼ˆoccupancymeasureï¼‰</strong>ï¼Œå…¶å…·ä½“çš„æ•°å­¦å®šä¹‰å’Œæ€§è´¨ä¼šåœ¨ç¬¬3ç« è®¨è®ºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªåšç®€è¦çš„é™ˆè¿°ï¼š</p><p>å½’ä¸€åŒ–çš„å ç”¨åº¦é‡ç”¨äºè¡¡é‡åœ¨ä¸€ä¸ªæ™ºèƒ½ä½“å†³ç­–ä¸ä¸€ä¸ªåŠ¨æ€ç¯å¢ƒçš„äº¤äº’è¿‡ç¨‹ä¸­ï¼Œ<strong>é‡‡æ ·åˆ°ä¸€ä¸ªå…·ä½“çš„çŠ¶æ€åŠ¨ä½œå¯¹ï¼ˆstate-actionpairï¼‰çš„æ¦‚ç‡åˆ†å¸ƒ</strong>ã€‚</p><p>å ç”¨åº¦é‡æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ€§è´¨ï¼šç»™å®šä¸¤ä¸ªç­–ç•¥åŠå…¶ä¸ä¸€ä¸ªåŠ¨æ€ç¯å¢ƒäº¤äº’å¾—åˆ°çš„ä¸¤ä¸ªå ç”¨åº¦é‡ï¼Œé‚£ä¹ˆå½“ä¸”ä»…å½“è¿™ä¸¤ä¸ªå ç”¨åº¦é‡ç›¸åŒæ—¶ï¼Œè¿™ä¸¤ä¸ªç­–ç•¥ç›¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªæ™ºèƒ½ä½“çš„ç­–ç•¥æœ‰æ‰€æ”¹å˜ï¼Œé‚£ä¹ˆå®ƒå’Œç¯å¢ƒäº¤äº’å¾—åˆ°çš„å ç”¨åº¦é‡ä¹Ÿä¼šç›¸åº”æ”¹å˜ã€‚</p><p>æ ¹æ®å ç”¨åº¦é‡è¿™ä¸€é‡è¦çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥é¢†æ‚Ÿåˆ°å¼ºåŒ–å­¦ä¹ æœ¬è´¨çš„æ€ç»´æ–¹å¼ã€‚</p><ul><li>å¼ºåŒ–å­¦ä¹ çš„ç­–ç•¥åœ¨è®­ç»ƒä¸­ä¼šä¸æ–­æ›´æ–°ï¼Œå…¶å¯¹åº”çš„æ•°æ®åˆ†å¸ƒï¼ˆå³å ç”¨åº¦é‡ï¼‰ä¹Ÿä¼šç›¸åº”åœ°æ”¹å˜ã€‚å› æ­¤ï¼Œ<strong>å¼ºåŒ–å­¦ä¹ çš„ä¸€å¤§éš¾ç‚¹å°±åœ¨äºï¼Œæ™ºèƒ½ä½“çœ‹åˆ°çš„æ•°æ®åˆ†å¸ƒæ˜¯éšç€æ™ºèƒ½ä½“çš„å­¦ä¹ è€Œä¸æ–­å‘ç”Ÿæ”¹å˜çš„</strong>ã€‚</li><li>ç”±äºå¥–åŠ±å»ºç«‹åœ¨çŠ¶æ€åŠ¨ä½œå¯¹ä¹‹ä¸Šï¼Œ<strong>ä¸€ä¸ªç­–ç•¥å¯¹åº”çš„ä»·å€¼å…¶å®å°±æ˜¯ä¸€ä¸ªå ç”¨åº¦é‡ä¸‹å¯¹åº”çš„å¥–åŠ±çš„æœŸæœ›</strong>ï¼Œå› æ­¤<strong>å¯»æ‰¾æœ€ä¼˜ç­–ç•¥å¯¹åº”ç€å¯»æ‰¾æœ€ä¼˜å ç”¨åº¦é‡</strong>ã€‚</li></ul><h3 id="ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ çš„åŒºåˆ«">1.5 ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ çš„åŒºåˆ«</h3><p><strong>ç›‘ç£å­¦ä¹ </strong>ï¼šç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„æ¨¡å‹å‡½æ•°ï¼Œä½¿å…¶åœ¨è®­ç»ƒæ•°æ®é›†ä¸Šæœ€å°åŒ–ä¸€ä¸ªç»™å®šçš„æŸå¤±å‡½æ•°ã€‚åœ¨<strong>è®­ç»ƒæ•°æ®ç‹¬ç«‹åŒåˆ†å¸ƒ</strong>çš„å‡è®¾ä¸‹ï¼Œè¿™ä¸ªä¼˜åŒ–ç›®æ ‡è¡¨ç¤ºæœ€å°åŒ–æ¨¡å‹åœ¨æ•´ä¸ªæ•°æ®åˆ†å¸ƒä¸Šçš„<strong>æ³›åŒ–è¯¯å·®</strong>ã€‚</p><p><strong>å¼ºåŒ–å­¦ä¹ </strong>ï¼šç›®æ ‡æ˜¯<strong>æœ€å¤§åŒ–</strong>æ™ºèƒ½ä½“ç­–ç•¥åœ¨å’ŒåŠ¨æ€ç¯å¢ƒäº¤äº’è¿‡ç¨‹ä¸­çš„<strong>ä»·å€¼</strong>ã€‚ç­–ç•¥çš„ä»·å€¼å¯ä»¥ç­‰ä»·è½¬æ¢æˆ<strong>å¥–åŠ±å‡½æ•°åœ¨ç­–ç•¥çš„å ç”¨åº¦é‡ä¸Šçš„æœŸæœ›</strong>ã€‚</p><p>ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ çš„ä¼˜åŒ–ç›®æ ‡ç›¸ä¼¼ï¼Œå³éƒ½æ˜¯åœ¨<strong>ä¼˜åŒ–æŸä¸ªæ•°æ®åˆ†å¸ƒä¸‹çš„ä¸€ä¸ªåˆ†æ•°å€¼çš„æœŸæœ›</strong>ã€‚ä½†æ˜¯äºŒè€…<strong>ä¼˜åŒ–çš„é€”å¾„ä¸åŒ</strong>ï¼Œç›‘ç£å­¦ä¹ ç›´æ¥é€šè¿‡ä¼˜åŒ–<strong>æ¨¡å‹å¯¹äºæ•°æ®ç‰¹å¾çš„è¾“å‡º</strong>æ¥ä¼˜åŒ–ç›®æ ‡ï¼Œå³<strong>ä¿®æ”¹ç›®æ ‡å‡½æ•°è€Œæ•°æ®åˆ†å¸ƒä¸å˜</strong>ï¼›å¼ºåŒ–å­¦ä¹ åˆ™é€šè¿‡<strong>æ”¹å˜ç­–ç•¥æ¥è°ƒæ•´æ™ºèƒ½ä½“å’Œç¯å¢ƒäº¤äº’æ•°æ®çš„åˆ†å¸ƒ</strong>ï¼Œè¿›è€Œä¼˜åŒ–ç›®æ ‡ï¼Œå³<strong>ä¿®æ”¹æ•°æ®åˆ†å¸ƒè€Œç›®æ ‡å‡½æ•°ä¸å˜</strong>ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œå¼ºåŒ–å­¦ä¹ å’Œç›‘ç£å­¦ä¹ çš„åŒºåˆ«åœ¨äºï¼š</p><ul><li>ç›‘ç£å­¦ä¹ å…³æ³¨å¯»æ‰¾ä¸€ä¸ª<strong>æ¨¡å‹</strong>ï¼Œä½¿å…¶åœ¨<strong>ç»™å®šæ•°æ®åˆ†å¸ƒä¸‹</strong>å¾—åˆ°çš„æŸå¤±å‡½æ•°çš„æœŸæœ›æœ€å°ï¼›</li><li>å¼ºåŒ–å­¦ä¹ å…³æ³¨å¯»æ‰¾ä¸€ä¸ª<strong>æ™ºèƒ½ä½“ç­–ç•¥</strong>ï¼Œä½¿å…¶åœ¨ä¸åŠ¨æ€ç¯å¢ƒäº¤äº’çš„è¿‡ç¨‹ä¸­<strong>äº§ç”Ÿæœ€ä¼˜çš„æ•°æ®åˆ†å¸ƒ</strong>ï¼Œå³æœ€å¤§åŒ–è¯¥åˆ†å¸ƒä¸‹ä¸€ä¸ªç»™å®šå¥–åŠ±å‡½æ•°çš„æœŸæœ›ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼ºåŒ–å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ³¨æ„åŠ›æœºåˆ¶(Attention)</title>
      <link href="/2024/08/08/NLP/Attention/"/>
      <url>/2024/08/08/NLP/Attention/</url>
      
        <content type="html"><![CDATA[<h1 id="æ³¨æ„åŠ›æœºåˆ¶">æ³¨æ„åŠ›æœºåˆ¶</h1><h2 id="self-attention">1 Self-Attention</h2><p>Self-Attentionæ˜¯ä¸€ç§æ³¨æ„åŠ›æœºåˆ¶ï¼Œå®ƒå…è®¸æ¨¡å‹åœ¨è¾“å…¥åºåˆ—ä¸­çš„ä¸åŒä½ç½®ä¹‹é—´å»ºç«‹ä¾èµ–å…³ç³»ã€‚</p><figure><img src="./images/selfa-mha.webp#80x80"title="å›¾1ï¼šSelf-Attention and Multi-Head Attention"alt="Self-Attention" /><figcaption aria-hidden="true">Self-Attention</figcaption></figure><p>Self-Attention æœºåˆ¶çš„è®¡ç®—å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\text{Attention}(Q, K, V) = \text{softmax}(\frac{QK^T}{\sqrt{d_k}} +\text{mask})V\]</span></p><h2 id="multi-head-attention">2 Multi-Head Attention</h2><p>å¤šå¤´æ³¨æ„åŠ›ç›¸æ¯”å•ä¸€çš„è‡ªæ³¨æ„åŠ›ï¼Œé€šè¿‡å¹¶è¡Œè®¡ç®—å¤šä¸ªå¤´çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œèƒ½å¤Ÿä»å¤šä¸ªå­ç©ºé—´ä¸­æå–ä¿¡æ¯ï¼Œæ•æ‰åˆ°æ›´åŠ ä¸°å¯Œå’Œå¤æ‚çš„ç‰¹å¾ï¼Œæå¤§åœ°æé«˜äº†æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›å’Œé²æ£’æ€§ã€‚</p><h3 id="mhaå˜ç§">2.1 MHAå˜ç§</h3><p>ä¸ºäº†åŠ å¿«æ³¨æ„åŠ›è®¡ç®—é€Ÿåº¦ï¼Œé€šå¸¸ä¼šé‡‡ç”¨KV-Cacheï¼Œä½†æ˜¯éšç€ä¸Šä¸‹æ–‡çª—å£æˆ–æ‰¹é‡å¤§å°çš„å¢åŠ ï¼Œ<strong>å¤šå¤´æ³¨æ„åŠ›(MHA)æ¨¡å‹ä¸­ä¸ KV ç¼“å­˜å¤§å°ç›¸å…³çš„å†…å­˜æˆæœ¬æ˜¾è‘—å¢é•¿</strong></p><p>å¯¹äºè¾ƒå¤§çš„æ¨¡å‹ï¼ŒKVç¼“å­˜å¤§å°æˆä¸ºç“¶é¢ˆï¼Œé”®å’Œå€¼æŠ•å½±å¯ä»¥åœ¨å¤šä¸ªå¤´ä¹‹é—´å…±äº«ï¼Œè€Œä¸ä¼šå¤§å¹…é™ä½æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨</p><ol type="1"><li>å…·æœ‰å•ä¸ª KVæŠ•å½±çš„å¤šæŸ¥è¯¢æ³¨æ„(MQA)ï¼šåªä½¿ç”¨ä¸€ä¸ªé”®å€¼å¤´ï¼Œè™½å¤§å¤§åŠ å¿«äº†è§£ç å™¨æ¨æ–­çš„é€Ÿåº¦ï¼Œä½†MQAå¯èƒ½å¯¼è‡´è´¨é‡ä¸‹é™</li><li>å…·æœ‰å¤šä¸ª KVæŠ•å½±çš„åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›(GQA)ï¼šé€šè¿‡æŠ˜ä¸­(å¤šäºä¸€ä¸ªä¸”å°‘äºæŸ¥è¯¢å¤´çš„æ•°é‡ï¼Œæ¯”å¦‚4ä¸ª)é”®å€¼å¤´çš„æ•°é‡ï¼Œä½¿å¾—ç»è¿‡è®­ç»ƒçš„GQAä»¥ä¸MQAç›¸å½“çš„é€Ÿåº¦è¾¾åˆ°æ¥è¿‘å¤šå¤´æ³¨æ„åŠ›çš„è´¨é‡</li></ol><p>GQA å˜ä½“åœ¨å¤§å¤šæ•°è¯„ä¼°ä»»åŠ¡ä¸Šçš„è¡¨ç°ä¸ MHA åŸºçº¿ç›¸å½“ï¼Œå¹¶ä¸”å¹³å‡ä¼˜äº MQAå˜ä½“</p><figure><img src="./images/MHA_GQA_MQA.webp" title="å›¾1ï¼šMHA_GQA_MQA"alt="MHA_GQA_MQA" /><figcaption aria-hidden="true">MHA_GQA_MQA</figcaption></figure><h3 id="gqa">2.2 GQA</h3><p>GQAçš„åˆ†ç»„æ•°æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œç»„æ•°è¶Šå¤§è¶Šæ¥è¿‘MHAï¼Œæ¨ç†å»¶è¿Ÿè¶Šå¤§ï¼ŒåŒæ—¶æ¨¡å‹ç²¾åº¦ä¹Ÿè¶Šé«˜(åŸè®ºæ–‡ä¸­å½“ç»„æ•°é‡ä»1é€æ¸ä¸Šå‡åˆ°8æ—¶ï¼Œæ¨¡å‹æ¨ç†çš„å¼€é”€å¹¶æ²¡æœ‰æ˜æ˜¾çš„å¢é•¿ï¼Œåœ¨8ä»¥åæ¨ç†å¼€é”€æ˜¾è‘—å˜å¤§)ã€‚MQAç•¥å¾®æŸå¤±äº†æ¨¡å‹ç²¾åº¦ï¼Œä½†æ˜¯ç¡®å®èƒ½å¤Ÿå¤§å¹…é™ä½æ¨ç†å¼€é”€ï¼Œè€Œå¦‚æœé€‰æ‹©äº†åˆé€‚çš„åˆ†ç»„æ•°ï¼ŒGQAèƒ½å¤Ÿä¸¤è€…çš†å¾—ã€‚</p><p>åœ¨ç†è®ºå±‚ï¼ŒMQAå’ŒGQAå¯¹æ¨ç†çš„å¸®åŠ©ä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ç‚¹</p><ol type="1"><li><strong>é™ä½å†…å­˜è¯»å–æ¨¡å‹æƒé‡çš„æ—¶é—´å¼€é”€</strong>ï¼šç”±äºKeyçŸ©é˜µå’ŒValueçŸ©é˜µæ•°é‡å˜å°‘äº†ï¼Œå› æ­¤æƒé‡å‚æ•°é‡ä¹Ÿå‡å°‘äº†ï¼Œéœ€è¦è¯»å–åˆ°å†…å­˜çš„æ•°é‡é‡å°‘äº†ï¼Œå› æ­¤å‡å°‘äº†è¯»å–æƒé‡çš„ç­‰å¾…æ—¶é—´</li><li><strong>KV-Cacheç©ºé—´å ç”¨é™ä½</strong>ï¼šKV-Cacheéœ€è¦å­˜å‚¨çš„å‚æ•°é‡é™ä½äº†head_numå€ï¼Œä»è€Œæé«˜KV-Cacheçš„è¯»å†™æ•ˆç‡ï¼›å¦ä¸€æ–¹é¢ï¼Œå¯ä»¥æœ‰ç©ºé—´æ¥å¢å¤§batch_sizeï¼Œä»è€Œæé«˜æ¨¡å‹æ¨ç†çš„ååé‡</li></ol><p>æ³¨æ„<strong>MQAå’ŒGQAå¹¶æ²¡æœ‰é™ä½Attentionçš„è®¡ç®—é‡ï¼ˆFLOPsï¼‰</strong>ï¼Œå› ä¸ºKeyã€Valueæ˜ å°„çŸ©é˜µä¼šä»¥å¹¿æ’­å˜é‡çš„å½¢å¼æ‹“å±•åˆ°å’ŒMHAå’Œä¸€æ ·ï¼Œå› æ­¤è®¡ç®—é‡ä¸å˜ï¼Œåªæ˜¯Keyã€Valueå‚æ•°å…±äº«ã€‚</p><h4 id="mqa">2.3 MQA</h4><p>MQA è®©æ‰€æœ‰çš„å¤´ä¹‹é—´ å…±äº« åŒä¸€ä»½ Key å’Œ ValueçŸ©é˜µï¼Œæ¯ä¸ªå¤´åªå•ç‹¬ä¿ç•™äº†ä¸€ä»½ Query å‚æ•°ï¼Œä»è€Œå¤§å¤§å‡å°‘ Key å’Œ ValueçŸ©é˜µçš„å‚æ•°é‡ã€‚ä½†æ˜¯ï¼ŒMQA ä¼šå¯¼è‡´æ¨¡å‹æ€§èƒ½å’Œè¡¨è¾¾èƒ½åŠ›ä¸‹é™ã€‚</p><h2 id="cross-attention">3 Cross-Attention</h2><p>Cross-Attentionæ˜¯ä¸€ç§æ³¨æ„åŠ›æœºåˆ¶ï¼Œå®ƒå…è®¸æ¨¡å‹åœ¨<strong>ä¸åŒåºåˆ—</strong>ä¹‹é—´å»ºç«‹ä¾èµ–å…³ç³»ã€‚å®ƒçš„æŸ¥è¯¢ï¼ˆQueryï¼‰æ¥è‡ªè§£ç å™¨ï¼Œè€Œé”®ï¼ˆKeyï¼‰å’Œå€¼ï¼ˆValueï¼‰æ¥è‡ªç¼–ç å™¨ã€‚è¿™ç§æœºåˆ¶å…è®¸è§£ç å™¨åœ¨ç”Ÿæˆè¾“å‡ºæ—¶ï¼Œå‚è€ƒç¼–ç å™¨å¤„ç†åçš„è¾“å…¥ä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–å’ŒSelf-Attention æœºåˆ¶ç±»ä¼¼ã€‚</p><h2 id="å…¶ä»–">4 å…¶ä»–</h2><ol type="1"><li>maskå–å…¨1å°±å¯¹åº”åŒå‘æ³¨æ„åŠ›ï¼Œmaskå–ä¸‹ä¸‰è§’çŸ©é˜µå°±å¯¹åº”å•å‘æ³¨æ„åŠ›</li></ol>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—å›¾(Computation Graph)</title>
      <link href="/2024/08/08/NLP/CompGraph/"/>
      <url>/2024/08/08/NLP/CompGraph/</url>
      
        <content type="html"><![CDATA[<h1 id="è®¡ç®—å›¾">è®¡ç®—å›¾</h1><h2 id="ä»€ä¹ˆæ˜¯è®¡ç®—å›¾">1. ä»€ä¹ˆæ˜¯è®¡ç®—å›¾</h2><p>è®¡ç®—å›¾æ˜¯ç”±èŠ‚ç‚¹å’Œè¾¹æ„æˆçš„æœ‰å‘å›¾ï¼ˆGraphï¼‰ï¼Œå…¶ä¸­ï¼š</p><ul><li>èŠ‚ç‚¹ï¼ˆNodesï¼‰ï¼šè¡¨ç¤ºæ“ä½œï¼ˆä¾‹å¦‚åŠ æ³•ã€ä¹˜æ³•ã€æ¿€æ´»å‡½æ•°ç­‰ï¼‰æˆ–å˜é‡ï¼ˆä¾‹å¦‚è¾“å…¥ã€æƒé‡ã€åç½®ç­‰ï¼‰ã€‚</li><li>è¾¹ï¼ˆEdgesï¼‰ï¼šè¡¨ç¤ºæ•°æ®åœ¨èŠ‚ç‚¹ä¹‹é—´çš„æµåŠ¨ï¼Œå³æ“ä½œçš„è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</li></ul><p>åœ¨è®¡ç®—å›¾ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯¹åº”ä¸€ä¸ªæ“ä½œæˆ–å˜é‡ï¼Œè¾¹åˆ™è¡¨ç¤ºè¿™äº›æ“ä½œä¹‹é—´çš„ä¾èµ–é¡ºåºã€‚</p><h2 id="è®¡ç®—å›¾çš„ä¼˜åŠ¿">2. è®¡ç®—å›¾çš„ä¼˜åŠ¿</h2><ol type="1"><li>è‡ªåŠ¨å¾®åˆ†:èƒ½å¤Ÿè‡ªåŠ¨è®¡ç®—å¤æ‚å‡½æ•°çš„æ¢¯åº¦(é“¾å¼æ³•åˆ™)</li><li>å¹¶è¡Œè®¡ç®—:å¯ä»¥è¯†åˆ«ç‹¬ç«‹çš„æ“ä½œå¹¶å¹¶è¡Œæ‰§è¡Œ</li><li>ä¼˜åŒ–:é€šè¿‡å›¾é‡å†™ã€æ“ä½œèåˆã€å†…å­˜ä¼˜åŒ–ç­‰æŠ€æœ¯ä¼˜åŒ–è®¡ç®—æ•ˆç‡<ol type="1"><li>æ“ä½œèåˆï¼šå°†å¤šä¸ªå°æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„æ“ä½œï¼Œä»¥å‡å°‘æ•°æ®ä¼ è¾“å’Œä¸­é—´ç»“æœçš„å­˜å‚¨éœ€æ±‚ï¼Œå¦‚y= 2x + 3xå¯ä¼˜åŒ–ä¸ºy = 5x</li><li>å†…å­˜ä¼˜åŒ–ï¼šé€šè¿‡åœ¨è®¡ç®—å›¾ä¸­æ™ºèƒ½åœ°åˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼Œå‡å°‘å†…å­˜å ç”¨</li><li>åˆ©ç”¨è®¡ç®—å›¾çš„ç»“æ„ï¼Œæ¡†æ¶å¯ä»¥è¯†åˆ«å‡ºç‹¬ç«‹çš„æ“ä½œï¼Œå¹¶åœ¨å¤šä¸ªå¤„ç†å™¨æˆ– GPUä¸Šå¹¶è¡Œæ‰§è¡Œè¿™äº›æ“ä½œ</li></ol></li></ol><h2 id="è®¡ç®—å›¾çš„æ„å»º">3. è®¡ç®—å›¾çš„æ„å»º</h2><p>å‰å‘è®¡ç®—çš„è¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹</p><figure><img src="./images/ForwardCal.webp" title="Forward Calculation"alt="Forward Calculation" /><figcaption aria-hidden="true">Forward Calculation</figcaption></figure><p>æ ¹æ®é“¾å¼æ³•åˆ™ï¼Œåå‘è®¡ç®—çš„è¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹</p><figure><img src="./images/BackwardCal.webp" title="Backward Calculation"alt="Backward Calculation" /><figcaption aria-hidden="true">Backward Calculation</figcaption></figure><ol type="1"><li>å…ˆæŒ‰ç€è®¡ç®—å›¾å¾€å‰è®¡ç®—å¾—åˆ°å„èŠ‚ç‚¹çš„å€¼ï¼›</li><li>ç„¶ååæ–¹å‘è®¡ç®—å‡ºå„ç›´æ¥è¿æ¥çš„èŠ‚ç‚¹é—´ï¼ˆå¦‚xå’Œzã€yå’Œzï¼‰çš„åå¯¼ï¼›</li><li>æœ€åå¯¹æœ‰æ•ˆè·¯å¾„æ±‚å’Œï¼Œå³å¯å¾—åˆ°rå¯¹aã€bã€cã€dã€eçš„åå¯¼ã€‚</li></ol><h2 id="è®¡ç®—å›¾çš„å®ç°">4. è®¡ç®—å›¾çš„å®ç°</h2><p>è®¡ç®—å›¾çš„å®ç°ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š</p><ol type="1"><li>é™æ€è®¡ç®—å›¾ï¼šåœ¨è®¡ç®—å›¾æ„å»ºå®Œæˆåï¼Œå›¾çš„ç»“æ„å’ŒèŠ‚ç‚¹çš„è®¡ç®—é¡ºåºéƒ½æ˜¯å›ºå®šçš„ï¼Œå¦‚TensorFlow çš„è®¡ç®—å›¾ã€‚</li><li>åŠ¨æ€è®¡ç®—å›¾ï¼šåœ¨è®¡ç®—å›¾æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€åœ°æ„å»ºè®¡ç®—å›¾çš„ç»“æ„å’ŒèŠ‚ç‚¹çš„è®¡ç®—é¡ºåºï¼Œå¦‚PyTorch çš„è®¡ç®—å›¾ã€‚</li><li>æ··åˆè®¡ç®—å›¾ï¼šç»“åˆäº†é™æ€è®¡ç®—å›¾å’ŒåŠ¨æ€è®¡ç®—å›¾çš„ä¼˜ç‚¹ï¼Œå¦‚ TensorFlow 2.0çš„è®¡ç®—å›¾ã€‚</li></ol><h2 id="æ€»ç»“">5. æ€»ç»“</h2><p>è®¡ç®—å›¾æ˜¯æ·±åº¦å­¦ä¹ æ¡†æ¶çš„æ ¸å¿ƒï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨å¾®åˆ†ã€å¹¶è¡Œè®¡ç®—ã€ä¼˜åŒ–è®¡ç®—æ•ˆç‡ç­‰ï¼Œæ˜¯å®ç°æ·±åº¦å­¦ä¹ ç®—æ³•çš„åŸºç¡€ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®">6. å‚è€ƒæ–‡çŒ®</h2><ol type="1"><li><ahref="https://zhuanlan.zhihu.com/p/412542969">è®¡ç®—å›¾çš„æ¦‚å¿µä¸ç†è§£</a></li><li><ahref="https://blog.csdn.net/wohu1104/article/details/106911071">æµ…æ˜¾æ˜“æ‡‚çš„è®¡ç®—å›¾ã€é“¾å¼æ³•åˆ™è®²è§£</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è¯åµŒå…¥(Embedding)</title>
      <link href="/2024/08/08/NLP/Embedding/"/>
      <url>/2024/08/08/NLP/Embedding/</url>
      
        <content type="html"><![CDATA[<h1 id="è¯åµŒå…¥embedding">è¯åµŒå…¥(Embedding)</h1><h2 id="ä½ç½®ç¼–ç positional-encoding">1 ä½ç½®ç¼–ç (PositionalEncoding)</h2><p>ä½ç½®ç¼–ç æ˜¯Transformeræ¨¡å‹ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºä¸ºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®æä¾›ä¸€ä¸ªä½ç½®å‘é‡ï¼Œæä¾›æ—¶åºä¿¡æ¯ã€‚</p><h3 id="æ ‡å‡†ä½ç½®ç¼–ç ">1.1 æ ‡å‡†ä½ç½®ç¼–ç </h3><p>å¦‚æœè¾“å…¥åºåˆ—é•¿åº¦ä¸º<code>seq_len</code>ï¼Œè¯åµŒå…¥çš„ç»´åº¦ä¸º<code>d_model</code>ã€‚ä½ç½®ç¼–ç çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[PE_{(pos, 2i)} =\sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)\\PE_{(pos, 2i+1)} =\cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)\]</span></p><p>å…¶ä¸­ï¼Œ<spanclass="math inline">\(pos\)</span>è¡¨ç¤ºtokenåœ¨åºåˆ—ä¸­çš„ä½ç½®ï¼Œ<spanclass="math inline">\(i\)</span>è¡¨ç¤ºç»´åº¦ã€‚ä½ç½®ç¼–ç çš„ç»´åº¦ä¸è¯åµŒå…¥çš„ç»´åº¦ç›¸åŒã€‚å¶æ•°ç»´åº¦ç”¨<code>sin</code>å‡½æ•°ç¼–ç ï¼Œå¥‡æ•°ç»´åº¦ç”¨<code>cos</code>å‡½æ•°ç¼–ç ã€‚</p><p>å¯¹äºä¸€ä¸ªåºåˆ—ï¼Œä½ç½®ç¼–ç çš„ç»´åº¦ä¸º<code>[seq_len, d_model]</code>ã€‚è¯åµŒå…¥å’Œä½ç½®ç¼–ç ç›¸åŠ ï¼Œä½œä¸ºæ¨¡å‹çš„è¾“å…¥ã€‚</p><p>æ¯”å¦‚å¯¹äºå…¶ä¸­ä¸€ä¸ªtokenï¼Œå°±æ˜¯ä¸€ä¸ª<code>[d_model]</code>çš„ä¸€ç»´å‘é‡ï¼Œå¯¹ä½ç›¸åŠ ä¸€ä¸ª<code>[d_model]</code>çš„ä¸€ç»´ä½ç½®ç¼–ç å‘é‡ã€‚</p><h3 id="æ—‹è½¬ä½ç½®ç¼–ç rope">1.2 æ—‹è½¬ä½ç½®ç¼–ç (ROPE)</h3><p>ROPEï¼ˆRotary PositionEmbeddingï¼‰é€šè¿‡å¯¹è¯å‘é‡è¿›è¡Œæ—‹è½¬å˜æ¢æ¥ç¼–ç ä½ç½®ä¿¡æ¯,è€Œä¸æ˜¯åƒä¼ ç»Ÿæ–¹æ³•é‚£æ ·å°†ä½ç½®ç¼–ç ç›´æ¥åŠ åˆ°è¯å‘é‡ä¸Šã€‚</p><p>å¦‚æœè¾“å…¥åºåˆ—é•¿åº¦ä¸º<code>seq_len</code>ï¼Œè¯åµŒå…¥çš„ç»´åº¦ä¸º<code>d_model</code>ã€‚RoPEçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><ol type="1"><li>å¤æ•°å½¢å¼ <span class="math display">\[\text{RoPE}(x_m, m) = x_m \cdot e^{im\theta}\]</span></li><li>åŸºæœ¬å½¢å¼ <span class="math display">\[\theta_{pos,i} = \frac{pos}{10000^{\frac{2i}{d}}}\\\text{RoPE}(x, pos)_{2i} = x_{2i} \cos(\theta_{pos,i}) + x_{2i+1}\sin(\theta_{pos,i})\\\text{RoPE}(x, pos)_{2i+1} = x_{2i+1} \cos(\theta_{pos,i}) - x_{2i}\sin(\theta_{pos,i})\]</span></li><li>çŸ©é˜µå½¢å¼ <span class="math display">\[R_{\theta,pos,2i} = \begin{bmatrix}\cos(\theta_{pos,i}) &amp; -\sin(\theta_{pos,i}) \\\sin(\theta_{pos,i}) &amp; \cos(\theta_{pos,i})\end{bmatrix}\\\begin{bmatrix}x&#39;_{2i} \\x&#39;_{2i+1}\end{bmatrix} =\begin{bmatrix}x_{2i} \\x_{2i+1}\end{bmatrix} \cdot R_{\theta,pos,2i}\]</span></li></ol><h3 id="çº¿æ€§æ³¨æ„åŠ›åç½®alibi">1.3 çº¿æ€§æ³¨æ„åŠ›åç½®(ALiBi)</h3><p>ä¸åŒäºä¼ ç»Ÿæ–¹æ³•ï¼ŒALiBiä¸ç›´æ¥ä¿®æ”¹tokenembeddingsï¼Œè€Œæ˜¯åœ¨æ³¨æ„åŠ›è®¡ç®—è¿‡ç¨‹ä¸­æ·»åŠ ä¸€ä¸ªçº¿æ€§åç½®é¡¹ï¼Œè¿™ä¸ªåç½®é¡¹éšç€åºåˆ—ä¸­tokensçš„ç›¸å¯¹è·ç¦»çº¿æ€§å¢åŠ ã€‚</p><p>[(Q, K, V) = ( + B) V]</p><p>å…¶ä¸­ï¼Œä½ç½®åç½®çŸ©é˜µ ( B ) å®šä¹‰ä¸ºï¼š</p><p>[B_{ij} = -|i - j| m]</p><h2 id="è¯å‘é‡word2vec">2 è¯å‘é‡(Word2Vec)</h2><p><strong>ä¸Šä¸‹æ–‡ç›¸ä¼¼çš„ä¸¤ä¸ªè¯ï¼Œå®ƒä»¬çš„è¯å‘é‡ä¹Ÿåº”è¯¥ç›¸ä¼¼</strong>ï¼Œæ¯”å¦‚é¦™è•‰å’Œæ¢¨åœ¨å¥å­ä¸­å¯èƒ½ç»å¸¸å‡ºç°åœ¨ç›¸åŒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤è¿™ä¸¤ä¸ªè¯çš„è¡¨ç¤ºå‘é‡åº”è¯¥å°±æ¯”è¾ƒç›¸ä¼¼ã€‚</p><p>Word2Vecæ˜¯ä¸€ç§è¯åµŒå…¥æŠ€æœ¯ï¼Œå®ƒçš„ç›®çš„æ˜¯å°†è¯è¯­æ˜ å°„åˆ°ä¸€ä¸ªä½ç»´ç©ºé—´ä¸­ï¼Œä½¿å¾—è¯­ä¹‰ç›¸è¿‘çš„è¯åœ¨è¿™ä¸ªç©ºé—´ä¸­çš„è·ç¦»ä¹Ÿæ¯”è¾ƒè¿‘ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡è®­ç»ƒç¥ç»ç½‘ç»œï¼Œä½¿å¾—è¯å‘é‡çš„å†…ç§¯å°½å¯èƒ½çš„å¤§ï¼Œè€Œä¸ä¹‹ä¸ç›¸å…³çš„è¯å‘é‡çš„å†…ç§¯å°½å¯èƒ½çš„å°ã€‚</p><p>Word2Vecæ¨¡å‹æœ‰ä¸¤ç§ï¼š</p><ol type="1"><li>CBOW: é€šè¿‡ä¸Šä¸‹æ–‡é¢„æµ‹ä¸­å¿ƒè¯ï¼Œå³ç”¨<span class="math inline">\(w_{t-1},w_{t-2}, w_{t+1}, w_{t+2}\)</span>é¢„æµ‹<spanclass="math inline">\(w_t\)</span></li><li>Skip-gram: é€šè¿‡ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡ï¼Œå³ç”¨<spanclass="math inline">\(w_t\)</span>é¢„æµ‹<spanclass="math inline">\(w_{t-1}, w_{t-2}, w_{t+1}, w_{t+2}\)</span></li></ol><figure><img src="./images/Word2Vec.webp#80x80" title="å›¾1ï¼šWord2Vec"alt="Word2Vec" /><figcaption aria-hidden="true">Word2Vec</figcaption></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLM å‚æ•°é‡åŠ FLOPs è®¡ç®—</title>
      <link href="/2024/08/08/NLP/FLOPs/"/>
      <url>/2024/08/08/NLP/FLOPs/</url>
      
        <content type="html"><![CDATA[<h1 id="llm-å‚æ•°é‡flopsè®¡ç®—å’Œä¸­é—´æ¿€æ´»å€¼çš„å­˜å‚¨">LLMå‚æ•°é‡ã€FLOPsè®¡ç®—å’Œä¸­é—´æ¿€æ´»å€¼çš„å­˜å‚¨</h1><p>åˆ†æåŸºäºDecoder-onlyçš„LLMæ¡†æ¶</p><table><thead><tr><th style="text-align: center;">å‚æ•°</th><th style="text-align: center;">ç¬¦å·</th><th style="text-align: center;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align: center;">Decoderå±‚æ•°</td><td style="text-align: center;">l</td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">TokenåµŒå…¥ç»´åº¦</td><td style="text-align: center;">d</td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">Attentionå±‚åµŒå…¥ç»´åº¦</td><td style="text-align: center;">d</td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">MLPéšè—å±‚ç»´åº¦</td><td style="text-align: center;">4d</td><td style="text-align: center;">é€šå¸¸è®¾ç½®ä¸ºåµŒå…¥ç»´åº¦4å€</td></tr><tr><td style="text-align: center;">Attention headæ•°é‡</td><td style="text-align: center;">n</td><td style="text-align: center;">è¦æ±‚å…¶æ•´é™¤d</td></tr><tr><td style="text-align: center;">è¯è¡¨å°ºå¯¸</td><td style="text-align: center;">V</td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">batch_size</td><td style="text-align: center;">b</td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">æ¨¡å‹è¾“å…¥é•¿åº¦</td><td style="text-align: center;">s</td><td style="text-align: center;"></td></tr></tbody></table><h2 id="æ¨¡å‹å‚æ•°é‡">1. æ¨¡å‹å‚æ•°é‡</h2><ol type="1"><li>Embeddingå±‚ï¼š<span class="math inline">\([V, d]\)</span> â€”â€” <spanclass="math inline">\(Vd\)</span></li><li>Self-Attentionå±‚(é€šå¸¸æ˜¯æ²¡æœ‰å¸¦åç½®é¡¹) â€”â€” <spanclass="math inline">\(4d^2 (+ 4d)\)</span><ul><li>Q K V çŸ©é˜µï¼š <span class="math inline">\([d, d]\)</span> â€”â€” <spanclass="math inline">\(3d^2\)</span></li><li>O çŸ©é˜µï¼š<span class="math inline">\([d, d]\)</span> â€”â€” <spanclass="math inline">\(d^2\)</span></li><li>å¦‚æœå¸¦åç½®ï¼Œæ¯ä¸ªéƒ½æ˜¯<span class="math inline">\(d\)</span> â€”â€” <spanclass="math inline">\(4d\)</span></li></ul></li><li>MLPå±‚(é€šå¸¸å¸¦åç½®é¡¹) â€”â€” <span class="math inline">\(8d^2 +5d\)</span><ul><li>X-&gt;Hï¼š<span class="math inline">\([d, 4d]\)</span> â€”â€” <spanclass="math inline">\(4d^2+4d\)</span></li><li>H-&gt;Oï¼š<span class="math inline">\([4d, d]\)</span> â€”â€” <spanclass="math inline">\(4d^2+d\)</span></li></ul></li><li>ä¸¤ä¸ªLayerNormå±‚ â€”â€” <span class="math inline">\(2 * 2d\)</span><ul><li>ç¼©æ”¾å‚æ•° Scaleï¼š<span class="math inline">\([d]\)</span> â€”â€” <spanclass="math inline">\(d\)</span></li><li>å¹³ç§»å‚æ•° Biasï¼š<span class="math inline">\([d]\)</span> â€”â€” <spanclass="math inline">\(d\)</span></li></ul></li></ol><table><thead><tr><th style="text-align: center;">æ¨¡å—</th><th style="text-align: center;">æ•°é‡</th><th style="text-align: center;">å•ä¸ªå‚æ•°é‡</th><th style="text-align: center;">æ€»å‚æ•°é‡</th></tr></thead><tbody><tr><td style="text-align: center;">Embedding</td><td style="text-align: center;">1</td><td style="text-align: center;"><spanclass="math inline">\(Vd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(Vd\)</span></td></tr><tr><td style="text-align: center;">Self-Attention</td><td style="text-align: center;">l</td><td style="text-align: center;"><span class="math inline">\(4d^2 (+4d)\)</span></td><td style="text-align: center;"><span class="math inline">\(4ld^2 (+4ld)\)</span></td></tr><tr><td style="text-align: center;">MLP</td><td style="text-align: center;">l</td><td style="text-align: center;"><span class="math inline">\(8d^2 +5d\)</span></td><td style="text-align: center;"><span class="math inline">\(8ld^2 +5ld\)</span></td></tr><tr><td style="text-align: center;">LayerNorm</td><td style="text-align: center;">2l</td><td style="text-align: center;"><spanclass="math inline">\(2d\)</span></td><td style="text-align: center;"><spanclass="math inline">\(4ld\)</span></td></tr></tbody></table><p>æ€»å‚æ•°é‡ï¼š<span class="math inline">\(Vd + 12ld^2 + 9ld (+4ld)\)</span> è¿‘ä¼¼äº <span class="math inline">\(12ld^2\)</span></p><p>æ¯”å¦‚LLaMa-7Bï¼Œ<span class="math inline">\(V=128k, d=4096,l=32\)</span></p><ul><li>æ€»å‚æ•°é‡ä¸º<span class="math inline">\(128k*4096 + 12*32*4096^2 +9*32*4096 \approx 6.98B\)</span></li><li>ç²—ç•¥è®¡ç®—ä¸º<span class="math inline">\(12*32*4096^2 \approx6.44B\)</span></li></ul><h2 id="æ˜¾å­˜å ç”¨">2. æ˜¾å­˜å ç”¨</h2><h3 id="è®­ç»ƒè¿‡ç¨‹">2.1 è®­ç»ƒè¿‡ç¨‹</h3><p>åœ¨è®­ç»ƒç¥ç»ç½‘ç»œçš„è¿‡ç¨‹ä¸­ï¼Œå ç”¨æ˜¾å­˜çš„å¤§å¤´ä¸»è¦åˆ†ä¸ºå››éƒ¨åˆ†ï¼š</p><ol type="1"><li>æ¨¡å‹å‚æ•°</li><li>å‰å‘è®¡ç®—è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´æ¿€æ´»ï¼ˆä¸­é—´æ¿€æ´»çš„æ˜¾å­˜å ç”¨åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼‰</li><li>åå‘ä¼ é€’è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦</li><li>ä¼˜åŒ–å™¨çŠ¶æ€</li></ol><p>è®­ç»ƒå¤§æ¨¡å‹æ—¶é€šå¸¸ä¼šé‡‡ç”¨AdamWä¼˜åŒ–å™¨ï¼Œå¹¶ç”¨æ··åˆç²¾åº¦è®­ç»ƒæ¥åŠ é€Ÿè®­ç»ƒï¼ŒåŸºäºè¿™ä¸ªå‰æåˆ†ææ˜¾å­˜å ç”¨ã€‚</p><p>åœ¨ä¸€æ¬¡è®­ç»ƒè¿­ä»£ä¸­ï¼Œæ¯ä¸ªå¯è®­ç»ƒæ¨¡å‹å‚æ•°éƒ½ä¼šå¯¹åº”1ä¸ªæ¢¯åº¦ï¼Œå¹¶å¯¹åº”2ä¸ªä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆAdamä¼˜åŒ–å™¨æ¢¯åº¦çš„ä¸€é˜¶åŠ¨é‡å’ŒäºŒé˜¶åŠ¨é‡ï¼‰ã€‚float16æ•°æ®ç±»å‹çš„å…ƒç´ å 2ä¸ªbytesï¼Œfloat32æ•°æ®ç±»å‹çš„å…ƒç´ å 4ä¸ªbytesã€‚åœ¨æ··åˆç²¾åº¦è®­ç»ƒä¸­ï¼Œä¼šä½¿ç”¨float16çš„æ¨¡å‹å‚æ•°è¿›è¡Œå‰å‘ä¼ é€’å’Œåå‘ä¼ é€’ï¼Œè®¡ç®—å¾—åˆ°float16çš„æ¢¯åº¦ï¼›åœ¨ä¼˜åŒ–å™¨æ›´æ–°æ¨¡å‹å‚æ•°æ—¶ï¼Œä¼šä½¿ç”¨float32çš„ä¼˜åŒ–å™¨çŠ¶æ€ã€float32çš„æ¢¯åº¦ã€float32çš„æ¨¡å‹å‚æ•°æ¥æ›´æ–°æ¨¡å‹å‚æ•°ã€‚</p><p>è®¾æ¨¡å‹å‚æ•°ä¸º<span class="math inline">\(N\)</span>ï¼Œåˆ™æ˜¾å­˜å ç”¨ä¸º<spanclass="math inline">\(20N\)</span> bytesï¼ˆä¸åŒ…æ‹¬ä¸­é—´æ¿€æ´»ï¼‰ã€‚</p><ol type="1"><li>æ¨¡å‹å‚æ•°ï¼š<span class="math inline">\(2N\)</span> bytes (float16) +<span class="math inline">\(4N\)</span> bytes (float32)</li><li>æ¢¯åº¦ï¼š<span class="math inline">\(2N\)</span> bytes (float16) +<span class="math inline">\(4N\)</span> bytes (float32)</li><li>ä¼˜åŒ–å™¨çŠ¶æ€ï¼š<span class="math inline">\(2 \times 4N\)</span> bytes(float32)</li></ol><h3 id="æ¨ç†è¿‡ç¨‹">2.2 æ¨ç†è¿‡ç¨‹</h3><p>ä¸éœ€è¦å­˜å‚¨æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼Œä¹Ÿæ— éœ€å­˜å‚¨ä¸­é—´æ¿€æ´»å€¼ï¼Œåªéœ€è¦å­˜å‚¨æ¨¡å‹å‚æ•°ï¼Œæ˜¾å­˜å ç”¨ä¸º<spanclass="math inline">\(2N\)</span> bytes (é‡‡ç”¨float16æ¨ç†)ã€‚æ³¨ï¼šå¦‚æœå¯ç”¨KVç¼“å­˜ï¼Œåˆ™éœ€è¦é¢å¤–å­˜å‚¨KVç¼“å­˜ã€‚</p><h2 id="flops">3. FLOPs</h2><p>LLM ä¸­çš„ä¸»è¦è¿ç®—æ˜¯çŸ©é˜µä¹˜æ³•ï¼Œæ•…è€ƒå¯Ÿ LLMè®¡ç®—é‡æ—¶ï¼Œ<strong>é€šå¸¸åªå…³æ³¨çŸ©é˜µä¹˜æ³•è¿ç®—å¯¹åº”çš„æµ®ç‚¹è®¡ç®—é‡</strong> <spanclass="math inline">\(m \times n\)</span> çŸ©é˜µä¹˜ä»¥ <spanclass="math inline">\(n \times k\)</span> çŸ©é˜µ(<em>n-1æ¬¡åŠ æ³•å’Œnæ¬¡ä¹˜æ³•</em> )çš„è¿ç®—é‡ä¸º <spanclass="math inline">\(mk(2n-1)\)</span>ï¼Œä½†æ˜¯ GPU è®¡ç®—çŸ©é˜µä¹˜æ³•æ—¶ä¸€èˆ¬ä½¿ç”¨FMA (fused multiplyâ€“add) è¿›è¡Œè®¡ç®—ï¼Œä¸€æ¬¡ FMAå¯ä»¥è®¡ç®—ä¸€ä¸ªä¹˜æ³•å’Œä¸€ä¸ªåŠ æ³•ï¼Œå› æ­¤å®é™…çš„ FLOPs è®¡ç®—é‡ä¸º <spanclass="math inline">\(mk(2n)\)</span></p><p>å‡è®¾è¾“å…¥çš„batchä¸º<span class="math inline">\(b \times s \timesd\)</span>ï¼Œå…¶ä¸­<spanclass="math inline">\(b\)</span>ä¸ºbatch_sizeï¼Œ<spanclass="math inline">\(s\)</span>ä¸ºè¾“å…¥é•¿åº¦ï¼Œ<spanclass="math inline">\(d\)</span>ä¸ºåµŒå…¥ç»´åº¦</p><ol type="1"><li>Embeddingå±‚ï¼šæŸ¥è¡¨æ“ä½œï¼Œä¸æ¶‰åŠçŸ©é˜µä¹˜æ³•ï¼Œæ•…ä¸è®¡å…¥FLOPs</li><li>é¢„æµ‹å¤šåˆ†ç±»å¤´(logits)å°†å°ºå¯¸ä¸º d çš„éšè—å‘é‡æ˜ å°„ä¸ºè¯è¡¨å¤§å°ï¼š<spanclass="math inline">\([b \times s \times d] \times [d \times V] = [b\times s \times V]\)</span> â€”â€” <spanclass="math inline">\(2bsVd\)</span></li><li>Self-Attentionå±‚ï¼š<span class="math inline">\(8bsd^2+4bs^2d\)</span><span class="math display">\[     Q=xW_{Q}, K=xW_{K}, V=xW_{V}\\     Attention(Q, K, V) = softmax(\frac{QK^T}{\sqrt{d_k}})V\\     x_{out}= AW_{O}+x\]</span><ul><li>è®¡ç®— QKV çŸ©é˜µï¼š<span class="math inline">\([b \times s \times d]\times [d \times d] = [b \times s \times d]\)</span> â€”â€” <spanclass="math inline">\(6bsd^2\)</span></li><li>è®¡ç®—æ³¨æ„åŠ›æƒé‡<span class="math inline">\(QK^T\)</span>ï¼š<spanclass="math inline">\([b \times n \times s \times d/n] \times [b \timesn \times d/n \times s] = [b \times n \times s \times s]\)</span> â€”â€”<span class="math inline">\(2bs^2d\)</span></li><li>æ±‡èšä»·å€¼ä¿¡æ¯<span class="math inline">\(AV\)</span>: <spanclass="math inline">\([b \times n \times s \times s] \times [b \times n\times s \times d/n] = [b \times n \times s \times d/n]\)</span> â€”â€”<span class="math inline">\(2bs^2d\)</span></li><li>æ‹¼æ¥å¤šå¤´æ³¨æ„åŠ›: ä¸æ¶‰åŠçŸ©é˜µä¹˜æ³•ï¼Œæ•…ä¸è®¡å…¥FLOPs</li><li>è¾“å‡ºçŸ©é˜µ<span class="math inline">\(O\)</span>: <spanclass="math inline">\([b \times s \times d] \times [d \times d] = [b\times s \times d]\)</span> â€”â€” <spanclass="math inline">\(2bsd^2\)</span></li></ul></li><li>MLPå±‚ï¼š<span class="math inline">\(16bsd^2\)</span> <spanclass="math display">\[     h=Relu(x_{out}W_1+b_1)\\     h_{out}=hW_2+b2\\     x=h_{out}+x_{out}\]</span><ul><li>ç¬¬ä¸€ä¸ªçº¿æ€§å±‚ï¼š<span class="math inline">\([b \times s \times d]\times [d \times 4d] = [b \times s \times 4d]\)</span> â€”â€” <spanclass="math inline">\(8bsd^2\)</span></li><li>ç¬¬äºŒä¸ªçº¿æ€§å±‚ï¼š<span class="math inline">\([b \times s \times 4d]\times [4d \times d] = [b \times s \times d]\)</span> â€”â€” <spanclass="math inline">\(8bsd^2\)</span></li></ul></li><li>åå‘ä¼ æ’­ï¼šåå‘ä¼ æ’­è¿‡ç¨‹ä¸­æ¯ä¸ªéç¬¬ä¸€å±‚éƒ½æœ‰ä¸¤æ¬¡çŸ©é˜µä¹˜æ³•æ“ä½œï¼Œè€Œç›¸åº”çš„å‰å‘è¿‡ç¨‹ä¸­åªæœ‰ä¸€æ¬¡ï¼ˆç¬¬ä¸€å±‚çš„åå‘-å‰å‘FLOPsæ¯”ç‡æ˜¯1:1ï¼Œè€Œå…¶ä»–å±‚åå‘-å‰å‘FLOPsæ¯”ç‡æ˜¯2:1ï¼‰ã€‚éšç€ç½‘ç»œå±‚æ•°å¢åŠ ï¼Œåå‘ä¼ æ’­è®¡ç®—é‡ä¼šè¶Šæ¥è¶Šæ¥è¿‘æ­£å‘ä¼ æ’­è®¡ç®—é‡çš„ä¸¤å€ã€‚</li></ol><table><thead><tr><th style="text-align: center;">æ¨¡å—</th><th style="text-align: center;">æ•°é‡</th><th style="text-align: center;">å•æ¬¡FLOPs</th><th style="text-align: center;">æ€»FLOPs</th></tr></thead><tbody><tr><td style="text-align: center;">Embedding</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr><td style="text-align: center;">LM Head(logits)</td><td style="text-align: center;">1</td><td style="text-align: center;"><spanclass="math inline">\(2bsVd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(2bsVd\)</span></td></tr><tr><td style="text-align: center;">Self-Attention</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(8bsd^2+4bs^2d\)</span></td><td style="text-align: center;"><spanclass="math inline">\(8blsd^2+4bls^2d\)</span></td></tr><tr><td style="text-align: center;">MLP</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(16bsd^2\)</span></td><td style="text-align: center;"><spanclass="math inline">\(16blsd^2\)</span></td></tr></tbody></table><p>å‰å‘ä¼ æ’­æ€»FLOPsï¼š<span class="math inline">\(2bsVd + 24blsd^2 +4bls^2d\)</span>ï¼Œè¿‘ä¼¼ä¸º<span class="math inline">\(24blsd^2\)</span>åŠ ä¸Šåå‘ä¼ æ’­çš„FLOPsï¼Œä¸€æ¬¡è®­ç»ƒè¿­ä»£çš„æ€»è®¡ç®—é‡ä¸º<spanclass="math inline">\(72blsd^2\)</span></p><h3 id="è®¡ç®—é‡å’Œå‚æ•°é‡çš„å…³ç³»">3.1 è®¡ç®—é‡å’Œå‚æ•°é‡çš„å…³ç³»</h3><p>è¿›ä¸€æ­¥è€ƒè™‘Tokenæ•°æ®é‡ä¸º<spanclass="math inline">\(D=bs\)</span>ï¼Œå‚æ•°é‡ä¸º<spanclass="math inline">\(N=12ld^2\)</span></p><ul><li>æ¨ç†ï¼š<span class="math inline">\(2DN\)</span></li><li>è®­ç»ƒï¼š<span class="math inline">\(6DN\)</span></li></ul><p>å¯ä»¥è¿‘ä¼¼è®¤ä¸ºï¼šåœ¨ä¸€æ¬¡æ¨ç†ä¸­ï¼Œå¯¹äºæ¯ä¸ªtokenï¼Œæ¯ä¸ªæ¨¡å‹å‚æ•°ï¼Œéœ€è¦è¿›è¡Œ2æ¬¡æµ®ç‚¹æ•°è¿ç®—ï¼Œå³ä¸€æ¬¡ä¹˜æ³•æ³•è¿ç®—å’Œä¸€æ¬¡åŠ æ³•è¿ç®—ï¼Œè€Œåœ¨ä¸€æ¬¡è®­ç»ƒä¸­ï¼Œéœ€è¦è¿›è¡Œ6æ¬¡æµ®ç‚¹æ•°è¿ç®—ã€‚</p><h3 id="ä¼°è®¡è®­ç»ƒæ—¶é—´">3.2 ä¼°è®¡è®­ç»ƒæ—¶é—´</h3><p>è®­ç»ƒç¥ç»ç½‘ç»œçš„ä¸€æ¬¡è¿­ä»£åˆ†ä¸ºä¸‰æ­¥</p><ol type="1"><li>å‰å‘ä¼ é€’è®¡ç®—æŸå¤±å‡½æ•°ï¼›</li><li>åå‘ä¼ é€’è®¡ç®—æ¢¯åº¦ï¼›</li><li>ä¼˜åŒ–å™¨æ›´æ–°æ¨¡å‹å‚æ•°ã€‚</li></ol><p>åå‘ä¼ é€’çš„è€—æ—¶å‡ ä¹æ˜¯å‰å‘ä¼ é€’çš„ä¸¤å€ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œä¼˜åŒ–å™¨æ›´æ–°çš„è€—æ—¶å‡ ä¹å¯ä»¥å¿½ç•¥ã€‚è¿›ä¸€æ­¥çš„</p><p><span class="math display">\[è®­ç»ƒæ—¶é—´ \approx \frac{6DN}{FLOPS \times {GPU æ•°é‡} \times {GPUåˆ©ç”¨ç‡}}\]</span></p><p>å¦‚æœä½¿ç”¨æ¿€æ´»é‡è®¡ç®—æŠ€æœ¯æ¥å‡å°‘ä¸­é—´æ¿€æ´»æ˜¾å­˜éœ€è¦è¿›è¡Œä¸€æ¬¡é¢å¤–çš„å‰å‘ä¼ é€’ï¼Œåˆ™</p><p><span class="math display">\[è®­ç»ƒæ—¶é—´ \approx \frac{8DN}{FLOPS \times {GPU æ•°é‡} \times {GPUåˆ©ç”¨ç‡}}\]</span></p><p>ä¸€èˆ¬æ¥è®²ï¼ŒGPUåˆ©ç”¨ç‡ä¸€èˆ¬åœ¨<spanclass="math inline">\(0.3-0.55\)</span>ä¹‹é—´ã€‚</p><h2 id="ä¸­é—´æ¿€æ´»å€¼çš„å­˜å‚¨">4 ä¸­é—´æ¿€æ´»å€¼çš„å­˜å‚¨</h2><p><strong>å‰å‘ä¼ é€’è¿‡ç¨‹ä¸­è®¡ç®—å¾—åˆ°çš„ï¼Œå¹¶åœ¨åå‘ä¼ é€’è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„æ‰€æœ‰å¼ é‡</strong>(ä¸åŒ…å«æ¨¡å‹å‚æ•°å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼Œä½†åŒ…å«dropoutæ“ä½œéœ€è¦ç”¨åˆ°çš„maskçŸ©é˜µ)</p><p>å¤§æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é€šå¸¸é‡‡ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼Œä¸­é—´æ¿€æ´»å€¼ä¸€èˆ¬æ˜¯float16æˆ–è€…bfloat16æ•°æ®ç±»å‹çš„ã€‚åœ¨åˆ†æä¸­é—´æ¿€æ´»çš„æ˜¾å­˜å ç”¨æ—¶ï¼Œ<strong>å‡è®¾ä¸­é—´æ¿€æ´»å€¼æ˜¯ä»¥float16æˆ–bfloat16æ•°æ®æ ¼å¼æ¥ä¿å­˜çš„ï¼Œæ¯ä¸ªå…ƒç´ å äº†2ä¸ªbytesã€‚å”¯ä¸€ä¾‹å¤–çš„æ˜¯ï¼Œdropoutæ“ä½œçš„maskçŸ©é˜µï¼Œæ¯ä¸ªå…ƒç´ åªå 1ä¸ªbytesã€‚</strong></p><ol type="1"><li>Self-Attentionå±‚ï¼š<span class="math inline">\(11bsd+5bs^2n\)</span><ol type="1"><li>å¯¹äºQKVï¼Œéœ€è¦ä¿å­˜è¾“å…¥xï¼š<span class="math inline">\([b \times s\times d]\)</span> â€”â€” <span class="math inline">\(2bsd\)</span></li><li>å¯¹äº<spanclass="math inline">\(QK^T\)</span>ï¼Œéœ€è¦ä¿å­˜Qå’ŒKçŸ©é˜µï¼š<spanclass="math inline">\([b \times s \times d]\)</span> â€”â€” <spanclass="math inline">\(4bsd\)</span></li><li>å¯¹äºSoftmaxï¼Œéœ€è¦ä¿å­˜<spanclass="math inline">\(QK^T\)</span>ï¼š<span class="math inline">\([b\times n \times s \times s]\)</span> â€”â€” <spanclass="math inline">\(2bs^2n\)</span></li><li>ä¼šæœ‰ä¸€ä¸ªdropoutæ“ä½œï¼Œéœ€è¦ä¿å­˜maskçŸ©é˜µï¼Œä¸<spanclass="math inline">\(QK^T\)</span>å°ºå¯¸ç›¸åŒï¼š<spanclass="math inline">\([b \times n \times s \times s]\)</span> â€”â€” <spanclass="math inline">\(bs^2n\)</span></li><li>ä¹‹åè®¡ç®—Aï¼Œéœ€è¦ä¿å­˜VçŸ©é˜µå’Œsoftmaxï¼š<span class="math inline">\([b\times s \times d]\)</span>å’Œ<span class="math inline">\([b \times n\times s \times s]\)</span> â€”â€” <span class="math inline">\(2bsd +2bs^2n\)</span></li><li>è®¡ç®—è¾“å‡ºçŸ©é˜µOï¼Œéœ€è¦ä¿å­˜Aï¼š<span class="math inline">\([b \times s\times d]\)</span> â€”â€” <span class="math inline">\(2bsd\)</span></li><li>ä¼šæœ‰ä¸€ä¸ªdropoutæ“ä½œï¼Œéœ€è¦ä¿å­˜maskçŸ©é˜µï¼Œä¸Aå°ºå¯¸ç›¸åŒï¼š<spanclass="math inline">\([b \times s \times d]\)</span> â€”â€” <spanclass="math inline">\(bsd\)</span></li></ol></li><li>MLPå±‚ï¼š<span class="math inline">\(19bsd\)</span><ol type="1"><li>å¯¹äºç¬¬ä¸€ä¸ªçº¿æ€§å±‚ï¼Œéœ€è¦ä¿å­˜è¾“å…¥xï¼š<span class="math inline">\([b\times s \times d]\)</span> â€”â€” <spanclass="math inline">\(2bsd\)</span></li><li>æ¿€æ´»å‡½æ•°éœ€è¦ä¿å­˜è¾“å…¥ï¼š<span class="math inline">\([b \times s \times4d]\)</span> â€”â€” <span class="math inline">\(8bsd\)</span></li><li>å¯¹äºç¬¬äºŒä¸ªçº¿æ€§å±‚ï¼Œéœ€è¦ä¿å­˜è¾“å…¥hï¼š<span class="math inline">\([b\times s \times 4d]\)</span> â€”â€” <spanclass="math inline">\(8bsd\)</span></li><li>ä¼šæœ‰ä¸€ä¸ªdropoutæ“ä½œï¼Œéœ€è¦ä¿å­˜maskçŸ©é˜µï¼Œä¸hå°ºå¯¸ç›¸åŒï¼š<spanclass="math inline">\([b \times s \times d]\)</span> â€”â€” <spanclass="math inline">\(bsd\)</span></li></ol></li><li>ä¸¤ä¸ªLayerNormå±‚ï¼š<span class="math inline">\(2 \times 2bsd\)</span>ä¿å­˜è¾“å…¥ï¼š<span class="math inline">\([b \times s \times d]\)</span> â€”â€”<span class="math inline">\(2bsd\)</span></li></ol><table><thead><tr><th style="text-align: center;">æ¨¡å—</th><th style="text-align: center;">æ•°é‡</th><th style="text-align: center;">å•ä¸ªå ç”¨</th><th style="text-align: center;">æ€»å ç”¨</th></tr></thead><tbody><tr><td style="text-align: center;">Self-Attention</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(11bsd+5bs^2n\)</span></td><td style="text-align: center;"><spanclass="math inline">\(11blsd+5bls^2n\)</span></td></tr><tr><td style="text-align: center;">MLP</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(19bsd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(19blsd\)</span></td></tr><tr><td style="text-align: center;">LayerNorm</td><td style="text-align: center;">2l</td><td style="text-align: center;"><spanclass="math inline">\(2bsd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(4blsd\)</span></td></tr></tbody></table><p>ä¸­é—´æ¿€æ´»å€¼æ€»æ˜¾å­˜å ç”¨ï¼š<spanclass="math inline">\(34blsd+5bls^2n\)</span> bytes</p><h3 id="ä¸­é—´æ¿€æ´»å€¼å’Œæ¨¡å‹å‚æ•°çš„å…³ç³»">4.1 ä¸­é—´æ¿€æ´»å€¼å’Œæ¨¡å‹å‚æ•°çš„å…³ç³»</h3><p>ä¸€æ¬¡è®­ç»ƒä¸­ï¼Œå ç”¨æ˜¾å­˜çš„å››å¤§éƒ¨åˆ†ä¸­ï¼Œæ¨¡å‹å‚æ•°ã€æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€çš„æ˜¾å­˜å ç”¨æ˜¯ä¸æ¨¡å‹å‚æ•°é‡æˆæ­£æ¯”çš„ï¼Œä¸è¾“å…¥æ•°æ®é‡æ— å…³ï¼›è€Œ<strong>ä¸­é—´æ¿€æ´»å€¼çš„æ˜¾å­˜å ç”¨æ˜¯ä¸è¾“å…¥æ•°æ®é‡ï¼ˆæ‰¹æ¬¡å¤§å°bå’Œåºåˆ—é•¿åº¦sï¼‰æˆæ­£ç›¸å…³çš„</strong>ã€‚æ‰€ä»¥å½“è®­ç»ƒæ—¶å‡ºç°æ˜¾å­˜ä¸è¶³çš„æƒ…å†µæ—¶ï¼Œå¯ä»¥é€šè¿‡å‡å°‘batch_sizeæ¥å‡å°‘ä¸­é—´æ¿€æ´»å€¼çš„æ˜¾å­˜å ç”¨ã€‚</p><p>éšç€æ‰¹æ¬¡å¤§å° bçš„å¢å¤§ï¼Œä¸­é—´æ¿€æ´»å ç”¨çš„æ˜¾å­˜è¿œè¿œè¶…è¿‡äº†æ¨¡å‹å‚æ•°æ˜¾å­˜ã€‚é€šå¸¸ä¼šé‡‡ç”¨æ¿€æ´»é‡è®¡ç®—æŠ€æœ¯æ¥å‡å°‘ä¸­é—´æ¿€æ´»ï¼Œç†è®ºä¸Šå¯ä»¥å°†ä¸­é—´æ¿€æ´»æ˜¾å­˜ä»<spanclass="math inline">\(O(n)\)</span>é™ä½åˆ°<spanclass="math inline">\(O(\sqrt{n})\)</span>(æ¯<spanclass="math inline">\(\sqrt{n}\)</span>å±‚å­˜å‚¨ä¸€ä¸ªæ£€æŸ¥ç‚¹)ã€‚</p><p>æ¿€æ´»é‡è®¡ç®—æœ¬è´¨æ˜¯<strong>æ—¶é—´æ¢ç©ºé—´</strong>ï¼Œé€šè¿‡åœ¨åå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—éƒ¨åˆ†æ¿€æ´»å€¼ï¼Œè€Œä¸æ˜¯åœ¨å‰å‘ä¼ æ’­æ—¶å­˜å‚¨æ‰€æœ‰æ¿€æ´»å€¼ï¼Œä»è€Œæ˜¾è‘—å‡å°‘å†…å­˜ä½¿ç”¨ã€‚</p><ol type="1"><li>å‰å‘ä¼ æ’­é˜¶æ®µï¼šåœ¨å‰å‘ä¼ æ’­ä¸­ï¼Œä¸å­˜å‚¨æ‰€æœ‰å±‚çš„æ¿€æ´»å€¼ã€‚ä»…å­˜å‚¨ä¸€äº›å…³é”®çš„æ£€æŸ¥ç‚¹ï¼ˆcheckpointsï¼‰ï¼Œå³åœ¨è‹¥å¹²å±‚ä¹‹åä¿å­˜ä¸€æ¬¡æ¿€æ´»å€¼ã€‚</li><li>åå‘ä¼ æ’­é˜¶æ®µï¼šå½“éœ€è¦è®¡ç®—æ¢¯åº¦æ—¶ï¼Œé‡æ–°è®¡ç®—æœªå­˜å‚¨çš„æ¿€æ´»å€¼ã€‚è¿™æ„å‘³ç€åœ¨åå‘ä¼ æ’­é˜¶æ®µéœ€è¦é‡æ–°æ‰§è¡Œä¸€éƒ¨åˆ†å‰å‘ä¼ æ’­è®¡ç®—ã€‚</li><li>å†…å­˜ä¸è®¡ç®—çš„æƒè¡¡ï¼šé€šè¿‡å‡å°‘æ¿€æ´»å€¼çš„å­˜å‚¨æ¥èŠ‚çœå†…å­˜ï¼Œä½†ä»£ä»·æ˜¯å¢åŠ äº†è®¡ç®—å¼€é”€ï¼Œå› ä¸ºéœ€è¦é‡æ–°è®¡ç®—æ¿€æ´»å€¼ã€‚</li></ol><p><img src="./images/vanilla-backprop.webp#50x50"title="å›¾1: åŸä¸­é—´æ¿€æ´»è®¡ç®—" alt="åŸä¸­é—´æ¿€æ´»è®¡ç®—" /> <imgsrc="./images/checkpointed-backprop.webp#50x50" title="å›¾2: æ¿€æ´»é‡è®¡ç®—"alt="æ¿€æ´»é‡è®¡ç®—" /></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¾®è°ƒ(Fine-Tuning)</title>
      <link href="/2024/08/08/NLP/FineTuning/"/>
      <url>/2024/08/08/NLP/FineTuning/</url>
      
        <content type="html"><![CDATA[<h1 id="å¾®è°ƒfine-tuning">å¾®è°ƒ(Fine-Tuning)</h1><h2 id="å¼€æºåŸºåº§æ¨¡å‹">1 å¼€æºåŸºåº§æ¨¡å‹</h2><p>å¤§è¯­è¨€æ¨¡å‹çš„è®­ç»ƒåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šï¼ˆ1ï¼‰åœ¨æµ·é‡æ–‡æœ¬è¯­æ–™ä¸Šçš„æ— ç›‘ç£é¢„è®­ç»ƒï¼Œå­¦ä¹ é€šç”¨çš„è¯­ä¹‰è¡¨ç¤ºå’Œä¸–ç•ŒçŸ¥è¯†ã€‚ï¼ˆ2ï¼‰åœ¨å°è§„æ¨¡æ•°æ®ä¸Šï¼Œè¿›è¡ŒæŒ‡ä»¤å¾®è°ƒå’ŒåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ ï¼Œæ›´å¥½åœ°å¯¹é½æœ€ç»ˆä»»åŠ¡å’Œäººç±»åå¥½ã€‚å‡ ä¹æ‰€æœ‰çŸ¥è¯†éƒ½æ˜¯åœ¨é¢„è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ åˆ°çš„ï¼Œåªéœ€è¦æœ‰é™çš„æŒ‡ä»¤å¾®è°ƒæ•°æ®å°±å¯ä»¥ç”Ÿæˆé«˜è´¨é‡çš„å›å¤ã€‚å› æ­¤ï¼ŒåŸºåº§æ¨¡å‹çš„æ€§èƒ½æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¦‚æœåŸºåº§æ¨¡å‹çš„æ€§èƒ½ä¸å¤Ÿå¥½ï¼ŒæŒ‡ä»¤å¾®è°ƒå’Œå¼ºåŒ–å­¦ä¹ ä¹Ÿéš¾ä»¥å–å¾—å¾ˆå¥½çš„æ•ˆæœã€‚</p><p>ä¸»æµçš„å¼€æºå¤§è¯­è¨€æ¨¡å‹ä¸»è¦æœ‰ä¸‰ä¸ªï¼šLLaMAã€ChatGLMå’ŒBLOOMã€‚</p><table><thead><tr><th>æ¨¡å‹</th><th>æ¨¡å‹ç»“æ„</th><th>ä½ç½®ç¼–ç </th><th>æ¿€æ´»å‡½æ•°</th><th>layer norm</th></tr></thead><tbody><tr><td>LLaMA</td><td>Casual decoder</td><td>RoPE</td><td>SwiGLU</td><td>Pre RMS Norm</td></tr><tr><td>ChatGLM-6B</td><td>Prefix decoder</td><td>RoPE</td><td>GeGLU</td><td>Post Deep Norm</td></tr><tr><td>Bloom</td><td>Casual decoder</td><td>ALiBi</td><td>GeLU</td><td>Pre Layer Norm</td></tr></tbody></table><h3 id="æ¨¡å‹å¯¹æ¯”">æ¨¡å‹å¯¹æ¯”</h3><h4 id="è¯è¡¨æ‰©å……">1) è¯è¡¨æ‰©å……</h4><p>LLaMAåŸæ¨¡å‹çš„è¯è¡¨å¤§å°æ˜¯32000ï¼Œtokenizerä¸»è¦æ˜¯åœ¨è‹±æ–‡è¯­æ–™ä¸Šè¿›è¡Œè®­ç»ƒçš„ï¼Œåœ¨ä¸­æ–‡ä¸Šå’Œå¤šè¯­ç§ä¸Šæ•ˆæœæ¯”è¾ƒå·®ã€‚</p><ol type="1"><li>LLaMAæ¨¡å‹æ˜¯åœ¨ä»¥è‹±æ–‡ä¸ºä¸»çš„æ‹‰ä¸è¯­ç³»è¯­æ–™ä¸Šè¿›è¡Œè®­ç»ƒçš„ï¼Œè®­ç»ƒè¯­æ–™ä¸åŒ…å«ä¸­æ–‡ï¼›</li><li>ä¸tokenizeræœ‰å…³ï¼Œè¯è¡¨è§„æ¨¡å°ï¼Œå¯èƒ½å°†ä¸€ä¸ªæ±‰å­—åˆ‡åˆ†ä¸ºå¤šä¸ªtokenï¼Œç¼–ç æ•ˆç‡ä½ï¼Œæ¨¡å‹å­¦ä¹ éš¾åº¦å¤§ã€‚</li></ol><p>æ‰©å±•ä¸­æ–‡è¯è¡¨åï¼Œå•ä¸ªæ±‰å­—å€¾å‘äºè¢«åˆ‡åˆ†ä¸º1ä¸ªtokenï¼Œé¿å…äº†ä¸€ä¸ªæ±‰å­—è¢«åˆ‡åˆ†ä¸ºå¤šä¸ªtokençš„é—®é¢˜ï¼Œæå‡äº†ä¸­æ–‡ç¼–ç æ•ˆç‡ã€‚</p><ol type="1"><li>åœ¨ä¸­æ–‡è¯­æ–™ä¸Šä½¿ç”¨Sentence Pieceè®­ç»ƒä¸€ä¸ªä¸­æ–‡tokenizerã€‚</li><li>å°†ä¸­æ–‡tokenizerä¸åŸå§‹çš„ LLaMAtokenizeråˆå¹¶èµ·æ¥ï¼Œé€šè¿‡ç»„åˆäºŒè€…çš„è¯æ±‡è¡¨ï¼Œæœ€ç»ˆè·å¾—ä¸€ä¸ªåˆå¹¶çš„tokenizerï¼Œç§°ä¸ºChineseLLaMA tokenizerã€‚</li><li>ä¸ºäº†é€‚åº”æ–°çš„tokenizerï¼Œå°†transformeræ¨¡å‹çš„embeddingçŸ©é˜µä»<spanclass="math inline">\(V \times h\)</span> æ‰©å±•åˆ° <spanclass="math inline">\(V&#39; \timesh\)</span>ï¼Œæ–°åŠ å…¥çš„ä¸­æ–‡tokené™„åŠ åˆ°åŸå§‹embeddingçŸ©é˜µçš„æœ«å°¾ï¼Œç¡®ä¿åŸå§‹è¯è¡¨è¡¨çš„embeddingçŸ©é˜µä¸å—å½±å“ã€‚</li><li>åœ¨ä¸­æ–‡è¯­æ–™ä¸Šè¿›ä¸€æ­¥é¢„è®­ç»ƒï¼Œå†»ç»“å’Œå›ºå®štransformerçš„æ¨¡å‹å‚æ•°ï¼Œåªè®­ç»ƒembeddingçŸ©é˜µï¼Œå­¦ä¹ æ–°åŠ å…¥ä¸­æ–‡tokençš„è¯å‘é‡è¡¨ç¤ºï¼ŒåŒæ—¶æœ€å°åŒ–å¯¹åŸæ¨¡å‹çš„å¹²æ‰°ã€‚</li><li>åœ¨æŒ‡ä»¤å¾®è°ƒé˜¶æ®µï¼Œå¯ä»¥æ”¾å¼€å…¨éƒ¨æ¨¡å‹å‚æ•°è¿›è¡Œè®­ç»ƒã€‚</li></ol><h4 id="æ¨¡å‹ç»“æ„">2) æ¨¡å‹ç»“æ„</h4><p>ä¸»æµæ¨¡å‹éƒ½é‡‡ç”¨decoder-onlyç»“æ„ï¼Œå…¶ä¸­LLaMAå’ŒBLOOMé‡‡ç”¨äº†casualdecoderï¼ŒChatGLMé‡‡ç”¨äº†prefix decoderã€‚</p><figure><img src="./images/Model_Structure.webp" title="å›¾1ï¼šæ¨¡å‹ç»“æ„"alt="æ¨¡å‹ç»“æ„" /><figcaption aria-hidden="true">æ¨¡å‹ç»“æ„</figcaption></figure><ol type="1"><li>casualdecoderï¼šé‡‡ç”¨<strong>å•å‘æ³¨æ„åŠ›</strong>æ©ç ï¼Œä»¥ç¡®ä¿æ¯ä¸ªè¾“å…¥æ ‡è®°åªèƒ½å…³æ³¨è¿‡å»çš„æ ‡è®°å’Œå®ƒæœ¬èº«ã€‚</li><li>prefixdecoderï¼šå¯¹å‰ç¼€æ ‡è®°æ‰§è¡Œ<strong>åŒå‘æ³¨æ„åŠ›</strong>ï¼Œå¹¶ä»…å¯¹ç”Ÿæˆçš„æ ‡è®°æ‰§è¡Œå•å‘æ³¨æ„åŠ›ã€‚è¿™æ ·ï¼Œä¸encoder-decoderç±»ä¼¼ï¼Œå¯ä»¥åŒå‘ç¼–ç å‰ç¼€åºåˆ—å¹¶è‡ªå›å½’çš„é€ä¸ªé¢„æµ‹è¾“å‡ºæ ‡è®°ï¼Œå…¶ä¸­åœ¨ç¼–ç å’Œè§£ç é˜¶æ®µå…±äº«ç›¸åŒçš„å‚æ•°ã€‚</li><li>attention maskä¸åŒï¼Œprefix LMçš„prefixéƒ¨åˆ†çš„tokenäº’ç›¸èƒ½çœ‹åˆ°ï¼ŒcausalLMä¸¥æ ¼éµå®ˆåªæœ‰åé¢çš„tokenæ‰èƒ½çœ‹åˆ°å‰é¢çš„tokençš„è§„åˆ™ã€‚</li><li>prefix decoder-onlyç»“æ„çš„ChatGLMå­˜åœ¨ä¸€ä¸ªåŠ£åŠ¿ï¼šè®­ç»ƒæ•ˆç‡ä½ã€‚causaldecoderç»“æ„ä¼šåœ¨æ‰€æœ‰çš„tokenä¸Šè®¡ç®—æŸå¤±ï¼Œè€Œprefixdecoderåªä¼šåœ¨è¾“å‡ºä¸Šè®¡ç®—æŸå¤±ï¼Œè€Œä¸è®¡ç®—è¾“å…¥ä¸Šçš„æŸå¤±ã€‚åœ¨æœ‰ç›¸åŒæ•°é‡çš„è®­ç»ƒtokensçš„æƒ…å†µä¸‹ï¼Œprefixdecoderè¦æ¯”causaldecoderçš„æ•ˆæœå·®ï¼Œå› ä¸ºè®­ç»ƒè¿‡ç¨‹ä¸­å®é™…ç”¨åˆ°çš„tokensæ•°é‡è¦æ›´å°‘ã€‚</li></ol><p><strong>æ³¨</strong>ï¼šChatGPTçš„æˆåŠŸå·²ç»è¯æ˜äº†causaldecoderç»“æ„çš„å¤§è¯­è¨€æ¨¡å‹å¯ä»¥è·å¾—éå¸¸å¥½çš„few-shotå’Œzero-shotç”Ÿæˆèƒ½åŠ›ï¼Œé€šè¿‡æŒ‡ä»¤å¾®è°ƒå¯ä»¥è¿›ä¸€æ­¥æ¿€å‘æ¨¡å‹çš„èƒ½åŠ›ã€‚è‡³äºprefixdecoderç»“æ„çš„å¤§è¯­è¨€æ¨¡å‹èƒ½å¦è·å¾—ç›¸å½“çš„few-shotå’Œzero-shotèƒ½åŠ›è¿˜ç¼ºå°‘è¶³å¤Ÿçš„éªŒè¯ã€‚(1)zero-shotï¼šè®­ç»ƒé›†ä¸­æ²¡æœ‰æŸä¸ªç±»åˆ«çš„æ ·æœ¬ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯ä»¥å­¦åˆ°ä¸€ä¸ªæ˜ å°„ï¼Œè¿™ä¸ªæ˜ å°„å¥½åˆ°å³ä½¿åœ¨è®­ç»ƒçš„æ—¶å€™æ²¡çœ‹åˆ°è¿™ä¸ªç±»ï¼Œä½†æ˜¯åœ¨é‡åˆ°çš„æ—¶å€™ä¾ç„¶èƒ½é€šè¿‡è¿™ä¸ªæ˜ å°„å¾—åˆ°è¿™ä¸ªæ–°ç±»çš„ç‰¹å¾ã€‚(2)one-shotï¼šæ¨¡å‹åœ¨åªè§è¿‡ä¸€ä¸ªè®­ç»ƒæ ·æœ¬çš„æƒ…å†µä¸‹ï¼Œå­¦ä¹ å¹¶å®Œæˆæ–°çš„ä»»åŠ¡ã€‚å¸¸è§äºå›¾åƒè¯†åˆ«é¢†åŸŸã€‚(3)few-shotï¼šæ¨¡å‹åœ¨è§è¿‡å°‘é‡ï¼ˆé€šå¸¸æ˜¯å‡ ä¸ªåˆ°å‡ åä¸ªï¼‰è®­ç»ƒæ ·æœ¬çš„æƒ…å†µä¸‹ï¼Œå­¦ä¹ å¹¶å®Œæˆæ–°çš„ä»»åŠ¡ã€‚</p><p><strong>Why decoder-onlyï¼Ÿ</strong></p><p>Encoderåœ¨æŠ½å–åºåˆ—ä¸­æŸä¸€ä¸ªè¯çš„ç‰¹å¾æ—¶èƒ½å¤Ÿçœ‹åˆ°æ•´ä¸ªåºåˆ—ä¸­æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå³ä¸Šæ–‡å’Œä¸‹æ–‡åŒæ—¶çœ‹åˆ°ã€‚ä¸»è¦ä½œç”¨æ˜¯ä»è¾“å…¥åºåˆ—ä¸­æŠ½å–ç‰¹å¾ï¼Œå½¢æˆä¸€ä¸ªè¡¨ç¤ºåºåˆ—çš„ä¸Šä¸‹æ–‡å‘é‡ï¼›Decoder ä¸­å› ä¸ºæœ‰ maskæœºåˆ¶çš„å­˜åœ¨ï¼Œä½¿å¾—å®ƒåœ¨ç¼–ç æŸä¸€ä¸ªè¯çš„ç‰¹å¾æ—¶åªèƒ½çœ‹åˆ°è‡ªèº«å’Œå®ƒä¹‹å‰çš„æ–‡æœ¬ä¿¡æ¯ã€‚ä¸»è¦ä½œç”¨æ˜¯æ ¹æ®Encoderç”Ÿæˆçš„ä¸Šä¸‹æ–‡å‘é‡å’Œä¹‹å‰å·²ç»ç”Ÿæˆçš„è¯ï¼Œé€æ­¥ç”Ÿæˆç›®æ ‡åºåˆ—ä¸­çš„æ¯ä¸ªè¯ã€‚</p><ol type="1"><li>ç”¨è¿‡å»ç ”ç©¶çš„ç»éªŒè¯´è¯ï¼Œdecoder-onlyçš„æ³›åŒ–æ€§èƒ½æ›´å¥½</li><li>decoder-onlyæ”¯æŒä¸€ç›´å¤ç”¨KV-Cacheï¼Œå¯¹å¤šè½®å¯¹è¯æ›´å‹å¥½</li><li>é¢„è®­ç»ƒä»»åŠ¡éš¾åº¦é—®é¢˜ï¼Œçº¯ç²¹çš„decoder-onlyæ¶æ„+next tokenpredicitioné¢„è®­ç»ƒï¼Œæ¯ä¸ªä½ç½®æ‰€èƒ½æ¥è§¦çš„ä¿¡æ¯æ¯”å…¶ä»–æ¶æ„å°‘ï¼Œè¦é¢„æµ‹ä¸‹ä¸€ä¸ªtokenéš¾åº¦æ›´é«˜ï¼Œå½“æ¨¡å‹è¶³å¤Ÿå¤§ï¼Œæ•°æ®è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼Œdecoder-onlyæ¨¡å‹å­¦ä¹ é€šç”¨è¡¨å¾çš„ä¸Šé™æ›´é«˜</li><li>åŒå‘attentionçš„æ³¨æ„åŠ›çŸ©é˜µå®¹æ˜“é€€åŒ–ä¸ºä½ç§©çŠ¶æ€ï¼Œè€Œcausalattentionçš„æ³¨æ„åŠ›çŸ©é˜µæ˜¯ä¸‹ä¸‰è§’çŸ©é˜µï¼Œå¿…ç„¶æ˜¯æ»¡ç§©çš„ï¼Œå»ºæ¨¡èƒ½åŠ›æ›´å¼ºï¼›</li><li>causalattentionå…·æœ‰éšå¼çš„ä½ç½®ç¼–ç åŠŸèƒ½ï¼Œæ‰“ç ´äº†transformerçš„ä½ç½®ä¸å˜æ€§ï¼Œè€Œå¸¦æœ‰åŒå‘attentionçš„æ¨¡å‹ï¼Œå¦‚æœä¸å¸¦ä½ç½®ç¼–ç ï¼ŒåŒå‘attentionçš„éƒ¨åˆ†tokenå¯ä»¥å¯¹æ¢ä¹Ÿä¸æ”¹å˜è¡¨ç¤ºï¼Œå¯¹è¯­åºçš„åŒºåˆ†èƒ½åŠ›å¤©ç”Ÿè¾ƒå¼±ã€‚</li><li>Encoder-Decoderæ¶æ„ä¹‹æ‰€ä»¥èƒ½å¤Ÿåœ¨æŸäº›åœºæ™¯ä¸‹è¡¨ç°æ›´å¥½ï¼Œå¤§æ¦‚åªæ˜¯å› ä¸ºå®ƒå¤šäº†ä¸€å€å‚æ•°ã€‚</li></ol><h4 id="layer-normalization">3) Layer Normalization</h4><p>åœ¨ç»Ÿè®¡å­¦ä¸­ï¼Œåå˜é‡åç§»æŒ‡çš„æ˜¯æºåŸŸï¼ˆSï¼‰å’Œç›®æ ‡åŸŸï¼ˆTï¼‰è¾¹ç¼˜åˆ†å¸ƒçš„ä¸ä¸€è‡´ï¼Œä½†æ˜¯å®ƒä»¬çš„æ¡ä»¶åˆ†å¸ƒå´æ˜¯ç›¸åŒçš„ã€‚å¯¹äºæ·±åº¦å­¦ä¹ æ¥è¯´ï¼ŒæŒ‡çš„æ˜¯è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„è¾“å…¥ç‰¹å¾åˆ†å¸ƒä¸åŒï¼ˆä¾‹å¦‚è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®æ‹æ‘„æ¡ä»¶ä¸åŒï¼‰ï¼Œä½†åœ¨ç»™å®šç‰¹å¾æ—¶ï¼Œè¾“å‡ºçš„åˆ†å¸ƒæ˜¯ä¸€è‡´çš„ã€‚</p><ol type="1"><li>ç”¨è®­ç»ƒé›†å¾—åˆ°çš„æ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šåšæ€§èƒ½è¯„ä¼°ï¼Œå¾—åˆ°çš„ä¸æ˜¯æ¨¡å‹çš„çœŸå®æ°´å¹³</li><li>è®­ç»ƒé›†å’Œæµ‹è¯•é›†åˆ†å¸ƒå·®å¼‚è¿‡å¤§ï¼Œæˆ‘ä»¬è®­ç»ƒå¾—åˆ°çš„ä¸æ˜¯çœŸå®æ¨¡å‹</li></ol><p>å› æ­¤åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬æœŸæœ›æ•°æ®æ˜¯<strong>ç‹¬ç«‹åŒåˆ†å¸ƒ</strong>çš„ï¼Œè¿™è¦æ±‚è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„æ ·æœ¬éƒ½æ˜¯ä»åŒä¸€ä¸ªåˆ†å¸ƒç‹¬ç«‹é‡‡æ ·è€Œæ¥ã€‚ä½†æ˜¯åœ¨æ·±å±‚ç¥ç»ç½‘ç»œçš„è®­ç»ƒä¸­ï¼Œå½“ä¸­é—´ç¥ç»å±‚çš„å‰ä¸€å±‚å‚æ•°å‘ç”Ÿæ”¹å˜æ—¶ï¼Œè¯¥å±‚çš„è¾“å…¥åˆ†å¸ƒä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨å†…éƒ¨åå˜é‡åç§»ICSé—®é¢˜ã€‚ä¸­é—´çš„ç¥ç»å±‚éœ€è¦ä¸æ–­é€‚åº”è¿™ç§å˜åŒ–ï¼Œè¿™ä¼šé™ä½æ•´ä¸ªç½‘ç»œçš„æ”¶æ•›é€Ÿåº¦ã€‚</p><p>å¯ä»¥é€šè¿‡å›ºå®šæ¯ä¸€å±‚ç½‘ç»œçš„è¾“å…¥å€¼åˆ†å¸ƒæ¥å‡ç¼“ICSé—®é¢˜:</p><ol type="1"><li>ç™½åŒ–ï¼šé€šè¿‡è°ƒæ•´è¾“å…¥æ•°æ®çš„åˆ†å¸ƒæ¥å‡å°‘åå˜é‡åç§»çš„å½±å“ï¼Œæ¯”å¦‚PCAã€‚å³æ ‡å‡†æ­£æ€åˆ†å¸ƒ+å»é™¤ç›¸å…³æ€§(åæ–¹å·®çŸ©é˜µå¥‡å¼‚å€¼åˆ†è§£)ã€‚1ï¼‰ç™½åŒ–è¿‡ç¨‹è®¡ç®—æˆæœ¬å¤ªé«˜ï¼Œå¦‚PCAä¸­éœ€è¦è®¡ç®—åæ–¹å·®çŸ©é˜µï¼Œå¹¶åœ¨æ¯ä¸€è½®è®­ç»ƒçš„æ¯ä¸€å±‚éƒ½æ‰§è¡Œè¯¥è¿ç®—ï¼›2ï¼‰ç™½åŒ–è¿‡ç¨‹æ”¹å˜äº†ç½‘ç»œä¸­æ¯ä¸€å±‚çš„åˆ†å¸ƒï¼Œå› æ­¤æ”¹å˜äº†ç½‘ç»œå±‚ä¸­æœ¬èº«æ•°æ®çš„è¡¨è¾¾èƒ½åŠ›ï¼Œåº•å±‚ç½‘ç»œå­¦ä¹ åˆ°çš„å‚æ•°ä¿¡æ¯ä¼šè¢«ç™½åŒ–æ“ä½œä¸¢å¤±ã€‚</li><li>å½’ä¸€åŒ–ï¼šä½¿å¾—æ ·æœ¬å¤„äºåŒä¸€åˆ†å¸ƒï¼Œä¸”å¯ä»¥è§£å†³æ¯æ‰¹è®­ç»ƒæ•°æ®åˆ†å¸ƒä¸åŒçš„é—®é¢˜ï¼Œè€Œä¸”NormalizationåŒ…å«çº¿æ€§å˜æ¢æ“ä½œï¼Œå¯ä»¥è®©æ•°æ®å°½å¯èƒ½æ¢å¤æœ¬èº«çš„è¡¨è¾¾èƒ½åŠ›ã€‚å³è½¬æ¢ä¸ºå‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1çš„æ ‡å‡†æ­£æ€åˆ†å¸ƒã€‚ä¸»è¦æ“ä½œæœ‰ï¼šå»å‡å€¼ã€é™¤ä»¥æ ‡å‡†å·®ã€çº¿æ€§å˜æ¢(ç¼©æ”¾å’Œå¹³ç§»)ã€‚</li></ol><p>å¸¸ç”¨çš„Normalizationæ–¹æ³•æœ‰Batch Normalizationã€LayerNormalizationã€Instance Normalizationã€GroupNormalizationç­‰ã€‚ä¸»è¦åŒºåˆ«åœ¨äºæ“ä½œçš„ç‰¹å¾ç»´åº¦ä¸åŒã€‚åŸºæœ¬è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[y = \gamma \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} + \beta\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(\gamma\)</span>å’Œ<spanclass="math inline">\(\beta\)</span>æ˜¯å¯å­¦ä¹ çš„å‚æ•°ï¼Œ<spanclass="math inline">\(\mu\)</span>å’Œ<spanclass="math inline">\(\sigma\)</span>æ˜¯å‡å€¼å’Œæ–¹å·®ï¼Œ<spanclass="math inline">\(\epsilon\)</span>æ˜¯ä¸€ä¸ªå¾ˆå°çš„æ•°ï¼Œé˜²æ­¢åˆ†æ¯ä¸º0ã€‚</p><p>å‡å®šè¾“å…¥æ•°æ®çš„ç»´åº¦æ˜¯<span class="math inline">\((N, C, H,W)\)</span>ï¼Œå…¶ä¸­<span class="math inline">\(N\)</span>æ˜¯batchsizeï¼Œ<span class="math inline">\(C\)</span>æ˜¯é€šé“æ•°ï¼Œ<spanclass="math inline">\(H\)</span>å’Œ<spanclass="math inline">\(W\)</span>æ˜¯é«˜å’Œå®½ã€‚ <strong>BatchNormalizationï¼šå¯¹æ•´ä¸ªæ‰¹æ¬¡çš„æ•°æ®è¿›è¡Œå½’ä¸€åŒ–ã€‚</strong> åœ¨<spanclass="math inline">\(N H W\)</span>ç»´åº¦ä¸Šæ±‚å‡å€¼å’Œæ–¹å·®ï¼Œä¿ç•™<spanclass="math inline">\(C\)</span>ç»´åº¦ï¼Œå¯¹æ¯ä¸ªé€šé“è¿›è¡Œå½’ä¸€åŒ–ã€‚</p><p><span class="math display">\[\mu_c = \frac{1}{NHW} \sum_{n=1}^{N} \sum_{h=1}^{H} \sum_{w=1}^{W}x_{nchw}\\\sigma_c^2 = \frac{1}{NHW} \sum_{n=1}^{N} \sum_{h=1}^{H} \sum_{w=1}^{W}(x_{nchw} - \mu_c)^2 + \epsilon\\\]</span></p><p><strong>LayerNormalizationï¼šå¯¹å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–ã€‚</strong> åœ¨<spanclass="math inline">\(C H W\)</span>ç»´åº¦ä¸Šæ±‚å‡å€¼å’Œæ–¹å·®ï¼Œä¿ç•™<spanclass="math inline">\(N\)</span>ç»´åº¦ã€‚</p><p><span class="math display">\[\mu_{n} = \frac{1}{CWH} \sum_{c=1}^{C} \sum_{h=1}^{H} \sum_{w=1}^{W}x_{nchw}\\\sigma_{n}^2 = \frac{1}{CWH} \sum_{c=1}^{C} \sum_{h=1}^{H}\sum_{w=1}^{W} (x_{nchw} - \mu_n)^2 + \epsilon\\\]</span></p><p><strong>InstanceNormalizationï¼šå¯¹æ¯ä¸ªæ ·æœ¬çš„æ¯ä¸ªé€šé“ç‹¬ç«‹è¿›è¡Œå½’ä¸€åŒ–ã€‚</strong> åœ¨<spanclass="math inline">\(H W\)</span>ç»´åº¦ä¸Šæ±‚å‡å€¼å’Œæ–¹å·®ï¼Œä¿ç•™<spanclass="math inline">\(N C\)</span>ç»´åº¦ã€‚åœ¨channelå†…éƒ¨æ±‚å‡å€¼å’Œæ ‡å‡†å·®</p><p><span class="math display">\[\mu_{nc} = \frac{1}{HW} \sum_{h=1}^{H} \sum_{w=1}^{W} x_{nchw}\\\sigma_{nc}^2 = \frac{1}{HW} \sum_{h=1}^{H} \sum_{w=1}^{W} (x_{nchw} -\mu_{nc})^2 + \epsilon\\\]</span></p><p><strong>GroupNormalizationï¼šå¯¹æ¯ä¸ªæ ·æœ¬çš„ç‰¹å®šç»„åˆ«çš„ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–ã€‚</strong>å°†é€šé“åˆ†ä¸ºè‹¥å¹²ç»„ï¼Œæ¯ç»„è¿›è¡Œå½’ä¸€åŒ–ã€‚å„ç»„channelç”¨å…¶å¯¹åº”çš„å½’ä¸€åŒ–å‚æ•°ç‹¬ç«‹åœ°å½’ä¸€åŒ–ã€‚</p><p><span class="math display">\[\mu_{ng} = \frac{1}{(C/G)HW} \sum_{c=1}^{C/G} \sum_{h=1}^{H}\sum_{w=1}^{W} x_{nchw}\\\sigma_{ng}^2 = \frac{1}{(C/G)HW} \sum_{c=1}^{C/G} \sum_{h=1}^{H}\sum_{w=1}^{W} (x_{nchw} - \mu_{ng})^2 + \epsilon\\\]</span></p><p><strong>æ€»ç»“</strong>ï¼š</p><ol type="1"><li>Batch Normalizationï¼šé€‚ç”¨äºCVé¢†åŸŸ<ol type="1"><li>å¤„ç†åºåˆ—æ•°æ®æ—¶è¡¨ç°å·®ï¼Œå› ä¸ºåºåˆ—æ•°æ®çš„ç»´åº¦æ˜¯å˜åŒ–çš„ï¼Œè€ŒBNæ˜¯åœ¨å›ºå®šç»´åº¦ä¸Šè¿›è¡Œå½’ä¸€åŒ–çš„ï¼Œå› æ­¤ä¸é€‚ç”¨äºRNNã€LSTMç­‰åºåˆ—æ¨¡å‹ã€‚</li><li>å°batch sizeæ—¶æ•ˆæœå·®ï¼Œå› ä¸ºæ¯ä¸ªbatchçš„ç»Ÿè®¡ç‰¹æ€§ä¼šæœ‰è¾ƒå¤§æ³¢åŠ¨</li></ol></li><li>Layer Normalizationï¼šé€‚ç”¨äºRNNã€LSTMç­‰åºåˆ—æ¨¡å‹<ol type="1"><li>é€‚ç”¨äºåºåˆ—æ•°æ®ï¼Œå› ä¸ºLNæ˜¯åœ¨æ¯ä¸ªæ ·æœ¬ä¸Šè¿›è¡Œå½’ä¸€åŒ–çš„ï¼Œä¸å—batchsizeå½±å“</li><li>é€‚ç”¨äºåºåˆ—æ•°æ®ï¼Œå› ä¸ºLNæ˜¯åœ¨åºåˆ—é•¿åº¦ä¸Šå¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œå½’ä¸€åŒ–</li><li>å¯¹å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾è¿›è¡Œç»Ÿä¸€å½’ä¸€åŒ–å¤„ç†ï¼Œå¦‚æœè¿™äº›ç‰¹å¾æ¥è‡ªä¸åŒçš„ç±»åˆ«æˆ–å…·æœ‰ä¸åŒçš„æ€§è´¨ï¼Œå¯èƒ½ä¼šé™ä½æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚</li><li>ä¸é€‚åº”è¾“å…¥å˜åŒ–å¾ˆå¤§çš„æ•°æ®</li></ol></li><li>Instance Normalizationï¼šå›¾åƒçš„é£æ ¼è¿ç§»<ol type="1"><li>å¯¹æ¯ä¸ªæ ·æœ¬çš„æ¯ä¸ªç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–ï¼Œå› æ­¤å®ƒå¯ä»¥æ•æ‰åˆ°æ›´å¤šçš„ç»†èŠ‚ä¿¡æ¯</li><li>å¯èƒ½ä¼šè¿‡åº¦å¼ºè°ƒç»†èŠ‚ä¿¡æ¯ï¼Œå¿½è§†äº†æ›´å®è§‚çš„ä¿¡æ¯</li><li>è®¡ç®—æˆæœ¬è¾ƒé«˜ï¼Œè®¡ç®—æˆæœ¬æ¯”BNå’ŒLNè¦é«˜</li><li>ä¸é€‚åº”é€šé“ä¹‹é—´çš„ç›¸å…³æ€§è¾ƒå¼ºæ•°æ®</li></ol></li><li>Group Normalizationï¼šé€‚ç”¨äºå ç”¨æ˜¾å­˜æ¯”è¾ƒå¤§çš„ä»»åŠ¡ï¼Œå¦‚å›¾åƒåˆ†å‰²<ol type="1"><li>æ—¢å¯ä»¥æ•è·åˆ°Batchçš„ç»Ÿè®¡ç‰¹æ€§ï¼Œåˆå¯ä»¥æ•è·åˆ°æ ·æœ¬çš„ç»†èŠ‚ä¿¡æ¯ï¼Œæ˜¯BNå’ŒINçš„æŠ˜ä¸­æ–¹æ¡ˆ</li><li>å¯¹Batch sizeä¸æ•æ„Ÿ</li><li>æ€§èƒ½å–å†³äºç»„çš„å¤§å°ï¼Œè®¡ç®—æˆæœ¬æ¯”BNå’ŒLNè¦é«˜</li></ol></li></ol><p>LLMé‡‡ç”¨Layer Normalizationï¼Œè€Œåˆå¯ä»¥ç»†åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><p><strong>æŒ‰æ–¹æ³•åˆ†ç±»ï¼š</strong></p><ol type="1"><li>LayerNormï¼šå¯¹å•ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–(æ ‡å‡†æ­£æ€åˆ†å¸ƒ+çº¿æ€§å˜æ¢)<span class="math display">\[y = \gamma \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} + \beta\]</span></li><li>RMSNormï¼šé€šè¿‡å®éªŒè¯æ˜re-centeræ“ä½œå¹¶ä¸é‡è¦ï¼Œç§»é™¤äº†LayerNormä¸­çš„å‡å€¼é¡¹ï¼Œå¯ä»¥çœ‹ä½œLayerNormåœ¨å‡å€¼ä¸º0æ—¶çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚(æ— éœ€è®¡ç®—å‡å€¼ï¼Œæé«˜äº†è®­ç»ƒé€Ÿåº¦)<span class="math display">\[y = \gamma \frac{x}{RMS(x)}\\RMS(x) = \sqrt{\frac{1}{d} \sum_{i=1}^{d} x_i^2}\]</span></li><li>DeepNorm:ä¸ä»…ç”¨ä½œæ ‡å‡†åŒ–ï¼Œè¿˜ä½œä¸ºæ®‹å·®è¿æ¥çš„ä¸€éƒ¨åˆ†ï¼Œå°†å‰ä¸€å±‚çš„è¾“å‡ºä¸æ ‡å‡†åŒ–åçš„è¾“å‡ºç›¸åŠ ã€‚å¯ä»¥ç¼“è§£çˆ†ç‚¸å¼æ¨¡å‹æ›´æ–°çš„é—®é¢˜ã€‚<span class="math display">\[x_{l+1}=LN(\alpha x_l + G_l(x_l, \theta_l))\]</span></li></ol><p><strong>æŒ‰ä½ç½®åˆ†ç±»ï¼š</strong></p><figure><img src="./images/LN_Pos.webp"title="å›¾2ï¼šLayer Normalization Position"alt="Layer Normalization Position" /><figcaption aria-hidden="true">Layer Normalization Position</figcaption></figure><ol type="1"><li>Post Layer Normï¼šåœ¨æ¯ä¸ªå­å±‚çš„è¾“å‡ºååº”ç”¨LayerNormã€‚ <strong><spanclass="math inline">\(x_{l+1} = LN(x_l +SubLayer(x_l))\)</span></strong><ol type="1"><li>Post Normç»“æ„çš„æœ€ç»ˆæ•ˆæœæ˜¯è¦å¥½äºPre Normçš„ï¼Œåªä¸è¿‡PostNormè¦è¾¾åˆ°è‡ªå·±çš„æœ€ä¼˜æ•ˆæœï¼Œéœ€è¦åŠ Warmupç­‰è®­ç»ƒæŠ€å·§ï¼Œå¦‚æœå’ŒPreNormç”¨ä¸€æ ·çš„è®­ç»ƒé…ç½®åˆ™æ•ˆæœä¸å¦‚Pre Normã€‚</li><li>ä¸Šé™é«˜äºPre Normï¼Œä½†æ˜¯éœ€è¦æ›´å¤šçš„è®­ç»ƒæŠ€å·§ã€‚</li><li>åœ¨æ·±å±‚çš„æ¢¯åº¦èŒƒå¼é€æ¸å¢å¤§ï¼Œå¯¼è‡´ä½¿ç”¨PostNormçš„æ·±å±‚Transformerå®¹æ˜“å‡ºç°è®­ç»ƒä¸ç¨³å®šçš„é—®é¢˜</li></ol></li><li>Pre Layer Normï¼šåœ¨æ¯ä¸ªå­å±‚çš„è¾“å…¥å‰åº”ç”¨LayerNormã€‚ <strong><spanclass="math inline">\(x_{l+1} = SubLayer(LN(x_l)) +x_l\)</span></strong><ol type="1"><li>åŒä¸€è®¾ç½®ä¸‹ï¼ŒPre Normç»“æ„å¾€å¾€æ›´å®¹æ˜“è®­ç»ƒï¼Œä½†æ˜¯æœ€ç»ˆæ•ˆæœé€šå¸¸ä¸å¦‚PostNorm</li><li>æ— å½¢åœ°å¢åŠ äº†æ¨¡å‹çš„å®½åº¦è€Œé™ä½äº†æ¨¡å‹çš„æ·±åº¦ï¼Œè€Œåœ¨æ·±åº¦å­¦ä¹ ä¸­æ·±åº¦é€šå¸¸æ¯”å®½åº¦æ›´é‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´PreNormçš„æ·±åº¦æœ‰â€œæ°´åˆ†â€ï¼Œä¸€ä¸ªLå±‚çš„Pre Normæ¨¡å‹å…¶å®é™…ç­‰æ•ˆå±‚æ•°ä¸å¦‚Lå±‚çš„PostNormæ¨¡å‹ï¼Œå±‚æ•°å°‘å°±ä¼šå¯¼è‡´æ•ˆæœå˜å·®ã€‚</li><li>ç›¸æ¯”äºPost Normï¼ŒPre Normåœ¨æ·±å±‚çš„æ¢¯åº¦èŒƒå¼è¿‘ä¼¼ç›¸ç­‰ï¼Œæ‰€ä»¥ä½¿ç”¨PreNormçš„æ·±å±‚Transformerè®­ç»ƒæ›´åŠ ç¨³å®š</li></ol></li><li>Sandwich Normï¼šç»“åˆäº†Pre Normå’ŒPostNormçš„ä¼˜ç‚¹ï¼ŒåŒæ—¶åœ¨è¾“å…¥å‰å’Œè¾“å‡ºååº”ç”¨LayerNormã€‚ <strong><spanclass="math inline">\(x_{l+1} = x_l +LN(SubLayer(LN(x_l)))\)</span></strong><ol type="1"><li>æœ‰æ•ˆæ§åˆ¶æ¯ä¸€å±‚çš„æ¿€æ´»å€¼ï¼Œé¿å…å®ƒä»¬è¿‡å¤§ï¼Œæ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°å­¦ä¹ æ•°æ®ç‰¹å¾</li><li>è®­ç»ƒä¸ç¨³å®šï¼Œå¯èƒ½ä¼šå¯¼è‡´è®­ç»ƒå´©æºƒ</li></ol></li></ol><h4 id="æ¿€æ´»å‡½æ•°">4) æ¿€æ´»å‡½æ•°</h4><p>FFNé€šå¸¸å…ˆå°†å‘é‡ä»ç»´åº¦då‡ç»´åˆ°ä¸­é—´ç»´åº¦4dï¼Œå†ä»4dé™ç»´åˆ°dã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[FFN(x) = f(xW_1 + b_1)W_2 + b_2\]</span></p><p>å…¶ä¸­ï¼Œf(x)æ˜¯éçº¿æ€§æ¿€æ´»å‡½æ•°ã€‚å¹¿æ³›ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°æœ‰ReLUã€GELUã€Swishç­‰ã€‚</p><p><span class="math display">\[ReLU(x) = max(0, x)\\GELU(x) = x \cdot \phi(x)\\Swish(x) = x \cdot \sigma(\beta x)\\\]</span></p><p>å…¶ä¸­ï¼Œ<spanclass="math inline">\(\phi(x)\)</span>æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼Œ<spanclass="math inline">\(\sigma(x)\)</span>æ˜¯sigmoidå‡½æ•°ã€‚</p><p><span class="math display">\[\phi(x) = \frac{1}{2} \left(1 +erf\left(\frac{x}{\sqrt{2}}\right)\right)\\\sigma(x) = \frac{1}{1 + e^{-x}}\]</span></p><p>é€šè¿‡å¼•å…¥çº¿æ€§é—¨æ§å•å…ƒï¼ˆGLUï¼‰æ¥å¢å¼ºæ¨¡å‹çš„éçº¿æ€§èƒ½åŠ›ï¼ŒFFNé¢å¤–å¢åŠ äº†ä¸€ä¸ªæƒé‡çŸ©é˜µï¼Œå³ä¸‹å¼ä¸­çš„Vï¼Œå…±æœ‰ä¸‰ä¸ªæƒé‡çŸ©é˜µï¼Œè·å¾—äº†æ›´å¥½çš„æ¨¡å‹æ€§èƒ½ã€‚</p><p><span class="math display">\[\begin{matrix}FFN(x) = (f(xW_1) \otimes xV)W_2\\ReGLU(x) = ReLU(xW) \otimes xV\\GeGLU(x) = GELU(xW) \otimes xV\\SwiGLU(x) = Swish_{\beta}(xW) \otimes xV\\  \end{matrix}\]</span></p><h2 id="é«˜æ•ˆå‚æ•°å¾®è°ƒæ–¹æ³•">2 é«˜æ•ˆå‚æ•°å¾®è°ƒæ–¹æ³•</h2><p>å¤§è¯­è¨€æ¨¡å‹çš„å‚æ•°é‡è¿›è¡Œå…¨é‡å¾®è°ƒæˆæœ¬å¾ˆé«˜ã€‚é«˜æ•ˆå‚æ•°å¾®è°ƒï¼ˆPEFTï¼‰åœ¨å¾®è°ƒå¤§æ¨¡å‹æ—¶åªè®­ç»ƒä¸€å°éƒ¨åˆ†å‚æ•°ã€‚é«˜æ•ˆå‚æ•°å¾®è°ƒæ–¹æ³•æœ‰ä»¥ä¸‹å‡ æ–¹é¢ä¼˜ç‚¹ï¼š</p><ol type="1"><li>æ˜¾å­˜å ç”¨å°‘ï¼Œå¯¹ç¡¬ä»¶èµ„æºè¦æ±‚ä½</li><li>è®­ç»ƒé€Ÿåº¦å¿«ï¼Œè€—æ—¶æ›´çŸ­</li><li>æ›´ä½çš„å­˜å‚¨æˆæœ¬ï¼Œä¸åŒçš„ä»»åŠ¡å¯ä»¥å…±äº«å¤§éƒ¨åˆ†çš„æƒé‡å‚æ•°</li><li>å¯èƒ½ä¼šæœ‰æ›´å¥½çš„æ¨¡å‹æ€§èƒ½ï¼Œå‡è½»äº†è¿‡æ‹Ÿåˆé—®é¢˜</li></ol><h3 id="æç¤ºå¾®è°ƒprompt-tuning">2.1 æç¤ºå¾®è°ƒ(Prompt Tuning)</h3><p>prompttuningåŸæœ¬çš„å«ä¹‰æŒ‡çš„æ˜¯é€šè¿‡ä¿®æ”¹è¾“å…¥promptæ¥è·å¾—æ›´å¥½çš„æ¨¡å‹æ•ˆæœã€‚è¿™é‡Œçš„æç¤ºæ˜¯â€œç¡¬æç¤ºï¼ˆhardpromptï¼‰â€ã€‚æˆ‘ä»¬ç›´æ¥ä¿®æ”¹è¾“å…¥promptï¼Œè¾“å…¥promptæ˜¯ä¸å¯å¯¼çš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¾“å…¥promptä»â€œWhatis the capital of France?â€ä¿®æ”¹ä¸ºâ€œQuestion: What is the capital ofFrance? Answer:â€ï¼Œå¼•å¯¼æ¨¡å‹ç”Ÿæˆæƒ³è¦çš„è¾“å‡ºã€‚</p><p>ä¸â€œç¡¬æç¤ºâ€ç›¸å¯¹åº”ï¼Œâ€œè½¯æç¤ºå¾®è°ƒï¼ˆsoft prompttuningï¼‰â€å°†ä¸€ä¸ªå¯è®­ç»ƒå¼ é‡ä¸è¾“å…¥æ–‡æœ¬çš„embeddingsæ‹¼æ¥èµ·æ¥ï¼Œè¿™ä¸ªå¯è®­ç»ƒå¼ é‡å¯ä»¥é€šè¿‡åå‘ä¼ æ’­æ¥ä¼˜åŒ–ï¼Œè¿›è€Œæå‡ç›®æ ‡ä»»åŠ¡çš„æ¨¡å‹æ•ˆæœã€‚è¿™é‡Œçš„å¯è®­ç»ƒå¼ é‡å¯ä»¥ç†è§£ä¸ºpromptæ–‡æœ¬å¯¹åº”çš„embeddingï¼Œæ˜¯ä¸€ä¸ªsoftpromptã€‚<strong>å†»ç»“å¤§æ¨¡å‹åŸå§‹çš„å‚æ•°ï¼Œåªè®­ç»ƒè¿™ä¸ªæ–°å¢åŠ çš„promptå¼ é‡</strong>ã€‚prompttuningéšç€åŸºåº§æ¨¡å‹å‚æ•°é‡çš„å¢å¤§æ•ˆæœä¼šå˜å¥½ã€‚ å°ºå¯¸ï¼š<spanclass="math inline">\([virtual\_token\_num, embd\_dim]\)</span></p><p><strong>å®é™…ä¸Šéƒ½åªæ˜¯æ”¹å˜çš„è¾“å…¥æ–‡æœ¬ï¼Œä¸æ”¹å˜LLMModelå‚æ•°</strong>ï¼Œä½†æ˜¯ç¡¬æç¤ºæ˜¯é€šè¿‡æ‰‹åŠ¨è®¾è®¡çš„è‡ªç„¶è¯­è¨€æç¤ºæ¥å¼•å¯¼æ¨¡å‹ï¼Œé€šè¿‡æ”¹å˜è¾“å…¥æ–‡æœ¬æ¥é—´æ¥å½±å“åµŒå…¥è¡¨ç¤ºï¼Œè€Œè½¯æç¤ºé€šè¿‡<strong>å¯è®­ç»ƒ</strong>çš„æç¤ºåµŒå…¥ç›´æ¥å½±å“è¾“å…¥è¡¨ç¤ºï¼Œèƒ½å¤Ÿè¿›è¡Œä¼˜åŒ–å’Œå¾®è°ƒï¼Œé€‚ç”¨äºæ›´å¤æ‚å’Œå¤šæ ·åŒ–çš„ä»»åŠ¡ã€‚</p><h2 id="å‰ç¼€å¾®è°ƒpre-fix-tuning">2.2 å‰ç¼€å¾®è°ƒ(Pre-fix Tuning)</h2><p>prefix tuningä¸prompttuningç›¸ä¼¼ï¼Œå°†ä¸€ä¸ªç‰¹å®šä»»åŠ¡çš„å¼ é‡æ·»åŠ åˆ°è¾“å…¥ï¼Œè¿™ä¸ªå¼ é‡æ˜¯å¯è®­ç»ƒçš„ï¼Œä¿æŒé¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°ä¸å˜ã€‚ä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š</p><ol type="1"><li>prefixtuningå°†prefixå‚æ•°ï¼ˆå¯è®­ç»ƒå¼ é‡ï¼‰æ·»åŠ åˆ°æ‰€æœ‰çš„transformerå±‚çš„è¾“å…¥(ä¹Ÿè®¸å°±æ˜¯ä¼ æ’­åçš„embeddingï¼Ÿ)ï¼Œè€Œprompttuningåªå°†å¯è®­ç»ƒçŸ©é˜µæ·»åŠ åˆ°è¾“å…¥embeddingã€‚prefixtuningä¼šå°†prefixå¼ é‡ä½œä¸ºpast_key_valueæ·»åŠ åˆ°æ‰€æœ‰çš„transformerå±‚ã€‚<strong>æ¯ä¸ªtransformerå±‚éƒ½æœ‰å„è‡ªä¸åŒçš„å¯å­¦ä¹ prefixï¼Œå…è®¸ä¸åŒæ¨¡å‹å±‚è¿›è¡Œæ›´é‡èº«å®šåˆ¶çš„é€‚åº”ã€‚</strong></li><li>ç”¨ä¸€ä¸ªç‹¬ç«‹çš„FFNæ¥ç¼–ç å’Œä¼˜åŒ–prefixå‚æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¼˜åŒ–softpromptï¼Œå› ä¸ºå®ƒå¯èƒ½é€ æˆä¸ç¨³å®šå¹¶æŸå®³æ€§èƒ½ã€‚åœ¨æ›´æ–°å®Œsoftpromptåï¼Œå°±ä¸å†ä½¿ç”¨FFNäº†ã€‚</li></ol><p>å‰è€…æ˜¯ç›´æ¥ä½œç”¨åœ¨è¾“å…¥embeddingä¸Šï¼Œåè€…æ˜¯ä½œç”¨åœ¨æ‰€æœ‰transformerå±‚çš„self-attentionå—ï¼Œåœ¨è®¡ç®—å¾—åˆ°Kå’ŒVåï¼Œä¸å¯è®­ç»ƒçš„prefixå¼ é‡æ‹¼æ¥èµ·æ¥ã€‚</p><p>å°ºå¯¸ï¼š<span class="math inline">\([virtual\_token\_num, 2 \timeslayer\_num \times hidden\_size]\)</span> (2æ˜¯å› ä¸ºKå’ŒV)</p><h2 id="é€‚é…å™¨å¾®è°ƒadapter-tuning">2.3 é€‚é…å™¨å¾®è°ƒ(Adapter Tuning)</h2><figure><img src="./images/Adapter-Tuning.webp" title="å›¾3ï¼šAdapter Tuning"alt="Adapter Tuning" /><figcaption aria-hidden="true">Adapter Tuning</figcaption></figure><p>é¦–å…ˆæ˜¯ä¸€ä¸ª down-projectå±‚å°†é«˜ç»´åº¦ç‰¹å¾æ˜ å°„åˆ°ä½ç»´ç‰¹å¾ï¼Œç„¶åè¿‡ä¸€ä¸ªéçº¿å½¢å±‚ä¹‹åï¼Œå†ç”¨ä¸€ä¸ªup-project ç»“æ„å°†ä½ç»´ç‰¹å¾æ˜ å°„å›åŸæ¥çš„é«˜ç»´ç‰¹å¾ï¼› åŒæ—¶ä¹Ÿè®¾è®¡äº†skip-connection ç»“æ„ï¼Œç¡®ä¿äº†åœ¨æœ€å·®çš„æƒ…å†µä¸‹èƒ½å¤Ÿé€€åŒ–ä¸º identity<strong>åœ¨è®­ç»ƒæ—¶ï¼Œå›ºå®šä½åŸæ¥é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°ä¸å˜ï¼Œåªå¯¹æ–°å¢çš„ Adapterç»“æ„è¿›è¡Œå¾®è°ƒ</strong></p><h3 id="llama-adapter">2.3.1 LLaMA-adapter</h3><p>LLaMA-adapterç»“åˆäº†prefix tuningå’Œadapterã€‚ä¸prefixtuningç±»ä¼¼ï¼ŒLLaMA-adapteråœ¨è¾“å…¥embedä¸Šæ·»åŠ äº†å¯è®­ç»ƒçš„promptå¼ é‡ã€‚</p><ol type="1"><li>LLaMA-adapterå¼•è¿›äº†é›¶åˆå§‹åŒ–çš„æ³¨æ„åŠ›æœºåˆ¶å’Œé—¨æ§æœºåˆ¶ã€‚åŠ¨æœºæ˜¯adapterå’Œprefixtuningç»“åˆäº†éšæœºåˆå§‹åŒ–çš„å¼ é‡ï¼ˆprefix promptså’Œadapterlayersï¼‰å¾ˆå¤§å¯èƒ½ä¼šæŸå®³é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„è¯­ä¹‰å­¦çŸ¥è¯†ï¼Œå¯¼è‡´åœ¨è®­ç»ƒåˆå§‹é˜¶æ®µçš„å¾®è°ƒä¸ç¨³å®šå’Œå¾ˆé«˜çš„æ€§èƒ½æŸå¤±ã€‚</li><li>LLaMA-adapteråªç»™Lä¸ªæ·±å±‚transformerå±‚æ·»åŠ äº†å¯å­¦ä¹ çš„adaptionpromptsï¼Œè€Œä¸æ˜¯ç»™æ‰€æœ‰çš„transformerå±‚éƒ½æ·»åŠ ã€‚ä½œè€…è®¤ä¸ºï¼Œè¿™ç§æ–¹æ³•å¯ä»¥æ›´æœ‰æ•ˆçš„å¾®è°ƒä¸“æ³¨äºé«˜çº§è¯­ä¹‰ä¿¡æ¯çš„è¯­è¨€è¡¨ç¤ºã€‚</li></ol><h2 id="ä½ç§©é€‚é…å¾®è°ƒlow-rank-adaptation-lora">2.4 ä½ç§©é€‚é…å¾®è°ƒ(Low-RankAdaptation, LoRA)</h2><figure><img src="./images/LoRA.webp" title="å›¾4ï¼šLoRA" alt="LoRA" /><figcaption aria-hidden="true">LoRA</figcaption></figure><p>å†»ç»“äº†é¢„è®­ç»ƒçš„æ¨¡å‹æƒé‡ï¼Œå¹¶å°†å¯è®­ç»ƒçš„ç§©åˆ†è§£çŸ©é˜µ(LoRAå‚æ•°)æ³¨å…¥åˆ°Transformer æ¶æ„çš„æ¯ä¸€å±‚ä¸­ã€‚</p><p>å‡è®¾æ¨¡å‹åŸæœ‰å‚æ•°ä¸º<span class="math inline">\(W_0 \in \mathbb{R}^{d\times k}\)</span>ï¼Œå¾®è°ƒåçš„å‚æ•°ä¸º<span class="math inline">\(W \in\mathbb{R}^{d \times k}\)</span>ï¼Œå³</p><p><span class="math display">\[W = W_0 + \Delta W\]</span></p><p>LoRAå°†<span class="math inline">\(\DeltaW\)</span>åˆ†è§£ä¸ºä¸¤ä¸ªä½ç§©çŸ©é˜µçš„ä¹˜ç§¯ï¼Œå³ï¼š</p><p><span class="math display">\[\Delta W = B \cdot A\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(B \in \mathbb{R}^{d \timesr}\)</span>ï¼Œ<span class="math inline">\(A \in \mathbb{R}^{r \timesk}\)</span>ï¼Œ<spanclass="math inline">\(r\)</span>æ˜¯ä½ç§©çŸ©é˜µçš„ç§©ï¼Œä¸”<spanclass="math inline">\(r \ll min(d,k)\)</span>ã€‚</p><p><code>F.linear(input, self.weight, self.bias) + (self.lora_dropout(input) @ self.lora_right_weight @ self.lora_left_weight) * self.lora_scaling</code></p><ol type="1"><li><spanclass="math inline">\(B\)</span>æ˜¯å‡ç»´çŸ©é˜µï¼Œå°†ä½ç»´çš„è¾“å…¥å‘é‡å‡ç»´åˆ°é«˜ç»´ç©ºé—´ï¼Œ<spanclass="math inline">\(A\)</span>æ˜¯é™ç»´çŸ©é˜µï¼Œå°†é«˜ç»´çš„è¾“å‡ºå‘é‡é™ç»´åˆ°ä½ç»´ç©ºé—´ã€‚çŸ©é˜µçš„â€å‡ç»´â€æˆ–â€é™ç»´â€ä½œç”¨å–å†³äºå®ƒåœ¨æ•´ä¸ªè¿ç®—ä¸­çš„ä½ç½®å’Œä½œç”¨,è€Œä¸ä»…ä»…æ˜¯å®ƒè‡ªèº«çš„ç»´åº¦ã€‚å³<spanclass="math inline">\(B\)</span>çš„ç»´åº¦æ˜¯<span class="math inline">\(d\times r\)</span>ï¼Œè¿™æ„å‘³ç€å®ƒå°†<spanclass="math inline">\(r\)</span>ç»´çš„è¾“å…¥å‘é‡å˜æ¢åˆ°<spanclass="math inline">\(d\)</span>ç»´çš„è¾“å‡ºå‘é‡ã€‚è€Œ<spanclass="math inline">\(A\)</span>çš„ç»´åº¦æ˜¯<span class="math inline">\(r\times k\)</span>ï¼Œè¿™æ„å‘³ç€å®ƒå°†<spanclass="math inline">\(d\)</span>ç»´çš„è¾“å…¥å‘é‡å˜æ¢åˆ°<spanclass="math inline">\(r\)</span>ç»´çš„è¾“å‡ºå‘é‡ã€‚</li><li>ä¸ºä»€ä¹ˆçŸ©é˜µBè¢«åˆå§‹åŒ–ä¸º0ï¼Œè€ŒçŸ©é˜µAæ­£å¸¸é«˜æ–¯åˆå§‹åŒ–å…¨0å®¹æ˜“æ¢¯åº¦æ¶ˆå¤±(å› ä¸ºå¯¹ç§°æ€§)ï¼Œå…¨é«˜æ–¯åˆå§‹åŒ–ä¼šå¼•å…¥è¿‡å¤§å™ªå£°ï¼Œæ‰€ä»¥Båˆå§‹åŒ–ä¸º0ï¼ŒAåˆå§‹åŒ–ä¸ºé«˜æ–¯ï¼Œæ˜¯ä¸ºäº†åœ¨è®­ç»ƒå¼€å§‹æ—¶ç»´æŒç½‘ç»œçš„åŸæœ‰è¾“å‡º(åˆå§‹åç§»ä¸º0)ï¼Œä½†åŒæ—¶ä¹Ÿä¿è¯åœ¨çœŸæ­£å¼€å§‹å­¦ä¹ åèƒ½å¤Ÿæ›´å¥½çš„æ”¶æ•›(æ‰“ç ´å¯¹ç§°æ€§)ã€‚</li><li><span class="math inline">\(\Delta W\)</span> ä¼šé€šè¿‡<spanclass="math inline">\(\frac{\alpha}{r}\)</span>çš„æ–¹å¼è¿›è¡Œç¼©æ”¾ï¼Œå…¶ä¸­<spanclass="math inline">\(\alpha\)</span>ç±»ä¼¼è°ƒæ•´å­¦ä¹ ç‡ï¼Œæ‰€ä»¥ä¸å¦‚å›ºå®šä¸º1ï¼Œåªè°ƒèŠ‚<spanclass="math inline">\(r\)</span>ã€‚</li><li>ä¸adapter tuningç›¸æ¯”ï¼ŒLoRAçš„åŒºåˆ«åœ¨äºï¼š<ol type="1"><li>æ’å…¥ä½ç½®ã€‚LoRAæ˜¯ä»¥æ®‹å·®è¿æ¥çš„å½¢å¼â€å¹¶è”â€åœ¨Transformerçš„Q,K,V,OçŸ©é˜µä¸Š(æœ‰ç ”ç©¶è¡¨æ˜åªç”¨äºQVè¡¨ç°ä¹Ÿä¸é”™)ï¼›è€ŒAdapteræ˜¯æ’å…¥åœ¨Feed-forwardLayeråé¢ã€‚</li><li>æ¨ç†å»¶è¿Ÿã€‚LoRAåœ¨è®­ç»ƒå®Œåå…¶å‚æ•°å¯ä»¥ä¸åŸæœ‰é¢„è®­ç»ƒæ¨¡å‹ç›´æ¥åˆå¹¶ï¼Œå˜å›å•åˆ†æ”¯ç»“æ„ï¼Œä¸ä¼šå¼•å…¥é¢å¤–çš„å»¶è¿Ÿï¼›è€ŒAdapterç”±äºå¼•å…¥äº†é¢å¤–çš„ä¸²è”ç½‘ç»œå±‚ï¼Œå› æ­¤ä¼šå¸¦æ¥é¢å¤–çš„å»¶è¿Ÿã€‚</li><li>å‚æ•°å­˜å‚¨ã€‚ä½¿ç”¨LoRAè¿›è¡Œå¾®è°ƒï¼Œåœ¨è®­ç»ƒå®Œæ¯•ååªéœ€è¦ä¿å­˜LoRAæœ¬èº«çš„å‚æ•°ï¼›è€Œä½¿ç”¨Adapteråˆ™è¦ä¿å­˜æ•´ä¸ªåŸæœ‰æ¨¡å‹çš„å‚æ•°ã€‚</li></ol></li></ol><h3 id="æ¨¡å‹é‡åŒ–quantization">2.4.1 æ¨¡å‹é‡åŒ–(Quantization)</h3><p>æ¨¡å‹é‡åŒ–æ˜¯ä¸€ç§å‹ç¼©ç½‘ç»œå‚æ•°çš„æ–¹å¼ï¼Œå®ƒå°†ç¥ç»ç½‘ç»œçš„å‚æ•°(weight)ã€ç‰¹å¾å›¾(activation)ç­‰åŸæœ¬ç”¨æµ®ç‚¹è¡¨ç¤ºçš„é‡å€¼æ¢ç”¨å®šç‚¹(æ•´å‹)è¡¨ç¤ºï¼Œåœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œå†å°†å®šç‚¹æ•°æ®åé‡åŒ–å›æµ®ç‚¹æ•°æ®ï¼Œå¾—åˆ°ç»“æœã€‚è¿™æ ·å¯ä»¥å‡å°‘æ¨¡å‹çš„å­˜å‚¨ç©ºé—´å’Œè®¡ç®—é‡ï¼Œæé«˜æ¨¡å‹çš„è¿è¡Œé€Ÿåº¦ã€‚</p><ol type="1"><li>å¯ä»¥å‡å°‘å†…å­˜å’Œæ˜¾å­˜å ç”¨ï¼Œç»™æ¨¡å‹ç˜¦èº«</li><li>èƒ½å¤Ÿæé«˜è¿è¡Œé€Ÿåº¦ï¼Œè¿™å¯ä»¥ä»ä¸¤æ–¹é¢ç†è§£<ol type="1"><li>åœ¨é€‚é…ä½ç²¾åº¦çš„ç¡¬ä»¶ä¸‹ï¼Œé‡åŒ–æ¨¡å‹çš„è¿ç®—èƒ½ç›´æ¥ç”¨ int8 GEMM kernelè®¡ç®—</li><li>é‡åŒ–å‡å°‘äº†å•ä½æ•°æ®çš„ bit æ•°ï¼Œå› è€Œå¯ä»¥å‡å°‘è®¡ç®—è¿‡ç¨‹ä¸­çš„ IO é€šä¿¡é‡</li></ol></li><li>å¯ä»¥å¢å¤§ batch size</li></ol><h4 id="é‡åŒ–æ–¹æ³•">é‡åŒ–æ–¹æ³•</h4><ol type="1"><li>QAT(Quant-Aware Training)ä¹Ÿå¯ä»¥ç§°ä¸ºåœ¨çº¿é‡åŒ–(OnQuantization)ã€‚å®ƒéœ€è¦åˆ©ç”¨é¢å¤–çš„è®­ç»ƒæ•°æ®ï¼Œåœ¨é‡åŒ–çš„åŒæ—¶ç»“åˆåå‘ä¼ æ’­å¯¹æ¨¡å‹æƒé‡è¿›è¡Œè°ƒæ•´ï¼Œæ„åœ¨ç¡®ä¿é‡åŒ–æ¨¡å‹çš„ç²¾åº¦ä¸æ‰ç‚¹</li><li>PTQ (Post Training Quantization)ä¹Ÿå¯ä»¥ç§°ä¸ºç¦»çº¿é‡åŒ–(OffQuantization)ã€‚å®ƒæ˜¯åœ¨å·²è®­ç»ƒçš„æ¨¡å‹ä¸Šï¼Œä½¿ç”¨å°‘é‡æˆ–ä¸ä½¿ç”¨é¢å¤–æ•°æ®ï¼Œå¯¹æ¨¡å‹é‡åŒ–è¿‡ç¨‹è¿›è¡Œæ ¡å‡†ï¼Œå¯èƒ½ä¼´æœ‰æ¨¡å‹æƒé‡çš„ç¼©æ”¾ã€‚<ol type="1"><li>è®­ç»ƒååŠ¨æ€é‡åŒ–(PostDynamicQuantization)ï¼Œä¸ä½¿ç”¨æ ¡å‡†æ•°æ®é›†ï¼Œç›´æ¥å¯¹æ¯ä¸€å±‚ layeré€šè¿‡é‡åŒ–å…¬å¼è¿›è¡Œè½¬æ¢ï¼ŒQLoRA å°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹æ³•</li><li>è®­ç»ƒåæ ¡æ­£é‡åŒ–(Post CalibrationQuantization)ï¼Œéœ€è¦è¾“å…¥æœ‰ä»£è¡¨æ€§çš„æ•°æ®é›†ï¼Œæ ¹æ®æ¨¡å‹æ¯ä¸€å±‚ layerçš„è¾“å…¥è¾“å‡ºè°ƒæ•´é‡åŒ–æƒé‡ï¼ŒGPTQ å°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹æ³•ã€‚</li></ol></li></ol><p>è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{align}{quantized\_value} ={round}(\frac) + {zero\_point}\\{float\_value} = ({quantized\_value} - {zero\_point}) \times {scale}\end{align}\]</span></p><p>é€šå¸¸ scale ä¸º <spanclass="math inline">\(\frac{max(abs(float\_value))}{2^{bit\_width-1}-1}\)</span></p><figure><img src="./images/Quant.webp" title="å›¾5ï¼šQuantization"alt="Quantization" /><figcaption aria-hidden="true">Quantization</figcaption></figure><p><strong>å¯¹ç§°é‡åŒ–</strong> é‡åŒ–å‰åçš„ 0ç‚¹æ˜¯å¯¹é½çš„ï¼Œå› æ­¤ä¸éœ€è¦è®°å½•é›¶ç‚¹ã€‚å®ƒé€‚åˆå¯¹åˆ†å¸ƒè‰¯å¥½ä¸”å‡å€¼ä¸º 0çš„å‚æ•°è¿›è¡Œé‡åŒ–ï¼ˆå¯¹äºæ­£è´Ÿæ•°ä¸å‡åŒ€åˆ†å¸ƒçš„æƒ…å†µä¸å¤Ÿå‹å¥½ï¼‰ï¼Œå› æ­¤å¯¹ç§°é‡åŒ–å¸¸ç”¨äºå¯¹weight é‡åŒ– <strong>éå¯¹ç§°é‡åŒ–</strong> é‡åŒ–å‰å 0ç‚¹ä¸å¯¹é½ï¼Œéœ€è¦é¢å¤–è®°å½•ä¸€ä¸ª offsetï¼Œä¹Ÿå°±æ˜¯é›¶ç‚¹ã€‚éå¯¹ç§°é‡åŒ–å¸¸ç”¨äºå¯¹activation åšé‡åŒ–</p><p>ä¸ºè€ƒè™‘å…¶ä»–æ›´å¤šæƒ…å†µï¼Œéœ€è¦å¼•å…¥ä¸€ç§æ–°çš„é‡åŒ–ç­–ç•¥ï¼š<strong>Block-wisequantization(å—çº§é‡åŒ–)ï¼Œå—çº§é‡åŒ–æœ€ç»ˆèƒ½ä½¿é‡åŒ–çš„ç²¾åº¦æŸå¤±å‡å°‘</strong>ã€‚ä¸ºäº†é¿å…å¼‚å¸¸å€¼(outlier)çš„å½±å“ï¼Œæˆ‘ä»¬ä¼šå°†è¾“å…¥tensor(é€šå¸¸æ˜¯ç¥ç»ç½‘ç»œçš„æƒé‡æˆ–æ¿€æ´»å€¼)åˆ†å‰²æˆå¤šä¸ªå—(block)ï¼Œç„¶åæ¯ä¸ªå—(block)å•ç‹¬åšé‡åŒ–ï¼Œæœ‰å•ç‹¬çš„ç¼©æ”¾å› å­scaleå’Œé›¶ç‚¹zero</p><ol type="1"><li>å¯ä»¥ä¸ºä¸åŒçš„æ•°æ®å—é€‰æ‹©<strong>ä¸åŒçš„é‡åŒ–ç­–ç•¥</strong>ã€‚ä¾‹å¦‚ï¼ŒæŸäº›å—å¯ä»¥ç”¨æ›´é«˜çš„ä½å®½é‡åŒ–ï¼Œè€Œå…¶ä»–å—åˆ™å¯ä»¥ç”¨æ›´ä½çš„ä½å®½</li><li>å°½ç®¡å—çº§é‡åŒ–å¯ä»¥æä¾›æ›´å¥½çš„ç²¾åº¦ï¼Œä½†ç”±äºæ¯ä¸ªå—éƒ½æœ‰è‡ªå·±çš„é‡åŒ–å‚æ•°ï¼Œè¿™å¯èƒ½ä¼š<strong>å¢åŠ è®¡ç®—å’Œå­˜å‚¨çš„å¼€é”€</strong></li></ol><h3 id="é‡åŒ–ä½ç§©é€‚é…qlora">2.4.2 é‡åŒ–ä½ç§©é€‚é…(QLoRA)</h3><p>QLoRAé’ˆå¯¹æ¨¡å‹æƒé‡(weight)åšé‡åŒ–ï¼Œé‡‡ç”¨çš„æ˜¯å¯¹ç§°é‡åŒ–ç®—æ³•ï¼Œé‡åŒ–è¿‡ç¨‹åŸºæœ¬ä¸LoRAç›¸åŒ:</p><ol type="1"><li>4ä½NormalFloaté‡åŒ–ï¼šç¡®ä¿æ¯ä¸ªé‡åŒ–ä»“ä¸­æœ‰ç›¸åŒæ•°é‡çš„å€¼ å³é‡‡ç”¨æ–°çš„ NF(NormalFloat)æ•°æ®ç±»å‹ï¼Œå®ƒæ˜¯å¯¹äºæ­£æ€åˆ†å¸ƒæƒé‡è€Œè¨€ä¿¡æ¯ç†è®ºä¸Šæœ€ä¼˜çš„æ•°æ®ç±»å‹ï¼ŒåŒæ—¶ï¼ŒNFç±»å‹æœ‰åŠ©äºç¼“è§£å¼‚å¸¸å€¼çš„å½±å“</li><li>åŒé‡åŒ–ï¼šå¯¹é‡åŒ–å¸¸é‡å†æ¬¡é‡åŒ–ä»¥èŠ‚çœé¢å¤–å†…å­˜çš„è¿‡ç¨‹ å³DoubleQuantï¼Œå¯¹äºé‡åŒ–åçš„ scale æ•°æ®åšè¿›ä¸€æ­¥çš„é‡åŒ–</li><li>QLoRaè¿˜æœ‰ç»Ÿä¸€å†…å­˜åˆ†é¡µï¼šå®ƒä¾èµ–äºNVIDIAç»Ÿä¸€å†…å­˜ç®¡ç†ï¼Œè‡ªåŠ¨å¤„ç†CPUå’ŒGPUä¹‹é—´çš„é¡µåˆ°é¡µä¼ è¾“ï¼Œå®ƒå¯ä»¥ä¿è¯GPUå¤„ç†æ— é”™ï¼Œç‰¹åˆ«æ˜¯åœ¨GPUå¯èƒ½è€—å°½å†…å­˜çš„æƒ…å†µä¸‹</li></ol><h4 id="nfæ•°æ®ç±»å‹">NFæ•°æ®ç±»å‹</h4><p>int4 çš„æ ¼ç‚¹åˆ†å¸ƒæ˜¯å‡åŒ€çš„ï¼Œç„¶è€Œæ¨¡å‹çš„æƒé‡é€šå¸¸æœä»å‡å€¼ä¸º 0çš„æ­£æ€åˆ†å¸ƒï¼Œå› æ­¤æ ¼ç‚¹çš„åˆ†å¸ƒå’Œæ•°æ®çš„åˆ†å¸ƒä¸ä¸€è‡´ã€‚ NF4çš„æ ¼ç‚¹æŒ‰ç…§æ­£æ€åˆ†å¸ƒçš„åˆ†ä½æ•°æˆªå–ï¼Œæ ¼ç‚¹åˆ†å¸ƒä¸¤ç«¯ç¨€ç–ï¼Œä¸­é—´å¯†é›†ï¼Œæ ¼ç‚¹åˆ†å¸ƒä¸æ•°æ®åˆ†å¸ƒä¸€è‡´ã€‚è¿™æ ·æ ¼ç‚¹åˆ†é…çš„æ•ˆç‡å°±å¤§å¤§å¢åŠ äº†ï¼ŒåŒæ—¶ç²¾åº¦å—æŸä¹Ÿä¸ä¼šå¤ªå¤§ã€‚</p><h4 id="åŒé‡åŒ–double-quant">åŒé‡åŒ–(Double Quant)</h4><p>QLoRA å°†æ¯ 64 ä¸ªå‚æ•°ä¸ºåšä¸€ä¸ª blockï¼Œå³ block_size = 64ï¼Œæ¯ä¸ª blockè®¡ç®—ä¸€ä¸ª Scaleã€‚ ç”±äºé‡åŒ–åçš„ Scale é€šå¸¸ä»¥ FP32 å­˜å‚¨ï¼Œåœ¨ blockæ•°ä¼—å¤šçš„æƒ…å†µä¸‹ï¼ŒScale å ç”¨çš„æ˜¾å­˜ä¹Ÿä¸å¯å¿½è§†ã€‚ å› æ­¤ï¼ŒQLoRA å¯¹ Scaleè¿›ä¸€æ­¥é‡åŒ–æˆ FP8ï¼Œå– Double Quant çš„ block size =256ï¼Œå› è€Œè¿›ä¸€æ­¥é™ä½äº†æ˜¾å­˜æ¶ˆè€—ã€‚</p><h4 id="ç»Ÿä¸€å†…å­˜åˆ†é¡µ">ç»Ÿä¸€å†…å­˜åˆ†é¡µ</h4>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Flash Attention</title>
      <link href="/2024/08/08/NLP/FlashAttention/"/>
      <url>/2024/08/08/NLP/FlashAttention/</url>
      
        <content type="html"><![CDATA[<h1 id="flash-attention">Flash Attention</h1><p>FlashAttention æ˜¯ä¸€ç§å…·æœ‰ IOæ„ŸçŸ¥ï¼Œä¸”å…¼å…·å¿«é€Ÿã€å†…å­˜é«˜æ•ˆçš„æ–°å‹æ³¨æ„åŠ›ç®—æ³•ã€‚ä¸ºäº†ç¼“è§£LLMè¾“å…¥è¾“å‡ºåºåˆ—sæ‰©å±•æ—¶è®¡ç®—å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦éƒ½æ˜¯<spanclass="math inline">\(O(s^2)\)</span>çš„é—®é¢˜ã€‚</p><h2 id="transformerå¤æ‚åº¦">1 Transformerå¤æ‚åº¦</h2><p>transformeræ¨¡å‹ä¸­self-attentionçš„è®¡ç®—é‡å’Œå‚¨å­˜å¤æ‚åº¦éšç€åºåˆ—é•¿åº¦ sâ€‹å‘ˆäºŒæ¬¡æ–¹å¢é•¿ï¼Œè¿™é™åˆ¶äº†å¤§è¯­è¨€æ¨¡å‹çš„æœ€å¤§åºåˆ—é•¿åº¦ sâ€‹ çš„å¤§å°ã€‚</p><h3 id="è®¡ç®—å¤æ‚åº¦">1.1 è®¡ç®—å¤æ‚åº¦</h3><table><thead><tr><th style="text-align: center;">æ¨¡å—</th><th style="text-align: center;">æ•°é‡</th><th style="text-align: center;">å•æ¬¡FLOPs</th><th style="text-align: center;">æ€»FLOPs</th></tr></thead><tbody><tr><td style="text-align: center;">Embedding</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr><td style="text-align: center;">LM Head(logits)</td><td style="text-align: center;">1</td><td style="text-align: center;"><spanclass="math inline">\(2bsVd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(2bsVd\)</span></td></tr><tr><td style="text-align: center;">Self-Attention</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(8bsd^2+4bs^2d\)</span></td><td style="text-align: center;"><spanclass="math inline">\(8blsd^2+4bls^2d\)</span></td></tr><tr><td style="text-align: center;">MLP</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(16bsd^2\)</span></td><td style="text-align: center;"><spanclass="math inline">\(16blsd^2\)</span></td></tr></tbody></table><p>æ€»FLOPsï¼š<span class="math inline">\(2bsVd + 24blsd^2 +4bls^2d\)</span></p><h3 id="ç©ºé—´å¤æ‚åº¦">1.2 ç©ºé—´å¤æ‚åº¦</h3><table><thead><tr><th style="text-align: center;">æ¨¡å—</th><th style="text-align: center;">æ•°é‡</th><th style="text-align: center;">å•ä¸ªå ç”¨</th><th style="text-align: center;">æ€»å ç”¨</th></tr></thead><tbody><tr><td style="text-align: center;">Self-Attention</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(11bsd+5bs^2n\)</span></td><td style="text-align: center;"><spanclass="math inline">\(11blsd+5bls^2n\)</span></td></tr><tr><td style="text-align: center;">MLP</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(19bsd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(19blsd\)</span></td></tr><tr><td style="text-align: center;">LayerNorm</td><td style="text-align: center;">2l</td><td style="text-align: center;"><spanclass="math inline">\(2bsd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(4blsd\)</span></td></tr></tbody></table><p>ä¸­é—´æ¿€æ´»å€¼æ€»æ˜¾å­˜å ç”¨ï¼š<spanclass="math inline">\(34blsd+5bls^2n\)</span> bytes</p><h2 id="standard-attention">2 Standard Attention</h2><p>é¦–å…ˆå›é¡¾Attentionçš„è®¡ç®—è¿‡ç¨‹ï¼š</p><p><span class="math display">\[\text{Attention}(Q, K, V) = \text{softmax}(\frac{QK^T}{\sqrt{d}})V\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(Q, K, V in \mathbb{R}^{s \timesd}\)</span>ï¼Œ<spanclass="math inline">\(d\)</span>æ˜¯embeddingç»´åº¦ï¼Œ<spanclass="math inline">\(s\)</span>æ˜¯åºåˆ—é•¿åº¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªç„¶è¯­è¨€å¤„ç†(NLP)ç®€ä»‹</title>
      <link href="/2024/08/08/NLP/Introduction/"/>
      <url>/2024/08/08/NLP/Introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªç„¶è¯­è¨€å¤„ç†nlp">è‡ªç„¶è¯­è¨€å¤„ç†(NLP)</h1><p>è‡ªç„¶è¯­è¨€å¤„ç†(Natural Language Processing,NLP)æ˜¯äººå·¥æ™ºèƒ½é¢†åŸŸçš„ä¸€ä¸ªé‡è¦åˆ†æ”¯ï¼Œç ”ç©¶å¦‚ä½•ä½¿è®¡ç®—æœºèƒ½å¤Ÿç†è§£ã€å¤„ç†å’Œç”Ÿæˆè‡ªç„¶è¯­è¨€æ–‡æœ¬ã€‚NLPæŠ€æœ¯åœ¨ä¿¡æ¯æ£€ç´¢ã€æœºå™¨ç¿»è¯‘ã€è¯­éŸ³è¯†åˆ«ã€æƒ…æ„Ÿåˆ†æã€å¯¹è¯ç³»ç»Ÿç­‰é¢†åŸŸæœ‰ç€å¹¿æ³›çš„åº”ç”¨ã€‚</p><h2 id="nlpåŸºç¡€">1. NLPåŸºç¡€</h2><h2 id="nlpä»»åŠ¡">2. NLPä»»åŠ¡</h2><h3 id="æ•°æ®é¢„å¤„ç†">2.1 æ•°æ®é¢„å¤„ç†</h3><p>NLPä»»åŠ¡çš„ç¬¬ä¸€æ­¥æ˜¯æ•°æ®é¢„å¤„ç†ï¼ŒåŒ…æ‹¬æ”¶é›†è¯­æ–™åº“ã€æ–‡æœ¬æ¸…æ´—ã€åˆ†è¯ã€å»æ‰åœç”¨è¯ï¼ˆå¯é€‰ï¼‰ã€æ ‡å‡†åŒ–å’Œç‰¹å¾æå–ç­‰ä»»åŠ¡æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[æ•°æ®é¢„å¤„ç†] --&gt; B[æ”¶é›†è¯­æ–™åº“]    B --&gt; C[æ–‡æœ¬æ¸…æ´—]    C --&gt; D[åˆ†è¯]    D --&gt; E[æ ‡å‡†åŒ–]    E --&gt; F[ç‰¹å¾æå–]  </pre></div><h4 id="æ”¶é›†è¯­æ–™åº“">2.1.1 æ”¶é›†è¯­æ–™åº“</h4><p>æ¯ä¸ªæœºå™¨å­¦ä¹ é—®é¢˜éƒ½ä»æ•°æ®å¼€å§‹ï¼Œä¾‹å¦‚ç”µå­é‚®ä»¶ï¼Œå¸–å­æˆ–æ¨æ–‡åˆ—è¡¨ã€‚è¿™äº›æ•°æ®çš„é›†åˆç§°ä¸ºè¯­æ–™åº“ã€‚è¯­æ–™åº“å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸€ä¸ªç½‘ç«™ï¼Œä¸€ä¸ªæ•°æ®åº“æˆ–ä»»ä½•å…¶ä»–æ•°æ®æºã€‚</p><h4 id="æ–‡æœ¬æ¸…æ´—">2.1.2 æ–‡æœ¬æ¸…æ´—</h4><p>æ–‡æœ¬æ¸…æ´—æ˜¯æŒ‡ä»æ–‡æœ¬ä¸­åˆ é™¤ä¸å¿…è¦çš„å­—ç¬¦ï¼Œä¾‹å¦‚æ ‡ç‚¹ç¬¦å·ã€ç‰¹æ®Šå­—ç¬¦ã€HTMLæ ‡ç­¾ç­‰ã€‚æ–‡æœ¬æ¸…æ´—çš„ç›®çš„æ˜¯å‡å°‘æ–‡æœ¬æ•°æ®çš„å™ªå£°ï¼Œä½¿æ–‡æœ¬æ•°æ®æ›´åŠ å¹²å‡€ã€‚</p><table><colgroup><col style="width: 33%" /><col style="width: 33%" /><col style="width: 33%" /></colgroup><thead><tr><th>æ•°æ®ç±»å‹</th><th>è§£é‡Š</th><th>å¸¸ç”¨æ ¼å¼</th></tr></thead><tbody><tr><td>ç»“æ„åŒ–æ•°æ®</td><td>æ•°æ®ä»¥è¡¨æ ¼å½¢å¼å­˜å‚¨ï¼Œæ¯è¡Œä»£è¡¨ä¸€ä¸ªæ ·æœ¬ï¼Œæ¯åˆ—ä»£è¡¨ä¸€ä¸ªç‰¹å¾</td><td>CSVã€Excelã€æ•°æ®åº“</td></tr><tr><td>éç»“æ„åŒ–æ•°æ®</td><td>æ•°æ®æ²¡æœ‰å›ºå®šçš„æ ¼å¼ï¼Œä¾‹å¦‚æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰</td><td>æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘</td></tr><tr><td>åŠç»“æ„åŒ–æ•°æ®</td><td>æ•°æ®ä»‹äºç»“æ„åŒ–æ•°æ®å’Œéç»“æ„åŒ–æ•°æ®ä¹‹é—´</td><td>XMLã€JSONã€HTML</td></tr></tbody></table><h4 id="åˆ†è¯">2.1.3 åˆ†è¯</h4><p>åˆ†è¯æ˜¯å°†æ–‡æœ¬åˆ†å‰²æˆä¸€ä¸ªä¸ªå•è¯æˆ–è¯ç»„çš„è¿‡ç¨‹ã€‚åˆ†è¯æ˜¯NLPä»»åŠ¡çš„ç¬¬ä¸€æ­¥ï¼Œä¹Ÿæ˜¯NLPä»»åŠ¡çš„åŸºç¡€ã€‚åˆ†è¯çš„ç›®çš„æ˜¯å°†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºè®¡ç®—æœºå¯ä»¥ç†è§£çš„å½¢å¼ã€‚</p><p>å¸¸è§çš„åˆ†è¯å™¨éƒ½æ˜¯ä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•å’Œè¯å…¸ç›¸ç»“åˆï¼Œä¸€æ–¹é¢èƒ½å¤Ÿæé«˜åˆ†è¯å‡†ç¡®ç‡ï¼Œå¦ä¸€æ–¹é¢èƒ½å¤Ÿæ”¹å–„é¢†åŸŸé€‚åº”æ€§ã€‚ç›®å‰ï¼Œä¸»æµçš„ä¸­æ–‡åˆ†è¯æŠ€æœ¯é‡‡ç”¨çš„éƒ½æ˜¯åŸºäºè¯å…¸æœ€å¤§æ¦‚ç‡è·¯å¾„+æœªç™»å½•è¯è¯†åˆ«ï¼ˆHMMï¼‰çš„æ–¹æ¡ˆï¼Œå…¶ä¸­å…¸å‹çš„ä»£è¡¨å°±æ˜¯jiebaåˆ†è¯ï¼Œä¸€ä¸ªçƒ­é—¨çš„å¤šè¯­è¨€ä¸­æ–‡åˆ†è¯åŒ…ã€‚</p><p>å¯ä»¥å€ŸåŠ©ä¸€äº›å¼€æºçš„åˆ†è¯å·¥å…·ï¼Œå¦‚jiebaã€NLTKã€spaCyç­‰ã€‚</p><h4 id="æ ‡å‡†åŒ–">2.1.4 æ ‡å‡†åŒ–</h4><p>æ ‡å‡†åŒ–æ˜¯å°†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºç»Ÿä¸€çš„æ ¼å¼ï¼Œä¾‹å¦‚å°†æ–‡æœ¬è½¬æ¢ä¸ºå°å†™ã€å»æ‰æ ‡ç‚¹ç¬¦å·ã€å»æ‰æ•°å­—ç­‰ã€‚æ ‡å‡†åŒ–çš„ç›®çš„æ˜¯å‡å°‘æ–‡æœ¬æ•°æ®çš„å™ªå£°ï¼Œä½¿æ–‡æœ¬æ•°æ®æ›´åŠ å¹²å‡€ã€‚åŒ…æ‹¬ï¼šå»æ‰åœç”¨è¯ã€è¯æ±‡è¡¨ã€è®­ç»ƒæ•°æ®ç­‰ç­‰ã€‚</p><h5 id="a-å»æ‰åœç”¨è¯">a å»æ‰åœç”¨è¯</h5><p>åœç”¨è¯æ˜¯æŒ‡åœ¨æ–‡æœ¬ä¸­é¢‘ç¹å‡ºç°ï¼Œä½†å¯¹æ–‡æœ¬åˆ†ææ²¡æœ‰å®é™…æ„ä¹‰çš„è¯ï¼Œå¦‚â€œçš„â€ã€â€œæ˜¯â€ã€â€œåœ¨â€ã€â€œå…¶ä¸­â€ã€â€œå†µä¸”â€ã€â€œä»€ä¹ˆâ€ç­‰ã€‚ä½†è¿™ä¸€æ­¥ä¸æ˜¯å¿…é¡»çš„ï¼Œè¦æ ¹æ®å®é™…ä¸šåŠ¡è¿›è¡Œé€‰æ‹©ï¼Œåƒå…³é”®è¯æŒ–æ˜å°±éœ€è¦å»æ‰åœç”¨è¯ï¼Œè€Œåƒè®­ç»ƒè¯å‘é‡å°±ä¸éœ€è¦ã€‚</p><h5 id="b-è¯æ±‡è¡¨">b è¯æ±‡è¡¨</h5><p>è¯æ±‡è¡¨æ˜¯ä¸ºè¯­æ–™åº“å»ºç«‹ä¸€ä¸ªæ‰€æœ‰ä¸é‡å¤è¯çš„åˆ—è¡¨ï¼Œæ¯ä¸ªè¯å¯¹åº”ä¸€ä¸ªç´¢å¼•å€¼ï¼Œå¹¶ç´¢å¼•å€¼ä¸å¯ä»¥æ”¹å˜ã€‚è¯æ±‡è¡¨çš„æœ€å¤§ä½œç”¨å°±æ˜¯å¯ä»¥å°†è¯è½¬åŒ–æˆä¸€ä¸ªå‘é‡ï¼Œå³One-Hotç¼–ç ã€‚</p><p><strong>O<em>ne-Hotç¼–ç çš„ç¼ºç‚¹</em></strong>å½“è¯æ±‡è¡¨çš„ç»´åº¦ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œå°±ä¼šå¯¼è‡´ç»è¿‡One-Hotç¼–ç åçš„è¯å‘é‡éå¸¸ç¨€ç–ï¼ŒåŒæ—¶One-Hotç¼–ç ä¹Ÿç¼ºå°‘è¯çš„è¯­ä¹‰ä¿¡æ¯ã€‚ç”±äºè¿™äº›é—®é¢˜ï¼Œæ‰æœ‰äº†åé¢å¤§åé¼é¼çš„Word2vecï¼Œä»¥åŠWord2vecçš„å‡çº§ç‰ˆBERTã€‚</p><h5 id="c-è®­ç»ƒæ•°æ®">c è®­ç»ƒæ•°æ®</h5><p>æˆ‘ä»¬åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œè¿˜éœ€è¦æä¾›è®­ç»ƒæ•°æ®ã€‚æ¨¡å‹çš„å­¦ä¹ å¯ä»¥å¤§ä½“åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>ç›‘ç£å­¦ä¹ ï¼Œåœ¨å·²çŸ¥ç­”æ¡ˆçš„æ ‡æ³¨æ•°æ®é›†ä¸Šï¼Œæ¨¡å‹ç»™å‡ºçš„é¢„æµ‹ç»“æœå°½å¯èƒ½æ¥è¿‘çœŸå®ç­”æ¡ˆï¼Œé€‚åˆé¢„æµ‹ä»»åŠ¡</li><li>éç›‘ç£å­¦ä¹ ï¼Œå­¦ä¹ æ²¡æœ‰æ ‡æ³¨çš„æ•°æ®ï¼Œæ˜¯è¦æ­ç¤ºå…³äºæ•°æ®éšè—ç»“æ„çš„ä¸€äº›è§„å¾‹ï¼Œé€‚åˆæè¿°ä»»åŠ¡</li></ul><p>æ ¹æ®ä¸åŒçš„å­¦ä¹ ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸åŒçš„æ ‡å‡†åŒ–æ•°æ®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ ‡æ³¨æ•°æ®çš„è·å–æˆæœ¬éå¸¸æ˜‚è´µï¼Œéç›‘ç£å­¦ä¹ è™½ç„¶ä¸éœ€è¦èŠ±è´¹è¿™æ ·çš„æˆæœ¬ï¼Œä½†åœ¨å®é™…é—®é¢˜çš„è§£å†³ä¸Šï¼Œä¸»æµçš„æ–¹å¼è¿˜é€‰æ‹©ç›‘ç£å­¦ä¹ ï¼Œå› ä¸ºæ•ˆæœæ›´å¥½ã€‚</p><h4 id="ç‰¹å¾æå–">2.1.5 ç‰¹å¾æå–</h4><p>ç‰¹å¾æå–æ˜¯å°†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºè®¡ç®—æœºå¯ä»¥ç†è§£çš„ç‰¹å¾å‘é‡çš„è¿‡ç¨‹ã€‚è½¬åŒ–çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼šç»Ÿè®¡å’ŒEmbedding</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>KV Cache</title>
      <link href="/2024/08/08/NLP/KV%20Cache/"/>
      <url>/2024/08/08/NLP/KV%20Cache/</url>
      
        <content type="html"><![CDATA[<h1 id="kv-cache">KV Cache</h1><p>KV-Cacheæ˜¯ä¸€ç§åŠ é€ŸTransformeræ¨ç†çš„ç­–ç•¥ï¼Œå‡ ä¹æ‰€æœ‰è‡ªå›å½’æ¨¡å‹éƒ½å†…ç½®äº†KV-Cache</p><h2 id="ä¸ºä»€ä¹ˆéœ€è¦kv-cache">1 ä¸ºä»€ä¹ˆéœ€è¦KV-Cache</h2><p>Transformeræ¯ä¸€å±‚åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯Self-Attentionï¼Œå¦ä¸€ä¸ªæ˜¯FeedForward Network(FFN)ã€‚</p><ol type="1"><li>Self-Attention: <span class="math inline">\(Attention(Q, K, V) =softmax(\frac{QK^T}{\sqrt{d_k}})V\)</span></li><li>FFN: <span class="math inline">\(FFN(x) = ReLU(xW_1 + b_1)W_2 +b_2\)</span></li></ol><p>è‡ªå›å½’æ¨¡å‹é‡‡ç”¨æ¯æ¬¡æ¨ç†éƒ½å°†å‰æ–‡æ•´å¥è¾“å…¥æ¨¡å‹ï¼Œç„¶åé¢„æµ‹ä¸‹ä¸€ä¸ªtokençš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¼šå­˜åœ¨ç›¸åŒç»“æœçš„é‡å¤æ¨ç†ã€‚ä»¤å‰ä¸€æ¬¡å¾…æ¨ç†çš„æ–‡æœ¬é•¿åº¦ä¸ºSï¼Œä¸‹ä¸€æ¬¡ä¸ºS+1ï¼Œç”±äºç½‘ç»œä¸­çš„å„é¡¹å‚æ•°å·²ç»å›ºå®šï¼Œå› æ­¤ä¸¤æ¬¡æ¨ç†å¯¹äºå‰Sä¸ªtokençš„è®¡ç®—ç»“æœæ˜¯å®Œå…¨ç›¸åŒçš„ï¼ŒåŒ…æ‹¬Embeddingæ˜ å°„ï¼Œæ¯ä¸€å±‚ã€æ¯ä¸€ä¸ªæ³¨æ„åŠ›å¤´ä¸‹çš„KQVæ˜ å°„ï¼Œæ³¨æ„åŠ›æƒé‡ï¼Œä»¥åŠåç»­çš„FFNå±‚éƒ½åœ¨é‡å¤è®¡ç®—ã€‚</p><p>é‚£ä¹ˆæ—¢ç„¶ä¸‹ä¸€ä¸ªtokenæ˜¯ç”±å½“å‰æœ€åä¸€ä¸ªtokençš„ç½‘ç»œè¾“å‡ºæ‰€å†³å®šçš„ï¼Œé‚£èƒ½ä¸èƒ½ä»…è¾“å…¥æœ€åä¸€ä¸ªtokenæ¥è¿›è¡Œæ¨ç†ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè™½ç„¶åœ¨ç»“æœå±‚ä»…ç”±æœ€åä¸€ä¸ªtokenæ¥å†³å®šï¼Œä½†æ˜¯ä¸­é—´çš„æ³¨æ„åŠ›è¿‡ç¨‹å®ƒçš„<strong>è®¡ç®—ä¾èµ–äºå‰æ–‡æ‰€æä¾›çš„Keyã€Valueå‘é‡</strong>(è¿™å°±æ˜¯å‰æ–‡ä¿¡æ¯)ï¼Œå› æ­¤ä¹Ÿä¸èƒ½æŠ›å¼ƒå‰æ–‡ä¸ç®¡ã€‚</p><p>S+1ä½ç½®tokençš„æ¨ç†ä¾èµ–äºä¸¤ä¸ªè¦ç´ :</p><ol type="1"><li>é¦–å…ˆæ˜¯å½“å‰ç¬¬Sä¸ªtokenåœ¨ç½‘ç»œä¸­å®Œæ•´forwardä¸€é</li><li>å…¶æ¬¡æ˜¯é™¤æœ€åä¸€ä¸ªtokenä»¥å¤–ï¼Œä¹‹å‰æ‰€æœ‰çš„S-1ä½ç½®çš„tokenåœ¨æ¯ä¸€å±‚ã€æ¯ä¸ªæ³¨æ„åŠ›å¤´ä¸‹çš„Keyï¼ŒValueä¿¡æ¯ã€‚</li></ol><p>æ‰€ä»¥å¯ä»¥å°†Keyã€Valueä¿¡æ¯ç¼“å­˜ä¸‹æ¥ï¼Œä¸‹æ¬¡æ¨ç†æ—¶ç›´æ¥ä½¿ç”¨ï¼Œè¿™å°±æ˜¯KV-Cacheçš„æ€æƒ³ã€‚</p><h2 id="kv-cacheçš„å®ç°">2 KV-Cacheçš„å®ç°</h2><p>ä»ç¬¬äºŒæ¬¡æ¨ç†å¼€å§‹ï¼Œä»…éœ€è¦è¾“å…¥å½“å‰æœ€åä¸€ä¸ªtokenï¼Œå•ç‹¬å¯¹è¯¥tokenåšQï¼ŒKï¼ŒVæ˜ å°„ï¼Œå°†past_key_valuesä¸­å‰æ–‡æ‰€æœ‰çš„Kï¼ŒVå’Œè¯¥tokençš„Kï¼ŒVè¿›è¡Œæ‹¼æ¥å¾—åˆ°å®Œæˆçš„Keyã€Valueå‘é‡(åªæ˜¯ç®€å•çš„æ‹¼æ¥çŸ©é˜µ)ï¼Œæœ€ç»ˆå’Œè¯¥tokençš„Queryè®¡ç®—æ³¨æ„åŠ›ï¼Œæ‹¼æ¥åçš„Keyã€Valueä¹ŸåŒæ­¥æ›´æ–°åˆ°past_key_valuesã€‚</p><h2 id="å­˜å‚¨ç»“æ„">3 å­˜å‚¨ç»“æ„</h2><p>KV-Cacheä¼šå°†æˆªæ­¢å½“å‰å„ä¸ªtokenåœ¨æ¯ä¸€å±‚ã€æ¯ä¸ªå¤´çš„Keyå‘é‡å’ŒValueå‘é‡å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œåœ¨HuggingFaceçš„ä»£ç å®ç°ä¸­ä½¿ç”¨past_key_valueså˜é‡è¿›è¡Œå­˜å‚¨ï¼Œpast_key_valuesæ˜¯ä¸€ä¸ªçŸ©é˜µï¼Œå…¶ç»´åº¦ä¸º[n,2, b, h, s, d]ï¼Œç±»ä¼¼ä¸€ä¸ªå…­ç»´çš„çŸ©é˜µï¼Œæ¯ä¸ªç»´åº¦çš„å«ä¹‰å¦‚ä¸‹</p><ol type="1"><li>ç¬¬ä¸€ç»´num_layersï¼šåœ¨å¤–å±‚æ˜¯ä»¥æ¯ä¸€ä¸ªå †å çš„Blockä¸ºå•ä½ï¼Œä¾‹å¦‚å †å 12å±‚ï¼Œåˆ™ä¸€å…±æœ‰12ç»„Keyã€Valueä¿¡æ¯</li><li>ç¬¬äºŒç»´2ï¼šä»£è¡¨Keyå’ŒValueè¿™ä¸¤ä¸ªä¿¡æ¯å¯¹è±¡ï¼Œç´¢å¼•0å–åˆ°Keyå‘é‡ï¼Œç´¢å¼•1å–åˆ°Valueå‘é‡</li><li>ç¬¬ä¸‰ç»´batch_sizeï¼šä»£è¡¨batch_sizeï¼Œå’Œè¾“å…¥éœ€è¦æ¨ç†çš„æ–‡æœ¬æ¡æ•°ç›¸ç­‰ï¼Œå¦‚æœè¾“å…¥æ˜¯ä¸€æ¡æ–‡æœ¬ï¼Œåˆ™b=1</li><li>ç¬¬å››ç»´ num_headsï¼šä»£è¡¨æ³¨æ„åŠ›å¤´çš„æ•°é‡ï¼Œä¾‹å¦‚æ¯å±‚æœ‰12ä¸ªå¤´ï¼Œåˆ™h=12</li><li>ç¬¬äº”ç»´seq_lenï¼šä»£è¡¨æˆªæ­¢åˆ°å½“å‰tokenä¸ºæ­¢çš„æ–‡æœ¬é•¿åº¦ï¼Œåœ¨æ¯ä¸€ä¸ªå†å²tokenä½ç½®ä¸Šè¯¥tokenåœ¨æ¯ä¸€å±‚æ¯ä¸ªå¤´ä¸‹çš„Keyï¼ŒValueä¿¡æ¯</li><li>ç¬¬å…­ç»´dï¼šä»£è¡¨Keyã€Valueå‘é‡çš„æ˜ å°„ç»´åº¦ï¼Œè‹¥tokenæ€»çš„æ˜ å°„ç»´åº¦ä¸º768ï¼Œæ³¨æ„åŠ›å¤´æ•°ä¸º12ï¼Œåˆ™d=768/12=64</li></ol><p>å¯ä»¥å‘ç°æ¯ä¸€æ­¥æ¨ç†åçš„å·®å¼‚ä»…ä»…äº§ç”Ÿåœ¨seq_lenè¿™ä¸ªç»´åº¦ä¸Š(seq_lenç»´åº¦å¤§å°ä¼šåŠ 1)ï¼Œå®ƒæ˜¯ç”±æ–°æ¨ç†çš„é‚£ä¸€ä¸ªtokenæ‰€å¯¹åº”çš„Keyï¼ŒValueæ‹¼æ¥åˆ°ä¸Šä¸€ä¸ªpast_key_valuesçš„seq_lenç»´åº¦ä¸­æ‰€å¯¼è‡´çš„ã€‚ä¾‹å¦‚ [12, 2, 1, 12, <strong>5</strong>, 64] -&gt; [12, 2, 1, 12,<strong>6</strong>, 64]</p><h2 id="kv-cacheå†…å­˜å ç”¨flopsä¸‹é™åˆ†æ">4KV-Cacheå†…å­˜å ç”¨ã€FLOPsä¸‹é™åˆ†æ</h2><h3 id="å†…å­˜å ç”¨">4.1 å†…å­˜å ç”¨</h3><p>KV-Cacheæœ¬è´¨ä¸Šæ˜¯<strong>ç”¨ç©ºé—´æ¢æ—¶é—´</strong>ï¼Œå­˜å‚¨çš„Keyã€ValueçŸ©é˜µä¼šé¢å¤–å ç”¨å†…å­˜ã€‚</p><p>å‡è®¾ä»¥float16ç²¾åº¦(å ç”¨ä¸¤ä¸ªå­—èŠ‚)æ¥å­˜å‚¨ï¼Œæ¯ä¸ªtokençš„å­˜å‚¨å ç”¨å…¬å¼å¦‚ä¸‹ï¼š<span class="math display">\[2 \times n_{layers} \times 2 \times n_{heads} \times d\]</span></p><p>ä»¥LLaMa-7B-FP16ä¸ºä¾‹ï¼Œæ¨¡å‹åŠ è½½å ç”¨æ˜¾å­˜14GBï¼Œå‘é‡ç»´åº¦4096ï¼Œå †å 32å±‚ï¼Œæœ€å¤§æ¨ç†æ­¥é•¿4096ã€‚è‹¥æ¨ç†ä¸€ä¸ªbatchä¸º2ï¼Œé•¿åº¦ä¸º4096çš„å¥å­ï¼ŒKV-Cacheå ç”¨çš„å­˜å‚¨ç©ºé—´ä¸º2Ã—2Ã—32Ã—4096Ã—2Ã—4096=4294967296å­—èŠ‚ï¼Œçº¦ç­‰äº4GBï¼Œéšç€æ¨ç†çš„batchå¢å¤§ï¼Œæ¨ç†é•¿åº¦å˜é•¿ï¼ŒKV-Cacheå ç”¨çš„å­˜å‚¨ç©ºé—´å¯èƒ½è¶…è¿‡æ¨¡å‹æœ¬èº«ã€‚</p><h3 id="flopsä¸‹é™">4.2 FLOPsä¸‹é™</h3><p>å¦ä¸€æ–¹é¢KV-Cacheæå¤§åœ°é™ä½äº†FLOPsï¼ˆæµ®ç‚¹è®¡ç®—é‡ï¼‰ï¼Œè¡¨é¢ä¸ŠKV-Cacheçœå»äº†ä¹‹å‰æ¯ä¸ªtokençš„Keyã€Valueçš„è®¡ç®—é‡ï¼Œæ¯ä¸ªtokenåœ¨æ‰€æœ‰å±‚ä¸‹è®¡ç®—Keyã€Valueçš„FLOPså…¬å¼å¦‚ä¸‹ï¼š<span class="math display">\[2 \times 2 \times n_{layers} \times  d^2\]</span></p><p>å…¶ä¸­då¹³æ–¹ä»£è¡¨ä»tokenEmbeddingåˆ°Keyæˆ–è€…Valueå‘é‡çš„è¿‡ç¨‹ï¼Œä¹˜ä»¥2æ˜¯çŸ©é˜µç›¸ä¹˜ä¸­é€ä½ç›¸ä¹˜å†ç›¸åŠ å¯¼è‡´æœ‰ä¸¤ä¸ªæ“ä½œï¼Œå†ä¹˜ä»¥2ä»£è¡¨Keyã€Valueå„ä¸€ä¸ªã€‚</p><p>ä»¥LLaMa-7Bä¸ºä¾‹ï¼Œæ¨ç†ä¸€ä¸ªbatchä¸º2ï¼Œé•¿åº¦ä¸º4096çš„å¥å­ï¼Œå…‰è®¡ç®—KVä¸€å…±èŠ‚çœäº†(2Ã—2Ã—32Ã—4096Ã—4096)Ã—4096Ã—2=17592BFLOPsçš„è®¡ç®—é‡</p><p>é¢å¤–çš„ï¼Œä¸ä»…çœå»äº†å‰æ–‡æ‰€æœ‰tokençš„Keyã€Valueçš„æ˜ å°„ï¼Œç”±æ­¤å¯¼è‡´åç»­è¿™äº›tokençš„æ³¨æ„åŠ›æƒé‡è®¡ç®—ï¼Œæ³¨æ„åŠ›çš„MLPå±‚ï¼ŒFFNå‰é¦ˆä¼ æ’­å±‚ä¹Ÿéƒ½ä¸éœ€è¦å†è®¡ç®—äº†ï¼Œç›¸å½“äºæ¨ç†é˜¶æ®µçš„è®¡ç®—å¤æ‚åº¦æ°¸è¿œç­‰äºåªå¯¹ä¸€ä¸ªtokenè¿›è¡Œå®Œæ•´çš„forwardæ¨ç†ï¼Œå› æ­¤è®¡ç®—é‡å¤§å¹…é™ä½ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>é‡‡æ ·</title>
      <link href="/2024/08/08/NLP/Sampling/"/>
      <url>/2024/08/08/NLP/Sampling/</url>
      
        <content type="html"><![CDATA[<h1 id="é‡‡æ ·sampling">é‡‡æ ·(Sampling)</h1><p>LLMåœ¨æ¨ç†æ—¶ï¼Œéœ€è¦å¯¹æ¨¡å‹è¾“å‡ºçš„æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œé‡‡æ ·ï¼Œä»¥å¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚å³åœ¨ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œéœ€è¦æ ¹æ®æ¦‚ç‡åˆ†å¸ƒé€‰æ‹©ä¸‹ä¸€ä¸ªè¯ã€‚</p><p>ä¾‹å¦‚ï¼šåœ¨æŸä¸€æ­¥çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">token1</span><span class="token punctuation">:</span> <span class="token number">0.4</span><span class="token key atrule">token2</span><span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token key atrule">token3</span><span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token key atrule">token4</span><span class="token punctuation">:</span> <span class="token number">0.1</span></code></pre><p>è¿™æ—¶åº”è¯¥æ ¹æ®ä»€ä¹ˆè§„åˆ™é€‰æ‹©ä¸‹ä¸€ä¸ªè¯å‘¢ï¼Ÿå¸¸ç”¨çš„é‡‡æ ·æ–¹æ³•æœ‰ï¼š</p><ol type="1"><li>è´ªå¿ƒé‡‡æ ·(Greedy Sampling)ï¼šé€‰æ‹©æ¦‚ç‡æœ€å¤§çš„è¯ä½œä¸ºä¸‹ä¸€ä¸ªè¯ã€‚<ol type="1"><li>ç®€å•é«˜æ•ˆ</li><li>å¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„æ–‡æœ¬è¿‡äºå•è°ƒå’Œé‡å¤</li></ol></li><li>éšæœºé‡‡æ ·(Random Sampling)ï¼šæ ¹æ®æ¦‚ç‡åˆ†å¸ƒéšæœºé€‰æ‹©ä¸‹ä¸€ä¸ªè¯ã€‚<ol type="1"><li>å¢åŠ ç”Ÿæˆçš„å¤šæ ·æ€§</li><li>ç”Ÿæˆçš„æ–‡æœ¬å¯èƒ½ä¸å¤Ÿè¿è´¯å’Œæ— æ„ä¹‰</li></ol></li><li>æŸæœç´¢(Beam Search)ï¼šç»´æŠ¤ä¸€ä¸ªå¤§å°ä¸º kçš„å€™é€‰åºåˆ—é›†åˆï¼Œæ¯ä¸€æ­¥ä»æ¯ä¸ªå€™é€‰åºåˆ—çš„æ¦‚ç‡åˆ†å¸ƒä¸­é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ kä¸ªå•è¯ï¼Œç„¶åä¿ç•™æ€»æ¦‚ç‡æœ€é«˜çš„ k ä¸ªå€™é€‰åºåˆ—ã€‚k=1æ—¶å³ä¸ºè´ªå¿ƒé‡‡æ ·ã€‚<ol type="1"><li>å¢åŠ æœç´¢ç©ºé—´ï¼Œå¹³è¡¡ç”Ÿæˆçš„è´¨é‡å’Œå¤šæ ·æ€§</li><li>å¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„æ–‡æœ¬ä¹‹é—´çš„ç›¸ä¼¼åº¦å¾ˆé«˜ï¼Œå¤šæ ·æ€§ä¸è¶³ï¼Œå¯¼è‡´è¿‡äºä¿å®ˆå’Œä¸è‡ªç„¶ã€‚</li></ol></li></ol><p>top-k é‡‡æ ·å’Œ top-pé‡‡æ ·æ˜¯ä»‹äºè´ªå¿ƒè§£ç å’Œéšæœºé‡‡æ ·ä¹‹é—´çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç›®å‰å¤§æ¨¡å‹è§£ç ç­–ç•¥ä¸­å¸¸ç”¨çš„æ–¹æ³•ã€‚</p><h2 id="top-ké‡‡æ ·">1 Top-ké‡‡æ ·</h2><p>åœ¨æ¯ä¸€æ­¥ï¼Œåªä»æ¦‚ç‡æœ€é«˜çš„ kä¸ªå•è¯ä¸­è¿›è¡Œéšæœºé‡‡æ ·ï¼Œè€Œä¸è€ƒè™‘å…¶ä»–ä½æ¦‚ç‡çš„å•è¯ã€‚ k=1æ—¶å³ä¸ºè´ªå¿ƒé‡‡æ ·ã€‚</p><p>Top-k é‡‡æ ·æ˜¯å¯¹å‰é¢â€œè´ªå¿ƒç­–ç•¥â€çš„ä¼˜åŒ–ï¼Œå®ƒä»æ’åå‰ k çš„ tokenä¸­è¿›è¡ŒæŠ½æ ·ï¼Œå…è®¸å…¶ä»–åˆ†æ•°æˆ–æ¦‚ç‡è¾ƒé«˜çš„token ä¹Ÿæœ‰æœºä¼šè¢«é€‰ä¸­ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œè¿™ç§æŠ½æ ·å¸¦æ¥çš„éšæœºæ€§æœ‰åŠ©äºæé«˜ç”Ÿæˆè´¨é‡ã€‚</p><ol type="1"><li>top-k ä¼˜ç‚¹ï¼š<ol type="1"><li>å¯ä»¥æ ¹æ®ä¸åŒçš„è¾“å…¥æ–‡æœ¬<strong>åŠ¨æ€è°ƒæ•´å€™é€‰å•è¯çš„æ•°é‡</strong>ï¼Œè€Œä¸æ˜¯å›ºå®šä¸ºkä¸ªã€‚ä¸åŒçš„è¾“å…¥æ–‡æœ¬å¯èƒ½ä¼šå¯¼è‡´ä¸åŒçš„æ¦‚ç‡åˆ†å¸ƒï¼Œæœ‰äº›åˆ†å¸ƒå¯èƒ½æ¯”è¾ƒå¹³å¦ï¼Œæœ‰äº›åˆ†å¸ƒå¯èƒ½æ¯”è¾ƒå°–é”ã€‚å¦‚æœåˆ†å¸ƒæ¯”è¾ƒå¹³å¦ï¼Œé‚£ä¹ˆå‰kä¸ªå•è¯å¯èƒ½éƒ½æœ‰ç›¸è¿‘çš„æ¦‚ç‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»ä¸­è¿›è¡Œéšæœºé‡‡æ ·ï¼›å¦‚æœåˆ†å¸ƒæ¯”è¾ƒå°–é”ï¼Œé‚£ä¹ˆå‰k ä¸ªå•è¯å¯èƒ½ä¼šå æ®ç»å¤§éƒ¨åˆ†æ¦‚ç‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è¿‘ä¼¼åœ°è¿›è¡Œè´ªå¿ƒè§£ç ã€‚</li><li>å¯ä»¥é€šè¿‡è°ƒæ•´ kçš„å¤§å°æ¥<strong>æ§åˆ¶ç”Ÿæˆçš„å¤šæ ·æ€§å’Œè´¨é‡</strong>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œkè¶Šå¤§ï¼Œç”Ÿæˆçš„å¤šæ ·æ€§è¶Šé«˜ï¼Œä½†æ˜¯ç”Ÿæˆçš„è´¨é‡è¶Šä½ï¼›kè¶Šå°ï¼Œç”Ÿæˆçš„è´¨é‡è¶Šé«˜ï¼Œä½†æ˜¯ç”Ÿæˆçš„å¤šæ ·æ€§è¶Šä½ã€‚</li><li><strong>å¯ä»¥ä¸å…¶ä»–è§£ç ç­–ç•¥ç»“åˆä½¿ç”¨</strong>ï¼Œä¾‹å¦‚æ¸©åº¦è°ƒèŠ‚ï¼ˆTemperatureScalingï¼‰ã€é‡å¤æƒ©ç½šï¼ˆRepetition Penaltyï¼‰ã€é•¿åº¦æƒ©ç½šï¼ˆLengthPenaltyï¼‰ç­‰ï¼Œæ¥è¿›ä¸€æ­¥ä¼˜åŒ–ç”Ÿæˆçš„æ•ˆæœã€‚</li></ol></li><li>top-k ç¼ºç‚¹ï¼š<ol type="1"><li>å¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„<strong>æ–‡æœ¬ä¸ç¬¦åˆå¸¸è¯†æˆ–é€»è¾‘</strong>ã€‚è¿™æ˜¯å› ä¸ºtop-ké‡‡æ ·<strong>åªè€ƒè™‘äº†å•è¯çš„æ¦‚ç‡</strong>ï¼Œè€Œæ²¡æœ‰è€ƒè™‘å•è¯ä¹‹é—´çš„è¯­ä¹‰å’Œè¯­æ³•å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¾“å…¥æ–‡æœ¬æ˜¯â€œæˆ‘å–œæ¬¢åƒâ€ï¼Œé‚£ä¹ˆå³ä½¿é¥ºå­çš„æ¦‚ç‡æœ€é«˜ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯æœ€åˆé€‚çš„é€‰æ‹©ï¼Œå› ä¸ºå¯èƒ½ç”¨æˆ·æ›´å–œæ¬¢åƒå…¶ä»–é£Ÿç‰©ã€‚</li><li>å¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„æ–‡æœ¬<strong>è¿‡äºç®€å•æˆ–æ— èŠ</strong>ã€‚è¿™æ˜¯å› ä¸º top-ké‡‡æ ·åªè€ƒè™‘äº†æ¦‚ç‡æœ€é«˜çš„ kä¸ªå•è¯ï¼Œè€Œæ²¡æœ‰è€ƒè™‘å…¶ä»–ä½æ¦‚ç‡ä½†æœ‰æ„ä¹‰æˆ–æœ‰åˆ›æ„çš„å•è¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¾“å…¥æ–‡æœ¬æ˜¯â€œæˆ‘å–œæ¬¢åƒâ€ï¼Œé‚£ä¹ˆå³ä½¿è‹¹æœã€é¥ºå­å’Œç«é”…éƒ½æ˜¯åˆç†çš„é€‰æ‹©ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯æœ€æœ‰è¶£æˆ–æœ€æƒŠå–œçš„é€‰æ‹©ï¼Œå› ä¸ºå¯èƒ½ç”¨æˆ·æ›´å–œæ¬¢åƒä¸€äº›ç‰¹åˆ«æˆ–æ–°å¥‡çš„é£Ÿç‰©ã€‚</li></ol></li></ol><p>å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè€ƒè™‘ top-k å’Œå…¶å®ƒç­–ç•¥ç»“åˆï¼Œæ¯”å¦‚ top-pã€‚</p><h2 id="top-pé‡‡æ ·">2 Top-pé‡‡æ ·</h2><p>top-k æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œé‚£å°±æ˜¯â€œkå€¼å–å¤šå°‘æ˜¯æœ€ä¼˜çš„ï¼Ÿâ€éå¸¸éš¾ç¡®å®šã€‚äºæ˜¯å‡ºç°äº†åŠ¨æ€è®¾ç½® tokenå€™é€‰åˆ—è¡¨å¤§å°ç­–ç•¥â€”â€”å³æ ¸é‡‡æ ·ï¼ˆNucleus Samplingï¼‰ã€‚</p><p>åœ¨æ¯ä¸€æ­¥ï¼Œåªä»ç´¯ç§¯æ¦‚ç‡è¶…è¿‡æŸä¸ªé˜ˆå€¼ pçš„æœ€å°å•è¯é›†åˆä¸­è¿›è¡Œéšæœºé‡‡æ ·ï¼Œè€Œä¸è€ƒè™‘å…¶ä»–ä½æ¦‚ç‡çš„å•è¯ã€‚å³åªè€ƒè™‘å‰ pçš„æ¦‚ç‡çš„å•è¯ã€‚ è¿™ç§æ–¹æ³•ä¹Ÿè¢«ç§°ä¸ºæ ¸é‡‡æ ·ï¼ˆnucleussamplingï¼‰ï¼Œå› ä¸ºå®ƒåªå…³æ³¨æ¦‚ç‡åˆ†å¸ƒçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œè€Œå¿½ç•¥äº†å°¾éƒ¨éƒ¨åˆ†ã€‚</p><h2 id="æ¸©åº¦è°ƒèŠ‚">3 æ¸©åº¦è°ƒèŠ‚</h2><p>æ¸©åº¦è°ƒèŠ‚ï¼ˆTemperatureScalingï¼‰æ˜¯ä¸€ç§ç®€å•æœ‰æ•ˆçš„è§£ç ç­–ç•¥ï¼Œå®ƒå¯ä»¥é€šè¿‡è°ƒæ•´æ¸©åº¦å‚æ•°æ¥æ§åˆ¶ç”Ÿæˆçš„å¤šæ ·æ€§å’Œè´¨é‡ã€‚</p><p>å®ç°ä¸»è¦æ˜¯å°† logits é™¤ä»¥æ¸©åº¦æ¥å®ç°æ¸©åº¦é‡‡æ ·ï¼Œç„¶åå°†å…¶è¾“å…¥ Softmaxå¹¶è·å¾—é‡‡æ ·æ¦‚ç‡ã€‚</p><p>temperatureè¿™ä¸ªå‚æ•°å¯ä»¥å‘Šè¯‰æœºå™¨å¦‚ä½•åœ¨è´¨é‡å’Œå¤šæ ·æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚è¾ƒä½çš„ temperature æ„å‘³ç€æ›´é«˜çš„è´¨é‡ï¼Œè€Œè¾ƒé«˜çš„ temperatureæ„å‘³ç€æ›´é«˜çš„å¤šæ ·æ€§ã€‚ å½“ temperatureè®¾ç½®ä¸ºé›¶æ—¶ï¼Œæ¨¡å‹æ€»æ˜¯ä¼šé€‰æ‹©å…·æœ‰æœ€é«˜å¯èƒ½æ€§åˆ†æ•°çš„tokenï¼Œä»è€Œå¯¼è‡´æ¨¡å‹ç”Ÿæˆçš„å›å¤ç¼ºä¹å¤šæ ·æ€§ï¼Œä½†å´èƒ½ç¡®ä¿æ€»æ˜¯é€‰æ‹©æ¨¡å‹è¯„ä¼°å‡ºçš„æœ€é«˜è´¨é‡çš„tokenæ¥ç”Ÿæˆå›å¤ã€‚å½“ temperatureè®¾ç½®ä¸ºè¾ƒå¤§æ—¶ï¼Œæ¦‚ç‡åˆ†å¸ƒè¶‹å‘äº<strong>å‡åŒ€åˆ†å¸ƒ</strong>ï¼Œä»è€Œå¯¼è‡´æ¨¡å‹ç”Ÿæˆçš„å›å¤å…·æœ‰æ›´é«˜çš„å¤šæ ·æ€§ï¼Œä½†å´å¯èƒ½å¯¼è‡´ç”Ÿæˆçš„å›å¤è´¨é‡è¾ƒä½ã€‚</p><h2 id="è”åˆé‡‡æ ·">4 è”åˆé‡‡æ ·</h2><p>é€šå¸¸å°† top-kã€ top-p å’Œ temperatureç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œä»¥è·å¾—æ›´å¥½çš„ç”Ÿæˆæ•ˆæœã€‚</p><p>ä½¿ç”¨çš„é¡ºåºä¸€èˆ¬æ˜¯ top-k -&gt; top-p -&gt; temperature</p><p>ä¾‹å¦‚å¯¹äºä¸Šé¢çš„ä¾‹å­:</p><ol type="1"><li>å…ˆæ ¹æ® top-k = 3 é‡‡æ ·ï¼Œå¾—åˆ°å€™é€‰è¯é›†åˆ<code>{token1: 0.4, token2: 0.3, token3: 0.2}</code></li><li>å†æ ¹æ® top-p = 0.8 é‡‡æ ·ï¼Œå¾—åˆ°å€™é€‰è¯é›†åˆ<code>{token1: 0.4, token2: 0.3}</code></li><li>æœ€åæ ¹æ® temperature = 0.7 å½’ä¸€åŒ–ï¼Œå¾—åˆ°å€™é€‰è¯é›†åˆ<code>{token1: 0.54, token2: 0.46}</code></li><li>æ ¹æ®æ¦‚ç‡åˆ†å¸ƒ<strong>éšæœº</strong>é€‰æ‹©ä¸‹ä¸€ä¸ªè¯ï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚</li></ol><h2 id="æƒ©ç½šæœºåˆ¶">5 æƒ©ç½šæœºåˆ¶</h2><p>é¢‘ç‡æƒ©ç½šï¼ˆfrequencypenaltyï¼‰ï¼šä¸€ç§æŠ‘åˆ¶é‡å¤ç”Ÿæˆçš„æœºåˆ¶ã€‚å®ƒé€šè¿‡å¯¹å·²ç»ç”Ÿæˆçš„è¯è¯­åœ¨ä¸‹ä¸€æ¬¡ç”Ÿæˆæ—¶è¿›è¡Œæƒ©ç½šæ¥å‡å°‘æŸäº›è¯çš„é‡å¤å‡ºç°ã€‚å­˜åœ¨æƒ©ç½šï¼ˆpresencepenaltyï¼‰ï¼šå­˜åœ¨æƒ©ç½šä¸é¢‘ç‡æƒ©ç½šç±»ä¼¼ï¼Œä½†å®ƒåªå…³å¿ƒè¯è¯­æ˜¯å¦å·²ç»å‡ºç°è¿‡ï¼Œè€Œä¸å…³å¿ƒå‡ºç°çš„æ¬¡æ•°ã€‚å­˜åœ¨æƒ©ç½šé€šè¿‡å‡å°‘å·²ç»å‡ºç°è¿‡çš„è¯è¯­çš„æ¦‚ç‡ï¼Œé¼“åŠ±ç”Ÿæˆæ–°çš„è¯è¯­ï¼Œè€Œä¸ä¼šæ˜æ˜¾æŠ‘åˆ¶å¸¸ç”¨è¯çš„é‡å¤ã€‚</p><p>temperatureå‚æ•°é€šè¿‡åœ¨tokené€‰æ‹©è¿‡ç¨‹ä¸­æ·»åŠ éšæœºæ€§æ¥å®ç°è¾“å‡ºå†…å®¹çš„å¤šæ ·æ€§ï¼Œè€Œé¢‘ç‡æƒ©ç½šå’Œå­˜åœ¨æƒ©ç½šåˆ™é€šè¿‡å¯¹å·²åœ¨æ–‡æœ¬ä¸­å‡ºç°çš„tokenæ–½åŠ æƒ©ç½šä»¥å¢åŠ è¾“å‡ºå†…å®¹çš„å¤šæ ·æ€§ã€‚è¿™ä½¿å¾—å¯¹æ—§çš„å’Œè¿‡åº¦ä½¿ç”¨çš„tokenè¿›è¡Œé€‰æ‹©å˜å¾—ä¸å¤ªå¯èƒ½ï¼Œä»è€Œè®©æ¨¡å‹é€‰æ‹©æ›´æ–°é¢–çš„tokenã€‚</p><p>å°±åƒ temperatureä¸€æ ·ï¼Œé¢‘ç‡æƒ©ç½šå’Œå­˜åœ¨æƒ©ç½šä¼šå¼•å¯¼æˆ‘ä»¬è¿œç¦»â€œæœ€ä½³çš„â€å¯èƒ½å›å¤ï¼Œæœç€æ›´æœ‰åˆ›æ„çš„æ–¹å‘å‰è¿›ã€‚ç„¶è€Œï¼Œå®ƒä»¬ä¸åƒtemperatureé‚£æ ·é€šè¿‡å¼•å…¥éšæœºæ€§ï¼Œè€Œæ˜¯é€šè¿‡ç²¾å¿ƒè®¡ç®—çš„é’ˆå¯¹æ€§æƒ©ç½šï¼Œä¸ºæ¨¡å‹ç”Ÿæˆå†…å®¹å¢æ·»å¤šæ ·æ€§ã€‚åœ¨ä¸€äº›ç½•è§çš„ã€éœ€è¦éé›¶temperatureçš„ä»»åŠ¡ä¸­ï¼ˆéœ€è¦å¯¹åŒä¸€ä¸ªæç¤ºè¯­ç»™å‡ºå¤šä¸ªç­”æ¡ˆæ—¶ï¼‰ï¼Œå¯èƒ½è¿˜éœ€è¦è€ƒè™‘å°†å°çš„é¢‘ç‡æƒ©ç½šæˆ–å­˜åœ¨æƒ©ç½šåŠ å…¥å…¶ä¸­ï¼Œä»¥æé«˜åˆ›é€ æ€§ã€‚ä½†æ˜¯ï¼Œå¯¹äºåªæœ‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆä¸”ä½ å¸Œæœ›ä¸€æ¬¡æ€§æ‰¾åˆ°åˆç†å›å¤çš„æç¤ºè¯­ï¼Œå½“ä½ å°†æ‰€æœ‰è¿™äº›å‚æ•°è®¾ä¸ºé›¶æ—¶ï¼ŒæˆåŠŸçš„å‡ ç‡å°±ä¼šæœ€é«˜ã€‚</p><h2 id="å‚æ•°è°ƒæ•´">6 å‚æ•°è°ƒæ•´</h2><h3 id="åªå­˜åœ¨ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ">1. åªå­˜åœ¨ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">temperature</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token key atrule">frequency_penalty</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token key atrule">presence_penalty</span><span class="token punctuation">:</span> <span class="token number">0.0</span></code></pre><h3 id="éœ€è¦åˆ›é€ æ€§æˆ–è€…å¤šæ ·æ€§">2. éœ€è¦åˆ›é€ æ€§æˆ–è€…å¤šæ ·æ€§</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">temperature</span><span class="token punctuation">:</span> å¢åŠ <span class="token key atrule">frequency_penalty</span><span class="token punctuation">:</span> å¢åŠ <span class="token key atrule">presence_penalty</span><span class="token punctuation">:</span> å¢åŠ </code></pre><p>å½“æ¨¡å‹è¾“å‡ºæ— æ„ä¹‰å†…å®¹æˆ–è€…èƒ¡è¨€ä¹±è¯­æ—¶ï¼Œéœ€è¦é™ä½<code>temperature top-k top-p</code>å¦‚æœæ¨¡å‹è¾“å‡ºçš„å†…å®¹çœ‹èµ·æ¥é›¶æ•£å¹¶ä¸”è¯é¢˜å˜åŒ–å¤ªå¿«ï¼Œåº”å½“é™ä½<code>presence_penalty</code>å¦‚æœæœ‰å¤ªå¤šæ–°å¥‡å’Œä¸å¯»å¸¸çš„è¯è¯­ï¼Œæˆ–è€…å­˜åœ¨æƒ©ç½šè®¾ç½®ä¸ºé›¶ä½†ä»ç„¶å­˜åœ¨å¾ˆå¤šè¯é¢˜å˜åŒ–ï¼Œåº”å½“é™ä½<code>frequency_penalty</code></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Transformer</title>
      <link href="/2024/08/08/NLP/Transformer/"/>
      <url>/2024/08/08/NLP/Transformer/</url>
      
        <content type="html"><![CDATA[<h1 id="transformer">Transformer</h1><h2 id="æ¨¡å‹æ¦‚è¿°">1. æ¨¡å‹æ¦‚è¿°</h2><p>Transformeræ˜¯ä¸€ç§ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰å’Œå…¶ä»–åºåˆ—åˆ°åºåˆ—ï¼ˆsequence-to-sequenceï¼‰ä»»åŠ¡çš„æ·±åº¦å­¦ä¹ æ¨¡å‹æ¶æ„ï¼Œå®ƒåœ¨2017å¹´ç”±Vaswaniç­‰äººé¦–æ¬¡æå‡ºã€‚Transformeræ¶æ„å¼•å…¥äº†è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆself-attentionmechanismï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³é”®çš„åˆ›æ–°ï¼Œä½¿å…¶åœ¨å¤„ç†åºåˆ—æ•°æ®æ—¶è¡¨ç°å‡ºè‰²ã€‚</p><h3 id="åŸºæœ¬ç»“æ„">1.1 åŸºæœ¬ç»“æ„</h3><p>transformeråŸºæœ¬æ¨¡å‹å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ¨¡å‹çš„å·¦åŠè¾¹Encoderéƒ¨åˆ†å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç¼–ç å™¨ï¼Œå³åŠè¾¹Decoderéƒ¨åˆ†å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè§£ç å™¨ï¼Œå…¶ä¸­ç¼–ç å™¨æ˜¯åŒå‘çš„ï¼Œè§£ç å™¨æ˜¯å•å‘çš„éœ€è¦å¾ªç¯è¿­ä»£è¾“å‡ºã€‚</p><figure><img src="./images/Transformer_Structure.webp"alt="transformeråŸºæœ¬ç»“æ„" /><figcaption aria-hidden="true">transformeråŸºæœ¬ç»“æ„</figcaption></figure><h3 id="ç‰¹ç‚¹ä¸åˆ›æ–°">1.2 ç‰¹ç‚¹ä¸åˆ›æ–°</h3><ol type="1"><li>è®­ç»ƒå¹¶è¡Œ: å³æ‰€æœ‰å­—æ˜¯åŒæ—¶è®­ç»ƒçš„ï¼Œè¿™æ ·å°±å¤§å¤§å¢åŠ äº†è®¡ç®—æ•ˆç‡</li><li>è‡ªæ³¨æ„åŠ›æœºåˆ¶:æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå®ƒä½¿æ¨¡å‹èƒ½å¤ŸåŒæ—¶è€ƒè™‘è¾“å…¥åºåˆ—ä¸­çš„æ‰€æœ‰ä½ç½®ï¼Œè€Œä¸æ˜¯åƒå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æˆ–å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ä¸€æ ·é€æ­¥å¤„ç†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹æ ¹æ®è¾“å…¥åºåˆ—ä¸­çš„ä¸åŒéƒ¨åˆ†æ¥èµ‹äºˆä¸åŒçš„æ³¨æ„æƒé‡ï¼Œä»è€Œæ›´å¥½åœ°æ•æ‰è¯­ä¹‰å…³ç³»ã€‚</li><li>å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-HeadAttentionï¼‰ï¼šè‡ªæ³¨æ„åŠ›æœºåˆ¶è¢«æ‰©å±•ä¸ºå¤šä¸ªæ³¨æ„åŠ›å¤´ï¼Œæ¯ä¸ªå¤´å¯ä»¥å­¦ä¹ ä¸åŒçš„æ³¨æ„æƒé‡ï¼Œä»¥æ›´å¥½åœ°æ•æ‰ä¸åŒç±»å‹çš„å…³ç³»ã€‚å¤šå¤´æ³¨æ„åŠ›å…è®¸æ¨¡å‹å¹¶è¡Œå¤„ç†ä¸åŒçš„ä¿¡æ¯å­ç©ºé—´ã€‚</li><li>å †å å±‚ï¼ˆStackedLayersï¼‰ï¼šTransformeré€šå¸¸ç”±å¤šä¸ªç›¸åŒçš„ç¼–ç å™¨å’Œè§£ç å™¨å±‚å †å è€Œæˆã€‚è¿™äº›å †å çš„å±‚æœ‰åŠ©äºæ¨¡å‹å­¦ä¹ å¤æ‚çš„ç‰¹å¾è¡¨ç¤ºå’Œè¯­ä¹‰ã€‚</li><li>ä½ç½®ç¼–ç ï¼ˆPositionalEncodingï¼‰ï¼šç”±äºTransformeræ²¡æœ‰å†…ç½®çš„åºåˆ—ä½ç½®ä¿¡æ¯ï¼Œå®ƒéœ€è¦é¢å¤–çš„ä½ç½®ç¼–ç æ¥è¡¨è¾¾è¾“å…¥åºåˆ—ä¸­å•è¯çš„ä½ç½®é¡ºåºã€‚</li><li>æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–ï¼ˆResidual Connections and LayerNormalizationï¼‰ï¼šè¿™äº›æŠ€æœ¯æœ‰åŠ©äºå‡è½»è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸é—®é¢˜ï¼Œä½¿æ¨¡å‹æ›´å®¹æ˜“è®­ç»ƒã€‚</li><li>ç¼–ç å™¨å’Œè§£ç å™¨ï¼šTransformeré€šå¸¸åŒ…æ‹¬ä¸€ä¸ªç¼–ç å™¨ç”¨äºå¤„ç†è¾“å…¥åºåˆ—å’Œä¸€ä¸ªè§£ç å™¨ç”¨äºç”Ÿæˆè¾“å‡ºåºåˆ—ï¼Œè¿™ä½¿å…¶é€‚ç”¨äºåºåˆ—åˆ°åºåˆ—çš„ä»»åŠ¡ï¼Œå¦‚æœºå™¨ç¿»è¯‘ã€‚</li></ol><h2 id="æ¨¡å‹ç»†èŠ‚">2. æ¨¡å‹ç»†èŠ‚</h2><h3 id="ç¼–ç å™¨encoder">2.1 ç¼–ç å™¨(Encoder)</h3><figure><img src="./images/Transformer_Encoder.webp" alt="ç¼–ç å™¨" /><figcaption aria-hidden="true">ç¼–ç å™¨</figcaption></figure><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[ç¼–ç å™¨] --&gt; B[è¾“å…¥éƒ¨åˆ† ï¼ˆEmbeddingï¼‰]    A --&gt; C[æ³¨æ„åŠ›æœºåˆ¶ ï¼ˆSelf-attentionï¼‰]    A --&gt; D[å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ ï¼ˆMulti-head Attentionï¼‰]    A --&gt; E[æ®‹å·®è¿æ¥ ResNet ï¼ˆResidual Networkï¼‰]    A --&gt; F[å±‚æ ‡å‡†åŒ– LNï¼ˆLayer Normalizationï¼‰]    A --&gt; G[å‰é¦ˆå‹ç¥ç»ç½‘ç»œ FFN ï¼ˆFeed Forward Networkï¼‰]  </pre></div><h4 id="è¾“å…¥éƒ¨åˆ†embedding">2.1.1 è¾“å…¥éƒ¨åˆ†ï¼ˆEmbeddingï¼‰</h4><p>ä¸ºäº†èƒ½å¤ŸæŠŠæ–‡æœ¬æ•°æ®æˆ–éŸ³é¢‘æ•°æ®è¾“å…¥è¿›Transformerè¿™ä¸ªé»‘ç›’å­é‡Œé¢å¤„ç†ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆé€šè¿‡Embeddingå°†å…¶è½¬æ¢æˆç¼–ç æ ‡è¯†ï¼Œä½¿å…¶æˆä¸ºè®¡ç®—æœºèƒ½å¤Ÿå¤„ç†çš„æ•°å­—ã€‚</p><p>åœ¨ç†è§£Embeddingå±‚ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨äºæ–‡æœ¬æ•°æ®çš„ç‰¹ç‚¹ï¼Œä¸¾ä¾‹ï¼šâ€œæˆ‘çˆ±åŒ—äº¬å¤©å®‰é—¨â€ï¼Œæˆ‘ä»¬åœ¨åšæ–‡æœ¬æ•°æ®å¤„ç†å¾—æ—¶å€™ï¼Œä¼ ç»Ÿçš„æ±‰å­—æ˜¯ä¸èƒ½ç»™è®¡ç®—æœºåšè¿ç®—çš„ï¼Œä¸ºäº†è§£å†³æ±‰å­—è¿ç®—çš„é—®é¢˜ï¼Œæå‡ºäº†å°†æ±‰å­—è¿›è¡Œç¼–ç ï¼ˆæˆ–å«æ–‡æœ¬å¼ é‡è¡¨ç¤ºï¼‰çš„æ€æƒ³ã€‚ç›®å‰ä¸»æµçš„ç¼–ç æ–¹å¼æœ‰one-hotç¼–ç åŠwordEmbeddingã€‚</p><h5 id="a.-one-hotç¼–ç ">a. One-hotç¼–ç </h5><p>è¯¥ç¼–ç æ ¼å¼è¾ƒä¸ºå‚»ç“œå¼ï¼Œå°±æ˜¯å°†è¯åº“ä¸­æ‰€æœ‰çš„å•è¯ï¼Œä»[0,max_len-1]çš„è¿›è¡Œç¼–å·ï¼Œä½¿ç”¨å“ªä¸ªè¯å¯¹åº”çš„ç¼–å·ä½ç½®éƒ¨åˆ†ç½®1ï¼Œå…¶ä½™éƒ¨åˆ†ç½®0ã€‚</p><h5 id="b.-word2vecç¼–ç ">b. word2vecç¼–ç </h5><p>word tovecï¼Œå³æ–‡æœ¬æ¨å¯¼å¼ é‡ï¼Œå­˜åœ¨ä¸¤ä¸ªæ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯CBOWï¼Œä¸€ä¸ªæ˜¯skipgram</p><ul><li>CBOWç±»ä¼¼äºæˆ‘ä»¬åœ¨è‹±æ–‡è€ƒè¯•ä¸­çš„å®Œå½¢å¡«ç©ºï¼Œå³æ ¹æ®ä¸Šä¸‹æ–‡æ¨å¯¼ä¸­é—´çš„å•è¯</li><li>skipgramä¸ä¹‹ç›¸åï¼Œé€šè¿‡æŸä¸ªå•è¯ï¼Œæ¨å¯¼ä¸Šä¸‹æ–‡ï¼Œè®¡ç®—æœºå¤æ‚åº¦æ›´å¤§</li></ul><h5 id="c.-ä½ç½®ç¼–ç ">c.Â ä½ç½®ç¼–ç </h5><p>åœ¨Transformerä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯å‘é‡å’Œä½ç½®å‘é‡è¿›è¡Œå åŠ ï¼Œè¿™æ ·æ‰èƒ½å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„è¯åµŒå…¥ã€‚ä½ç½®ç¼–ç çš„ä½œç”¨å°±æ˜¯ä¸ºäº†ç»™è¯å‘é‡åŠ ä¸Šä½ç½®ä¿¡æ¯ï¼Œä½¿å¾—è¯å‘é‡åœ¨ç©ºé—´ä¸­çš„ä½ç½®ä¸åŒï¼Œä»è€Œä½¿å¾—æ¨¡å‹èƒ½å¤ŸåŒºåˆ†ä¸åŒä½ç½®çš„è¯ã€‚</p><figure><img src="./images/Transformer_PositionalEncoding.webp"alt="ä½ç½®ç¼–ç " /><figcaption aria-hidden="true">ä½ç½®ç¼–ç </figcaption></figure><h5 id="å…·ä½“ä¾‹å­">å…·ä½“ä¾‹å­</h5><p>Transformerçš„è¾“å…¥éƒ¨åˆ†å…¶å®å°±æ˜¯<strong><em>è¯å‘é‡</em></strong> å’Œ<strong><em>ä½ç½®å‘é‡</em></strong>çš„å åŠ ï¼šæ¯”å¦‚ä¸‹é¢ä¸€å¥è¯â€æˆ‘æœ‰ä¸€åªçŒ«â€ï¼Œç»è¿‡åˆ†è¯ä¹‹åçš„å¾—åˆ°çš„tokenæ˜¯<code>æˆ‘</code><code>æœ‰</code> <code>ä¸€åª</code> <code>çŒ«</code>ï¼Œé‚£ä¹ˆ<code>æˆ‘</code><code>æœ‰</code> <code>ä¸€åª</code> <code>çŒ«</code> çš„<strong><em>è¯å‘é‡</em></strong> å’Œ<strong><em>ä½ç½®å‘é‡</em></strong>çš„å åŠ åçš„å‘é‡å†æ”¾åœ¨ä¸€èµ·ç»„æˆçš„çŸ©é˜µå°±æ˜¯è¿™å¥è¯çš„<strong><em>è¯åµŒå…¥</em></strong></p><p><img src="./images/Transformer_WordEmbedding.webp" alt="è¯åµŒå…¥" /><img src="./images/Transformer_WordEmbedding2.webp" alt="è¯åµŒå…¥" /></p><h4 id="æ³¨æ„åŠ›æœºåˆ¶self-attention">2.1.2æ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-attentionï¼‰</h4><p>åœ¨æ‹¿åˆ°ä¸€ä¸ªEmbeddingçš„å‘é‡åï¼Œæˆ‘ä»¬ä¸‹ä¸€æ­¥è¦åšçš„äº‹å°±æ˜¯åˆ©ç”¨Self-Attentionæœºåˆ¶å»è®¡ç®—ä¸åŒå•è¯ä¹‹é—´è¯å‘é‡çš„ç›¸ä¼¼åº¦</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹KTransformers</title>
      <link href="/2024/08/08/NLP/LLMModels/KTransformers/"/>
      <url>/2024/08/08/NLP/LLMModels/KTransformers/</url>
      
        <content type="html"><![CDATA[<h1 id="ktransformers">KTransformers</h1><p>KTransformers KTransformers æ˜¯ä¸€ä¸ªçµæ´»çš„ã€ä»¥ Pythonä¸ºä¸­å¿ƒçš„æ¡†æ¶ï¼Œæ—¨åœ¨é€šè¿‡é«˜çº§å†…æ ¸ä¼˜åŒ–å’Œæ”¾ç½®/å¹¶è¡Œç­–ç•¥å¢å¼º transformers</p><p><ahref="https://github.com/kvcache-ai/KTransformers">KTransformersçš„Githubé“¾æ¥</a><a href="https://github.com/deepseek-ai/DeepSeek-V2">DeepSeekV2çš„Githubé“¾æ¥</a> <a href="https://arxiv.org/abs/2405.04434">DeepSeekV2çš„è®ºæ–‡é“¾æ¥</a></p><h2 id="ä»‹ç»">1. ä»‹ç»</h2><p>KTransformers çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„ã€åŸºäºæ¨¡æ¿çš„æ³¨å…¥æ¡†æ¶ã€‚</p><figure><img src="./images/InjectStruction.webp#60x60"title="å›¾1ï¼šKTransformers æ¶æ„" alt="KTransformers æ¶æ„" /><figcaption aria-hidden="true">KTransformers æ¶æ„</figcaption></figure><h2 id="ä¼˜åŒ–æŠ€æœ¯">2. ä¼˜åŒ–æŠ€æœ¯</h2><p>KTransformersé‡‡ç”¨äº†å¤šç§ä¼˜åŒ–æŠ€æœ¯ï¼Œå°†éœ€è¦ä¸¤å—80GBæ˜¾å­˜GPUçš„ DeepSeek-V2Q4_k_m æ¨¡å‹è¿è¡Œåœ¨21GBæ˜¾å­˜å’Œ136GBå†…å­˜çš„å°å¼è®¡ç®—æœºä¸Šã€‚</p><h3 id="mla-æ³¨æ„åŠ›æœºåˆ¶">2.1 MLA æ³¨æ„åŠ›æœºåˆ¶</h3><p>DeepSeek V2 çš„ MLAå®˜æ–¹å¼€æºæ˜ç¡®åœ°è§£å‹äº†MLAçš„å‹ç¼©è¡¨ç¤ºï¼Œå¹¶ç¼“å­˜äº†è§£å‹åçš„é”®å€¼å¯¹ã€‚é’ˆå¯¹æ­¤ï¼ŒKTransformerså¯¹DeepSeek V2 çš„MLAæŒ‰ç…§åŸæ–‡è¿›è¡Œäº†å®ç°ï¼Œå°†è§£å‹ç¼©çŸ©é˜µç›´æ¥å¸æ”¶åˆ° q_proj å’Œout_proj æƒé‡ä¸­ï¼Œå‡å°‘äº† KVç¼“å­˜å¤§å°å¹¶å¢åŠ äº†è¯¥ç®—å­çš„ç®—åŠ›å¼ºåº¦ï¼Œä»è€Œå¤§å¤§ä¼˜åŒ–äº† GPUè®¡ç®—èƒ½åŠ›çš„åˆ©ç”¨ç‡ã€‚</p><figure><img src="./images/DeepSeek-on-KTransformers.webp#100x100"title="å›¾2ï¼šå®ç°åçš„MLA æ¶æ„" alt="å®ç°åçš„MLA æ¶æ„" /><figcaption aria-hidden="true">å®ç°åçš„MLA æ¶æ„</figcaption></figure><h4 id="deepseek-v2-çš„mla">2.1.1 DeepSeek V2 çš„MLA</h4><p>DeepSeek V2 è®¾è®¡äº†MLAï¼Œå®ƒåˆ©ç”¨ä½ç§©é”®å€¼è”åˆå‹ç¼©æ¥æ¶ˆé™¤æ¨ç†æ—¶é—´é”®å€¼ç¼“å­˜çš„ç“¶é¢ˆï¼Œä»è€Œæ”¯æŒæœ‰æ•ˆçš„æ¨ç†ã€‚</p><figure><img src="./images/deepseekv2.webp#80x80" title="å›¾3ï¼šDeepSeek MLA æ¶æ„"alt="DeepSeek MLA æ¶æ„" /><figcaption aria-hidden="true">DeepSeek MLA æ¶æ„</figcaption></figure><h5 id="mlaçš„æå‡º">2.1.1.1 MLAçš„æå‡º</h5><p>MLAçš„æ ¸å¿ƒæ˜¯å¯¹é”®å’Œå€¼è¿›è¡Œä½ç§©è”åˆå‹ç¼©ï¼Œä»¥å‡å°‘KVç¼“å­˜:</p><figure><img src="./images/dsattn.webp#100x100" title="å›¾4ï¼šMLA æ¶æ„"alt="MLA æ¶æ„" /><figcaption aria-hidden="true">MLA æ¶æ„</figcaption></figure><p>Attentionçš„è®¡ç®—å…¬å¼ä¸º<span class="math inline">\(A =\text{softmax}(\frac{QK^T}{\sqrt{d_k}})V\)</span>ï¼Œå…¶ä¸­<spanclass="math inline">\(Q,K,V\)</span>åˆ†åˆ«ä¸ºæŸ¥è¯¢ã€é”®ã€å€¼ï¼Œ<spanclass="math inline">\(d_k\)</span>ä¸ºé”®çš„ç»´åº¦ã€‚</p><p>å‡å®šè¾“å…¥æ˜¯<span class="math inline">\(x\)</span>ï¼Œå¯¹<spanclass="math inline">\(x\)</span>åšä¸€ä¸ªä½ç§©è½¬æ¢ï¼š</p><p><span class="math display">\[\begin{aligned}    \textcolor{red}{c} &amp;= xW^C \quad W^C \in\mathbb{R}^{d_{\text{model}} \times d_c} \quad x \in \mathbb{R}^{n\times d_{\text{model}}}\end{aligned}\]</span></p><p>æ¥ç€è®¡ç®—<strong>æ¯ä¸€ä¸ªhead</strong>çš„<spanclass="math inline">\(Q,K,V\)</span>ï¼š</p><p><span class="math display">\[\begin{aligned}    Q &amp;= xW^Q \quad W^Q \in \mathbb{R}^{d_{\text{model}} \timesd_k}\\    K &amp;= xW^K = \textcolor{red}{c}W^{K&#39;}  \quad W^K \in\mathbb{R}^{d_{\text{model}} \times d_k} \quad W^{K&#39;} \in\mathbb{R}^{d_{\textcolor{red}{c}} \times d_k}\\    V &amp;= xW^V = \textcolor{red}{c}W^{V&#39;} \quad W^V \in\mathbb{R}^{d_{\text{model}} \times d_v} \quad W^{V&#39;} \in\mathbb{R}^{d_{\textcolor{red}{c}} \times d_v}\\    QK^T &amp;= xW^Q(\textcolor{red}{c}W^{K&#39;})^T =x(W^QW^{K&#39;T})\textcolor{red}{c}^T\end{aligned}\]</span></p><p>æ­¤æ—¶å¦‚æœæœ‰<spanclass="math inline">\(W^{Q&#39;}=W^QW^{K&#39;T}\)</span>(<strong>ä¼šä¸ä¼šæœ‰ç²¾åº¦æŸå¤±ï¼Ÿ</strong>)ä¸” <span class="math inline">\(W^{Q&#39;} \in\mathbb{R}^{d_{\text{model}} \times d_c}\)</span>ï¼Œåˆ™<spanclass="math inline">\(QK^T=xW^{Q&#39;}\textcolor{red}{c}^T\)</span>ï¼Œåœ¨æ¨ç†è¿‡ç¨‹ä¸­ä¸éœ€è¦å†ç¼“å­˜<code>K</code><code>V</code> çŸ©é˜µï¼Œåªéœ€è¦ç¼“å­˜ <spanclass="math inline">\(\textcolor{red}{c}\)</span> çŸ©é˜µï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}A &amp;= \text{softmax}(\frac{QK^T}{\sqrt{d_k}})V \\&amp;=\text{softmax}(\frac{xW^{Q&#39;}\textcolor{red}{c}^T}{\sqrt{d_k}}){\textcolor{red}{c}W^{V&#39;}}\\\end{aligned}\]</span></p><p><strong><spanclass="math inline">\(\textcolor{red}{æ³¨æ„}\)</span></strong>ï¼šè¿™é‡Œçš„<spanclass="math inline">\(\textcolor{red}{c}\)</span>æ˜¯ä»<spanclass="math inline">\(x\)</span>å¾—åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¯ä¸€ä¸ªLayerï¼Œæ‰€æœ‰çš„Attention-Headä½¿ç”¨çš„éƒ½æ˜¯ä¸€ä¸ªåŒæ ·çš„<spanclass="math inline">\(\textcolor{red}{c}\)</span>ï¼Œè€Œä¸æ˜¯æ¯ä¸ªHeadéƒ½ä½¿ç”¨ä¸åŒçš„<code>K</code><code>V</code>çŸ©é˜µã€‚å‚æ•°ä»<span class="math inline">\(2 \timeshead\)</span> å˜ä¸ºäº† <spanclass="math inline">\(\textcolor{red}{1}\)</span>ã€‚</p><p>ä»ä¸Šé¢çš„å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œ<strong>MLAå®é™…ä¸Šæ˜¯ä¸€ä¸ªMHAï¼Œä½†æ˜¯KV_Cacheå ç”¨ç”šè‡³å°‘äºGQA</strong>ã€‚å†æ¬¡å›é¡¾å›¾3ï¼Œå¯ä»¥æ¸…æ™°çœ‹å‡ºåŒºåˆ«ã€‚</p><p>å…¶ä¸­<span class="math inline">\(d_{\textcolor{red}{c}}\)</span>æ˜¯è¶…å‚æ•°ï¼Œ<span class="math inline">\(d_{\text{model}}\)</span>æ˜¯æ¨¡å‹ç»´åº¦ï¼Œ<span class="math inline">\(d_k\)</span> æ˜¯é”®çš„ç»´åº¦ï¼Œ<spanclass="math inline">\(d_v\)</span> æ˜¯å€¼çš„ç»´åº¦ã€‚</p><h6id="é—®é¢˜1å’Œgqamhaå¯¹æ¯”ä¸åŒä¹‹å¤„"><strong>é—®é¢˜1ï¼šå’ŒGQAï¼ŒMHAå¯¹æ¯”ä¸åŒä¹‹å¤„</strong></h6><p>å¦‚æœè€ƒè™‘æ‰€æœ‰å¤´ç»´åº¦åŠ èµ·æ¥çš„è¯:</p><p><span class="math display">\[n_{head} \times d_{k}=\begin{cases}    d_{model} &amp; \text{MHA} \\    (1,d_{model}) &amp; \text{GQA} \\\end{cases}\]</span></p><p><span class="math inline">\(W^Q\)</span>å’Œ<spanclass="math inline">\(W^K\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\text{model}} \timesd_k}\)</span>ï¼Œ<span class="math inline">\(W^V\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\text{model}} \timesd_v}\)</span>ã€‚</p><p><span class="math inline">\(W^{Q&#39;}\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{model} \timesd_{\textcolor{red}{c}}}\)</span>ï¼Œ<spanclass="math inline">\(W^{Q&#39;}\)</span>å’Œ<spanclass="math inline">\(W^{V&#39;}\)</span>ä¸å­˜åœ¨äº†ï¼Œ<spanclass="math inline">\(W^{O&#39;}\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\textcolor{red}{c}} \timesd_{model}}\)</span>ã€‚DeepSeek V2 é€‰æ‹©çš„æ˜¯<spanclass="math inline">\(d_{\textcolor{red}{c}} = 4\timesd_k\)</span>ã€‚</p><p>æ‰€ä»¥MLAå½“<span class="math inline">\(d_{\textcolor{red}{c}} =d_k\)</span>æ—¶å°±æ˜¯æ­£å¸¸çš„MHAã€‚</p><h6id="é—®é¢˜2å’Œæ­£å¸¸çš„attentionå¯¹æ¯”ä¸ºä»€ä¹ˆä¸è¿›ä¸€æ­¥cache-x"><strong>é—®é¢˜2ï¼šå’Œæ­£å¸¸çš„Attentionå¯¹æ¯”ï¼Œä¸ºä»€ä¹ˆä¸è¿›ä¸€æ­¥cachex</strong></h6><p>æ­£å¸¸çš„Attentionè®¡ç®—å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}A &amp;= \text{softmax}(\frac{QK^T}{\sqrt{d_k}})V \\&amp;= \text{softmax}(\frac{xW^QW^{KT}x^T}{\sqrt{d_k}}){xW^V}\end{aligned}\]</span></p><p>å’Œä¸Šæ–‡ä»‹ç»çš„å¯¹æ¯”ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä¿å­˜<spanclass="math inline">\(x\)</span>ï¼Œè€Œå»ä¿å­˜<spanclass="math inline">\(c\)</span>?</p><ol type="1"><li>ä¿å­˜<spanclass="math inline">\(x\)</span>å°±æ˜¯ä¸åšKV_Cacheçš„æƒ…å†µï¼šæˆ–è€…è¯´ä¿å­˜<spanclass="math inline">\(x\)</span>ï¼ŒæŠŠ<spanclass="math inline">\(W^K\)</span>å¸æ”¶åˆ°<spanclass="math inline">\(W^Q\)</span>ä¸­è¿™æ—¶å€™çš„<spanclass="math inline">\(W^{Q&#39;}\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\text{model}} \timesd_{\text{model}}}\)</span>ï¼Œè€Œä¿å­˜<spanclass="math inline">\(c\)</span>çš„æ—¶å€™<spanclass="math inline">\(W^{Q&#39;}\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\text{model}} \timesd_c}\)</span>ã€‚é€šå¸¸<span class="math inline">\(d_{\text{model}} \ggd_c\)</span>ï¼Œæ‰€ä»¥ä¿å­˜<spanclass="math inline">\(x\)</span>çš„è®¡ç®—é‡æ›´å¤§ã€‚</li><li>ä¿å­˜å…¨é‡KV_Cacheå°±æ˜¯é€šå¸¸çš„KV_Cacheçš„åšæ³•</li><li>è€Œä¿å­˜<spanclass="math inline">\(c\)</span>åˆ™æ˜¯æŠ˜ä¸­ï¼š<strong>é™ä½æ˜¾å­˜å’ŒåŠ è½½ä»£ä»·,è€Œæå‡è®¡ç®—ä»£ä»·</strong></li></ol><p>è¿™ä¹Ÿæ˜¯æ•´ä¸ªæ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³ã€‚</p><h5 id="ä¸å…¼å®¹rope">2.1.1.2 ä¸å…¼å®¹ROPE</h5><p>ä½†æ˜¯å½“åŠ å…¥ROPEåå°±ä¼šå­˜åœ¨é—®é¢˜ï¼š</p><p><span class="math display">\[f_{\{q, k\}}\left(\boldsymbol{x}_{m}, m\right)=\boldsymbol{R}_{\Theta,m}^{d} \boldsymbol{W}_{\{q, k\}} \boldsymbol{x}_{m}\]</span></p><p>å…¶ä¸­<span class="math inline">\(\boldsymbol{R}_{\Theta,m}^{d}\)</span> æ˜¯æ—‹è½¬çŸ©é˜µï¼Œ<spanclass="math inline">\(\boldsymbol{W}_{\{q, k\}}\)</span>æ˜¯æƒé‡çŸ©é˜µï¼Œ<span class="math inline">\(\boldsymbol{x}_{m}\)</span>æ˜¯è¾“å…¥ã€‚</p><p><span class="math display">\[\begin{aligned}Q &amp;= xW^QR^Q\\K &amp;= xW^KR^K\\QK^T &amp;= xW^QR^Q(xW^KR^K)^T\\    &amp;= xW^QR^Q(cW^{K&#39;}R^K)^T\\    &amp;= x(W^QR^{Q-K}W^{K&#39;T})c^T\\\end{aligned}\]</span></p><p>æ­¤æ—¶çš„<spanclass="math inline">\((W^QR^{Q-K}W^{K&#39;T})\)</span>å› ä¸ºåŠ å…¥äº†ä½ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸å†æ˜¯å¸¸æ•°ï¼Œæ‰€ä»¥æ— æ³•åƒMLAä¸€æ ·è¿›è¡Œä¼˜åŒ–ã€‚</p><p>æ‰€ä»¥DeepSeek V2 é‡‡å–äº†ä¸€ç§æ··åˆçš„æ–¹æ³•â€”â€”æ¯ä¸ªAttention Headçš„Qã€Kæ–°å¢<span class="math inline">\(dr\)</span>ä¸ªç»´åº¦ç”¨æ¥æ·»åŠ RoPEï¼Œå…¶ä¸­Kæ–°å¢çš„ç»´åº¦æ¯ä¸ªHeadå…±äº«(æ³¨1)ï¼š</p><p><span class="math display">\[\begin{aligned}Q &amp;= [xW^{Q&#39;}, xW^{Qr}R^Q] \in \mathbb{R}^{d_{model} \times(d_{\text{k}}+dr})\\K &amp;= [cW^{K&#39;}, xW^{Kr}R^K] \in \mathbb{R}^{d_{model} \times(d_{\text{k}}+dr)}\\\end{aligned}\]</span></p><p>æ­¤æ—¶çš„çŸ©é˜µä¸­<spanclass="math inline">\(xW^{Q&#39;}\)</span>å°±ä¸æºå¸¦ä½ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥åƒMLAä¸€æ ·è¿›è¡Œä¼˜åŒ–ã€‚è€Œ<span class="math inline">\(xW^{Qr}R^Q\)</span>å’Œ<spanclass="math inline">\(xW^{Kr}R^K\)</span>åˆ™æºå¸¦ä½ç½®ä¿¡æ¯ã€‚</p><p>æ­¤æ—¶åœ¨æ¨ç†è¿‡ç¨‹KV_Cacheä¸­ï¼Œåªéœ€è¦å¤šç¼“å­˜ä¸€ä¸ª<spanclass="math inline">\(xW^{Kr}R^K\)</span>(å‘½åä¸ºK^r)ã€‚ å³åªéœ€è¦ç¼“å­˜<spanclass="math inline">\(\textcolor{red}{c}\)</span>å’Œ<spanclass="math inline">\(\textcolor{red}{K^r}\)</span>ã€‚</p><p>è®ºæ–‡ä¸­é€‰å–çš„å‚æ•°å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å€¼</th></tr></thead><tbody><tr><td><span class="math inline">\(d_{\text{model}}\)</span></td><td>5120</td></tr><tr><td><span class="math inline">\(d_k\)</span></td><td>128</td></tr><tr><td><span class="math inline">\(d_c\)</span></td><td>512</td></tr><tr><td><span class="math inline">\(dr\)</span></td><td>64</td></tr></tbody></table><p>æ³¨1ï¼š è™½ç„¶ä¸åŒçš„æ³¨æ„åŠ›å¤´æœ‰å„è‡ªç‹¬ç«‹çš„ <spanclass="math inline">\(k_{head}\)</span>ï¼Œä½†è¿™äº›æ–°å¢çš„ <spanclass="math inline">\(dr\)</span>ä¸ªç»´åº¦æ˜¯ç›¸åŒçš„ï¼Œæ‰€æœ‰å¤´åœ¨è¿™äº›ç»´åº¦ä¸Šä½¿ç”¨çš„æ˜¯ç›¸åŒçš„ä½ç½®ç¼–ç ä¿¡æ¯ã€‚è¿™ä¸æ ‡å‡†å¤šå¤´æ³¨æ„åŠ›ä¸­çš„åšæ³•ä¸€è‡´ï¼Œåœ¨æ ‡å‡†å¤šå¤´æ³¨æ„åŠ›ä¸­ï¼Œå°½ç®¡æ¯ä¸ªå¤´æœ‰ä¸åŒçš„é”®å‘é‡<spanclass="math inline">\(k_{head}\)</span>,ä½†è¿™äº›é”®å‘é‡çš„ä½ç½®ç¼–ç ä¿¡æ¯æ˜¯ç›¸åŒçš„ï¼Œå› ä¸ºæ¯ä¸ªAttentionHeadè¾“å…¥éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™ç§å…±äº«æœ‰åŠ©äºåœ¨ä¸åŒçš„å¤´ä¹‹é—´ä¿æŒä½ç½®ä¿¡æ¯çš„ä¸€è‡´æ€§ï¼Œä»è€Œè®©æ¯ä¸ªå¤´èƒ½å¤Ÿä»¥ä¸€è‡´çš„æ–¹å¼åˆ©ç”¨ä½ç½®ä¿¡æ¯ï¼Œå°½ç®¡å®ƒä»¬åœ¨å…³æ³¨çš„å†…å®¹ä¸Šå¯èƒ½æœ‰æ‰€ä¸åŒã€‚</p><h5 id="query-ä½ç§©">2.1.1.3. Query ä½ç§©</h5><p>DeepSeek V2 è¿˜å°† <span class="math inline">\(Q\)</span>ä¹Ÿè½¬åŒ–ä¸ºäº†ä½ç§©çŸ©é˜µï¼Œè¿™å¹¶ä¸ä¼šå‡å°‘KV_Cacheçš„å­˜å‚¨é‡ï¼Œæ–‡ä¸­ç§°å¯ä»¥å‡å°‘è®­ç»ƒæœŸé—´å‚æ•°é‡å’Œç›¸åº”çš„æ¢¯åº¦ã€‚</p><p><span class="math display">\[\begin{aligned}Q &amp;= [c^{&#39;}W^{Q&#39;}, c^{&#39;}W^{Qr}R^Q] \in\mathbb{R}^{d_{model} \times (d_{\text{k}}+dr})\\K &amp;= [cW^{K&#39;}, xW^{Kr}R^K] \in \mathbb{R}^{d_{model} \times(d_{\text{k}}+dr)}\\\end{aligned}\]</span></p><p>å…¶ä¸­<spanclass="math inline">\(d_{c^{&#39;}}\)</span>æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œ<spanclass="math inline">\(d_{c^{&#39;}}=1536\)</span>ã€‚</p><h4 id="kv_cacheå’Œflopsçš„æƒè¡¡">2.1.2 KV_Cacheå’ŒFLOPsçš„æƒè¡¡</h4><p><strong>å‡å°‘éƒ¨åˆ†KVCacheï¼Œå¢åŠ éƒ¨åˆ†è®¡ç®—é‡ï¼Œåœ¨ä¿å­˜å…¨é‡KV_Cacheå’Œä¸ä¿å­˜KV_Cacheä¹‹é—´å–å¾—äº†ä¸€ä¸ªæŠ˜ä¸­</strong>ã€‚å¦‚ä¸‹ï¼š</p><p><strong>1. è®­ç»ƒé˜¶æ®µ</strong> MLAåŸºæœ¬ç›¸å½“äºæŠŠMHAçš„æ¯ä¸ªAttention Headä¸­çš„<span class="math inline">\(Q,K\)</span>ç»´åº¦ä»<spanclass="math inline">\(d_k\)</span>å˜ä¸ºäº†<spanclass="math inline">\(d_c+dr\)</span>ã€‚</p><p><strong>2. æ¨ç†é˜¶æ®µ</strong></p><p>ç”±äº<span class="math inline">\(d_{\textcolor{red}{c}} = 4\timesd_k\)</span>ï¼Œå®é™…ä¸ŠMLAåœ¨æ¨ç†é˜¶æ®µåšçš„è¿™ä¸ªè½¬æ¢ï¼Œè™½ç„¶èƒ½æœ‰æ•ˆå‡å°‘KVCacheï¼Œä½†å…¶æ¨ç†çš„è®¡ç®—é‡æ˜¯å¢åŠ çš„ã€‚</p><h5 id="kv_cache">2.1.2.1 KV_Cache</h5><table><thead><tr><th style="text-align: center;">Attention Mechanism</th><th style="text-align: center;">KV_Cache per token</th><th style="text-align: center;">Capability</th></tr></thead><tbody><tr><td style="text-align: center;">MHA</td><td style="text-align: center;"><spanclass="math inline">\(2n_hd_hl\)</span></td><td style="text-align: center;">Strong</td></tr><tr><td style="text-align: center;">GQA</td><td style="text-align: center;"><spanclass="math inline">\(2n_gd_hl\)</span></td><td style="text-align: center;">Moderate</td></tr><tr><td style="text-align: center;">MQA</td><td style="text-align: center;"><spanclass="math inline">\(2d_hl\)</span></td><td style="text-align: center;">Weak</td></tr><tr><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">MLA</td><td style="text-align: center;"><span class="math inline">\((d_c+d_r)l\approx 4.5d_hl\)</span></td><td style="text-align: center;">Strong</td></tr></tbody></table><p>å…¶ä¸­<span class="math inline">\(d_h\)</span>æ˜¯headç»´åº¦ï¼Œ<spanclass="math inline">\(n_h\)</span>æ˜¯headæ•°ï¼Œ<spanclass="math inline">\(n_g\)</span>æ˜¯gqa headæ•°ã€‚</p><p>æ‰€ä»¥å¤§æ¦‚ç­‰æ•ˆäº<spanclass="math inline">\(n_g=2.25\)</span>çš„GQAçš„KV_Cacheï¼Œç›¸æ¯”äº8ä¸ªheadçš„GQAå¤§æ¦‚é™ä½åˆ°äº†åŸæ¥çš„0.28å€ã€‚</p><h5 id="flops">2.1.2.2 FLOPs</h5><p>å› ä¸ºæ­£å¸¸æ¥è®²<span class="math inline">\(W^Q\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\text{model}} \timesd_k}\)</span>ï¼Œ<span class="math inline">\(W^O\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_v \timesd_{\text{model}}}\)</span>ã€‚è€Œåœ¨MLAä¸­<spanclass="math inline">\(W^{Q&#39;}\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_{\text{model}} \timesd_c}\)</span>ï¼Œ<spanclass="math inline">\(W^{O&#39;}\)</span>çš„å¤§å°æ˜¯<spanclass="math inline">\(\mathbb{R}^{d_c \timesd_{\text{model}}}\)</span>ã€‚æ‰€ä»¥åœ¨æ¨ç†é˜¶æ®µï¼ŒMLAçš„è®¡ç®—é‡æ˜¯å¢åŠ çš„ã€‚</p><p><strong>å…·ä½“å¢åŠ äº†å¤šå°‘</strong></p><p>å‡è®¾è¾“å…¥çš„batchä¸º<span class="math inline">\(b \times s \timesd\)</span>ï¼Œå…¶ä¸­<spanclass="math inline">\(b\)</span>ä¸ºbatch_sizeï¼Œ<spanclass="math inline">\(s\)</span>ä¸ºè¾“å…¥é•¿åº¦ï¼Œ<spanclass="math inline">\(d\)</span>ä¸ºåµŒå…¥ç»´åº¦</p><ol type="1"><li>Embeddingå±‚ï¼šæŸ¥è¡¨æ“ä½œï¼Œä¸æ¶‰åŠçŸ©é˜µä¹˜æ³•ï¼Œæ•…ä¸è®¡å…¥FLOPs</li><li>é¢„æµ‹å¤šåˆ†ç±»å¤´(logits)å°†å°ºå¯¸ä¸º d çš„éšè—å‘é‡æ˜ å°„ä¸ºè¯è¡¨å¤§å°ï¼š<spanclass="math inline">\([b \times s \times d] \times [d \times V] = [b\times s \times V]\)</span> â€”â€” <spanclass="math inline">\(2bsVd\)</span></li><li>Self-Attentionå±‚ï¼š <span class="math display">\[     Q&#39;=xW^{Q&#39;}\\     Attention =\text{softmax}(\frac{Q&#39;\textcolor{red}{c&#39;}^T}{\sqrt{d_k}}){\textcolor{red}{c}}\\     x_{out}= AW^{O&#39;}+x\]</span><ul><li>æ¯ä¸ªå¤´çš„æ³¨æ„åŠ›è®¡ç®—ï¼šä¸€ä¸‹éœ€è¦ä¹˜<spanclass="math inline">\(n_{heads}\)</span>æ¬¡ï¼Œæ¯æ¬¡è®¡ç®—å¦‚ä¸‹ï¼š<ul><li>è®¡ç®— Qâ€™ çŸ©é˜µï¼š<span class="math inline">\([b \times s \times d]\times [d \times d_{c&#39;}] = [b \times s \times d_{c&#39;}]\)</span>â€”â€” <span class="math inline">\(2bsdd_{c&#39;}\)</span></li><li>è®¡ç®—æ³¨æ„åŠ›æƒé‡<spanclass="math inline">\(Q&#39;{c&#39;}^T\)</span>ï¼š<spanclass="math inline">\([b \times s \times d_{c&#39;}] \times [b \times s\times d_{c&#39;}]^T = [b \times s \times s]\)</span> â€”â€” <spanclass="math inline">\(2bs^2d_{c&#39;}\)</span></li><li>æ±‡èšä»·å€¼ä¿¡æ¯<span class="math inline">\(Ac\)</span>: <spanclass="math inline">\([b \times s \times s] \times [b \times s \timesd_c] = [b \times s \times d_c]\)</span> â€”â€” <spanclass="math inline">\(2bs^2d_c\)</span></li></ul></li><li>æ‹¼æ¥å¤šå¤´æ³¨æ„åŠ›: ä¸æ¶‰åŠçŸ©é˜µä¹˜æ³•ï¼Œæ•…ä¸è®¡å…¥FLOPs</li><li>è¾“å‡ºçŸ©é˜µ<span class="math inline">\(O\)</span>: <spanclass="math inline">\([b \times s \times (n_{heads}\times d_c)] \times[(n_{heads}\times d_c) \times d] = [b \times s \times d]\)</span> â€”â€”<span class="math inline">\(2bsd(n_{heads}\times d_c)\)</span></li></ul></li><li>MLPå±‚ï¼š<span class="math inline">\(16bsd^2\)</span> <spanclass="math display">\[     h=Relu(x_{out}W^1+b_1)\\     h_{out}=hW^2+b2\\     x=h_{out}+x_{out}\]</span><ul><li>ç¬¬ä¸€ä¸ªçº¿æ€§å±‚ï¼š<span class="math inline">\([b \times s \times d]\times [d \times 4d] = [b \times s \times 4d]\)</span> â€”â€” <spanclass="math inline">\(8bsd^2\)</span></li><li>ç¬¬äºŒä¸ªçº¿æ€§å±‚ï¼š<span class="math inline">\([b \times s \times 4d]\times [4d \times d] = [b \times s \times d]\)</span> â€”â€” <spanclass="math inline">\(8bsd^2\)</span></li></ul></li></ol><table><colgroup><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /><col style="width: 25%" /></colgroup><thead><tr><th style="text-align: center;">æ¨¡å—</th><th style="text-align: center;">æ•°é‡</th><th style="text-align: center;">å•æ¬¡FLOPs</th><th style="text-align: center;">æ€»FLOPs</th></tr></thead><tbody><tr><td style="text-align: center;">Embedding</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr><tr><td style="text-align: center;">LM Head(logits)</td><td style="text-align: center;">1</td><td style="text-align: center;"><spanclass="math inline">\(2bsVd\)</span></td><td style="text-align: center;"><spanclass="math inline">\(2bsVd\)</span></td></tr><tr><td style="text-align: center;">Self-Attention</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(2bsn_{heads}(2dd_c+dd_r+2sd_c+sd_r)\)</span></td><td style="text-align: center;"><spanclass="math inline">\(2blsn_{heads}(2dd_c+dd_r+2sd_c+sd_r)\)</span></td></tr><tr><td style="text-align: center;">MLP</td><td style="text-align: center;">l</td><td style="text-align: center;"><spanclass="math inline">\(16bsd^2\)</span></td><td style="text-align: center;"><spanclass="math inline">\(16blsd^2\)</span></td></tr><tr><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">æ­£å¸¸çš„MHA FLOPs</td><td style="text-align: center;">-</td><td style="text-align: center;">-</td><td style="text-align: center;"><span class="math inline">\(2bsVd +24blsd^2 + 4bls^2d\)</span></td></tr></tbody></table><p>å…¶ä¸­<span class="math inline">\(l\)</span>ä¸ºå±‚æ•°ï¼Œ<spanclass="math inline">\(d\)</span>ä¸ºåµŒå…¥ç»´åº¦ï¼Œ<spanclass="math inline">\(s\)</span>ä¸ºè¾“å…¥é•¿åº¦ï¼Œ<spanclass="math inline">\(V\)</span>ä¸ºè¯è¡¨å¤§å°ï¼Œ<spanclass="math inline">\(b\)</span>ä¸ºbatch_sizeï¼Œ<spanclass="math inline">\(n_{heads}\)</span>ä¸ºheadæ•°ã€‚</p><p><span class="math display">\[\begin{aligned}FLOPs(MLA/MHA)&amp;\approx\frac{16blsd^2+2blsn_{heads}(2dd_c+dd_r+2sd_c+sd_r)}{24blsd^2 +4bls^2d}\\&amp;= \frac{33d+17s}{24d+4s}(\textcolor{red}{å­˜ç–‘})\\\end{aligned}\]</span></p><h4 id="deepseek-v2-çš„moe">2.1.3 DeepSeek V2 çš„MOE</h4><p>å¦å¤– DeepSeek V2 æ˜¯ä¸€ä¸ªæ”¹è¿›çš„MOEæ¨¡å‹ï¼Œéƒ¨åˆ†æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ol type="1"><li>ç»†ç²’åº¦ä¸“å®¶åˆ†å‰²ï¼šé€šè¿‡å°†æ¯ä¸ªFFNä¸“å®¶è¿›ä¸€æ­¥ç»†åˆ†ï¼Œè¿™å…è®¸æ¨¡å‹åœ¨ä¿æŒå‚æ•°æ€»æ•°ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ¿€æ´»æ›´å¤šçš„ã€æ›´ç»†ç²’åº¦çš„ä¸“å®¶ã€‚è¿™ç§ç­–ç•¥ä½¿å¾—å„ä¸ªä¸“å®¶èƒ½å¤Ÿä¸“æ³¨äºæ›´ç»†è‡´çš„çŸ¥è¯†é¢†åŸŸï¼Œæé«˜äº†ä¸“å®¶çš„ä¸“ä¸šåŒ–ç¨‹åº¦ã€‚</li><li>å…±äº«ä¸“å®¶éš”ç¦»ï¼šè®¾ç½®ä¸€éƒ¨åˆ†ä¸“å®¶ä½œä¸ºâ€œå…±äº«ä¸“å®¶â€ï¼Œè¿™äº›ä¸“å®¶æ€»æ˜¯è¢«æ¿€æ´»ï¼Œç”¨äºæ•æ‰å’Œæ•´åˆå¸¸è§çš„è·¨ä¸Šä¸‹æ–‡çŸ¥è¯†ã€‚è¿™æ ·å¯ä»¥å‡å°‘è·¯ç”±ä¸“å®¶ä¹‹é—´çš„çŸ¥è¯†å†—ä½™ï¼Œé¿å…é‡å¤çŸ¥è¯†ï¼Œæ¯ä¸ªè·¯ç”±ä¸“å®¶å¯ä»¥æ›´ä¸“æ³¨äºç‹¬ç‰¹çš„çŸ¥è¯†é¢†åŸŸã€‚</li></ol><h3 id="æ”¹è¿›çš„é‡åŒ–å†…æ ¸">2.2 æ”¹è¿›çš„é‡åŒ–å†…æ ¸</h3><p>Transformers çš„ Torchå®ç°å¿…é¡»åœ¨å¤„ç†ä¹‹å‰å°†è¿™äº›å¼ é‡åé‡åŒ–ä¸ºæ”¯æŒçš„æ•°æ®ç±»å‹ï¼Œè¿™ä¼šå¸¦æ¥ä¸å¿…è¦çš„è®¡ç®—å¼€é”€å¹¶å¢åŠ å†…å­˜æµé‡ã€‚ä¸ºäº†å…‹æœè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åŠ å…¥äº†ç›´æ¥å¯¹é‡åŒ–æ•°æ®ç±»å‹è¿›è¡Œæ“ä½œçš„é«˜çº§å†…æ ¸ï¼Œä»è€Œä¼˜åŒ–äº†æ¨ç†æ€§èƒ½ã€‚</p><h3 id="è®¡ç®—å¼ºåº¦å¼•å¯¼çš„æ¨¡å‹åŠ è½½">2.3 è®¡ç®—å¼ºåº¦å¼•å¯¼çš„æ¨¡å‹åŠ è½½</h3><p>éµå¾ªæŒ‰ç®—æœ¯å¼ºåº¦æ’åˆ—æ‰€æœ‰ç®—å­å¹¶å°½å¯èƒ½å°†æœ€å¯†é›†çš„ç®—å­æ”¾åœ¨ GPUä¸­çš„åŸåˆ™ï¼Œç­–ç•¥æ€§åœ°åªå°†è®¡ç®—æœ€å¯†é›†çš„å‚æ•°å­˜å‚¨åœ¨ GPU ä¸Šã€‚</p><p>ä¼˜å…ˆå°† MoE å‚æ•°å’Œè¯åµŒå…¥è®¡ç®—æ”¾åœ¨ CPUç«¯ä»¥åˆ©ç”¨å…¶æ›´å¤§çš„å†…å­˜å®¹é‡ã€‚å…¶ä½™å‚æ•°ï¼ˆåŒ…æ‹¬å…±äº«ä¸“å®¶ã€æ³¨æ„æ¨¡å—ä¸­çš„æŠ•å½±å’ŒMLAï¼‰å­˜å‚¨åœ¨ GPU VRAM ä¸­ã€‚ç”±äºæ¯ä¸ª tokenéƒ½ä¼šè®¿é—®è¿™äº›å‚æ•°ï¼Œå› æ­¤å°†å®ƒä»¬æ”¾ç½®åœ¨ GPUä¸Šå¯ä»¥æœ€å¤§é™åº¦åœ°å‘æŒ¥é«˜å†…å­˜å¸¦å®½çš„ä¼˜åŠ¿ã€‚å¦‚æœä½¿ç”¨ Q4_K_Mç‰ˆæœ¬ï¼Œæ­¤é…ç½®å°†å¯¼è‡´å¤§çº¦ 20.7 GB çš„ VRAM ä½¿ç”¨é‡å’Œ 136GB çš„ DRAMå†…å­˜è¯·æ±‚ï¼Œå³ä½¿åœ¨æœ¬åœ°æ¡Œé¢ä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p><ol type="1"><li>MLA è¿ç®—ç¬¦ï¼ˆåŒ…å« 128 ä¸ªå¤´ï¼Œå…·æœ‰å…±äº«çš„å‹ç¼©é”®å€¼è¡¨ç¤ºï¼‰çš„ç®—æœ¯å¼ºåº¦ä¸º512ã€‚è¿™ä½¿å…¶æˆä¸ºæœ€å¯†é›†çš„è¿ç®—ç¬¦ï¼Œå°¤å…¶æ˜¯åœ¨è¾ƒå°çš„æ¨ç†æ‰¹æ¬¡å¤§å°æœŸé—´ã€‚å› æ­¤ï¼Œå®ƒè¢«åˆ†é…ç»™GPU ä»¥åˆ©ç”¨å¼ é‡æ ¸å¿ƒã€‚</li><li>DeepSeek-V2 ä¸­çš„æ¯ä¸ªè½¬æ¢å™¨å—åŒ…å« 160 ä½æ··åˆä¸“å®¶ (MoE)ä¸“å®¶ï¼Œå æ€»å‚æ•°çš„ 96%ã€‚ä½†æ˜¯ï¼ŒMoE è·¯ç”±å™¨ä¸ºæ¯ä¸ª token ä»…æ¿€æ´»è¿™ 160ä½ä¸“å®¶ä¸­çš„ 6 ä½ã€‚å› æ­¤ï¼Œæ­¤æ“ä½œä¸»è¦æ¶‰åŠæ‰¹é‡é€šç”¨çŸ©é˜µå‘é‡ä¹˜æ³• (GEMV)ï¼Œå¯ä»¥ç”±CPU é«˜æ•ˆå¤„ç†ã€‚</li></ol><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ol type="1"><li><ahref="https://kexue.fm/archives/10091">ç¼“å­˜ä¸æ•ˆæœçš„æé™æ‹‰æ‰¯ï¼šä»MHAã€MQAã€GQAåˆ°MLA</a></li><li>çŸ¥ä¹ï¼šå¦‚ä½•çœ‹å¾… DeepSeek å‘å¸ƒçš„ MoE å¤§æ¨¡å‹ DeepSeek-V2<ol type="1"><li><ahref="https://www.zhihu.com/question/655172528/answer/3491439374">å›ç­”1</a></li><li><ahref="https://www.zhihu.com/question/655172528/answer/3495218670">å›ç­”2</a></li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹MInference</title>
      <link href="/2024/08/08/NLP/LLMModels/MInference/"/>
      <url>/2024/08/08/NLP/LLMModels/MInference/</url>
      
        <content type="html"><![CDATA[<h1 id="minference">MInference</h1><p>é€šè¿‡åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›åŠ é€Ÿé•¿ä¸Šä¸‹æ–‡llmçš„é¢„å¡«å…… åŸæ–‡é“¾æ¥ï¼š<ahref="https://arxiv.org/abs/2407.02490">MInference 1.0: AcceleratingPre-filling for Long-Context LLMs via Dynamic Sparse Attention</a></p><h2 id="ç®€ä»‹">1. ç®€ä»‹</h2><p>MInferenceæ˜¯ä¸€ç§åˆ©ç”¨<strong>ç©ºé—´èšé›†æ¨¡å¼</strong>çš„åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›æ¥åŠ é€Ÿé•¿åºåˆ—é¢„å¡«å……é˜¶æ®µçš„æ–¹æ³•ã€‚</p><ol type="1"><li>å°†æ³¨æ„åŠ›å¤´åˆ†ä¸ºä¸‰ç§å¯ä»¥ç”¨äºgpuä¸Šçš„é«˜æ•ˆç¨€ç–è®¡ç®—ç±»å‹: A-shape,Vertical-Slash, Block-Sparseã€‚</li><li>é‡‡ç”¨æ ¸æ„ŸçŸ¥çš„æœ€ä¼˜ç¨€ç–æ¨¡å¼æœç´¢æ–¹æ³•ï¼Œç¦»çº¿ç¡®å®šæ¯ä¸ªæ³¨æ„åŠ›å¤´çš„æœ€ä¼˜æ¨¡å¼ã€‚</li><li>åœ¨æ¨ç†è¿‡ç¨‹ä¸­åˆ©ç”¨å¿«é€Ÿé€¼è¿‘æ–¹æ³•ä¸ºä¸åŒçš„è¾“å…¥æ„å»ºåŠ¨æ€ç¨€ç–æ©ç ï¼Œç„¶ååº”ç”¨è¿™äº›æ©ç è¿›è¡Œç¨€ç–æ³¨æ„åŠ›è®¡ç®—ã€‚</li></ol><p>å³<strong>åªè®¡ç®—æ³¨æ„æƒå€¼ä¸­æœ€é‡è¦çš„éƒ¨åˆ†</strong></p><h3 id="å±€é™æ€§">å±€é™æ€§</h3><ol type="1"><li>ä¸Šä¸‹æ–‡é•¿åº¦è¾ƒå°æ—¶ï¼Œæ„å»ºåŠ¨æ€ç´¢å¼•æ‰€éœ€çš„æ—¶é—´ä¼šå› ä¸ºæ³¨æ„åŠ›è®¡ç®—æ—¶é—´çš„å‡å°è€Œå¢å¤§ã€‚</li><li>å½“ä½¿ç”¨è¾ƒé«˜çš„ç¨€ç–ç‡æ—¶ï¼Œæ¨¡å‹æ€§èƒ½å¯èƒ½ä¼šæ˜æ˜¾ä¸‹é™ã€‚</li></ol><h2 id="åŸç†">2. åŸç†</h2><h3 id="ç¨€ç–æ³¨æ„åŠ›å¤´ç±»å‹">2.1 ç¨€ç–æ³¨æ„åŠ›å¤´ç±»å‹</h3><p>å¦‚å›¾1å’Œ2æ‰€ç¤ºï¼Œå°†æ³¨æ„åŠ›å¤´åˆ†ä¸º<strong>ä¸‰ç§ç±»å‹</strong>ã€‚</p><ol type="1"><li><strong>A-shape</strong>:è¯¥æ¨¡å¼çš„æ³¨æ„æƒé‡é›†ä¸­åœ¨åˆå§‹ä»¤ç‰Œå’Œå±€éƒ¨çª—å£ï¼Œè¡¨ç°å‡ºç›¸å¯¹è¾ƒé«˜çš„ç¨³å®šæ€§ã€‚</li><li><strong>Vertical-Slash</strong>:è¯¥æ¨¡å¼çš„æ³¨æ„æƒé‡é›†ä¸­åœ¨ç‰¹å®šçš„æ ‡è®°(ç«–çº¿)å’Œå›ºå®šé—´éš”çš„æ ‡è®°(æ–œçº¿)ä¸Šã€‚è¯¥å›¾æ¡ˆä¸­ç«–çº¿å’Œæ–œçº¿çš„ä½ç½®éšä¸Šä¸‹æ–‡å†…å®¹åŠ¨æ€å˜åŒ–ã€‚</li><li><strong>Block-Sparse</strong>:è¯¥æ¨¡å¼æ˜¯æœ€åŠ¨æ€çš„ï¼Œè¡¨ç°å‡ºæ›´åˆ†æ•£çš„åˆ†å¸ƒï¼Œä¿æŒäº†ç©ºé—´èšç±»çš„ä¸€äº›ç‰¹å¾ã€‚</li></ol><figure><img src="./images/attention_pattern.webp#50x50"title="å›¾1: æ³¨æ„åŠ›æƒé‡ä¸‰ç§ç±»å‹" alt="æ³¨æ„åŠ›æƒé‡ä¸‰ç§ç±»å‹" /><figcaption aria-hidden="true">æ³¨æ„åŠ›æƒé‡ä¸‰ç§ç±»å‹</figcaption></figure><figure><img src="./images/MInference_framework_crop.webp"title="å›¾2: ç®€åŒ–ä¸‰ç§ç±»å‹" alt="ç®€åŒ–ä¸‰ç§ç±»å‹" /><figcaption aria-hidden="true">ç®€åŒ–ä¸‰ç§ç±»å‹</figcaption></figure><h3 id="ç¨€ç–æ³¨æ„åŠ›è®¡ç®—">2.2 ç¨€ç–æ³¨æ„åŠ›è®¡ç®—</h3><p>å½“ä½¿ç”¨ç¨€ç–æ³¨æ„åŠ›è®¡ç®—åŠ é€Ÿé•¿ä¸Šä¸‹æ–‡llmçš„é¢„å¡«å……é˜¶æ®µæ—¶ï¼Œ<strong>æ³¨æ„åŠ›çŸ©é˜µ</strong>å¯ä»¥è¡¨ç¤ºä¸º:</p><p><span class="math display">\[\begin{equation}    \bm{A(M)} = \text{Softmax}(\frac{1}{\sqrt{d}}\bm{Q}\bm{K}^\top -c(1-\bm{M}))    \tag{1}\end{equation}\]</span></p><p><span class="math inline">\(M_{i,j} \in \{0,1\}\)</span>è¡¨ç¤ºæ³¨æ„çŸ©é˜µç¬¬<spanclass="math inline">\({i,j}\)</span>é¡¹çš„åŠ¨æ€ç¨€ç–æ©ç ï¼Œ<spanclass="math inline">\(c\)</span>æ˜¯ä¸€ä¸ªå¤§çš„å¸¸æ•°ï¼Œç¡®ä¿softmaxå<spanclass="math inline">\(M_{i,j} =0\)</span>é‚£äº›ä¸å¤ªé‡è¦çš„æ³¨æ„æƒé‡æ¥è¿‘0ã€‚</p><p>æ‰€ä»¥<strong>ç›®æ ‡å‡½æ•°</strong>ä¸º:</p><p><span class="math display">\[\begin{equation}    \begin{aligned}        \min \enspace &amp; \enspace \enspace |\bm{A}(\bm{M}) -\bm{A}_{\text{dense}}|, \\        \min \enspace &amp;  t_{\text{sparse}}(\bm{M}) +t_{\text{overhead}}(\bm{M}),    \end{aligned}    \tag{2}\end{equation}\]</span></p><h3 id="å®ç°æ­¥éª¤">2.3 å®ç°æ­¥éª¤</h3><h4 id="ç¦»çº¿æ ¸æ„ŸçŸ¥æœ€ä¼˜ç¨€ç–æ¨¡å¼æœç´¢">2.3.1ç¦»çº¿æ ¸æ„ŸçŸ¥æœ€ä¼˜ç¨€ç–æ¨¡å¼æœç´¢</h4><p>é€šè¿‡ä¸€ä¸ªå‚è€ƒç¤ºä¾‹éå†æœç´¢ç©ºé—´ï¼Œä»¥å†³å®šæœ€ä¼˜æ¨¡å¼å’Œè®¾ç½®ã€‚ç”¨äºç¡®å®šæ¯ä¸ªæ³¨æ„å¤´å°†<strong>ä½¿ç”¨å“ªç§ç¨€ç–æ¨¡å¼</strong>ï¼Œä»¥åŠå®é™…è®¡ç®—ä¸­<strong>æ¨¡å¼çš„æœ€ä½³è®¾ç½®</strong>(ä¾‹å¦‚ï¼ŒVSæ¨¡å¼ä¸­å‚ç›´/æ–œçº¿çš„æ•°é‡;æˆ–BSæ¨¡å¼ä¸­top-kå—çš„æ•°é‡)</p><ol type="1"><li>åˆå§‹åŒ–æˆ–è·å–å…¨å±€çš„æ³¨æ„åŠ›æ©ç </li><li>æŒ‰ç…§å…¬å¼(1)è®¡ç®—æ³¨æ„åŠ›æƒé‡</li><li>åˆå§‹åŒ–æœ€ä½³åˆ†æ•°å’Œå¯¹åº”å‚æ•°</li><li>éå†æ¯ç§æ¨¡å¼ï¼ˆstream_llmã€vertical_and_slashã€block_sparseï¼‰åŠå…¶å‚æ•°ç»„åˆï¼Œè®¡ç®—åˆ†æ•°(ç±»ä¼¼äºå·ç§¯æ ¸æå–ç‰¹å®šæ¨¡å¼çš„ç‰¹å¾ï¼Ÿ)<ol type="1"><li>vertical_and_slashå‚ç›´æ³¨æ„åŠ›ï¼šå¯¹æŸ¥è¯¢-é”®ç‚¹ç§¯è¿›è¡Œsoftmaxï¼Œç´¯åŠ æ‰€æœ‰åˆ—çš„æ³¨æ„åŠ›æƒé‡ï¼Œå¹¶é€‰æ‹©top-kåˆ—ã€‚æ–œçº¿æ³¨æ„åŠ›ï¼šè®¡ç®—æ‰€æœ‰æ–œçº¿å…ƒç´ çš„å’Œï¼Œé€‰æ‹©top-kæ–œçº¿ã€‚åˆå¹¶ï¼šå°†å‚ç›´å’Œæ–œçº¿æ³¨æ„åŠ›çŸ©é˜µç»„åˆã€‚</li><li>stream_llmæ©ç è®¡ç®—ï¼šç”Ÿæˆä¸Šä¸‹ä¸‰è§’æ©ç çŸ©é˜µï¼Œè®¾ç½®æŒ‡å®šå¤§å°çš„å‚ç›´å’Œæ–œçº¿åŒºåŸŸã€‚åº”ç”¨æ©ç ï¼šå°†æ©ç åº”ç”¨äºæ³¨æ„åŠ›æƒé‡çŸ©é˜µã€‚</li><li>block_sparse å—åˆ’åˆ†ï¼šå°†æŸ¥è¯¢å’Œé”®åˆ†æˆå¤šä¸ªå—ï¼Œå¹¶å¯¹æ¯ä¸ªå—è¿›è¡Œæ± åŒ–ã€‚ é€‰æ‹©top-kï¼šè®¡ç®—å—çº§åˆ«çš„æ³¨æ„åŠ›æƒé‡ï¼Œé€‰æ‹©å‰top-kä¸ªå—ã€‚åˆå¹¶å—ç¨€ç–æ³¨æ„åŠ›ï¼šå°†å—ç¨€ç–çŸ©é˜µæ‰©å±•åˆ°åŸå§‹ç»´åº¦</li></ol></li><li>è®°å½•æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶æ›´æ–°æœ€ä½³åˆ†æ•°å’Œå‚æ•°</li><li>é€‰æ‹©æ¯ä¸ªæ³¨æ„åŠ›å¤´çš„æœ€ä½³æ¨¡å¼</li></ol><h4 id="ç¨€ç–åº¦æŒ‡æ ‡é€¼è¿‘ä¸åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›è®¡ç®—">2.3.2ç¨€ç–åº¦æŒ‡æ ‡é€¼è¿‘ä¸åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›è®¡ç®—</h4><p>åœ¨æ¨ç†é˜¶æ®µï¼Œæ ¹æ®åˆ†é…çš„æ¨¡å¼å’Œå‡†ç¡®çš„è¾“å…¥å¯¹æ³¨æ„åŠ›çŸ©é˜µè¿›è¡Œåœ¨çº¿ä¼°è®¡ï¼Œä»¥åŠ¨æ€ç¡®å®šæˆ‘ä»¬çš„ç¨€ç–æŒ‡æ•°çš„ç©ºé—´åˆ†å¸ƒã€‚</p><figure><img src="./images/algo2.webp#100x100"title="å›¾4: ç¨€ç–åº¦æŒ‡æ ‡é€¼è¿‘ä¸åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›è®¡ç®—"alt="ç¨€ç–åº¦æŒ‡æ ‡é€¼è¿‘ä¸åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›è®¡ç®—" /><figcaptionaria-hidden="true">ç¨€ç–åº¦æŒ‡æ ‡é€¼è¿‘ä¸åŠ¨æ€ç¨€ç–æ³¨æ„åŠ›è®¡ç®—</figcaption></figure><h5 id="vertical-slash">1) Vertical-Slash</h5><ol type="1"><li>ç”Ÿæˆä¼°è®¡çš„æ³¨æ„åŠ›çŸ©é˜µ <spanclass="math inline">\(\boldsymbol{\hat{A}}\)</span>:ç”±äºå‚ç›´çº¿å’Œæ–œçº¿çš„è¿ç»­æ€§ï¼Œæˆ‘ä»¬å°†æœ€åä¸€ä¸ªæŸ¥è¯¢å‘é‡ <spanclass="math inline">\(\bm{Q}_{[-\text{last\_q}:]}\)</span> å’Œé”®å‘é‡<span class="math inline">\(\bm{K}\)</span> è¿›è¡ŒçŸ©é˜µä¹˜æ³•</li><li>ç”¨<spanclass="math inline">\(\boldsymbol{\hat{A}}\)</span>æ¥ç¡®å®šå‚ç›´çº¿ <spanclass="math inline">\(\bm{i}_v\)</span> å’Œæ–œçº¿ <spanclass="math inline">\(\bm{i}_s\)</span> çš„ç´¢å¼•ã€‚</li><li>å°†å‚ç›´çº¿å’Œæ–œçº¿çš„ç¨€ç–ç´¢å¼•è½¬æ¢ä¸ºç¨€ç–æ ¼å¼ <spanclass="math inline">\(\bm{i}_{vs}\)</span>ã€‚</li><li>åˆ©ç”¨è¿™äº›ç¨€ç–ç´¢å¼•ï¼Œæˆ‘ä»¬æ‰§è¡Œæ³¨æ„åŠ›æƒé‡å’Œæ³¨æ„åŠ›è¾“å‡ºçš„å—ç¨€ç–è®¡ç®—ã€‚</li></ol><h5 id="block-sparse">2) Block-Sparse</h5><ol type="1"><li>å¯¹ <span class="math inline">\(\bm{Q}\)</span> å’Œ <spanclass="math inline">\(\bm{K}\)</span> åº”ç”¨å‡å€¼æ± åŒ–ä»¥è·å¾— ( ) å’Œ ()ã€‚</li><li>å°†è¿™ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜ä»¥å¾—åˆ°ä¼°è®¡çš„å—çº§æ³¨æ„åŠ›æƒé‡ <spanclass="math inline">\(\bm{\hat{A}}\)</span>ã€‚ç”±äºå‡å€¼æ± åŒ–å’ŒçŸ©é˜µä¹˜æ³•æ“ä½œæ˜¯å¯äº¤æ¢çš„ï¼Œç»“æœæ³¨æ„åŠ›æƒé‡å¤§è‡´ç­‰åŒäºå‡å€¼æ± åŒ–åçš„å®é™…æ³¨æ„åŠ›æƒé‡ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä»¥æœ€å°çš„å¼€é”€è¿‘ä¼¼å®é™…æ³¨æ„åŠ›æƒé‡çš„å—ç¨€ç–æ¨¡å¼ã€‚</li><li>æ„å»ºä¸€ä¸ªç¨€ç–ç´¢å¼• <spanclass="math inline">\(\bm{i}_b\)</span>ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è®¡ç®—ç¨€ç–æ³¨æ„åŠ›æƒé‡å’Œæ³¨æ„åŠ›è¾“å‡ºã€‚</li></ol><h4 id="åˆ©ç”¨ä¼˜åŒ–åçš„gpu-kernelè¿›è¡Œç¨€ç–æ³¨æ„åŠ›è®¡ç®—">**2.3.3åˆ©ç”¨ä¼˜åŒ–åçš„GPU kernelè¿›è¡Œç¨€ç–æ³¨æ„åŠ›è®¡ç®—*</h4><h5 id="stream-llm"><em>Stream-LLM</em></h5><ol type="1"><li>åˆå§‹åŒ–å—èŒƒå›´å’Œæ©ç ï¼šæ ¹æ®æ»‘åŠ¨çª—å£å’Œå—å¤§å°è®¡ç®—è¦å¤„ç†çš„é”®å’Œå€¼å‘é‡çš„åˆ—èŒƒå›´ã€‚</li><li>å¾ªç¯å¤„ç†å—ï¼šéå†èŒƒå›´å†…çš„å—ï¼ŒåŠ è½½å¯¹åº”çš„é”®å’Œå€¼å‘é‡ã€‚</li><li>è®¡ç®—æŸ¥è¯¢-é”®ç‚¹ç§¯å¹¶åº”ç”¨æ©ç ï¼šè®¡ç®—æŸ¥è¯¢å’Œé”®å‘é‡çš„ç‚¹ç§¯ï¼Œå¹¶åº”ç”¨æ»‘åŠ¨çª—å£æ©ç ç¡®ä¿æ³¨æ„åŠ›æœºåˆ¶çš„æ–¹å‘æ€§ã€‚</li><li>æ›´æ–°ç´¯åŠ å™¨å’Œsoftmaxè®¡ç®—ï¼šè®¡ç®—softmaxæ¦‚ç‡å¹¶æ›´æ–°ç´¯åŠ å™¨ï¼Œæœ€ç»ˆå¾—åˆ°æ³¨æ„åŠ›æƒé‡çš„åŠ æƒå’Œã€‚</li></ol><h5 id="block-sparse-1"><em>Block-Sparse</em></h5><ol type="1"><li>åˆå§‹åŒ–æ©ç å’Œå—è®¡æ•°ï¼šç¡®å®šå“ªäº›æŸ¥è¯¢å‘é‡åœ¨å½“å‰å—å†…æœ‰æ•ˆï¼Œå¹¶è®¡ç®—éœ€è¦å¤„ç†çš„å—æ•°é‡ã€‚</li><li>å¾ªç¯å¤„ç†ç¨€ç–å—ï¼šéå†æ¯ä¸ªç¨€ç–å—ï¼ŒåŠ è½½ç›¸åº”çš„å—ç´¢å¼•å’Œåˆ—ç´¢å¼•ã€‚</li><li>åŠ è½½é”®å’Œå€¼å‘é‡çš„å—ï¼šä½¿ç”¨ç”Ÿæˆçš„åˆ—ç´¢å¼•åŠ è½½å¯¹åº”çš„é”®å‘é‡å’Œå€¼å‘é‡å—ã€‚</li><li>è®¡ç®—æŸ¥è¯¢å’Œé”®çš„ç‚¹ç§¯ï¼Œå¹¶åº”ç”¨å› æœæ©ç ï¼šè®¡ç®—æŸ¥è¯¢å’Œé”®å‘é‡çš„ç‚¹ç§¯ï¼Œå¹¶åº”ç”¨å› æœæ©ç ä»¥ç¡®ä¿æ³¨æ„åŠ›æœºåˆ¶çš„æ–¹å‘æ€§ã€‚</li><li>æ›´æ–°ç´¯åŠ å™¨å’Œsoftmaxè®¡ç®—ï¼šé€šè¿‡softmaxè®¡ç®—å’Œç´¯åŠ æ›´æ–°ç´¯åŠ å™¨ï¼Œæœ€ç»ˆå¾—åˆ°æ³¨æ„åŠ›æƒé‡çš„åŠ æƒå’Œã€‚</li><li>å†™å›è¾“å‡ºï¼šå°†ç´¯åŠ å’Œé™¤ä»¥å½’ä¸€åŒ–å› å­åå†™å›è¾“å‡ºã€‚</li></ol><h5 id="vertical-slash-1"><em>Vertical-Slash</em></h5><ol type="1"><li><strong>ç´¢å¼•æ’åºå’ŒèŒƒå›´è®¡ç®—</strong>ï¼š<ul><li>æ ¹æ®ç«–çº¿å’Œæ–œçº¿ç´¢å¼•æ’åºï¼Œå¹¶è®¡ç®—æ¯ä¸ªå—çš„èŒƒå›´ï¼Œç¡®å®šå“ªäº›å…ƒç´ éœ€è¦è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ã€‚</li></ul></li><li><strong>å—å†…å¹¶è¡Œè®¡ç®—</strong>ï¼š<ul><li>åœ¨æ¯ä¸ªå—å†…åˆ†åˆ«è®¡ç®—ç«–çº¿éƒ¨åˆ†å’Œæ–œçº¿éƒ¨åˆ†çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œé€šè¿‡åŠ è½½æŸ¥è¯¢ã€é”®ã€å€¼å‘é‡å—å¹¶è¿›è¡Œç‚¹ç§¯è®¡ç®—ã€‚</li><li>è®¡ç®—ç«–çº¿æ³¨æ„åŠ›åˆ†æ•°</li></ul><ol type="1"><li>å¾ªç¯éå†å—ç´¢å¼• block_indexï¼Œåœ¨æ¯ä¸ªå—å†…è®¡ç®—ç«–çº¿éƒ¨åˆ†çš„æ³¨æ„åŠ›åˆ†æ•°qkã€‚</li><li>ä½¿ç”¨ tl.dot(q, k) è®¡ç®—æŸ¥è¯¢å‘é‡å’Œé”®å‘é‡çš„ç‚¹ç§¯ï¼Œå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•°ã€‚</li><li>åº”ç”¨å› æœæ©ç  causal_maskç¡®ä¿ä»…è®¡ç®—å½“å‰æ—¶é—´æ­¥åŠä¹‹å‰çš„æ—¶é—´æ­¥ï¼Œå¹¶æ’é™¤æ‰ä¸ç›¸å…³çš„æœªæ¥æ—¶é—´æ­¥ã€‚</li><li>è®¡ç®—æ–°çš„æœ€å¤§å€¼ m_i_new å’Œæ¯”ä¾‹å› å­ alpha æ¥æ›´æ–°æ³¨æ„åŠ›åˆ†æ•°ã€‚</li><li>é€šè¿‡ p åŠ æƒå¹¶æ›´æ–°ç´¯åŠ å™¨ accã€‚</li></ol><ul><li>è®¡ç®—æ–œçº¿éƒ¨åˆ†</li></ul><ol type="1"><li>åœ¨å¦ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œé€šè¿‡åˆ—ç´¢å¼• start_néå†å—å†…æ‰€æœ‰åˆ—ï¼Œè®¡ç®—æ–œçº¿éƒ¨åˆ†çš„æ³¨æ„åŠ›åˆ†æ•°å’Œç´¯åŠ å€¼ã€‚</li><li>åŒæ ·ä½¿ç”¨ tl.dot(q, k) è®¡ç®—æŸ¥è¯¢å‘é‡å’Œé”®å‘é‡çš„ç‚¹ç§¯ï¼Œå¹¶åº”ç”¨æ©ç æ“ä½œm_mask å’Œ n_mask ç¡®ä¿è®¡ç®—çš„æ­£ç¡®æ€§ã€‚</li><li>è®¡ç®—æ–°çš„æœ€å¤§å€¼ m_i_new å’Œæ¯”ä¾‹å› å­ alphaï¼Œå¹¶é€šè¿‡ p æ›´æ–°ç´¯åŠ å™¨accã€‚</li></ol></li><li><strong>æ©ç åº”ç”¨å’Œå½’ä¸€åŒ–</strong>ï¼š<ul><li>åº”ç”¨æ©ç ç¡®ä¿åªè®¡ç®—ç›¸å…³éƒ¨åˆ†çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œå¹¶è¿›è¡Œæœ€å¤§å€¼æ›´æ–°å’Œå½’ä¸€åŒ–å¤„ç†ã€‚</li></ul></li><li><strong>æœ€ç»ˆè¾“å‡º</strong>ï¼š<ul><li>å°†å½’ä¸€åŒ–åçš„æ³¨æ„åŠ›è¾“å‡ºå†™å›åˆ°æœ€ç»ˆè¾“å‡ºå¼ é‡ä¸­ã€‚</li></ul></li></ol><h6 id="è·å–-vertical-slash-index-è¿”å›å—è®¡æ•°å—ç´¢å¼•åˆ—è®¡æ•°å’Œåˆ—ç´¢å¼•">è·å–Vertical-Slash Index: è¿”å›å—è®¡æ•°ã€å—ç´¢å¼•ã€åˆ—è®¡æ•°å’Œåˆ—ç´¢å¼•</h6><ol type="1"><li><strong>æ’åºç«–çº¿å’Œæ–œçº¿ç´¢å¼•</strong>ï¼š<ul><li>å¯¹ç«–çº¿ç´¢å¼•è¿›è¡Œå¢é‡æ’åº <code>IncrementalSort(i_v)</code></li><li>å¯¹æ–œçº¿ç´¢å¼•è¿›è¡Œé™åºæ’åº <code>DescendingSort(i_s)</code></li></ul></li><li><strong>è®¡ç®—å—æ•°</strong>ï¼š<ul><li>è®¡ç®—å—æ•°é‡ ( N )</li></ul></li><li><strong>åˆå§‹åŒ–è¾“å‡º</strong>ï¼š<ul><li>åˆå§‹åŒ–å—è®¡æ•° <code>block count</code> ( c_{} ^{N} )</li><li>åˆå§‹åŒ–å—ç´¢å¼• <code>block index</code> ( i_{} ^{N k_v} )</li><li>åˆå§‹åŒ–åˆ—è®¡æ•° <code>column count</code> ( c_{} ^{N} )</li><li>åˆå§‹åŒ–åˆ—ç´¢å¼• <code>column index</code> ( i_{} ^{N k_s} )</li></ul></li><li><strong>å¹¶è¡ŒåŒ–å¤„ç†</strong>ï¼š<ul><li>å¯¹æ¯ä¸ªå—è¿›è¡Œéå†ï¼Œæ‰¾åˆ°äº¤å‰ç«–çº¿å’Œæ–œçº¿çš„ä½ç½®ï¼Œè®°å½•èŒƒå›´å¹¶æ›´æ–°å—ç´¢å¼•å’Œåˆ—ç´¢å¼•ã€‚</li></ul></li><li><strong>åˆå¹¶ç‚¹ï¼ˆç«–çº¿ç´¢å¼•å’Œæ–œçº¿ç´¢å¼•èŒƒå›´ï¼‰</strong>ï¼š<ul><li>é€šè¿‡åˆå¹¶ç‚¹å’ŒèŒƒå›´æ¥æ›´æ–°å—å’Œåˆ—ä¿¡æ¯ã€‚</li></ul></li></ol><h6 id="è·å–-vertical-slash-flash-attention">è·å– Vertical-Slash FlashAttention</h6><ol type="1"><li><strong>åˆå§‹åŒ–</strong>ï¼š<ul><li>ç¼©æ”¾å› å­ ( )</li><li>åˆå§‹åŒ–è¾“å‡º ( O (0)^{S d_h} )</li></ul></li><li><strong>å¹¶è¡ŒåŒ–å¤„ç†ï¼ˆç«–çº¿éƒ¨åˆ†ï¼‰</strong>ï¼š<ul><li>å¯¹æ¯ä¸ªå—è¿›è¡Œéå†ï¼ŒåŠ è½½æŸ¥è¯¢å— ( Q_{} )ï¼Œåˆå§‹åŒ–è¾“å‡ºå— ( O_{} )</li><li>åˆå§‹åŒ–æœ€å¤§å€¼ ( m ()^{B} ) å’Œç´¯è®¡é‡ ( l (0)^{B} )</li><li>éå†å—ç´¢å¼•ï¼ŒåŠ è½½é”®å’Œå€¼å—ï¼Œè®¡ç®—æ³¨æ„åŠ›åˆ†æ•° ( S Q_{} K_{}^T )</li><li>åº”ç”¨æ©ç å’Œç¼©æ”¾ï¼Œæ›´æ–°æœ€å¤§å€¼å’Œç´¯è®¡é‡ï¼Œè®¡ç®—åŠ æƒå’Œæ›´æ–°è¾“å‡ºå— ( O_{})</li></ul></li><li><strong>å¹¶è¡ŒåŒ–å¤„ç†ï¼ˆæ–œçº¿éƒ¨åˆ†ï¼‰</strong>ï¼š<ul><li>éå†åˆ—ç´¢å¼•ï¼ŒåŠ è½½é”®å’Œå€¼å—ï¼Œè®¡ç®—æ³¨æ„åŠ›åˆ†æ•° ( S Q_{} K_{}^T )</li><li>åº”ç”¨æ©ç å’Œç¼©æ”¾ï¼Œæ›´æ–°æœ€å¤§å€¼å’Œç´¯è®¡é‡ï¼Œè®¡ç®—åŠ æƒå’Œæ›´æ–°è¾“å‡ºå— ( O_{})</li></ul></li><li><strong>å†™å›è¾“å‡º</strong>ï¼š<ul><li>å¯¹è¾“å‡ºå—è¿›è¡Œå½’ä¸€åŒ– ( O_{} (l^{-1}) O_{} )</li><li>ä¿å­˜æœ€ç»ˆè¾“å‡º ( O_i O_{} )</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹Mistral</title>
      <link href="/2024/08/08/NLP/LLMModels/Mistral/"/>
      <url>/2024/08/08/NLP/LLMModels/Mistral/</url>
      
        <content type="html"><![CDATA[<h1 id="mistral-ai">Mistral AI</h1><h2 id="mistral-7b">Mistral-7B</h2><ol type="1"><li>é‡‡ç”¨äº†åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›(GQA)ï¼Œæ˜¾è‘—åŠ å¿«äº†æ¨ç†é€Ÿåº¦ï¼Œè¿˜å‡å°‘äº†è§£ç æœŸé—´çš„å†…å­˜éœ€æ±‚ï¼Œå…è®¸æ›´é«˜çš„æ‰¹å¤„ç†å¤§å°ï¼Œä»è€Œæé«˜ååé‡</li><li>ç»“åˆæ»‘åŠ¨çª—å£æ³¨æ„åŠ›(SWA)ä»¥æœ‰æ•ˆå¤„ç†ä»»æ„é•¿åº¦çš„åºåˆ—<ol type="1"><li>æ¯ä¸ªtokenæœ€å¤šå¯ä»¥å…³æ³¨æ¥è‡ªä¸Šä¸€å±‚çš„Wä¸ªtoken(æ³¨ï¼Œæ»‘åŠ¨çª—å£ä¹‹å¤–çš„tokenä»ç„¶å½±å“ä¸‹ä¸€ä¸ªå•è¯é¢„æµ‹)</li><li>å›ºå®šçš„æ³¨æ„åŠ›é•¿åº¦æ„å‘³ç€å¯ä»¥ä½¿ç”¨æ»šåŠ¨ç¼“å­˜æ¥é™åˆ¶çš„ç¼“å­˜å¤§å°</li></ol></li></ol><h2 id="mixtral-8x7b">Mixtral-8x7B</h2><figure><img src="./images/Mixtral8x7B.webp#50x50" title="å›¾1ï¼šMistral-8x7B"alt="Mistral-8x7B" /><figcaption aria-hidden="true">Mistral-8x7B</figcaption></figure><ol type="1"><li>FFNä»ä¸€ç»„ 8 ä¸ªä¸åŒçš„å‚æ•°ç»„ä¸­è¿›è¡Œé€‰æ‹©</li><li>åœ¨æ¯ä¸€å±‚ï¼Œå¯¹äºæ¯ä¸ªtokenï¼Œè·¯ç”±å™¨ç½‘ç»œé€‰æ‹©å…¶ä¸­çš„ä¸¤ä¸ªç»„(â€œä¸“å®¶â€)æ¥å¤„ç†tokenå¹¶é€šè¿‡ç»„åˆç›¸åŠ å¾—åˆ°å®ƒä»¬çš„è¾“å‡º</li><li>åœ¨å„ä¸ªå±‚ä¸­ä»…æœ‰expertséƒ¨åˆ†(FFN)æ˜¯ç‹¬ç«‹å­˜åœ¨çš„ï¼Œå…¶ä½™çš„éƒ¨åˆ†(Attentionç­‰)åˆ™æ˜¯å„ä¸ªexpertå‡æœ‰å…±äº«çš„</li><li>è·¯ç”±(Gating/Router)æœ¬è´¨æ˜¯ä¸€ä¸ªçº¿æ€§å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸ºéšå±‚ç»´åº¦hidden_dimã€è¾“å‡ºç»´åº¦ä¸ºexpertæ•°num_expertsã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹T-MAC</title>
      <link href="/2024/08/08/NLP/LLMModels/T-MAC/"/>
      <url>/2024/08/08/NLP/LLMModels/T-MAC/</url>
      
        <content type="html"><![CDATA[<h1 id="t-mac">T-MAC</h1><p>CPUä¸Šé€šè¿‡æŸ¥æ‰¾è¡¨è¿›è¡Œä½æ¯”ç‰¹é‡åŒ–å¤§æ¨¡å‹éƒ¨ç½² åŸæ–‡é“¾æ¥ï¼š<ahref="https://arxiv.org/abs/2407.00088">CPU Renaissance via Table Lookupfor Low-Bit LLM Deployment on Edge</a> GitHubé“¾æ¥ï¼š<ahref="https://github.com/microsoft/T-MAC">T-MAC</a></p><h2 id="é—®é¢˜æå‡º">é—®é¢˜æå‡º</h2><p>æƒé‡é‡åŒ–å¯¹äºå‡å°‘ LLM åœ¨è®¾å¤‡ä¸Šçš„å†…å­˜å ç”¨è‡³å…³é‡è¦ã€‚ç„¶è€Œï¼Œä½ä½ LLMéœ€è¦åœ¨æ¨ç†è¿‡ç¨‹ä¸­è¿›è¡Œä½ç²¾åº¦æƒé‡å’Œé«˜ç²¾åº¦æ¿€æ´»çš„æ··åˆç²¾åº¦çŸ©é˜µä¹˜æ³•(mpGEMM)ã€‚ç°æœ‰ç³»ç»Ÿç¼ºä¹å¯¹ mpGEMMçš„åŸç”Ÿæ”¯æŒï¼Œåªèƒ½é€šè¿‡å»é‡åŒ–æƒé‡æ¥å®ç°é«˜ç²¾åº¦è®¡ç®—ã€‚è¿™ç§é—´æ¥çš„æ–¹å¼å¯èƒ½ä¼šå¯¼è‡´æ˜¾ç€çš„æ¨ç†å¼€é”€ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2><figure><img src="./images/overview.webp#70x70" title="å›¾1: T-MAC Overview"alt="T-MAC Overview" /><figcaption aria-hidden="true">T-MAC Overview</figcaption></figure><h3 id="t-macç®€ä»‹">T-MACç®€ä»‹</h3><p>ä¸€ç§åŸºäºæŸ¥æ‰¾è¡¨ (LUT)çš„æ–¹æ³•ï¼Œå°†ä¼ ç»Ÿçš„ä»¥æ•°æ®ç±»å‹ä¸ºä¸­å¿ƒçš„<strong>ä¹˜æ³•</strong>è½¬æ¢ä¸º<strong>æŒ‰ä½è¡¨æŸ¥æ‰¾</strong>ï¼Œä¸“ä¸ºCPU ä¸Šçš„é«˜æ•ˆä½ä½ LLMï¼ˆå³æƒé‡é‡åŒ– LLMï¼‰æ¨ç†è€Œè®¾è®¡ã€‚</p><p>ç›´æ¥æ”¯æŒ mpGEMMï¼Œæ— éœ€åé‡åŒ–ï¼Œç®€åŒ–ä¸ºæŸ¥è¡¨+åŠ æ³•æ“ä½œ</p><figure><img src="./images/fig_intro.webp#70x70"title="å›¾2: T-MAC vs general practice for mpGEMM"alt="T-MAC vs general practice for mpGEMM" /><figcaption aria-hidden="true">T-MAC vs general practice formpGEMM</figcaption></figure><p>ä¸¤ä¸ªæ•°çš„ä¹˜æ³•å¯ä»¥è½¬åŒ–ä¸º<strong>ä¸€ä¸ªæ•°</strong>ä¹˜ä»¥<strong>å¦ä¸€ä¸ªæ•°çš„æ¯ä¸€ä½</strong>ï¼Œç„¶å<strong>ç§»ä½å¹¶ç›¸åŠ </strong>éƒ¨åˆ†ç§¯ã€‚æ¿€æ´»çŸ©é˜µå’Œæƒé‡çŸ©é˜µä¹‹é—´çš„mpGEMM è¢«åˆ†è§£ä¸ºæ¿€æ´»çŸ©é˜µå’Œä¸€ä½çŸ©é˜µä¹‹é—´çš„ mpGEMMçš„ä¸€ç³»åˆ—ï¼ˆ=æƒé‡çš„ä½å®½ï¼‰ï¼Œç„¶åå°†éƒ¨åˆ†ç»“æœç›¸åŠ ã€‚å› æ­¤ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ”¯æŒæ¿€æ´»å’Œæƒé‡çš„ä»»ä½•ä½å®½ç»„åˆã€‚</p><p><span class="math display">\[\begin{equation}A\times W=A\times(\sum^{n-1}_{i=0}2^i W_i)=\sum^{n-1}_{i=0}2^i A\timesW_i\end{equation}\]</span></p><p>å¯¹äºæ··åˆç²¾åº¦ GEMMï¼Œğ´ å’Œ ğ‘Š åˆ†åˆ«æ˜¯æ¿€æ´»çŸ©é˜µå’Œæƒé‡çŸ©é˜µã€‚ğ‘› æ˜¯æƒé‡çš„ä½å®½ã€‚ğ‘Šğ‘– æ˜¯ ğ‘Š çš„æ¯ä¸€ä½çŸ©é˜µã€‚</p><h3 id="åŸç†">åŸç†</h3><h4 id="æŒ‰ä½å¸ƒå±€å’Œä¹˜æ³•">æŒ‰ä½å¸ƒå±€å’Œä¹˜æ³•</h4><p>æ•´ä¸ªè®¡ç®—çš„æµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure><img src="./images/LUTGEMV.webp#80x80"title="å›¾3: LUT example for mpGEMM" alt="LUT example for mpGEMM" /><figcaption aria-hidden="true">LUT example for mpGEMM</figcaption></figure><h5 id="ç¦»çº¿å‡†å¤‡é˜¶æ®µ">ç¦»çº¿å‡†å¤‡é˜¶æ®µ</h5><p>åœ¨ç¦»çº¿å‡†å¤‡é˜¶æ®µï¼Œ<code>n-bit</code>æƒé‡çŸ©é˜µè¢«åˆ†è§£ä¸º<code>nä¸ª1-bit</code>çŸ©é˜µã€‚ç”±äº<code>1-bit</code>åªèƒ½ä»£è¡¨ä¸¤ä¸ªå€¼ï¼Œå¯¹äºå…·æœ‰<code>ğ‘”-bit</code>çš„ç»„ï¼Œå¯èƒ½çš„æ’åˆ—åªæœ‰<spanclass="math inline">\(2^ğ‘”\)</span>ã€‚è¡¨å¤§å°ä¸º<spanclass="math inline">\([1, 2^ğ‘”]\)</span>ã€‚</p><p>åœ¨è¿™é‡Œï¼Œè¡¨çš„å¤§å°æ˜¯æ ¹æ®æƒé‡çš„è¡Œæ•°æ¥ç¡®å®šçš„ï¼Œä¸æƒé‡çš„ä½å®½æ— å…³ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª<code>8-bit</code>ä¸”<code>g</code>è¡Œçš„æƒé‡çŸ©é˜µï¼Œä¼šåˆ†ä¸º<code>8</code>ä¸ªä¸€æ ·çš„<code>1-bit</code>çŸ©é˜µï¼ŒçŸ©é˜µçš„å¤§å°ä¸º<spanclass="math inline">\([1, 2^g]\)</span>ã€‚</p><h5 id="åœ¨çº¿é˜¶æ®µ">åœ¨çº¿é˜¶æ®µ</h5><p>å¯¹äºåœ¨çº¿é˜¶æ®µï¼Œç»™å®š GEMM çš„è¾“å…¥æ¿€æ´»ï¼ŒT-MAC æ„å»ºä¸€ä¸ªè¡¨ã€‚åœ¨ LUTæœŸé—´ï¼Œä¸€ä½æƒé‡çŸ©é˜µçš„æ¯ä¸ªç´¢å¼•ç”¨äºæŸ¥æ‰¾éƒ¨åˆ†ç»“æœçš„è¡¨ã€‚éƒ¨åˆ†ç»“æœçš„ç´¯åŠ å°†æ˜¯æœ€ç»ˆçš„GEMMç»“æœã€‚</p><p>å’Œå³è¾¹è¡¨çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><ol type="1"><li>å·¦è¾¹æ˜¯0001çš„æ—¶å€™ï¼Œéœ€è¦è®¡ç®—<code>D</code>çš„å€¼</li><li>å·¦è¾¹æ˜¯0011çš„æ—¶å€™ï¼Œéœ€è¦è®¡ç®—<code>C + D</code>çš„å€¼</li></ol><p>è¡¨ä¸­çš„<code>-</code>ä»£è¡¨èˆå¼ƒçš„å€¼ï¼Œå› ä¸ºè¿™äº›å€¼åœ¨è®¡ç®—ä¸­ä¸ä¼šè¢«ç”¨åˆ°ã€‚</p><h4 id="æŒ‘æˆ˜">æŒ‘æˆ˜</h4><ol type="1"><li>éšæœºæ•°æ®è®¿é—®ã€‚æœ‰å¿…è¦å°†è¡¨å­˜æ”¾åœ¨å¿«é€Ÿon-chipmemoryä¸­ä»¥é™ä½è®¿é—®æˆæœ¬ã€‚</li><li>éœ€è¦æ›´å¤šon-chipmemoryã€‚æŸ¥æ‰¾è¡¨éœ€è¦<strong>ä¿å­˜æ¿€æ´»å‘é‡</strong>ä¸æ‰€æœ‰<strong>å¯èƒ½çš„ä½æ¨¡å¼ç›¸ä¹˜çš„ä¸­é—´ç»“æœ</strong>ä»¥ç»„åˆä¸ºçœŸæ­£çš„ç»“æœã€‚</li></ol><h5 id="ä»¥-lut-ä¸ºä¸­å¿ƒçš„æ•°æ®å¸ƒå±€">ä»¥ LUT ä¸ºä¸­å¿ƒçš„æ•°æ®å¸ƒå±€</h5><ol type="1"><li><strong>å°†æŸ¥æ‰¾è¡¨æ”¾åœ¨on-chip memoryä¸Š</strong> åˆ©ç”¨ CPUä¸Šçš„æŸ¥è¡¨å‘é‡æŒ‡ä»¤ (TBL/PSHUF) æå‡éšæœºè®¿å­˜æ€§èƒ½</li><li><strong>æ”¹å˜çŸ©é˜µ axisè®¡ç®—é¡ºåº</strong>ï¼Œä»¥å°½å¯èƒ½æå‡æ”¾å…¥ç‰‡ä¸Šå†…å­˜çš„æœ‰é™ LUTçš„æ•°æ®é‡ç”¨ç‡ã€‚</li><li><strong>ä¸ºæŸ¥è¡¨å•ç‹¬è®¾è®¡æœ€ä¼˜çŸ©é˜µåˆ†å—</strong> (Tiling) æ–¹å¼</li></ol><h5 id="è¡¨å‹ç¼©æ–¹æ³•">è¡¨å‹ç¼©æ–¹æ³•</h5><ol type="1"><li><strong>é•œåƒæ•´åˆ</strong>ã€‚ LLMæ¨ç†çš„æŸ¥æ‰¾è¡¨ä¸Šä¸‹æ–‡ä¸­è¡¨å€¼å›ºæœ‰çš„å¯¹ç§°å±æ€§æä¾›äº†ç‹¬ç‰¹çš„ä¼˜åŒ–æœºä¼šã€‚è¡¨ä¸­çš„æ¯ä¸ªæ­£å€¼è‡ªç„¶åœ°ä¸å…¶å¯¹åº”çš„è´Ÿå€¼é…å¯¹ï¼Œåæ˜ é›¶å€¼ä¸Šçš„é•œåƒã€‚</li><li><strong>è¡¨é‡åŒ–</strong>ã€‚è¡¨é‡åŒ–çš„è¿è¡ŒåŸç†ç±»ä¼¼äºæƒé‡å’Œæ¿€æ´»é‡åŒ–ï¼Œæ—¨åœ¨é™ä½è¡¨å€¼çš„ç²¾åº¦ä»¥æé«˜è®¡ç®—æ•ˆç‡ã€‚ä¾‹å¦‚ï¼šæœ€åˆåœ¨æŸ¥æ‰¾è¡¨ä¸­ä»¥16 ä½æµ®ç‚¹ (fp16) è¡¨ç¤ºçš„å€¼å¯ä»¥é€šè¿‡ç¼©æ”¾å› å­é‡åŒ–ä¸º 8 ä½æ•´æ•° (int8)ã€‚</li></ol><p>å®éªŒå®£ç§°ï¼šè¡¨å‹ç¼©å¯¹æ¨¡å‹çš„æ¨ç†ç²¾åº¦çš„å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†æ˜¯å¯ä»¥æ˜¾è‘—æé«˜æ¨ç†æ€§èƒ½ã€‚</p><figure><img src="./images/table_reduction.webp#50x50"title="å›¾4: é•œåƒåˆå¹¶ä½¿è¡¨é•¿åº¦å‡åŠ;è¡¨é‡åŒ–å‡å°‘äº†è¡¨å®½åº¦"alt="é•œåƒåˆå¹¶ä½¿è¡¨é•¿åº¦å‡åŠã€‚è¡¨é‡åŒ–å‡å°‘äº†è¡¨å®½åº¦" /><figcaptionaria-hidden="true">é•œåƒåˆå¹¶ä½¿è¡¨é•¿åº¦å‡åŠã€‚è¡¨é‡åŒ–å‡å°‘äº†è¡¨å®½åº¦</figcaption></figure><h2 id="è¯„ä¼°">è¯„ä¼°</h2><h3 id="ç²¾åº¦æŸå¤±">ç²¾åº¦æŸå¤±</h3><p>T-MACä¸ºæ¨¡å‹æ¨ç†å¼•å…¥çš„è¯¯å·®å¯ä»¥å¿½ç•¥ä¸è®¡ï¼ŒåŒæ—¶æä¾›æ˜¾ç€çš„åŠ é€Ÿã€‚å¿«é€Ÿèšåˆ(FA)å¯ä»¥è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œä½†ä»£ä»·æ˜¯æ¨¡å‹è´¨é‡ã€‚</p><h4 id="ç›¸å¯¹äºæœªé‡åŒ–ğ‘Šğ¹ğ‘ƒ16ğ´ğ¹ğ‘ƒ16gemvå†…æ ¸çš„å½’ä¸€åŒ–å‡æ–¹è¯¯å·®nmse">1.ç›¸å¯¹äºæœªé‡åŒ–(ğ‘Šğ¹ğ‘ƒ16ğ´ğ¹ğ‘ƒ16)GEMVå†…æ ¸çš„å½’ä¸€åŒ–å‡æ–¹è¯¯å·®NMSE</h4><table><colgroup><col style="width: 21%" /><col style="width: 26%" /><col style="width: 22%" /><col style="width: 30%" /></colgroup><thead><tr><th style="text-align: center;"><spanclass="math inline">\(\textbf{MxKxN}\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{llama.cpp}\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{T-MAC}\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{T-MAC(+FA)}\)</span></th></tr></thead><tbody><tr><td style="text-align: center;">4096x4096x1</td><td style="text-align: center;">3.33e-03</td><td style="text-align: center;">3.35e-03</td><td style="text-align: center;">8.09e-03</td></tr><tr><td style="text-align: center;">11008x4096x1</td><td style="text-align: center;">3.44e-03</td><td style="text-align: center;">3.46e-03</td><td style="text-align: center;">8.27e-03</td></tr><tr><td style="text-align: center;">4096x11008x1</td><td style="text-align: center;">4.13e-03</td><td style="text-align: center;">4.15e-03</td><td style="text-align: center;">8.45e-03</td></tr></tbody></table><h4 id="wikitext-2-å’Œ-ambada_openai-çš„å›°æƒ‘åº¦winogrande-çš„é—®ç­”å‡†ç¡®æ€§">2.WikiText-2 å’Œ ambada_openai çš„å›°æƒ‘åº¦ï¼ŒWinoGrande çš„é—®ç­”å‡†ç¡®æ€§</h4><table><colgroup><col style="width: 20%" /><col style="width: 20%" /><col style="width: 18%" /><col style="width: 23%" /><col style="width: 18%" /></colgroup><thead><tr><th style="text-align: center;"><spanclass="math inline">\(\textbf{Framework}\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{Throughput}\)</span> <br> <spanclass="math inline">\(Tokens/sec \uparrow\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{WikiText2}\)</span> <br> <spanclass="math inline">\(PPL\downarrow\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{lambada\_openai}\)</span> <br> <spanclass="math inline">\(PPL\downarrow\)</span></th><th style="text-align: center;"><spanclass="math inline">\(\textbf{WinoGrande}\)</span> <br> <spanclass="math inline">\(Acc.\uparrow\)</span></th></tr></thead><tbody><tr><td style="text-align: center;">Un-quantized</td><td style="text-align: center;">3.79</td><td style="text-align: center;">5.80</td><td style="text-align: center;">12.65</td><td style="text-align: center;">71.0</td></tr><tr><td style="text-align: center;">llama.cpp</td><td style="text-align: center;">5.65</td><td style="text-align: center;">5.96</td><td style="text-align: center;">12.95</td><td style="text-align: center;">70.8</td></tr><tr><td style="text-align: center;">T-MAC</td><td style="text-align: center;">7.34</td><td style="text-align: center;">5.96</td><td style="text-align: center;">12.95</td><td style="text-align: center;">70.8</td></tr><tr><td style="text-align: center;">T-MAC (+FA)</td><td style="text-align: center;">8.97</td><td style="text-align: center;">6.38</td><td style="text-align: center;">13.99</td><td style="text-align: center;">67.8</td></tr></tbody></table><h3 id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”</h3><p>åœ¨GPUä¸Šä½¿ç”¨æŸ¥æ‰¾è¡¨å°½ç®¡ç†è®ºä¸Šè®¡ç®—å¤æ‚åº¦é™ä½äº†ï¼Œä½†å®é™…çš„å†…æ ¸æ€§èƒ½æ¯”åŸºäºåé‡åŒ–çš„å†…æ ¸è¦å·®ã€‚è¿™å¯èƒ½å½’å› äºGPUå›ºå®šæ¶æ„çš„é™åˆ¶ï¼Œè¯¥æ¶æ„ä¸ºæŸ¥æ‰¾è¡¨æä¾›çš„å­˜å‚¨å®¹é‡ä¸è¶³æˆ–è¡¨è®¿é—®é€Ÿåº¦ä¸å¤Ÿå¿«ã€‚</p><p>å› æ­¤æœ¬æ–‡æ¢ç´¢äº† CPU ä¸Šçš„æŸ¥æ‰¾è¡¨å†…æ ¸ã€‚</p><h4 id="é€æ­¥åº”ç”¨-t-mac-ä¼˜åŒ–">1. é€æ­¥åº”ç”¨ T-MAC ä¼˜åŒ–</h4><p>é€šè¿‡é€æ­¥åº”ç”¨ T-MAC ä¼˜åŒ–ï¼ŒLlama-2-7B/13B GEMV å†…æ ¸åœ¨ M2-Ultraä¸Šçš„å¤šçº¿ç¨‹æ€§èƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/ablation.webp#80x80" title="å›¾5: æ€§èƒ½å¯¹æ¯”"alt="Performance comparison" /><figcaption aria-hidden="true">Performance comparison</figcaption></figure><p>S0-S5ï¼šä¸åŒçš„çŸ©é˜µå½¢çŠ¶ï¼ŒTMï¼šT-MACï¼ŒTQï¼šè¡¨é‡åŒ–ï¼ŒPerm.ï¼šæ’åˆ—ï¼ŒILï¼šäº¤ç»‡ï¼ŒFAï¼šå¿«é€Ÿèšåˆã€‚</p><h4 id="å’Œéªé¾™-x-elite-npuèŠ¯ç‰‡çš„æ€§èƒ½å¯¹æ¯”">2. å’Œéªé¾™ X-ELiteNPUèŠ¯ç‰‡çš„æ€§èƒ½å¯¹æ¯”</h4><p>X-ELite NPU åªèƒ½ç”Ÿæˆ 10.4 ä¸ª token/secï¼Œè€Œä½¿ç”¨ T-MAC çš„ CPUåœ¨ä¸¤æ ¸çš„æƒ…å†µä¸‹å°±èƒ½è¾¾åˆ° 12.6 ä¸ª token/secï¼Œç”šè‡³æœ€é«˜èƒ½è¾¾åˆ° 22 ä¸ªtoken/secã€‚è€ƒè™‘åˆ° T-MACçš„è®¡ç®—æ€§èƒ½èƒ½éšç€ä½æ•°çš„å‡å°‘è€Œçº¿æ€§æå‡ï¼ˆè¿™åœ¨åŸºäºåé‡åŒ–çš„ GPU å’Œ NPUä¸Šæ˜¯è§‚å¯Ÿä¸åˆ°çš„ï¼‰ï¼ŒT-MAC ç”šè‡³å¯ä»¥åœ¨ 2 ä¸ª bit ä¸‹åŒ¹æ•Œå•æ ¸ CPU çš„ NPUã€‚</p><table><colgroup><col style="width: 23%" /><col style="width: 23%" /><col style="width: 18%" /><col style="width: 34%" /></colgroup><thead><tr><th>Framework</th><th>Model</th><th>NUM_THREADS</th><th style="text-align: left;">Throughput <br> (tokens/sec)</th></tr></thead><tbody><tr><td>T-MAC (CPU)</td><td>llama-2-7b (W4)</td><td>2</td><td style="text-align: left;"><b>12.6</b></td></tr><tr><td>T-MAC (CPU)</td><td>llama-2-7b (W4)</td><td>4</td><td style="text-align: left;"><b>18.7</b></td></tr><tr><td>T-MAC (CPU)</td><td>llama-2-7b (W2)</td><td>1</td><td style="text-align: left;">9.3</td></tr><tr><td>T-MAC (CPU)</td><td>llama-2-7b (W2)</td><td>4</td><td style="text-align: left;"><b>28.4</b></td></tr><tr><td></td><td></td><td></td><td style="text-align: left;"></td></tr><tr><td>NPE (NPU)</td><td>llama-2-7b (W4)</td><td>-</td><td style="text-align: left;">10.4</td></tr></tbody></table><h4 id="å’Œ-nvidia-jetson-agx-orinä¸Šçš„æ€§èƒ½å¯¹æ¯”">3. å’Œ NVIDIA Jetson AGXOrinä¸Šçš„æ€§èƒ½å¯¹æ¯”</h4><p>NVIDIA Jetson AGX Orin ä¸Šçš„ Llama-2-7B (W2)çš„ååé‡/åŠŸç‡/èƒ½é‡æ¯”è¾ƒï¼ˆCPU çš„ NUM_THREADS=12ï¼‰</p><table style="width:100%;"><colgroup><col style="width: 23%" /><col style="width: 34%" /><col style="width: 17%" /><col style="width: 24%" /></colgroup><thead><tr><th>Framework</th><th style="text-align: left;">Throughput (tokens/sec)</th><th style="text-align: left;">Power (W)</th><th style="text-align: left;">Energy (J/token)</th></tr></thead><tbody><tr><td>llama.cpp (CPU)</td><td style="text-align: left;">7.08</td><td style="text-align: left;">15.0</td><td style="text-align: left;">2.12</td></tr><tr><td>llama.cpp (GPU)</td><td style="text-align: left;"><b>20.03</b></td><td style="text-align: left;">30.8</td><td style="text-align: left;">1.54</td></tr><tr><td>T-MAC (CPU)</td><td style="text-align: left;">15.62</td><td style="text-align: left;"><b>10.4</b></td><td style="text-align: left;"><b>0.66</b></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹PowerInfer</title>
      <link href="/2024/08/08/NLP/LLMModels/PowerInfer/Introduction/"/>
      <url>/2024/08/08/NLP/LLMModels/PowerInfer/Introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="powerinfer">PowerInfer</h1><figure><img src="./images/PowerInfer.svg" alt="PowerInfer" /><figcaption aria-hidden="true">PowerInfer</figcaption></figure><h2 id="powerinfer-1.0">PowerInfer 1.0</h2><p>PowerInfer æ˜¯ä¸€æ¬¾åœ¨é…å¤‡å•ä¸ªæ¶ˆè´¹çº§ GPU çš„ä¸ªäººè®¡ç®—æœº (PC)ä¸Šè¿è¡Œçš„é«˜é€Ÿå¤§å‹è¯­è¨€æ¨¡å‹ (LLM) æ¨ç†å¼•æ“ã€‚PowerInfer è®¾è®¡çš„å…³é”®åœ¨äºåˆ©ç”¨LLM æ¨ç†å›ºæœ‰çš„é«˜å±€éƒ¨æ€§ ï¼Œå…¶ç‰¹ç‚¹æ˜¯ç¥ç»å…ƒæ¿€æ´»å‘ˆç°å¹‚å¾‹åˆ†å¸ƒã€‚</p><p>è¿™ç§åˆ†å¸ƒè¡¨æ˜ï¼Œä¸€å°éƒ¨åˆ†ç¥ç»å…ƒï¼ˆç§°ä¸ºçƒ­ç¥ç»å…ƒï¼‰åœ¨è¾“å…¥è¿‡ç¨‹ä¸­å§‹ç»ˆå¤„äºæ¿€æ´»çŠ¶æ€ï¼Œè€Œå¤§å¤šæ•°ç¥ç»å…ƒï¼ˆå†·ç¥ç»å…ƒï¼‰åˆ™æ ¹æ®ç‰¹å®šè¾“å…¥è€Œå˜åŒ–ã€‚PowerInferåˆ©ç”¨è¿™ç§æ´å¯ŸåŠ›è®¾è®¡äº† GPU-CPU æ··åˆæ¨ç†å¼•æ“ï¼šçƒ­æ¿€æ´»ç¥ç»å…ƒé¢„åŠ è½½åˆ° GPUä¸Šä»¥ä¾¿å¿«é€Ÿè®¿é—®ï¼Œè€Œå†·æ¿€æ´»ç¥ç»å…ƒåˆ™åœ¨ CPU ä¸Šè®¡ç®—ï¼Œä»è€Œæ˜¾è‘—å‡å°‘ GPUå†…å­˜éœ€æ±‚å’Œ CPU-GPU æ•°æ®ä¼ è¾“ã€‚PowerInferè¿›ä¸€æ­¥é›†æˆäº†è‡ªé€‚åº”é¢„æµ‹å™¨å’Œç¥ç»å…ƒæ„ŸçŸ¥ç¨€ç–è¿ç®—ç¬¦ï¼Œä¼˜åŒ–äº†ç¥ç»å…ƒæ¿€æ´»å’Œè®¡ç®—ç¨€ç–æ€§çš„æ•ˆç‡ã€‚</p><ul><li>ä»¥å±€éƒ¨ä¸ºä¸­å¿ƒçš„è®¾è®¡ï¼šåˆ©ç”¨ç¨€ç–æ¿€æ´»å’Œâ€œçƒ­â€/â€œå†·â€ç¥ç»å…ƒæ¦‚å¿µè¿›è¡Œé«˜æ•ˆçš„ LLMæ¨ç†ï¼Œç¡®ä¿åœ¨è¾ƒä½çš„èµ„æºéœ€æ±‚ä¸‹å®ç°è¾ƒé«˜çš„é€Ÿåº¦ã€‚</li><li>æ··åˆ CPU/GPU åˆ©ç”¨ç‡ï¼šæ— ç¼é›†æˆ CPU å’Œ GPUçš„å†…å­˜/è®¡ç®—èƒ½åŠ›ï¼Œå®ç°å·¥ä½œè´Ÿè½½å¹³è¡¡å’Œå¤„ç†é€Ÿåº¦æ›´å¿«ã€‚</li></ul><h2 id="powerinfer-2.0">PowerInfer 2.0</h2><p>PowerInfer-2æ˜¯ä¸€ä¸ªä¸ºæ™ºèƒ½æ‰‹æœºä¸Šå¤§å‹è¯­è¨€æ¨¡å‹(LLM)é«˜é€Ÿæ¨ç†è€Œè®¾è®¡çš„æ¡†æ¶ï¼Œç‰¹åˆ«é€‚ç”¨äºå¤§å°è¶…è¿‡è®¾å¤‡å†…å­˜å®¹é‡çš„æ¨¡å‹ã€‚æ ¸å¿ƒæ˜¯å°†LLMæ¨ç†ä¸­å…¸å‹çš„ç²—ç²’åº¦çŸ©é˜µè®¡ç®—åˆ†è§£ä¸ºç»†ç²’åº¦ç¥ç»å…ƒé›†ç¾¤è®¡ç®—ã€‚PowerInfer-2ä»¥ç¥ç»å…ƒç°‡çš„ç²’åº¦è¿›è¡Œè®¡ç®—å’ŒI/Oæ“ä½œï¼Œç¥ç»å…ƒç°‡å¯ä»¥åœ¨è®¡ç®—è¿‡ç¨‹ä¸­åŠ¨æ€åœ°ç”±å¤šä¸ªæ¿€æ´»çš„ç¥ç»å…ƒç»„æˆï¼Œç¥ç»å…ƒçš„æ•°é‡ç”±è®¡ç®—å•å…ƒçš„è®¡ç®—èƒ½åŠ›å†³å®šï¼Œä»è€Œå¯ä»¥å……åˆ†åˆ©ç”¨å…·æœ‰ä¸åŒè®¡ç®—èƒ½åŠ›çš„XPUã€‚</p><ul><li>åœ¨çº¿éƒ¨åˆ†æä¾›ç¥ç»å…ƒç°‡ç²’åº¦çš„æ¨ç†ï¼ŒåŒ…æ‹¬å››ä¸ªåä½œç»„ä»¶ï¼šå¤šæ€ç¥ç»å…ƒå¼•æ“ã€å†…å­˜ä¸­ç¥ç»å…ƒç¼“å­˜ã€çµæ´»çš„ç¥ç»å…ƒåŠ è½½å’Œç¥ç»å…ƒç°‡çº§åˆ«I /O ç®¡é“ã€‚</li><li>ç¦»çº¿éƒ¨åˆ†æè¿°åœ¨çº¿æ¨ç†ä¸­æ¶‰åŠçš„æ¯ä¸ªç»„ä»¶çš„å…·ä½“é…ç½®å¹¶æŒ‡å¯¼åœ¨çº¿è¿‡ç¨‹ã€‚</li></ul><h2 id="turbo-sparse">Turbo Sparse</h2><p>æå‡ºäº†ä¸€ç§æ–°çš„åŸºäºdreluçš„ç¨€ç–åŒ–æ–¹æ³•ï¼Œåœ¨ä¿æŒæ€§èƒ½çš„åŒæ—¶ï¼Œå°†æ¨¡å‹ç¨€ç–æ€§æé«˜åˆ°90%ï¼Œåœ¨æ¨ç†ä¸­å®ç°äº†2-5å€çš„åŠ é€Ÿã€‚</p><ul><li>å°† ReLU åŒ–è¿‡ç¨‹ä¸­çš„åŸå§‹åŸºäº SwiGLU çš„å‰é¦ˆç½‘ç»œï¼ˆFFNï¼‰æ›¿æ¢ä¸ºåŸºäº dReLUçš„å‰é¦ˆç½‘ç»œï¼ˆFFNï¼‰ã€‚</li><li>åœ¨ç¬¬ä¸€ç§æ”¹è¿›çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ç¨€ç–æœºåˆ¶è¿›ä¸€æ­¥ä¼˜åŒ–æ¨¡å‹æ€§èƒ½ï¼Œé€šè¿‡æ§åˆ¶ç¨€ç–æ°´å¹³æ¥è°ƒæ•´æ¨¡å‹çš„æ¿€æ´»å€¼ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹PowerInfer1.0</title>
      <link href="/2024/08/08/NLP/LLMModels/PowerInfer/PowerInfer1/"/>
      <url>/2024/08/08/NLP/LLMModels/PowerInfer/PowerInfer1/</url>
      
        <content type="html"><![CDATA[<h1 id="powerinfer">PowerInfer</h1><p>åœ¨æ¶ˆè´¹çº§ GPU ä¸Šçš„å¿«é€Ÿå¤§è¯­è¨€æ¨¡å‹æ¨ç† åŸæ–‡é“¾æ¥ï¼š<ahref="https://arxiv.org/abs/2312.12456">PowerInfer: Fast Large LanguageModel Serving with a Consumer-grade GPU</a></p><h2 id="ç®€ä»‹">1 ç®€ä»‹</h2><p><strong>åˆ©ç”¨LLMæ¨ç†ä¸­å›ºæœ‰çš„é«˜å±€éƒ¨æ€§ç‰¹æ€§:ä¸€ä¸ªå°å­é›†çš„ç¥ç»å…ƒï¼ˆç§°ä¸ºçƒ­ç¥ç»å…ƒï¼‰åœ¨å„ç§è¾“å…¥ä¸‹å§‹ç»ˆè¢«æ¿€æ´»ï¼Œè€Œå¤§å¤šæ•°ç¥ç»å…ƒï¼ˆç§°ä¸ºå†·ç¥ç»å…ƒï¼‰åˆ™æ ¹æ®ç‰¹å®šè¾“å…¥è€Œå˜åŒ–ã€‚</strong></p><p>PowerInferåˆ©ç”¨è¿™ä¸€è§è§£è®¾è®¡äº†ä¸€ä¸ªGPU-CPUæ··åˆæ¨ç†å¼•æ“ï¼š</p><ol type="1"><li>å°†çƒ­æ¿€æ´»ç¥ç»å…ƒé¢„åŠ è½½åˆ°GPUä¸­ä»¥ä¾¿å¿«é€Ÿè®¿é—®ï¼Œè€Œå†·æ¿€æ´»ç¥ç»å…ƒåˆ™åœ¨CPUä¸Šè¿›è¡Œè®¡ç®—ï¼Œä»è€Œæ˜¾è‘—å‡å°‘äº†GPUå†…å­˜éœ€æ±‚å’ŒCPU-GPUæ•°æ®ä¼ è¾“ã€‚</li><li>é›†æˆè‡ªé€‚åº”é¢„æµ‹å™¨å’Œç¥ç»å…ƒæ„ŸçŸ¥ç¨€ç–ç®—å­ï¼Œä¼˜åŒ–äº†ç¥ç»å…ƒæ¿€æ´»å’Œè®¡ç®—ç¨€ç–æ€§çš„æ•ˆç‡ã€‚<ol type="1"><li>è‡ªé€‚åº”:åœ¨DejaVuçš„åŸºç¡€ä¸Šè‡ªé€‚åº”ä¸¤å±‚MLPé¢„æµ‹å™¨(X-H-O)ä¸­éšè—å±‚Hçš„ç»´åº¦</li><li>ç¥ç»å…ƒæ„ŸçŸ¥:é¢„æµ‹å‡ºæ¿€æ´»çš„ç¥ç»å…ƒï¼Œå¾—åˆ°è¦ç®—å‡ºè¿™ä¸ªç¥ç»å…ƒéœ€è¦å“ªä¸€è¡Œ/åˆ—çš„æƒé‡ï¼Œç„¶ååªè®¡ç®—è¿™ä¸€è¡Œ/åˆ—çš„æƒé‡</li></ol></li></ol><p>æ¨¡å‹è¶Šå¤§ï¼Œä¼˜åŠ¿è¶Šæ˜æ˜¾:å³ä¸»è¦é’ˆå¯¹çš„æ˜¯æ¨¡å‹æ¯”æ˜¾å­˜å¤§æ—¶ä¸èƒ½å®Œå…¨offloadåˆ°GPUçš„æƒ…å†µã€‚</p><h3 id="æ ¸å¿ƒ">1.1 æ ¸å¿ƒ</h3><p><strong>å°†å°‘æ•°çš„çƒ­ç¥ç»å…ƒåˆ†é…ç»™GPUï¼Œè€Œå¤šæ•°çš„å†·ç¥ç»å…ƒç”±CPUç®¡ç†(GPUé¢„åŠ è½½ç»å¸¸æ¿€æ´»çš„ç¥ç»å…ƒçš„æƒé‡ï¼Œè€Œä¸å¤ªæ´»è·ƒçš„ç¥ç»å…ƒçš„æƒé‡ä¿ç•™åœ¨CPUä¸Š)ã€‚ç¦»çº¿é¢„é€‰æ‹©å’Œé¢„åŠ è½½çƒ­æ¿€æ´»ç¥ç»å…ƒï¼Œå¹¶åœ¨è¿è¡Œæ—¶åˆ©ç”¨åœ¨çº¿é¢„æµ‹å™¨æ¥é¢„æµ‹æ¿€æ´»çš„ç¥ç»å…ƒã€‚</strong></p><h2 id="èƒŒæ™¯">2 èƒŒæ™¯</h2><h3 id="ç¨€ç–æ¿€æ´»çš„å¯èƒ½æ€§">2.1 ç¨€ç–æ¿€æ´»çš„å¯èƒ½æ€§</h3><figure><img src="./images/MLP.webp#60x60"title="å›¾1: æ¿€æ´»çš„ç¥ç»å…ƒè¡¨ç¤ºä¸ºç”±çº¢çº¿åŒ…å›´çš„ç»¿è‰²è¡Œæˆ–åˆ—ï¼Œ FC1 çš„è¾“å‡ºå‘é‡æä¾›ç»™ FC2 ä½œä¸ºå…¶è¾“å…¥å‘é‡ã€‚"alt="ç¨€ç–æ¿€æ´»" /><figcaption aria-hidden="true">ç¨€ç–æ¿€æ´»</figcaption></figure><p>åœ¨å›¾ 1 ä¸­ï¼ŒMLP å—çš„å±‚ FC1 å’Œ FC2é€šè¿‡çŸ©é˜µä¹˜æ³•ç”Ÿæˆå‘é‡ã€‚æ¯ä¸ªè¾“å‡ºå…ƒç´ éƒ½æ¥è‡ªè¾“å…¥å‘é‡å’Œç¥ç»å…ƒçš„ç‚¹ç§¯ï¼ˆæƒé‡çŸ©é˜µä¸­çš„è¡Œ/åˆ—ï¼‰ã€‚ReLUç­‰æ¿€æ´»å‡½æ•°å……å½“é—¨ï¼Œé€‰æ‹©æ€§åœ°ä¿ç•™æˆ–ä¸¢å¼ƒå‘é‡ä¸­çš„å€¼ï¼Œå½±å“ FC1 å’Œ FC2ä¸­çš„ç¥ç»å…ƒæ¿€æ´»æƒ…å†µã€‚</p><h3 id="å¯¹llmæ¨ç†ä¸­çš„å±€éƒ¨æ€§çš„æ´å¯Ÿ">2.2 å¯¹LLMæ¨ç†ä¸­çš„å±€éƒ¨æ€§çš„æ´å¯Ÿ</h3><p><strong>å¹‚å¾‹æ¿€æ´»</strong>LLMæ¨ç†è¡¨ç°å‡ºé«˜åº¦çš„å±€éƒ¨æ€§ï¼Œè¡¨æ˜ä¸€ç»„ä¸€è‡´çš„ç¥ç»å…ƒç»å¸¸è¢«æ¿€æ´»ï¼Œä»è€Œå¯ä»¥åˆ†ä¸ºçƒ­ç¥ç»å…ƒå’Œå†·ç¥ç»å…ƒã€‚</p><p><strong>CPUå†…å¿«é€Ÿè®¡ç®—</strong>å¦‚æœæ¿€æ´»çš„ç¥ç»å…ƒé©»ç•™åœ¨CPUå†…å­˜ä¸­ï¼Œåˆ™åœ¨CPUä¸Šè®¡ç®—å®ƒä»¬æ¯”å°†å®ƒä»¬è½¬ç§»åˆ°GPUæ›´å¿«ã€‚</p><h2 id="powerinfer-è®¾è®¡">3 PowerInfer è®¾è®¡</h2><ul><li>ä¸ºäº†å‡å°‘æ¨ç†å»¶è¿Ÿï¼Œåœ¨æ¨ç†è¿‡ç¨‹ä¸­<strong>ä»…è®¡ç®—åœ¨çº¿é¢„æµ‹å™¨é¢„æµ‹ä¸ºæ´»åŠ¨çš„ç¥ç»å…ƒ</strong>ã€‚</li><li>é¢„åŠ è½½ç­–ç•¥ä½¿PowerInferèƒ½å¤Ÿå°†<strong>å¤§éƒ¨åˆ†æ¨ç†ä»»åŠ¡åˆ†é…ç»™GPU</strong>ï¼Œå› ä¸ºåŠ è½½åœ¨GPUä¸Šçš„çƒ­æ¿€æ´»ç¥ç»å…ƒæ„æˆäº†æ¿€æ´»çš„å¾ˆå¤§ä¸€éƒ¨åˆ†ã€‚</li><li>å¯¹äº<strong>å†·æ¿€æ´»ç¥ç»å…ƒï¼Œåœ¨éœ€è¦è®¡ç®—æ—¶ä»…åœ¨ CPUä¸Šæ‰§è¡Œ</strong>ï¼Œæ¶ˆé™¤äº†æƒé‡è½¬ç§»åˆ° GPU çš„éœ€æ±‚ã€‚</li></ul><h3 id="æ¶æ„ä¸å·¥ä½œæµç¨‹">3.1 æ¶æ„ä¸å·¥ä½œæµç¨‹</h3><figure><img src="./images/architecture.webp#80x80" title="å›¾2: PowerInferæ¶æ„"alt="PowerInferæ¶æ„" /><figcaption aria-hidden="true">PowerInferæ¶æ„</figcaption></figure><p>å›¾ 2 æ˜¾ç¤ºäº† PowerInfer çš„æ¶æ„ï¼ŒåŒ…æ‹¬ç¦»çº¿å’Œåœ¨çº¿ç»„ä»¶ã€‚</p><ul><li>ç¦»çº¿ç»„ä»¶åˆ†ællmçš„æ¿€æ´»ç¨€ç–æ€§ï¼ŒåŒºåˆ†çƒ­ç¥ç»å…ƒå’Œå†·ç¥ç»å…ƒã€‚</li><li>åœ¨çº¿é˜¶æ®µï¼Œæ¨ç†å¼•æ“å°†ä¸¤ç§ç±»å‹çš„ç¥ç»å…ƒåŠ è½½åˆ° GPU å’Œ CPUä¸­ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„è®¡ç®—ã€‚</li></ul><p><strong>LLMåˆ†æå™¨å’Œç­–ç•¥æ±‚è§£å™¨(ç¦»çº¿)</strong>: è¯¥ç»„ä»¶åŒ…æ‹¬ä¸€ä¸ª LLMåˆ†æå™¨ï¼Œä½¿ç”¨é€šç”¨æ•°æ®é›†å¾—åˆ°ã€‚å®ƒç›‘æ§æ‰€æœ‰å±‚çš„ç¥ç»å…ƒæ¿€æ´»ï¼ˆæ­¥éª¤â‘ ï¼‰ï¼Œç„¶åæ˜¯å°†ç¥ç»å…ƒåˆ†ç±»ä¸ºçƒ­æˆ–å†·çš„ç­–ç•¥æ±‚è§£å™¨ã€‚æ±‚è§£å™¨æ—¨åœ¨å°†é¢‘ç¹æ¿€æ´»çš„ç¥ç»å…ƒåˆ†é…ç»™GPUï¼Œå°†å…¶ä»–ç¥ç»å…ƒåˆ†é…ç»™CPUã€‚åœ¨åˆ’åˆ†è¿‡ç¨‹ä¸­ä½¿ç”¨æ•´æ•°çº¿æ€§è§„åˆ’æ¥å¹³è¡¡å·¥ä½œè´Ÿè½½ï¼ˆæ­¥éª¤ â‘¡ï¼‰ã€‚</p><p><strong>ç¥ç»å…ƒæ„ŸçŸ¥LLMæ¨ç†å¼•æ“(åœ¨çº¿)</strong>:åœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚ä¹‹å‰ï¼Œæ ¹æ®ç¦»çº¿æ±‚è§£å™¨çš„è¾“å‡ºï¼Œåœ¨çº¿å¼•æ“å°†ä¸¤ç§ç±»å‹çš„ç¥ç»å…ƒåˆ†é…åˆ°å„è‡ªçš„å¤„ç†å•å…ƒ(æ­¥éª¤â‘¢)ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå¼•æ“åˆ›å»ºGPU å’Œ CPU æ‰§è¡Œå™¨ï¼Œå®ƒä»¬æ˜¯è¿è¡Œåœ¨ CPU ä¾§çš„çº¿ç¨‹ï¼Œä»¥ç®¡ç†å¹¶å‘ CPU-GPUè®¡ç®—ï¼ˆæ­¥éª¤ â‘£ï¼‰ã€‚è¯¥å¼•æ“è¿˜é¢„æµ‹ç¥ç»å…ƒæ¿€æ´»å¹¶è·³è¿‡éæ¿€æ´»ç¥ç»å…ƒã€‚åœ¨ GPUå†…å­˜ä¸­é¢„åŠ è½½çš„æ¿€æ´»ç¥ç»å…ƒåœ¨é‚£é‡Œè¿›è¡Œå¤„ç†ï¼Œè€Œ CPUå°†å…¶ç¥ç»å…ƒçš„ç»“æœè®¡ç®—å¹¶ä¼ è¾“åˆ° GPU ä»¥è¿›è¡Œé›†æˆã€‚è¯¥å¼•æ“åœ¨ CPU å’Œ GPUä¸Šä½¿ç”¨ç¨€ç–ç¥ç»å…ƒæ„ŸçŸ¥ç®—å­ï¼Œ<strong>ä¸“æ³¨äºçŸ©é˜µå†…çš„å•ä¸ªç¥ç»å…ƒè¡Œ/åˆ—</strong>ã€‚</p><h3 id="å•å±‚ç¤ºä¾‹">3.2 å•å±‚ç¤ºä¾‹</h3><p>å›¾ 3 è¯´æ˜äº† PowerInfer åœ¨å¤„ç†å±‚ç¥ç»å…ƒæ—¶å¦‚ä½•åè°ƒ GPU å’Œ CPUã€‚</p><ol type="1"><li>æ ¹æ®ç¦»çº¿æ•°æ®å¯¹ç¥ç»å…ƒè¿›è¡Œåˆ†ç±»ï¼Œå°†çƒ­æ¿€æ´»ç¥ç»å…ƒï¼ˆç´¢å¼• 3ã€5ã€7ï¼‰åˆ†é…ç»™GPU å†…å­˜ï¼Œå°†å…¶ä»–ç¥ç»å…ƒåˆ†é…ç»™ CPU å†…å­˜ã€‚</li><li>åœ¨æ¥æ”¶åˆ°è¾“å…¥åï¼Œé¢„æµ‹å™¨è¯†åˆ«å½“å‰å±‚ä¸­çš„å“ªäº›ç¥ç»å…ƒå¯èƒ½è¢«æ¿€æ´»ã€‚ä¾‹å¦‚ï¼Œå®ƒé¢„æµ‹ç¥ç»å…ƒ3ã€4å’Œ5çš„æ¿€æ´»ã€‚</li><li>ä½†æ˜¯é€šè¿‡ç¦»çº¿ç»Ÿè®¡åˆ†æè¯†åˆ«çš„çƒ­æ¿€æ´»ç¥ç»å…ƒå¯èƒ½ä¸èƒ½ä¸€è‡´åœ°åŒ¹é…è¿è¡Œæ—¶æ¿€æ´»è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¥ç»å…ƒ7 è™½ç„¶è¢«æ ‡è®°ä¸ºçƒ­æ¿€æ´»ï¼Œä½†è¢«é¢„æµ‹ä¸ºä¸æ´»è·ƒã€‚</li><li>ç„¶å CPU å’Œ GPUéƒ½å¤„ç†é¢„æµ‹çš„æ´»åŠ¨ç¥ç»å…ƒï¼Œå¿½ç•¥éæ´»åŠ¨ç¥ç»å…ƒã€‚GPUè®¡ç®—ç¥ç»å…ƒ3å’Œ5ï¼Œè€ŒCPUå¤„ç†ç¥ç»å…ƒ4ã€‚</li><li>ä¸€æ—¦ç¥ç»å…ƒ4çš„è®¡ç®—å®Œæˆï¼Œå…¶è¾“å‡ºè¢«å‘é€åˆ°GPUè¿›è¡Œç»“æœé›†æˆã€‚</li></ol><figure><img src="./images/example.webp#80x80" title="å›¾3: å•å±‚ç¤ºä¾‹"alt="å•å±‚ç¤ºä¾‹" /><figcaption aria-hidden="true">å•å±‚ç¤ºä¾‹</figcaption></figure><h2 id="ç¥ç»å…ƒæ„ŸçŸ¥æ¨ç†å¼•æ“">4 ç¥ç»å…ƒæ„ŸçŸ¥æ¨ç†å¼•æ“</h2><p><strong>PowerInferä¸­çš„åœ¨çº¿æ¨ç†å¼•æ“é€šè¿‡ä»…å¤„ç†é‚£äº›è¢«é¢„æµ‹ä¸ºæ¿€æ´»çš„ç¥ç»å…ƒæ¥å‡å°‘è®¡ç®—è´Ÿè½½ã€‚</strong></p><h3 id="è‡ªé€‚åº”ç¨€ç–é¢„æµ‹å™¨">4.1 è‡ªé€‚åº”ç¨€ç–é¢„æµ‹å™¨</h3><p>é¢„æµ‹å™¨çš„å¤§å°å—ä¸¤ä¸ªä¸»è¦å› ç´ çš„å½±å“ï¼šLLMå±‚çš„ç¨€ç–æ€§åŠå…¶å†…éƒ¨ååº¦ã€‚(å…·æœ‰è¾ƒé«˜æ¿€æ´»ç¨€ç–æ€§æˆ–è€…é«˜ååº¦çš„å±‚ç®€åŒ–äº†è¯†åˆ«æ¿€æ´»ç¥ç»å…ƒçš„ä»»åŠ¡ï¼Œä»è€Œå…è®¸è¾ƒå°çš„é¢„æµ‹æ¨¡å‹ã€‚)</p><p>PowerInferåœ¨DejaVuçš„åŸºç¡€ä¸Šä¸ºæ¯ä¸ªTransformerå±‚è®¾è®¡äº†ä¸€ç§éå›ºå®šå¤§å°çš„é¢„æµ‹å™¨çš„è¿­ä»£è®­ç»ƒæ–¹æ³•(<strong>å…¶å®å°±æ˜¯è‡ªé€‚åº”ä¸¤å±‚MLPé¢„æµ‹å™¨(X-H-O)ä¸­éšè—å±‚Hçš„ç»´åº¦</strong>):</p><ul><li>é¦–å…ˆåŸºäºå±‚çš„ç¨€ç–é…ç½®æ–‡ä»¶å»ºç«‹åŸºçº¿é¢„æµ‹å™¨æ¨¡å‹å¤§å°ã€‚</li><li>éšåï¼Œåœ¨è€ƒè™‘å†…éƒ¨æ¿€æ´»ååº¦ä»¥ä¿æŒå‡†ç¡®æ€§çš„æƒ…å†µä¸‹ï¼Œè¿­ä»£åœ°è°ƒæ•´æ¨¡å‹å¤§å°ã€‚(MLPé¢„æµ‹å™¨é€šå¸¸åŒ…æ‹¬è¾“å…¥ã€éšè—å±‚å’Œè¾“å‡ºå±‚ã€‚ç”±äºè¾“å…¥å’Œè¾“å‡ºå±‚çš„ç»´åº¦ç”± Transformerå±‚çš„ç»“æ„å†³å®šï¼Œå› æ­¤ä¿®æ”¹ä¸»è¦é’ˆå¯¹éšè—å±‚)</li><li>åœ¨è¿­ä»£è°ƒæ•´è¿‡ç¨‹ä¸­ï¼Œéšè—å±‚çš„ç»´æ•°æ ¹æ®è§‚æµ‹åˆ°çš„ååº¦è¿›è¡Œä¿®æ”¹ã€‚(å¯¹äºå…·æœ‰æ˜æ˜¾ååº¦çš„å±‚ï¼Œéšè—å±‚çš„å¤§å°é€æ¸å‡å°ï¼Œç›´åˆ°ç²¾åº¦é™è‡³95%ä»¥ä¸‹ã€‚ç›¸åï¼Œå¯¹äºå…·æœ‰æœ€å°ååº¦çš„å±‚ï¼Œåˆ™å¢åŠ å°ºå¯¸ä»¥æé«˜ç²¾åº¦ã€‚)</li></ul><p>é€šè¿‡è¿™ç§æ–¹æ³•ï¼ŒPowerInferæœ‰æ•ˆåœ°å°†MLPé¢„æµ‹å™¨å‚æ•°é™åˆ¶åœ¨LLMæ€»å‚æ•°çš„10%ä»¥å†…ã€‚</p><h3 id="ç¥ç»å…ƒæ”¾ç½®å’Œç®¡ç†">4.2 ç¥ç»å…ƒæ”¾ç½®å’Œç®¡ç†</h3><p>æŠŠç¥ç»å…ƒæ‹†åˆ†å¼€äº†ï¼Œé‚£è®¡ç®—çš„æ—¶å€™å¦‚ä½•ç¡®ä¿è®¡ç®—ä½ç½®æ˜¯å¯¹çš„ï¼Ÿ</p><p>åˆ›å»ºä¸¤ä¸ªç¥ç»å…ƒè¡¨ï¼Œä¸€ä¸ªä½äº CPU ä¸­ï¼Œå¦ä¸€ä¸ªä½äº GPUå†…å­˜ä¸­ã€‚è¿™äº›è¡¨å°†æ¯ä¸ªç¥ç»å…ƒä¸å…¶çŸ©é˜µä¸­çš„åŸå§‹ä½ç½®ç›¸å…³è”ã€‚åœ¨ä¸è¾“å…¥å¼ é‡ç›¸ä¹˜çš„è¿‡ç¨‹ä¸­ï¼Œç”±ç¥ç»å…ƒè¡¨æŒ‡å¯¼ã€‚</p><h3 id="gpu-cpuæ··åˆæ‰§è¡Œ">4.3 GPU-CPUæ··åˆæ‰§è¡Œ</h3><p>GPU-CPUä¸¤ä¸ªå•å…ƒç‹¬ç«‹è®¡ç®—å®ƒä»¬å„è‡ªçš„æ¿€æ´»ç¥ç»å…ƒï¼Œç„¶ååœ¨ GPUä¸Šç»„åˆç»“æœã€‚</p><ol type="1"><li>åœ¨æ¨ç†ä¹‹å‰ï¼Œæ„é€ ä¸€ä¸ªè®¡ç®—å›¾ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ª LLMæ¨ç†ç®—å­ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ CPUå†…å­˜ä¸­çš„å…¨å±€é˜Ÿåˆ—ä¸­ã€‚é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªè¿ç®—ç¬¦éƒ½æ ‡æœ‰å…¶å…ˆå†³æ¡ä»¶è¿ç®—ç¬¦ã€‚</li><li>åœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œä¸»æœºæ“ä½œç³»ç»Ÿåˆ›å»ºçš„ä¸¤ç§ç±»å‹çš„æ‰§è¡Œå™¨ pthreads ç®¡ç† CPUå’Œ GPUçš„è®¡ç®—ã€‚å®ƒä»¬ä»å…¨å±€é˜Ÿåˆ—ã€æ£€æŸ¥ä¾èµ–é¡¹ä¸­æå–è¿ç®—ç¬¦å¹¶å°†å®ƒä»¬åˆ†é…ç»™é€‚å½“çš„å¤„ç†å•å…ƒã€‚</li><li>GPU å’Œ CPU ä½¿ç”¨ä»–ä»¬çš„ç¥ç»å…ƒæ„ŸçŸ¥è¿ç®—ç¬¦ï¼ŒGPU æ‰§è¡Œå™¨ä½¿ç”¨cudaLaunchKernel ç­‰ API å¯åŠ¨ GPU è¿ç®—ç¬¦ï¼Œä»¥åŠåè°ƒæœªå ç”¨ CPUå†…æ ¸ä»¥è¿›è¡Œè®¡ç®—çš„ CPU æ‰§è¡Œå™¨ã€‚åœ¨æ‰§è¡Œè¿ç®—ç¬¦ä¹‹å‰ï¼ŒCPUæ‰§è¡Œå™¨è¿˜ç¡®å®šå¹¶è¡Œè®¡ç®—çš„å¿…è¦çº¿ç¨‹è®¡æ•°ã€‚</li><li>ä¸ºäº†ç®¡ç†è¿ç®—ç¬¦ä¾èµ–å…³ç³»ï¼Œå°¤å…¶æ˜¯å½“ CPU è¿ç®—ç¬¦çš„çˆ¶èŠ‚ç‚¹åœ¨ GPUä¸Šå¤„ç†æ—¶ï¼Œç¡®ä¿ GPU è®¡ç®—åœ¨ CPU å¯åŠ¨å…¶è¿ç®—ç¬¦ä¹‹å‰å®Œæˆã€‚</li></ol><p><strong>GPUå’ŒCPUé€‰æ‹©æ€§åŒæ­¥ç­–ç•¥</strong>:åœ¨ä¸€ä¸ªå•å…ƒå®Œæˆå…¶ç¥ç»å…ƒè®¡ç®—åï¼Œå®ƒç­‰å¾…å¦ä¸€ä¸ªåˆå¹¶ç»“æœã€‚ç”±äº GPUç¥ç»å…ƒæ›´é¢‘ç¹åœ°è¢«æ¿€æ´»ï¼ŒPowerInfer å°†åˆå¹¶æ“ä½œåˆ†é…ç»™GPUã€‚å½“CPUæ‰§è¡Œå™¨æ²¡æœ‰æ¿€æ´»ç¥ç»å…ƒæ—¶ç»•è¿‡ç»“æœåŒæ­¥ï¼Œä½¿å…¶èƒ½å¤Ÿç»§ç»­åç»­å—ï¼Œä»è€Œæé«˜æ•´ä½“æ•ˆç‡ã€‚</p><h3 id="ç¥ç»å…ƒæ„ŸçŸ¥ç®—å­">4.4 ç¥ç»å…ƒæ„ŸçŸ¥ç®—å­</h3><p>è€ƒè™‘åˆ°llmçš„æ¿€æ´»ç¨€ç–æ€§ï¼ŒçŸ©é˜µä¹˜æ³•æ“ä½œå¯ä»¥ä½¿ç”¨ç¨€ç–ç®—å­ç»•è¿‡ä¸æ´»è·ƒçš„ç¥ç»å…ƒåŠå…¶æƒé‡ã€‚PowerInferå¼•å…¥äº†ä¸€ç§ç¥ç»å…ƒæ„ŸçŸ¥ç®—å­ï¼Œ<strong>ä¸“æ³¨äºçŸ©é˜µä¸­çš„å•ä¸ªè¡Œ/åˆ—å‘é‡</strong>è€Œä¸æ˜¯æ•´ä¸ªçŸ©é˜µã€‚</p><p><strong>GPU çš„ç¥ç»å…ƒæ„ŸçŸ¥ç®—å­</strong>: å°½ç®¡GPUä¸Š<strong>å‘é‡-å‘é‡è®¡ç®—</strong> æ¯” <strong>çŸ©é˜µ-å‘é‡è®¡ç®—</strong>æ•ˆç‡æ›´ä½ï¼Œä½†æ˜¯åœ¨ç¥ç»ç½‘ç»œä¸­é€šå¸¸æœ‰å¤§é‡éæ´»åŠ¨ç¥ç»å…ƒï¼ŒåŸºäº<strong>å‘é‡-å‘é‡è®¡ç®—</strong>çš„ç®—å­å¯ä»¥è·³è¿‡è¿™äº›éæ´»åŠ¨ç¥ç»å…ƒï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—å’Œå†…å­˜ï¼Œå¹¶ä¸”ä¸éœ€è¦æ˜‚è´µçš„çŸ©é˜µè½¬æ¢ã€‚</p><p><strong>CPU çš„ç¥ç»å…ƒæ„ŸçŸ¥ç®—å­</strong>:CPUé€šå¸¸å…·æœ‰è¾ƒä½çš„å¹¶è¡Œæ€§å’ŒçŸ©é˜µè®¡ç®—æ•ˆç‡ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹<strong>å‘é‡-å‘é‡è®¡ç®—</strong>éå¸¸æœ‰åˆ©ã€‚CPUæ‰§è¡Œå™¨ä¸ºå¤šæ ¸åˆ†é…ä¸€ä¸ªç¥ç»å…ƒæ„ŸçŸ¥ç®—å­ï¼Œå°†ç¥ç»å…ƒåˆ†æˆæ›´å°çš„æ‰¹æ¬¡è¿›è¡Œå¹¶å‘æ¿€æ´»æ£€æŸ¥ã€‚æ¯ä¸ªæ ¸å¿ƒåªå¤„ç†å…¶æ‰¹æ¬¡ä¸­çš„æ¿€æ´»ç¥ç»å…ƒï¼Œä½¿ç”¨AVX2 ç­‰ç¡¬ä»¶å‘é‡æ‰©å±•ä¼˜åŒ– <strong>å‘é‡-å‘é‡è®¡ç®—</strong>ã€‚</p><h2 id="ç¥ç»å…ƒæ”¾ç½®ç­–ç•¥">5 ç¥ç»å…ƒæ”¾ç½®ç­–ç•¥</h2><p>PowerInfer çš„ç¦»çº¿ç»„ä»¶æä¾›äº†ä¸€ç§æ”¾ç½®ç­–ç•¥ï¼Œä»¥æŒ‡å¯¼æ¯ä¸ªç¥ç»å…ƒåˆ†é…ç»™ GPUæˆ– CPUã€‚</p><h3 id="ç¦»çº¿åˆ†æ">5.1 ç¦»çº¿åˆ†æ</h3><p>åœ¨ç¡®å®šæ¯ä¸ªç¥ç»å…ƒçš„ä½ç½®ä¹‹å‰ï¼ŒPowerInferçš„ç¦»çº¿åˆ†æå™¨éœ€è¦ä¸ºæ¯ä¸ªç¥ç»å…ƒæ”¶é›†è¿è¡Œæ—¶æ¨æ–­æ•°æ®(å°±æ˜¯æ¨ç†é€šç”¨æ•°æ®é›†ç„¶åç»Ÿè®¡é¢‘ç¹æ¿€æ´»çš„ç¥ç»å…ƒ)ã€‚</p><ul><li>éƒ¨ç½²LLMæ¥å¤„ç†ä»å¤šä¸ªé€šç”¨æ•°æ®é›†ç”Ÿæˆçš„è¯·æ±‚ã€‚</li><li>åˆ†æå™¨åœ¨ Transformerå±‚å†…çš„æ¯ä¸ªå—ä¹‹åæ’å…¥ä¸€ä¸ªç›‘æ§å†…æ ¸(æ£€æŸ¥å±‚ä¸­çš„æ¯ä¸ªç¥ç»å…ƒæ˜¯å¦åœ¨æ¨ç†è¿‡ç¨‹ä¸­è¢«æ¿€æ´»ï¼Œå¦‚æœæ˜¯ï¼Œå¢åŠ ç¥ç»å…ƒè¡¨ä¸­ç›¸åº”çš„è®¡æ•°)</li><li>åœ¨ GPU ä¸Šæ„å»ºäº†ä¸€ä¸ªç¥ç»å…ƒä¿¡æ¯è¡¨ï¼Œæ—¨åœ¨è·Ÿè¸ªæ¯ä¸ªç¥ç»å…ƒçš„æ¿€æ´»è®¡æ•°ã€‚</li></ul><h3 id="ç¥ç»å…ƒå½±å“åº¦é‡">5.2 ç¥ç»å…ƒå½±å“åº¦é‡</h3><p>ç¥ç»å…ƒå½±å“åº¦é‡æµ‹é‡æ¯ä¸ªç¥ç»å…ƒå¯¹LLMæ•´ä½“æ¨ç†ç»“æœçš„è´¡çŒ®ã€‚æˆ‘ä»¬é€šè¿‡åˆ©ç”¨åˆ†ææ¿€æ´»é¢‘ç‡å‡†ç¡®åæ˜ è¿è¡Œæ—¶è¡Œä¸ºçš„äº‹å®æ¥æœ‰æ•ˆåœ°è®¡ç®—è¯¥æŒ‡æ ‡ï¼š</p><p><span class="math display">\[\begin{gather*}v_{i} = f_{i} \hspace{1cm}\forall i \in \mathbb{N} \tag{1}\end{gather*}\]</span></p><h3 id="ç¥ç»å…ƒæ”¾ç½®å»ºæ¨¡">5.3 ç¥ç»å…ƒæ”¾ç½®å»ºæ¨¡</h3><p>åŸºäºç¥ç»å…ƒå½±å“åº¦é‡ï¼ŒPowerInfer åˆ©ç”¨æ±‚è§£å™¨æ¥ä¼˜åŒ– GPUä¸­æ‰€æœ‰ç¥ç»å…ƒçš„æ€»å½±å“ã€‚è¿™ä¸ªç´¯ç§¯å½±å“è¢«è¡¨è¿°ä¸ºç›®æ ‡å‡½æ•°ï¼Œå¦‚å¼ 2æ‰€ç¤ºã€‚ç„¶åå°†è¯¥å‡½æ•°è¾“å…¥åˆ°æ•´æ•°çº¿æ€§è§„åˆ’æ¡†æ¶ä¸­ï¼Œä»¥è¯†åˆ«æœ€å¤§åŒ–å‡½æ•°çš„ç‰¹å®šè§£ã€‚ç­‰å¼3 ä¸­å®šä¹‰çš„äºŒå…ƒå˜é‡ <span class="math inline">\(a_{in}\)</span>è¡¨ç¤ºç¥ç»å…ƒæ˜¯å¦æ”¾ç½®åœ¨å¤„ç†å•å…ƒ <span class="math inline">\(i\)</span>ä¸Šã€‚</p><p><span class="math display">\[\begin{gather*}Maximize \quad t_i= \sum_{e \in \mathbb{N}} a_{ie} * v_{e} \forall i \in\{GPU\} \tag{2} \\\sum_{i \in \mathbb{U}} a_{in} = 1 \quad\forall n \in \mathbb{N} \tag{3}\end{gather*}\]</span></p><h4 id="é€šä¿¡çº¦æŸ">5.3.1 é€šä¿¡çº¦æŸ</h4><p>åœ¨GPUä¸Šé¢„åŠ è½½çš„ç¥ç»å…ƒæ•°é‡å—åˆ°å±‚å†…é€šä¿¡å¼€é”€çš„é™åˆ¶ã€‚å¦‚æœé¢„åŠ è½½äº†å¤ªå°‘çš„ç¥ç»å…ƒï¼Œè¿™ç§å¼€é”€ä¼šå¦å®šGPU æä¾›çš„è®¡ç®—ä¼˜åŠ¿ã€‚å› æ­¤ï¼Œæ±‚è§£å™¨å¿…é¡»è¯†åˆ«æœ€å°‘æ•°é‡çš„ç¥ç»å…ƒæ¥åˆ†é…ç»™ GPUè¿›è¡Œå¤„ç†ã€‚åœ¨ä¸ç­‰å¼ 4 ä¸­ï¼Œ<span class="math inline">\(C_{l}\)</span>æ˜¯å¿…é¡»åˆ†é…ç»™ç¬¬ <span class="math inline">\(l\)</span> å±‚çš„ GPUçš„ç¥ç»å…ƒçš„æœ€å°è®¡æ•°ã€‚å…·ä½“æ¥è¯´ï¼ŒGPU ä¸Šå±‚ <spanclass="math inline">\(l\)</span> çš„ç¥ç»å…ƒæ•°å¿…é¡»è¶…è¿‡ <spanclass="math inline">\(C_{l}\)</span> æˆ–ç­‰äº 0ã€‚</p><p>åœ¨æ±‚è§£ä¸ç­‰å¼ 4 æ—¶ï¼Œå¿…é¡»å®šä¹‰ç¬¬ <span class="math inline">\(l\)</span>å±‚å•ä¸ªç¥ç»å…ƒçš„è®¡ç®—æ—¶é—´å’Œå±‚å†…é€šä¿¡å¼€é”€ã€‚åœ¨LLMæ¨ç†ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨è¾ƒå°çš„æ‰¹å¤„ç†å¤§å°ä¸‹ï¼Œè¯¥è¿‡ç¨‹ä¸»è¦å—å†…å­˜å¸¦å®½çš„é™åˆ¶ã€‚å› æ­¤ï¼Œç¥ç»å…ƒçš„è®¡ç®—æ—¶é—´å¤§è‡´ç­‰äºä¸€æ¬¡è®¿é—®æ‰€æœ‰æƒé‡æ‰€éœ€çš„æ—¶é—´ï¼Œå¦‚å…¬å¼5æ‰€ç¤ºã€‚åœ¨è¾ƒå°çš„æ‰¹å¤„ç†å¤§å°ä¸‹ï¼Œå±‚å†…æ•°æ®ä¼ è¾“çš„ç¨‹åº¦å¾€å¾€è·¨å±‚ä¸€è‡´ï¼Œå¯¼è‡´åŒæ­¥æˆæœ¬å‡åŒ€ã€‚</p><p><span class="math display">\[\begin{gather*}C_{l} \cdot T_{l}^{GPU} + T_{sync} \leq C_{l} \cdot T_{l}^{CPU} \foralll \in \mathbb{L} \tag{4} \\T_{i}^{j} = M_{i} / Bandwidth_{j} \quad \forall j \in \mathbb{D},\forall i \in \mathbb{L} \tag{5} \\\end{gather*}\]</span></p><h4 id="å†…å­˜çº¦æŸ">5.3.2 å†…å­˜çº¦æŸ</h4><p>ç¥ç»å…ƒæ”¾ç½®è¿›ä¸€æ­¥å—åˆ°å¤„ç†å•å…ƒçš„å†…å­˜å®¹é‡çš„é™åˆ¶ï¼Œå¦‚ä¸ç­‰å¼ 6 æ‰€ç¤ºã€‚</p><p>æˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªè¾…åŠ©äºŒè¿›åˆ¶å˜é‡<spanclass="math inline">\(y_l\)</span>ï¼Œå®ƒå¯ä»¥æ˜¯1æˆ–0ã€‚è¿™ä¸ªå˜é‡å†³å®šäº†ä»»ä½•ç¥ç»å…ƒæ˜¯å¦åˆ†é…ç»™ç¬¬<spanclass="math inline">\(l\)</span>å±‚çš„GPUã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿˜å¼•å…¥äº†è¶³å¤Ÿå¤§çš„<span class="math inline">\(K\)</span>ã€‚</p><p>ç­‰å¼ 7 å’Œ 8 è¢«åˆ¶å®šä¸ºå¯¹è¿™ç§çº¦æŸè¿›è¡Œå»ºæ¨¡ã€‚å½“ <spanclass="math inline">\(y_l\)</span> ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºè¯¥å±‚ GPUä¸Šçš„ç¥ç»å…ƒæ”¾ç½®ï¼Œé‰´äº <span class="math inline">\(K\)</span>è¶³å¤Ÿå¤§ï¼Œè¿™ä¸¤ä¸ªä¸ç­‰å¼æœ‰æ•ˆåœ°å˜ä¸º <span class="math inline">\(y_l \leq\sum_{e \in N_l} a_{ie} \leq K\)</span>ã€‚ç›¸åï¼Œå¦‚æœ <spanclass="math inline">\(y_l\)</span> è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºå±‚ <spanclass="math inline">\(l\)</span> çš„ GPU ä¸Šæ²¡æœ‰ç¥ç»å…ƒæ”¾ç½®ï¼Œåˆ™ä¸ç­‰å¼å‡å°‘åˆ°<span class="math inline">\(\sum_{e \in N_l} a_{ie} = 0\)</span>ã€‚</p><p><span class="math display">\[\begin{gather*}\sum_{n \in N} a_{jn} \cdot M_{n} &lt; MCap_j \quad \forall j \in\mathbb{U} \tag{6} \\\sum_{e \in N_l} a_{ie} \geq C_l \cdot y_l \quad \forall l \in\mathbb{L}, \forall i \in \{GPU\} \tag{7} \\\sum_{e \in N_l} a_{ie} \leq K \cdot y_l \quad \forall l \in \mathbb{L},\forall i \in \{GPU\} \tag{8}\end{gather*}\]</span></p><h4 id="ilpä¼˜åŒ–">5.3.3 ILPä¼˜åŒ–</h4><p>éšåï¼Œæ±‚è§£å™¨åˆ©ç”¨æ•´æ•°çº¿æ€§è§„åˆ’ (ILP) æ¥ä¼˜åŒ–ç›®æ ‡å‡½æ•°ï¼Œç¬¦åˆç­‰å¼/ä¸ç­‰å¼ 3åˆ° 8 çš„æ‰€æœ‰çº¦æŸã€‚ä¸ºäº†åŠ å¿« IPLè¿‡ç¨‹å¹¶å®ç°è¿‘ä¼¼è§£ï¼Œä¸»è¦ç­–ç•¥æ˜¯å°†æ¯ä¸€å±‚çš„ç¥ç»å…ƒèšåˆæˆæ‰¹æ¬¡ä»¥è¿›è¡Œé›†ä½“æ”¾ç½®åˆ†æã€‚</p><h2 id="é™„å½•">é™„å½•</h2><h3 id="dejavu">DejaVu</h3><p>æ ¸å¿ƒæ–¹æ³•æ˜¯åœ¨æ¨ç†é˜¶æ®µï¼Œåˆ©ç”¨å½“å‰è¾“å…¥<spanclass="math inline">\(X\)</span>åŠ¨æ€åœ°é€‰æ‹©éƒ¨åˆ†ç½‘ç»œå‚æ•°æ¥è¿›è¡Œæ¨ç†ï¼Œè€Œä¸ä½¿ç”¨å…¨å‚ã€‚æ‰€ä»¥å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€ç§â€œåŠ¨æ€å‰ªæâ€çš„æ–¹æ³•ã€‚</p><p>åŸæ–‡ä¸­æŒ‡å‡º: åœ¨å®é™…æ¨ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åªä½¿ç”¨çº¦20%çš„Attentionheadå’Œçº¦5%çš„MLPç¥ç»å…ƒï¼Œå°±èƒ½è¾¾åˆ°å’Œå…¨å‚æ¨¡å‹å·®ä¸å¤šçš„æ•ˆæœã€‚</p><figure><img src="./images/ContextualSparsity.svg#80x80" title="å›¾4: DejaVu"alt="DejaVu" /><figcaption aria-hidden="true">DejaVu</figcaption></figure><p>å¦‚ä½•åŸºäºè¾“å…¥<span class="math inline">\(X\)</span>ä»é¢„è®­ç»ƒå¥½çš„LLMAä¸­å¿«é€Ÿäº§ç”ŸLLM Bï¼Œä½¿å¾—LLM Båœ¨<spanclass="math inline">\(X\)</span>ä¸Šçš„æ¨ç†ç»“æœä¸LLM Aåœ¨<spanclass="math inline">\(X\)</span>ä¸Šçš„æ¨ç†ç»“æœå°½å¯èƒ½ä¸€è‡´ï¼Ÿ</p><p>åœ¨DejaVuä¸­ä½¿ç”¨äº†ä¸¤ä¸ªæ¨¡å‹æ¥åšé¢„æµ‹ï¼Œè¿™ä¸¤ä¸ªæ¨¡å‹çš„å®ç°éƒ½ä½¿ç”¨äº†ä¸€ä¸ªä¸¤å±‚MLPã€‚ç¬¬ä¸€ä¸ªæ¨¡å‹ç”¨æ¥é¢„æµ‹MHAä¸­å“ªäº›headæ˜¯â€œé«˜æ•ˆçš„â€ï¼›ç¬¬äºŒä¸ªæ¨¡å‹ç”¨æ¥é¢„æµ‹MLPä¸­å“ªäº›ç¥ç»å…ƒæ˜¯â€œé«˜æ•ˆçš„â€ï¼ˆç¥ç»å…ƒå®é™…ä¸Šå¯¹åº”äºå‚æ•°çŸ©é˜µçš„æŸä¸€åˆ—æˆ–æŸä¸€è¡Œï¼‰ã€‚</p><p>ä»¥é¢„æµ‹Attentionçš„headç¼–å·ä¸ºä¾‹ï¼Œå‡è®¾headæ•°ä¸º256ï¼Œåªéœ€è¦å°†MLPçš„è¾“å‡ºå±‚çš„å¤§å°è®¾ä¸º256ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªè¾“å‡ºä½¿ç”¨sigmoidæ¥åšä¸€ä¸ªäºŒåˆ†ç±»å³å¯ï¼ˆâ€œé€‰æ‹©â€orâ€œä¸é€‰æ‹©â€ï¼‰ã€‚è®­ç»ƒæ•°æ®ä¾é ä¸€ä¸ªå®Œæ•´çš„ã€è®­ç»ƒå¥½çš„LLMæ¥äº§ç”Ÿã€‚åœ¨è¿™ä¸ªLLMçš„æ¨ç†è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è®°å½•å®ƒçš„Attentionè¾“å…¥å’ŒAttentionè¾“å‡ºï¼Œå¹¶è®¡ç®—ä¸åŒheadçš„L2Normï¼Œå†åŸºäºä¸€ä¸ªL2 Normçš„é˜ˆå€¼tå°†headåˆ†ä¸ºæ­£ä¾‹å’Œè´Ÿä¾‹ã€‚</p><p>å‡è®¾å½“å‰çš„Transformeræ¨¡å—ä¸ºç½‘ç»œçš„ç¬¬ <spanclass="math inline">\(l\)</span>å±‚(ä¸åŒç½‘ç»œå±‚ä½¿ç”¨çš„ç¨€ç–æ€§é¢„æµ‹æ¨¡å‹æ˜¯ä¸åŒçš„)ï¼Œå®ƒå¯¹åº”çš„MHAå’ŒMLPç¨€ç–æ€§é¢„æµ‹æ¨¡å‹è®°ä¸º<span class="math inline">\(\mathsf{SP}_A^{l}\)</span> å’Œ <spanclass="math inline">\(\mathsf{SP}_M^{l}\)</span> ï¼Œè¾“å…¥ä¸º<spanclass="math inline">\(y_l\)</span>ã€‚ å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{align*}    S_A^l  \leftarrow \mathsf{SP}_A^{l}(y_l), \quad    \widetilde{y}_l \leftarrow \mathsf{MHA}^{l}_{S_A^l}(y_l), \\    S_M^l \leftarrow \mathsf{SP}_M^{l}(\widetilde{y}_l ), \quad    \widehat{y}_l \leftarrow \mathsf{MLP}^{l}_{S_M^l}( \widetilde{y}_l)\end{align*}\tag{-1}\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(S_A^l\)</span>å’Œ<spanclass="math inline">\(S_M^l\)</span>åˆ†åˆ«æ˜¯Attentionå’ŒMLPçš„ä¸Šä¸‹æ–‡ç¨€ç–åº¦ã€‚</p><ol type="1"><li>KV cache ç¼ºå¤±çš„å¤„ç†:å¯¹äºåœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œä¼šä¸ºä¸è¢«é€‰æ‹©çš„æ³¨æ„åŠ›å¤´ä¿å­˜ä¸€ä»½è¿‡å¾€tokençš„å‰¯æœ¬ï¼Œåœ¨ä¸‹ä¸€æ¬¡è®¡ç®—æ—¶ï¼Œå¦‚æœè¿™ä¸ªå¤´è¢«é€‰æ‹©äº†ï¼Œå¹¶ä¸”ç¼ºå°‘KVcacheï¼Œæ­¤æ—¶å°±ä¼šåŠ è½½å­˜å‚¨çš„tokenåµŒå…¥å¹¶ä¸€èµ·è®¡ç®—K/V</li><li>å³ä½¿å‡å°‘äº†éƒ¨åˆ†FFNå’Œæ³¨æ„åŠ›å¤´ï¼Œç¨€ç–é¢„æµ‹å¼€é”€å¯èƒ½å¾ˆå®¹æ˜“å¢åŠ è€Œä¸æ˜¯å‡å°‘ç«¯åˆ°ç«¯å»¶è¿Ÿ:å› ä¸ºæ³¨æ„åŠ›å’ŒMLPå—çš„è®¡ç®—å¿…é¡»ç­‰å¾…ç¨€ç–é¢„æµ‹å™¨çš„å†³å®šã€‚å°±å»¶è¿Ÿè€Œè¨€ï¼Œè¿™ç§å¼€é”€å¯èƒ½è¶…è¿‡äº†æ³¨æ„åŠ›å’ŒMLPå—çš„èŠ‚çœã€‚é‰´äºæ­¤ï¼Œå¼•å…¥äº†ä¸€ç§å‰ç»æ€§ç¨€ç–é¢„æµ‹æ–¹æ³•ã€‚ç ”ç©¶å‘ç°äº†ï¼šåµŒå…¥ç‰¹å¾ç¼“æ…¢æ¼”å˜ï¼Œå³å¯ä»¥ç”¨<spanclass="math inline">\(y_l\)</span>æ¥é¢„æµ‹<spanclass="math inline">\(l+1\)</span>å±‚çš„ç¨€ç–æ€§ã€‚ä»è€Œå®ç°å¹¶è¡ŒåŒ–ã€‚ <spanclass="math display">\[   \begin{align*}   \widetilde{y}_l \leftarrow \mathsf{MHA}^{l}_{S_A^l}(y_l), \quad   \widehat{y}_l \leftarrow \mathsf{MLP}^{l}_{S_M^l}( \widetilde{y}_l ),\\   S_{A}^{l+1} \leftarrow \mathsf{SP}_A^{l}(y_l), \quad   S_M^{l+1}  \leftarrow \mathsf{SP}_M^{l}(y_l),   \end{align*}   \tag{-2}\]</span></li><li>å…¶ä»–trick:å°†ç¨€ç–çŸ©é˜µçš„ç´¢å¼•å’Œä¹˜æ³•æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªå•ä¸€çš„å†…æ ¸ï¼Œä»¥åŠé‡‡ç”¨äº†å…¶ä»–ä¸€äº›å†…å­˜å¯¹é½æŠ€æœ¯ä»¥ä¿è¯é«˜æ•ˆæ‰§è¡Œã€‚</li></ol><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://arxiv.org/abs/2310.17157">Deja Vu:Contextual Sparsity for Efficient LLMs at Inference Time</a> <ahref="https://zhuanlan.zhihu.com/p/673848224">å‚è€ƒ</a></p><h3 id="å…¶ä»–">å…¶ä»–</h3><ol type="1"><li>å¤§äºæ€»å†…å­˜çš„æ¨¡å‹æ€ä¹ˆæ”¾åˆ°æœºå™¨ä¸Š<ol type="1"><li>å¯¹äºPowerInfer1ï¼Œæ¨¡å‹é¦–å…ˆåœ¨CPUä¸ŠåŠ è½½ï¼Œç„¶åå°†çƒ­æ¿€æ´»ç¥ç»å…ƒæ ¹æ®æ¨¡å‹ä¿å­˜çš„æ¿€æ´»æ–‡ä»¶ä¿¡æ¯å¸è½½åˆ°GPUä¸Šã€‚</li><li>è‡³äºPowerInfer-2ï¼Œåˆ™æ˜¯åˆ›å»ºä¸€ä¸ªLRUç¼“å­˜ï¼Œå°†é¢‘ç¹ä½¿ç”¨çš„(çƒ­æ¿€æ´»)ç¥ç»å…ƒæ”¾åˆ°DRAMä¸­ï¼Œè¶…å‡ºLRUç¼“å­˜å¤§å°çš„(å†·)ç¥ç»å…ƒæ”¾åœ¨RAMï¼Œç„¶åè®¡ç®—çš„æ—¶å€™å¦‚æœå‘½ä¸­LRUç¼“å­˜ï¼Œç›´æ¥è®¡ç®—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è·³è¿‡è¯¥ç¥ç»å…ƒè®¡ç®—ä¸‹ä¸€ä¸ªç¥ç»å…ƒï¼Œå¹¶åŒæ—¶å¼€å§‹IOæ“ä½œã€‚è¿™æ ·å¯ä»¥å…ˆè®¡ç®—åœ¨DRAMä¸­çš„ç¥ç»å…ƒï¼Œç„¶åå†è®¡ç®—åœ¨RAMä¸­çš„ç¥ç»å…ƒï¼Œè¿™ç§å¹¶è¡Œå¯ä»¥å‡å°‘IOæ“ä½œçš„å½±å“ã€‚</li></ol></li><li>DejaVu å¢åŠ äº†è®¡ç®—æ€ä¹ˆæ¯”åŸæ¥è®¡ç®—å¿«<ol type="1"><li>DejaVu é€šè¿‡åŠ¨æ€å‰ªæçš„æ–¹å¼ï¼Œå‡å°‘äº†è®¡ç®—é‡</li><li>ç¨€ç–é¢„æµ‹å™¨è¿›è¡Œå¹¶è¡Œé¢„æµ‹ï¼Œåœ¨ç¬¬tæ­¥æ—¶é¢„æµ‹ç¬¬t+1æ­¥çš„ç¨€ç–æ€§ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´</li><li>Kernel fusion: å°†ç¨€ç–çŸ©é˜µçš„ç´¢å¼•å’Œä¹˜æ³•æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªå•ä¸€çš„å†…æ ¸</li><li>å†…å­˜å¯¹é½æŠ€æœ¯: å‡å°‘IOæ“ä½œçš„å½±å“</li></ol></li><li>ä¸ºä»€ä¹ˆåœ¨ä¸‹æŠ•å½±å±‚å®ç°AXPYç®—å­æ¥è®¡ç®—ç¨€ç–çŸ©é˜µï¼Œè€Œä¸ŠæŠ•å½±å±‚åˆ™æ˜¯æ­£å¸¸çš„vec_dotå½¢å¼çš„çŸ©é˜µä¹˜æ³•<ol type="1"><li>è¿™æ˜¯è€ƒè™‘åˆ°äº†ç¥ç»å…ƒçš„æ¿€æ´»åœ¨ä¸‹æŠ•å½±å±‚æ˜¯æŒ‰åˆ—çš„ï¼Œå¯¼è‡´äº†ä¸‹æŠ•å½±å±‚åŠ è½½æ—¶çš„ä¸è¿ç»­æ€§ï¼Œdecodingé˜¶æ®µLLMæ¨ç†æ˜¯memorybandwidthboundçš„ï¼Œå®ç°æ€è·¯å°±æ˜¯å°½å¯èƒ½ä¿è¯è¿ç»­çš„loadï¼Œå¹¶ä¸”è·³è¿‡ä¸å¿…è¦çš„memoryaccessã€‚å°½ç®¡GPUä¸Šsharedmemoryæ˜¯å¯ä»¥ä»HBMå…ˆä¸è¿ç»­çš„loadè¿›æ¥å†è¿›è¡Œè®¡ç®—ï¼Œä½†æ˜¯CPUä¸Šçš„cacheæ²¡åŠæ³•æ˜¾å¼æ§åˆ¶ï¼ŒAXPYå¯ä»¥ä¿è¯CPU/GPUéƒ½èƒ½åšåˆ°è¿ç»­çš„memoryaccessï¼Œå› æ­¤è®¾è®¡äº†AXPYã€‚</li><li>å¦‚å›¾1æ‰€ç¤ºï¼Œåœ¨ä¸‹æŠ•å½±è®¡ç®—çš„æ—¶å€™ï¼Œæ¯ä¸€è¡Œçš„å…ƒç´ æ˜¯ç¨€ç–æ¿€æ´»çš„ï¼Œæ¿€æ´»çš„åˆ—æ•°æ®æ˜¯è¿ç»­çš„ï¼Œå› æ­¤åœ¨è®¡ç®—æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æ¿€æ´»ï¼Œå¦‚æœæ¿€æ´»åˆ™å°†å¯¹åº”çš„åˆ—åŠ è½½åˆ°cacheä¸­ï¼Œç„¶åè¿›è¡Œè®¡ç®—ï¼Œå¦‚æœä¸æ¿€æ´»åˆ™è·³è¿‡è¯¥åˆ—ã€‚å°†ä»¥è¡Œä¸ºåŸºå‡†çš„ç¨€ç–çŸ©é˜µè½¬æ¢ä¸ºä»¥åˆ—ä¸ºåŸºå‡†çš„ç¨€ç–çŸ©é˜µã€‚</li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹PowerInfer2.0</title>
      <link href="/2024/08/08/NLP/LLMModels/PowerInfer/PowerInfer2/"/>
      <url>/2024/08/08/NLP/LLMModels/PowerInfer/PowerInfer2/</url>
      
        <content type="html"><![CDATA[<h1 id="powerinfer-2">PowerInfer-2</h1><p>åœ¨æ™ºèƒ½æ‰‹æœºä¸Šçš„å¿«é€Ÿå¤§è¯­è¨€æ¨¡å‹æ¨ç† åŸæ–‡é“¾æ¥ï¼š<ahref="https://arxiv.org/abs/2406.06282">PowerInfer-2: Fast LargeLanguage Model Inference on a Smartphone</a></p><h2 id="ç®€ä»‹">1 ç®€ä»‹</h2><p>PowerInfer-2æ˜¯ä¸€ä¸ªä¸ºæ™ºèƒ½æ‰‹æœºä¸Šå¤§å‹è¯­è¨€æ¨¡å‹(LLM)é«˜é€Ÿæ¨ç†è€Œè®¾è®¡çš„æ¡†æ¶ï¼Œ<strong>ç‰¹åˆ«é€‚ç”¨äºå¤§å°è¶…è¿‡è®¾å¤‡å†…å­˜å®¹é‡çš„æ¨¡å‹</strong>ã€‚</p><h3 id="æ€§èƒ½æå‡">1.1 æ€§èƒ½æå‡</h3><p>PowerInfer-2 æ˜¯ç¬¬ä¸€ä¸ªä¸º TurboSparse-Mixral-47Bæ¨¡å‹æä¾›æœåŠ¡çš„ç³»ç»Ÿï¼Œæ™ºèƒ½æ‰‹æœºæ¯ç§’ç”Ÿæˆ 11.68ä¸ªtokensã€‚å¯¹äºå®Œå…¨åœ¨å†…å­˜ä¸­æ‹Ÿåˆçš„æ¨¡å‹ï¼ŒPowerInfer-2 åœ¨ä¿æŒä¸ llama.cpp å’ŒMLC-LLM ç›¸å½“çš„æ¨ç†é€Ÿåº¦çš„åŒæ—¶ï¼Œå¯ä»¥å‡å°‘å¤§çº¦ 40% çš„å†…å­˜ä½¿ç”¨ã€‚</p><ol type="1"><li>ä½æ¨ç†å»¶è¿Ÿï¼šæœ€å¤§é™åº¦åœ°å‡å°‘é¢„å¡«å……é˜¶æ®µï¼ˆTTFTï¼‰å’Œè§£ç é˜¶æ®µï¼ˆTBTï¼‰çš„æ¨ç†å»¶è¿Ÿï¼›</li><li>ä½å†…å­˜å ç”¨ï¼šå‡å°‘æ¨ç†è¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨ï¼Œå³ä½¿æ¨¡å‹å¤§å°è¶…è¿‡è®¾å¤‡å†…å­˜é™åˆ¶ï¼Œä¹Ÿèƒ½å®ç°LLMçš„ä½å»¶è¿Ÿæ¨ç†ï¼›</li><li>çµæ´»æ€§ï¼šç¡®ä¿è®¾è®¡èƒ½å¤Ÿæ— ç¼é€‚åº”å…·æœ‰ä¸åŒè®¡ç®—ã€å†…å­˜å’Œå­˜å‚¨å®¹é‡çš„æ™ºèƒ½æ‰‹æœºã€‚</li></ol><h2 id="æ¦‚è¿°">2 æ¦‚è¿°</h2><h3 id="æ ¸å¿ƒ">2.1 æ ¸å¿ƒ</h3><p><strong>PowerInfer-2 çš„æ ¸å¿ƒæ˜¯å°† LLMæ¨ç†ä¸­å…¸å‹çš„ç²—ç²’åº¦çŸ©é˜µè®¡ç®—åˆ†è§£ä¸ºç»†ç²’åº¦ç¥ç»å…ƒé›†ç¾¤è®¡ç®—ã€‚</strong></p><h3 id="ç¥ç»å…ƒç°‡å’Œæ¶æ„">2.2 ç¥ç»å…ƒç°‡å’Œæ¶æ„</h3><p>PowerInfer-2ä»¥ç¥ç»å…ƒç°‡çš„ç²’åº¦è¿›è¡Œè®¡ç®—å’ŒI/Oæ“ä½œï¼Œ<strong>ç¥ç»å…ƒç°‡å¯ä»¥åœ¨è®¡ç®—è¿‡ç¨‹ä¸­åŠ¨æ€åœ°ç”±å¤šä¸ªæ¿€æ´»çš„ç¥ç»å…ƒç»„æˆ</strong>ï¼Œç¥ç»å…ƒçš„æ•°é‡ç”±è®¡ç®—å•å…ƒçš„è®¡ç®—èƒ½åŠ›å†³å®šï¼Œä»è€Œå¯ä»¥å……åˆ†åˆ©ç”¨å…·æœ‰ä¸åŒè®¡ç®—èƒ½åŠ›çš„XPUã€‚</p><p>å›¾ 1å±•ç¤ºäº†PowerInfer-2çš„æ•´ä½“æ¶æ„ï¼Œå®ƒåˆ†ä¸ºåœ¨çº¿ï¼ˆå³éƒ¨åˆ†ï¼‰å’Œç¦»çº¿ï¼ˆå·¦éƒ¨åˆ†ï¼‰ç¨‹åºã€‚</p><ul><li>åœ¨çº¿éƒ¨åˆ†æä¾›ç¥ç»å…ƒç°‡ç²’åº¦çš„æ¨ç†ï¼ŒåŒ…æ‹¬å››ä¸ªåä½œç»„ä»¶ï¼šå¤šæ€ç¥ç»å…ƒå¼•æ“ã€å†…å­˜ä¸­ç¥ç»å…ƒç¼“å­˜ã€çµæ´»çš„ç¥ç»å…ƒåŠ è½½å’Œç¥ç»å…ƒç°‡çº§åˆ«I /O ç®¡é“ã€‚</li><li>ç¦»çº¿éƒ¨åˆ†æè¿°åœ¨çº¿æ¨ç†ä¸­æ¶‰åŠçš„æ¯ä¸ªç»„ä»¶çš„å…·ä½“é…ç½®å¹¶æŒ‡å¯¼åœ¨çº¿è¿‡ç¨‹ã€‚</li></ul><figure><img src="./images/architecture.webp#80x80"title="å›¾1: PowerInfer-2æ•´ä½“æ¶æ„" alt="PowerInfer-2æ•´ä½“æ¶æ„" /><figcaption aria-hidden="true">PowerInfer-2æ•´ä½“æ¶æ„</figcaption></figure><h2 id="åœ¨çº¿éƒ¨åˆ†">3 åœ¨çº¿éƒ¨åˆ†</h2><h3 id="å¤šæ€ç¥ç»å…ƒå¼•æ“">3.1 å¤šæ€ç¥ç»å…ƒå¼•æ“</h3><p>PowerInfer-2å¼•å…¥äº†ä¸€ä¸ªå¤šæ€ç¥ç»å…ƒå¼•æ“ï¼Œè¯¥å¼•æ“åŠ¨æ€åœ°å°†ç¥ç»å…ƒç»„åˆæˆç¥ç»å…ƒç°‡ï¼Œä»¥åˆ©ç”¨LLMæ¨ç†é˜¶æ®µå’Œå¼‚è´¨XPUçš„ä¸åŒè®¡ç®—ç‰¹å¾ã€‚ç”¨äºé¢„å¡«å……å’Œè§£ç é˜¶æ®µçš„ä¸¤ä¸ªè®¡ç®—å·¥ä½œæµç¨‹å¦‚å›¾2 æ‰€ç¤ºã€‚</p><figure><img src="./images/computing-workflow.webp#50x50"title="å›¾2: PowerInfer-2çš„å¤šæ€ç¥ç»å…ƒå¼•æ“"alt="PowerInfer-2çš„å¤šæ€ç¥ç»å…ƒå¼•æ“" /><figcaption aria-hidden="true">PowerInfer-2çš„å¤šæ€ç¥ç»å…ƒå¼•æ“</figcaption></figure><ul><li><ol type="a"><li>é¢„å¡«å……é˜¶æ®µé‡‡ç”¨ä»¥ NPU ä¸ºä¸­å¿ƒçš„å·¥ä½œæµç¨‹ï¼Œåˆ©ç”¨ NPU è¿›è¡Œè®¡ç®—ï¼Œåˆ©ç”¨ CPUè¿›è¡Œå‡†å¤‡ï¼›</li></ol></li><li><ol start="2" type="a"><li>è§£ç é˜¶æ®µä»¥ CPU ä¸ºä¸­å¿ƒï¼Œä»…ä½¿ç”¨ CPU æ ¸å¿ƒæ¥åˆ©ç”¨ç¨€ç–æ¿€æ´»ã€‚</li></ol></li></ul><h4 id="ä»¥-npu-ä¸ºä¸­å¿ƒçš„é¢„å¡«å……">3.1.1 ä»¥ NPU ä¸ºä¸­å¿ƒçš„é¢„å¡«å……</h4><p>å¯¹äº<strong>é¢„å¡«å……é˜¶æ®µï¼Œç¥ç»å…ƒç°‡åŒ…å«æƒé‡çŸ©é˜µä¸­çš„æ‰€æœ‰ç¥ç»å…ƒ</strong>ï¼Œæ‰€æœ‰tokenséƒ½ä¼šåŒæ—¶å¤„ç†ã€‚å°½ç®¡è¿™äº›tokensä¸­çš„æ¯ä¸€ä¸ªéƒ½æ˜¾ç¤ºå‡ºé«˜ç¨€ç–æ€§å¹¶æ¿€æ´»ä¸åŒçš„ç¥ç»å…ƒï¼Œä½†ç”±äºè¿™äº›æ¿€æ´»çš„èšåˆï¼Œæ€»ä½“ç¨€ç–æ€§æ˜¾ç€é™ä½ã€‚å› æ­¤ï¼ŒPowerInfer-2åœ¨é¢„å¡«å……é˜¶æ®µä¸ä¼šä½¿ç”¨é¢„æµ‹å™¨æ¥è®¡ç®—æ¿€æ´»çš„ç¥ç»å…ƒï¼Œè€Œæ˜¯é€‰æ‹©ç›´æ¥å°†æ‰€æœ‰ç¥ç»å…ƒåˆå¹¶æˆä¸€ä¸ªå¤§çš„ç¥ç»å…ƒç°‡ã€‚</p><p>CPUæ ¸å¿ƒä¸å‚ä¸çŸ©é˜µè®¡ç®—ï¼Œåœ¨é¢„å¡«å……é˜¶æ®µåªä¸ºNPUæ‰§è¡Œå¿…è¦çš„å‡†å¤‡ä»»åŠ¡ã€‚</p><ul><li>é¦–å…ˆï¼Œç”±äºå†…å­˜æœ‰é™ï¼ŒPowerInfer-2 åœ¨é¢„å¡«å……é˜¶æ®µä¾èµ– CPUæ ¸å¿ƒå°†é—ªå­˜ä¸­å­˜å‚¨çš„æƒé‡åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>å…¶æ¬¡ï¼Œç”±äºå½“å‰çš„ NPU ä¸æ”¯æŒç›´æ¥ä½¿ç”¨é‡åŒ–æƒé‡è¿›è¡Œè®¡ç®—ï¼ŒPowerInfer-2 åœ¨NPU è®¡ç®—ä¹‹å‰ä½¿ç”¨ CPU å†…æ ¸å¯¹æ•°æ®è¿›è¡Œåé‡åŒ–ã€‚</li></ul><p>å›¾ 2-a æ¼”ç¤ºäº† CPU å’Œ NPU å¦‚ä½•åä½œåœ¨ Transformerå±‚ç²’åº¦ä¸­æ‰§è¡Œé¢„å¡«å……é˜¶æ®µæ¨ç†ã€‚ NPU è®¡ç®—éœ€è¦ä½¿ç”¨ä¸ CPUå…±äº«çš„æœ‰é™å†…å­˜ã€‚å› æ­¤ï¼Œåœ¨ NPU è®¡ç®—å¼€å§‹ä¹‹å‰ï¼ŒCPUåº”å°†æ‰€éœ€çš„çŸ©é˜µæƒé‡é¢„åŠ è½½åˆ°è¯¥å…±äº«å†…å­˜ä¸­ã€‚</p><ol type="1"><li>åœ¨NPUè¿›è¡Œä»»ä½•çŸ©é˜µä¹˜æ³•ä¹‹å‰ï¼Œå¤šä¸ªCPUä¸­æ ¸ä»ç¥ç»å…ƒç¼“å­˜ä¸­è¯»å–é‡åŒ–çŸ©é˜µæƒé‡ï¼Œå¹¶æå‰å°†è¿™äº›çŸ©é˜µæƒé‡åé‡åŒ–ä¸ºfp16ï¼Œæœ€ç»ˆå°†ç»“æœå­˜å‚¨åœ¨CPUå’ŒCPUä¹‹é—´çš„å…±äº«å†…å­˜ä¸­ã€‚</li><li>åŒæ—¶ï¼ŒPowerInfer-2ä½¿ç”¨å¦ä¸€ä¸ªå¤§æ ¸å°†ä¸‹ä¸€å±‚çš„æ‰€æœ‰çŸ©é˜µæƒé‡å¼‚æ­¥é¢„åŠ è½½åˆ°ç¥ç»å…ƒç¼“å­˜ä¸­ã€‚</li><li>ä¸­æ ¸çš„åé‡åŒ–ã€NPUçš„è®¡ç®—å’Œå¤§æ ¸çš„I/Oæ“ä½œåŒæ—¶è¿›è¡Œï¼Œä»¥å‡å°‘I/Oå¼€é”€ã€‚</li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºé¢„å¡«å……é˜¶æ®µæ¶‰åŠå¯†é›†çŸ©é˜µè€Œä¸æ˜¯ç¨€ç–è®¡ç®—,é€šè¿‡ I/Oè¿›è¡ŒåŠ æƒåŠ è½½å¯ä»¥åˆ©ç”¨é¡ºåºè¯»å–å°†å¤§å—æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨UFS çš„ I/O å¸¦å®½ã€‚</p><h4 id="ä»¥cpuä¸ºä¸­å¿ƒçš„è§£ç ">3.1.2 ä»¥CPUä¸ºä¸­å¿ƒçš„è§£ç </h4><p>ä¸é¢„å¡«å……é˜¶æ®µä¸åŒï¼Œè§£ç é˜¶æ®µåœ¨æ¯æ¬¡è¿­ä»£æœŸé—´é›†ä¸­äºå•ä¸ªtokenï¼Œè¡¨ç°å‡ºæ˜¾ç€çš„ç¨€ç–æ€§ï¼Œå› ä¸ºæƒé‡çŸ©é˜µä¸­åªæœ‰ä¸€å°éƒ¨åˆ†ç¥ç»å…ƒï¼ˆå¤§çº¦10%ï¼‰è¢«æ¿€æ´»å¹¶å‚ä¸è®¡ç®—ã€‚å› æ­¤ï¼Œå¯¹äºè§£ç é˜¶æ®µï¼Œ<strong>è°ƒç”¨é¢„æµ‹å™¨æ¥è¯†åˆ«åœ¨å¼€å§‹è®¡ç®—ä¹‹å‰å°†æ¿€æ´»å“ªäº›ç¥ç»å…ƒï¼Œç„¶åå¼•æ“å°†è¿™äº›æ¿€æ´»çš„ç¥ç»å…ƒåˆå¹¶æˆä¸€ä¸ªå°çš„ç¥ç»å…ƒç°‡ï¼Œå¹¶åˆ©ç”¨CPU æ ¸å¿ƒåŠ¨æ€è®¡ç®—ç¥ç»å…ƒç°‡</strong>:</p><ul><li>å½“æ‰¹é‡å¤§å°ä¸º 1 æ—¶(å³å°±ä¸€ä¸ª token)ï¼ŒCPU å†…æ ¸ä¸ŠçŸ©é˜µå‘é‡è®¡ç®—çš„å»¶è¿Ÿä½äºNPU ä¸Šçš„å»¶è¿Ÿã€‚</li><li>ç”±äºç¨€ç–æ€§å¯¼è‡´æ¿€æ´»çš„ç¥ç»å…ƒæ•°é‡å‡å°‘ï¼ŒCPU å†…æ ¸æœ€é€‚åˆ XPUä¸­çš„è¿™äº›è¾ƒè½»ä¸”ç¨€ç–çš„è®¡ç®—ã€‚</li></ul><p>å…·ä½“æ¥è¯´ï¼ŒPowerInfer-2 åœ¨è§£ç é˜¶æ®µåˆ©ç”¨ CPU å†…æ ¸æ¥è®¡ç®—æ³¨æ„åŠ›å—å’Œ FFNå—ã€‚</p><ul><li>å°½ç®¡æ³¨æ„åŠ›å—æ²¡æœ‰è¡¨ç°å‡ºç¨€ç–æ€§ï¼Œä½†å½“è¾“å…¥åªæ˜¯å•ä¸ªå‘é‡æ—¶ï¼ŒCPUå†…æ ¸ä»ç„¶æä¾›è¾ƒä½çš„è®¡ç®—å»¶è¿Ÿã€‚</li><li>å¯¹äº FFN å—ï¼ŒPowerInfer-2 é¦–å…ˆå°† FFNå—çš„è¾“å…¥å‘é‡ä¼ é€’ç»™é¢„æµ‹å™¨ï¼Œ<strong>é¢„æµ‹å™¨é¢„æµ‹ FFNæƒé‡çŸ©é˜µä¸­çš„å“ªäº›ç¥ç»å…ƒéœ€è¦æ¿€æ´»ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶åˆ°ç¥ç»å…ƒç°‡ä¸­</strong>ã€‚ç„¶åï¼Œæ¯ä¸ªCPU æ ¸å¿ƒè·å–ä¸€ä¸ªé›†ç¾¤å¹¶è®¡ç®—é›†ç¾¤å†…çš„è¿™äº›ç¥ç»å…ƒå’Œè¾“å…¥å‘é‡ã€‚</li></ul><p>å›¾ 2-b è¯´æ˜äº†ä¸åŒCPUæ ¸è¿›è¡Œçš„è§£ç é˜¶æ®µæ¨æ–­ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p><ol type="1"><li>CPUæ ¸å¿ƒé¦–å…ˆä»ç¥ç»å…ƒç¼“å­˜ä¸­è¯»å–æ³¨æ„åŠ›å—çš„æƒé‡ï¼Œå¹¶ä½¿ç”¨è¾“å…¥å‘é‡è¿›è¡Œè®¡ç®—ã€‚</li><li>è¿è¡Œé¢„æµ‹å™¨æ¥ç¡®å®šåç»­æƒé‡çŸ©é˜µä¸­ç¥ç»å…ƒçš„æ¿€æ´»çŠ¶æ€ã€‚</li><li>CPUæ ¸å¿ƒå°†æ¿€æ´»çš„ç¥ç»å…ƒåˆ†æˆå‡ ä¸ªç°‡ï¼Œæ¯ä¸ªæ ¸å¿ƒè´Ÿè´£ç”¨è¾“å…¥å‘é‡è®¡ç®—å…¶ç°‡å†…æ¿€æ´»çš„ç¥ç»å…ƒï¼Œå¹¶æœ€ç»ˆèšåˆç»“æœã€‚</li><li>å¦‚æœè¿™äº›ç¥ç»å…ƒä½äºç¥ç»å…ƒç¼“å­˜å†…ï¼ŒCPUå†…æ ¸å°†ä½¿ç”¨è¾“å…¥å‘é‡è®¡ç®—å®ƒä»¬ã€‚åœ¨ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µä¸‹ï¼Œå³ç¥ç»å…ƒä¸åœ¨ç¥ç»å…ƒç¼“å­˜ä¸­ï¼ŒCPUæ ¸å¿ƒä¸Šè¿è¡Œçš„ I/Oçº¿ç¨‹å°†ç¥ç»å…ƒå¼‚æ­¥åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œæœ€ç»ˆé€šçŸ¥è®¡ç®—çº¿ç¨‹å®Œæˆè®¡ç®—ã€‚</li></ol><h3 id="å†…å­˜ä¸­ç¥ç»å…ƒç¼“å­˜">3.2 å†…å­˜ä¸­ç¥ç»å…ƒç¼“å­˜</h3><p>PowerInfer-2 å¼•å…¥äº†é’ˆå¯¹ LLMå†…å„ç§æ•°æ®ç±»å‹é‡èº«å®šåˆ¶çš„åˆ†æ®µç¥ç»å…ƒç¼“å­˜è®¾è®¡ã€‚å®ƒå°†ç¼“å­˜åˆ’åˆ†ä¸ºå¤šä¸ªåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½æœ‰ç‰¹å®šçš„é¢„å–å’Œé€å‡ºç­–ç•¥ã€‚</p><p>æ³¨æ„åŠ›å—æƒé‡è¾ƒå°ä¸”æ¿€æ´»è¾ƒå°‘ï¼Œåœ¨æ•´ä¸ªè¿è¡Œæ—¶é¢„åŠ è½½å¹¶ä¿ç•™ã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼ŒFFNå—å®¹æ˜“é¢‘ç¹æ¿€æ´»çƒ­ç¥ç»å…ƒï¼Œå¯¹è¿™äº›ç¥ç»å…ƒä½¿ç”¨åŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨ (LRU)çš„åŠ¨æ€é©±é€ç­–ç•¥ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿çƒ­ç¥ç»å…ƒæ›´æœ‰å¯èƒ½ä¿ç•™åœ¨ç¼“å­˜ä¸­ï¼Œè€Œå†·ç¥ç»å…ƒç»å¸¸è¢«é€å‡ºå¹¶æŒ‰éœ€ä»é—ªå­˜åŠ è½½ã€‚é‡è¦çš„æ˜¯ï¼Œé€å‡ºè¿‡ç¨‹ä¸æ¶‰åŠå†™å…¥å­˜å‚¨ï¼Œè€Œåªæ˜¯ä¸¢å¼ƒå†…å­˜ä¸­çš„æƒé‡ã€‚</p><p>PowerInfer-2 åˆ©ç”¨ç»å…¸çš„åŒé˜Ÿåˆ—æ–¹æ³•æ¥å®ç°å…¶ LRUç¥ç»å…ƒç¼“å­˜ï¼Œè¯¥ç¼“å­˜ä»¥å•ä¸ªç¥ç»å…ƒçš„ç²’åº¦ç®¡ç† LLMæƒé‡ã€‚è¯¥ç³»ç»Ÿç»´æŠ¤ä¸¤ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸ºæ´»åŠ¨å’Œéæ´»åŠ¨ï¼Œå…¶ä¸­é˜Ÿåˆ—ä¸­ç¥ç»å…ƒçš„é¡ºåºç”±å®ƒä»¬æœ€è¿‘è®¿é—®çš„æ—¶é—´å†³å®šï¼Œæœ€è¿‘è®¿é—®çš„ç¥ç»å…ƒä½äºé˜Ÿåˆ—çš„å¤´éƒ¨ã€‚</p><p>**LRU ç¼“å­˜ç®¡ç†å™¨çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼šåœ¨è¿è¡Œæ—¶ï¼Œæ‰€æœ‰ç¥ç»å…ƒæœ€åˆéƒ½ä¼šåŠ å…¥éæ´»åŠ¨é˜Ÿåˆ—ã€‚é‡æ–°è®¿é—®æ—¶ï¼Œå®ƒä»¬è¢«æå‡åˆ°æ´»åŠ¨é˜Ÿåˆ—çš„å‰é¢ã€‚å·²ç»åœ¨æ´»åŠ¨é˜Ÿåˆ—ä¸­çš„ç¥ç»å…ƒåœ¨åç»­è®¿é—®æ—¶è¢«ç§»åŠ¨åˆ°å¤´éƒ¨ã€‚ä¸ºäº†ç®¡ç†ç¼“å­˜å®¹é‡ï¼Œå½“æ´»åŠ¨é˜Ÿåˆ—å æ»¡ç¼“å­˜ç©ºé—´çš„90% æ—¶ï¼Œæ´»åŠ¨é˜Ÿåˆ—å°¾éƒ¨çš„ç¥ç»å…ƒå°†è¢«ç§»è‡³éæ´»åŠ¨é˜Ÿåˆ—ï¼Œç›´åˆ°æ´»åŠ¨é˜Ÿåˆ—çš„å ç”¨ç‡é™è‡³90%ä»¥ä¸‹ã€‚å¦‚æœç¼“å­˜è¾¾åˆ°å®¹é‡ï¼Œéæ´»åŠ¨é˜Ÿåˆ—å°¾éƒ¨çš„ç¥ç»å…ƒå°†è¢«ä¸¢å¼ƒï¼Œä¸ºæ–°æ¡ç›®è…¾å‡ºç©ºé—´ã€‚*</p><h3 id="çµæ´»çš„ç¥ç»å…ƒåŠ è½½">3.3 çµæ´»çš„ç¥ç»å…ƒåŠ è½½</h3><p>PowerInfer-2 é€šè¿‡è‡ªé€‚åº”æ†ç»‘å’ŒåŠ è½½ç¥ç»å…ƒæ¥æœ€å¤§é™åº¦åœ°å‡å°‘ I/Oå¼€é”€ï¼Œè¿™æ˜¯ç”±æ¨¡å‹çš„é‡åŒ–å†³å®šçš„ã€‚</p><h4 id="è‡ªé€‚åº”æ†ç»‘">3.3.1 è‡ªé€‚åº”æ†ç»‘</h4><p>åœ¨æ¨ç†è¿‡ç¨‹ä»ç„¶ä¸å¯é¿å…åœ°å¯¼è‡´æœªç¼“å­˜ç¥ç»å…ƒçš„ I/O æ“ä½œï¼Œä¸ºäº†ä¼˜åŒ– I/Oè¯»å–ååé‡å¹¶æœ€å°åŒ– I/O æ“ä½œï¼ŒPowerInfer-2è¿˜æ†ç»‘ç›¸å…³ç¥ç»å…ƒã€‚å°½ç®¡åœ¨å•ä¸ªFFNæƒé‡çŸ©é˜µå†…çš„å…±æ¿€æ´»åœ¨ç§»é™¤çƒ­ç¥ç»å…ƒåå˜å¾—ä¸å¸¸è§ï¼Œä½†ä¸åŒçŸ©é˜µä¸­ç›¸åº”ä½ç½®çš„ç¥ç»å…ƒé€šå¸¸ä¼šä¸€èµ·æ¿€æ´»ã€‚å› æ­¤PowerInfer-2<strong>é€‰æ‹©æ ¹æ®ç¥ç»å…ƒç²’åº¦è€Œä¸æ˜¯çŸ©é˜µç»“æ„æ¥å­˜å‚¨ç¥ç»å…ƒæƒé‡</strong>ã€‚</p><p>**ä¾‹å¦‚ï¼ŒGateã€Upã€Down çŸ©é˜µä¸­ç¬¬ i ä¸ªç¥ç»å…ƒçš„å…±æ¿€æ´»æ¦‚ç‡é«˜è¾¾80%ï¼Œæ‰€ä»¥å°† Gateã€Up å’Œ Down çŸ©é˜µä¸­ç¬¬ iä¸ªç¥ç»å…ƒçš„æƒé‡è¿æ¥åˆ°å•ä¸ªæ¡ç›®ä¸­ã€‚*</p><h4 id="çµæ´»çš„ç¥ç»å…ƒåŠ è½½-1">3.3.2 çµæ´»çš„ç¥ç»å…ƒåŠ è½½</h4><p>è€ƒè™‘åˆ°ä¸åŒæ¨¡å‹çš„é‡åŒ–æ–¹æ³•å’Œ UFS I/O çš„å›ºæœ‰ç‰¹æ€§ï¼ŒPowerInfer-2è¿›ä¸€æ­¥å¼•å…¥äº†ä¸åŒæ¨¡å‹çš„ä¸åŒ I/O åŠ è½½ç­–ç•¥ã€‚</p><p>å¯¹äºæ²¡æœ‰é‡åŒ–çš„æ¨¡å‹ï¼Œç”±äºæ¯ä¸ªç¥ç»å…ƒå ç”¨çš„å­˜å‚¨ç©ºé—´è¾ƒå¤§ï¼ŒPowerInfer-2ä½¿ç”¨æ›´å¤§ç²’åº¦çš„éšæœºè¯»å–æ¥æé«˜I/Oå¸¦å®½ã€‚**ä¾‹å¦‚ï¼ŒLlama-7B-FP16 ä¸­çš„å•ä¸ªç¥ç»å…ƒå ç”¨ 8KBï¼Œæ¥è‡ª Gateã€Up å’Œ DownçŸ©é˜µçš„ç¥ç»å…ƒçš„æ€»å¤§å°ä¸º 24KBã€‚ PowerInfer-2 é€šè¿‡ä¸€æ¬¡éšæœº I/Oè¯»å–ï¼Œæœ‰æ•ˆåœ°å°†æ•´ä¸ª 24KB æ¿€æ´»åŒ…ä¼ è¾“åˆ°å†…å­˜ä¸­ã€‚*</p><p>å¯¹äº 4 ä½é‡åŒ–æ¨¡å‹ï¼Œæ†ç»‘åŒ…å¤§å°è®¾ç½®ä¸º 8KBã€‚ä»¥ Llama-7Bæ¨¡å‹ä¸ºä¾‹ï¼Œæ¯ä¸ªç¥ç»å…ƒè¢«é‡åŒ–ä¸º 4 ä½ç²¾åº¦å¹¶å ç”¨ 2.5KBï¼ˆé‡åŒ–çš„ int4 å€¼ä¸º2KBï¼Œé‡åŒ–ç»„çš„ FP16 å°ºåº¦ä¸º 0.5KBï¼‰ï¼Œç»„åˆæŸå¤§å°è¾¾åˆ° 7.5KBã€‚ä¸ºäº†ä¸å­˜å‚¨ä»‹è´¨4KB çš„æœ€å°è¯»å–ç²’åº¦ä¿æŒä¸€è‡´ï¼ŒPowerInfer-2 åœ¨æ†ç»‘åŒ…ä¸­é¢å¤–è¡¥å……äº†0.5KBï¼Œå°†æ€»æ•°å››èˆäº”å…¥ä¸º 8KBã€‚ç„¶è€Œï¼ŒPowerInfer-2 å¹¶æ²¡æœ‰åœ¨å•ä¸ª I/Oæ“ä½œä¸­åŠ è½½è¿™äº› 8KB åŒ…ï¼Œè€Œæ˜¯é€‰æ‹©äº† 4KB ç²’åº¦ã€‚å› ä¸ºæˆ‘ä»¬å‘ç°ä¸¤æ¬¡å•ç‹¬çš„ 4KBéšæœºè¯»å–çš„å¸¦å®½è¶…è¿‡äº†å•ä¸ª 8KB è¯»å–çš„å¸¦å®½ï¼Œä»è€Œä¼˜åŒ–äº† I/O è¯»å–è¿‡ç¨‹ã€‚</p><p>æ­¤å¤–ï¼Œè€ƒè™‘åˆ°è¿™äº›ç¥ç»æŸå†…å…±æ¿€æ´»çš„å¯èƒ½æ€§ä¸º 80%ï¼Œè¿™äº›æˆæŸç¥ç»å…ƒä»æœ‰è¿‘20% çš„æ¦‚ç‡ä¸è¢«å…±æ¿€æ´»ã€‚å› æ­¤ï¼Œç»„åˆä¸¤ä¸ª 4KBéšæœºè¯»å–å¯èƒ½ä¼šå¯¼è‡´å¸¦å®½æµªè´¹ã€‚ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œå¯¹äºä½¿ç”¨ 4ä½é‡åŒ–çš„æ¨¡å‹ï¼ŒPowerInfer-2 ä¼šå»¶è¿Ÿç¬¬äºŒä¸ª 4KBè¯»å–ï¼Œç›´åˆ°è·å¾—é—¨ç¥ç»å…ƒä¹˜æ³•çš„ç»“æœã€‚(PowerInfer-2ä½¿ç”¨é¢„æµ‹å™¨æ¥ç¡®å®šé—¨çŸ©é˜µå†…ç¥ç»å…ƒçš„æ¿€æ´»ï¼Œå¹¶æ ¹æ®æ­¤ä¿¡æ¯å¯åŠ¨æŸç¬¬ä¸€éƒ¨åˆ†çš„è´Ÿè½½ã€‚ä¹‹åï¼Œå¦‚æœé—¨ç¥ç»å…ƒçš„è¾“å‡ºï¼ˆé€šè¿‡æ¿€æ´»å‡½æ•°ï¼‰éé›¶ï¼ŒPowerInfer-2å°†ç»§ç»­åŠ è½½æ†ç»‘åŒ…çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°å‡å°‘ä¸å¿…è¦çš„ I/O æ“ä½œã€‚)</p><h3 id="ç¥ç»å…ƒç°‡çº§ç®¡é“">3.4 ç¥ç»å…ƒç°‡çº§ç®¡é“</h3><p>ä¸ºäº†å‡å°‘ I/O å»¶è¿Ÿï¼ŒPowerInfer-2å¼•å…¥äº†ä¸€ç§æ–°é¢–çš„ç®¡é“æœºåˆ¶ï¼Œå¯ä»¥åŒæ—¶å¤„ç†ç¥ç»å…ƒé›†ç¾¤å’Œ I/O æ“ä½œ(å°†è®¡ç®—ä¸ I/Oæ´»åŠ¨é‡å æ¥éšè— I/O å¼€é”€)ã€‚å›¾ 3æ˜¯ä¸¤ç§ç±»å‹çš„ç®¡é“ï¼Œç»“åˆäº†çŸ©é˜µå‘é‡ä¹˜æ³•å’Œäº”ä¸ªæ ¸å¿ƒï¼ˆ4 ä¸ªè®¡ç®—æ ¸å¿ƒå’Œ 1 ä¸ª I/Oæ ¸å¿ƒï¼‰ä¸Šçš„ I/O æ“ä½œã€‚</p><figure><img src="./images/neurou-pipeline.webp#60x60"title="å›¾3: ç¥ç»å…ƒç°‡çº§ç®¡é“" alt="ç¥ç»å…ƒç°‡çº§ç®¡é“" /><figcaption aria-hidden="true">ç¥ç»å…ƒç°‡çº§ç®¡é“</figcaption></figure><ul><li><ol type="a"><li>çŸ©é˜µçº§ç®¡é“å°†ç®¡é“åˆ†æˆå­¤ç«‹çš„çŸ©é˜µå•å…ƒï¼›</li></ol></li><li><ol start="2" type="a"><li>PowerInfer-2 ä¸­çš„ç¥ç»å…ƒç°‡çº§ç®¡é“æ‰“ç ´äº†çŸ©é˜µéšœç¢ï¼Œå¹¶å°†å…¶è®¡ç®—å’Œ I/Oæ“ä½œæ··åˆåœ¨ç¥ç»å…ƒç°‡ç²’åº¦ä¸­ã€‚</li></ol></li></ul><h4 id="çŸ©é˜µçº§ç®¡é“">3.4.1 çŸ©é˜µçº§ç®¡é“</h4><p>ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯çŸ©é˜µçº§é‡å ï¼Œå®ƒå‘å‡º I/Oå‘½ä»¤ä»å­˜å‚¨ä¸­æ£€ç´¢çŸ©é˜µç¥ç»å…ƒï¼ŒåŒæ—¶å¤„ç†å†…å­˜ä¸­å·²æœ‰çš„ç¥ç»å…ƒã€‚å½“å­˜å‚¨ä¸­çš„ç¥ç»å…ƒè¢«åŠ è½½æ—¶ï¼Œå®ƒä»¬ä¼šç«‹å³è¢«å¤„ç†ã€‚è™½ç„¶è¿™ç§çŸ©é˜µçº§é‡å æ–¹æ³•å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šéšè—è®¡ç®—è¿‡ç¨‹ä¸­I/Oæ“ä½œçš„æˆæœ¬ï¼Œä½†å®ƒä»ç„¶è¦æ±‚ç³»ç»Ÿç­‰å¾…çŸ©é˜µå†…æ‰€æœ‰ç¥ç»å…ƒçš„å®Œæˆï¼ŒåŒ…æ‹¬ä»å­˜å‚¨ä¸­è·å–çš„ç¥ç»å…ƒï¼Œç„¶åå†ç»§ç»­ä¸‹ä¸€ä¸ªã€‚</p><p>å¦‚å›¾ 3-aæ‰€ç¤ºï¼Œå‡è®¾ä¸€ä¸ªçŸ©é˜µåŒ…å«8ä¸ªç¥ç»å…ƒç°‡ï¼Œå…¶ä¸­4ä¸ªä½äºå†…å­˜ä¸­ï¼Œå…¶ä½™4ä¸ªä½äºå­˜å‚¨ä¸­ã€‚ä¸€éƒ¨åˆ†I/O æ“ä½œå¯ä»¥éšè—åœ¨ç¼“å­˜çš„ç¥ç»å…ƒè®¡ç®—åé¢ã€‚ä½†ç”±äº I/O æ—¶é—´è¾ƒé•¿ï¼Œä»ç„¶å­˜åœ¨CPU å†…æ ¸å¿…é¡»ç­‰å¾… I/O å®Œæˆçš„æƒ…å†µã€‚</p><h4 id="ç¥ç»å…ƒç°‡çº§ç®¡é“-1">3.4.2 ç¥ç»å…ƒç°‡çº§ç®¡é“</h4><p>ä¸ºäº†æ¶ˆé™¤ I/O æ“ä½œçš„ç­‰å¾…æ—¶é—´ï¼ŒPowerInfer-2å¼•å…¥äº†ç¥ç»å…ƒç°‡çº§ç®¡é“æœºåˆ¶ï¼Œå¦‚å›¾3-bæ‰€ç¤ºã€‚é€šè¿‡å°†ç¥ç»å…ƒç°‡ä½œä¸ºç²’åº¦ï¼Œå¯ä»¥åœ¨æ¥è‡ªå¤šä¸ªçŸ©é˜µçš„ç¥ç»å…ƒç°‡è®¡ç®—ä¸­é‡å I/O æ“ä½œã€‚</p><p>å…·ä½“æ¥è¯´ï¼ŒPowerInfer-2æ‰“ç ´äº†çŸ©é˜µè®¡ç®—ä¹‹é—´çš„éšœç¢ï¼›ä¸€æ—¦ä¸€ä¸ªç¥ç»å…ƒç°‡å®Œæˆè®¡ç®—ï¼Œå®ƒç«‹å³å¼€å§‹è®¡ç®—å†…å­˜ä¸­ä¸‹ä¸€ä¸ªçŸ©é˜µä¸­çš„ç¥ç»å…ƒç°‡ã€‚è¯¥æœºåˆ¶æœ‰æ•ˆå‡å°‘äº†ç­‰å¾…æ°”æ³¡ã€‚</p><p>PowerInfer-2å°†ç¥ç»å…ƒç°‡çš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸º5ä¸ªè¿ç»­çš„é˜¶æ®µï¼Œåˆ›å»ºäº†å¤šä¸ªè®¡ç®—çº¿ç¨‹å’Œä¸€ä¸ªI/Oçº¿ç¨‹æ¥åˆ†åˆ«å¤„ç†è¿™5ä¸ªé˜¶æ®µçš„è®¡ç®—å’ŒI/Oæ“ä½œï¼š</p><ol type="1"><li>é€šè¿‡é¢„æµ‹å™¨(Pred)ç¡®å®šGateã€Upå’ŒDownçŸ©é˜µçš„è¡Œ/åˆ—æ˜¯å¦è¢«æ¿€æ´»;</li><li>ä»å­˜å‚¨å™¨(GIO)ä¸­è¯»å–GateçŸ©é˜µçš„è¡Œæƒå€¼;</li><li>è®¡ç®—GateçŸ©é˜µçš„è¡Œä¸è¾“å…¥å‘é‡(GC)çš„ä¹˜ç§¯;</li><li>ä»å­˜å‚¨(UDIO)ä¸­è¯»å–Upå’ŒDownçŸ©é˜µçš„è¡Œ/åˆ—;</li><li>åˆ†åˆ«è®¡ç®—Upå’ŒDownçŸ©é˜µçš„è¡Œ/åˆ—ä¸è¾“å…¥å‘é‡çš„ä¹˜ç§¯(UDC)ã€‚</li></ol><p>å›¾ 4 å±•ç¤ºäº†è®¡ç®—å’Œ I/O çº¿ç¨‹å¦‚ä½•å·¥ä½œæ¥å®ç°ç¥ç»å…ƒç°‡ç®¡é“ã€‚</p><ol type="1"><li>åœ¨æ¯ä¸ªFFNå—å¼€å§‹æ—¶ï¼Œæ‰€æœ‰ç¥ç»å…ƒæœ€åˆéƒ½å¤„äºPredé˜¶æ®µï¼Œè¢«æ’å…¥åˆ°è®¡ç®—é˜Ÿåˆ—ä¸­ã€‚</li><li>è®¡ç®—çº¿ç¨‹å¤„ç†è¿™äº›ç¥ç»å…ƒï¼Œä»…å°†é‚£äº›æ¿€æ´»çš„ç¥ç»å…ƒæ¨è¿›åˆ°åç»­é˜¶æ®µã€‚</li><li>ç„¶åè¿™äº›æ¿€æ´»çš„ç¥ç»å…ƒåˆå¹¶æˆç¥ç»å…ƒç°‡ã€‚</li><li>å¦‚æœç¥ç»å…ƒç°‡çš„ Gateæƒé‡åœ¨å†…å­˜ä¸­å¯ç”¨ï¼Œåˆ™ç¥ç»å…ƒç°‡è¿›å…¥GCé˜¶æ®µå¹¶è¿”å›åˆ°è®¡ç®—é˜Ÿåˆ—ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºGIO å¹¶ç§»è‡³ I/O é˜Ÿåˆ—ã€‚</li><li>åŒæ—¶ï¼Œè®¡ç®—çº¿ç¨‹ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªç¥ç»å…ƒç°‡ã€‚</li><li>åŒæ—¶ï¼ŒI/O çº¿ç¨‹ä» I/O é˜Ÿåˆ—ä¸­å–å‡ºç¥ç»å…ƒï¼Œæ ¹æ®éœ€è¦æ‰§è¡Œ I/O ä»»åŠ¡ã€‚</li><li>UDIO å’ŒUDC çš„æ‰§è¡Œéµå¾ªä¸GC å’ŒGIO ç±»ä¼¼çš„æ¨¡å¼ã€‚</li></ol><figure><img src="./images/neurou-pipeline-workflow.webp#70x70"title="å›¾4: ç¥ç»å…ƒç°‡çº§ç®¡é“å·¥ä½œæµ" alt="ç¥ç»å…ƒç°‡çº§ç®¡é“å·¥ä½œæµ" /><figcaption aria-hidden="true">ç¥ç»å…ƒç°‡çº§ç®¡é“å·¥ä½œæµ</figcaption></figure><h2 id="ç¦»çº¿éƒ¨åˆ†">4 ç¦»çº¿éƒ¨åˆ†</h2><p>ä¸ºäº†è‡ªåŠ¨é€‚åº”ä¸åŒçš„æ¨¡å‹æˆ–æ™ºèƒ½æ‰‹æœºï¼Œåœ¨åœ¨çº¿æ¨ç†å¼€å§‹ä¹‹å‰ï¼Œå¯¹äºæœ€åˆåœ¨æ–°æ™ºèƒ½æ‰‹æœºä¸ŠæœåŠ¡çš„æ¯ä¸ªæ¨¡å‹æ‰§è¡Œä¸€æ¬¡ç¦»çº¿è¿‡ç¨‹ã€‚æ­¤è¿‡ç¨‹æ¶‰åŠæ¥æ”¶ä¸‰ç§ç±»å‹çš„è¾“å…¥ï¼šæ¨¡å‹æƒé‡ã€ç”¨æˆ·è¾“å…¥å’Œç¡¬ä»¶è§„æ ¼ã€‚å®ƒè¾“å‡ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°åœ¨çº¿æ¨ç†ä¸­æ¶‰åŠçš„æ¯ä¸ªç»„ä»¶çš„é…ç½®å¹¶æŒ‡å¯¼åœ¨çº¿è¿‡ç¨‹ã€‚</p><h3 id="ç”Ÿæˆæ‰§è¡Œè®¡åˆ’">4.1 ç”Ÿæˆæ‰§è¡Œè®¡åˆ’</h3><p>PowerInfer-2çš„ç¦»çº¿è§„åˆ’å™¨é€šè¿‡åˆ†ææ¨¡å‹æƒé‡ã€ç”¨æˆ·è¾“å…¥å’Œç¡¬ä»¶è§„æ ¼æ¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œè¾“å‡ºè®¡ç®—ã€å†…å­˜å’ŒI/O çš„é…ç½®ã€‚</p><ol type="1"><li>è¾“å…¥é…ç½®ï¼š<ul><li>ç¡¬ä»¶ï¼šç¡¬ä»¶é…ç½®çš„å‚æ•°ï¼Œå¦‚CPU FLOPSã€I/Oååé‡å’Œå†…å­˜å¸¦å®½ã€‚</li><li>ç”¨æˆ·ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„å‚æ•°ï¼Œå¦‚CPUçº¦æŸã€å†…å­˜é™åˆ¶ã€è¯‘ç é€Ÿåº¦ä¸‹ç•Œç­‰ã€‚</li><li>Modelï¼šç¦»çº¿åˆ†æå™¨æ”¶é›†çš„å…³äºæ¨¡å‹çš„å‚æ•°ï¼Œä¾‹å¦‚æ¨¡å‹çš„å¤§å°ã€ç¨€ç–åº¦çº§åˆ«å’Œç¼“å­˜ç‰¹å¾ç­‰ã€‚</li></ul></li><li>è¾“å‡ºé…ç½®ï¼š<ul><li>è®¡ç®—ï¼šæ ¹æ®CPUå’ŒNPUçš„è®¡ç®—å¼ºåº¦ç¡®å®šä¸åŒé˜¶æ®µæˆ–å±‚ä¸­CPUå’ŒNPUçš„ä½¿ç”¨æ¯”ä¾‹ã€‚</li><li>å†…å­˜ï¼šä¸ºäº†å®ç°å†…å­˜ä½¿ç”¨å’Œæ¨ç†æ€§èƒ½ä¹‹é—´çš„å¹³è¡¡ï¼Œè§„åˆ’å™¨å…è®¸ç”¨æˆ·åœ¨è¿è¡ŒPowerInfer-2 ä¹‹å‰è®¾ç½®æ‰€éœ€çš„æ¨ç†é€Ÿåº¦ã€‚æ ¹æ®è®¾ç½®çš„é€Ÿåº¦ï¼ŒPowerInfer-2è®¡ç®—æ‰€éœ€çš„æœ€ä½³ç¼“å­˜å¤§å°ã€‚</li><li>I/Oï¼šè§„åˆ’å™¨è§¦å‘åˆ†æå™¨æ¥æµ‹é‡æ¨¡å‹çš„ç¨€ç–æ€§ä»¥åŠå†·çƒ­ç¥ç»å…ƒçš„åˆ†å¸ƒã€‚</li></ul></li></ol><h2 id="é™„å½•">é™„å½•</h2><h3 id="llm-in-a-flash">LLM in a flash</h3><p>å°†æ¨¡å‹å‚æ•°å­˜å‚¨åœ¨é—ªå­˜ä¸­ï¼Œä½†å°†å…¶æŒ‰éœ€å¸¦å…¥DRAMï¼Œè§£å†³è¶…è¿‡DRAMå¯ç”¨å®¹é‡çš„llmçš„æŒ‘æˆ˜ã€‚</p><ol type="1"><li>å‡å°‘æ•°æ®åŠ è½½é‡<ol type="1"><li>æœ‰é€‰æ‹©æ€§åœ°æŠŠéƒ¨åˆ†å‚æ•°å¸¸é©»åœ¨DRAMä¸­ã€‚è€Œè¿™éƒ¨åˆ†å¸¸é©»çš„å‚æ•°å°±æ˜¯Attentionå‚æ•°å’ŒEmbeddingå‚æ•°ï¼ŒåŸå› æ˜¯å› ä¸ºå®ƒä»¬å æ¯”è¾ƒå°ã€‚</li><li>å€Ÿé‰´äº†DejaVuã€‚æ¯æ¬¡åœ¨æ¨ç†æ—¶åŠ¨æ€åŠ è½½MLPé¢„æµ‹ä¸ºæ¿€æ´»ç¥ç»å…ƒå¯¹åº”çš„å‚æ•°ã€‚</li><li>æ»‘åŠ¨çª—å£ã€‚ä¿ç•™å¤„ç†è¿‡å»kä¸ªtokenæ—¶çš„æ¿€æ´»ç¥ç»å…ƒæ‰€å¯¹åº”çš„å‚æ•°åœ¨DRAMä¸­ï¼Œå¹¶åœ¨å¤„ç†å½“å‰tokenæ—¶åªå¯¹ï¼š1ï¼‰éƒ¨åˆ†å¤šä½™çš„å‚æ•°è¿›è¡Œåˆ é™¤ï¼›2ï¼‰ç¼ºå°‘çš„å‚æ•°è¿›è¡ŒåŠ è½½ã€‚</li></ol></li><li>æé«˜ä¼ è¾“æ•°æ®é‡(è¯»å–å¤§å—æ•°æ®) æœªæ¥æ”¹è¿›:æŠŠå‘ä¸ŠæŠ•å½±çš„ç¬¬iåˆ—å’Œå‘ä¸‹æŠ•å½±çš„ç¬¬iè¡Œæ†ç»‘å­˜å‚¨ã€‚å½“æ¿€æ´»ç¬¬iä¸ªä¸­é—´ç¥ç»å…ƒæ—¶ï¼Œè¿™ä¸¤éƒ¨åˆ†æ•°æ®ä¼šåŒæ—¶è¢«ä½¿ç”¨ã€‚é€šè¿‡åœ¨é—ªå­˜ä¸­å°†è¿™äº›å¯¹åº”çš„åˆ—å’Œè¡Œä¸€èµ·å­˜å‚¨ï¼Œå¯ä»¥å°†æ•°æ®æ•´åˆæˆæ›´å¤§çš„å—è¿›è¡Œè¯»å–ã€‚</li></ol><p>åŸæ–‡é“¾æ¥: <a href="https://arxiv.org/abs/2312.11514">LLM in a flash:Efficient Large Language Model Inference with Limited Memory</a> <ahref="https://zhuanlan.zhihu.com/p/673775476">å‚è€ƒ</a> <ahref="https://zhuanlan.zhihu.com/p/673572594">ç¿»è¯‘</a></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LLMæ¨¡å‹ä¹‹Turbo Sparse</title>
      <link href="/2024/08/08/NLP/LLMModels/PowerInfer/TurboSparse/"/>
      <url>/2024/08/08/NLP/LLMModels/PowerInfer/TurboSparse/</url>
      
        <content type="html"><![CDATA[<h1 id="turbo-sparse">Turbo Sparse</h1><p>é€šè¿‡æœ€å°‘çš„æ¿€æ´»å‚æ•°å®ç° LLM çš„æœ€å…ˆè¿›æ€§èƒ½ åŸæ–‡é“¾æ¥ï¼š<ahref="https://arxiv.org/abs/2406.05955">Turbo Sparse: Achieving LLM SOTAPerformance with Minimal Activated Parameters</a></p><h2 id="ç®€ä»‹">1. ç®€ä»‹</h2><p>æå‡ºäº†ä¸€ç§æ–°çš„åŸºäºdreluçš„ç¨€ç–åŒ–æ–¹æ³•ï¼Œåœ¨ä¿æŒæ€§èƒ½çš„åŒæ—¶ï¼Œå°†æ¨¡å‹ç¨€ç–æ€§æé«˜åˆ°90%ï¼Œåœ¨æ¨ç†ä¸­å®ç°äº†2-5å€çš„åŠ é€Ÿã€‚</p><h3 id="æ€§èƒ½æå‡">1.1 æ€§èƒ½æå‡</h3><p>é€šè¿‡å°†æˆ‘ä»¬çš„ç¥ç»å…ƒç¨€ç–åŒ–æ–¹æ³•åº”ç”¨äºMistralå’ŒMixtralæ¨¡å‹ï¼Œæ¯æ¬¡æ¨ç†è¿­ä»£åˆ†åˆ«åªæœ‰25äº¿ä¸ªå’Œ43äº¿ä¸ªå‚æ•°è¢«æ¿€æ´»ï¼ŒåŒæ—¶å®ç°äº†æ›´å¼ºå¤§çš„æ¨¡å‹æ€§èƒ½ã€‚è¯„ä¼°ç»“æœè¡¨æ˜ï¼Œè¿™ç§ç¨€ç–æ€§å®ç°äº†2-5å€çš„è§£ç åŠ é€Ÿã€‚åœ¨æ‰‹æœºä¸Šï¼Œæˆ‘ä»¬çš„<ahref="https://huggingface.co/PowerInfer">TurboSparse-Mixtral-47B</a>å®ç°äº†11tokens/sçš„æ¨ç†é€Ÿåº¦ã€‚</p><h2 id="æ¦‚è¿°">2 æ¦‚è¿°</h2><h3 id="èƒŒæ™¯">2.1 èƒŒæ™¯</h3><p>ä¸ºäº†è§£å†³ç°æœ‰å¯†é›†æ¨¡å‹å›ºæœ‰çš„æ•ˆç‡é—®é¢˜ï¼Œæ¡ä»¶è®¡ç®—å·²ç»æˆä¸ºä¸€ç§å…³é”®æ–¹æ³•ï¼Œå®ƒæŒ‡çš„æ˜¯æ¿€æ´»ç½‘ç»œä¸­çš„éƒ¨åˆ†ç¥ç»å…ƒã€‚</p><ol type="1"><li>æ··åˆä¸“å®¶(MoE):é€šè¿‡åœ¨è®­ç»ƒå‰æ‰‹åŠ¨è®¾ç½®æ¨¡å‹æ¶æ„ä¸Šçš„çº¦æŸæ¥å¼•å…¥æ¡ä»¶è®¡ç®—ï¼Œä¾‹å¦‚ç¡®å®šè¦æ¿€æ´»çš„ä¸“å®¶æ•°é‡ã€‚è¿™ç§æŠ€æœ¯é€šè¿‡ä¸€ä¸ªç§°ä¸ºä¸“å®¶è·¯ç”±çš„è¿‡ç¨‹ï¼Œé€‰æ‹©æ€§åœ°æ¿€æ´»æ¨¡å‹çš„ç‰¹å®šéƒ¨åˆ†ï¼Œä»¥å“åº”ç‰¹å®šçš„è¾“å…¥ï¼Œä»è€Œæ˜¾è‘—æé«˜æ•ˆç‡ï¼›</li><li>åˆ©ç”¨ReLUæ¿€æ´»å‡½æ•°è‡ªç„¶äº§ç”Ÿçš„ç¨€ç–æ¿€æ´»ï¼Œå®ƒè‡ªç„¶åœ°è¾“å‡ºé›¶å…ƒç´ ï¼›</li><li>é—¨æ§ MLPå—ã€‚åœ¨è¿™ç§å—ä¸­ï¼Œæ¿€æ´»å‡½æ•°çš„è¾“å‡ºè¢«é—¨æ§ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡è¿­ä»£ä¸­åªæ¿€æ´»ä¸€éƒ¨åˆ†ç¥ç»å…ƒã€‚</li></ol><p>ReLUization æ˜¯ä¸€ç§ç°æœ‰çš„æœ€å…ˆè¿›çš„æ–¹æ³•ï¼Œç”¨ ReLUæ›¿æ¢åŸå§‹æ¿€æ´»å‡½æ•°å¹¶ç»§ç»­é¢„è®­ç»ƒã€‚å°½ç®¡è¿™ç§æ–¹æ³•å…·æœ‰æ½œåŠ›ï¼Œä½†å¾€å¾€éš¾ä»¥è¾¾åˆ°æ‰€éœ€çš„æ¿€æ´»ç¨€ç–åº¦æ°´å¹³ï¼Œå¹¶å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p><p>æˆ‘ä»¬è®¤ä¸ºç°æœ‰ ReLUification æ–¹æ³•çš„å¤±è´¥å¯å½’å› äºä¸¤ä¸ªä¸»è¦åŸå› ã€‚</p><ul><li>é¦–å…ˆï¼Œç®€å•åœ°ç”¨ ReGLU æ›¿æ¢ SwiGLU æ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºå®ƒåªå°†ç¨€ç–æ€§ä» 40%å¢åŠ åˆ°å¤§çº¦70%ã€‚è¿™è¡¨æ˜æœ‰å¿…è¦å¯¹æ¨¡å‹æ¶æ„è¿›è¡Œæ›´æ·±å…¥çš„ç ”ç©¶ï¼Œä»¥å®ç°æ›´é«˜æ°´å¹³çš„ç¨€ç–æ€§ã€‚</li><li>å…¶æ¬¡ï¼Œé¢„è®­ç»ƒæ•°æ®çš„å¤šæ ·æ€§æœ‰é™ï¼Œå½“å‰æ–¹æ³•ä¸­è®­ç»ƒtokensæ•°é‡ä¸è¶³å¯¼è‡´èƒ½åŠ›æ¢å¤ä¸å®Œæ•´ã€‚å› æ­¤ï¼Œæ‰©å¤§é¢„è®­ç»ƒæ•°æ®é›†çš„å¤šæ ·æ€§å¹¶å¢åŠ è®­ç»ƒtokensçš„æ•°é‡æ˜¯æé«˜æ¨¡å‹æ€§èƒ½çš„å…³é”®æ­¥éª¤ã€‚</li></ul><h3 id="åˆ›æ–°">2.2 åˆ›æ–°</h3><p>ä¸ºäº†åº”å¯¹è¿™äº›æŒ‘æˆ˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹ç°æœ‰çš„ ReLUficationæ–¹æ³•è¿›è¡Œäº†ç»¼åˆåˆ†æï¼Œå¹¶ç¡®å®šå…¶ç¼ºç‚¹æºäº GLU ç»„ä»¶ä¸­çš„è´Ÿæ¿€æ´»ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªåä¸º dReLU çš„æœ‰æ•ˆæ¿€æ´»å‡½æ•°ã€‚</p><ol type="1"><li>é«˜æ•ˆçš„dReLUæ¿€æ´»å‡½æ•°:ä½¿ç”¨ä¸åˆ°150Bä¸ªtokensï¼Œä¸åˆ°å…¸å‹é¢„è®­ç»ƒtokens(é€šå¸¸ä¸º15T tokens)çš„1%ã€‚</li><li>ç¨€ç–æ¿€æ´»æ¨¡å‹:ä¸¤ç§ç¨€ç–æ¿€æ´»TurboSparse-Mistral7Bå’ŒTurboSparse-Mixtral-47Bæ¨¡å‹éƒ½æ¯”åŸå§‹ç‰ˆæœ¬è¡¨ç°å‡ºæ›´å¥½çš„æ€§èƒ½ã€‚</li><li>å®é™…æ¨ç†åŠ é€Ÿ:å¯ä»¥å®ç°2-5å€çš„åŠ é€Ÿã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿åœ¨TurboSparse-Mixtral-47Bä¸Šæ²¡æœ‰GPUï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°é«˜è¾¾10tokens/sçš„é€Ÿåº¦ã€‚</li></ol><h2 id="drelu">3 dReLU</h2><h3 id="æ ¸å¿ƒ">3.1 æ ¸å¿ƒ</h3><ul><li><strong>ç¬¬ä¸€ç§æ”¹è¿›</strong> å°† ReLU åŒ–è¿‡ç¨‹ä¸­çš„åŸå§‹åŸºäº SwiGLUçš„å‰é¦ˆç½‘ç»œï¼ˆFFNï¼‰æ›¿æ¢ä¸ºåŸºäº dReLU çš„å‰é¦ˆç½‘ç»œï¼ˆFFNï¼‰ã€‚</li><li><strong>ç¬¬äºŒç§æ”¹è¿›</strong>æ˜¯åœ¨ç¬¬ä¸€ç§æ”¹è¿›çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ç¨€ç–æœºåˆ¶è¿›ä¸€æ­¥ä¼˜åŒ–æ¨¡å‹æ€§èƒ½ï¼Œé€šè¿‡æ§åˆ¶ç¨€ç–æ°´å¹³æ¥è°ƒæ•´æ¨¡å‹çš„æ¿€æ´»å€¼ã€‚</li></ul><figure><img src="./images/architecture.webp#80x80"title="å›¾1: dReLU Sparsification" alt="dReLU Sparsification" /><figcaption aria-hidden="true">dReLU Sparsification</figcaption></figure><h3 id="drelu-æ¿€æ´»å‡½æ•°">3.2 dReLU æ¿€æ´»å‡½æ•°</h3><p>å¸¸ç”¨çš„ <span class="math inline">\(Gated-MLP\)</span>å—ç”±ä¸‰ä¸ªå…¨è¿æ¥å±‚ç»„æˆï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[\begin{aligned}\text{Gate}(x) &amp;\coloneqq F_{act} (x W_{gate}) \\\text{Up}(x) &amp;\coloneqq x W_{up} \\\text{Combined}(x) &amp;\coloneqq \text{Gate}(x) * \text{Up}(x) \\\text{Gated-MLP}(x) &amp;\coloneqq \text{Combined}(x) W_{down}\end{aligned}\]</span></p><p>å…¶ä¸­ <span class="math inline">\(F_{act}\)</span>ä»£è¡¨ä¸åŒçš„æ¿€æ´»å‡½æ•°ï¼Œ<span class="math inline">\(W_{gate}\)</span>ã€<spanclass="math inline">\(W_{up}\)</span> å’Œ <spanclass="math inline">\(W_{down}\)</span> æ˜¯æƒé‡çŸ©é˜µã€‚</p><h4 id="ä½¿ç”¨-drelu-æ¿€æ´»å‡½æ•°">3.2.1 ä½¿ç”¨ dReLU æ¿€æ´»å‡½æ•°</h4><p>å¼•å…¥äº†ä¸€ç§æ–°çš„æ¿€æ´»å‡½æ•° <spanclass="math inline">\(dReLU\)</span>ï¼š</p><p><span class="math display">\[\begin{aligned}\text{Combined}_{\text{dReLU}}(x) &amp;\coloneqq \max(0, x W_{gate}) *\max(0, x W_{up})\end{aligned}\]</span></p><p>å› æ­¤ç»“åˆåŸæœ¬çš„ <span class="math inline">\(Gated-MLP\)</span>å—ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ° <span class="math inline">\(Gated-MLP\)</span> å—çš„<span class="math inline">\(dReLU\)</span> ç‰ˆæœ¬ï¼š</p><ol type="1"><li>ä½¿ç”¨ ((0, x W_{gate})) è®¡ç®—é—¨æ§æ¿€æ´»ï¼ˆGateï¼‰ã€‚</li><li>ä½¿ç”¨ ((0, x W_{up})) è®¡ç®—å‘ä¸ŠæŠ•å½±ï¼ˆUpï¼‰ã€‚</li><li>å°†ä¸Šè¿°ä¸¤æ­¥ç»“æœç›¸ä¹˜ä»¥è·å¾— Combinedã€‚</li><li>æœ€åï¼Œå°† Combined é€šè¿‡ä¸‹æŠ•å½±çŸ©é˜µ (W_{down}) ç”Ÿæˆæœ€ç»ˆè¾“å‡ºã€‚</li></ol><p><span class="math display">\[\begin{aligned}\text{Gate}(x) &amp;\coloneqq \max(0, x W_{gate}) \\\text{Up}(x) &amp;\coloneqq \max(0, x W_{up}) \\\text{Combined}_{\text{dReLU}}(x) &amp;\coloneqq \text{Gate}(x) *\text{Up}(x) \\\text{Gated-MLP}(x) &amp;\coloneqq \text{Combined}_{\text{dReLU}}(x)W_{down}\end{aligned}\]</span></p><h4 id="å¼•å…¥ç¨€ç–æ€§æœºåˆ¶">3.2.2 å¼•å…¥ç¨€ç–æ€§æœºåˆ¶</h4><p>åœ¨ä¸Šè¿° dReLU æ¿€æ´»å‡½æ•°çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥ç¨€ç–æ€§æœºåˆ¶ï¼Œé€šè¿‡é€‰æ‹©å‰ k%çš„æ¿€æ´»å€¼ï¼Œæ¥æ§åˆ¶æ¨¡å‹çš„ç¨€ç–æ°´å¹³(åœ¨å…¬å¼ 3 çš„åŸºç¡€ä¸ŠåŠ å…¥ä»¥ä¸‹):</p><ol type="1"><li>è®¡ç®— Combined å¹¶ç”Ÿæˆå…¶ç»å¯¹å€¼çš„å‰ k% çš„æ©ç ï¼ˆMaskï¼‰ã€‚</li><li>å°† Combined ä¹˜ä»¥ Maskï¼Œä»¥ä¿ç•™ä»…å‰ k% çš„æ¿€æ´»å€¼ã€‚</li><li>å°†å¤„ç†åçš„ Combined é€šè¿‡ä¸‹æŠ•å½±çŸ©é˜µ (W_{down}) ç”Ÿæˆæœ€ç»ˆè¾“å‡ºã€‚</li></ol><p><span class="math display">\[\begin{aligned}\text{Mask}(x) &amp;\coloneqq \text{Top}_k(|\text{Combined}(x)|)\end{aligned}\]</span></p><p><span class="math display">\[\begin{aligned}\text{Gated-MLP}(x) &amp;\coloneqq (\text{Combined}(x) * \text{Mask}(x))W_{down}\end{aligned}\]</span></p><h3 id="pytorch-å®ç°å¤§æ¦‚">3.3 PyTorch å®ç°(å¤§æ¦‚)</h3><h4 id="drelu-æ¿€æ´»å‡½æ•°-1">3.3.1 dReLU æ¿€æ´»å‡½æ•°</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">dReLU</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">GatedMLP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> output_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>GatedMLP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>W_gate <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>W_up <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>W_down <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> output_dim<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>drelu <span class="token operator">=</span> dReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        gate <span class="token operator">=</span> self<span class="token punctuation">.</span>drelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>W_gate<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        up <span class="token operator">=</span> self<span class="token punctuation">.</span>drelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>W_up<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        combined <span class="token operator">=</span> gate <span class="token operator">*</span> up        out <span class="token operator">=</span> self<span class="token punctuation">.</span>W_down<span class="token punctuation">(</span>combined<span class="token punctuation">)</span>        <span class="token keyword">return</span> out</code></pre><h4 id="å¼•å…¥ç¨€ç–æ€§æœºåˆ¶-1">3.3.2 å¼•å…¥ç¨€ç–æ€§æœºåˆ¶</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">dReLU</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">SparseGatedMLP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> output_dim<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>SparseGatedMLP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>W_gate <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>W_up <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>W_down <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> output_dim<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>drelu <span class="token operator">=</span> dReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>k <span class="token operator">=</span> k  <span class="token comment"># ç¨€ç–æ°´å¹³</span>        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        gate <span class="token operator">=</span> self<span class="token punctuation">.</span>drelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>W_gate<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        up <span class="token operator">=</span> self<span class="token punctuation">.</span>drelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>W_up<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        combined <span class="token operator">=</span> gate <span class="token operator">*</span> up                <span class="token comment"># åœ¨ Combined ä¸­ä¿ç•™å‰ k% çš„æ¿€æ´»å€¼</span>        abs_combined <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>combined<span class="token punctuation">)</span>        top_k_values<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>abs_combined<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>k <span class="token operator">*</span> combined<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        min_top_k <span class="token operator">=</span> top_k_values<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>abs_combined<span class="token punctuation">)</span>        mask <span class="token operator">=</span> abs_combined <span class="token operator">>=</span> min_top_k        masked_combined <span class="token operator">=</span> combined <span class="token operator">*</span> mask<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                out <span class="token operator">=</span> self<span class="token punctuation">.</span>W_down<span class="token punctuation">(</span>masked_combined<span class="token punctuation">)</span>        <span class="token keyword">return</span> out</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªç„¶è¯­è¨€å¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>A100 vs V100</title>
      <link href="/2024/07/05/TechnicalNotes/Devices/"/>
      <url>/2024/07/05/TechnicalNotes/Devices/</url>
      
        <content type="html"><![CDATA[<h2 id="a100-vs-v100">A100 vs V100</h2><table><colgroup><col style="width: 26%" /><col style="width: 36%" /><col style="width: 36%" /></colgroup><thead><tr><th style="text-align: center;">ç‰¹æ€§</th><th style="text-align: center;">A100</th><th style="text-align: center;">V100</th></tr></thead><tbody><tr><td style="text-align: center;">æ¶æ„</td><td style="text-align: center;">Ampere (GA100)</td><td style="text-align: center;">Volta (GV100)</td></tr><tr><td style="text-align: center;">CUDAæ ¸å¿ƒæ•°é‡</td><td style="text-align: center;">6,912</td><td style="text-align: center;">5,120</td></tr><tr><td style="text-align: center;">SMæ•°é‡</td><td style="text-align: center;">108</td><td style="text-align: center;">80</td></tr><tr><td style="text-align: center;">å¼ é‡æ ¸å¿ƒæ•°é‡</td><td style="text-align: center;">640</td><td style="text-align: center;">640</td></tr><tr><td style="text-align: center;">å¼ é‡æ ¸å¿ƒç²¾åº¦æ”¯æŒ</td><td style="text-align: center;">FP64, TF32, FP16, BF16, INT8, INT4</td><td style="text-align: center;">FP32, FP16</td></tr><tr><td style="text-align: center;">å¼ é‡æ ¸å¿ƒæ€§èƒ½</td><td style="text-align: center;"></td><td style="text-align: center;"></td></tr><tr><td style="text-align: center;">æ˜¾å­˜å®¹é‡</td><td style="text-align: center;">40GB / 80GB HBM2e</td><td style="text-align: center;">16GB / 32GB HBM2</td></tr><tr><td style="text-align: center;">æ˜¾å­˜å¸¦å®½</td><td style="text-align: center;">1555 GB/s</td><td style="text-align: center;">900 GB/s</td></tr><tr><td style="text-align: center;">NVLinkå¸¦å®½</td><td style="text-align: center;">600 GB/s</td><td style="text-align: center;">300 GB/s</td></tr><tr><td style="text-align: center;">PCIeæ”¯æŒ</td><td style="text-align: center;">PCIe 4.0</td><td style="text-align: center;">PCIe 3.0</td></tr><tr><td style="text-align: center;">åŠŸè€— (TDP)</td><td style="text-align: center;">400W</td><td style="text-align: center;">300W</td></tr><tr><td style="text-align: center;">å¤šå®ä¾‹GPU (MIG)</td><td style="text-align: center;">æ”¯æŒ</td><td style="text-align: center;">ä¸æ”¯æŒ</td></tr><tr><td style="text-align: center;">ç¨€ç–æ€§åŠ é€Ÿ</td><td style="text-align: center;">æ”¯æŒ(<span class="math inline">\(\approx2 \times V100\)</span>)</td><td style="text-align: center;">ä¸æ”¯æŒ</td></tr></tbody></table><h3 id="æ¶æ„">æ¶æ„</h3><p>A100å¼•å…¥äº†<strong>TensorFloat-32 (TF32) TensorCore</strong>ä»¥åŠ<strong>ç»“æ„åŒ–ç¨€ç–åŠŸèƒ½</strong>ï¼š</p><ul><li>è¿è¡Œé€Ÿåº¦æ¯” V100 FP32 FMA æ“ä½œå¿« 10 å€(ç¨€ç–æ€§å¿« 20 å€)</li><li>FP16/FP32 æ··åˆç²¾åº¦ï¼ŒA100 Tensor Core çš„æ€§èƒ½æ˜¯ V100 çš„ 2.5å€(ç¨€ç–æ€§åˆ™æé«˜åˆ° 5 å€)</li></ul>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>IDEç¼“å­˜æ¸…ç†</title>
      <link href="/2024/07/01/TechnicalNotes/IDECacheClear/"/>
      <url>/2024/07/01/TechnicalNotes/IDECacheClear/</url>
      
        <content type="html"><![CDATA[<h2 id="ideç¼“å­˜æ¸…ç†">IDEç¼“å­˜æ¸…ç†</h2><h3 id="visual-studio">Visual Studio</h3><table><colgroup><col style="width: 33%" /><col style="width: 33%" /><col style="width: 33%" /></colgroup><thead><tr><th>ç¼“å­˜ç±»å‹</th><th>è·¯å¾„</th><th>æ¸…ç†æ–¹æ³•</th></tr></thead><tbody><tr><td>NuGetåŒ…ç¼“å­˜</td><td><code>%UserProfile%\.nuget</code></td><td>æ‰§è¡Œ<code>dotnet nuget locals all --clear</code>å‘½ä»¤</td></tr></tbody></table><h3 id="visual-studio-code">Visual Studio Code</h3><table><colgroup><col style="width: 33%" /><col style="width: 33%" /><col style="width: 33%" /></colgroup><thead><tr><th>ç¼“å­˜ç±»å‹</th><th>è·¯å¾„</th><th>æ¸…ç†æ–¹æ³•</th></tr></thead><tbody><tr><td>æ‰©å±•ç¼“å­˜</td><td><code>%UserProfile%\.vscode\extensions</code></td><td>åˆ é™¤<code>.vscode\extensions</code>æ–‡ä»¶å¤¹</td></tr></tbody></table><h3 id="android-studio">Android Studio</h3><table><thead><tr><th>ç¼“å­˜ç±»å‹</th><th>è·¯å¾„</th><th>æ¸…ç†æ–¹æ³•</th></tr></thead><tbody><tr><td>Gradleç¼“å­˜</td><td><code>%UserProfile%\.gradle</code></td><td>åˆ é™¤<code>.gradle</code>æ–‡ä»¶å¤¹</td></tr><tr><td>Android SDKç¼“å­˜</td><td><code>%UserProfile%\.android</code></td><td>åˆ é™¤<code>.android</code>æ–‡ä»¶å¤¹</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 10 æ³¨æ„åŠ›æœºåˆ¶</title>
      <link href="/2024/06/30/DL/10%20%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6/"/>
      <url>/2024/06/30/DL/10%20%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="æ³¨æ„åŠ›æœºåˆ¶">10 æ³¨æ„åŠ›æœºåˆ¶</h2><h3 id="æ³¨æ„åŠ›æç¤º">10.1 æ³¨æ„åŠ›æç¤º</h3><p>è‡ªä¸»æ€§çš„ä¸éè‡ªä¸»æ€§çš„æ³¨æ„åŠ›æç¤ºè§£é‡Šäº†äººç±»çš„æ³¨æ„åŠ›çš„æ–¹å¼ï¼ŒæŸ¥è¯¢ï¼ˆè‡ªä¸»æç¤ºï¼‰å’Œé”®ï¼ˆéè‡ªä¸»æç¤ºï¼‰ä¹‹é—´çš„äº¤äº’å½¢æˆäº†æ³¨æ„åŠ›æ±‡èšï¼›æ³¨æ„åŠ›æ±‡èšæœ‰é€‰æ‹©åœ°èšåˆäº†å€¼ï¼ˆæ„Ÿå®˜è¾“å…¥ï¼‰ä»¥ç”Ÿæˆæœ€ç»ˆçš„è¾“å‡ºã€‚ä¸‹é¢æ˜¯é€šè¿‡è¿™ä¸¤ç§æ³¨æ„åŠ›æç¤ºç”¨ç¥ç»ç½‘ç»œæ¥è®¾è®¡æ³¨æ„åŠ›æœºåˆ¶çš„æ¡†æ¶:</p><figure><img src="./images/10.1_attention.svg"title="å›¾10.1ï¼šæ³¨æ„åŠ›æœºåˆ¶é€šè¿‡æ³¨æ„åŠ›æ±‡èšå°†æŸ¥è¯¢ï¼ˆè‡ªä¸»æ€§æç¤ºï¼‰å’Œé”®ï¼ˆéè‡ªä¸»æ€§æç¤ºï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼Œå®ç°å¯¹å€¼ï¼ˆæ„Ÿå®˜è¾“å…¥ï¼‰çš„é€‰æ‹©å€¾å‘"alt="æŸ¥è¯¢ã€é”®å’Œå€¼" /><figcaption aria-hidden="true">æŸ¥è¯¢ã€é”®å’Œå€¼</figcaption></figure><h3 id="æ³¨æ„åŠ›æ±‡èšnadaraya-watson-æ ¸å›å½’">10.2æ³¨æ„åŠ›æ±‡èšï¼šNadaraya-Watson æ ¸å›å½’</h3><h4 id="ç”Ÿæˆæ•°æ®é›†">10.2.1 ç”Ÿæˆæ•°æ®é›†</h4><p><span class="math display">\[y_i = 2\sin(x_i) + x_i^{0.8} + \epsilon\tag{10.1}\]</span></p><pre class="language-python" data-language="python"><code class="language-python">n_train <span class="token operator">=</span> <span class="token number">50</span>  <span class="token comment"># è®­ç»ƒæ ·æœ¬æ•°</span>x_train<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>n_train<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment"># æ’åºåçš„è®­ç»ƒæ ·æœ¬</span><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token operator">**</span><span class="token number">0.8</span>y_train <span class="token operator">=</span> f<span class="token punctuation">(</span>x_train<span class="token punctuation">)</span> <span class="token operator">+</span> torch<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n_train<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># è®­ç»ƒæ ·æœ¬çš„è¾“å‡º</span>x_test <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>  <span class="token comment"># æµ‹è¯•æ ·æœ¬</span>y_truth <span class="token operator">=</span> f<span class="token punctuation">(</span>x_test<span class="token punctuation">)</span>  <span class="token comment"># æµ‹è¯•æ ·æœ¬çš„çœŸå®è¾“å‡º</span>n_test <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x_test<span class="token punctuation">)</span>  <span class="token comment"># æµ‹è¯•æ ·æœ¬æ•°</span><span class="token comment"># ç»˜åˆ¶è®­ç»ƒæ•°æ® çœŸå®å€¼ æµ‹è¯•ç»“æœ</span><span class="token keyword">def</span> <span class="token function">plot_kernel_reg</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">)</span><span class="token punctuation">:</span>    d2l<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> <span class="token punctuation">[</span>y_truth<span class="token punctuation">,</span> y_hat<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Truth'</span><span class="token punctuation">,</span> <span class="token string">'Pred'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    d2l<span class="token punctuation">.</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="å¹³å‡æ±‡èš">10.2.2 å¹³å‡æ±‡èš</h4>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 8 å¾ªç¯ç¥ç»ç½‘ç»œ</title>
      <link href="/2024/06/30/DL/8%20%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
      <url>/2024/06/30/DL/8%20%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="å¾ªç¯ç¥ç»ç½‘ç»œ">8 å¾ªç¯ç¥ç»ç½‘ç»œ</h2><h3 id="åºåˆ—æ¨¡å‹">8.1 åºåˆ—æ¨¡å‹</h3><p><strong>è‡ªå›å½’æ¨¡å‹AR</strong>:è‡ªå›å½’æ¨¡å‹æ˜¯æ—¶é—´åºåˆ—æ¨¡å‹çš„ä¸€ç§ï¼Œå®ƒå‡è®¾å½“å‰æ—¶é—´ç‚¹çš„å€¼æ˜¯ä¹‹å‰è‹¥å¹²æ—¶é—´ç‚¹å€¼çš„çº¿æ€§ç»„åˆã€‚ç®€å•æ¥è¯´ï¼ŒARæ¨¡å‹æ ¹æ®è¿‡å»çš„è§‚å¯Ÿå€¼æ¥é¢„æµ‹æœªæ¥çš„å€¼ã€‚</p><p><span class="math display">\[\begin{aligned}X_t &amp;= c + \sum_{i=1}^{p} \phi_i X_{t-i} + \epsilon_t \\\text{å…¶ä¸­} &amp; \\X_t &amp;\text{ æ˜¯æ—¶é—´åºåˆ—åœ¨æ—¶é—´ } t \text{ çš„å€¼} \\c &amp;\text{ æ˜¯ä¸€ä¸ªå¸¸æ•°é¡¹} \\\phi_i &amp;\text{ æ˜¯è‡ªå›å½’ç³»æ•°} \\p &amp;\text{ æ˜¯æ¨¡å‹çš„é˜¶æ•°ï¼Œå³ä½¿ç”¨å¤šå°‘ä¸ªè¿‡å»çš„æ—¶é—´ç‚¹æ¥é¢„æµ‹å½“å‰å€¼} \\\epsilon_t &amp;\text{ æ˜¯è¯¯å·®é¡¹ï¼Œé€šå¸¸å‡è®¾ä¸ºç™½å™ªå£°}\end{aligned}\tag{8.1}\]</span></p><p><strong>éšå˜é‡è‡ªå›å½’æ¨¡å‹LV-AR</strong>:éšå˜é‡è‡ªå›å½’æ¨¡å‹æ˜¯åœ¨è‡ªå›å½’æ¨¡å‹çš„åŸºç¡€ä¸Šå¼•å…¥äº†éšå˜é‡ã€‚éšå˜é‡æ˜¯æŒ‡é‚£äº›ä¸èƒ½ç›´æ¥è§‚å¯Ÿåˆ°ï¼Œä½†å¯ä»¥é€šè¿‡å…¶ä»–è§‚å¯Ÿå˜é‡é—´æ¥æ¨æ–­å‡ºæ¥çš„å˜é‡ã€‚LVARæ¨¡å‹çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œè§‚å¯Ÿåˆ°çš„æ—¶é—´åºåˆ—æ˜¯ç”±ä¸€äº›éšè—çš„åŠ¨æ€è¿‡ç¨‹é©±åŠ¨çš„ã€‚åŒ…å«äº†è§‚æµ‹æ–¹ç¨‹å’ŒçŠ¶æ€æ–¹ç¨‹ä¸¤éƒ¨åˆ†ï¼š</p><p><span class="math display">\[\begin{aligned}&amp; \textbf{è§‚æµ‹æ–¹ç¨‹} \\Y_t &amp;= \Lambda X_t + \epsilon_t \\\text{å…¶ä¸­} &amp; \\Y_t &amp;\text{ æ˜¯åœ¨æ—¶é—´ } t \text{ è§‚æµ‹åˆ°çš„å˜é‡} \\\Lambda &amp;\text{ æ˜¯éšå˜é‡ä¸è§‚æµ‹å˜é‡ä¹‹é—´çš„å…³ç³»çŸ©é˜µ} \\X_t &amp;\text{ æ˜¯æ—¶é—´ } t \text{ çš„éšå˜é‡} \\\epsilon_t &amp;\text{ æ˜¯è§‚æµ‹å™ªå£°}\end{aligned}\tag{8.2}\]</span></p><p><span class="math display">\[\begin{aligned}&amp; \textbf{çŠ¶æ€æ–¹ç¨‹} \\X_t &amp;= A X_{t-1} + \eta_t \\\text{å…¶ä¸­} &amp; \\A &amp;\text{ æ˜¯éšå˜é‡çš„è‡ªå›å½’ç³»æ•°çŸ©é˜µ} \\\eta_t &amp;\text{ æ˜¯çŠ¶æ€å™ªå£°}\end{aligned}\tag{8.3}\]</span></p><p><strong>é©¬å°”å¯å¤«æ¨¡å‹</strong>ï¼šä½¿ç”¨ <spanclass="math inline">\(x_{t-1}, \ldots, x_{t-\tau}\)</span> è€Œä¸æ˜¯ <spanclass="math inline">\(x_{t-1}, \ldots, x_1\)</span> æ¥é¢„æµ‹ <spanclass="math inline">\(x_t\)</span> ï¼Œåªè¦è¿™ç§æ˜¯è¿‘ä¼¼ç²¾ç¡®çš„ï¼Œæˆ‘ä»¬å°±è¯´åºåˆ—æ»¡è¶³é©¬å°”å¯å¤«æ¡ä»¶ã€‚å½“ <spanclass="math inline">\(\tau = 1\)</span>æ—¶ï¼Œæˆ‘ä»¬ç§°åºåˆ—æ˜¯ä¸€é˜¶é©¬å°”å¯å¤«åºåˆ—ã€‚</p><h3 id="æ–‡æœ¬é¢„å¤„ç†">8.2 æ–‡æœ¬é¢„å¤„ç†</h3><ol type="1"><li>å°†æ–‡æœ¬ä½œä¸ºå­—ç¬¦ä¸²åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºè¯å…ƒï¼ˆå¦‚å•è¯å’Œå­—ç¬¦ï¼‰ã€‚</li><li>å»ºç«‹ä¸€ä¸ªè¯è¡¨ï¼Œå°†æ‹†åˆ†çš„è¯å…ƒæ˜ å°„åˆ°æ•°å­—ç´¢å¼•ã€‚</li><li>å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­—ç´¢å¼•åºåˆ—ï¼Œæ–¹ä¾¿æ¨¡å‹æ“ä½œã€‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> collections<span class="token keyword">import</span> re<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token comment"># è¯»å–æ•°æ®é›†</span>d2l<span class="token punctuation">.</span>DATA_HUB<span class="token punctuation">[</span><span class="token string">'time_machine'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>d2l<span class="token punctuation">.</span>DATA_URL <span class="token operator">+</span> <span class="token string">'timemachine.txt'</span><span class="token punctuation">,</span>                                <span class="token string">'090b5e7e70c295757f55df93cb0a180b9691891a'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">read_time_machine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># @save</span>    <span class="token triple-quoted-string string">"""å°†æ—¶é—´æœºå™¨æ•°æ®é›†åŠ è½½åˆ°æ–‡æœ¬è¡Œçš„åˆ—è¡¨ä¸­"""</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>d2l<span class="token punctuation">.</span>download<span class="token punctuation">(</span><span class="token string">'time_machine'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'[^A-Za-z]+'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">]</span>lines <span class="token operator">=</span> read_time_machine<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'# æ–‡æœ¬æ€»è¡Œæ•°: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>lines<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># è¯å…ƒåŒ–</span><span class="token keyword">def</span> <span class="token function">tokenize</span><span class="token punctuation">(</span>lines<span class="token punctuation">,</span> token<span class="token operator">=</span><span class="token string">'word'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># @save</span>    <span class="token triple-quoted-string string">"""å°†æ–‡æœ¬è¡Œæ‹†åˆ†ä¸ºå•è¯æˆ–å­—ç¬¦è¯å…ƒ"""</span>    <span class="token keyword">if</span> token <span class="token operator">==</span> <span class="token string">'word'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">]</span>    <span class="token keyword">elif</span> token <span class="token operator">==</span> <span class="token string">'char'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">]</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'é”™è¯¯ï¼šæœªçŸ¥è¯å…ƒç±»å‹ï¼š'</span> <span class="token operator">+</span> token<span class="token punctuation">)</span>tokens <span class="token operator">=</span> tokenize<span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># è¯æ±‡è¡¨</span><span class="token comment"># å°†è®­ç»ƒé›†ä¸­çš„æ‰€æœ‰æ–‡æ¡£åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¯¹å®ƒä»¬çš„å”¯ä¸€è¯å…ƒè¿›è¡Œç»Ÿè®¡ï¼Œ å¾—åˆ°çš„ç»Ÿè®¡ç»“æœç§°ä¹‹ä¸ºè¯­æ–™</span><span class="token keyword">class</span> <span class="token class-name">Vocab</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""æ–‡æœ¬è¯è¡¨"""</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tokens<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> min_freq<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> reserved_tokens<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> tokens <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> reserved_tokens <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            reserved_tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment"># æŒ‰å‡ºç°é¢‘ç‡æ’åº</span>        counter <span class="token operator">=</span> count_corpus<span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_token_freqs <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                                   reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment"># æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0</span>        self<span class="token punctuation">.</span>idx_to_token <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&lt;unk>'</span><span class="token punctuation">]</span> <span class="token operator">+</span> reserved_tokens        self<span class="token punctuation">.</span>token_to_idx <span class="token operator">=</span> <span class="token punctuation">&#123;</span>token<span class="token punctuation">:</span> idx                             <span class="token keyword">for</span> idx<span class="token punctuation">,</span> token <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> token<span class="token punctuation">,</span> freq <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_freqs<span class="token punctuation">:</span>            <span class="token keyword">if</span> freq <span class="token operator">&lt;</span> min_freq<span class="token punctuation">:</span>                <span class="token keyword">break</span>            <span class="token keyword">if</span> token <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>token_to_idx<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">.</span>append<span class="token punctuation">(</span>token<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>token_to_idx<span class="token punctuation">[</span>token<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>token_to_idx<span class="token punctuation">.</span>get<span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> self<span class="token punctuation">.</span>unk<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token keyword">for</span> token <span class="token keyword">in</span> tokens<span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">to_tokens</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> indices<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>indices<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">[</span>indices<span class="token punctuation">]</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx_to_token<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token keyword">for</span> index <span class="token keyword">in</span> indices<span class="token punctuation">]</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">unk</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">token_freqs</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_token_freqs<span class="token keyword">def</span> <span class="token function">count_corpus</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># @save</span>    <span class="token triple-quoted-string string">"""ç»Ÿè®¡è¯å…ƒçš„é¢‘ç‡"""</span>    <span class="token comment"># è¿™é‡Œçš„tokensæ˜¯1Dåˆ—è¡¨æˆ–2Dåˆ—è¡¨</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å°†è¯å…ƒåˆ—è¡¨å±•å¹³æˆä¸€ä¸ªåˆ—è¡¨</span>        tokens <span class="token operator">=</span> <span class="token punctuation">[</span>token <span class="token keyword">for</span> line <span class="token keyword">in</span> tokens <span class="token keyword">for</span> token <span class="token keyword">in</span> line<span class="token punctuation">]</span>    <span class="token keyword">return</span> collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>vocab <span class="token operator">=</span> Vocab<span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>vocab<span class="token punctuation">.</span>token_to_idx<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'æ–‡æœ¬:'</span><span class="token punctuation">,</span> tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ç´¢å¼•:'</span><span class="token punctuation">,</span> vocab<span class="token punctuation">[</span>tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># æ•´åˆæ‰€æœ‰åŠŸèƒ½</span><span class="token keyword">def</span> <span class="token function">load_corpus_time_machine</span><span class="token punctuation">(</span>max_tokens<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># @save</span>    <span class="token triple-quoted-string string">"""è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¯å…ƒç´¢å¼•åˆ—è¡¨å’Œè¯è¡¨"""</span>    lines <span class="token operator">=</span> read_time_machine<span class="token punctuation">(</span><span class="token punctuation">)</span>    tokens <span class="token operator">=</span> tokenize<span class="token punctuation">(</span>lines<span class="token punctuation">,</span> <span class="token string">'char'</span><span class="token punctuation">)</span>    vocab <span class="token operator">=</span> Vocab<span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>    <span class="token comment"># å› ä¸ºæ—¶å…‰æœºå™¨æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œ</span>    <span class="token comment"># æ‰€ä»¥å°†æ‰€æœ‰æ–‡æœ¬è¡Œå±•å¹³åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­</span>    corpus <span class="token operator">=</span> <span class="token punctuation">[</span>vocab<span class="token punctuation">[</span>token<span class="token punctuation">]</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> tokens <span class="token keyword">for</span> token <span class="token keyword">in</span> line<span class="token punctuation">]</span>    <span class="token keyword">if</span> max_tokens <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        corpus <span class="token operator">=</span> corpus<span class="token punctuation">[</span><span class="token punctuation">:</span>max_tokens<span class="token punctuation">]</span>    <span class="token keyword">return</span> corpus<span class="token punctuation">,</span> vocabcorpus<span class="token punctuation">,</span> vocab <span class="token operator">=</span> load_corpus_time_machine<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">len</span><span class="token punctuation">(</span>corpus<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span></code></pre><h3 id="è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†">8.3 è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†</h3>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 7 ç°ä»£å·ç§¯ç¥ç»ç½‘ç»œ</title>
      <link href="/2024/06/29/DL/7%20%E7%8E%B0%E4%BB%A3%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
      <url>/2024/06/29/DL/7%20%E7%8E%B0%E4%BB%A3%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="ç°ä»£å·ç§¯ç¥ç»ç½‘ç»œ">7 ç°ä»£å·ç§¯ç¥ç»ç½‘ç»œ</h2><h3 id="æ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œalexnet">7.1 æ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œï¼ˆAlexNetï¼‰</h3><p>ä»LeNetåˆ°AlexNetçš„å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.1_lenet-to-alexnet.svg"title="å›¾7.1ï¼šLeNetï¼ˆå·¦ï¼‰å’Œ AlexNetï¼ˆå³ï¼‰çš„è®¾è®¡ã€‚"alt="LeNetåˆ°AlexNet" /><figcaption aria-hidden="true">LeNetåˆ°AlexNet</figcaption></figure><ol type="1"><li>AlexNetæ¯”ç›¸å¯¹è¾ƒå°çš„LeNet5è¦æ·±å¾—å¤šã€‚AlexNetç”±å…«å±‚ç»„æˆï¼šäº”ä¸ªå·ç§¯å±‚ã€ä¸¤ä¸ªå…¨è¿æ¥éšè—å±‚å’Œä¸€ä¸ªå…¨è¿æ¥è¾“å‡ºå±‚ã€‚</li><li>AlexNetä½¿ç”¨ReLUè€Œä¸æ˜¯sigmoidä½œä¸ºå…¶æ¿€æ´»å‡½æ•°ã€‚</li><li>AlexNetçš„æ¶æ„ä¸LeNetç›¸ä¼¼ï¼Œä½†ä½¿ç”¨äº†æ›´å¤šçš„å·ç§¯å±‚å’Œæ›´å¤šçš„å‚æ•°æ¥æ‹Ÿåˆå¤§è§„æ¨¡çš„ImageNetæ•°æ®é›†ã€‚</li><li>Dropoutã€ReLUå’Œé¢„å¤„ç†æ˜¯æå‡è®¡ç®—æœºè§†è§‰ä»»åŠ¡æ€§èƒ½çš„å…¶ä»–å…³é”®æ­¥éª¤ã€‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2lnet <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>    <span class="token comment"># è¿™é‡Œä½¿ç”¨ä¸€ä¸ª11*11çš„æ›´å¤§çª—å£æ¥æ•æ‰å¯¹è±¡ã€‚</span>    <span class="token comment"># åŒæ—¶ï¼Œæ­¥å¹…ä¸º4ï¼Œä»¥å‡å°‘è¾“å‡ºçš„é«˜åº¦å’Œå®½åº¦ã€‚</span>    <span class="token comment"># å¦å¤–ï¼Œè¾“å‡ºé€šé“çš„æ•°ç›®è¿œå¤§äºLeNet</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># å‡å°å·ç§¯çª—å£ï¼Œä½¿ç”¨å¡«å……ä¸º2æ¥ä½¿å¾—è¾“å…¥ä¸è¾“å‡ºçš„é«˜å’Œå®½ä¸€è‡´ï¼Œä¸”å¢å¤§è¾“å‡ºé€šé“æ•°</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># ä½¿ç”¨ä¸‰ä¸ªè¿ç»­çš„å·ç§¯å±‚å’Œè¾ƒå°çš„å·ç§¯çª—å£ã€‚</span>    <span class="token comment"># é™¤äº†æœ€åçš„å·ç§¯å±‚ï¼Œè¾“å‡ºé€šé“çš„æ•°é‡è¿›ä¸€æ­¥å¢åŠ ã€‚</span>    <span class="token comment"># åœ¨å‰ä¸¤ä¸ªå·ç§¯å±‚ä¹‹åï¼Œæ±‡èšå±‚ä¸ç”¨äºå‡å°‘è¾“å…¥çš„é«˜åº¦å’Œå®½åº¦</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># è¿™é‡Œï¼Œå…¨è¿æ¥å±‚çš„è¾“å‡ºæ•°é‡æ˜¯LeNetä¸­çš„å¥½å‡ å€ã€‚ä½¿ç”¨dropoutå±‚æ¥å‡è½»è¿‡æ‹Ÿåˆ</span>    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">6400</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># æœ€åæ˜¯è¾“å‡ºå±‚ã€‚ç”±äºè¿™é‡Œä½¿ç”¨Fashion-MNISTï¼Œæ‰€ä»¥ç”¨ç±»åˆ«æ•°ä¸º10ï¼Œè€Œéè®ºæ–‡ä¸­çš„1000</span>    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="ä½¿ç”¨å—çš„ç½‘ç»œvgg">7.2 ä½¿ç”¨å—çš„ç½‘ç»œï¼ˆVGGï¼‰</h3><p>ä¸AlexNetã€LeNetä¸€æ ·ï¼ŒVGGç½‘ç»œå¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†ä¸»è¦ç”±å·ç§¯å±‚å’Œæ±‡èšå±‚ç»„æˆï¼Œç¬¬äºŒéƒ¨åˆ†ç”±å…¨è¿æ¥å±‚ç»„æˆã€‚ä»AlexNetåˆ°VGGï¼Œå®ƒä»¬æœ¬è´¨ä¸Šéƒ½æ˜¯å—è®¾è®¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.2_vgg-block.svg" title="å›¾7.2ï¼šVGGå—ç»“æ„"alt="VGGå—" /><figcaption aria-hidden="true">VGGå—</figcaption></figure><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># VGGå—(num_convsä¸ªå·ç§¯å±‚ + 1ä¸ªç”¨äºç©ºé—´ä¸‹é‡‡æ ·çš„æœ€å¤§æ±‡èšå±‚)</span><span class="token keyword">def</span> <span class="token function">vgg_block</span><span class="token punctuation">(</span>num_convs<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>    layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_convs<span class="token punctuation">)</span><span class="token punctuation">:</span>        layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span>                                kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        in_channels <span class="token operator">=</span> out_channels    layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span><span class="token comment"># VGGç½‘ç»œ</span><span class="token keyword">def</span> <span class="token function">vgg</span><span class="token punctuation">(</span>conv_arch<span class="token punctuation">)</span><span class="token punctuation">:</span>    conv_blks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    in_channels <span class="token operator">=</span> <span class="token number">1</span>    <span class="token comment"># å·ç§¯å±‚éƒ¨åˆ†</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>num_convs<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span> <span class="token keyword">in</span> conv_arch<span class="token punctuation">:</span>        conv_blks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>vgg_block<span class="token punctuation">(</span>num_convs<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">)</span>        in_channels <span class="token operator">=</span> out_channels    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>        <span class="token operator">*</span>conv_blks<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment"># å…¨è¿æ¥å±‚éƒ¨åˆ†</span>        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>out_channels <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>conv_arch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># æŒ‡å®šå·ç§¯å±‚ä¸ªæ•°å’Œè¾“å‡ºé€šé“æ•°</span>net <span class="token operator">=</span> vgg<span class="token punctuation">(</span>conv_arch<span class="token punctuation">)</span></code></pre><h3 id="ç½‘ç»œä¸­çš„ç½‘ç»œnin">7.3 ç½‘ç»œä¸­çš„ç½‘ç»œï¼ˆNiNï¼‰</h3><p>åœ¨æ¯ä¸ªåƒç´ ä½ç½®ï¼ˆé’ˆå¯¹æ¯ä¸ªé«˜åº¦å’Œå®½åº¦ï¼‰åº”ç”¨ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼ŒNiNå—ä»¥ä¸€ä¸ªæ™®é€šå·ç§¯å±‚å¼€å§‹ï¼Œåé¢æ˜¯ä¸¤ä¸ª<spanclass="math inline">\(1 \times 1\)</span>çš„å·ç§¯å±‚ã€‚è¿™ä¸¤ä¸ª<spanclass="math inline">\(1 \times1\)</span>å·ç§¯å±‚å……å½“å¸¦æœ‰ReLUæ¿€æ´»å‡½æ•°çš„é€åƒç´ å…¨è¿æ¥å±‚ã€‚ç¬¬ä¸€å±‚çš„å·ç§¯çª—å£å½¢çŠ¶é€šå¸¸ç”±ç”¨æˆ·è®¾ç½®ã€‚ éšåçš„å·ç§¯çª—å£å½¢çŠ¶å›ºå®šä¸º<spanclass="math inline">\(1 \times 1\)</span>ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.3_nin-block.svg"title="å›¾7.3ï¼šå¯¹æ¯” VGG å’Œ NiN åŠå®ƒä»¬çš„å—ä¹‹é—´ä¸»è¦æ¶æ„å·®å¼‚" alt="NiNå—" /><figcaption aria-hidden="true">NiNå—</figcaption></figure><ol type="1"><li>NiNä½¿ç”¨ç”±ä¸€ä¸ªå·ç§¯å±‚å’Œå¤šä¸ª<span class="math inline">\(1 \times1\)</span>å·ç§¯å±‚ç»„æˆçš„å—ã€‚è¯¥å—å¯ä»¥åœ¨å·ç§¯ç¥ç»ç½‘ç»œä¸­ä½¿ç”¨ï¼Œä»¥å…è®¸æ›´å¤šçš„æ¯åƒç´ éçº¿æ€§ã€‚</li><li>NiNå»é™¤äº†å®¹æ˜“é€ æˆè¿‡æ‹Ÿåˆçš„å…¨è¿æ¥å±‚ï¼Œå°†å®ƒä»¬æ›¿æ¢ä¸ºå…¨å±€å¹³å‡æ±‡èšå±‚ï¼ˆå³åœ¨æ‰€æœ‰ä½ç½®ä¸Šè¿›è¡Œæ±‚å’Œï¼‰ã€‚è¯¥æ±‡èšå±‚é€šé“æ•°é‡ä¸ºæ‰€éœ€çš„è¾“å‡ºæ•°é‡ï¼ˆä¾‹å¦‚ï¼ŒFashion-MNISTçš„è¾“å‡ºä¸º10ï¼‰ã€‚</li><li>ç§»é™¤å…¨è¿æ¥å±‚å¯å‡å°‘è¿‡æ‹Ÿåˆï¼ŒåŒæ—¶æ˜¾è‘—å‡å°‘NiNçš„å‚æ•°ã€‚</li><li>NiNè®¾è®¡çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œå®ƒæ˜¾è‘—å‡å°‘äº†æ¨¡å‹æ‰€éœ€å‚æ•°çš„æ•°é‡ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œè¿™ç§è®¾è®¡æœ‰æ—¶ä¼šå¢åŠ è®­ç»ƒæ¨¡å‹çš„æ—¶é—´ã€‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># NiNå— (1ä¸ªæ™®é€šå·ç§¯å±‚ + 2ä¸ª1x1å·ç§¯å±‚)</span><span class="token keyword">def</span> <span class="token function">nin_block</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> padding<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> padding<span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># NiNç½‘ç»œ</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>    nin_block<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nin_block<span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nin_block<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># æ ‡ç­¾ç±»åˆ«æ•°æ˜¯10</span>    nin_block<span class="token punctuation">(</span><span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># å°†å››ç»´çš„è¾“å‡ºè½¬æˆäºŒç»´çš„è¾“å‡ºï¼Œå…¶å½¢çŠ¶ä¸º(æ‰¹é‡å¤§å°,10)</span>    nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="å«å¹¶è¡Œè¿ç»“çš„ç½‘ç»œgooglenet">7.4å«å¹¶è¡Œè¿ç»“çš„ç½‘ç»œï¼ˆGoogLeNetï¼‰</h3><p>GoogLeNetå¸æ”¶äº†NiNä¸­ä¸²è”ç½‘ç»œçš„æ€æƒ³ï¼Œé‡ç‚¹æ˜¯è§£å†³äº†ä»€ä¹ˆæ ·å¤§å°çš„å·ç§¯æ ¸æœ€åˆé€‚çš„é—®é¢˜ã€‚æœ¬æ–‡çš„ä¸€ä¸ªè§‚ç‚¹æ˜¯ï¼Œæœ‰æ—¶ä½¿ç”¨ä¸åŒå¤§å°çš„å·ç§¯æ ¸ç»„åˆæ˜¯æœ‰åˆ©çš„ã€‚Inceptionå—ç›¸å½“äºä¸€ä¸ªæœ‰4æ¡è·¯å¾„çš„å­ç½‘ç»œã€‚å®ƒé€šè¿‡ä¸åŒçª—å£å½¢çŠ¶çš„å·ç§¯å±‚å’Œæœ€å¤§æ±‡èšå±‚æ¥å¹¶è¡ŒæŠ½å–ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨<spanclass="math inline">\(1 \times1\)</span>å·ç§¯å±‚å‡å°‘æ¯åƒç´ çº§åˆ«ä¸Šçš„é€šé“ç»´æ•°ä»è€Œé™ä½æ¨¡å‹å¤æ‚åº¦ã€‚</p><p>æœ€åŸºæœ¬çš„å·ç§¯å—å«ä½œInceptionå—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.4_inception-block.svg"title="å›¾7.4ï¼šInceptionå—çš„ç»“æ„" alt="Inceptionå—" /><figcaption aria-hidden="true">Inceptionå—</figcaption></figure><ol type="1"><li>ç”±å››æ¡å¹¶è¡Œè·¯å¾„ç»„æˆï¼Œå‰ä¸‰æ¡è·¯å¾„ä½¿ç”¨çª—å£å¤§å°ä¸º<spanclass="math inline">\(1\times 1\)</span>ã€<spanclass="math inline">\(3\times 3\)</span>å’Œ<spanclass="math inline">\(5\times5\)</span>çš„å·ç§¯å±‚ï¼Œæ¥æŠ½å–ä¸åŒç©ºé—´å°ºå¯¸ä¸‹çš„ä¿¡æ¯ï¼Œå…¶ä¸­ä¸­é—´ä¸¤æ¡è·¯å¾„ä¼šå¯¹è¾“å…¥å…ˆåš<spanclass="math inline">\(1\times1\)</span>å·ç§¯æ¥å‡å°‘è¾“å…¥é€šé“æ•°ï¼Œä»¥é™ä½æ¨¡å‹å¤æ‚åº¦ã€‚</li><li>ç¬¬å››æ¡è·¯å¾„ä½¿ç”¨<span class="math inline">\(3\times3\)</span>æœ€å¤§æ±‡èšå±‚ï¼Œåæ¥<span class="math inline">\(1\times1\)</span>å·ç§¯å±‚æ¥æ”¹å˜é€šé“æ•°ã€‚</li><li>è¿™å››æ¡è·¯å¾„éƒ½ä½¿ç”¨åˆé€‚çš„å¡«å……æ¥ä½¿è¾“å…¥ä¸è¾“å‡ºçš„é«˜å’Œå®½ä¸€è‡´ã€‚</li><li>æœ€åæˆ‘ä»¬å°†æ¯æ¡çº¿è·¯çš„è¾“å‡ºåœ¨é€šé“ç»´ä¸Šè¿ç»“ï¼Œå¹¶è¾“å…¥æ¥ä¸‹æ¥çš„å±‚ä¸­å»ã€‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Inceptionå—</span><span class="token keyword">class</span> <span class="token class-name">Inception</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># c1--c4æ˜¯æ¯æ¡è·¯å¾„çš„è¾“å‡ºé€šé“æ•°</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Inception<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        <span class="token comment"># çº¿è·¯1ï¼Œå•1x1å·ç§¯å±‚</span>        self<span class="token punctuation">.</span>p1_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># çº¿è·¯2ï¼Œ1x1å·ç§¯å±‚åæ¥3x3å·ç§¯å±‚</span>        self<span class="token punctuation">.</span>p2_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> c2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>p2_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># çº¿è·¯3ï¼Œ1x1å·ç§¯å±‚åæ¥5x5å·ç§¯å±‚</span>        self<span class="token punctuation">.</span>p3_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> c3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>p3_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        <span class="token comment"># çº¿è·¯4ï¼Œ3x3æœ€å¤§æ±‡èšå±‚åæ¥1x1å·ç§¯å±‚</span>        self<span class="token punctuation">.</span>p4_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>p4_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> c4<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        p1 <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p1_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        p2 <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p2_2<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p2_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        p3 <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p3_2<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p3_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        p4 <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p4_2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p4_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># åœ¨é€šé“ç»´åº¦ä¸Šè¿ç»“è¾“å‡º</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p>ä»è€Œç»„åˆä¸ºGoogLeNetï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.5_googlenet.svg" title="å›¾7.5ï¼šGoogLeNetç½‘ç»œè®¾è®¡"alt="GoogLeNet" /><figcaption aria-hidden="true">GoogLeNet</figcaption></figure><ol type="1"><li>Inceptionå—ä¹‹é—´çš„æœ€å¤§æ±‡èšå±‚å¯é™ä½ç»´åº¦</li><li>ç¬¬ä¸€ä¸ªæ¨¡å—ç±»ä¼¼äºAlexNetå’ŒLeNet</li><li>Inceptionå—çš„ç»„åˆä»VGGç»§æ‰¿</li><li>å…¨å±€å¹³å‡æ±‡èšå±‚é¿å…äº†åœ¨æœ€åä½¿ç”¨å…¨è¿æ¥å±‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># GoogLeNet</span>b1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Inception<span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   Inception<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Inception<span class="token punctuation">(</span><span class="token number">480</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">208</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   Inception<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   Inception<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   Inception<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">288</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   Inception<span class="token punctuation">(</span><span class="token number">528</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Inception<span class="token punctuation">(</span><span class="token number">832</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   Inception<span class="token punctuation">(</span><span class="token number">832</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> b4<span class="token punctuation">,</span> b5<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="æ‰¹é‡è§„èŒƒåŒ–">7.5 æ‰¹é‡è§„èŒƒåŒ–</h3><ol type="1"><li>åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ‰¹é‡è§„èŒƒåŒ–åˆ©ç”¨å°æ‰¹é‡çš„å‡å€¼å’Œæ ‡å‡†å·®ï¼Œä¸æ–­è°ƒæ•´ç¥ç»ç½‘ç»œçš„ä¸­é—´è¾“å‡ºï¼Œä½¿æ•´ä¸ªç¥ç»ç½‘ç»œå„å±‚çš„ä¸­é—´è¾“å‡ºå€¼æ›´åŠ ç¨³å®šã€‚</li><li>æ‰¹é‡è§„èŒƒåŒ–åœ¨å…¨è¿æ¥å±‚å’Œå·ç§¯å±‚çš„ä½¿ç”¨ç•¥æœ‰ä¸åŒã€‚</li><li>æ‰¹é‡è§„èŒƒåŒ–å±‚å’Œæš‚é€€å±‚ä¸€æ ·ï¼Œåœ¨è®­ç»ƒæ¨¡å¼å’Œé¢„æµ‹æ¨¡å¼ä¸‹è®¡ç®—ä¸åŒã€‚</li></ol><h4 id="åŸç†">7.5.1 åŸç†</h4><p>åŸç†:åœ¨æ¯æ¬¡è®­ç»ƒè¿­ä»£ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè§„èŒƒåŒ–è¾“å…¥ï¼Œå³é€šè¿‡å‡å»å…¶å‡å€¼å¹¶é™¤ä»¥å…¶æ ‡å‡†å·®ï¼Œå…¶ä¸­ä¸¤è€…å‡åŸºäºå½“å‰å°æ‰¹é‡å¤„ç†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åº”ç”¨æ¯”ä¾‹ç³»æ•°å’Œæ¯”ä¾‹åç§»ã€‚å¯ä»¥ç”¨äºåŠ é€Ÿæ·±åº¦ç½‘ç»œçš„æ”¶æ•›é€Ÿåº¦ï¼ŒåŒæ—¶é¿å…ä¸­é—´å±‚çš„å˜åŒ–å¹…åº¦è¿‡äºå‰§çƒˆã€‚</p><p>ç”¨<span class="math inline">\(\mathbf{x} \in\mathcal{B}\)</span>è¡¨ç¤ºä¸€ä¸ªæ¥è‡ªå°æ‰¹é‡<spanclass="math inline">\(\mathcal{B}\)</span>çš„è¾“å…¥æ ·æœ¬ï¼Œæ‰¹é‡è§„èŒƒåŒ–<spanclass="math inline">\(\mathrm{BN}\)</span>æ ¹æ®ä»¥ä¸‹ç­‰å¼è½¬æ¢<spanclass="math inline">\(\mathbf{x}\)</span>:</p><p><span class="math display">\[\mathrm{BN}(\mathbf{x}) = \boldsymbol{\gamma} \odot \frac{\mathbf{x} -\hat{\boldsymbol{\mu}}_\mathcal{B}}{\hat{\boldsymbol{\sigma}}_\mathcal{B}}+ \boldsymbol{\beta}\tag{7.1}\]</span></p><p>å…¶ä¸­<spanclass="math inline">\(\hat{\boldsymbol{\mu}}_\mathcal{B}\)</span>æ˜¯å°æ‰¹é‡<spanclass="math inline">\(\mathcal{B}\)</span>çš„å‡å€¼ï¼Œ<spanclass="math inline">\(\hat{\boldsymbol{\sigma}}_\mathcal{B}\)</span>æ˜¯å°æ‰¹é‡çš„æ ‡å‡†å·®ã€‚åº”ç”¨æ ‡å‡†åŒ–åï¼Œç”Ÿæˆçš„å°æ‰¹é‡çš„å¹³å‡å€¼ä¸º0å’Œå•ä½æ–¹å·®ä¸º1ã€‚ç”±äºå•ä½æ–¹å·®æ˜¯ä¸€ä¸ªä¸»è§‚çš„é€‰æ‹©ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸åŒ…å«<em>æ‹‰ä¼¸å‚æ•°ï¼ˆscaleï¼‰<spanclass="math inline">\(\boldsymbol{\gamma}\)</span></em> å’Œ<em>åç§»å‚æ•°ï¼ˆshiftï¼‰<spanclass="math inline">\(\boldsymbol{\beta}\)</span></em>ï¼Œå®ƒä»¬çš„å½¢çŠ¶ä¸<spanclass="math inline">\(\mathbf{x}\)</span>ç›¸åŒã€‚ è¯·æ³¨æ„ï¼Œ<spanclass="math inline">\(\boldsymbol{\gamma}\)</span>å’Œ<spanclass="math inline">\(\boldsymbol{\beta}\)</span>æ˜¯éœ€è¦ä¸å…¶ä»–æ¨¡å‹å‚æ•°ä¸€èµ·å­¦ä¹ çš„å‚æ•°ã€‚</p><p><span class="math display">\[\begin{split}\begin{aligned} \hat{\boldsymbol{\mu}}_\mathcal{B} &amp;=\frac{1}{|\mathcal{B}|} \sum_{\mathbf{x} \in \mathcal{B}} \mathbf{x},\\\hat{\boldsymbol{\sigma}}_\mathcal{B}^2 &amp;= \frac{1}{|\mathcal{B}|}\sum_{\mathbf{x} \in \mathcal{B}} (\mathbf{x} -\hat{\boldsymbol{\mu}}_{\mathcal{B}})^2 +\epsilon.\end{aligned}\end{split}\tag{7.2}\]</span></p><h4 id="æ‰¹é‡è§„èŒƒåŒ–å±‚">7.5.2 æ‰¹é‡è§„èŒƒåŒ–å±‚</h4><p>æ‰¹é‡è§„èŒƒåŒ–å’Œå…¶ä»–å±‚ä¹‹é—´çš„ä¸€ä¸ªå…³é”®åŒºåˆ«æ˜¯ï¼Œç”±äºæ‰¹é‡è§„èŒƒåŒ–åœ¨å®Œæ•´çš„å°æ‰¹é‡ä¸Šè¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½åƒä»¥å‰åœ¨å¼•å…¥å…¶ä»–å±‚æ—¶é‚£æ ·å¿½ç•¥æ‰¹é‡å¤§å°</p><p><strong>å…¨è¿æ¥å±‚</strong>:å°†æ‰¹é‡è§„èŒƒåŒ–å±‚ç½®äºå…¨è¿æ¥å±‚ä¸­çš„ä»¿å°„å˜æ¢å’Œæ¿€æ´»å‡½æ•°ä¹‹é—´ã€‚<spanclass="math inline">\(\mathbf{h} = \phi(\mathrm{BN}(\mathbf{W}\mathbf{x}+ \mathbf{b}) )\)</span> <strong>å·ç§¯å±‚</strong>:åœ¨å·ç§¯å±‚ä¹‹åå’Œéçº¿æ€§æ¿€æ´»å‡½æ•°ä¹‹å‰åº”ç”¨æ‰¹é‡è§„èŒƒåŒ–ã€‚å½“å·ç§¯æœ‰å¤šä¸ªè¾“å‡ºé€šé“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™äº›é€šé“çš„â€œæ¯ä¸ªâ€è¾“å‡ºæ‰§è¡Œæ‰¹é‡è§„èŒƒåŒ–ï¼Œæ¯ä¸ªé€šé“éƒ½æœ‰è‡ªå·±çš„æ‹‰ä¼¸ï¼ˆscaleï¼‰å’Œåç§»ï¼ˆshiftï¼‰å‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯æ ‡é‡ã€‚<strong>é¢„æµ‹è¿‡ç¨‹ä¸­çš„æ‰¹é‡è§„èŒƒåŒ–</strong>: ä¸€ç§å¸¸ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡<em>ç§»åŠ¨å¹³å‡ä¼°</em>ç®—æ•´ä¸ªè®­ç»ƒæ•°æ®é›†çš„æ ·æœ¬å‡å€¼å’Œæ–¹å·®ï¼Œå¹¶åœ¨é¢„æµ‹æ—¶ä½¿ç”¨å®ƒä»¬å¾—åˆ°ç¡®å®šçš„è¾“å‡ºã€‚</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ä½¿ç”¨æ‰¹é‡è§„èŒƒåŒ–å±‚çš„ LeNet</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="æ®‹å·®ç½‘ç»œresnet">7.6 æ®‹å·®ç½‘ç»œï¼ˆResNetï¼‰</h3><p>æ®‹å·®ç½‘ç»œçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ¯ä¸ªé™„åŠ å±‚éƒ½åº”è¯¥æ›´å®¹æ˜“åœ°åŒ…å«åŸå§‹å‡½æ•°ä½œä¸ºå…¶å…ƒç´ ä¹‹ä¸€ã€‚åœ¨æ®‹å·®å—ä¸­ï¼Œè¾“å…¥å¯é€šè¿‡è·¨å±‚æ•°æ®çº¿è·¯æ›´å¿«åœ°å‘å‰ä¼ æ’­ã€‚æ®‹å·®ç½‘ç»œèƒ½å¤Ÿè§£å†³æ·±åº¦ç¥ç»ç½‘ç»œä¸­çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œå…è®¸æ„å»ºæ›´æ·±çš„ç½‘ç»œã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.6_residual-block.svg"title="å›¾7.6ï¼šä¸€ä¸ªæ­£å¸¸å—ï¼ˆå·¦å›¾ï¼‰å’Œä¸€ä¸ªæ®‹å·®å—ï¼ˆå³å›¾ï¼‰" alt="æ®‹å·®å—" /><figcaption aria-hidden="true">æ®‹å·®å—</figcaption></figure><p>å¦‚æœæƒ³æ”¹å˜é€šé“æ•°ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ä¸ªé¢å¤–çš„<span class="math inline">\(1\times1\)</span>å·ç§¯å±‚æ¥å°†è¾“å…¥å˜æ¢æˆéœ€è¦çš„å½¢çŠ¶åå†åšç›¸åŠ è¿ç®—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.7_residual-block-channels.svg"title="å›¾7.7ï¼šä¸åŒ…å«å’ŒåŒ…å«é€šé“å˜æ¢çš„æ®‹å·®å—" alt="æ®‹å·®å—ä¸­çš„é€šé“å˜æ¢" /><figcaption aria-hidden="true">æ®‹å·®å—ä¸­çš„é€šé“å˜æ¢</figcaption></figure><h3 id="ç¨ å¯†è¿æ¥ç½‘ç»œdensenet">7.7 ç¨ å¯†è¿æ¥ç½‘ç»œï¼ˆDenseNetï¼‰</h3><ol type="1"><li>åœ¨è·¨å±‚è¿æ¥ä¸Šï¼Œä¸åŒäºResNetä¸­å°†è¾“å…¥ä¸è¾“å‡ºç›¸åŠ ï¼Œç¨ å¯†è¿æ¥ç½‘ç»œï¼ˆDenseNetï¼‰åœ¨é€šé“ç»´ä¸Šè¿ç»“è¾“å…¥ä¸è¾“å‡ºã€‚</li><li>DenseNetçš„ä¸»è¦æ„å»ºæ¨¡å—æ˜¯ç¨ å¯†å—å’Œè¿‡æ¸¡å±‚ã€‚</li><li>å‰è€…å®šä¹‰å¦‚ä½•è¿æ¥è¾“å…¥å’Œè¾“å‡ºï¼Œè€Œåè€…åˆ™æ§åˆ¶é€šé“æ•°é‡ï¼Œä½¿å…¶ä¸ä¼šå¤ªå¤æ‚ã€‚</li></ol><p>å¯ä»¥ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜å’Œå¼ºåŒ–ç‰¹å¾ä¼ æ’­ï¼Œè¿˜å¯ä»¥å‡å°‘å‚æ•°æ•°é‡ç­‰ã€‚</p><p>ResNetï¼ˆå·¦ï¼‰ä¸ DenseNetï¼ˆå³ï¼‰åœ¨è·¨å±‚è¿æ¥ä¸Šçš„ä¸»è¦åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.8_resnet-densenet.svg"title="å›¾7.8ï¼šResNetä¸DenseNetåœ¨è·¨å±‚è¿æ¥ä¸Šçš„ä¸»è¦åŒºåˆ«: ä½¿ç”¨ç›¸åŠ å’Œä½¿ç”¨è¿ç»“"alt="ResNetä¸DenseNetåœ¨è·¨å±‚è¿æ¥ä¸Šçš„ä¸»è¦åŒºåˆ«" /><figcaptionaria-hidden="true">ResNetä¸DenseNetåœ¨è·¨å±‚è¿æ¥ä¸Šçš„ä¸»è¦åŒºåˆ«</figcaption></figure><p>å°†ResNetçš„ <span class="math inline">\(f(x)=x+g(x)\)</span>(ä¸€ä¸ªç®€å•çš„çº¿æ€§é¡¹å’Œä¸€ä¸ªå¤æ‚çš„éçº¿æ€§é¡¹) æ‹“å±•æˆè¶…è¿‡ä¸¤éƒ¨åˆ†çš„ä¿¡æ¯ <spanclass="math inline">\(\mathbf{x} \to \left[\mathbf{x},f_1(\mathbf{x}),f_2([\mathbf{x}, f_1(\mathbf{x})]), f_3([\mathbf{x}, f_1(\mathbf{x}),f_2([\mathbf{x}, f_1(\mathbf{x})])]), \ldots\right]\)</span></p><p>æœ€åä¸€å±‚ä¸ä¹‹å‰çš„æ‰€æœ‰å±‚ç´§å¯†ç›¸è¿ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/7.9_densenet-block.svg" title="å›¾7.9ï¼šç¨ å¯†è¿æ¥"alt="ç¨ å¯†è¿æ¥" /><figcaption aria-hidden="true">ç¨ å¯†è¿æ¥</figcaption></figure>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 6 å·ç§¯ç¥ç»ç½‘ç»œ</title>
      <link href="/2024/06/28/DL/6%20%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
      <url>/2024/06/28/DL/6%20%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="å·ç§¯ç¥ç»ç½‘ç»œ">6 å·ç§¯ç¥ç»ç½‘ç»œ</h2><p>å·ç§¯ç¥ç»ç½‘ç»œï¼ˆconvolutional neuralnetworkï¼ŒCNNï¼‰æ˜¯ä¸€ç±»å¼ºå¤§çš„ã€ä¸ºå¤„ç†å›¾åƒæ•°æ®è€Œè®¾è®¡çš„ç¥ç»ç½‘ç»œï¼Œåˆ©ç”¨ç›¸è¿‘åƒç´ ä¹‹é—´çš„ç›¸äº’å…³è”æ€§ï¼Œä»å›¾åƒæ•°æ®ä¸­å­¦ä¹ å¾—åˆ°æœ‰æ•ˆçš„æ¨¡å‹ã€‚</p><h3 id="ä»å…¨è¿æ¥å±‚åˆ°å·ç§¯å±‚">6.1 ä»å…¨è¿æ¥å±‚åˆ°å·ç§¯å±‚</h3><ol type="1"><li>å¹³ç§»ä¸å˜æ€§ï¼šä¸ç®¡æ£€æµ‹å¯¹è±¡å‡ºç°åœ¨å›¾åƒä¸­çš„å“ªä¸ªä½ç½®ï¼Œç¥ç»ç½‘ç»œçš„å‰é¢å‡ å±‚åº”è¯¥å¯¹ç›¸åŒçš„å›¾åƒåŒºåŸŸå…·æœ‰ç›¸ä¼¼çš„ååº”ã€‚</li><li>å±€éƒ¨æ€§ï¼šç¥ç»ç½‘ç»œçš„å‰é¢å‡ å±‚åº”è¯¥åªæ¢ç´¢è¾“å…¥å›¾åƒä¸­çš„å±€éƒ¨åŒºåŸŸï¼Œè€Œä¸è¿‡åº¦åœ¨æ„å›¾åƒä¸­ç›¸éš”è¾ƒè¿œåŒºåŸŸçš„å…³ç³»ã€‚</li></ol><p>æœ€ç»ˆï¼Œå¯ä»¥èšåˆè¿™äº›å±€éƒ¨ç‰¹å¾ï¼Œä»¥åœ¨æ•´ä¸ªå›¾åƒçº§åˆ«è¿›è¡Œé¢„æµ‹ã€‚</p><ol type="1"><li>å›¾åƒçš„å¹³ç§»ä¸å˜æ€§ä½¿æˆ‘ä»¬ä»¥ç›¸åŒçš„æ–¹å¼å¤„ç†å±€éƒ¨å›¾åƒï¼Œè€Œä¸åœ¨ä¹å®ƒçš„ä½ç½®ã€‚</li><li>å±€éƒ¨æ€§æ„å‘³ç€è®¡ç®—ç›¸åº”çš„éšè—è¡¨ç¤ºåªéœ€ä¸€å°éƒ¨åˆ†å±€éƒ¨å›¾åƒåƒç´ ã€‚</li><li>åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå·ç§¯å±‚é€šå¸¸æ¯”å…¨è¿æ¥å±‚éœ€è¦æ›´å°‘çš„å‚æ•°ï¼Œä½†ä¾æ—§è·å¾—é«˜æ•ˆç”¨çš„æ¨¡å‹ã€‚</li><li>å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰æ˜¯ä¸€ç±»ç‰¹æ®Šçš„ç¥ç»ç½‘ç»œï¼Œå®ƒå¯ä»¥åŒ…å«å¤šä¸ªå·ç§¯å±‚ã€‚</li><li>å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºé€šé“ä½¿æ¨¡å‹åœ¨æ¯ä¸ªç©ºé—´ä½ç½®å¯ä»¥è·å–å›¾åƒçš„å¤šæ–¹é¢ç‰¹å¾ã€‚</li></ol><p>å…¶å®ä¹Ÿå°±æ˜¯è¯´ï¼Œå·ç§¯å±‚æ˜¯ç”¨æ¥æå–<strong>å›¾åƒçš„å±€éƒ¨ç‰¹å¾</strong>ï¼Œå…¨è¿æ¥å±‚æ˜¯ç”¨æ¥<strong>æ•´åˆè¿™äº›å±€éƒ¨ç‰¹å¾</strong>:<strong>å·ç§¯çš„æœ¬è´¨æ˜¯æœ‰æ•ˆæå–ç›¸é‚»åƒç´ é—´çš„ç›¸å…³ç‰¹å¾</strong>ã€‚</p><h3 id="å›¾åƒå·ç§¯">6.2 å›¾åƒå·ç§¯</h3><p>è¾“å…¥<span class="math inline">\(n_h \timesn_w\)</span>çš„å›¾åƒï¼Œå·ç§¯æ ¸<span class="math inline">\(k_h \timesk_w\)</span>ï¼Œè¾“å‡ºå°†æ˜¯<span class="math inline">\((n_h - k_h + 1) \times(n_w - k_w + 1)\)</span>çš„å›¾åƒã€‚</p><h4 id="äº’ç›¸å…³è¿ç®—">6.2.1 äº’ç›¸å…³è¿ç®—</h4><p>å·ç§¯è¿ç®—å…¶å®æ˜¯äº’ç›¸å…³è¿ç®—ï¼š</p><figure><img src="./images/6.1_correlation.svg" title="å›¾6.1ï¼šäºŒç»´äº’ç›¸å…³è¿ç®—"alt="äºŒç»´äº’ç›¸å…³è¿ç®—" /><figcaption aria-hidden="true">äºŒç»´äº’ç›¸å…³è¿ç®—</figcaption></figure><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">corr2d</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è®¡ç®—äºŒç»´äº’ç›¸å…³è¿ç®—"""</span>    h<span class="token punctuation">,</span> w <span class="token operator">=</span> K<span class="token punctuation">.</span>shape    Y <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> h <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> w <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Y<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Y<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            Y<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>X<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> h<span class="token punctuation">,</span> j<span class="token punctuation">:</span>j <span class="token operator">+</span> w<span class="token punctuation">]</span> <span class="token operator">*</span> K<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> Y</code></pre><h4 id="å·ç§¯å±‚">6.2.2 å·ç§¯å±‚</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Conv2D</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>kernel_size<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>bias <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> corr2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>weight<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>bias</code></pre><h4 id="å·ç§¯æ ¸è®­ç»ƒ">6.2.3 å·ç§¯æ ¸è®­ç»ƒ</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># æ„é€ ä¸€ä¸ªäºŒç»´å·ç§¯å±‚ï¼Œå®ƒå…·æœ‰1ä¸ªè¾“å‡ºé€šé“å’Œå½¢çŠ¶ä¸ºï¼ˆ1ï¼Œ2ï¼‰çš„å·ç§¯æ ¸</span>conv2d <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment"># è¿™ä¸ªäºŒç»´å·ç§¯å±‚ä½¿ç”¨å››ç»´è¾“å…¥å’Œè¾“å‡ºæ ¼å¼ï¼ˆæ‰¹é‡å¤§å°ã€é€šé“ã€é«˜åº¦ã€å®½åº¦ï¼‰ï¼Œ</span><span class="token comment"># å…¶ä¸­æ‰¹é‡å¤§å°å’Œé€šé“æ•°éƒ½ä¸º1</span>X <span class="token operator">=</span> X<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Y <span class="token operator">=</span> Y<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lr <span class="token operator">=</span> <span class="token number">3e-2</span>  <span class="token comment"># å­¦ä¹ ç‡</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    Y_hat <span class="token operator">=</span> conv2d<span class="token punctuation">(</span>X<span class="token punctuation">)</span>  <span class="token comment"># é€šè¿‡å·ç§¯å±‚ conv2d è®¡ç®—è¾“å‡º Y_hat</span>    l <span class="token operator">=</span> <span class="token punctuation">(</span>Y_hat <span class="token operator">-</span> Y<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>  <span class="token comment"># è®¡ç®—æŸå¤± lï¼ˆå‡æ–¹è¯¯å·®æŸå¤±ï¼‰</span>    conv2d<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å°†å·ç§¯å±‚ conv2d ä¸­çš„æ‰€æœ‰å‚æ•°æ¢¯åº¦æ¸…é›¶</span>    l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å¯¹æŸå¤± l è¿›è¡Œåå‘ä¼ æ’­ï¼Œè®¡ç®—å‚æ•°çš„æ¢¯åº¦</span>    <span class="token comment"># è¿­ä»£å·ç§¯æ ¸</span>    conv2d<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-=</span> lr <span class="token operator">*</span> conv2d<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>grad  <span class="token comment"># ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•æ›´æ–°å·ç§¯æ ¸çš„æƒé‡</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'epoch </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">, loss </span><span class="token interpolation"><span class="token punctuation">&#123;</span>l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># æ¯ä¸¤è½®è¿­ä»£æ‰“å°ä¸€æ¬¡æŸå¤±</span></code></pre><h3 id="å¡«å……å’Œæ­¥å¹…">6.3 å¡«å……å’Œæ­¥å¹…</h3><h4 id="å¡«å……">6.3.1 å¡«å……</h4><p>åœ¨è¾“å…¥å›¾åƒçš„è¾¹ç•Œå¡«å……å…ƒç´ ï¼ˆé€šå¸¸å¡«å……å…ƒç´ æ˜¯<spanclass="math inline">\(0\)</span>ï¼‰ã€‚ å‡è®¾å¡«å……<spanclass="math inline">\(p_h\)</span>è¡Œå’Œ<spanclass="math inline">\(p_w\)</span>åˆ—(ä¸Šä¸‹å·¦å³å„å¤§çº¦ä¸€åŠ)ï¼Œè¾“å‡ºå½¢çŠ¶ä¸ºï¼š<spanclass="math inline">\((n_h-k_h+p_h+1)\times(n_w-k_w+p_w+1)\)</span>æ‰€ä»¥è®¸å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šè®¾ç½®<spanclass="math inline">\(p_h=k_h-1\)</span>å’Œ$p_w=k_w-1ï¼Œè¿™æ ·è¾“å…¥å’Œè¾“å‡ºå…·æœ‰ç›¸åŒçš„é«˜åº¦å’Œå®½åº¦ã€‚å› æ­¤å·ç§¯æ ¸ä¹Ÿé€šå¸¸è®¾ç½®ä¸ºå¥‡æ•°ï¼Œæ–¹ä¾¿å„å¡«å……ä¸€åŠã€‚è¿˜å¯ä»¥å¾—åˆ°å¯¹äºä»»ä½•äºŒç»´å¼ é‡Xï¼Œå½“æ»¡è¶³ï¼š1. å·ç§¯æ ¸çš„å¤§å°æ˜¯å¥‡æ•°ï¼› 2. æ‰€æœ‰è¾¹çš„å¡«å……è¡Œæ•°å’Œåˆ—æ•°ç›¸åŒï¼› 3.è¾“å‡ºä¸è¾“å…¥å…·æœ‰ç›¸åŒé«˜åº¦å’Œå®½åº¦ åˆ™å¯ä»¥å¾—å‡ºï¼šè¾“å‡ºY[i, j]æ˜¯é€šè¿‡ä»¥è¾“å…¥X[i,j]ä¸ºä¸­å¿ƒï¼Œä¸å·ç§¯æ ¸è¿›è¡Œäº’ç›¸å…³è®¡ç®—å¾—åˆ°çš„ã€‚</p><h4 id="æ­¥å¹…">6.3.2 æ­¥å¹…</h4><p>å·ç§¯çª—å£å¯ä»¥è·³è¿‡ä¸­é—´ä½ç½®ï¼Œæ¯æ¬¡æ»‘åŠ¨å¤šä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å°†æ¯æ¬¡æ»‘åŠ¨å…ƒç´ çš„æ•°é‡ç§°ä¸ºæ­¥å¹…ï¼ˆstrideï¼‰ã€‚</p><p>ä¸ºäº†è®¡ç®—è¾“å‡ºä¸­ç¬¬ä¸€åˆ—çš„ç¬¬äºŒä¸ªå…ƒç´ å’Œç¬¬ä¸€è¡Œçš„ç¬¬äºŒä¸ªå…ƒç´ ï¼Œå·ç§¯çª—å£åˆ†åˆ«å‘ä¸‹æ»‘åŠ¨ä¸‰è¡Œå’Œå‘å³æ»‘åŠ¨ä¸¤åˆ—:</p><figure><img src="./images/6.2_strides.svg"title="å›¾6.2ï¼šå‚ç›´æ­¥å¹…ä¸º 3ï¼Œæ°´å¹³æ­¥å¹…ä¸º 2 çš„äºŒç»´äº’ç›¸å…³è¿ç®—" alt="æ­¥å¹…" /><figcaption aria-hidden="true">æ­¥å¹…</figcaption></figure><p>æ­¤æ—¶çš„è¾“å‡ºå½¢çŠ¶ä¸ºï¼š<spanclass="math inline">\(\lfloor(n_h-k_h+p_h+s_h)/s_h\rfloor \times\lfloor(n_w-k_w+p_w+s_w)/s_w\rfloor.\)</span></p><h3 id="å¤šè¾“å…¥é€šé“å’Œå¤šè¾“å‡ºé€šé“">6.4 å¤šè¾“å…¥é€šé“å’Œå¤šè¾“å‡ºé€šé“</h3><h4 id="å¤šè¾“å…¥é€šé“">6.4.1 å¤šè¾“å…¥é€šé“</h4><p>å½“è¾“å…¥åŒ…å«å¤šä¸ªé€šé“æ—¶ï¼Œéœ€è¦æ„é€ ä¸€ä¸ªä¸è¾“å…¥æ•°æ®å…·æœ‰ç›¸åŒè¾“å…¥é€šé“æ•°çš„å·ç§¯æ ¸:<span class="math inline">\(c_i\times k_h\times k_w\)</span></p><figure><img src="./images/6.3_conv_multi_in.svg"title="å›¾6.3ï¼šå¤šè¾“å…¥é€šé“çš„äº’ç›¸å…³è®¡ç®—" alt="å¤šè¾“å…¥é€šé“çš„äº’ç›¸å…³è®¡ç®—" /><figcaption aria-hidden="true">å¤šè¾“å…¥é€šé“çš„äº’ç›¸å…³è®¡ç®—</figcaption></figure><h4 id="å¤šè¾“å‡ºé€šé“">6.4.2 å¤šè¾“å‡ºé€šé“</h4><p>ä¸ºäº†è·å¾—å¤šä¸ªé€šé“çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªè¾“å‡ºé€šé“åˆ›å»ºä¸€ä¸ªå½¢çŠ¶ä¸º<spanclass="math inline">\(c_i\times k_h\timesk_w\)</span>çš„å·ç§¯æ ¸å¼ é‡ï¼Œåˆ™<span class="math inline">\(c_o\timesc_i\times k_h\times k_w\)</span>ã€‚</p><h4 id="times-1å·ç§¯å±‚">6.4.3 <span class="math inline">\(1\times1\)</span>å·ç§¯å±‚</h4><p><span class="math inline">\(1\times1\)</span>å·ç§¯æ ¸çš„ä¸»è¦ä½œç”¨æ˜¯è°ƒæ•´ç½‘ç»œå±‚ä¹‹é—´çš„é€šé“æ•°ï¼Œè€Œä¸æ˜¯è¯†åˆ«ç›¸é‚»å…ƒç´ é—´ç›¸äº’ä½œç”¨ã€‚</p><figure><img src="./images/6.4_conv_1x1.svg"title="å›¾6.4ï¼šäº’ç›¸å…³è®¡ç®—ä½¿ç”¨äº†å…·æœ‰3ä¸ªè¾“å…¥é€šé“å’Œ2ä¸ªè¾“å‡ºé€šé“çš„$1\times 1$å·ç§¯æ ¸"alt="1\times 1å·ç§¯æ ¸" /><figcaption aria-hidden="true"><span class="math inline">\(1\times1\)</span>å·ç§¯æ ¸</figcaption></figure><p><strong>æœ¬è´¨ç›¸å½“äºä¸€ä¸ªè°ƒæ•´é€šé“æ•°çš„å…¨è¿æ¥å±‚ã€‚</strong></p><h3 id="æ±‡èšå±‚æ± åŒ–å±‚">6.5 æ±‡èšå±‚(æ± åŒ–å±‚)</h3><p><strong>é™ä½å·ç§¯å±‚å¯¹ä½ç½®çš„æ•æ„Ÿæ€§</strong>ï¼ŒåŒæ—¶<strong>é™ä½å¯¹ç©ºé—´é™é‡‡æ ·è¡¨ç¤ºçš„æ•æ„Ÿæ€§</strong></p><p>æœ€å¤§æ±‡èšå±‚å’Œå¹³å‡æ±‡èšå±‚æ˜¯æœ€å¸¸è§çš„æ±‡èšå±‚ï¼Œåˆ†åˆ«å–æ± åŒ–çª—å£ä¸­è¾“å…¥çš„æœ€å¤§å€¼å’Œå¹³å‡å€¼ã€‚</p><p>ç›¸æ¯”å·ç§¯å±‚:</p><ul><li>ç›¸åŒï¼šæ±‡èšå±‚ä¹Ÿæœ‰å¡«å……å’Œæ­¥å¹…ã€‚</li><li>ä¸åŒï¼š1. æ±‡èšå±‚çš„å‚æ•°ä¸éœ€è¦è®­ç»ƒï¼Œæ˜¯å›ºå®šçš„ï¼›2.åœ¨å¤„ç†å¤šé€šé“è¾“å…¥æ•°æ®æ—¶ï¼Œæ±‡èšå±‚åœ¨æ¯ä¸ªè¾“å…¥é€šé“ä¸Šå•ç‹¬è¿ç®—ï¼Œè€Œä¸æ˜¯åƒå·ç§¯å±‚ä¸€æ ·åœ¨é€šé“ä¸Šå¯¹è¾“å…¥è¿›è¡Œæ±‡æ€»(è¿™æ„å‘³ç€æ±‡èšå±‚çš„è¾“å‡ºé€šé“æ•°ä¸è¾“å…¥é€šé“æ•°ç›¸åŒ)ã€‚</li></ul><h3 id="å·ç§¯ç¥ç»ç½‘ç»œä»¥-lenet-ä¸ºä¾‹">6.6 å·ç§¯ç¥ç»ç½‘ç»œ(ä»¥ LeNet ä¸ºä¾‹)</h3><p>LeNetï¼ˆLeNet-5ï¼‰ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ol type="1"><li>å·ç§¯ç¼–ç å™¨ï¼šç”±ä¸¤ä¸ªå·ç§¯å±‚ç»„æˆ;</li><li>å…¨è¿æ¥å±‚å¯†é›†å—ï¼šç”±ä¸‰ä¸ªå…¨è¿æ¥å±‚ç»„æˆã€‚</li></ol><figure><img src="./images/6.5_lenet.svg"title="å›¾6.5ï¼šLeNetä¸­çš„æ•°æ®æµã€‚è¾“å…¥æ˜¯æ‰‹å†™æ•°å­—ï¼Œè¾“å‡ºä¸º10ç§å¯èƒ½ç»“æœçš„æ¦‚ç‡"alt="LeNet" /><figcaption aria-hidden="true">LeNet</figcaption></figure><figure><img src="./images/6.6_lenet-vert.svg" title="å›¾6.6ï¼šLeNet çš„ç®€åŒ–ç‰ˆ"alt="LeNet ç®€åŒ–ç‰ˆ" /><figcaption aria-hidden="true">LeNet ç®€åŒ–ç‰ˆ</figcaption></figure><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token keyword">def</span> <span class="token function">evaluate_accuracy_gpu</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> data_iter<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># @save</span>    <span class="token triple-quoted-string string">"""ä½¿ç”¨GPUè®¡ç®—æ¨¡å‹åœ¨æ•°æ®é›†ä¸Šçš„ç²¾åº¦"""</span>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>        net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> device<span class="token punctuation">:</span>            device <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>device    <span class="token comment"># æ­£ç¡®é¢„æµ‹çš„æ•°é‡ï¼Œæ€»é¢„æµ‹çš„æ•°é‡</span>    metric <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Accumulator<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token comment"># BERTå¾®è°ƒæ‰€éœ€çš„ï¼ˆä¹‹åå°†ä»‹ç»ï¼‰</span>                X <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> X<span class="token punctuation">]</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>            y <span class="token operator">=</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>            metric<span class="token punctuation">.</span>add<span class="token punctuation">(</span>d2l<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> metric<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">train_ch6</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ç”¨GPUè®­ç»ƒæ¨¡å‹"""</span>    <span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> nn<span class="token punctuation">.</span>Linear <span class="token keyword">or</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">:</span>            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>xavier_uniform_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>    net<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>init_weights<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'training on'</span><span class="token punctuation">,</span> device<span class="token punctuation">)</span>    <span class="token comment"># æ¨¡å‹è½¬ç§»åˆ°GPUä¸Š</span>    net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>    animator <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Animator<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">'epoch'</span><span class="token punctuation">,</span> xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span>                            legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train loss'</span><span class="token punctuation">,</span> <span class="token string">'train acc'</span><span class="token punctuation">,</span> <span class="token string">'test acc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    timer<span class="token punctuation">,</span> num_batches <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Timer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_iter<span class="token punctuation">)</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># è®­ç»ƒæŸå¤±ä¹‹å’Œï¼Œè®­ç»ƒå‡†ç¡®ç‡ä¹‹å’Œï¼Œæ ·æœ¬æ•°</span>        metric <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Accumulator<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>        net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>            timer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># åœ¨æ¯ä¸€ä¸ªæ‰¹é‡ä¸Šè®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°æ¨¡å‹å‚æ•°ï¼Œéœ€è¦è½¬ç§»åˆ°GPU</span>            X<span class="token punctuation">,</span> y <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>            y_hat <span class="token operator">=</span> net<span class="token punctuation">(</span>X<span class="token punctuation">)</span>            l <span class="token operator">=</span> loss<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span>            l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                metric<span class="token punctuation">.</span>add<span class="token punctuation">(</span>l <span class="token operator">*</span> X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d2l<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            timer<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>            train_l <span class="token operator">=</span> metric<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>            train_acc <span class="token operator">=</span> metric<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>num_batches <span class="token operator">//</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> i <span class="token operator">==</span> num_batches <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>                animator<span class="token punctuation">.</span>add<span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_batches<span class="token punctuation">,</span>                             <span class="token punctuation">(</span>train_l<span class="token punctuation">,</span> train_acc<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        test_acc <span class="token operator">=</span> evaluate_accuracy_gpu<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">)</span>        animator<span class="token punctuation">.</span>add<span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> test_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'loss </span><span class="token interpolation"><span class="token punctuation">&#123;</span>train_l<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">&#125;</span></span><span class="token string">, train acc </span><span class="token interpolation"><span class="token punctuation">&#123;</span>train_acc<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">&#125;</span></span><span class="token string">, '</span></span>          <span class="token string-interpolation"><span class="token string">f'test acc </span><span class="token interpolation"><span class="token punctuation">&#123;</span>test_acc<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>metric<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> num_epochs <span class="token operator">/</span> timer<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">&#125;</span></span><span class="token string"> examples/sec '</span></span>          <span class="token string-interpolation"><span class="token string">f'on </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                           <span class="token comment"># åœ¨å…¨è¿æ¥å±‚ä¹‹å‰è¦å…ˆå±•å¹³</span>        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># è¯»å–æ•°æ®</span>    batch_size <span class="token operator">=</span> <span class="token number">256</span>    train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_data_fashion_mnist<span class="token punctuation">(</span>batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>    <span class="token comment"># è®­ç»ƒ</span>    lr<span class="token punctuation">,</span> num_epochs <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">10</span>    train_ch6<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> d2l<span class="token punctuation">.</span>try_gpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 5 æ·±åº¦å­¦ä¹ è®¡ç®—</title>
      <link href="/2024/06/27/DL/5%20%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%A1%E7%AE%97/"/>
      <url>/2024/06/27/DL/5%20%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%A1%E7%AE%97/</url>
      
        <content type="html"><![CDATA[<h2 id="æ·±åº¦å­¦ä¹ è®¡ç®—">5 æ·±åº¦å­¦ä¹ è®¡ç®—</h2><h3 id="å±‚å’Œå—">5.1 å±‚å’Œå—</h3><p>å—ï¼ˆblockï¼‰å¯ä»¥æè¿°å•ä¸ªå±‚ã€ç”±å¤šä¸ªå±‚ç»„æˆçš„ç»„ä»¶æˆ–æ•´ä¸ªæ¨¡å‹æœ¬èº«ã€‚å—ç”±ç±»ï¼ˆclassï¼‰è¡¨ç¤ºã€‚å®ƒçš„ä»»ä½•å­ç±»éƒ½å¿…é¡»å®šä¹‰ä¸€ä¸ªå°†å…¶è¾“å…¥è½¬æ¢ä¸ºè¾“å‡ºçš„å‰å‘ä¼ æ’­å‡½æ•°ï¼Œå¹¶ä¸”å¿…é¡»å­˜å‚¨ä»»ä½•å¿…éœ€çš„å‚æ•°ã€‚ æ³¨æ„ï¼Œæœ‰äº›å—ä¸éœ€è¦ä»»ä½•å‚æ•°ã€‚æœ€åï¼Œä¸ºäº†è®¡ç®—æ¢¯åº¦ï¼Œå—å¿…é¡»å…·æœ‰åå‘ä¼ æ’­å‡½æ•°ã€‚æ€»ä½“æ¥è¯´ï¼Œåº”è¯¥å…·æœ‰ä»¥ä¸‹å†…å®¹ï¼š</p><ol type="1"><li>å°†è¾“å…¥æ•°æ®ä½œä¸ºå…¶å‰å‘ä¼ æ’­å‡½æ•°çš„å‚æ•°ã€‚</li><li>é€šè¿‡å‰å‘ä¼ æ’­å‡½æ•°æ¥ç”Ÿæˆè¾“å‡ºã€‚è¯·æ³¨æ„ï¼Œè¾“å‡ºçš„å½¢çŠ¶å¯èƒ½ä¸è¾“å…¥çš„å½¢çŠ¶ä¸åŒã€‚</li><li>è®¡ç®—å…¶è¾“å‡ºå…³äºè¾“å…¥çš„æ¢¯åº¦ï¼Œå¯é€šè¿‡å…¶åå‘ä¼ æ’­å‡½æ•°è¿›è¡Œè®¿é—®ã€‚é€šå¸¸è¿™æ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ã€‚</li><li>å­˜å‚¨å’Œè®¿é—®å‰å‘ä¼ æ’­è®¡ç®—æ‰€éœ€çš„å‚æ•°ã€‚</li><li>æ ¹æ®éœ€è¦åˆå§‹åŒ–æ¨¡å‹å‚æ•°ã€‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F<span class="token triple-quoted-string string">""" 5.1.1 è‡ªå®šä¹‰å— """</span><span class="token keyword">class</span> <span class="token class-name">MLP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># ç”¨æ¨¡å‹å‚æ•°å£°æ˜å±‚ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å£°æ˜ä¸¤ä¸ªå…¨è¿æ¥çš„å±‚</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># è°ƒç”¨MLPçš„çˆ¶ç±»Moduleçš„æ„é€ å‡½æ•°æ¥æ‰§è¡Œå¿…è¦çš„åˆå§‹åŒ–ã€‚</span>        <span class="token comment"># è¿™æ ·ï¼Œåœ¨ç±»å®ä¾‹åŒ–æ—¶ä¹Ÿå¯ä»¥æŒ‡å®šå…¶ä»–å‡½æ•°å‚æ•°ï¼Œä¾‹å¦‚æ¨¡å‹å‚æ•°paramsï¼ˆç¨åå°†ä»‹ç»ï¼‰</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>hidden <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># éšè—å±‚</span>        self<span class="token punctuation">.</span>out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># è¾“å‡ºå±‚</span>    <span class="token comment"># å®šä¹‰æ¨¡å‹çš„å‰å‘ä¼ æ’­ï¼Œå³å¦‚ä½•æ ¹æ®è¾“å…¥Xè¿”å›æ‰€éœ€çš„æ¨¡å‹è¾“å‡º</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ReLUçš„å‡½æ•°ç‰ˆæœ¬ï¼Œå…¶åœ¨nn.functionalæ¨¡å—ä¸­å®šä¹‰ã€‚</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>net <span class="token operator">=</span> MLP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">""" 5.1.2 é¡ºåºå— """</span><span class="token keyword">class</span> <span class="token class-name">MySequential</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> module <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># è¿™é‡Œï¼Œmoduleæ˜¯Moduleå­ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚æˆ‘ä»¬æŠŠå®ƒä¿å­˜åœ¨'Module'ç±»çš„æˆå‘˜</span>            <span class="token comment"># å˜é‡_modulesä¸­ã€‚_moduleçš„ç±»å‹æ˜¯OrderedDict</span>            self<span class="token punctuation">.</span>_modules<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> module    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># OrderedDictä¿è¯äº†æŒ‰ç…§æˆå‘˜æ·»åŠ çš„é¡ºåºéå†å®ƒä»¬</span>        <span class="token keyword">for</span> block <span class="token keyword">in</span> self<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            X <span class="token operator">=</span> block<span class="token punctuation">(</span>X<span class="token punctuation">)</span>        <span class="token keyword">return</span> Xnet <span class="token operator">=</span> MySequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">""" 5.1.3 åœ¨å‰å‘ä¼ æ’­å‡½æ•°ä¸­æ‰§è¡Œä»£ç  """</span><span class="token keyword">class</span> <span class="token class-name">FixedHiddenMLP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># ä¸è®¡ç®—æ¢¯åº¦çš„éšæœºæƒé‡å‚æ•°ã€‚å› æ­¤å…¶åœ¨è®­ç»ƒæœŸé—´ä¿æŒä¸å˜</span>        self<span class="token punctuation">.</span>rand_weight <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        X <span class="token operator">=</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>X<span class="token punctuation">)</span>        <span class="token comment"># ä½¿ç”¨åˆ›å»ºçš„å¸¸é‡å‚æ•°ä»¥åŠreluå’ŒmmçŸ©é˜µä¹˜æ³•å‡½æ•°</span>        <span class="token comment"># æ­¤æ—¶éšè—å±‚æƒé‡å§‹ç»ˆä¸ä¼šæ›´æ–°</span>        X <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>rand_weight<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># å¤ç”¨å…¨è¿æ¥å±‚ã€‚è¿™ç›¸å½“äºä¸¤ä¸ªå…¨è¿æ¥å±‚å…±äº«å‚æ•°</span>        X <span class="token operator">=</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>X<span class="token punctuation">)</span>        <span class="token comment"># æ§åˆ¶æµ</span>        <span class="token keyword">while</span> X<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>            X <span class="token operator">/=</span> <span class="token number">2</span>        <span class="token keyword">return</span> X<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">""" 5.1.4 æ··æ­å„ç§ç»„åˆå— """</span><span class="token keyword">class</span> <span class="token class-name">NestMLP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                 nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>chimera <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>NestMLP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FixedHiddenMLP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="å‚æ•°ç®¡ç†">5.2 å‚æ•°ç®¡ç†</h3><ol type="1"><li>è®¿é—®å‚æ•°ï¼Œç”¨äºè°ƒè¯•ã€è¯Šæ–­å’Œå¯è§†åŒ–ï¼›</li><li>å‚æ•°åˆå§‹åŒ–ï¼›</li><li>åœ¨ä¸åŒæ¨¡å‹ç»„ä»¶é—´å…±äº«å‚æ•°ã€‚</li></ol><p>å…·ä½“æ“ä½œç•¥ã€‚</p><h3 id="å»¶ååˆå§‹åŒ–">5.3 å»¶ååˆå§‹åŒ–</h3><ol type="1"><li>å®šä¹‰äº†ç½‘ç»œæ¶æ„ï¼Œä½†æ²¡æœ‰æŒ‡å®šè¾“å…¥ç»´åº¦ã€‚</li><li>æ·»åŠ å±‚æ—¶æ²¡æœ‰æŒ‡å®šå‰ä¸€å±‚çš„è¾“å‡ºç»´åº¦ã€‚</li><li>åœ¨åˆå§‹åŒ–å‚æ•°æ—¶ï¼Œç”šè‡³æ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥ç¡®å®šæ¨¡å‹åº”è¯¥åŒ…å«å¤šå°‘å‚æ•°ã€‚</li></ol><p>ä¾‹å¦‚:<code>net = nn.Sequential(nn.LazyLinear(256), nn.ReLU(),nn.Linear(256,10))</code></p><h3 id="è‡ªå®šä¹‰å±‚">5.4 è‡ªå®šä¹‰å±‚</h3><h4 id="ä¸å«æ¨¡å‹å‚æ•°çš„è‡ªå®šä¹‰å±‚">5.4.1 ä¸å«æ¨¡å‹å‚æ•°çš„è‡ªå®šä¹‰å±‚</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CenteredLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> X <span class="token operator">-</span> X<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CenteredLayer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h4 id="å«æ¨¡å‹å‚æ•°çš„è‡ªå®šä¹‰å±‚">5.4.2 å«æ¨¡å‹å‚æ•°çš„è‡ªå®šä¹‰å±‚</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyLinear</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_units<span class="token punctuation">,</span> units<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>in_units<span class="token punctuation">,</span> units<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>bias <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>units<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        linear <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data        <span class="token keyword">return</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>linear<span class="token punctuation">)</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>MyLinear<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyLinear<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="è¯»å†™æ–‡ä»¶">5.5 è¯»å†™æ–‡ä»¶</h3><p>å®šæœŸä¿å­˜ä¸­é—´ç»“æœ</p><h4 id="è¯»å†™å¼ é‡">5.5.1 è¯»å†™å¼ é‡</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># å¼ é‡</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">'x-file'</span><span class="token punctuation">)</span>x2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'x-file'</span><span class="token punctuation">)</span><span class="token comment"># å¼ é‡åˆ—è¡¨</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'x-files'</span><span class="token punctuation">)</span>x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'x-files'</span><span class="token punctuation">)</span><span class="token comment"># ä»å­—ç¬¦ä¸²æ˜ å°„åˆ°å¼ é‡çš„å­—å…¸</span>mydict <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'x'</span><span class="token punctuation">:</span> x<span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">:</span> y<span class="token punctuation">&#125;</span>torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>mydict<span class="token punctuation">,</span> <span class="token string">'mydict'</span><span class="token punctuation">)</span>mydict2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'mydict'</span><span class="token punctuation">)</span></code></pre><h4 id="è¯»å†™æ¨¡å‹å‚æ•°">5.5.2 è¯»å†™æ¨¡å‹å‚æ•°</h4><p>æ³¨æ„ï¼š<strong>ä»…ä¿å­˜æ¨¡å‹å‚æ•°è€Œä¸æ˜¯æ•´ä¸ªæ¨¡å‹</strong>ã€‚</p><pre class="language-python" data-language="python"><code class="language-python">net <span class="token operator">=</span> MLP<span class="token punctuation">(</span><span class="token punctuation">)</span>X <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>Y <span class="token operator">=</span> net<span class="token punctuation">(</span>X<span class="token punctuation">)</span>torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'mlp.params'</span><span class="token punctuation">)</span>clone <span class="token operator">=</span> MLP<span class="token punctuation">(</span><span class="token punctuation">)</span>clone<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'mlp.params'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="gpuè®¡ç®—">5.6 GPUè®¡ç®—</h3><p>åœ¨PyTorchä¸­ï¼Œæ¯ä¸ªæ•°ç»„éƒ½æœ‰ä¸€ä¸ªè®¾å¤‡ï¼ˆdeviceï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸å°†å…¶ç§°ä¸ºç¯å¢ƒï¼ˆcontextï¼‰ã€‚</p><ol type="1"><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å˜é‡å’Œç›¸å…³çš„è®¡ç®—éƒ½åˆ†é…ç»™CPUã€‚</li><li>è®¡ç®—çš„æ‰€æœ‰è¾“å…¥æ•°æ®éƒ½å¿…é¡»åœ¨åŒä¸€è®¾å¤‡ä¸Šï¼Œæ— è®ºæ˜¯CPUè¿˜æ˜¯GPUã€‚</li><li>ä¸ç»æ„åœ°ç§»åŠ¨æ•°æ®å¯èƒ½ä¼šæ˜¾è‘—é™ä½æ€§èƒ½ã€‚ä¸€ä¸ªå…¸å‹çš„é”™è¯¯å¦‚ä¸‹ï¼šè®¡ç®—GPUä¸Šæ¯ä¸ªå°æ‰¹é‡çš„æŸå¤±ï¼Œå¹¶åœ¨å‘½ä»¤è¡Œä¸­å°†å…¶æŠ¥å‘Šç»™ç”¨æˆ·ï¼ˆæˆ–å°†å…¶è®°å½•åœ¨NumPyndarrayä¸­ï¼‰æ—¶ï¼Œå°†è§¦å‘å…¨å±€è§£é‡Šå™¨é”ï¼Œä»è€Œä½¿æ‰€æœ‰GPUé˜»å¡ã€‚æœ€å¥½æ˜¯åœ¨GPUå†…å­˜ä¸­ä¸ºæ—¥å¿—åˆ†é…ä¸“é—¨çš„ç©ºé—´ï¼Œå°†å°æ‰¹é‡çš„æŸå¤±ç´¯ç§¯åˆ°è¾ƒå¤§çš„æ—¥å¿—ä¸­ï¼Œåªæœ‰åœ¨å¿…è¦æ—¶æ‰å°†æ•´ä¸ªæ—¥å¿—ç§»åŠ¨åˆ°CPUè¿›è¡Œæ‰“å°æˆ–è®°å½•ã€‚</li></ol><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">try_gpu</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›gpu(i)ï¼Œå¦åˆ™è¿”å›cpu()"""</span>    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cuda:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">try_all_gpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è¿”å›æ‰€æœ‰å¯ç”¨çš„GPUï¼Œå¦‚æœæ²¡æœ‰GPUï¼Œåˆ™è¿”å›[cpu(),]"""</span>    devices <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cuda:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>             <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">return</span> devices <span class="token keyword">if</span> devices <span class="token keyword">else</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># å¼ é‡</span>X <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> device<span class="token operator">=</span>try_gpu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># GPU0 ä¸Šåˆ›å»ºå¼ é‡</span>Y <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> device<span class="token operator">=</span>try_gpu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># GPU1 ä¸Šåˆ›å»ºå¼ é‡</span><span class="token comment"># å¦‚æœè¦è®¡ç®— X + Yï¼Œæˆ‘ä»¬éœ€è¦å†³å®šåœ¨å“ªé‡Œå­˜å‚¨ç»“æœï¼Œä¸èƒ½ç®€å•çš„ä½¿ç”¨ X + Y</span>Z <span class="token operator">=</span> X<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>X <span class="token operator">+</span> Y<span class="token punctuation">)</span> <span class="token comment"># å¼‚å¸¸</span><span class="token keyword">print</span><span class="token punctuation">(</span>Z <span class="token operator">+</span> Y<span class="token punctuation">)</span> <span class="token comment"># æ­£å¸¸</span><span class="token comment"># æ¨¡å‹</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>net <span class="token operator">=</span> net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>try_gpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><ol type="1"><li>æ‹·è´æ“ä½œè¦æ ¼å¤–å°å¿ƒã€‚æ ¹æ®ç»éªŒï¼Œå¤šä¸ªå°æ“ä½œæ¯”ä¸€ä¸ªå¤§æ“ä½œç³Ÿç³•å¾—å¤šï¼Œä¸€æ¬¡æ‰§è¡Œå‡ ä¸ªæ“ä½œæ¯”ä»£ç ä¸­æ•£å¸ƒçš„è®¸å¤šå•ä¸ªæ“ä½œè¦å¥½å¾—å¤šã€‚</li><li>å½“æ‰“å°å¼ é‡æˆ–å°†å¼ é‡è½¬æ¢ä¸ºNumPyæ ¼å¼æ—¶ï¼Œå¦‚æœæ•°æ®ä¸åœ¨CPUå†…å­˜ä¸­ï¼Œæ¡†æ¶ä¼šé¦–å…ˆå°†å…¶å¤åˆ¶åˆ°å†…å­˜ä¸­ï¼Œè¿™ä¼šå¯¼è‡´é¢å¤–çš„ä¼ è¾“å¼€é”€ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 4 å¤šå±‚æ„ŸçŸ¥æœº</title>
      <link href="/2024/06/26/DL/4%20%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/"/>
      <url>/2024/06/26/DL/4%20%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="å¤šå±‚æ„ŸçŸ¥æœº">4 å¤šå±‚æ„ŸçŸ¥æœº</h2><p>æœ€ç®€å•çš„æ·±åº¦ç½‘ç»œç§°ä¸ºå¤šå±‚æ„ŸçŸ¥æœºã€‚å¤šå±‚æ„ŸçŸ¥æœºç”±å¤šå±‚ç¥ç»å…ƒç»„æˆï¼Œæ¯ä¸€å±‚ä¸å®ƒçš„ä¸Šä¸€å±‚ç›¸è¿ï¼Œä»ä¸­æ¥æ”¶è¾“å…¥ï¼›åŒæ—¶æ¯ä¸€å±‚ä¹Ÿä¸å®ƒçš„ä¸‹ä¸€å±‚ç›¸è¿ï¼Œå½±å“å½“å‰å±‚çš„ç¥ç»å…ƒã€‚</p><h3 id="å¤šå±‚æ„ŸçŸ¥æœº-1">4.1 å¤šå±‚æ„ŸçŸ¥æœº</h3><p>å¤šå±‚æ„ŸçŸ¥æœºåœ¨è¾“å‡ºå±‚å’Œè¾“å…¥å±‚ä¹‹é—´å¢åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…¨è¿æ¥éšè—å±‚ï¼Œå¹¶é€šè¿‡æ¿€æ´»å‡½æ•°è½¬æ¢éšè—å±‚çš„è¾“å‡ºã€‚</p><h4 id="éšè—å±‚">4.1.1 éšè—å±‚</h4><h5 id="çº¿æ€§æ¨¡å‹çš„å±€é™æ€§">4.1.1.1 çº¿æ€§æ¨¡å‹çš„å±€é™æ€§</h5><p>çº¿æ€§æ¨¡å‹çš„ä¸€ä¸ªä¸»è¦å±€é™æ€§æ˜¯å®ƒä»¬åªèƒ½è¡¨ç¤ºè¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„ç®€å•å…³ç³»ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æ¨¡æ‹Ÿæ›´å¤æ‚çš„éçº¿æ€§å…³ç³»ï¼Œå°±éœ€è¦æ›´å¤æ‚çš„æ¨¡å‹ã€‚</p><h5 id="åœ¨ç½‘ç»œä¸­åŠ å…¥éšè—å±‚">4.1.1.2 åœ¨ç½‘ç»œä¸­åŠ å…¥éšè—å±‚</h5><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç½‘ç»œä¸­åŠ å…¥ä¸€ä¸ªæˆ–å¤šä¸ªéšè—å±‚æ¥å…‹æœçº¿æ€§æ¨¡å‹çš„é™åˆ¶ï¼Œä½¿å…¶èƒ½å¤„ç†æ›´æ™®éçš„å‡½æ•°å…³ç³»ç±»å‹ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†è®¸å¤šå…¨è¿æ¥å±‚å †å åœ¨ä¸€èµ·ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå‰<spanclass="math inline">\(L-1\)</span>å±‚çœ‹ä½œè¡¨ç¤ºï¼ŒæŠŠæœ€åä¸€å±‚çœ‹ä½œçº¿æ€§é¢„æµ‹å™¨ã€‚è¿™ç§æ¶æ„é€šå¸¸ç§°ä¸ºå¤šå±‚æ„ŸçŸ¥æœºï¼ˆmultilayer perceptronï¼‰ï¼Œé€šå¸¸ç¼©å†™ä¸ºMLPã€‚</p><figure><img src="./images/4.1_multilayer-perceptron.svg"title="å›¾4.1ï¼šå¤šå±‚æ„ŸçŸ¥æœº" alt="å¤šå±‚æ„ŸçŸ¥æœº" /><figcaption aria-hidden="true">å¤šå±‚æ„ŸçŸ¥æœº</figcaption></figure><p>è¿™ä¸ªå¤šå±‚æ„ŸçŸ¥æœºæœ‰4ä¸ªè¾“å…¥ï¼Œ3ä¸ªè¾“å‡ºï¼Œå…¶éšè—å±‚åŒ…å«5ä¸ªéšè—å•å…ƒã€‚è¾“å…¥å±‚ä¸æ¶‰åŠä»»ä½•è®¡ç®—ï¼Œå› æ­¤ä½¿ç”¨æ­¤ç½‘ç»œäº§ç”Ÿè¾“å‡ºåªéœ€è¦å®ç°éšè—å±‚å’Œè¾“å‡ºå±‚çš„è®¡ç®—ã€‚å› æ­¤ï¼Œè¿™ä¸ªå¤šå±‚æ„ŸçŸ¥æœºä¸­çš„å±‚æ•°ä¸º2ã€‚ æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå±‚éƒ½æ˜¯å…¨è¿æ¥çš„ã€‚æ¯ä¸ªè¾“å…¥éƒ½ä¼šå½±å“éšè—å±‚ä¸­çš„æ¯ä¸ªç¥ç»å…ƒï¼Œè€Œéšè—å±‚ä¸­çš„æ¯ä¸ªç¥ç»å…ƒåˆä¼šå½±å“è¾“å‡ºå±‚ä¸­çš„æ¯ä¸ªç¥ç»å…ƒã€‚</p><p>ç„¶è€Œï¼Œå…·æœ‰å…¨è¿æ¥å±‚çš„å¤šå±‚æ„ŸçŸ¥æœºçš„å‚æ•°å¼€é”€å¯èƒ½ä¼šé«˜å¾—ä»¤äººæœ›è€Œå´æ­¥ã€‚å³ä½¿åœ¨ä¸æ”¹å˜è¾“å…¥æˆ–è¾“å‡ºå¤§å°çš„æƒ…å†µä¸‹ï¼Œéœ€è¦åœ¨å‚æ•°èŠ‚çº¦å’Œæ¨¡å‹æœ‰æ•ˆæ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</p><h5 id="ä»çº¿æ€§åˆ°éçº¿æ€§">4.1.1.3 ä»çº¿æ€§åˆ°éçº¿æ€§</h5><p>å³ä½¿åœ¨æ·»åŠ éšè—å±‚åï¼ŒæŒ‰ç…§ä¹‹å‰çš„é€»è¾‘ï¼Œæˆ‘ä»¬çš„è¾“å‡ºä»ç„¶æ˜¯è¾“å…¥çš„çº¿æ€§ç»„åˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿æˆ‘ä»¬æœ‰æ— é™å¤šçš„éšè—å±‚ï¼Œå¤šå±‚æ„ŸçŸ¥æœºä»ç„¶ç­‰åŒäºçº¿æ€§æ¨¡å‹ã€‚</p><p>åŸå› å¦‚ä¸‹:</p><p><span class="math display">\[\begin{gathered}\mathbf{H} &amp; = \mathbf{X} \mathbf{W}^{(1)} + \mathbf{b}^{(1)}, \\\mathbf{O} &amp; = \mathbf{H}\mathbf{W}^{(2)} + \mathbf{b}^{(2)}.\end{gathered}\tag{4.1}\]</span></p><p>å…¶ä¸­<span class="math inline">\(X\)</span>è¡¨ç¤ºè¾“å…¥ï¼Œ<spanclass="math inline">\(H\)</span>è¡¨ç¤ºéšè—å±‚çš„è¾“å‡ºï¼Œ<spanclass="math inline">\(O\)</span>è¡¨ç¤ºè¾“å‡ºå±‚çš„è¾“å‡ºï¼Œ<spanclass="math inline">\(\mathbf{W}^{(1)}\)</span>å’Œ<spanclass="math inline">\(\mathbf{W}^{(2)}\)</span>æ˜¯æƒé‡å‚æ•°ï¼Œ<spanclass="math inline">\(\mathbf{b}^{(1)}\)</span>å’Œ<spanclass="math inline">\(\mathbf{b}^{(2)}\)</span>æ˜¯åç½®å‚æ•°ã€‚</p><p>ä¸Šé¢çš„éšè—å•å…ƒç”±è¾“å…¥<spanclass="math inline">\(X\)</span>çš„ä»¿å°„å‡½æ•°ç»™å‡ºï¼Œ è€Œè¾“å‡º<spanclass="math inline">\(O\)</span>ï¼ˆsoftmaxæ“ä½œå‰ï¼‰åªæ˜¯éšè—å•å…ƒ<spanclass="math inline">\(H\)</span>çš„ä»¿å°„å‡½æ•°ã€‚ä»¿å°„å‡½æ•°çš„ä»¿å°„å‡½æ•°æœ¬èº«å°±æ˜¯ä»¿å°„å‡½æ•°ï¼Œ æ‰€ä»¥è¿™å’Œçº¿æ€§æ¨¡å‹æ²¡æœ‰åŒºåˆ«ã€‚</p><p><strong>å¼•å…¥å…³é”®å› ç´ </strong>:åœ¨ä»¿å°„å˜æ¢ä¹‹åå¯¹æ¯ä¸ªéšè—å•å…ƒåº”ç”¨éçº¿æ€§çš„æ¿€æ´»å‡½æ•°<spanclass="math inline">\(\sigma\)</span></p><p><span class="math display">\[\begin{gathered}\mathbf{H} &amp; = \sigma(\mathbf{X} \mathbf{W}^{(1)} +\mathbf{b}^{(1)}), \\\mathbf{O} &amp; = \mathbf{H}\mathbf{W}^{(2)} + \mathbf{b}^{(2)}.\\\end{gathered}\tag{4.2}\]</span></p><h5 id="é€šç”¨è¿‘ä¼¼å®šç†">4.1.1.4 é€šç”¨è¿‘ä¼¼å®šç†</h5><p>å¤šå±‚æ„ŸçŸ¥æœºå¯ä»¥é€šè¿‡éšè—ç¥ç»å…ƒï¼Œæ•æ‰åˆ°è¾“å…¥ä¹‹é—´å¤æ‚çš„ç›¸äº’ä½œç”¨ï¼Œè¿™äº›ç¥ç»å…ƒä¾èµ–äºæ¯ä¸ªè¾“å…¥çš„å€¼ã€‚</p><h4 id="æ¿€æ´»å‡½æ•°">4.1.2 æ¿€æ´»å‡½æ•°</h4><p>æ¿€æ´»å‡½æ•°é€šè¿‡<strong>è®¡ç®—åŠ æƒå’Œ</strong>å¹¶åŠ ä¸Š<strong>åç½®</strong>æ¥ç¡®å®šç¥ç»å…ƒæ˜¯å¦åº”è¯¥è¢«æ¿€æ´»ï¼Œå®ƒä»¬å°†è¾“å…¥ä¿¡å·è½¬æ¢ä¸ºè¾“å‡ºçš„å¯å¾®è¿ç®—ã€‚å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°åŒ…æ‹¬<strong>ReLUå‡½æ•°ã€sigmoidå‡½æ•°å’Œtanhå‡½æ•°</strong>ã€‚</p><p>å…¶å‡½æ•°å’Œå¯¼æ•°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/4.2_activation-functions.svg" title="å›¾4.2ï¼šæ¿€æ´»å‡½æ•°"alt="æ¿€æ´»å‡½æ•°" /><figcaption aria-hidden="true">æ¿€æ´»å‡½æ•°</figcaption></figure><p>ç»˜å›¾ä»£ç è§<a href="#é™„å½•aæ¿€æ´»å‡½æ•°ç»˜å›¾ä»£ç ">é™„å½•A</a>ã€‚</p><h5 id="reluå‡½æ•°ä¿®æ­£çº¿æ€§å•å…ƒ">4.1.2.1 ReLUå‡½æ•°(ä¿®æ­£çº¿æ€§å•å…ƒ)</h5><p>ReLUå‡½æ•°ä»…ä¿ç•™æ­£å…ƒç´ å¹¶ä¸¢å¼ƒæ‰€æœ‰è´Ÿå…ƒç´ ï¼Œç»™å®šå…ƒç´ <spanclass="math inline">\(x\)</span>ï¼ŒReLUå‡½æ•°è¢«å®šä¹‰ä¸ºè¯¥å…ƒç´ ä¸<spanclass="math inline">\(0\)</span>çš„æœ€å¤§å€¼ï¼š</p><p><span class="math display">\[\begin{equation}\begin{gathered}\operatorname{ReLU}(x) = \max(x, 0).\end{gathered}\end{equation}\tag{4.3}\]</span></p><p>ä½¿ç”¨ReLUçš„åŸå› æ˜¯ï¼Œå®ƒæ±‚å¯¼è¡¨ç°å¾—ç‰¹åˆ«å¥½ï¼š<strong>è¦ä¹ˆè®©å‚æ•°æ¶ˆå¤±ï¼Œè¦ä¹ˆè®©å‚æ•°é€šè¿‡</strong>ã€‚è¿™ä½¿å¾—ä¼˜åŒ–è¡¨ç°å¾—æ›´å¥½ï¼Œå¹¶ä¸”<strong>ReLUå‡è½»äº†å›°æ‰°ä»¥å¾€ç¥ç»ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</strong>ã€‚</p><p>**æ³¨æ„ï¼ŒReLUå‡½æ•°æœ‰è®¸å¤šå˜ä½“ï¼ŒåŒ…æ‹¬å‚æ•°åŒ–ReLUï¼ˆpReLUï¼‰ å‡½æ•°ã€‚è¯¥å˜ä½“ä¸ºReLUæ·»åŠ äº†ä¸€ä¸ªçº¿æ€§é¡¹ï¼Œå› æ­¤å³ä½¿å‚æ•°æ˜¯è´Ÿçš„ï¼ŒæŸäº›ä¿¡æ¯ä»ç„¶å¯ä»¥é€šè¿‡ï¼š*</p><p><span class="math display">\[\begin{equation}\begin{gathered}\operatorname{pReLU}(x) = \max(0, x) + \alpha \min(0, x).\end{gathered}\end{equation}\tag{4.4}\]</span></p><h5 id="sigmoidå‡½æ•°æŒ¤å‹å‡½æ•°">4.1.2.2 sigmoidå‡½æ•°(æŒ¤å‹å‡½æ•°)</h5><p>sigmoidå‡½æ•°å°†èŒƒå›´ <span class="math inline">\((-inf, inf)\)</span>ä¸­çš„ä»»æ„è¾“å…¥å‹ç¼©åˆ°åŒºé—´ <span class="math inline">\((0, 1)\)</span>ä¸­çš„æŸä¸ªå€¼ï¼š</p><p><span class="math display">\[\begin{equation}\begin{gathered}\operatorname{sigmoid}(x) = \frac{1}{1 + \exp(-x)}.\end{gathered}\end{equation}\tag{4.5}\]</span></p><p>å½“æˆ‘ä»¬æƒ³è¦å°†è¾“å‡ºè§†ä½œ<strong>äºŒå…ƒåˆ†ç±»</strong>é—®é¢˜çš„æ¦‚ç‡æ—¶ï¼Œsigmoidä»ç„¶è¢«å¹¿æ³›ç”¨ä½œè¾“å‡ºå•å…ƒä¸Šçš„æ¿€æ´»å‡½æ•°ï¼ˆ<strong>sigmoidå¯ä»¥è§†ä¸ºsoftmaxçš„ç‰¹ä¾‹</strong>ï¼‰ã€‚ç„¶è€Œï¼Œsigmoidåœ¨<strong>éšè—å±‚ä¸­å·²ç»è¾ƒå°‘ä½¿ç”¨</strong>ï¼Œå®ƒåœ¨å¤§éƒ¨åˆ†æ—¶å€™è¢«æ›´ç®€å•ã€æ›´å®¹æ˜“è®­ç»ƒçš„<strong>ReLUæ‰€å–ä»£</strong>ã€‚</p><h5 id="tanhå‡½æ•°åŒæ›²æ­£åˆ‡å‡½æ•°">4.1.2.3 tanhå‡½æ•°(åŒæ›²æ­£åˆ‡å‡½æ•°)</h5><p>tanhå‡½æ•°ä¹Ÿèƒ½å°†å…¶è¾“å…¥å‹ç¼©è½¬æ¢åˆ°åŒºé—´<span class="math inline">\((-1,1)\)</span>ä¸Š:</p><p><span class="math display">\[\begin{equation}\begin{gathered}\operatorname{tanh}(x) = \frac{1 - \exp(-2x)}{1 + \exp(-2x)}.\end{gathered}\end{equation}\tag{4.6}\]</span></p><h3 id="å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°">4.2 å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token comment"># 4.2.3 æ¿€æ´»å‡½æ•°</span><span class="token keyword">def</span> <span class="token function">relu</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>X<span class="token punctuation">)</span>    <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token comment"># 4.2.4 æ¨¡å‹</span><span class="token keyword">def</span> <span class="token function">net</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># å› ä¸ºå¿½ç•¥äº†ç©ºé—´ç»“æ„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨reshapeå°†æ¯ä¸ªäºŒç»´å›¾åƒè½¬æ¢ä¸ºä¸€ä¸ªé•¿åº¦ä¸ºnum_inputsçš„å‘é‡</span>    X <span class="token operator">=</span> X<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> num_inputs<span class="token punctuation">)</span><span class="token punctuation">)</span>    H <span class="token operator">=</span> relu<span class="token punctuation">(</span>X@W1 <span class="token operator">+</span> b1<span class="token punctuation">)</span>  <span class="token comment"># è¿™é‡Œâ€œ@â€ä»£è¡¨çŸ©é˜µä¹˜æ³•</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>H@W2 <span class="token operator">+</span> b2<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment"># 4.2 å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°</span>    <span class="token comment"># 4.2.1 è¯»å–æ•°æ®</span>    batch_size <span class="token operator">=</span> <span class="token number">256</span>    train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_data_fashion_mnist<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>    <span class="token comment"># 4.2.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span>    num_inputs<span class="token punctuation">,</span> num_outputs<span class="token punctuation">,</span> num_hiddens <span class="token operator">=</span> <span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">256</span>    W1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>        num_inputs<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01</span><span class="token punctuation">)</span>    b1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_hiddens<span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    W2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>        num_hiddens<span class="token punctuation">,</span> num_outputs<span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01</span><span class="token punctuation">)</span>    b2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_outputs<span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    params <span class="token operator">=</span> <span class="token punctuation">[</span>W1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> W2<span class="token punctuation">,</span> b2<span class="token punctuation">]</span>    <span class="token comment"># 4.2.3 æ¿€æ´»å‡½æ•°</span>    <span class="token comment"># 4.2.4 æ¨¡å‹</span>    <span class="token comment"># 4.2.5 æŸå¤±å‡½æ•°</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token comment"># reduction='none'è¡¨ç¤ºç›´æ¥è¿”å›æ¯ä¸ªæ ·æœ¬çš„æŸå¤±ï¼Œå…¶ä»–æœ‰sumã€mean</span>    <span class="token comment"># 4.2.6 è®­ç»ƒ</span>    num_epochs<span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0.1</span>    updater <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>    d2l<span class="token punctuation">.</span>train_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> updater<span class="token punctuation">)</span>    <span class="token comment"># 4.2.7 é¢„æµ‹</span>    d2l<span class="token punctuation">.</span>predict_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">)</span></code></pre><h3 id="å¤šå±‚æ„ŸçŸ¥æœºçš„ç®€æ´å®ç°">4.3 å¤šå±‚æ„ŸçŸ¥æœºçš„ç®€æ´å®ç°</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment"># 4.3 å¤šå±‚æ„ŸçŸ¥æœºçš„ç®€æ´å®ç°</span>    <span class="token comment"># 4.3.1 å®šä¹‰æ¨¡å‹</span>    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment"># å°†è¾“å…¥çš„å¤šç»´å¼ é‡è½¬æ¢ä¸ºä¸€ç»´å¼ é‡</span>                        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># å…¨è¿æ¥å±‚</span>                        nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment"># æ¿€æ´»å‡½æ•°</span>                        nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># å…¨è¿æ¥å±‚</span>    <span class="token comment"># 4.3.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span>    <span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">:</span>            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>init_weights<span class="token punctuation">)</span>    <span class="token comment"># 4.3.3 è¯»å–æ•°æ®å¹¶è®­ç»ƒæ¨¡å‹</span>    batch_size<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> num_epochs <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">10</span>    train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_data_fashion_mnist<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>    d2l<span class="token punctuation">.</span>train_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span>    <span class="token comment"># 4.3.4 é¢„æµ‹</span>    d2l<span class="token punctuation">.</span>predict_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">)</span></code></pre><h3 id="æ¨¡å‹é€‰æ‹©æ¬ æ‹Ÿåˆå’Œè¿‡æ‹Ÿåˆ">4.4 æ¨¡å‹é€‰æ‹©ã€æ¬ æ‹Ÿåˆå’Œè¿‡æ‹Ÿåˆ</h3><p>å¦‚ä½•å‘ç°å¯ä»¥<strong>æ³›åŒ–</strong>çš„æ¨¡å¼æ˜¯æœºå™¨å­¦ä¹ çš„æ ¹æœ¬é—®é¢˜ã€‚</p><h4 id="è®­ç»ƒè¯¯å·®å’Œæ³›åŒ–è¯¯å·®">4.4.1 è®­ç»ƒè¯¯å·®å’Œæ³›åŒ–è¯¯å·®</h4><p>è®­ç»ƒè¯¯å·®æ˜¯æŒ‡ï¼Œ æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®é›†ä¸Šè®¡ç®—å¾—åˆ°çš„è¯¯å·®ã€‚ æ³›åŒ–è¯¯å·®æ˜¯æŒ‡ï¼Œæ¨¡å‹åº”ç”¨åœ¨åŒæ ·ä»åŸå§‹æ ·æœ¬çš„åˆ†å¸ƒä¸­æŠ½å–çš„æ— é™å¤šæ•°æ®æ ·æœ¬æ—¶ï¼Œæ¨¡å‹è¯¯å·®çš„æœŸæœ›ã€‚(å®é™…ä¸­åªèƒ½é€šè¿‡æµ‹è¯•æ•°æ®é›†æ¥è¿‘ä¼¼ä¼°è®¡æ³›åŒ–è¯¯å·®)</p><p>å‡ ä¸ªå€¾å‘äºå½±å“æ¨¡å‹æ³›åŒ–çš„å› ç´ :</p><ol type="1"><li>å¯è°ƒæ•´å‚æ•°çš„æ•°é‡ã€‚å½“å¯è°ƒæ•´å‚æ•°çš„æ•°é‡ï¼ˆæœ‰æ—¶ç§°ä¸ºè‡ªç”±åº¦ï¼‰å¾ˆå¤§æ—¶ï¼Œæ¨¡å‹å¾€å¾€æ›´å®¹æ˜“è¿‡æ‹Ÿåˆã€‚</li><li>å‚æ•°é‡‡ç”¨çš„å€¼ã€‚å½“æƒé‡çš„å–å€¼èŒƒå›´è¾ƒå¤§æ—¶ï¼Œæ¨¡å‹å¯èƒ½æ›´å®¹æ˜“è¿‡æ‹Ÿåˆã€‚</li><li>è®­ç»ƒæ ·æœ¬çš„æ•°é‡ã€‚å³ä½¿æ¨¡å‹å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆå®¹æ˜“è¿‡æ‹ŸåˆåªåŒ…å«ä¸€ä¸¤ä¸ªæ ·æœ¬çš„æ•°æ®é›†ã€‚è€Œè¿‡æ‹Ÿåˆä¸€ä¸ªæœ‰æ•°ç™¾ä¸‡ä¸ªæ ·æœ¬çš„æ•°æ®é›†åˆ™éœ€è¦ä¸€ä¸ªæå…¶çµæ´»çš„æ¨¡å‹ã€‚</li></ol><h4 id="æ¨¡å‹é€‰æ‹©">4.4.2 æ¨¡å‹é€‰æ‹©</h4><p>è®­ç»ƒé›†: ç”¨äºè®­ç»ƒæ¨¡å‹çš„æ•°æ®é›† éªŒè¯é›†: ç”¨äºè°ƒæ•´æ¨¡å‹è¶…å‚æ•°çš„æ•°æ®é›†æµ‹è¯•é›†: ç”¨äºè¯„ä¼°æ¨¡å‹æ³›åŒ–è¯¯å·®çš„æ•°æ®é›†</p><table><thead><tr><th>æ•°æ®é›†</th><th>ç”¨é€”</th><th>å‚ä¸è®­ç»ƒ</th><th>ç”¨æ¥è°ƒå‚</th><th>ç”¨æ¥è¯„ä¼°æœ€ç»ˆæ€§èƒ½</th></tr></thead><tbody><tr><td><strong>è®­ç»ƒé›†</strong></td><td>æ‹¿æ¥è®­ç»ƒæ¨¡å‹</td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âŒ å¦</td></tr><tr><td><strong>éªŒè¯é›†</strong></td><td>æ‹¿æ¥é€‰æ¨¡å‹/è°ƒå‚æ•°</td><td>âŒ å¦</td><td>âœ… æ˜¯</td><td>âŒ å¦</td></tr><tr><td><strong>æµ‹è¯•é›†</strong></td><td>æ‹¿æ¥æœ€ç»ˆè¯„ä¼°</td><td>âŒ å¦</td><td>âŒ å¦</td><td>âœ… æ˜¯</td></tr></tbody></table><p>ï¼ˆä½†ç°å®æ˜¯éªŒè¯æ•°æ®å’Œæµ‹è¯•æ•°æ®ä¹‹é—´çš„è¾¹ç•Œæ¨¡ç³Šå¾—ä»¤äººæ‹…å¿§ã€‚ï¼‰</p><p>å½“è®­ç»ƒæ•°æ®ç¨€ç¼ºæ—¶ï¼Œæˆ‘ä»¬ç”šè‡³å¯èƒ½æ— æ³•æä¾›è¶³å¤Ÿçš„æ•°æ®æ¥æ„æˆä¸€ä¸ªåˆé€‚çš„éªŒè¯é›†ã€‚è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªæµè¡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯<strong>é‡‡ç”¨<spanclass="math inline">\(K\)</span>æŠ˜äº¤å‰éªŒè¯</strong>ã€‚è¿™é‡Œï¼ŒåŸå§‹è®­ç»ƒæ•°æ®è¢«åˆ†æˆ<spanclass="math inline">\(K\)</span>ä¸ªä¸é‡å çš„å­é›†ã€‚ ç„¶åæ‰§è¡Œ<spanclass="math inline">\(K\)</span>æ¬¡æ¨¡å‹è®­ç»ƒå’ŒéªŒè¯ï¼Œæ¯æ¬¡åœ¨<spanclass="math inline">\(K-1\)</span>ä¸ªå­é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼Œå¹¶åœ¨å‰©ä½™çš„ä¸€ä¸ªå­é›†ï¼ˆåœ¨è¯¥è½®ä¸­æ²¡æœ‰ç”¨äºè®­ç»ƒçš„å­é›†ï¼‰ä¸Šè¿›è¡ŒéªŒè¯ã€‚æœ€åï¼Œé€šè¿‡å¯¹<spanclass="math inline">\(K\)</span>æ¬¡å®éªŒçš„ç»“æœå–å¹³å‡æ¥ä¼°è®¡è®­ç»ƒå’ŒéªŒè¯è¯¯å·®ã€‚</p><h4 id="æ¬ æ‹Ÿåˆå’Œè¿‡æ‹Ÿåˆ">4.4.3 æ¬ æ‹Ÿåˆå’Œè¿‡æ‹Ÿåˆ</h4><p><strong>æ¬ æ‹Ÿåˆ</strong> è®­ç»ƒè¯¯å·®å’ŒéªŒè¯è¯¯å·®éƒ½å¾ˆä¸¥é‡ï¼Œä½†å®ƒä»¬ä¹‹é—´ä»…æœ‰ä¸€ç‚¹å·®è·ã€‚å¦‚æœ<strong>æ¨¡å‹ä¸èƒ½é™ä½è®­ç»ƒè¯¯å·®</strong>ï¼Œè¿™å¯èƒ½æ„å‘³ç€æ¨¡å‹è¿‡äºç®€å•ï¼ˆå³è¡¨è¾¾èƒ½åŠ›ä¸è¶³ï¼‰ï¼Œæ— æ³•æ•è·è¯•å›¾å­¦ä¹ çš„æ¨¡å¼ã€‚æ­¤å¤–ï¼Œç”±äºæˆ‘ä»¬çš„è®­ç»ƒå’ŒéªŒè¯è¯¯å·®ä¹‹é—´çš„æ³›åŒ–è¯¯å·®å¾ˆå°ï¼Œæˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡å¯ä»¥ç”¨ä¸€ä¸ªæ›´å¤æ‚çš„æ¨¡å‹é™ä½è®­ç»ƒè¯¯å·®ã€‚</p><p><strong>è¿‡æ‹Ÿåˆ</strong> å½“æˆ‘ä»¬çš„è®­ç»ƒè¯¯å·®æ˜æ˜¾ä½äºéªŒè¯è¯¯å·®æ—¶è¦å°å¿ƒï¼Œè¿™è¡¨æ˜ä¸¥é‡çš„è¿‡æ‹Ÿåˆã€‚ <strong>æ³¨æ„ï¼Œè¿‡æ‹Ÿåˆå¹¶ä¸æ€»æ˜¯ä¸€ä»¶åäº‹ã€‚</strong>ç‰¹åˆ«æ˜¯åœ¨æ·±åº¦å­¦ä¹ é¢†åŸŸï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œæœ€å¥½çš„é¢„æµ‹æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¡¨ç°å¾€å¾€æ¯”åœ¨ä¿ç•™ï¼ˆéªŒè¯ï¼‰æ•°æ®ä¸Šå¥½å¾—å¤šã€‚<strong>æœ€ç»ˆï¼Œæˆ‘ä»¬é€šå¸¸æ›´å…³å¿ƒéªŒè¯è¯¯å·®ï¼Œè€Œä¸æ˜¯è®­ç»ƒè¯¯å·®å’ŒéªŒè¯è¯¯å·®ä¹‹é—´çš„å·®è·ã€‚</strong></p><p><strong><em>æ˜¯å¦è¿‡æ‹Ÿåˆæˆ–æ¬ æ‹Ÿåˆå¯èƒ½å–å†³äºæ¨¡å‹å¤æ‚æ€§å’Œå¯ç”¨è®­ç»ƒæ•°æ®é›†çš„å¤§å°</em></strong></p><h5 id="æ¨¡å‹å¤æ‚æ€§">4.4.3.1 æ¨¡å‹å¤æ‚æ€§</h5><p>æ¯”å¦‚ä¸€ä¸ªçº¿æ€§å›å½’æ¨¡å‹çš„æ‹Ÿåˆ(ç‰¹å¾æ˜¯<spanclass="math inline">\(x\)</span>çš„å¹‚ç»™å‡ºçš„ï¼Œ æ¨¡å‹çš„æƒé‡æ˜¯<spanclass="math inline">\(w_i\)</span>ç»™å‡ºçš„ï¼Œåç½®æ˜¯<spanclass="math inline">\(w_0\)</span>ç»™å‡º):</p><p><span class="math display">\[\begin{equation}\begin{gathered}\hat{y}= \sum_{i=0}^d x^i w_i\end{gathered}\end{equation}\tag{4.7}\]</span></p><p>é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ¯”ä½é˜¶å¤šé¡¹å¼å‡½æ•°å¤æ‚å¾—å¤šã€‚é«˜é˜¶å¤šé¡¹å¼çš„å‚æ•°è¾ƒå¤šï¼Œæ¨¡å‹å‡½æ•°çš„é€‰æ‹©èŒƒå›´è¾ƒå¹¿ã€‚å› æ­¤åœ¨å›ºå®šè®­ç»ƒæ•°æ®é›†çš„æƒ…å†µä¸‹ï¼Œé«˜é˜¶å¤šé¡¹å¼å‡½æ•°ç›¸å¯¹äºä½é˜¶å¤šé¡¹å¼çš„è®­ç»ƒè¯¯å·®åº”è¯¥å§‹ç»ˆæ›´ä½ï¼ˆæœ€åä¹Ÿæ˜¯ç›¸ç­‰ï¼‰ã€‚äº‹å®ä¸Šï¼Œå½“æ•°æ®æ ·æœ¬åŒ…å«äº†<spanclass="math inline">\(x\)</span>çš„ä¸åŒå€¼æ—¶ï¼Œå‡½æ•°é˜¶æ•°ç­‰äºæ•°æ®æ ·æœ¬æ•°é‡çš„å¤šé¡¹å¼å‡½æ•°å¯ä»¥å®Œç¾æ‹Ÿåˆè®­ç»ƒé›†ã€‚</p><p>æ¨¡å‹çš„é€‰æ‹©å’Œæ‹Ÿåˆæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="./images/4.3_model-complexity-vs-dataset-size.svg"title="å›¾4.3ï¼šæ¨¡å‹å¤æ‚åº¦å¯¹æ¬ æ‹Ÿåˆå’Œè¿‡æ‹Ÿåˆçš„å½±å“"alt="æ¨¡å‹çš„é€‰æ‹©å’Œæ‹Ÿåˆæƒ…å†µ" /><figcaption aria-hidden="true">æ¨¡å‹çš„é€‰æ‹©å’Œæ‹Ÿåˆæƒ…å†µ</figcaption></figure><h5 id="æ•°æ®é›†å¤§å°">4.4.3.2 æ•°æ®é›†å¤§å°</h5><p>è®­ç»ƒæ•°æ®é›†ä¸­çš„æ ·æœ¬è¶Šå°‘ï¼Œæˆ‘ä»¬å°±è¶Šæœ‰å¯èƒ½ï¼ˆä¸”æ›´ä¸¥é‡åœ°ï¼‰è¿‡æ‹Ÿåˆã€‚éšç€è®­ç»ƒæ•°æ®é‡çš„å¢åŠ ï¼Œæ³›åŒ–è¯¯å·®é€šå¸¸ä¼šå‡å°ã€‚</p><h4 id="å¤šé¡¹å¼å›å½’">4.4.4 å¤šé¡¹å¼å›å½’</h4><p>é€šè¿‡å¤šé¡¹å¼æ‹Ÿåˆæ¥æ¢ç´¢è¿™äº›æ¦‚å¿µ</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> math<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token keyword">def</span> <span class="token function">evaluate_loss</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> data_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># @save</span>    <span class="token triple-quoted-string string">"""è¯„ä¼°ç»™å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„æŸå¤±"""</span>    metric <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Accumulator<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># æŸå¤±çš„æ€»å’Œ,æ ·æœ¬æ•°é‡</span>    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>        out <span class="token operator">=</span> net<span class="token punctuation">(</span>X<span class="token punctuation">)</span>        y <span class="token operator">=</span> y<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>out<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>        l <span class="token operator">=</span> loss<span class="token punctuation">(</span>out<span class="token punctuation">,</span> y<span class="token punctuation">)</span>        metric<span class="token punctuation">.</span>add<span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> metric<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>train_features<span class="token punctuation">,</span> test_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span> test_labels<span class="token punctuation">,</span>          num_epochs<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span>    input_shape <span class="token operator">=</span> train_features<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token comment"># ä¸è®¾ç½®åç½®ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨å¤šé¡¹å¼ä¸­å®ç°äº†å®ƒ</span>    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_shape<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    batch_size <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> train_labels<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    train_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span><span class="token punctuation">(</span>train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                batch_size<span class="token punctuation">)</span>    test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span><span class="token punctuation">(</span>test_features<span class="token punctuation">,</span> test_labels<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                               batch_size<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    trainer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>    animator <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Animator<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">'epoch'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">,</span> yscale<span class="token operator">=</span><span class="token string">'log'</span><span class="token punctuation">,</span>                            xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span> ylim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1e-3</span><span class="token punctuation">,</span> <span class="token number">1e2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                            legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        d2l<span class="token punctuation">.</span>train_epoch_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> trainer<span class="token punctuation">)</span>        <span class="token keyword">if</span> epoch <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">20</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            animator<span class="token punctuation">.</span>add<span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>evaluate_loss<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">,</span>                                     evaluate_loss<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'weight:'</span><span class="token punctuation">,</span> net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># 1. ç”Ÿæˆæ•°æ®é›†</span>    max_degree <span class="token operator">=</span> <span class="token number">20</span>  <span class="token comment"># å¤šé¡¹å¼çš„æœ€å¤§é˜¶æ•°</span>    n_train<span class="token punctuation">,</span> n_test <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span>  <span class="token comment"># è®­ç»ƒå’Œæµ‹è¯•æ•°æ®é›†å¤§å°</span>    true_w <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>max_degree<span class="token punctuation">)</span>  <span class="token comment"># åˆ†é…å¤§é‡çš„ç©ºé—´</span>    true_w<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.4</span><span class="token punctuation">,</span> <span class="token number">5.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    features <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span>n_train <span class="token operator">+</span> n_test<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># å™ªå£°é¡¹</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>features<span class="token punctuation">)</span> <span class="token comment"># æ‰“ä¹±é¡ºåº</span>    poly_features <span class="token operator">=</span> np<span class="token punctuation">.</span>power<span class="token punctuation">(</span>features<span class="token punctuation">,</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>max_degree<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_degree<span class="token punctuation">)</span><span class="token punctuation">:</span>        poly_features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">/=</span> math<span class="token punctuation">.</span>gamma<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># gamma(n)=(n-1)!</span>    <span class="token comment"># labelsçš„ç»´åº¦:(n_train+n_test,)</span>    labels <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>poly_features<span class="token punctuation">,</span> true_w<span class="token punctuation">)</span>    labels <span class="token operator">+=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> size<span class="token operator">=</span>labels<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>    <span class="token comment"># NumPy ndarrayè½¬æ¢ä¸ºtensor</span>    true_w<span class="token punctuation">,</span> features<span class="token punctuation">,</span> poly_features<span class="token punctuation">,</span> labels <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>        x<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span>true_w<span class="token punctuation">,</span> features<span class="token punctuation">,</span> poly_features<span class="token punctuation">,</span> labels<span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token comment"># 2. å®šä¹‰ã€è®­ç»ƒå’Œæµ‹è¯•æ¨¡å‹</span>    <span class="token comment"># åœ¨å¤–éƒ¨å‡½æ•°ä¸­å®šä¹‰</span>    <span class="token comment"># 3.1  ä¸‰é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ(æ­£å¸¸)</span>    <span class="token comment"># ä»å¤šé¡¹å¼ç‰¹å¾ä¸­é€‰æ‹©å‰4ä¸ªç»´åº¦ï¼Œå³1,x,x^2/2!,x^3/3!</span>    train<span class="token punctuation">(</span>poly_features<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> poly_features<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          labels<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 3.2 çº¿æ€§å‡½æ•°æ‹Ÿåˆ(æ¬ æ‹Ÿåˆ)</span>    <span class="token comment"># ä»å¤šé¡¹å¼ç‰¹å¾ä¸­é€‰æ‹©å‰2ä¸ªç»´åº¦ï¼Œå³1å’Œx</span>    train<span class="token punctuation">(</span>poly_features<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> poly_features<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          labels<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># å‡å°‘è¯¥æ¨¡å‹çš„è®­ç»ƒæŸå¤±ç›¸å¯¹å›°éš¾ï¼Œåœ¨æœ€åä¸€ä¸ªè¿­ä»£å‘¨æœŸå®Œæˆåï¼Œè®­ç»ƒæŸå¤±ä»ç„¶å¾ˆé«˜ã€‚</span>    <span class="token comment"># 3.3 é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ(è¿‡æ‹Ÿåˆ)</span>    <span class="token comment"># ä»å¤šé¡¹å¼ç‰¹å¾ä¸­é€‰å–æ‰€æœ‰ç»´åº¦ï¼Œå³1,x,x^2/2!,...,x^19/19!</span>    train<span class="token punctuation">(</span>poly_features<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> poly_features<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          labels<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">1500</span><span class="token punctuation">)</span>    <span class="token comment"># è®­ç»ƒè¯¯å·®è¿…é€Ÿé™ä½ï¼Œä½†æµ‹è¯•æŸå¤±ä»ç„¶å¾ˆé«˜</span></code></pre><p>æ•°æ®é›†çš„ç”Ÿæˆï¼š</p><p><span class="math display">\[\begin{equation}\begin{gathered}y = 5 + 1.2x - 3.4\frac{x^2}{2!} + 5.6 \frac{x^3}{3!} + \epsilon \text{where }\epsilon \sim \mathcal{N}(0, 0.1^2)\end{gathered}\end{equation}\tag{4.8}\]</span></p><p>åœ¨ä¼˜åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›é¿å…éå¸¸å¤§çš„æ¢¯åº¦å€¼æˆ–æŸå¤±å€¼ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å°†ç‰¹å¾ä» <span class="math inline">\(x^i\)</span> è°ƒæ•´ä¸º <spanclass="math inline">\(\frac{x^i}{i!}\)</span> çš„åŸå› ï¼Œè¿™æ ·å¯ä»¥é¿å…å¾ˆå¤§çš„ <span class="math inline">\(i\)</span>å¸¦æ¥çš„ç‰¹åˆ«å¤§çš„æŒ‡æ•°å€¼ã€‚</p><h5 id="ä½¿ç”¨çº¿æ€§å‡½æ•°æ‹Ÿåˆæ¬ æ‹Ÿåˆ">4.4.4.1 ä½¿ç”¨çº¿æ€§å‡½æ•°æ‹Ÿåˆ(æ¬ æ‹Ÿåˆ)</h5><p>å‡å°‘è¯¥æ¨¡å‹çš„è®­ç»ƒæŸå¤±ç›¸å¯¹å›°éš¾ã€‚åœ¨æœ€åä¸€ä¸ªè¿­ä»£å‘¨æœŸå®Œæˆåï¼Œè®­ç»ƒæŸå¤±ä»ç„¶å¾ˆé«˜ã€‚</p><figure><img src="./images/4.4_linear-function-fit.svg"title="å›¾4.4ï¼šä½¿ç”¨çº¿æ€§å‡½æ•°æ‹Ÿåˆ" alt="ä½¿ç”¨çº¿æ€§å‡½æ•°æ‹Ÿåˆ" /><figcaption aria-hidden="true">ä½¿ç”¨çº¿æ€§å‡½æ•°æ‹Ÿåˆ</figcaption></figure><h5 id="ä½¿ç”¨ä¸‰é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆåˆé€‚">4.4.4.2ä½¿ç”¨ä¸‰é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ(åˆé€‚)</h5><p>è¯¥æ¨¡å‹èƒ½æœ‰æ•ˆé™ä½è®­ç»ƒæŸå¤±å’Œæµ‹è¯•æŸå¤±ã€‚å­¦ä¹ åˆ°çš„æ¨¡å‹å‚æ•°ä¹Ÿæ¥è¿‘çœŸå®å€¼ã€‚</p><figure><img src="./images/4.5_cubic-function-fit.svg"title="å›¾4.5ï¼šä½¿ç”¨ä¸‰é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ" alt="ä½¿ç”¨ä¸‰é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ" /><figcaption aria-hidden="true">ä½¿ç”¨ä¸‰é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ</figcaption></figure><h5 id="ä½¿ç”¨é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆè¿‡æ‹Ÿåˆ">4.4.4.3ä½¿ç”¨é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ(è¿‡æ‹Ÿåˆ)</h5><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç”¨äºå­¦åˆ°é«˜é˜¶ç³»æ•°åº”è¯¥å…·æœ‰æ¥è¿‘äºé›¶çš„å€¼ã€‚å› æ­¤ï¼Œè¿™ä¸ªè¿‡äºå¤æ‚çš„æ¨¡å‹ä¼šè½»æ˜“å—åˆ°è®­ç»ƒæ•°æ®ä¸­å™ªå£°çš„å½±å“ã€‚è™½ç„¶è®­ç»ƒæŸå¤±å¯ä»¥æœ‰æ•ˆåœ°é™ä½ï¼Œä½†æµ‹è¯•æŸå¤±ä»ç„¶å¾ˆé«˜ã€‚</p><figure><img src="./images/4.6_high-order-function-fit.svg"title="å›¾4.6ï¼šä½¿ç”¨é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ" alt="ä½¿ç”¨é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ" /><figcaption aria-hidden="true">ä½¿ç”¨é«˜é˜¶å¤šé¡¹å¼å‡½æ•°æ‹Ÿåˆ</figcaption></figure><h3 id="æƒé‡è¡°å‡">4.5 æƒé‡è¡°å‡</h3><p>è™½ç„¶å¯ä»¥é€šè¿‡å»æ”¶é›†æ›´å¤šçš„è®­ç»ƒæ•°æ®æ¥ç¼“è§£<strong>è¿‡æ‹Ÿåˆ</strong>ï¼Œä½†æ˜¯â€¦â€¦å¹¶ä¸å¤ªå¯èƒ½å‡è®¾æˆ‘ä»¬å·²ç»æ‹¥æœ‰å°½å¯èƒ½å¤šçš„é«˜è´¨é‡æ•°æ®ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å°†é‡ç‚¹æ”¾åœ¨<strong>æ­£åˆ™åŒ–æŠ€æœ¯</strong>ä¸Šã€‚æ­£åˆ™åŒ–æ˜¯å¤„ç†<strong>è¿‡æ‹Ÿåˆ</strong>çš„å¸¸ç”¨æ–¹æ³•ï¼š<strong>åœ¨è®­ç»ƒé›†çš„æŸå¤±å‡½æ•°ä¸­åŠ å…¥æƒ©ç½šé¡¹ï¼Œä»¥é™ä½å­¦ä¹ åˆ°çš„æ¨¡å‹çš„å¤æ‚åº¦</strong>ã€‚<strong>æƒé‡è¡°å‡ï¼ˆweight decayï¼‰æ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„æ­£åˆ™åŒ–çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œå®ƒé€šå¸¸ä¹Ÿè¢«ç§°ä¸º<spanclass="math inline">\(L_2\)</span>æ­£åˆ™åŒ–ã€‚</strong></p><p>åŸæ¥çš„æŸå¤±å‡½æ•°:</p><p><span class="math display">\[\begin{equation}\begin{gathered}L(\mathbf{w}, b) = \frac{1}{n}\sum_{i=1}^n\frac{1}{2}\left(\mathbf{w}^\top \mathbf{x}^{(i)} + b - y^{(i)}\right)^2\end{gathered}\end{equation}\tag{4.9}\]</span></p><p>ç°åœ¨çš„æŸå¤±å‡½æ•°(é€šè¿‡æ­£åˆ™åŒ–å¸¸æ•°<spanclass="math inline">\(\lambda\)</span>æ¥æè¿°è¿™ç§æƒè¡¡ï¼Œè¿™æ˜¯ä¸€ä¸ªéè´Ÿè¶…å‚æ•°):</p><p><span class="math display">\[\begin{equation}\begin{gathered}L(\mathbf{w}, b) + \frac{\lambda}{2} \|\mathbf{w}\|^2\end{gathered}\end{equation}\tag{4.10}\]</span></p><h4 id="é«˜ç»´çº¿æ€§å›å½’">4.5.1 é«˜ç»´çº¿æ€§å›å½’</h4><p>ä½¿ç”¨çš„æ•°æ®é›†ç”±ä¸‹é¢å…¬å¼ç”Ÿæˆ:</p><p><span class="math display">\[\begin{equation}\begin{gathered}y = 0.05 + \sum_{i = 1}^d 0.01 x_i + \epsilon \text{ where }\epsilon \sim \mathcal{N}(0, 0.01^2)\end{gathered}\end{equation}\tag{4.11}\]</span></p><p>ä¸ºäº†ä½¿è¿‡æ‹Ÿåˆçš„æ•ˆæœæ›´åŠ æ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥å°†é—®é¢˜çš„ç»´æ•°å¢åŠ åˆ° <spanclass="math inline">\(d=200\)</span>ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªåªåŒ…å«20ä¸ªæ ·æœ¬çš„å°è®­ç»ƒé›†ã€‚</p><h4 id="ä»é›¶å¼€å§‹å®ç°">4.5.2 ä»é›¶å¼€å§‹å®ç°</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">import</span> torch<span class="token comment"># éšæœºåˆå§‹åŒ–æ¨¡å‹å‚æ•°</span><span class="token keyword">def</span> <span class="token function">init_params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    w <span class="token operator">=</span> torch<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    b <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>w<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token comment"># L2èŒƒæ•°æƒ©ç½š</span><span class="token keyword">def</span> <span class="token function">l2_penalty</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token comment"># å®šä¹‰è®­ç»ƒ</span><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>lambd<span class="token punctuation">)</span><span class="token punctuation">:</span>    w<span class="token punctuation">,</span> b <span class="token operator">=</span> init_params<span class="token punctuation">(</span><span class="token punctuation">)</span>    net<span class="token punctuation">,</span> loss <span class="token operator">=</span> <span class="token keyword">lambda</span> X<span class="token punctuation">:</span> d2l<span class="token punctuation">.</span>linreg<span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> d2l<span class="token punctuation">.</span>squared_loss    num_epochs<span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.003</span>    animator <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Animator<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">'epochs'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">,</span> yscale<span class="token operator">=</span><span class="token string">'log'</span><span class="token punctuation">,</span>                            xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span> legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>            <span class="token comment"># å¢åŠ äº†L2èŒƒæ•°æƒ©ç½šé¡¹ï¼Œ</span>            <span class="token comment"># å¹¿æ’­æœºåˆ¶ä½¿l2_penalty(w)æˆä¸ºä¸€ä¸ªé•¿åº¦ä¸ºbatch_sizeçš„å‘é‡</span>            l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">+</span> lambd <span class="token operator">*</span> l2_penalty<span class="token punctuation">(</span>w<span class="token punctuation">)</span>            l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            d2l<span class="token punctuation">.</span>sgd<span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            animator<span class="token punctuation">.</span>add<span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>d2l<span class="token punctuation">.</span>evaluate_loss<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">,</span>                                     d2l<span class="token punctuation">.</span>evaluate_loss<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'wçš„L2èŒƒæ•°æ˜¯:'</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    n_train<span class="token punctuation">,</span> n_test<span class="token punctuation">,</span> num_inputs<span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">5</span>    true_w<span class="token punctuation">,</span> true_b <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.05</span>    train_data <span class="token operator">=</span> d2l<span class="token punctuation">.</span>synthetic_data<span class="token punctuation">(</span>true_w<span class="token punctuation">,</span> true_b<span class="token punctuation">,</span> n_train<span class="token punctuation">)</span>    train_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>    test_data <span class="token operator">=</span> d2l<span class="token punctuation">.</span>synthetic_data<span class="token punctuation">(</span>true_w<span class="token punctuation">,</span> true_b<span class="token punctuation">,</span> n_test<span class="token punctuation">)</span>    test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token comment"># æ— æ­£åˆ™åŒ–</span>    train<span class="token punctuation">(</span>lambd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># ä½¿ç”¨æƒé‡è¡°å‡</span>    train<span class="token punctuation">(</span>lambd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><h5 id="ä¸ä½¿ç”¨æ­£åˆ™åŒ–">4.5.2.1 ä¸ä½¿ç”¨æ­£åˆ™åŒ–</h5><p>è¿™é‡Œè®­ç»ƒè¯¯å·®æœ‰äº†å‡å°‘ï¼Œä½†æµ‹è¯•è¯¯å·®æ²¡æœ‰å‡å°‘ï¼Œè¿™æ„å‘³ç€å‡ºç°äº†ä¸¥é‡çš„è¿‡æ‹Ÿåˆ</p><figure><img src="./images/4.7_no-weight-decay.svg" title="å›¾4.7ï¼šä¸ä½¿ç”¨æ­£åˆ™åŒ–"alt="ä¸ä½¿ç”¨æ­£åˆ™åŒ–" /><figcaption aria-hidden="true">ä¸ä½¿ç”¨æ­£åˆ™åŒ–</figcaption></figure><h5 id="ä½¿ç”¨æƒé‡è¡°å‡">4.5.2.2 ä½¿ç”¨æƒé‡è¡°å‡</h5><p>åœ¨è¿™é‡Œè®­ç»ƒè¯¯å·®å¢å¤§ï¼Œä½†æµ‹è¯•è¯¯å·®å‡å°ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æœŸæœ›ä»æ­£åˆ™åŒ–ä¸­å¾—åˆ°çš„æ•ˆæœã€‚</p><figure><img src="./images/4.8_weight-decay.svg" title="å›¾4.8ï¼šä½¿ç”¨æƒé‡è¡°å‡"alt="ä½¿ç”¨æƒé‡è¡°å‡" /><figcaption aria-hidden="true">ä½¿ç”¨æƒé‡è¡°å‡</figcaption></figure><h4 id="ç®€æ´å®ç°">4.5.3 ç®€æ´å®ç°</h4><p>æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸ºäº†ä¾¿äºæˆ‘ä»¬ä½¿ç”¨æƒé‡è¡°å‡ï¼Œå°†æƒé‡è¡°å‡é›†æˆåˆ°ä¼˜åŒ–ç®—æ³•ä¸­ï¼Œä»¥ä¾¿ä¸ä»»ä½•æŸå¤±å‡½æ•°ç»“åˆä½¿ç”¨ã€‚</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">import</span> torch<span class="token keyword">def</span> <span class="token function">train_concise</span><span class="token punctuation">(</span>wd<span class="token punctuation">)</span><span class="token punctuation">:</span>    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> param <span class="token keyword">in</span> net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        param<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token punctuation">)</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span>    num_epochs<span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.003</span>    <span class="token comment"># é»˜è®¤æƒ…å†µä¸‹ï¼ŒPyTorchåŒæ—¶è¡°å‡æƒé‡å’Œåç§»ã€‚ è¿™é‡Œæˆ‘ä»¬åªä¸ºæƒé‡è®¾ç½®äº†weight_decayï¼Œæ‰€ä»¥åç½®å‚æ•°bä¸ä¼šè¡°å‡ã€‚</span>    trainer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span><span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span><span class="token string">"params"</span><span class="token punctuation">:</span> net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> wd<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span><span class="token string">"params"</span><span class="token punctuation">:</span> net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>    animator <span class="token operator">=</span> d2l<span class="token punctuation">.</span>Animator<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">'epochs'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">,</span> yscale<span class="token operator">=</span><span class="token string">'log'</span><span class="token punctuation">,</span>                            xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span> legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>            trainer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>            l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>            l<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            trainer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            animator<span class="token punctuation">.</span>add<span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>                         <span class="token punctuation">(</span>d2l<span class="token punctuation">.</span>evaluate_loss<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">,</span>                          d2l<span class="token punctuation">.</span>evaluate_loss<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'wçš„L2èŒƒæ•°:'</span><span class="token punctuation">,</span> net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>norm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    n_train<span class="token punctuation">,</span> n_test<span class="token punctuation">,</span> num_inputs<span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">5</span>    true_w<span class="token punctuation">,</span> true_b <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.05</span>    train_data <span class="token operator">=</span> d2l<span class="token punctuation">.</span>synthetic_data<span class="token punctuation">(</span>true_w<span class="token punctuation">,</span> true_b<span class="token punctuation">,</span> n_train<span class="token punctuation">)</span>    train_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>    test_data <span class="token operator">=</span> d2l<span class="token punctuation">.</span>synthetic_data<span class="token punctuation">(</span>true_w<span class="token punctuation">,</span> true_b<span class="token punctuation">,</span> n_test<span class="token punctuation">)</span>    test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token comment"># æ— æ­£åˆ™åŒ–</span>    train_concise<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># ä½¿ç”¨æƒé‡è¡°å‡</span>    train_concise<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><h5 id="ä¸ä½¿ç”¨æ­£åˆ™åŒ–-1">4.5.3.1 ä¸ä½¿ç”¨æ­£åˆ™åŒ–</h5><figure><img src="./images/4.9_no-weight-decay.svg" title="å›¾4.9ï¼šä¸ä½¿ç”¨æ­£åˆ™åŒ–"alt="ä¸ä½¿ç”¨æ­£åˆ™åŒ–" /><figcaption aria-hidden="true">ä¸ä½¿ç”¨æ­£åˆ™åŒ–</figcaption></figure><h5 id="ä½¿ç”¨æƒé‡è¡°å‡-1">4.5.3.2 ä½¿ç”¨æƒé‡è¡°å‡</h5><figure><img src="./images/4.10_weight-decay.svg" title="å›¾4.10ï¼šä½¿ç”¨æƒé‡è¡°å‡"alt="ä½¿ç”¨æƒé‡è¡°å‡" /><figcaption aria-hidden="true">ä½¿ç”¨æƒé‡è¡°å‡</figcaption></figure><h3 id="æš‚é€€æ³•">4.6 æš‚é€€æ³•</h3><p><strong>æš‚é€€æ³•åœ¨å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—æ¯ä¸€å†…éƒ¨å±‚çš„åŒæ—¶æ³¨å…¥å™ªå£°ï¼Œè¿™å·²ç»æˆä¸ºè®­ç»ƒç¥ç»ç½‘ç»œçš„å¸¸ç”¨æŠ€æœ¯ã€‚</strong>è¿™ç§æ–¹æ³•ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºæš‚é€€æ³•ï¼Œå› ä¸ºæˆ‘ä»¬ä»è¡¨é¢ä¸Šçœ‹æ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸¢å¼ƒï¼ˆdropoutï¼‰ä¸€äº›ç¥ç»å…ƒã€‚<strong>åœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹çš„æ¯ä¸€æ¬¡è¿­ä»£ä¸­ï¼Œæ ‡å‡†æš‚é€€æ³•åŒ…æ‹¬åœ¨è®¡ç®—ä¸‹ä¸€å±‚ä¹‹å‰å°†å½“å‰å±‚ä¸­çš„ä¸€äº›èŠ‚ç‚¹ç½®é›¶ã€‚</strong></p><p>é‚£ä¹ˆå…³é”®çš„æŒ‘æˆ˜å°±æ˜¯å¦‚ä½•æ³¨å…¥è¿™ç§å™ªå£°ã€‚ä¸€ç§æƒ³æ³•æ˜¯ä»¥ä¸€ç§æ— åå‘ï¼ˆunbiasedï¼‰çš„æ–¹å¼æ³¨å…¥å™ªå£°ã€‚è¿™æ ·åœ¨å›ºå®šä½å…¶ä»–å±‚æ—¶ï¼Œæ¯ä¸€å±‚çš„æœŸæœ›å€¼ç­‰äºæ²¡æœ‰å™ªéŸ³æ—¶çš„å€¼ã€‚åœ¨æ ‡å‡†æš‚é€€æ³•æ­£åˆ™åŒ–ä¸­ï¼Œé€šè¿‡æŒ‰ä¿ç•™ï¼ˆæœªä¸¢å¼ƒï¼‰çš„èŠ‚ç‚¹çš„åˆ†æ•°è¿›è¡Œè§„èŒƒåŒ–æ¥æ¶ˆé™¤æ¯ä¸€å±‚çš„åå·®:</p><p><span class="math display">\[\begin{split}\begin{aligned}h&#39; =\begin{cases}    0 &amp; \text{ æ¦‚ç‡ä¸º } p \\    \frac{h}{1-p} &amp; \text{ å…¶ä»–æƒ…å†µ}\end{cases}\end{aligned}\end{split}\tag{4.12}\]</span></p><p>æœŸæœ›å€¼ä¿æŒä¸å˜ï¼Œå³ <span class="math inline">\(E[h&#39;] =h\)</span>ã€‚</p><h4 id="å®è·µä¸­çš„æš‚é€€æ³•">4.6.1 å®è·µä¸­çš„æš‚é€€æ³•</h4><p>å½“æˆ‘ä»¬å°†æš‚é€€æ³•åº”ç”¨åˆ°éšè—å±‚ï¼Œä»¥<spanclass="math inline">\(p\)</span>çš„æ¦‚ç‡å°†éšè—å•å…ƒç½®ä¸ºé›¶æ—¶ï¼Œç»“æœå¯ä»¥çœ‹ä½œä¸€ä¸ªåªåŒ…å«åŸå§‹ç¥ç»å…ƒå­é›†çš„ç½‘ç»œã€‚ å¦‚å›¾4.11ï¼Œ åˆ é™¤äº†<spanclass="math inline">\(h_2\)</span>å’Œ<spanclass="math inline">\(h_5\)</span>ï¼Œ å› æ­¤è¾“å‡ºçš„è®¡ç®—ä¸å†ä¾èµ–äº<spanclass="math inline">\(h_2\)</span>æˆ–<spanclass="math inline">\(h_5\)</span>ï¼Œå¹¶ä¸”å®ƒä»¬å„è‡ªçš„æ¢¯åº¦åœ¨æ‰§è¡Œåå‘ä¼ æ’­æ—¶ä¹Ÿä¼šæ¶ˆå¤±ã€‚è¿™æ ·ï¼Œè¾“å‡ºå±‚çš„è®¡ç®—ä¸èƒ½è¿‡åº¦ä¾èµ–äº<spanclass="math inline">\(h_1,...,h_5\)</span>çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ ã€‚</p><figure><img src="./images/4.11_dropout_MLP.svg"title="å›¾4.11ï¼šdropoutå‰åçš„å¤šå±‚æ„ŸçŸ¥æœº" alt="dropoutå‰åçš„å¤šå±‚æ„ŸçŸ¥æœº" /><figcaption aria-hidden="true">dropoutå‰åçš„å¤šå±‚æ„ŸçŸ¥æœº</figcaption></figure><p>é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•æ—¶ä¸ç”¨æš‚é€€æ³•ã€‚ç»™å®šä¸€ä¸ªè®­ç»ƒå¥½çš„æ¨¡å‹å’Œä¸€ä¸ªæ–°çš„æ ·æœ¬ï¼Œæˆ‘ä»¬ä¸ä¼šä¸¢å¼ƒä»»ä½•èŠ‚ç‚¹ï¼Œå› æ­¤ä¸éœ€è¦æ ‡å‡†åŒ–ã€‚ç„¶è€Œä¹Ÿæœ‰ä¸€äº›ä¾‹å¤–ï¼šä¸€äº›ç ”ç©¶äººå‘˜åœ¨æµ‹è¯•æ—¶ä½¿ç”¨æš‚é€€æ³•ï¼Œç”¨äºä¼°è®¡ç¥ç»ç½‘ç»œé¢„æµ‹çš„â€œä¸ç¡®å®šæ€§â€ï¼šå¦‚æœé€šè¿‡è®¸å¤šä¸åŒçš„æš‚é€€æ³•é®ç›–åå¾—åˆ°çš„é¢„æµ‹ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¯´ç½‘ç»œå‘æŒ¥æ›´ç¨³å®šã€‚</p><h4 id="ä»é›¶å¼€å§‹å®ç°-1">4.6.2 ä»é›¶å¼€å§‹å®ç°</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token comment"># å®šä¹‰ä¸€ä¸ªdropoutå‡½æ•°</span><span class="token keyword">def</span> <span class="token function">dropout_layer</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> dropout <span class="token operator">&lt;=</span> <span class="token number">1</span>    <span class="token comment"># åœ¨æœ¬æƒ…å†µä¸­ï¼Œæ‰€æœ‰å…ƒç´ éƒ½è¢«ä¸¢å¼ƒ</span>    <span class="token keyword">if</span> dropout <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>X<span class="token punctuation">)</span>    <span class="token comment"># åœ¨æœ¬æƒ…å†µä¸­ï¼Œæ‰€æœ‰å…ƒç´ éƒ½è¢«ä¿ç•™</span>    <span class="token keyword">if</span> dropout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> X    mask <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">></span> dropout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># ç”Ÿæˆä¸€ä¸ªmask</span>    <span class="token keyword">return</span> mask <span class="token operator">*</span> X <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> dropout<span class="token punctuation">)</span> <span class="token comment"># æŒ‰ä½mask</span><span class="token comment"># æµ‹è¯•dropoutå‡½æ•°</span><span class="token keyword">class</span> <span class="token class-name">Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_inputs<span class="token punctuation">,</span> num_outputs<span class="token punctuation">,</span> num_hiddens1<span class="token punctuation">,</span> num_hiddens2<span class="token punctuation">,</span>                 is_training <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>num_inputs <span class="token operator">=</span> num_inputs        self<span class="token punctuation">.</span>training <span class="token operator">=</span> is_training        self<span class="token punctuation">.</span>lin1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> num_hiddens1<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>lin2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_hiddens1<span class="token punctuation">,</span> num_hiddens2<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>lin3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_hiddens2<span class="token punctuation">,</span> num_outputs<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>        H1 <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lin1<span class="token punctuation">(</span>X<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_inputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># åªæœ‰åœ¨è®­ç»ƒæ¨¡å‹æ—¶æ‰ä½¿ç”¨dropout</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            <span class="token comment"># åœ¨ç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚ä¹‹åæ·»åŠ ä¸€ä¸ªdropoutå±‚</span>            H1 <span class="token operator">=</span> dropout_layer<span class="token punctuation">(</span>H1<span class="token punctuation">,</span> dropout1<span class="token punctuation">)</span>        H2 <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lin2<span class="token punctuation">(</span>H1<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            <span class="token comment"># åœ¨ç¬¬äºŒä¸ªå…¨è¿æ¥å±‚ä¹‹åæ·»åŠ ä¸€ä¸ªdropoutå±‚</span>            H2 <span class="token operator">=</span> dropout_layer<span class="token punctuation">(</span>H2<span class="token punctuation">,</span> dropout2<span class="token punctuation">)</span>        out <span class="token operator">=</span> self<span class="token punctuation">.</span>lin3<span class="token punctuation">(</span>H2<span class="token punctuation">)</span>        <span class="token keyword">return</span> out<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    num_inputs<span class="token punctuation">,</span> num_outputs<span class="token punctuation">,</span> num_hiddens1<span class="token punctuation">,</span> num_hiddens2 <span class="token operator">=</span> <span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span>    <span class="token comment"># å®šä¹‰æ¨¡å‹</span>    <span class="token comment"># æˆ‘ä»¬å¯ä»¥å°†æš‚é€€æ³•åº”ç”¨äºæ¯ä¸ªéšè—å±‚çš„è¾“å‡ºï¼ˆåœ¨æ¿€æ´»å‡½æ•°ä¹‹åï¼‰ï¼Œ å¹¶ä¸”å¯ä»¥ä¸ºæ¯ä¸€å±‚åˆ†åˆ«è®¾ç½®æš‚é€€æ¦‚ç‡ï¼š å¸¸è§çš„æŠ€å·§æ˜¯åœ¨é è¿‘è¾“å…¥å±‚çš„åœ°æ–¹è®¾ç½®è¾ƒä½çš„æš‚é€€æ¦‚ç‡ã€‚ </span>    <span class="token comment"># ä¸‹é¢çš„æ¨¡å‹å°†ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªéšè—å±‚çš„æš‚é€€æ¦‚ç‡åˆ†åˆ«è®¾ç½®ä¸º0.2å’Œ0.5ï¼Œ å¹¶ä¸”æš‚é€€æ³•åªåœ¨è®­ç»ƒæœŸé—´æœ‰æ•ˆã€‚</span>    dropout1<span class="token punctuation">,</span> dropout2 <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.5</span>    net <span class="token operator">=</span> Net<span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> num_outputs<span class="token punctuation">,</span> num_hiddens1<span class="token punctuation">,</span> num_hiddens2<span class="token punctuation">)</span>    <span class="token comment"># è®­ç»ƒå’Œæµ‹è¯•æ¨¡å‹</span>    num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">256</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span>    train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_data_fashion_mnist<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>    trainer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>    d2l<span class="token punctuation">.</span>train_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> trainer<span class="token punctuation">)</span></code></pre><h4 id="ç®€æ´å®ç°-1">4.6.3 ç®€æ´å®ç°</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2lnet <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment"># åœ¨ç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚ä¹‹åæ·»åŠ ä¸€ä¸ªdropoutå±‚</span>                    nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout1<span class="token punctuation">)</span><span class="token punctuation">,</span>                    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment"># åœ¨ç¬¬äºŒä¸ªå…¨è¿æ¥å±‚ä¹‹åæ·»åŠ ä¸€ä¸ªdropoutå±‚</span>                    nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout2<span class="token punctuation">)</span><span class="token punctuation">,</span>                    nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">:</span>        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>net<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>init_weights<span class="token punctuation">)</span>trainer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>d2l<span class="token punctuation">.</span>train_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> trainer<span class="token punctuation">)</span></code></pre><h3 id="å‰å‘ä¼ æ’­åå‘ä¼ æ’­å’Œè®¡ç®—å›¾">4.7 å‰å‘ä¼ æ’­ã€åå‘ä¼ æ’­å’Œè®¡ç®—å›¾</h3><h4 id="å‰å‘ä¼ æ’­">4.7.1 å‰å‘ä¼ æ’­</h4><p>æŒ‰é¡ºåºï¼ˆä»è¾“å…¥å±‚åˆ°è¾“å‡ºå±‚ï¼‰<strong>è®¡ç®—</strong>å’Œ<strong>å­˜å‚¨</strong>ç¥ç»ç½‘ç»œä¸­æ¯å±‚çš„ç»“æœã€‚</p><p><span class="math display">\[\begin{equation}\begin{gathered}\mathbf{z}= \mathbf{W}^{(1)} \mathbf{x}\\\mathbf{h}= \phi(\mathbf{z})\\\mathbf{o}= \mathbf{W}^{(2)} \mathbf{h}\\\end{gathered}\end{equation}\tag{4.13}\]</span></p><p>æŸå¤±å‡½æ•°<span class="math inline">\(l\)</span>ï¼Œæ ·æœ¬æ ‡ç­¾<spanclass="math inline">\(y\)</span>ï¼Œåˆ™æŸå¤±é¡¹ï¼Œæ­£åˆ™é¡¹ï¼Œæ­£åˆ™åŒ–æŸå¤±:</p><p><span class="math display">\[\begin{gathered}L = l(\mathbf{o}, y)\\s = \frac{\lambda}{2} \left(\|\mathbf{W}^{(1)}\|_F^2 +\|\mathbf{W}^{(2)}\|_F^2\right)\\J = L + s\end{gathered}\tag{4.14}\]</span></p><p>ç›®æ ‡å‡½æ•°å³ä¸º<span class="math inline">\(J\)</span>ã€‚</p><h4 id="å‰å‘ä¼ æ’­è®¡ç®—å›¾">4.7.2 å‰å‘ä¼ æ’­è®¡ç®—å›¾</h4><p>æ­£æ–¹å½¢è¡¨ç¤ºå˜é‡ï¼Œåœ†åœˆè¡¨ç¤ºæ“ä½œç¬¦ï¼Œå·¦ä¸‹è§’è¡¨ç¤ºè¾“å…¥ï¼Œå³ä¸Šè§’è¡¨ç¤ºè¾“å‡ºã€‚</p><figure><img src="./images/4.12_forward.svg" title="å›¾4.12ï¼šå‰å‘ä¼ æ’­è®¡ç®—å›¾"alt="å‰å‘ä¼ æ’­è®¡ç®—å›¾" /><figcaption aria-hidden="true">å‰å‘ä¼ æ’­è®¡ç®—å›¾</figcaption></figure><h4 id="åå‘ä¼ æ’­">4.7.3 åå‘ä¼ æ’­</h4><p>åå‘ä¼ æ’­æŒ‡çš„æ˜¯è®¡ç®—ç¥ç»ç½‘ç»œå‚æ•°æ¢¯åº¦çš„æ–¹æ³•ã€‚ç®€è¨€ä¹‹ï¼Œè¯¥æ–¹æ³•æ ¹æ®å¾®ç§¯åˆ†ä¸­çš„<strong>é“¾å¼è§„åˆ™</strong>ï¼ŒæŒ‰ç›¸åçš„é¡ºåºä»è¾“å‡ºå±‚åˆ°è¾“å…¥å±‚éå†ç½‘ç»œã€‚<strong>è¯¥ç®—æ³•å­˜å‚¨äº†è®¡ç®—æŸäº›å‚æ•°æ¢¯åº¦æ—¶æ‰€éœ€çš„ä»»ä½•ä¸­é—´å˜é‡ï¼ˆåå¯¼æ•°ï¼‰</strong>ã€‚</p><p>åœ¨æ­¤ä¾‹å­ä¸­ï¼Œå³é€šè¿‡é“¾å¼æ³•åˆ™è®¡ç®—<span class="math inline">\(\partialJ/\partial \mathbf{W}^{(1)}\)</span>å’Œ<spanclass="math inline">\(\partial J/\partial\mathbf{W}^{(2)}\)</span>ã€‚</p><p><span class="math display">\[\begin{gathered}  \frac{\partial J}{\partial \mathbf{W}^{(2)}}=\text{prod}\left(\frac{\partial J}{\partial \mathbf{o}}, \frac{\partial\mathbf{o}}{\partial \mathbf{W}^{(2)}}\right) +\text{prod}\left(\frac{\partial J}{\partial s}, \frac{\partials}{\partial \mathbf{W}^{(2)}}\right)\\  \frac{\partial J}{\partial \mathbf{W}^{(1)}}  = \text{prod}\left(\frac{\partial J}{\partial \mathbf{z}},\frac{\partial \mathbf{z}}{\partial \mathbf{W}^{(1)}}\right) +\text{prod}\left(\frac{\partial J}{\partial s}, \frac{\partials}{\partial \mathbf{W}^{(1)}}\right)\end{gathered}\tag{4.15}\]</span></p><h4 id="å†…å­˜éœ€æ±‚">4.7.4 å†…å­˜éœ€æ±‚</h4><p>å› æ­¤ï¼Œåœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ï¼Œåœ¨åˆå§‹åŒ–æ¨¡å‹å‚æ•°åï¼Œæˆ‘ä»¬äº¤æ›¿ä½¿ç”¨å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ï¼Œåˆ©ç”¨åå‘ä¼ æ’­ç»™å‡ºçš„æ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹å‚æ•°ã€‚æ³¨æ„ï¼Œ<strong>åå‘ä¼ æ’­é‡å¤åˆ©ç”¨å‰å‘ä¼ æ’­ä¸­å­˜å‚¨çš„ä¸­é—´å€¼</strong>ï¼Œä»¥é¿å…é‡å¤è®¡ç®—ã€‚å¸¦æ¥çš„å½±å“ä¹‹ä¸€æ˜¯æˆ‘ä»¬<strong>éœ€è¦ä¿ç•™ä¸­é—´å€¼</strong>ï¼Œç›´åˆ°åå‘ä¼ æ’­å®Œæˆã€‚è¿™ä¹Ÿæ˜¯<strong>è®­ç»ƒæ¯”å•çº¯çš„é¢„æµ‹éœ€è¦æ›´å¤šçš„å†…å­˜ï¼ˆæ˜¾å­˜ï¼‰</strong>çš„åŸå› ä¹‹ä¸€ã€‚æ­¤å¤–ï¼Œè¿™äº›<strong>ä¸­é—´å€¼çš„å¤§å°ä¸ç½‘ç»œå±‚çš„æ•°é‡å’Œæ‰¹é‡çš„å¤§å°å¤§è‡´æˆæ­£æ¯”</strong>ã€‚å› æ­¤ï¼Œä½¿ç”¨æ›´å¤§çš„æ‰¹é‡æ¥è®­ç»ƒæ›´æ·±å±‚æ¬¡çš„ç½‘ç»œæ›´å®¹æ˜“å¯¼è‡´å†…å­˜ä¸è¶³ï¼ˆout ofmemoryï¼‰é”™è¯¯ã€‚</p><h3 id="æ•°å€¼ç¨³å®šæ€§å’Œæ¨¡å‹åˆå§‹åŒ–">4.8 æ•°å€¼ç¨³å®šæ€§å’Œæ¨¡å‹åˆå§‹åŒ–</h3><p>åˆå§‹åŒ–æ–¹æ¡ˆçš„é€‰æ‹©åœ¨ç¥ç»ç½‘ç»œå­¦ä¹ ä¸­èµ·ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ï¼Œå®ƒå¯¹ä¿æŒæ•°å€¼ç¨³å®šæ€§è‡³å…³é‡è¦ã€‚ç³Ÿç³•é€‰æ‹©å¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨è®­ç»ƒæ—¶é‡åˆ°æ¢¯åº¦çˆ†ç‚¸æˆ–æ¢¯åº¦æ¶ˆå¤±ã€‚</p><ol type="1"><li>éœ€è¦ç”¨å¯å‘å¼çš„åˆå§‹åŒ–æ–¹æ³•æ¥ç¡®ä¿åˆå§‹æ¢¯åº¦æ—¢ä¸å¤ªå¤§ä¹Ÿä¸å¤ªå°ã€‚</li><li>ReLUæ¿€æ´»å‡½æ•°ç¼“è§£äº†æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œè¿™æ ·å¯ä»¥åŠ é€Ÿæ”¶æ•›ã€‚</li><li>éšæœºåˆå§‹åŒ–æ˜¯ä¿è¯åœ¨è¿›è¡Œä¼˜åŒ–å‰æ‰“ç ´å¯¹ç§°æ€§çš„å…³é”®ã€‚</li></ol><h4 id="æ¢¯åº¦çˆ†ç‚¸æ¢¯åº¦æ¶ˆå¤±æ‰“ç ´å¯¹ç§°æ€§">4.8.1æ¢¯åº¦çˆ†ç‚¸ã€æ¢¯åº¦æ¶ˆå¤±ã€æ‰“ç ´å¯¹ç§°æ€§</h4><p><strong>æ¢¯åº¦æ¶ˆå¤±ï¼ˆgradient vanishingï¼‰</strong>ï¼š<strong>å‚æ•°æ›´æ–°è¿‡å°ï¼Œåœ¨æ¯æ¬¡æ›´æ–°æ—¶å‡ ä¹ä¸ä¼šç§»åŠ¨</strong>ï¼Œå¯¼è‡´æ¨¡å‹æ— æ³•å­¦ä¹ ã€‚æ ¹æ®é“¾å¼æ±‚å¯¼æ³•åˆ™ï¼Œæ¢¯åº¦çš„è®¡ç®—æ˜¯ç”±ä¸åŒå› å­çš„è¿ä¹˜ç»“æœï¼Œåªè¦å…¶ä¸­æŸä¸ªå› å­çš„æ•°å€¼å°äº1é‚£ä¹ˆéšç€ç½‘ç»œçš„åŠ æ·±ï¼Œåç»­çš„æ¢¯åº¦ä¸€å®šæ˜¯é€æ¸é™ä½çš„ï¼ˆå‡è®¾å…¶ä»–å› å­è®¾ç½®åˆç†ï¼‰ã€‚å¦‚æœå› å­çš„æ•°å€¼å¤Ÿä½ï¼Œåç»­æ¢¯åº¦ç”šè‡³ä¼šå‡ºç°æ¶ˆå¤±ç°è±¡ï¼Œå¯¼è‡´ç½‘ç»œéš¾ä»¥è®­ç»ƒå’Œæ”¶æ•›ï¼Œè¿™å°±æ˜¯æ¢¯åº¦æ¶ˆå¤±çš„ç°è±¡ã€‚ä¾‹å¦‚:å½“sigmoidå‡½æ•°çš„è¾“å…¥å¾ˆå¤§æˆ–æ˜¯å¾ˆå°æ—¶ï¼Œå®ƒçš„æ¢¯åº¦éƒ½ä¼šæ¶ˆå¤±ã€‚<strong>æ¢¯åº¦çˆ†ç‚¸ï¼ˆgradient explodingï¼‰</strong>ï¼š<strong>å‚æ•°æ›´æ–°è¿‡å¤§ï¼Œç ´åäº†æ¨¡å‹çš„ç¨³å®šæ”¶æ•›</strong>ã€‚åŒæ¢¯åº¦æ¶ˆå¤±çš„åŸç†ä¸€æ ·ï¼Œæ¢¯åº¦çˆ†ç‚¸ä¹Ÿæ˜¯å› ä¸ºå› å­çš„æ•°å€¼å¤§äº1ï¼Œåœ¨ç»è¿‡ç½‘ç»œçš„ä¸æ–­åŠ æ·±ï¼Œåç»­æ¢¯åº¦å‡ºç°çˆ†ç‚¸çš„ç°è±¡ã€‚<strong>æ‰“ç ´å¯¹ç§°æ€§</strong>ï¼šç¥ç»ç½‘ç»œè®¾è®¡ä¸­çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯å…¶å‚æ•°åŒ–æ‰€å›ºæœ‰çš„å¯¹ç§°æ€§ã€‚å¦‚æœæˆ‘ä»¬<strong>å°†éšè—å±‚çš„æ‰€æœ‰å‚æ•°åˆå§‹åŒ–ä¸ºåŒä¸€ä¸ªå¸¸é‡</strong>ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨å‰å‘ä¼ æ’­æœŸé—´ï¼Œéšè—å•å…ƒé‡‡ç”¨ç›¸åŒçš„è¾“å…¥å’Œå‚æ•°ï¼Œäº§ç”Ÿç›¸åŒçš„æ¿€æ´»ï¼Œè¯¥æ¿€æ´»è¢«é€åˆ°è¾“å‡ºå•å…ƒã€‚åœ¨åå‘ä¼ æ’­æœŸé—´ï¼Œæ ¹æ®å‚æ•°å¯¹è¾“å‡ºå•å…ƒè¿›è¡Œå¾®åˆ†ï¼Œå¾—åˆ°ä¸€ä¸ªæ¢¯åº¦ï¼Œå…¶å…ƒç´ éƒ½å–ç›¸åŒçš„å€¼ã€‚ å› æ­¤ï¼Œåœ¨åŸºäºæ¢¯åº¦çš„è¿­ä»£ä¹‹åï¼Œéšè—å•å…ƒçš„æ‰€æœ‰å…ƒç´ ä»ç„¶é‡‡ç”¨ç›¸åŒçš„å€¼ã€‚è¿™æ ·çš„è¿­ä»£æ°¸è¿œä¸ä¼šæ‰“ç ´å¯¹ç§°æ€§ï¼Œæˆ‘ä»¬å¯èƒ½æ°¸è¿œä¹Ÿæ— æ³•å®ç°ç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›ã€‚<strong>éšè—å±‚çš„è¡Œä¸ºå°±å¥½åƒåªæœ‰ä¸€ä¸ªå•å…ƒ</strong>ã€‚è¯·æ³¨æ„ï¼Œè™½ç„¶å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™ä¸ä¼šæ‰“ç ´è¿™ç§å¯¹ç§°æ€§ï¼Œä½†æš‚é€€æ³•æ­£åˆ™åŒ–å¯ä»¥ã€‚</p><h4 id="åˆå§‹åŒ–å‚æ•°">4.8.2 åˆå§‹åŒ–å‚æ•°</h4><ol type="1"><li>Pytorchçš„é»˜è®¤åˆå§‹åŒ–</li><li>Xavieråˆå§‹åŒ–: ä»å‡å€¼ä¸ºé›¶ï¼Œæ–¹å·® <span class="math inline">\(\sigma^2= \frac{2}{n_\mathrm{in} + n_\mathrm{out}}\)</span>çš„é«˜æ–¯åˆ†å¸ƒä¸­é‡‡æ ·æƒé‡ã€‚</li></ol><h3 id="ç¯å¢ƒä¸åˆ†å¸ƒåç§»">4.9 ç¯å¢ƒä¸åˆ†å¸ƒåç§»</h3><p><strong>åˆ†å¸ƒåç§»ï¼ˆDistributionShiftï¼‰æ˜¯æŒ‡æ¨¡å‹åœ¨è®­ç»ƒå’Œæµ‹è¯•æ•°æ®é›†ä¹‹é—´çš„æ•°æ®åˆ†å¸ƒä¸åŒ¹é…çš„æƒ…å†µã€‚</strong>è¿™ç§ä¸åŒ¹é…å¯èƒ½å¯¼è‡´æ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šçš„è¡¨ç°ä¸‹é™ï¼Œå› ä¸ºæ¨¡å‹åœ¨è®­ç»ƒæ—¶å­¦ä¹ åˆ°çš„ç‰¹å¾åœ¨æµ‹è¯•æ—¶å¯èƒ½ä¸å†é€‚ç”¨ã€‚</p><h4 id="åˆ†å¸ƒåç§»çš„ç±»å‹">4.9.1 åˆ†å¸ƒåç§»çš„ç±»å‹</h4><ol type="1"><li><strong>åå˜é‡ï¼ˆç‰¹å¾ï¼‰åç§»</strong>ï¼šè™½ç„¶è¾“å…¥çš„åˆ†å¸ƒæ”¹å˜ï¼Œä½†æ ‡ç­¾æ²¡æœ‰æ”¹å˜ã€‚ä¾‹å¦‚çŒ«ç‹—è¯†åˆ«ï¼Œè®­ç»ƒæ•°æ®ä¸»è¦æ¥è‡ªå®¶å…»ï¼Œè€Œæµ‹è¯•æ•°æ®ä¸»è¦æ¥è‡ªé‡å¤–æ‹æ‘„ï¼Œæ­¤æ—¶è¾“å…¥æ•°æ®çš„åˆ†å¸ƒå‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ ‡ç­¾ï¼ˆçŒ«æˆ–ç‹—ï¼‰æ²¡æœ‰å˜åŒ–ã€‚</li><li><strong>æ ‡ç­¾åç§»</strong>ï¼šè™½ç„¶è¾“å…¥çš„åˆ†å¸ƒä¿æŒä¸å˜ï¼Œä½†æ ‡ç­¾çš„åˆ†å¸ƒæ”¹å˜ã€‚å‡è®¾ä½ è®­ç»ƒäº†ä¸€ä¸ªæ¨¡å‹æ¥é¢„æµ‹æŸåŸå¸‚çš„å¤©æ°”ï¼Œè®­ç»ƒæ•°æ®ä¸­æ™´å¤©å’Œé›¨å¤©çš„æ¯”ä¾‹æ˜¯9:1ï¼Œä½†æµ‹è¯•æ•°æ®ä¸­è¿™ä¸ªæ¯”ä¾‹å˜æˆäº†1:1ã€‚è¾“å…¥çš„å¤©æ°”ç‰¹å¾åˆ†å¸ƒä¿æŒä¸å˜ï¼Œä½†æ ‡ç­¾çš„åˆ†å¸ƒå‘ç”Ÿäº†å˜åŒ–ã€‚</li><li><strong>æ¦‚å¿µåç§»</strong>ï¼šè¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„æ˜ å°„å…³ç³»å‘ç”Ÿäº†å˜åŒ–ï¼Œå³ç‰¹å¾å’Œæ ‡ç­¾ä¹‹é—´çš„å…³ç³»å˜äº†ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªåƒåœ¾é‚®ä»¶åˆ†ç±»å™¨ï¼Œè®­ç»ƒæ•°æ®ä¸­åƒåœ¾é‚®ä»¶çš„ç‰¹å¾æ˜¯æŸäº›å…³é”®è¯ï¼ˆå¦‚â€œå…è´¹â€ã€â€œä¼˜æƒ â€ç­‰ï¼‰ï¼Œä½†éšç€æ—¶é—´æ¨ç§»ï¼Œåƒåœ¾é‚®ä»¶å‘é€è€…æ”¹å˜äº†ç­–ç•¥ï¼Œä½¿ç”¨äº†æ–°çš„å…³é”®è¯ï¼ˆå¦‚â€œä¿ƒé”€â€ã€â€œæŠ˜æ‰£â€ç­‰ï¼‰ã€‚</li></ol><h4 id="åˆ†å¸ƒåç§»çº æ­£">4.9.2 åˆ†å¸ƒåç§»çº æ­£</h4><p>å¯ä»¥é‡‡ç”¨<strong>åŠ æƒç»éªŒé£é™©æœ€å°åŒ–</strong>ç­‰æ–¹æ³•ã€‚</p><p>æ³¨ï¼šçœŸå®é£é™©æ˜¯ä»çœŸå®åˆ†å¸ƒä¸­æŠ½å–çš„æ‰€æœ‰æ•°æ®çš„æ€»ä½“æŸå¤±çš„é¢„æœŸã€‚ç„¶è€Œï¼Œè¿™ä¸ªæ•°æ®æ€»ä½“é€šå¸¸æ˜¯æ— æ³•è·å¾—çš„ã€‚ç»éªŒé£é™©æ˜¯è®­ç»ƒæ•°æ®çš„å¹³å‡æŸå¤±ï¼Œç”¨äºè¿‘ä¼¼çœŸå®é£é™©ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬è¿›è¡Œç»éªŒé£é™©æœ€å°åŒ–ã€‚</p><h3 id="å®æˆ˜kaggleæ¯”èµ›æˆ¿ä»·é¢„æµ‹">4.10 å®æˆ˜Kaggleæ¯”èµ›ï¼šæˆ¿ä»·é¢„æµ‹</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hashlib<span class="token keyword">import</span> os<span class="token keyword">import</span> tarfile<span class="token keyword">import</span> zipfile<span class="token keyword">import</span> requests<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token keyword">def</span> <span class="token function">download</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cache_dir<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ä¸‹è½½ä¸€ä¸ªDATA_HUBä¸­çš„æ–‡ä»¶ï¼Œè¿”å›æœ¬åœ°æ–‡ä»¶å"""</span>    <span class="token keyword">assert</span> name <span class="token keyword">in</span> DATA_HUB<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> ä¸å­˜åœ¨äº </span><span class="token interpolation"><span class="token punctuation">&#123;</span>DATA_HUB<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    url<span class="token punctuation">,</span> sha1_hash <span class="token operator">=</span> DATA_HUB<span class="token punctuation">[</span>name<span class="token punctuation">]</span>    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>cache_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    fname <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cache_dir<span class="token punctuation">,</span> url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>        sha1 <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># åˆå§‹åŒ–ä¸€ä¸ªsha1å¯¹è±¡</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1048576</span><span class="token punctuation">)</span>  <span class="token comment"># é€å—è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ¯æ¬¡è¯»å– 1 MB</span>                <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>                    <span class="token keyword">break</span>                sha1<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># sha1å¯ä»¥åœ¨å†å²å“ˆå¸Œå€¼åŸºç¡€ä¸Šç”¨å½“å‰æ–‡ä»¶å†…å®¹æ›´æ–°å“ˆå¸Œå€¼</span>        <span class="token keyword">if</span> sha1<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> sha1_hash<span class="token punctuation">:</span>            <span class="token keyword">return</span> fname  <span class="token comment"># å‘½ä¸­ç¼“å­˜</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'æ­£åœ¨ä»</span><span class="token interpolation"><span class="token punctuation">&#123;</span>url<span class="token punctuation">&#125;</span></span><span class="token string">ä¸‹è½½</span><span class="token interpolation"><span class="token punctuation">&#123;</span>fname<span class="token punctuation">&#125;</span></span><span class="token string">...'</span></span><span class="token punctuation">)</span>    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>r<span class="token punctuation">.</span>content<span class="token punctuation">)</span>    <span class="token keyword">return</span> fname<span class="token keyword">def</span> <span class="token function">download_extract</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> folder<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ä¸‹è½½å¹¶è§£å‹zip/taræ–‡ä»¶"""</span>    fname <span class="token operator">=</span> download<span class="token punctuation">(</span>name<span class="token punctuation">)</span>    base_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>    data_dir<span class="token punctuation">,</span> ext <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>    <span class="token keyword">if</span> ext <span class="token operator">==</span> <span class="token string">'.zip'</span><span class="token punctuation">:</span>        fp <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> ext <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'.tar'</span><span class="token punctuation">,</span> <span class="token string">'.gz'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        fp <span class="token operator">=</span> tarfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'åªæœ‰zip/taræ–‡ä»¶å¯ä»¥è¢«è§£å‹ç¼©'</span>    fp<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>base_dir<span class="token punctuation">)</span>    <span class="token keyword">return</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> folder<span class="token punctuation">)</span> <span class="token keyword">if</span> folder <span class="token keyword">else</span> data_dir<span class="token keyword">def</span> <span class="token function">download_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ä¸‹è½½DATA_HUBä¸­çš„æ‰€æœ‰æ–‡ä»¶"""</span>    <span class="token keyword">for</span> name <span class="token keyword">in</span> DATA_HUB<span class="token punctuation">:</span>        download<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_net</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> net<span class="token comment"># é‡‡ç”¨ç›¸å¯¹è¯¯å·®è€Œä¸æ˜¯ç»å¯¹è¯¯å·®æ¥è¡¡é‡è¯¯å·®</span><span class="token keyword">def</span> <span class="token function">log_rmse</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> features<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># å°†é¢„æµ‹å€¼ä¸­å°äº1çš„éƒ¨åˆ†è®¾ç½®ä¸º1ï¼Œä»¥é¿å…åœ¨å–å¯¹æ•°æ—¶å‡ºç°è´Ÿæ— ç©·å¤§çš„æƒ…å†µ</span>    clipped_preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>net<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    rmse <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>loss<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>clipped_preds<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> rmse<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span> test_features<span class="token punctuation">,</span> test_labels<span class="token punctuation">,</span>          num_epochs<span class="token punctuation">,</span> learning_rate<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    train_ls<span class="token punctuation">,</span> test_ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    train_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_array<span class="token punctuation">(</span><span class="token punctuation">(</span>train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>    <span class="token comment"># è¿™é‡Œä½¿ç”¨çš„æ˜¯Adamä¼˜åŒ–ç®—æ³•</span>    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                 lr<span class="token operator">=</span>learning_rate<span class="token punctuation">,</span>                                 weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">)</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>            l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>            l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>        train_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>log_rmse<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> test_labels <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            test_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>log_rmse<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_features<span class="token punctuation">,</span> test_labels<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> train_ls<span class="token punctuation">,</span> test_ls<span class="token comment"># ç”¨KæŠ˜äº¤å‰éªŒè¯æ¥è¯„ä¼°æ¨¡å‹</span><span class="token keyword">def</span> <span class="token function">get_k_fold_data</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> i<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> k <span class="token operator">></span> <span class="token number">1</span>    fold_size <span class="token operator">=</span> X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> k    X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>        idx <span class="token operator">=</span> <span class="token builtin">slice</span><span class="token punctuation">(</span>j <span class="token operator">*</span> fold_size<span class="token punctuation">,</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> fold_size<span class="token punctuation">)</span>        X_part<span class="token punctuation">,</span> y_part <span class="token operator">=</span> X<span class="token punctuation">[</span>idx<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>        <span class="token keyword">if</span> j <span class="token operator">==</span> i<span class="token punctuation">:</span>            X_valid<span class="token punctuation">,</span> y_valid <span class="token operator">=</span> X_part<span class="token punctuation">,</span> y_part        <span class="token keyword">elif</span> X_train <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> X_part<span class="token punctuation">,</span> y_part        <span class="token keyword">else</span><span class="token punctuation">:</span>            X_train <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>X_train<span class="token punctuation">,</span> X_part<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>            y_train <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>y_train<span class="token punctuation">,</span> y_part<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> X_valid<span class="token punctuation">,</span> y_valid<span class="token keyword">def</span> <span class="token function">k_fold</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> learning_rate<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    train_l_sum<span class="token punctuation">,</span> valid_l_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>        data <span class="token operator">=</span> get_k_fold_data<span class="token punctuation">(</span>k<span class="token punctuation">,</span> i<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>        net <span class="token operator">=</span> get_net<span class="token punctuation">(</span><span class="token punctuation">)</span>        train_ls<span class="token punctuation">,</span> valid_ls <span class="token operator">=</span> train<span class="token punctuation">(</span>net<span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> learning_rate<span class="token punctuation">,</span>                                   weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>        train_l_sum <span class="token operator">+=</span> train_ls<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>        valid_l_sum <span class="token operator">+=</span> valid_ls<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            d2l<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>train_ls<span class="token punctuation">,</span> valid_ls<span class="token punctuation">]</span><span class="token punctuation">,</span>                     xlabel<span class="token operator">=</span><span class="token string">'epoch'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'rmse'</span><span class="token punctuation">,</span> xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span>                     legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yscale<span class="token operator">=</span><span class="token string">'log'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'æŠ˜</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">ï¼Œè®­ç»ƒlog rmse</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">float</span><span class="token punctuation">(</span>train_ls<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">, '</span></span>              <span class="token string-interpolation"><span class="token string">f'éªŒè¯log rmse</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">float</span><span class="token punctuation">(</span>valid_ls<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token keyword">return</span> train_l_sum <span class="token operator">/</span> k<span class="token punctuation">,</span> valid_l_sum <span class="token operator">/</span> k<span class="token keyword">def</span> <span class="token function">train_and_pred</span><span class="token punctuation">(</span>train_features<span class="token punctuation">,</span> test_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span> test_data<span class="token punctuation">,</span>                   num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    net <span class="token operator">=</span> get_net<span class="token punctuation">(</span><span class="token punctuation">)</span>    train_ls<span class="token punctuation">,</span> _ <span class="token operator">=</span> train<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span>                        num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>    d2l<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>train_ls<span class="token punctuation">]</span><span class="token punctuation">,</span> xlabel<span class="token operator">=</span><span class="token string">'epoch'</span><span class="token punctuation">,</span>             ylabel<span class="token operator">=</span><span class="token string">'log rmse'</span><span class="token punctuation">,</span> xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span> yscale<span class="token operator">=</span><span class="token string">'log'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'è®­ç»ƒlog rmseï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">float</span><span class="token punctuation">(</span>train_ls<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token comment"># å°†ç½‘ç»œåº”ç”¨äºæµ‹è¯•é›†ã€‚</span>    preds <span class="token operator">=</span> net<span class="token punctuation">(</span>test_features<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># å°†å…¶é‡æ–°æ ¼å¼åŒ–ä»¥å¯¼å‡ºåˆ°Kaggle</span>    test_data<span class="token punctuation">[</span><span class="token string">'SalePrice'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>preds<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    submission <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>test_data<span class="token punctuation">[</span><span class="token string">'Id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_data<span class="token punctuation">[</span><span class="token string">'SalePrice'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    submission<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'submission.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    DATA_HUB <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    DATA_URL <span class="token operator">=</span> <span class="token string">'http://d2l-data.s3-accelerate.amazonaws.com/'</span>    DATA_HUB<span class="token punctuation">[</span><span class="token string">'kaggle_house_train'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>        DATA_URL <span class="token operator">+</span> <span class="token string">'kaggle_house_pred_train.csv'</span><span class="token punctuation">,</span> <span class="token string">'585e9cc93e70b39160e7921475f9bcd7d31219ce'</span><span class="token punctuation">)</span>    DATA_HUB<span class="token punctuation">[</span><span class="token string">'kaggle_house_test'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>        DATA_URL <span class="token operator">+</span> <span class="token string">'kaggle_house_pred_test.csv'</span><span class="token punctuation">,</span> <span class="token string">'fa19780a7b011d9b009e8bff8e99922a8ee2eb90'</span><span class="token punctuation">)</span>    <span class="token comment">#  åˆ’åˆ†è®­ç»ƒé›†ä»¥åˆ›å»ºéªŒè¯é›†</span>    train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>download<span class="token punctuation">(</span><span class="token string">'kaggle_house_train'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    test_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>download<span class="token punctuation">(</span><span class="token string">'kaggle_house_test'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># åˆ é™¤IDåˆ—ä»¥åŠæ ‡ç­¾åˆ—</span>    all_features <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">(</span>train_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># æ•°æ®é¢„å¤„ç†</span>    <span class="token comment"># è‹¥æ— æ³•è·å¾—æµ‹è¯•æ•°æ®ï¼Œåˆ™å¯æ ¹æ®è®­ç»ƒæ•°æ®è®¡ç®—å‡å€¼å’Œæ ‡å‡†å·®</span>    numeric_features <span class="token operator">=</span> all_features<span class="token punctuation">.</span>dtypes<span class="token punctuation">[</span>all_features<span class="token punctuation">.</span>dtypes <span class="token operator">!=</span>                                           <span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index    all_features<span class="token punctuation">[</span>numeric_features<span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span>numeric_features<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>        <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># æ ‡å‡†åŒ–æ•°æ®æœ‰ä¸¤ä¸ªåŸå› ï¼š æ–¹ä¾¿ä¼˜åŒ–ï¼›ä¸çŸ¥é“å“ªäº›ç‰¹å¾æ˜¯ç›¸å…³çš„ï¼Œé¿å…è®©æƒ©ç½šåˆ†é…ç»™ä¸€ä¸ªç‰¹å¾çš„ç³»æ•°æ¯”åˆ†é…ç»™å…¶ä»–ä»»ä½•ç‰¹å¾çš„ç³»æ•°æ›´å¤§ã€‚</span>    <span class="token comment"># åœ¨æ ‡å‡†åŒ–æ•°æ®ä¹‹åï¼Œæ‰€æœ‰å‡å€¼æ¶ˆå¤±ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†ç¼ºå¤±å€¼è®¾ç½®ä¸º0</span>    all_features<span class="token punctuation">[</span>numeric_features<span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span>numeric_features<span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># å°†ç¦»æ•£æ•°å€¼è½¬æ¢ä¸ºç‹¬çƒ­ç¼–ç (get_dummieså‡½æ•°å°†åˆ†ç±»å˜é‡è½¬æ¢ä¸ºè™šæ‹Ÿå˜é‡)</span>    <span class="token comment"># â€œDummy_na=Trueâ€å°†â€œnaâ€ï¼ˆç¼ºå¤±å€¼ï¼‰è§†ä¸ºæœ‰æ•ˆçš„ç‰¹å¾å€¼ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºæŒ‡ç¤ºç¬¦ç‰¹å¾</span>    all_features <span class="token operator">=</span> pd<span class="token punctuation">.</span>get_dummies<span class="token punctuation">(</span>all_features<span class="token punctuation">,</span> dummy_na<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># é€šè¿‡valueså±æ€§å¾—åˆ°NumPyæ ¼å¼çš„æ•°æ®ï¼Œå¹¶è½¬æ¢æˆå¼ é‡</span>    n_train <span class="token operator">=</span> train_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    train_features <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>        all_features<span class="token punctuation">[</span><span class="token punctuation">:</span>n_train<span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    test_features <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>        all_features<span class="token punctuation">[</span>n_train<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    train_labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>        train_data<span class="token punctuation">.</span>SalePrice<span class="token punctuation">.</span>values<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>    <span class="token comment"># è®­ç»ƒæ¨¡å‹</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>    in_features <span class="token operator">=</span> train_features<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    k<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span>    <span class="token comment"># å°†è®­ç»ƒé›†åˆ’åˆ†ä¸ºKä»½ï¼Œç„¶åä½¿ç”¨ç¬¬Kä»½ä½œä¸ºéªŒè¯é›†ï¼Œå…¶ä½™ä½œä¸ºè®­ç»ƒé›†</span>    train_l<span class="token punctuation">,</span> valid_l <span class="token operator">=</span> k_fold<span class="token punctuation">(</span>        k<span class="token punctuation">,</span> train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>k<span class="token punctuation">&#125;</span></span><span class="token string">-æŠ˜éªŒè¯: å¹³å‡è®­ç»ƒlog rmse: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">float</span><span class="token punctuation">(</span>train_l<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">, '</span></span><span class="token string-interpolation"><span class="token string">f'å¹³å‡éªŒè¯log rmse: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">float</span><span class="token punctuation">(</span>valid_l<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token comment"># ä½¿ç”¨æ‰€æœ‰æ•°æ®å¯¹å…¶è¿›è¡Œè®­ç»ƒï¼Œç„¶åé¢„æµ‹å¹¶åœ¨Kaggleæäº¤ç»“æœ</span>    train_and_pred<span class="token punctuation">(</span>train_features<span class="token punctuation">,</span> test_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">,</span>                   test_data<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span></code></pre><h3 id="é™„å½•">é™„å½•</h3><h4 id="é™„å½•aæ¿€æ´»å‡½æ•°ç»˜å›¾ä»£ç ">é™„å½•Aï¼šæ¿€æ´»å‡½æ•°ç»˜å›¾ä»£ç </h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> matplotlib <span class="token keyword">as</span> mpl<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token comment"># è®¾ç½®ä¸­æ–‡å­—ä½“</span>mpl<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>mpl<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token comment"># å®šä¹‰æ¿€æ´»å‡½æ•°</span><span class="token keyword">def</span> <span class="token function">relu</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sigmoid</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">tanh</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">prelu</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> alpha <span class="token operator">*</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token comment"># å®šä¹‰å¯¼æ•°</span><span class="token keyword">def</span> <span class="token function">relu_derivative</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sigmoid_derivative</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    s <span class="token operator">=</span> sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token keyword">return</span> s <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">tanh_derivative</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> np<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token keyword">def</span> <span class="token function">prelu_derivative</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºæ•°æ®ç‚¹</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºå›¾å½¢å’Œå­å›¾ (2è¡Œ4åˆ—ï¼Œå…±8ä¸ªå­å›¾)</span>fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># è®¾ç½®å›¾è¡¨æ ‡é¢˜</span>fig<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span><span class="token string">'æ¿€æ´»å‡½æ•°åŠå…¶å¯¼æ•°å¯¹æ¯”'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token comment"># ç¬¬ä¸€è¡Œï¼šæ¿€æ´»å‡½æ•°</span><span class="token comment"># ReLU æ¿€æ´»å‡½æ•°</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'ReLU æ¿€æ´»å‡½æ•°'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'ReLU(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># Sigmoid æ¿€æ´»å‡½æ•°</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'g-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Sigmoid æ¿€æ´»å‡½æ•°'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Sigmoid(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># Tanh æ¿€æ´»å‡½æ•°</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> tanh<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'b-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Tanh æ¿€æ´»å‡½æ•°'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Tanh(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># pReLU æ¿€æ´»å‡½æ•°</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> prelu<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'m-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'pReLU æ¿€æ´»å‡½æ•° (Î±=0.2)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'pReLU(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># ç¬¬äºŒè¡Œï¼šå¯¼æ•°</span><span class="token comment"># ReLU å¯¼æ•°</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> relu_derivative<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'ReLU å¯¼æ•°'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'ReLU\'(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># Sigmoid å¯¼æ•°</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> sigmoid_derivative<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'g-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Sigmoid å¯¼æ•°'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Sigmoid\'(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># Tanh å¯¼æ•°</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> tanh_derivative<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'b-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Tanh å¯¼æ•°'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Tanh\'(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># pReLU å¯¼æ•°</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> prelu_derivative<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'m-'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'pReLU å¯¼æ•° (Î±=0.2)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'pReLU\'(x)'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axhline<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>axvline<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'k'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token comment"># è°ƒæ•´å¸ƒå±€</span>plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># ä¿å­˜å›¾åƒ</span>save_path <span class="token operator">=</span> <span class="token string">'./source/_posts/DL/activation_functions.svg'</span>plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'svg'</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> bbox_inches<span class="token operator">=</span><span class="token string">'tight'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å›¾åƒå·²ä¿å­˜è‡³: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>save_path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token comment"># æ˜¾ç¤ºå›¾åƒ</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h4id="é™„å½•bç¥ç»ç½‘ç»œåå‘ä¼ æ’­é€šä¿—è§£é‡Š">é™„å½•Bï¼šç¥ç»ç½‘ç»œåå‘ä¼ æ’­é€šä¿—è§£é‡Š</h4><p>ç¥ç»ç½‘ç»œä½¿ç”¨åå‘ä¼ æ’­ç®—æ³•è¿›è¡Œè®­ç»ƒï¼Œæ ¸å¿ƒæ˜¯é“¾å¼æ³•åˆ™ï¼ˆé“¾å¼æ±‚å¯¼ï¼‰ï¼Œè®­ç»ƒçš„ç›®æ ‡æ˜¯æœ€å°åŒ–æŸå¤±å‡½æ•°ã€‚æˆ‘ä»¬è¦è§£å†³çš„å°±æ˜¯æ€ä¹ˆè°ƒæ•´æ¨¡å‹çš„å‚æ•°<spanclass="math inline">\(\omega\)</span>æ‰èƒ½è®©æŸå¤±å‡½æ•°æœ€å°ã€‚</p><p>è¿™å°±ç±»ä¼¼äº<spanclass="math inline">\(y=f(x)\)</span>çš„å‡½æ•°ï¼Œæˆ‘ä»¬æƒ³è¦æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„<spanclass="math inline">\(x\)</span>ä½¿å¾—<spanclass="math inline">\(y\)</span>æœ€å°ã€‚è¿™é‡Œçš„<spanclass="math inline">\(x\)</span>å°±æ˜¯ç¥ç»ç½‘ç»œçš„å‚æ•°<spanclass="math inline">\(\omega\)</span>ï¼Œè€Œ<spanclass="math inline">\(y\)</span>å°±æ˜¯æŸå¤±å‡½æ•°<spanclass="math inline">\(L(\omega)\)</span>ã€‚è‡ªç„¶è€Œç„¶çš„å¼•å‡ºäº†å¯¼æ•°çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯æ¢¯åº¦<spanclass="math inline">\(\frac{\partial L}{\partial\omega}\)</span>ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬åœ¨å½“å‰å‚æ•°ä½ç½®ï¼ŒæŸå¤±å‡½æ•°çš„å˜åŒ–ç‡ã€‚</p><p>ç”±æ­¤å¼•å‡ºä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><p><strong>1. å¯¼æ•°å’Œæ¢¯åº¦çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>æƒ…å†µä¸€ï¼šä¸€å…ƒå‡½æ•°ï¼ˆåªæœ‰ä¸€ä¸ªè¾“å…¥ï¼‰<span class="math inline">\(f(w) =w^2\)</span></p><ul><li>å®ƒçš„å¯¼æ•°æ˜¯ï¼š<span class="math inline">\(\frac{df}{dw} =2w\)</span></li><li>å®ƒçš„æ¢¯åº¦ä¹Ÿæ˜¯ï¼š<span class="math inline">\(\nabla f(w) =(2w)\)</span></li></ul><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>æ¢¯åº¦å°±ç­‰äºå¯¼æ•°æœ¬èº«</strong>ï¼Œåªæ˜¯å†™æˆäº†ä¸€ä¸ªä¸€ç»´å‘é‡ã€‚</p><p>æƒ…å†µäºŒï¼šå¤šå…ƒå‡½æ•°ï¼ˆå¤šä¸ªè¾“å…¥ï¼‰<span class="math inline">\(f(w_1, w_2) =w_1^2 + w_2^2\)</span></p><p><strong>æ²¡æ³•ç”¨ã€Œå¯¼æ•°ã€æè¿°å®ƒçš„å…¨éƒ¨æ–¹å‘çš„å˜åŒ–</strong>ã€‚è¦ç”¨æ¢¯åº¦ï¼š<spanclass="math inline">\(\nabla f = \left( \frac{\partial f}{\partial w_1},\frac{\partial f}{\partial w_2} \right) = (2w_1, 2w_2)\)</span></p><table><colgroup><col style="width: 46%" /><col style="width: 12%" /><col style="width: 40%" /></colgroup><thead><tr><th>æƒ…å†µ</th><th>ä½¿ç”¨çš„æ¦‚å¿µ</th><th>æ˜¯å¦ç­‰ä»·</th></tr></thead><tbody><tr><td>ä¸€ç»´å‡½æ•° <span class="math inline">\(f(w)\)</span></td><td>å¯¼æ•° &amp; æ¢¯åº¦</td><td>âœ… ç­‰ä»·ï¼ˆæ¢¯åº¦æ˜¯ 1 ç»´å‘é‡ï¼‰</td></tr><tr><td>å¤šç»´å‡½æ•° <span class="math inline">\(f(w_1, w_2,\dots)\)</span></td><td>æ¢¯åº¦ï¼ˆå‘é‡ï¼‰</td><td>âŒ ä¸ç­‰ä»·ï¼Œå¯¼æ•°åªçœ‹ä¸€ä¸ªæ–¹å‘ï¼Œæ¢¯åº¦æ˜¯å…¨éƒ¨æ–¹å‘</td></tr></tbody></table><p><strong>2. ä¸ºä»€ä¹ˆä¸ç›´æ¥è®©æ¢¯åº¦ä¸º0å°±å¯ä»¥äº†ï¼Ÿ</strong></p><table><colgroup><col style="width: 31%" /><col style="width: 68%" /></colgroup><thead><tr><th>é—®é¢˜</th><th>å›ç­”</th></tr></thead><tbody><tr><td>ä¸ºä»€ä¹ˆä¸ç›´æ¥è®©æ¢¯åº¦ä¸º 0ï¼Ÿ</td><td>å› ä¸ºæ±‚ä¸å‡ºæ¥ï¼ˆæ— è§£æè§£ï¼‰ï¼Œè€Œä¸”æ¢¯åº¦ä¸º 0 ä¸ä¸€å®šæ˜¯æœ€å°å€¼</td></tr><tr><td>é‚£æˆ‘ä»¬æ€ä¹ˆåšï¼Ÿ</td><td>ä½¿ç”¨æ¢¯åº¦ä¸‹é™ï¼Œæ²¿ç€è´Ÿæ¢¯åº¦æ–¹å‘ä¸€ç‚¹ç‚¹èµ°ï¼Œé€æ­¥é€¼è¿‘æœ€å°å€¼</td></tr><tr><td>å¥½å¤„ï¼Ÿ</td><td>ä¸éœ€è¦æ˜¾å¼è§£æ–¹ç¨‹ï¼Œé€‚åˆé«˜ç»´ã€å¤§è§„æ¨¡ã€éçº¿æ€§ä¼˜åŒ–é—®é¢˜</td></tr></tbody></table><p><strong>3. æœ‰äº†æ¢¯åº¦ä¹‹åæ€ä¹ˆæ›´æ–°å‚æ•°ï¼Ÿä¸ºä»€ä¹ˆè¿™ä¹ˆæ›´æ–°ï¼Ÿ</strong></p><p>æœ‰äº†æ¢¯åº¦ä¹‹åï¼Œ<strong>æˆ‘ä»¬ç”¨æ¢¯åº¦çš„åæ–¹å‘æ¥æ›´æ–°å‚æ•°</strong>ï¼Œå› ä¸ºæ¢¯åº¦æŒ‡å‡ºäº†æŸå¤±å‡½æ•°å¢åŠ æœ€å¿«çš„æ–¹å‘ï¼Œæ‰€ä»¥åæ–¹å‘æ˜¯<strong>ä¸‹é™æœ€å¿«çš„æ–¹å‘</strong>ã€‚</p><p>å‚æ•°æ›´æ–°çš„å…¬å¼ï¼ˆæ¢¯åº¦ä¸‹é™æ³•ï¼‰ã€‚è®¾ï¼š</p><ul><li><spanclass="math inline">\(\mathbf{w}\)</span>ï¼šæ¨¡å‹å‚æ•°ï¼ˆå¯ä»¥æ˜¯æƒé‡ã€åç½®ç­‰ï¼‰</li><li><spanclass="math inline">\(\mathcal{L}(\mathbf{w})\)</span>ï¼šæŸå¤±å‡½æ•°</li><li><span class="math inline">\(\nabla\mathcal{L}(\mathbf{w})\)</span>ï¼šå½“å‰å‚æ•°å¤„çš„æ¢¯åº¦</li><li><span class="math inline">\(\eta\)</span>ï¼šå­¦ä¹ ç‡ï¼ˆlearningrateï¼Œæ§åˆ¶æ­¥å­å¤§å°ï¼‰</li></ul><p>é‚£ä¹ˆå‚æ•°æ›´æ–°å…¬å¼ä¸ºï¼š</p><p><span class="math display">\[\mathbf{w}_{\text{new}} = \mathbf{w}_{\text{old}} - \eta \cdot \nabla\mathcal{L}(\mathbf{w}_{\text{old}})\tag{B.1}\]</span></p><p>ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªå…¬å¼ï¼Ÿ</p><blockquote><p>1ï¸âƒ£ æ¢¯åº¦å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ</p></blockquote><p>æ¢¯åº¦ <span class="math inline">\(\nabla\mathcal{L}(\mathbf{w})\)</span> æ˜¯ä¸€ä¸ªå‘é‡ï¼Œè¡¨ç¤ºåœ¨æ¯ä¸€ä¸ªç»´åº¦ä¸Šï¼š</p><ul><li>å¢åŠ å‚æ•° â†’ æŸå¤±å‡½æ•°ä¼šä¸Šå‡å¤šå°‘</li></ul><p>æ‰€ä»¥æ¢¯åº¦çš„æ–¹å‘ï¼Œå°±æ˜¯â€œæŸå¤±å‡½æ•°ä¸Šå‡æœ€å¿«çš„æ–¹å‘â€</p><blockquote><p>2ï¸âƒ£ é‚£æˆ‘ä»¬æƒ³åšä»€ä¹ˆï¼Ÿ</p></blockquote><p>æˆ‘ä»¬æƒ³è®©æŸå¤±å‡½æ•° <strong>å˜å°</strong>ï¼Œè€Œä¸æ˜¯å˜å¤§ï¼</p><p>å› æ­¤ï¼Œæˆ‘ä»¬è¦æœ<strong>æŸå¤±ä¸‹é™æœ€å¿«çš„æ–¹å‘</strong>ç§»åŠ¨ï¼Œé‚£å°±æ˜¯æ¢¯åº¦çš„<strong>è´Ÿæ–¹å‘</strong>ï¼š<spanclass="math inline">\(-\nabla \mathcal{L}(\mathbf{w})\)</span></p><blockquote><p>3ï¸âƒ£ ä¸ºä»€ä¹ˆè¿˜è¦ä¹˜ä¸€ä¸ª <span class="math inline">\(\eta\)</span>å­¦ä¹ ç‡ï¼Ÿ</p></blockquote><p>æ¢¯åº¦åªæ˜¯ä¸€ä¸ªæ–¹å‘ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ§åˆ¶â€œèµ°å¤šè¿œâ€ï¼š</p><ul><li>æ­¥å­å¤ªå¤§ â†’ å¯èƒ½é”™è¿‡æœ€å°å€¼ï¼Œç”šè‡³éœ‡è¡æˆ–å‘æ•£</li><li>æ­¥å­å¤ªå° â†’ å­¦å¾—å¤ªæ…¢ï¼Œæ”¶æ•›ææ…¢</li></ul><p>æ‰€ä»¥æˆ‘ä»¬åŠ ä¸€ä¸ªç³»æ•° <span class="math inline">\(\eta\)</span>ï¼Œå°±æ˜¯<strong>å­¦ä¹ ç‡</strong>ï¼Œæ¥æ§åˆ¶æ›´æ–°çš„å¹…åº¦ï¼š<spanclass="math inline">\(\text{æ›´æ–°é‡} = -\eta \cdot \nabla\mathcal{L}(\mathbf{w})\)</span></p><table><colgroup><col style="width: 8%" /><col style="width: 91%" /></colgroup><thead><tr><th>æ­¥éª¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>1. è®¡ç®—æ¢¯åº¦</td><td>å¾—åˆ°æŸå¤±å‡½æ•°å¯¹å‚æ•°çš„å¯¼æ•°ï¼ˆæ¯ä¸ªæ–¹å‘çš„å˜åŒ–ç‡ï¼‰</td></tr><tr><td>2. å–åæ–¹å‘</td><td>å› ä¸ºæ¢¯åº¦æ˜¯ä¸Šå‡æ–¹å‘ï¼Œä¸‹é™è¦èµ°åæ–¹å‘</td></tr><tr><td>3. ä¹˜ä»¥å­¦ä¹ ç‡</td><td>æ§åˆ¶æ›´æ–°çš„å¹…åº¦ï¼Œé¿å…æ­¥å­å¤ªå¤§æˆ–å¤ªå°</td></tr><tr><td>4. æ›´æ–°å‚æ•°</td><td><span class="math inline">\(\mathbf{w}_{\text{new}} =\mathbf{w}_{\text{old}} - \eta \cdot \nabla \mathcal{L}\)</span></td></tr></tbody></table><h4id="é™„å½•cä¸ºä»€ä¹ˆå…³æ³¨æ¿€æ´»å‡½æ•°çš„å¯¼æ•°">é™„å½•Cï¼šä¸ºä»€ä¹ˆå…³æ³¨æ¿€æ´»å‡½æ•°çš„å¯¼æ•°ï¼Ÿ</h4><blockquote><p><strong>ä¸¾ä¾‹ï¼šReLU çš„å¯¼æ•°</strong></p></blockquote><ul><li><p>ReLU(x) = max(0, x)</p></li><li><p>å®ƒçš„å¯¼æ•°ä¸ºï¼š</p><p><span class="math display">\[\text{ReLU}&#39;(x) = \begin{cases}1, &amp; x &gt; 0 \\0, &amp; x \leq 0\end{cases}\tag{C.1}\]</span></p></li></ul><p>è¿™æ„å‘³ç€åªæœ‰å½“è¾“å…¥ä¸ºæ­£æ—¶ï¼ŒReLU æ‰ä¼šè®©æ¢¯åº¦æµåŠ¨â€”â€”å¦åˆ™æ¢¯åº¦ä¸º0ï¼Œç¥ç»å…ƒä¸å†å­¦ä¹ ã€‚</p><blockquote><p><strong>äº†è§£æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸çš„é—®é¢˜</strong></p></blockquote><p>æŸäº›æ¿€æ´»å‡½æ•°çš„å¯¼æ•°å¯èƒ½å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ï¼ˆå¦‚ Sigmoidï¼‰æˆ–çˆ†ç‚¸ï¼ˆå¦‚ Softplusçš„å¤§è¾“å…¥ï¼‰ã€‚åˆ†æå¯¼æ•°å¯ä»¥å¸®åŠ©ç†è§£å’Œé€‰æ‹©<strong>æ›´åˆé€‚çš„æ¿€æ´»å‡½æ•°</strong>ï¼Œé¿å…è¿™äº›é—®é¢˜ã€‚</p><p><strong>ä¾‹å­ï¼šSigmoid çš„å¯¼æ•°</strong></p><ul><li>æœ€å¤§å€¼æ˜¯ 0.25ï¼Œè¾“å…¥è¿‡å¤§æˆ–è¿‡å°æ—¶å¯¼æ•°æ¥è¿‘ 0ï¼Œå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ã€‚</li></ul><blockquote><p><strong>è®¾è®¡æ–°æ¿€æ´»å‡½æ•°</strong></p></blockquote><p>å¾ˆå¤šæ”¹è¿›å‹æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ LeakyReLUã€ELUã€Swishã€Mishï¼‰éƒ½æ˜¯åŸºäºå¯¹å¯¼æ•°è¡Œä¸ºçš„æ·±å…¥ç†è§£åæå‡ºçš„ã€‚ä¾‹å¦‚ï¼š</p><ul><li><p><strong>Leaky ReLU</strong>ï¼šè§£å†³ ReLUçš„â€œç¥ç»å…ƒæ­»äº¡â€é—®é¢˜ï¼ˆå³ä¸€æ—¦è¾“å‡ºä¸º0ï¼Œå°±æ— æ³•æ¢å¤ï¼‰ï¼Œé€šè¿‡åœ¨è´ŸåŒºé—´ç»™ä¸€ä¸ªå°æ–œç‡ï¼ˆå¯¼æ•°éé›¶ï¼‰ï¼š</p><p><span class="math display">\[\text{Leaky ReLU}(x) = \begin{cases}x, &amp; x &gt; 0 \\0.01x, &amp; x \leq 0\end{cases}\tag{C.2}\]</span></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 3 çº¿æ€§ç¥ç»ç½‘ç»œ</title>
      <link href="/2024/06/25/DL/3%20%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
      <url>/2024/06/25/DL/3%20%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="çº¿æ€§ç¥ç»ç½‘ç»œ">3 çº¿æ€§ç¥ç»ç½‘ç»œ</h2><h3 id="çº¿æ€§å›å½’">3.1 çº¿æ€§å›å½’</h3><p>å›å½’ï¼ˆregressionï¼‰æ˜¯èƒ½ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå˜é‡ä¸å› å˜é‡ä¹‹é—´å…³ç³»å»ºæ¨¡çš„ä¸€ç±»æ–¹æ³•ã€‚</p><h4 id="éšæœºæ¢¯åº¦ä¸‹é™">3.1.1 éšæœºæ¢¯åº¦ä¸‹é™</h4><p><strong>æ¢¯åº¦ä¸‹é™é€šè¿‡ä¸æ–­åœ°åœ¨æŸå¤±å‡½æ•°é€’å‡çš„æ–¹å‘ä¸Šæ›´æ–°å‚æ•°æ¥é™ä½è¯¯å·®ã€‚</strong></p><p><span class="math display">\[w \leftarrow w - \eta \frac{\partial(J)}{\partial(w)}\tag{3.1}\]</span></p><p>æ¢¯åº¦ä¸‹é™æœ€ç®€å•çš„ç”¨æ³•æ˜¯è®¡ç®—<strong>æŸå¤±å‡½æ•°</strong>ï¼ˆæ•°æ®é›†ä¸­æ‰€æœ‰æ ·æœ¬çš„æŸå¤±å‡å€¼ï¼‰<strong>å…³äºæ¨¡å‹å‚æ•°çš„å¯¼æ•°</strong>ï¼ˆåœ¨è¿™é‡Œä¹Ÿå¯ä»¥ç§°ä¸ºæ¢¯åº¦ï¼‰ã€‚ä½†å®é™…ä¸­çš„æ‰§è¡Œå¯èƒ½ä¼šéå¸¸æ…¢ï¼šå› ä¸ºåœ¨æ¯ä¸€æ¬¡æ›´æ–°å‚æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»éå†æ•´ä¸ªæ•°æ®é›†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šåœ¨æ¯æ¬¡éœ€è¦è®¡ç®—æ›´æ–°çš„æ—¶å€™éšæœºæŠ½å–ä¸€å°æ‰¹æ ·æœ¬ï¼Œè¿™ç§å˜ä½“å«åšå°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™ã€‚</p><p>åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆéšæœºæŠ½æ ·ä¸€ä¸ªå°æ‰¹é‡<spanclass="math inline">\(B\)</span>ï¼Œ å®ƒæ˜¯ç”±å›ºå®šæ•°é‡çš„è®­ç»ƒæ ·æœ¬ç»„æˆçš„ã€‚ç„¶åï¼Œæˆ‘ä»¬è®¡ç®—å°æ‰¹é‡çš„å¹³å‡æŸå¤±å…³äºæ¨¡å‹å‚æ•°çš„å¯¼æ•°ï¼ˆä¹Ÿå¯ä»¥ç§°ä¸ºæ¢¯åº¦ï¼‰ã€‚æœ€åï¼Œæˆ‘ä»¬å°†æ¢¯åº¦ä¹˜ä»¥ä¸€ä¸ªé¢„å…ˆç¡®å®šçš„æ­£æ•°<spanclass="math inline">\(\eta\)</span>ï¼Œå¹¶ä»å½“å‰å‚æ•°çš„å€¼ä¸­å‡æ‰ã€‚</p><p>æ›´å…·ä½“çš„ <spanclass="math inline">\(B\)</span>è¡¨ç¤ºå°æ‰¹é‡ä¸­çš„æ ·æœ¬æ•°ï¼Œä¹Ÿè¢«ç§°ä¸ºæ‰¹é‡å¤§å°ï¼ˆbatchsizeï¼‰ <span class="math inline">\(\eta\)</span>ç§°ä¸ºå­¦ä¹ ç‡ï¼ˆlearningrateï¼‰ï¼Œæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œç”¨æ¥è°ƒèŠ‚æ¯æ¬¡æ›´æ–°çš„å¹…åº¦ã€‚ å½“<spanclass="math inline">\(\eta\)</span>è¾ƒå°æ—¶ï¼Œæ›´æ–°çš„å¹…åº¦è¾ƒå°ã€‚ å½“<spanclass="math inline">\(\eta\)</span>è¾ƒå¤§æ—¶ï¼Œæ›´æ–°çš„å¹…åº¦è¾ƒå¤§ã€‚ å½“<spanclass="math inline">\(\eta\)</span>è¿‡å¤§æ—¶ï¼Œå¯èƒ½ä¼šä½¿æ¨¡å‹åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­å‘æ•£ï¼Œç”šè‡³æ— æ³•æ”¶æ•›åˆ°æœ€ä¼˜è§£ã€‚å½“<spanclass="math inline">\(\eta\)</span>è¿‡å°æ—¶ï¼Œæ¨¡å‹ä¼˜åŒ–çš„é€Ÿåº¦ä¼šè¿‡æ…¢ã€‚</p><p>çº¿æ€§å›å½’æ°å¥½æ˜¯ä¸€ä¸ªåœ¨æ•´ä¸ªåŸŸä¸­åªæœ‰ä¸€ä¸ªæœ€å°å€¼çš„å­¦ä¹ é—®é¢˜ã€‚ä½†æ˜¯å¯¹åƒæ·±åº¦ç¥ç»ç½‘ç»œè¿™æ ·å¤æ‚çš„æ¨¡å‹æ¥è¯´ï¼ŒæŸå¤±å¹³é¢ä¸Šé€šå¸¸åŒ…å«å¤šä¸ªæœ€å°å€¼ã€‚äº‹å®ä¸Šï¼Œæ›´éš¾åšåˆ°çš„æ˜¯æ‰¾åˆ°ä¸€ç»„å‚æ•°ï¼Œè¿™ç»„å‚æ•°èƒ½å¤Ÿåœ¨æˆ‘ä»¬ä»æœªè§è¿‡çš„æ•°æ®ä¸Šå®ç°è¾ƒä½çš„æŸå¤±ï¼Œè¿™ä¸€æŒ‘æˆ˜è¢«ç§°ä¸ºæ³›åŒ–ï¼ˆgeneralizationï¼‰ã€‚</p><h4 id="çŸ¢é‡åŒ–åŠ é€Ÿ">3.1.2 çŸ¢é‡åŒ–åŠ é€Ÿ</h4><p>åœ¨è®­ç»ƒæˆ‘ä»¬çš„æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸å¸Œæœ›èƒ½å¤ŸåŒæ—¶å¤„ç†æ•´ä¸ªå°æ‰¹é‡çš„æ ·æœ¬ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨çº¿æ€§ä»£æ•°åº“ï¼Œè€Œä¸æ˜¯åœ¨Pythonä¸­ç¼–å†™å¼€é”€è¾ƒå¤§çš„forå¾ªç¯ã€‚</p><p>ä¾‹å¦‚ <code>for i in range(n): c[i] = a[i] + b[i]</code> å¯ä»¥è¢«æ›¿æ¢ä¸º<code>c = a + b</code>ã€‚</p><h4 id="æ­£æ€åˆ†å¸ƒä¸å¹³æ–¹æŸå¤±">3.1.3 æ­£æ€åˆ†å¸ƒä¸å¹³æ–¹æŸå¤±</h4><p>æ ¹æ®æå¤§ä¼¼ç„¶ä¼°è®¡æ³•ï¼Œå‚æ•°<span class="math inline">\(w\)</span>å’Œ<spanclass="math inline">\(b\)</span>çš„æœ€ä¼˜å€¼æ˜¯ä½¿æ•´ä¸ªæ•°æ®é›†çš„ä¼¼ç„¶æœ€å¤§çš„å€¼ã€‚ç”±äºå¹³æ–¹æŸå¤±å‡½æ•°ï¼Œè¿™ç­‰ä»·äºæœ€å°åŒ–å¹³æ–¹æŸå¤±ã€‚</p><h4 id="ä»çº¿æ€§å›å½’åˆ°æ·±åº¦ç½‘ç»œ">3.1.4 ä»çº¿æ€§å›å½’åˆ°æ·±åº¦ç½‘ç»œ</h4><p>è¾“å…¥å±‚çš„ç‰¹å¾ç»´åº¦ä¸º<spanclass="math inline">\(d\)</span>ï¼Œè¾“å‡ºå±‚çš„è¾“å‡ºç»´åº¦ä¸º1ï¼Œæ‰€è¡¨ç¤ºçš„ç¥ç»ç½‘ç»œå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ(é€šå¸¸æˆ‘ä»¬è®¡ç®—å±‚æ•°æ—¶ä¸è€ƒè™‘è¾“å…¥å±‚)ï¼Œå¦‚å›¾3.1æ‰€ç¤ºã€‚</p><figure><img src="./images/3.1_linear-regression-single-layer-network.svg"title="å›¾3.1ï¼šçº¿æ€§å›å½’æ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ"alt="çº¿æ€§å›å½’æ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ" /><figcaption aria-hidden="true">çº¿æ€§å›å½’æ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ</figcaption></figure><h3 id="çº¿æ€§å›å½’çš„ä»é›¶å¼€å§‹å®ç°">3.2 çº¿æ€§å›å½’çš„ä»é›¶å¼€å§‹å®ç°</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 3.2.1 ç”Ÿæˆæ•°æ®é›†</span><span class="token keyword">import</span> torch<span class="token keyword">import</span> random<span class="token keyword">def</span> <span class="token function">synthetic_data</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> b<span class="token punctuation">,</span> num_examples<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ç”Ÿæˆy=Xw+b+å™ªå£°"""</span>    X <span class="token operator">=</span> torch<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>num_examples<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># ç”Ÿæˆä¸€ä¸ª1000è¡Œ2åˆ—çš„çŸ©é˜µ</span>    y <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">+</span> b <span class="token comment"># y = Xw+b</span>    y <span class="token operator">+=</span> torch<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token comment"># æ·»åŠ å™ªå£°ï¼Œæ ‡å‡†å·®ä¸º0.01çš„æ­£æ€åˆ†å¸ƒ</span>    <span class="token keyword">return</span> X<span class="token punctuation">,</span> y<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># yå˜ä¸ºåˆ—å‘é‡</span>true_w <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>true_b <span class="token operator">=</span> <span class="token number">4.2</span><span class="token comment"># ç”Ÿæˆä¸€ä¸ªåŒ…å«1000ä¸ªæ ·æœ¬çš„æ•°æ®é›†ï¼Œ æ¯ä¸ªæ ·æœ¬åŒ…å«ä»æ ‡å‡†æ­£æ€åˆ†å¸ƒä¸­é‡‡æ ·çš„2ä¸ªç‰¹å¾</span>features<span class="token punctuation">,</span> labels <span class="token operator">=</span> synthetic_data<span class="token punctuation">(</span>true_w<span class="token punctuation">,</span> true_b<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment"># 3.2.2 è¯»å–æ•°æ®</span><span class="token comment"># è®­ç»ƒæ¨¡å‹æ—¶è¦å¯¹æ•°æ®é›†è¿›è¡Œéå†ï¼Œæ¯æ¬¡æŠ½å–ä¸€å°æ‰¹é‡æ ·æœ¬ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬æ¥æ›´æ–°æˆ‘ä»¬çš„æ¨¡å‹ã€‚</span><span class="token keyword">def</span> <span class="token function">data_iter</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> features<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>    num_examples <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span>    indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_examples<span class="token punctuation">)</span><span class="token punctuation">)</span>        random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>indices<span class="token punctuation">)</span> <span class="token comment"># æ‰“ä¹±æ•°æ®é›†ä¸­çš„æ ·æœ¬å¹¶ä»¥å°æ‰¹é‡æ–¹å¼è·å–æ•°æ®</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> num_examples<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>        batch_indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">:</span> <span class="token builtin">min</span><span class="token punctuation">(</span>i <span class="token operator">+</span> batch_size<span class="token punctuation">,</span> num_examples<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment"># yieldå…³é”®å­—æ¥æ„é€ ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œé€æ‰¹è¿”å›æ•°æ®å’Œæ ‡ç­¾ï¼Œç”¨äºé«˜æ•ˆåœ°å¤„ç†å¤§æ•°æ®é›†æˆ–åœ¨è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹æ—¶è¿›è¡Œå°æ‰¹é‡è®­ç»ƒ</span>        <span class="token keyword">yield</span> features<span class="token punctuation">[</span>batch_indices<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>batch_indices<span class="token punctuation">]</span>batch_size <span class="token operator">=</span> <span class="token number">10</span><span class="token comment"># ç”Ÿæˆç¬¬ä¸€ä¸ªå°æ‰¹é‡æ•°æ®æ ·æœ¬</span><span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> features<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>    <span class="token keyword">break</span><span class="token comment"># 3.2.3 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span><span class="token comment"># ä½¿ç”¨éšæœºæ•°æ¥åˆå§‹åŒ–æƒé‡ï¼Œåç½®åˆ™åˆå§‹åŒ–ä¸º0ï¼ŒåŒæ—¶å¯ç”¨å¼ é‡çš„è‡ªåŠ¨å¾®åˆ†åŠŸèƒ½</span>w <span class="token operator">=</span> torch<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> b <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># 3.2.4 å®šä¹‰æ¨¡å‹</span><span class="token keyword">def</span> <span class="token function">linreg</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""çº¿æ€§å›å½’æ¨¡å‹"""</span>    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token comment"># 3.2.5 å®šä¹‰æŸå¤±å‡½æ•°</span><span class="token comment"># å› ä¸ºéœ€è¦è®¡ç®—æŸå¤±å‡½æ•°çš„æ¢¯åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å…ˆå®šä¹‰æŸå¤±å‡½æ•°</span><span class="token keyword">def</span> <span class="token function">squared_loss</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""å‡æ–¹æŸå¤±"""</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>y_hat <span class="token operator">-</span> y<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>y_hat<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment"># éœ€è¦å°†çœŸå®å€¼yçš„å½¢çŠ¶è½¬æ¢ä¸ºå’Œé¢„æµ‹å€¼y_hatçš„å½¢çŠ¶ç›¸åŒ</span><span class="token comment"># 3.2.6 å®šä¹‰ä¼˜åŒ–ç®—æ³•(å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™æ›´æ–°)</span><span class="token comment"># åœ¨æ¯ä¸€æ­¥ä¸­ï¼Œä½¿ç”¨ä»æ•°æ®é›†ä¸­éšæœºæŠ½å–çš„ä¸€ä¸ªå°æ‰¹é‡ï¼Œç„¶åæ ¹æ®å‚æ•°è®¡ç®—æŸå¤±çš„æ¢¯åº¦ã€‚ æ¥ä¸‹æ¥ï¼Œæœç€å‡å°‘æŸå¤±çš„æ–¹å‘æ›´æ–°æˆ‘ä»¬çš„å‚æ•°ã€‚</span><span class="token keyword">def</span> <span class="token function">sgd</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># æ¨¡å‹å‚æ•°ï¼Œå­¦ä¹ é€Ÿç‡ï¼Œæ‰¹é‡å¤§å°</span>    <span class="token triple-quoted-string string">"""å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™"""</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># å¼€å¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œåœ¨è¯¥ä¸Šä¸‹æ–‡ä¸­ç¦ç”¨æ¢¯åº¦è®¡ç®—ã€‚å‚æ•°æ›´æ–°å’Œåå‘ä¼ æ’­æ˜¯ä¸åŒçš„æ­¥éª¤</span>        <span class="token keyword">for</span> param <span class="token keyword">in</span> params<span class="token punctuation">:</span>            <span class="token comment"># è®¡ç®—çš„æŸå¤±æ˜¯ä¸€ä¸ªæ‰¹é‡æ ·æœ¬çš„æ€»å’Œï¼Œæ‰€ä»¥ç”¨æ‰¹é‡å¤§å°ï¼ˆbatch_sizeï¼‰ æ¥è§„èŒƒåŒ–æ­¥é•¿ï¼Œè¿™æ ·æ­¥é•¿å¤§å°å°±ä¸ä¼šå–å†³äºæˆ‘ä»¬å¯¹æ‰¹é‡å¤§å°çš„é€‰æ‹©ã€‚</span>            param <span class="token operator">-=</span> lr <span class="token operator">*</span> param<span class="token punctuation">.</span>grad <span class="token operator">/</span> batch_size <span class="token comment"># æ¯ä¸€æ­¥æ›´æ–°çš„å¤§å°ç”±å­¦ä¹ é€Ÿç‡lrå†³å®šã€‚ </span>            param<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># æ¢¯åº¦æ¸…é›¶</span><span class="token comment"># 3.2.7 è®­ç»ƒ</span>lr <span class="token operator">=</span> <span class="token number">0.03</span> <span class="token comment"># å­¦ä¹ ç‡</span>num_epochs <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment"># è®­ç»ƒè½®æ¬¡</span>net <span class="token operator">=</span> linreg <span class="token comment"># è‡ªå®šä¹‰æ¨¡å‹</span>loss <span class="token operator">=</span> squared_loss <span class="token comment"># è‡ªå®šä¹‰æŸå¤±å‡½æ•°</span><span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> features<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>        l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>  <span class="token comment"># Xå’Œyçš„å°æ‰¹é‡æŸå¤±</span>        <span class="token comment"># å› ä¸ºlå½¢çŠ¶æ˜¯(batch_size,1)ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ ‡é‡ã€‚lä¸­çš„æ‰€æœ‰å…ƒç´ è¢«åŠ åˆ°ä¸€èµ·ï¼Œ</span>        <span class="token comment"># å¹¶ä»¥æ­¤è®¡ç®—å…³äº[w,b]çš„æ¢¯åº¦</span>        l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># åå‘ä¼ æ’­</span>        sgd<span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨å‚æ•°çš„æ¢¯åº¦æ›´æ–°å‚æ•°</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># æ¨¡å‹è¯„ä¼°ä¸éœ€è¦åå‘ä¼ æ’­</span>        train_l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>features<span class="token punctuation">,</span> w<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token comment"># æ‰“å°å½“å‰æ¨¡å‹åœ¨æ•´ä¸ªè®­ç»ƒé›†ä¸Šçš„æŸå¤±</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'epoch </span><span class="token interpolation"><span class="token punctuation">&#123;</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">, loss </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">float</span><span class="token punctuation">(</span>train_l<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token comment"># 3.2.8 å¯¹æ¯”çœŸå®å€¼</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'wçš„ä¼°è®¡è¯¯å·®: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>true_w <span class="token operator">-</span> w<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>true_w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'bçš„ä¼°è®¡è¯¯å·®: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>true_b <span class="token operator">-</span> b<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></code></pre><h3 id="çº¿æ€§å›å½’çš„ç®€æ´å®ç°">3.3 çº¿æ€§å›å½’çš„ç®€æ´å®ç°</h3><p>ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¡†æ¶çš„é«˜çº§APIç®€æ´å®ç°çº¿æ€§å›å½’</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 3.3.1 ç”Ÿæˆæ•°æ®é›†</span><span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> torch<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils <span class="token keyword">import</span> data<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2ltrue_w <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>true_b <span class="token operator">=</span> <span class="token number">4.2</span>features<span class="token punctuation">,</span> labels <span class="token operator">=</span> d2l<span class="token punctuation">.</span>synthetic_data<span class="token punctuation">(</span>true_w<span class="token punctuation">,</span> true_b<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment"># 3.3.2 è¯»å–æ•°æ®é›†</span><span class="token comment"># è°ƒç”¨dataå‡½æ•°ï¼Œå°†featureså’Œlabelsä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¾—åˆ°ä¸€ä¸ªdata.TensorDatasetå®ä¾‹</span><span class="token keyword">def</span> <span class="token function">load_array</span><span class="token punctuation">(</span>data_arrays<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># *data_arraysè¡¨ç¤ºä¼ å…¥çš„æ˜¯ä¸€ä¸ªlistï¼Œ*è¡¨ç¤ºè§£åŒ…</span>    dataset <span class="token operator">=</span> data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span><span class="token operator">*</span>data_arrays<span class="token punctuation">)</span>    <span class="token comment"># shuffleè¡¨ç¤ºæ˜¯å¦æ‰“ä¹±æ•°æ®</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span>is_train<span class="token punctuation">)</span>batch_size <span class="token operator">=</span> <span class="token number">10</span>data_iter <span class="token operator">=</span> load_array<span class="token punctuation">(</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token comment"># è¯»å–å¹¶æ‰“å°ç¬¬ä¸€ä¸ªå°æ‰¹é‡æ ·æœ¬</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨iterå‡½æ•°ç”Ÿæˆè¿­ä»£å™¨ï¼Œä½¿ç”¨nextå‡½æ•°å¾—åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ </span><span class="token comment"># 3.3.3 å®šä¹‰æ¨¡å‹</span><span class="token comment"># Sequentialç±»å°†å¤šä¸ªå±‚ä¸²è”åœ¨ä¸€èµ·ã€‚ å½“ç»™å®šè¾“å…¥æ•°æ®æ—¶ï¼ŒSequentialå®ä¾‹å°†æ•°æ®ä¼ å…¥åˆ°ç¬¬ä¸€å±‚ï¼Œ ç„¶åå°†ç¬¬ä¸€å±‚çš„è¾“å‡ºä½œä¸ºç¬¬äºŒå±‚çš„è¾“å…¥ï¼Œä»¥æ­¤ç±»æ¨ã€‚</span><span class="token comment"># å…¨è¿æ¥å±‚åœ¨Linearç±»ä¸­å®šä¹‰ã€‚ è¯¥å±‚çš„è¾“å‡ºæ•°é‡ä¸º1ã€‚</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ç›´æ¥æŒ‡å®šè¾“å…¥å’Œè¾“å‡ºå°ºå¯¸ã€‚2è¡¨ç¤ºè¾“å…¥ç‰¹å¾æ•°ï¼Œ1è¡¨ç¤ºè¾“å‡ºç‰¹å¾æ•°</span><span class="token comment"># 3.3.4 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span><span class="token comment"># é€šè¿‡net[0]è®¿é—®Sequentialå®ä¾‹ä¸­çš„ç¬¬ä¸€å±‚ï¼Œç„¶åä½¿ç”¨weight.dataå’Œbias.dataæ–¹æ³•è®¿é—®å‚æ•°ã€‚</span><span class="token comment"># ä½¿ç”¨æ›¿æ¢æ–¹æ³•normal_å’Œfill_æ¥é‡å†™å‚æ•°å€¼</span>net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>  <span class="token comment"># å‡å€¼ä¸º0ï¼Œæ ‡å‡†å·®ä¸º0.01çš„æ­£æ€åˆ†å¸ƒ</span>net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fill_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨fill_æ–¹æ³•å°†åç½®å‚æ•°è®¾ç½®ä¸º0</span><span class="token comment"># 3.3.5 å®šä¹‰æŸå¤±å‡½æ•°</span>loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å‡æ–¹è¯¯å·®æŸå¤±å‡½æ•°</span><span class="token comment"># 3.3.6 å®šä¹‰ä¼˜åŒ–ç®—æ³•</span><span class="token comment"># æŒ‡å®šä¼˜åŒ–çš„å‚æ•° ï¼ˆå¯é€šè¿‡net.parameters()ä»æ¨¡å‹ä¸­è·å¾—ï¼‰ä»¥åŠä¼˜åŒ–ç®—æ³•æ‰€éœ€çš„è¶…å‚æ•°å­—å…¸</span>trainer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨SGDä¼˜åŒ–ç®—æ³•ï¼Œå­¦ä¹ ç‡ä¸º0.03</span><span class="token comment"># 3.3.7 è®­ç»ƒ</span>num_epochs <span class="token operator">=</span> <span class="token number">3</span><span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>        l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>        trainer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>        l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>        trainer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>    l <span class="token operator">=</span> loss<span class="token punctuation">(</span>net<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'epoch </span><span class="token interpolation"><span class="token punctuation">&#123;</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">, loss </span><span class="token interpolation"><span class="token punctuation">&#123;</span>l<span class="token punctuation">:</span><span class="token format-spec">f</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token comment"># æ¯”è¾ƒå­¦åˆ°çš„æ¨¡å‹å‚æ•°å’ŒçœŸå®lçš„æ¨¡å‹å‚æ•°</span>w <span class="token operator">=</span> net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'wçš„ä¼°è®¡è¯¯å·®:'</span><span class="token punctuation">,</span> true_w <span class="token operator">-</span> w<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>true_w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>b <span class="token operator">=</span> net<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'bçš„ä¼°è®¡è¯¯å·®:'</span><span class="token punctuation">,</span> true_b <span class="token operator">-</span> b<span class="token punctuation">)</span></code></pre><h3 id="softmaxå›å½’">3.4 softmaxå›å½’</h3><p>softmaxè¿ç®—è·å–ä¸€ä¸ªå‘é‡å¹¶å°†å…¶æ˜ å°„ä¸ºæ¦‚ç‡ï¼Œé€‚ç”¨äºåˆ†ç±»é—®é¢˜ï¼Œå®ƒä½¿ç”¨äº†softmaxè¿ç®—ä¸­è¾“å‡ºç±»åˆ«çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p><h4 id="åˆ†ç±»é—®é¢˜">3.4.1 åˆ†ç±»é—®é¢˜</h4><p>ä»ä¸€ä¸ªå›¾åƒåˆ†ç±»é—®é¢˜å¼€å§‹ã€‚ å‡è®¾æ¯æ¬¡è¾“å…¥æ˜¯ä¸€ä¸ª 2X2 çš„ç°åº¦å›¾åƒã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ ‡é‡è¡¨ç¤ºæ¯ä¸ªåƒç´ å€¼ï¼Œæ¯ä¸ªå›¾åƒå¯¹åº”å››ä¸ªç‰¹å¾<spanclass="math inline">\(x_1,x_2,x_3,x_4\)</span>ã€‚æ­¤å¤–ï¼Œå‡è®¾æ¯ä¸ªå›¾åƒå±äºç±»åˆ«â€œçŒ«â€â€œé¸¡â€å’Œâ€œç‹—â€ä¸­çš„ä¸€ä¸ªã€‚(ç‹¬çƒ­ç¼–ç :ç‹¬çƒ­ç¼–ç æ˜¯ä¸€ä¸ªå‘é‡ï¼Œå®ƒçš„åˆ†é‡å’Œç±»åˆ«ä¸€æ ·å¤šã€‚ç±»åˆ«å¯¹åº”çš„åˆ†é‡è®¾ç½®ä¸º1ï¼Œå…¶ä»–æ‰€æœ‰åˆ†é‡è®¾ç½®ä¸º0ã€‚)</p><h4 id="ç½‘ç»œæ¶æ„">3.4.2 ç½‘ç»œæ¶æ„</h4><p>ä¸ºäº†ä¼°è®¡æ‰€æœ‰å¯èƒ½ç±»åˆ«çš„æ¡ä»¶æ¦‚ç‡ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ‰å¤šä¸ªè¾“å‡ºçš„æ¨¡å‹ï¼Œæ¯ä¸ªç±»åˆ«å¯¹åº”ä¸€ä¸ªè¾“å‡ºã€‚ä¸ºäº†è§£å†³çº¿æ€§æ¨¡å‹çš„åˆ†ç±»é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å’Œè¾“å‡ºä¸€æ ·å¤šçš„ä»¿å°„å‡½æ•°ï¼ˆaffinefunctionï¼‰ã€‚</p><p><span class="math display">\[\begin{gathered}o_1 &amp;= x_1 w_{11} + x_2 w_{12} + x_3 w_{13} + x_4 w_{14} + b_1,\\o_2 &amp;= x_1 w_{21} + x_2 w_{22} + x_3 w_{23} + x_4 w_{24} + b_2,\\o_3 &amp;= x_1 w_{31} + x_2 w_{32} + x_3 w_{33} + x_4 w_{34} + b_3.\end{gathered}\tag{3.2}\]</span></p><p>è¡¨è¾¾ä¸ºå‘é‡å½¢å¼<span class="math inline">\(\mathbf{o} = \mathbf{W}\mathbf{x} + \mathbf{b}\)</span></p><p>å› æ­¤å¯ä»¥æ„å»ºå¦‚ä¸‹çš„å•å±‚ç¥ç»ç½‘ç»œ(åŒæ ·çš„ï¼Œä¹Ÿæ˜¯å…¨è¿æ¥å±‚)ï¼š</p><figure><img src="./images/3.2_softmax-regression-single-layer-network.svg"title="å›¾3.2ï¼šsoftmaxå›å½’æ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ"alt="softmaxå›å½’æ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ" /><figcaptionaria-hidden="true">softmaxå›å½’æ˜¯ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œ</figcaption></figure><h4 id="å…¨è¿æ¥å±‚çš„å‚æ•°å¼€é”€">3.4.3 å…¨è¿æ¥å±‚çš„å‚æ•°å¼€é”€</h4><p>å…¨è¿æ¥å±‚æ˜¯â€œå®Œå…¨â€è¿æ¥çš„ï¼Œå¯èƒ½æœ‰å¾ˆå¤šå¯å­¦ä¹ çš„å‚æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºä»»ä½•å…·æœ‰dä¸ªè¾“å…¥å’Œpä¸ªè¾“å‡ºçš„å…¨è¿æ¥å±‚ï¼Œ å‚æ•°å¼€é”€ä¸º<spanclass="math inline">\(\mathcal{O}(dq)\)</span>ï¼Œè¿™ä¸ªæ•°å­—åœ¨å®è·µä¸­å¯èƒ½é«˜å¾—ä»¤äººæœ›è€Œå´æ­¥ã€‚å¹¸è¿çš„æ˜¯ï¼Œå°†dä¸ªè¾“å…¥è½¬æ¢ä¸ºqä¸ªè¾“å‡ºçš„æˆæœ¬å¯ä»¥å‡å°‘åˆ°<spanclass="math inline">\(\mathcal{O}(\frac{dq}{n})\)</span>ã€‚å…¶ä¸­ï¼Œå…¶ä¸­è¶…å‚æ•°nå¯ä»¥ç”±æˆ‘ä»¬çµæ´»æŒ‡å®š</p><h4 id="softmaxè¿ç®—">3.4.4. softmaxè¿ç®—</h4><p>ç°åœ¨æˆ‘ä»¬å°†ä¼˜åŒ–å‚æ•°ä»¥æœ€å¤§åŒ–è§‚æµ‹æ•°æ®çš„æ¦‚ç‡ã€‚ä¸ºäº†å¾—åˆ°é¢„æµ‹ç»“æœï¼Œæˆ‘ä»¬å°†è®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œå¦‚é€‰æ‹©å…·æœ‰æœ€å¤§æ¦‚ç‡çš„æ ‡ç­¾ã€‚</p><p>ç„¶è€Œæˆ‘ä»¬èƒ½å¦å°†æœªè§„èŒƒåŒ–çš„é¢„æµ‹<spanclass="math inline">\(o\)</span>ç›´æ¥è§†ä½œæˆ‘ä»¬æ„Ÿå…´è¶£çš„è¾“å‡ºå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ å› ä¸ºå°†çº¿æ€§å±‚çš„è¾“å‡ºç›´æ¥è§†ä¸ºæ¦‚ç‡æ—¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šä¸€æ–¹é¢ï¼Œæˆ‘ä»¬æ²¡æœ‰é™åˆ¶è¿™äº›è¾“å‡ºæ•°å­—çš„æ€»å’Œä¸º1ã€‚å¦ä¸€æ–¹é¢ï¼Œæ ¹æ®è¾“å…¥çš„ä¸åŒï¼Œå®ƒä»¬å¯ä»¥ä¸ºè´Ÿå€¼ã€‚è¦å°†è¾“å‡ºè§†ä¸ºæ¦‚ç‡ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯åœ¨ä»»ä½•æ•°æ®ä¸Šçš„è¾“å‡ºéƒ½æ˜¯éè´Ÿçš„ä¸”æ€»å’Œä¸º1ã€‚</p><p>ç”±æ­¤å¼•å‡º<strong>softmaxå‡½æ•°</strong>:</p><p><span class="math display">\[\hat{\mathbf{y}} = \mathrm{softmax}(\mathbf{o})\quad \text{å…¶ä¸­}\quad\hat{y}_j = \frac{\exp(o_j)}{\sum_k \exp(o_k)}\tag{3.3}\]</span></p><p><spanclass="math inline">\(\hat{\mathbf{y}}\)</span>å¯ä»¥è§†ä¸ºä¸€ä¸ªæ­£ç¡®çš„æ¦‚ç‡åˆ†å¸ƒã€‚softmaxè¿ç®—ä¸ä¼šæ”¹å˜æœªè§„èŒƒåŒ–çš„é¢„æµ‹<spanclass="math inline">\(o\)</span>ä¹‹é—´çš„å¤§å°æ¬¡åºï¼Œä»è€Œä¾æ—§æ˜¯:</p><p><span class="math display">\[\operatorname*{argmax}_j \hat y_j = \operatorname*{argmax}_j o_j.\tag{3.4}\]</span></p><p>å°½ç®¡softmaxæ˜¯ä¸€ä¸ªéçº¿æ€§å‡½æ•°ï¼Œä½†softmaxå›å½’çš„è¾“å‡ºä»ç„¶ç”±è¾“å…¥ç‰¹å¾çš„ä»¿å°„å˜æ¢å†³å®šã€‚å› æ­¤ï¼Œ<strong>softmaxå›å½’æ˜¯ä¸€ä¸ªçº¿æ€§æ¨¡å‹</strong>ï¼ˆlinear modelï¼‰ã€‚</p><h4 id="å°æ‰¹é‡æ ·æœ¬çš„çŸ¢é‡åŒ–">3.4.5. å°æ‰¹é‡æ ·æœ¬çš„çŸ¢é‡åŒ–</h4><p>ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡å¹¶ä¸”å……åˆ†åˆ©ç”¨GPUï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¯¹å°æ‰¹é‡æ ·æœ¬çš„æ•°æ®æ‰§è¡ŒçŸ¢é‡è®¡ç®—ã€‚å‡è®¾æˆ‘ä»¬è¯»å–äº†ä¸€ä¸ªæ‰¹é‡çš„æ ·æœ¬<spanclass="math inline">\(X\)</span>ï¼Œ å…¶ä¸­ç‰¹å¾ç»´åº¦ï¼ˆè¾“å…¥æ•°é‡ï¼‰ä¸º<spanclass="math inline">\(d\)</span>ï¼Œæ‰¹é‡å¤§å°ä¸º<spanclass="math inline">\(n\)</span>ã€‚ æ­¤å¤–ï¼Œå‡è®¾æˆ‘ä»¬åœ¨è¾“å‡ºä¸­æœ‰<spanclass="math inline">\(q\)</span>ä¸ªç±»åˆ«ã€‚ é‚£ä¹ˆå°æ‰¹é‡æ ·æœ¬çš„ç‰¹å¾ä¸º<spanclass="math inline">\(\mathbf{X} \in \mathbb{R}^{n \times d}\)</span>ï¼Œæƒé‡ä¸º<span class="math inline">\(\mathbf{W} \in \mathbb{R}^{d \timesq}\)</span>ï¼Œ åç½®ä¸º<span class="math inline">\(\mathbf{b} \in\mathbb{R}^{1\times q}\)</span>ã€‚ softmaxå›å½’çš„çŸ¢é‡è®¡ç®—è¡¨è¾¾å¼ä¸ºï¼š</p><p><span class="math display">\[\begin{gathered}\mathbf{O} &amp;= \mathbf{X} \mathbf{W} + \mathbf{b}, \\\hat{\mathbf{Y}} &amp; = \mathrm{softmax}(\mathbf{O}).\end{gathered}\tag{3.5}\]</span></p><p>ç›¸å¯¹äºä¸€æ¬¡å¤„ç†ä¸€ä¸ªæ ·æœ¬ï¼Œ å°æ‰¹é‡æ ·æœ¬çš„çŸ¢é‡åŒ–åŠ å¿«äº†<spanclass="math inline">\(X\)</span>å’Œ<spanclass="math inline">\(W\)</span>çš„çŸ©é˜µ-å‘é‡ä¹˜æ³•ã€‚</p><h4 id="æŸå¤±å‡½æ•°">3.4.6 æŸå¤±å‡½æ•°</h4><p>åŒçº¿æ€§å›å½’ä¸€æ ·ï¼Œä½¿ç”¨æœ€å¤§ä¼¼ç„¶ä¼°è®¡æ³•ã€‚</p><p><strong>äº¤å‰ç†µæŸå¤±</strong>(æ˜¯åˆ†ç±»é—®é¢˜æœ€å¸¸ç”¨çš„æŸå¤±ä¹‹ä¸€ï¼Œæ˜¯ä¸€ä¸ªè¡¡é‡ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒä¹‹é—´å·®å¼‚çš„å¾ˆå¥½çš„åº¦é‡ï¼Œå®ƒæµ‹é‡ç»™å®šæ¨¡å‹ç¼–ç æ•°æ®æ‰€éœ€çš„æ¯”ç‰¹æ•°):</p><p><span class="math display">\[l(\mathbf{y}, \hat{\mathbf{y}}) = - \sum_{j=1}^q y_j \log \hat{y}_j.\tag{3.6}\]</span></p><h3 id="å›¾åƒåˆ†ç±»æ•°æ®é›†">3.5 å›¾åƒåˆ†ç±»æ•°æ®é›†</h3><p>MNISTæ•°æ®é›†æ˜¯å›¾åƒåˆ†ç±»ä¸­å¹¿æ³›ä½¿ç”¨çš„æ•°æ®é›†ä¹‹ä¸€ï¼Œä½†ä½œä¸ºåŸºå‡†æ•°æ®é›†è¿‡äºç®€å•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ç±»ä¼¼ä½†æ›´å¤æ‚çš„Fashion-MNISTæ•°æ®é›†ã€‚</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torchvision<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils <span class="token keyword">import</span> data<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2ld2l<span class="token punctuation">.</span>use_svg_display<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 3.5.1 è¯»å–æ•°æ®é›†</span><span class="token comment"># 3.5.1.1 é€šè¿‡æ¡†æ¶ä¸­çš„å†…ç½®å‡½æ•°å°†Fashion-MNISTæ•°æ®é›†ä¸‹è½½å¹¶è¯»å–åˆ°å†…å­˜ä¸­</span>trans <span class="token operator">=</span> transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># é€šè¿‡ToTensorå®ä¾‹å°†å›¾åƒæ•°æ®ä»PILç±»å‹å˜æ¢æˆ32ä½æµ®ç‚¹æ•°æ ¼å¼ï¼Œå¹¶é™¤ä»¥255ä½¿å¾—æ‰€æœ‰åƒç´ çš„æ•°å€¼å‡åœ¨0ï½1ä¹‹é—´</span>mnist_train <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>    root<span class="token operator">=</span><span class="token string">"../data"</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>trans<span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>mnist_test <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>    root<span class="token operator">=</span><span class="token string">"../data"</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>trans<span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># Fashion-MNISTç”±10ä¸ªç±»åˆ«çš„å›¾åƒç»„æˆï¼Œ æ¯ä¸ªç±»åˆ«ç”±è®­ç»ƒæ•°æ®é›†ï¼ˆtrain datasetï¼‰ä¸­çš„6000å¼ å›¾åƒ å’Œæµ‹è¯•æ•°æ®é›†ï¼ˆtest datasetï¼‰ä¸­çš„1000å¼ å›¾åƒç»„æˆã€‚ </span><span class="token comment"># å› æ­¤ï¼Œè®­ç»ƒé›†å’Œæµ‹è¯•é›†åˆ†åˆ«åŒ…å«60000å’Œ10000å¼ å›¾åƒã€‚ æµ‹è¯•æ•°æ®é›†ä¸ä¼šç”¨äºè®­ç»ƒï¼Œåªç”¨äºè¯„ä¼°æ¨¡å‹æ€§èƒ½ã€‚</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>mnist_train<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mnist_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ¯ä¸ªè¾“å…¥å›¾åƒçš„é«˜åº¦å’Œå®½åº¦å‡ä¸º28åƒç´ ã€‚ æ•°æ®é›†ç”±ç°åº¦å›¾åƒç»„æˆï¼Œå…¶é€šé“æ•°ä¸º1</span><span class="token keyword">print</span><span class="token punctuation">(</span>mnist_train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token comment"># torch.Size([1, 28, 28])</span><span class="token comment"># 3.5.1.2 åœ¨æ•°å­—æ ‡ç­¾ç´¢å¼•åŠå…¶æ–‡æœ¬åç§°ä¹‹é—´è¿›è¡Œè½¬æ¢</span><span class="token keyword">def</span> <span class="token function">get_fashion_mnist_labels</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è¿”å›Fashion-MNISTæ•°æ®é›†çš„æ–‡æœ¬æ ‡ç­¾"""</span>    text_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'t-shirt'</span><span class="token punctuation">,</span> <span class="token string">'trouser'</span><span class="token punctuation">,</span> <span class="token string">'pullover'</span><span class="token punctuation">,</span> <span class="token string">'dress'</span><span class="token punctuation">,</span> <span class="token string">'coat'</span><span class="token punctuation">,</span>                   <span class="token string">'sandal'</span><span class="token punctuation">,</span> <span class="token string">'shirt'</span><span class="token punctuation">,</span> <span class="token string">'sneaker'</span><span class="token punctuation">,</span> <span class="token string">'bag'</span><span class="token punctuation">,</span> <span class="token string">'ankle boot'</span><span class="token punctuation">]</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>text_labels<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> labels<span class="token punctuation">]</span><span class="token comment"># 3.5.1.3 å¯è§†åŒ–æ ·æœ¬</span><span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> num_rows<span class="token punctuation">,</span> num_cols<span class="token punctuation">,</span> titles<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ç»˜åˆ¶å›¾åƒåˆ—è¡¨"""</span>    figsize <span class="token operator">=</span> <span class="token punctuation">(</span>num_cols <span class="token operator">*</span> scale<span class="token punctuation">,</span> num_rows <span class="token operator">*</span> scale<span class="token punctuation">)</span>    _<span class="token punctuation">,</span> axes <span class="token operator">=</span> d2l<span class="token punctuation">.</span>plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>num_rows<span class="token punctuation">,</span> num_cols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>    axes <span class="token operator">=</span> axes<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> img<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>axes<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>is_tensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># å›¾ç‰‡å¼ é‡</span>            ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token comment"># PILå›¾ç‰‡</span>            ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>        ax<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>get_xaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>        ax<span class="token punctuation">.</span>axes<span class="token punctuation">.</span>get_yaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> titles<span class="token punctuation">:</span>            ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>titles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> axes<span class="token comment"># å±•ç¤ºå‰å‡ ä¸ªæ ·æœ¬</span>X<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>mnist_train<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>show_images<span class="token punctuation">(</span>X<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> titles<span class="token operator">=</span>get_fashion_mnist_labels<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment"># 3.5.2 å°æ‰¹é‡è¯»å–</span><span class="token comment"># ä½¿ç”¨å†…ç½®çš„æ•°æ®è¿­ä»£å™¨ï¼Œæ¯æ¬¡éƒ½ä¼šè¯»å–ä¸€å°æ‰¹é‡æ•°æ®ï¼Œå¤§å°ä¸ºbatch_sizeã€‚åŒæ—¶éšæœºæ‰“ä¹±æ‰€æœ‰æ ·æœ¬ï¼Œä»è€Œæ— åè§åœ°è¯»å–å°æ‰¹é‡</span>batch_size <span class="token operator">=</span> <span class="token number">256</span><span class="token keyword">def</span> <span class="token function">get_dataloader_workers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ä½¿ç”¨4ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®"""</span>    <span class="token keyword">return</span> <span class="token number">4</span><span class="token comment"># 3.5.3 æ•´åˆæ‰€æœ‰ç»„ä»¶</span><span class="token comment"># è·å–å’Œè¯»å–Fashion-MNISTæ•°æ®é›†ï¼Œè¿”å›è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ•°æ®è¿­ä»£å™¨ã€‚</span><span class="token keyword">def</span> <span class="token function">load_data_fashion_mnist</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> resize<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""ä¸‹è½½Fashion-MNISTæ•°æ®é›†ï¼Œç„¶åå°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­"""</span>    trans <span class="token operator">=</span> <span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> resize<span class="token punctuation">:</span> <span class="token comment"># å¯é€‰å‚æ•°resizeï¼Œç”¨æ¥å°†å›¾åƒå¤§å°è°ƒæ•´ä¸ºå¦ä¸€ç§å½¢çŠ¶</span>        trans<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>resize<span class="token punctuation">)</span><span class="token punctuation">)</span>    trans <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span>trans<span class="token punctuation">)</span>    mnist_train <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>        root<span class="token operator">=</span><span class="token string">"../data"</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>trans<span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    mnist_test <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>        root<span class="token operator">=</span><span class="token string">"../data"</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>trans<span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>mnist_train<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span>get_dataloader_workers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>mnist_test<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span>get_dataloader_workers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># å¾—åˆ°è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„æ•°æ®è¿­ä»£å™¨(æµ‹è¯•load_data_fashion_mnistå‡½æ•°çš„å›¾åƒå¤§å°è°ƒæ•´åŠŸèƒ½)</span>train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> load_data_fashion_mnist<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> resize<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>    <span class="token comment"># torch.Size([32, 1, 64, 64])   torch.float32   torch.Size([32])    torch.int64 </span>    <span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> X<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> y<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>    <span class="token keyword">break</span></code></pre><h3 id="softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°">3.6 softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°</h3><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»å¼•å…¥äº†Fashion-MNISTæ•°æ®é›†ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨softmaxå›å½’ä»é›¶å¼€å§‹å®ç°å®ƒã€‚</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> IPython <span class="token keyword">import</span> display<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token comment"># 3.6.1 åˆå§‹åŒ–æ¨¡å‹å‚æ•°(æ”¾å…¥mainå‡½æ•°ä¸­)</span><span class="token comment"># åŸå§‹è¾“å…¥å›¾åƒå¤§å°æ˜¯28*28ï¼Œè¿™é‡Œå°†å…¶è½¬æ¢ä¸ºé•¿åº¦ä¸º28*28=784çš„å‘é‡</span><span class="token comment"># ç”±äºæœ‰10ä¸ªç±»åˆ«ï¼Œæ‰€ä»¥è¾“å‡ºå±‚çš„è¾“å‡ºä¸ªæ•°ä¸º10</span><span class="token comment"># å› æ­¤ï¼Œæƒé‡å°†æ„æˆä¸€ä¸ª784*10çš„çŸ©é˜µ</span><span class="token comment"># åç½®å°†æ„æˆä¸€ä¸ª10ç»´çš„å‘é‡</span><span class="token comment"># 3.6.2 å®ç°softmaxè¿ç®—</span><span class="token keyword">def</span> <span class="token function">softmax</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 1. å¯¹æ¯ä¸ªé¡¹æ±‚å¹‚ï¼ˆä½¿ç”¨expï¼‰ï¼›</span>    X_exp <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>X<span class="token punctuation">)</span>    <span class="token comment"># 2. å¯¹æ¯ä¸€è¡Œæ±‚å’Œï¼ˆå°æ‰¹é‡ä¸­æ¯ä¸ªæ ·æœ¬æ˜¯ä¸€è¡Œï¼‰ï¼Œå¾—åˆ°æ¯ä¸ªæ ·æœ¬çš„è§„èŒƒåŒ–å¸¸æ•°ï¼›</span>    partition <span class="token operator">=</span> X_exp<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># è°ƒç”¨sumæ—¶ï¼Œå¯ä»¥æŒ‡å®šä¿æŒåœ¨åŸå§‹å¼ é‡çš„è½´æ•°ï¼Œè€Œä¸æŠ˜å æ±‚å’Œçš„ç»´åº¦ã€‚å…¶ä¸­1è¡¨ç¤ºæ²¿è¡Œæ±‚å’Œï¼Œkeepdim=Trueä¿æŒåˆ—å‘é‡çš„å½¢çŠ¶</span>    <span class="token comment"># 3. å°†æ¯ä¸€è¡Œé™¤ä»¥å…¶è§„èŒƒåŒ–å¸¸æ•°ï¼Œç¡®ä¿ç»“æœçš„å’Œä¸º1ã€‚</span>    <span class="token keyword">return</span> X_exp <span class="token operator">/</span> partition  <span class="token comment"># è¿™é‡Œåº”ç”¨äº†å¹¿æ’­æœºåˆ¶</span><span class="token comment"># 3.6.3 å®šä¹‰æ¨¡å‹</span><span class="token comment"># è¾“å…¥é€šè¿‡ç½‘ç»œæ˜ å°„åˆ°è¾“å‡º</span><span class="token keyword">def</span> <span class="token function">net</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># é€šè¿‡reshapeå‡½æ•°å°†æ¯å¼ åŸå§‹å›¾åƒæ”¹ä¸ºé•¿åº¦ä¸ºnum_inputsçš„å‘é‡ï¼Œå³reshape((-1, 784))ã€‚</span>    <span class="token keyword">return</span> softmax<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>X<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> W<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> W<span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token comment"># 3.6.4 å®šä¹‰æŸå¤±å‡½æ•°</span><span class="token comment"># äº¤å‰ç†µæŸå¤±å‡½æ•°</span><span class="token keyword">def</span> <span class="token function">cross_entropy</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># y_hatæ˜¯é¢„æµ‹æ¦‚ç‡ï¼Œyæ˜¯æ ‡ç­¾</span>    <span class="token keyword">return</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y_hat<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 3.6.5 è®¡ç®—åˆ†ç±»å‡†ç¡®ç‡</span><span class="token comment"># è®¡ç®—å‡†ç¡®ç‡</span><span class="token keyword">def</span> <span class="token function">accuracy</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡"""</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">and</span> y_hat<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>        y_hat <span class="token operator">=</span> y_hat<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># è¿”å›æ²¿è½´axisæœ€å¤§å€¼çš„ç´¢å¼•</span>    <span class="token builtin">cmp</span> <span class="token operator">=</span> y_hat<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span> <span class="token operator">==</span> y <span class="token comment"># åŒ¹é…æ•°æ®ç±»å‹å¹¶æ¯”è¾ƒï¼Œè¿”å›å¸ƒå°”å€¼0æˆ–1</span>    <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">cmp</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># è¯„ä¼°æ¨¡å‹netçš„ç²¾åº¦</span><span class="token keyword">def</span> <span class="token function">evaluate_accuracy</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> data_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦"""</span>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># å¦‚æœæ˜¯torch.nn.Moduleå®ä¾‹ï¼Œä½¿ç”¨isinstanceå‡½æ•°è¿”å›True</span>        net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span>    metric <span class="token operator">=</span> Accumulator<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># æ­£ç¡®é¢„æµ‹æ•°ã€é¢„æµ‹æ€»æ•°(è‡ªå®šä¹‰çš„ç´¯åŠ å™¨ç±»)</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># ä¸è®¡ç®—æ¢¯åº¦</span>        <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>            metric<span class="token punctuation">.</span>add<span class="token punctuation">(</span>accuracy<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># ç´¯åŠ æ¯ä¸ªbatch_sizeä¸ªæ ·æœ¬çš„å‡†ç¡®ç‡å’Œæ ·æœ¬æ•°</span>    <span class="token keyword">return</span> metric<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token comment"># 3.6.6 è®­ç»ƒæ¨¡å‹</span><span class="token comment"># å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è®­ç»ƒä¸€ä¸ªè¿­ä»£å‘¨æœŸ</span><span class="token keyword">def</span> <span class="token function">train_epoch_ch3</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> updater<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸ"""</span>    <span class="token comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼</span>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>        net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># è®­ç»ƒæŸå¤±æ€»å’Œã€è®­ç»ƒå‡†ç¡®åº¦æ€»å’Œã€æ ·æœ¬æ•°</span>    metric <span class="token operator">=</span> Accumulator<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>        <span class="token comment"># è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°å‚æ•°</span>        y_hat <span class="token operator">=</span> net<span class="token punctuation">(</span>X<span class="token punctuation">)</span>        l <span class="token operator">=</span> loss<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>updater<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># ä½¿ç”¨PyTorchå†…ç½®çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span>            updater<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>            l<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            updater<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token comment"># ä½¿ç”¨å®šåˆ¶çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span>            l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>            updater<span class="token punctuation">(</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        metric<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accuracy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># è¿”å›è®­ç»ƒæŸå¤±å’Œè®­ç»ƒç²¾åº¦</span>    <span class="token keyword">return</span> metric<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> metric<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> metric<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token comment"># è®­ç»ƒå‡½æ•°</span><span class="token keyword">def</span> <span class="token function">train_ch3</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> updater<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è®­ç»ƒæ¨¡å‹"""</span>    animator <span class="token operator">=</span> Animator<span class="token punctuation">(</span>xlabel<span class="token operator">=</span><span class="token string">'epoch'</span><span class="token punctuation">,</span> xlim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">]</span><span class="token punctuation">,</span> ylim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        legend<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train loss'</span><span class="token punctuation">,</span> <span class="token string">'train acc'</span><span class="token punctuation">,</span> <span class="token string">'test acc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>        train_metrics <span class="token operator">=</span> train_epoch_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> updater<span class="token punctuation">)</span>        test_acc <span class="token operator">=</span> evaluate_accuracy<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">)</span>        animator<span class="token punctuation">.</span>add<span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> train_metrics <span class="token operator">+</span> <span class="token punctuation">(</span>test_acc<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    train_loss<span class="token punctuation">,</span> train_acc <span class="token operator">=</span> train_metrics    <span class="token keyword">assert</span> train_loss <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">,</span> train_loss    <span class="token keyword">assert</span> train_acc <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">and</span> train_acc <span class="token operator">></span> <span class="token number">0.7</span><span class="token punctuation">,</span> train_acc    <span class="token keyword">assert</span> test_acc <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">and</span> test_acc <span class="token operator">></span> <span class="token number">0.7</span><span class="token punctuation">,</span> test_acc<span class="token comment"># å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™æ¥ä¼˜åŒ–æ¨¡å‹çš„æŸå¤±å‡½æ•°</span><span class="token keyword">def</span> <span class="token function">updater</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> d2l<span class="token punctuation">.</span>sgd<span class="token punctuation">(</span><span class="token punctuation">[</span>W<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token comment"># 3.6.7 é¢„æµ‹</span><span class="token keyword">def</span> <span class="token function">predict_ch3</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""é¢„æµ‹æ ‡ç­¾"""</span>    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> test_iter<span class="token punctuation">:</span> <span class="token comment"># å–ä¸€ä¸ªbatch_sizeçš„æ•°æ®</span>        <span class="token keyword">break</span>    trues <span class="token operator">=</span> d2l<span class="token punctuation">.</span>get_fashion_mnist_labels<span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token comment"># çœŸå®æ ‡ç­¾</span>    preds <span class="token operator">=</span> d2l<span class="token punctuation">.</span>get_fashion_mnist_labels<span class="token punctuation">(</span>net<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># é¢„æµ‹æ ‡ç­¾</span>    titles <span class="token operator">=</span> <span class="token punctuation">[</span>true <span class="token operator">+</span><span class="token string">'\n'</span> <span class="token operator">+</span> pred <span class="token keyword">for</span> true<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>trues<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># æ ‡é¢˜</span>    d2l<span class="token punctuation">.</span>show_images<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> titles<span class="token operator">=</span>titles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># æ˜¾ç¤ºå›¾ç‰‡</span><span class="token comment"># Helper class</span><span class="token comment"># ç´¯åŠ å™¨ç±»</span><span class="token keyword">class</span> <span class="token class-name">Accumulator</span><span class="token punctuation">:</span>  <span class="token comment">#@save</span>    <span class="token triple-quoted-string string">"""åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span> <span class="token operator">*</span> n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> a<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token comment"># æ•°æ®å¯è§†åŒ–</span><span class="token keyword">class</span> <span class="token class-name">Animator</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""åœ¨åŠ¨ç”»ä¸­ç»˜åˆ¶æ•°æ®"""</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> xlabel<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> legend<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> xlim<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>                 ylim<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> xscale<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span> yscale<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span>                 fmts<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'m--'</span><span class="token punctuation">,</span> <span class="token string">'g-.'</span><span class="token punctuation">,</span> <span class="token string">'r:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>                 figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3.5</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å¢é‡åœ°ç»˜åˆ¶å¤šæ¡çº¿</span>        <span class="token keyword">if</span> legend <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            legend <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        d2l<span class="token punctuation">.</span>use_svg_display<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fig<span class="token punctuation">,</span> self<span class="token punctuation">.</span>axes <span class="token operator">=</span> d2l<span class="token punctuation">.</span>plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token punctuation">,</span> ncols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>        <span class="token keyword">if</span> nrows <span class="token operator">*</span> ncols <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>axes <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>axes<span class="token punctuation">,</span> <span class="token punctuation">]</span>        <span class="token comment"># ä½¿ç”¨lambdaå‡½æ•°æ•è·å‚æ•°</span>        self<span class="token punctuation">.</span>config_axes <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> d2l<span class="token punctuation">.</span>set_axes<span class="token punctuation">(</span>            self<span class="token punctuation">.</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> xlabel<span class="token punctuation">,</span> ylabel<span class="token punctuation">,</span> xlim<span class="token punctuation">,</span> ylim<span class="token punctuation">,</span> xscale<span class="token punctuation">,</span> yscale<span class="token punctuation">,</span> legend<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> self<span class="token punctuation">.</span>fmts <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> fmts    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å‘å›¾è¡¨ä¸­æ·»åŠ å¤šä¸ªæ•°æ®ç‚¹</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token string">"__len__"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            y <span class="token operator">=</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span>        n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"__len__"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            x <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">*</span> n        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>X<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>Y<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>Y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> a <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> b <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                self<span class="token punctuation">.</span>X<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>Y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cla<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> fmt <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>X<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> self<span class="token punctuation">.</span>fmts<span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>config_axes<span class="token punctuation">(</span><span class="token punctuation">)</span>        display<span class="token punctuation">.</span>display<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fig<span class="token punctuation">)</span>        display<span class="token punctuation">.</span>clear_output<span class="token punctuation">(</span>wait<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># è¯»å–æ•°æ®</span>    batch_size <span class="token operator">=</span> <span class="token number">256</span>    train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_data_fashion_mnist<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span> <span class="token comment"># åŠ è½½æ•°æ®é›†</span>    <span class="token comment"># åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span>    <span class="token comment"># åŸå§‹è¾“å…¥å›¾åƒå¤§å°æ˜¯28*28ï¼Œè¿™é‡Œå°†å…¶è½¬æ¢ä¸ºé•¿åº¦ä¸º28*28=784çš„å‘é‡</span>    num_inputs <span class="token operator">=</span> <span class="token number">784</span>    <span class="token comment"># ç”±äºæœ‰10ä¸ªç±»åˆ«ï¼Œæ‰€ä»¥è¾“å‡ºå±‚çš„è¾“å‡ºä¸ªæ•°ä¸º10</span>    num_outputs <span class="token operator">=</span> <span class="token number">10</span>    <span class="token comment"># å› æ­¤ï¼Œæƒé‡å°†æ„æˆä¸€ä¸ª784*10çš„çŸ©é˜µ</span>    W <span class="token operator">=</span> torch<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> num_outputs<span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># åç½®å°†æ„æˆä¸€ä¸ª10ç»´çš„å‘é‡</span>    b <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_outputs<span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># è®­ç»ƒæ¨¡å‹</span>    lr <span class="token operator">=</span> <span class="token number">0.1</span>    num_epochs <span class="token operator">=</span> <span class="token number">10</span>    updater <span class="token operator">=</span> <span class="token keyword">lambda</span> batch_size<span class="token punctuation">:</span> d2l<span class="token punctuation">.</span>sgd<span class="token punctuation">(</span><span class="token punctuation">[</span>W<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>    train_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> cross_entropy<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> updater<span class="token punctuation">)</span>    <span class="token comment"># é¢„æµ‹</span>    predict_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> test_iter<span class="token punctuation">)</span></code></pre><h3 id="softmaxå›å½’çš„ç®€æ´å®ç°">3.7 softmaxå›å½’çš„ç®€æ´å®ç°</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> d2l <span class="token keyword">import</span> torch <span class="token keyword">as</span> d2l<span class="token comment"># 3.7.1 è·å–å’Œè¯»å–æ•°æ®</span><span class="token comment"># 3.7.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span><span class="token comment"># softmaxå›å½’çš„è¾“å‡ºå±‚æ˜¯ä¸€ä¸ªå…¨è¿æ¥å±‚ã€‚ å› æ­¤åªéœ€åœ¨Sequentialä¸­æ·»åŠ ä¸€ä¸ªå¸¦æœ‰10ä¸ªè¾“å‡ºçš„å…¨è¿æ¥å±‚</span><span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">:</span>        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token comment"># 3.7.3 é‡æ–°å®¡è§†Softmaxçš„å®ç°</span><span class="token comment"># åœ¨äº¤å‰ç†µæŸå¤±å‡½æ•°ä¸­ä¼ é€’æœªè§„èŒƒåŒ–çš„é¢„æµ‹ï¼Œå¹¶åŒæ—¶è®¡ç®—softmaxåŠå…¶å¯¹æ•°</span><span class="token comment"># PyTorchä¸­çš„CrossEntropyLossç±»å°†softmaxè¿ç®—å’Œäº¤å‰ç†µæŸå¤±è®¡ç®—ç»“åˆåœ¨ä¸€èµ·ï¼ŒåŒæ—¶é¿å…äº†æ•°å€¼ä¸ç¨³å®šæ€§</span><span class="token comment"># 3.7.4 ä¼˜åŒ–ç®—æ³•</span><span class="token comment"># ä¸çº¿æ€§å›å½’ä¸­çš„ç›¸åŒï¼Œsoftmaxå›å½’ä¹Ÿä½¿ç”¨å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™ä½œä¸ºä¼˜åŒ–ç®—æ³•ã€‚</span><span class="token comment"># 3.7.5 è®­ç»ƒ</span><span class="token comment"># é€šè¿‡è°ƒç”¨ä¼˜åŒ–ç®—æ³•çš„stepå‡½æ•°æ¥è¿­ä»£æ¨¡å‹å‚æ•°</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># 3.7.1 è·å–å’Œè¯»å–æ•°æ®</span>    batch_size <span class="token operator">=</span> <span class="token number">256</span>    train_iter<span class="token punctuation">,</span> test_iter <span class="token operator">=</span> d2l<span class="token punctuation">.</span>load_data_fashion_mnist<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>    <span class="token comment"># 3.7.2 åˆå§‹åŒ–æ¨¡å‹å‚æ•°</span>    <span class="token comment"># PyTorchä¸ä¼šéšå¼åœ°è°ƒæ•´è¾“å…¥çš„å½¢çŠ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨çº¿æ€§å±‚å‰å®šä¹‰äº†å±•å¹³å±‚ï¼ˆflattenï¼‰ï¼Œæ¥è°ƒæ•´ç½‘ç»œè¾“å…¥çš„å½¢çŠ¶</span>    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    net<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>init_weights<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment"># 3.7.3 é‡æ–°å®¡è§†Softmaxçš„å®ç°</span>    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span>    <span class="token comment"># 3.7.4 ä¼˜åŒ–ç®—æ³•</span>    trainer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token comment"># 3.7.5 è®­ç»ƒ(3.6.6èŠ‚ä¸­å®šä¹‰çš„è®­ç»ƒå‡½æ•°)</span>    num_epochs <span class="token operator">=</span> <span class="token number">10</span>    d2l<span class="token punctuation">.</span>train_ch3<span class="token punctuation">(</span>net<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> num_epochs<span class="token punctuation">,</span> trainer<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 2 é¢„å¤‡çŸ¥è¯†</title>
      <link href="/2024/06/25/DL/2%20%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86/"/>
      <url>/2024/06/25/DL/2%20%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h2 id="é¢„å¤‡çŸ¥è¯†">2 é¢„å¤‡çŸ¥è¯†</h2><h3 id="æ•°æ®æ“ä½œ">2.1 æ•°æ®æ“ä½œ</h3><p>n ç»´æ•°ç»„ï¼Œä¹Ÿç§°ä¸ºå¼ é‡ï¼ˆtensorï¼‰ã€‚æ— è®ºä½¿ç”¨å“ªä¸ªæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå®ƒçš„å¼ é‡ç±»éƒ½ä¸Numpyçš„ndarrayç±»ä¼¼ã€‚</p><p>ä½†æ·±åº¦å­¦ä¹ æ¡†æ¶åˆæ¯”Numpyçš„ndarrayå¤šä¸€äº›é‡è¦åŠŸèƒ½ï¼š</p><ul><li>GPUå¾ˆå¥½åœ°æ”¯æŒåŠ é€Ÿè®¡ç®—ï¼Œè€ŒNumPyä»…æ”¯æŒCPUè®¡ç®—</li><li>å¼ é‡ç±»æ”¯æŒè‡ªåŠ¨å¾®åˆ†ã€‚</li></ul><h3 id="æ•°æ®é¢„å¤„ç†">2.2 æ•°æ®é¢„å¤„ç†</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 2.2.1 è¯»å–æ•°æ®é›†</span><span class="token comment"># è¯»å–æ•°æ®åˆ°CSVæ–‡ä»¶</span><span class="token keyword">import</span> osos<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨</span>data_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token string">'house_tiny.csv'</span><span class="token punctuation">)</span> <span class="token comment"># æ•°æ®æ–‡ä»¶å</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span> <span class="token comment"># åˆ›å»ºå¹¶å†™å…¥ä¸€ä¸ªCSVæ–‡ä»¶</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'NumRooms,Alley,Price\n'</span><span class="token punctuation">)</span>  <span class="token comment"># åˆ—å</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'NA,Pave,127500\n'</span><span class="token punctuation">)</span>  <span class="token comment"># æ¯è¡Œè¡¨ç¤ºä¸€ä¸ªæ•°æ®æ ·æœ¬</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'2,NA,106000\n'</span><span class="token punctuation">)</span>     f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'4,NA,178100\n'</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'NA,NA,140000\n'</span><span class="token punctuation">)</span><span class="token comment"># è¯»å–æ•°æ®</span><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pddata <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_file<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token comment"># 2.2.2 å¤„ç†ç¼ºå¤±å€¼</span>inputs<span class="token punctuation">,</span> outputs <span class="token operator">=</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment"># ilocç´¢å¼•å™¨ï¼Œç”¨äºåˆ†ç¦»è¾“å…¥æ•°æ®å’Œè¾“å‡ºæ•°æ®</span>inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># å¯¹äºinputsä¸­ç¼ºå°‘çš„æ•°å€¼ï¼Œæˆ‘ä»¬ç”¨åŒä¸€åˆ—çš„å‡å€¼æ›¿æ¢â€œNaNâ€é¡¹</span><span class="token keyword">print</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token comment"># 2.2.3 è½¬æ¢ä¸ºå¼ é‡æ ¼å¼</span><span class="token keyword">import</span> torchX <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span>dtype<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span>dtype<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span></code></pre><h4 id="è¯»å–æ•°æ®é›†">2.2.1 è¯»å–æ•°æ®é›†</h4><p>é¦–å…ˆå°†æ•°æ®å­˜å…¥CSVæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨Pandasåº“è¯»å–æ•°æ®ã€‚</p><h4 id="å¤„ç†ç¼ºå¤±å€¼">2.2.2 å¤„ç†ç¼ºå¤±å€¼</h4><p>å…¸å‹çš„æ–¹æ³•åŒ…æ‹¬<strong>æ’å€¼æ³•</strong>å’Œ<strong>åˆ é™¤æ³•</strong>ï¼Œæ’å€¼æ³•ç”¨ä¸€ä¸ªæ›¿ä»£å€¼å¼¥è¡¥ç¼ºå¤±å€¼ï¼Œè€Œåˆ é™¤æ³•åˆ™ç›´æ¥å¿½ç•¥ç¼ºå¤±å€¼ã€‚</p><h4 id="è½¬æ¢ä¸ºå¼ é‡æ ¼å¼">2.2.3 è½¬æ¢ä¸ºå¼ é‡æ ¼å¼</h4><p><code>X=torch.tensor(X.values)</code></p><h3 id="çº¿æ€§ä»£æ•°">2.3 çº¿æ€§ä»£æ•°</h3><h4 id="çŸ©é˜µçš„å¹¿æ’­æœºåˆ¶">2.3.1 çŸ©é˜µçš„å¹¿æ’­æœºåˆ¶</h4><p>å½“å¯¹ä¸¤ä¸ªå½¢çŠ¶ä¸åŒçš„å¼ é‡æŒ‰å…ƒç´ è¿ç®—æ—¶ï¼Œå¯èƒ½ä¼šè§¦å‘å¹¿æ’­æœºåˆ¶ï¼šé¦–å…ˆï¼Œå°†å…ƒç´ é€å…ƒç´ åœ°å¤åˆ¶åˆ°ä¸€ä¸ªåˆé€‚çš„å½¢çŠ¶ï¼Œä»¥ä½¿ä¸¤ä¸ªå¼ é‡å…·æœ‰ç›¸åŒçš„å½¢çŠ¶ï¼Œç„¶åå†æŒ‰å…ƒç´ è¿ç®—ã€‚</p><p>å¹¿æ’­çš„è§„åˆ™å¦‚ä¸‹ï¼š</p><ol type="1"><li>å¦‚æœå¼ é‡çš„ç»´æ•°ä¸åŒï¼Œå°†ç»´æ•°è¾ƒå°çš„å¼ é‡è¿›è¡Œæ‰©å±•ï¼Œç›´åˆ°ä¸¤ä¸ªå¼ é‡çš„ç»´æ•°éƒ½ä¸€æ ·ã€‚ä¾‹å¦‚ï¼Œå°†å¼ é‡çš„å½¢çŠ¶(2,3, 4)å’Œ(4,)å¹¿æ’­ä¸º(2, 3, 4)å’Œ(1, 1, 4)ã€‚</li><li>å¦‚æœä¸¤ä¸ªå¼ é‡åœ¨æŸä¸ªç»´åº¦ä¸Šçš„é•¿åº¦æ˜¯ç›¸åŒçš„ï¼Œ<strong><em>æˆ–å…¶ä¸­ä¸€ä¸ªå¼ é‡åœ¨è¯¥ç»´åº¦ä¸Šçš„é•¿åº¦ä¸º1</em></strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´è¿™ä¸¤ä¸ªå¼ é‡åœ¨è¯¥ç»´åº¦ä¸Šæ˜¯ç›¸å®¹çš„ã€‚ä¾‹å¦‚ï¼Œ(2,3, 1)å’Œ(1, 1, 4)æ˜¯ç›¸å®¹çš„ã€‚</li></ol><p><strong>æ³¨æ„:ä¸¤ä¸ªå¼ é‡çš„å½¢çŠ¶åœ¨ä»»ä½•ä¸€ä¸ªç»´åº¦ä¸Šè¦ä¹ˆç›¸ç­‰ï¼Œè¦ä¹ˆå…¶ä¸­ä¸€ä¸ªä¸º1ã€‚</strong></p><h3 id="å¾®ç§¯åˆ†">2.4 å¾®ç§¯åˆ†</h3><h3 id="è‡ªåŠ¨å¾®åˆ†">2.5 è‡ªåŠ¨å¾®åˆ†</h3><p>æ·±åº¦å­¦ä¹ æ¡†æ¶é€šè¿‡è‡ªåŠ¨è®¡ç®—å¯¼æ•°ï¼Œå³è‡ªåŠ¨å¾®åˆ†ï¼ˆautomaticdifferentiationï¼‰æ¥åŠ å¿«æ±‚å¯¼ã€‚å®é™…ä¸­ï¼Œæ ¹æ®è®¾è®¡å¥½çš„æ¨¡å‹ï¼Œç³»ç»Ÿä¼šæ„å»ºä¸€ä¸ªè®¡ç®—å›¾ï¼ˆcomputational graphï¼‰ï¼Œæ¥è·Ÿè¸ªè®¡ç®—æ˜¯å“ªäº›æ•°æ®é€šè¿‡å“ªäº›æ“ä½œç»„åˆèµ·æ¥äº§ç”Ÿè¾“å‡ºã€‚è‡ªåŠ¨å¾®åˆ†ä½¿ç³»ç»Ÿèƒ½å¤Ÿéšååå‘ä¼ æ’­æ¢¯åº¦ã€‚è¿™é‡Œï¼Œåå‘ä¼ æ’­ï¼ˆbackpropagateï¼‰æ„å‘³ç€è·Ÿè¸ªæ•´ä¸ªè®¡ç®—å›¾ï¼Œå¡«å……å…³äºæ¯ä¸ªå‚æ•°çš„åå¯¼æ•°ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆå°†æ¢¯åº¦é™„åŠ åˆ°æƒ³è¦å¯¹å…¶è®¡ç®—åå¯¼æ•°çš„å˜é‡ä¸Šï¼Œç„¶åè®°å½•ç›®æ ‡å€¼çš„è®¡ç®—ï¼Œæ‰§è¡Œå®ƒçš„åå‘ä¼ æ’­å‡½æ•°ï¼Œå¹¶è®¿é—®å¾—åˆ°çš„æ¢¯åº¦ã€‚</p><h3 id="æ¦‚ç‡">2.6 æ¦‚ç‡</h3><p>ç®€å•åœ°è¯´ï¼Œæœºå™¨å­¦ä¹ å°±æ˜¯åšå‡ºé¢„æµ‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±åº¦å­¦ä¹ â€”â€” 1 å¼•è¨€</title>
      <link href="/2024/06/25/DL/1%20%E5%BC%95%E8%A8%80/"/>
      <url>/2024/06/25/DL/1%20%E5%BC%95%E8%A8%80/</url>
      
        <content type="html"><![CDATA[<p>åŸºäº<a href="https://zh-v2.d2l.ai/">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ Pytorchç‰ˆ</a></p><h2 id="å¼•è¨€">1 å¼•è¨€</h2><h3 id="æœºå™¨å­¦ä¹ ä¸­çš„å…³é”®ç»„ä»¶">1.1 æœºå™¨å­¦ä¹ ä¸­çš„å…³é”®ç»„ä»¶</h3><ol type="1"><li>å¯ä»¥ç”¨æ¥å­¦ä¹ çš„æ•°æ®ï¼ˆdataï¼‰ï¼›</li><li>å¦‚ä½•è½¬æ¢æ•°æ®çš„æ¨¡å‹ï¼ˆmodelï¼‰ï¼›</li><li>â¼€ä¸ªç›®æ ‡å‡½æ•°ï¼ˆobjective functionï¼‰ï¼Œç”¨æ¥é‡åŒ–æ¨¡å‹çš„æœ‰æ•ˆæ€§ï¼›</li><li>è°ƒæ•´æ¨¡å‹å‚æ•°ä»¥ä¼˜åŒ–ç›®æ ‡å‡½æ•°çš„ç®—æ³•ï¼ˆalgorithmï¼‰ã€‚</li></ol><h3 id="å„ç§æœºå™¨å­¦ä¹ é—®é¢˜">1.2 å„ç§æœºå™¨å­¦ä¹ é—®é¢˜</h3><h4 id="ç›‘ç£å­¦ä¹ ">1.2.1 ç›‘ç£å­¦ä¹ </h4><p>ç›‘ç£å­¦ä¹ ï¼ˆsupervised learningï¼‰æ“…é•¿åœ¨â€œç»™å®šè¾“å…¥ç‰¹å¾â€çš„æƒ…å†µä¸‹é¢„æµ‹æ ‡ç­¾ã€‚æ¯ä¸ªâ€œç‰¹å¾-æ ‡ç­¾â€å¯¹éƒ½ç§°ä¸ºä¸€ä¸ªæ ·æœ¬ï¼ˆexampleï¼‰ã€‚æœ‰æ—¶ï¼Œå³ä½¿æ ‡ç­¾æ˜¯æœªçŸ¥çš„ï¼Œæ ·æœ¬ä¹Ÿå¯ä»¥æŒ‡ä»£è¾“å…¥ç‰¹å¾ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ªæ¨¡å‹ï¼Œèƒ½å¤Ÿå°†ä»»ä½•è¾“å…¥ç‰¹å¾æ˜ å°„åˆ°æ ‡ç­¾ï¼ˆå³é¢„æµ‹ï¼‰ã€‚</p><p>ç›‘ç£å­¦ä¹ çš„å­¦ä¹ è¿‡ç¨‹ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºä¸‰å¤§æ­¥éª¤ï¼š</p><ol type="1"><li>ä»å·²çŸ¥å¤§é‡æ•°æ®æ ·æœ¬ä¸­éšæœºé€‰å–ä¸€ä¸ªå­é›†ï¼Œä¸ºæ¯ä¸ªæ ·æœ¬è·å–çœŸå®æ ‡ç­¾ã€‚è¿™äº›è¾“å…¥å’Œç›¸åº”çš„æ ‡ç­¾ä¸€èµ·æ„æˆäº†è®­ç»ƒæ•°æ®é›†ï¼›</li><li>é€‰æ‹©æœ‰ç›‘ç£çš„å­¦ä¹ ç®—æ³•ï¼Œå®ƒå°†è®­ç»ƒæ•°æ®é›†ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡ºä¸€ä¸ªâ€œå·²å®Œæˆå­¦ä¹ çš„æ¨¡å‹â€ï¼›</li><li>å°†ä¹‹å‰æ²¡æœ‰è§è¿‡çš„æ ·æœ¬ç‰¹å¾æ”¾åˆ°è¿™ä¸ªâ€œå·²å®Œæˆå­¦ä¹ çš„æ¨¡å‹â€ä¸­ï¼Œä½¿ç”¨æ¨¡å‹çš„è¾“å‡ºä½œä¸ºç›¸åº”æ ‡ç­¾çš„é¢„æµ‹ã€‚</li></ol><p>å…·ä½“å¦‚å›¾1.1æ‰€ç¤º:</p><figure><img src="./images/1.1_supervised-learning.svg#60x60"title="å›¾1.1ï¼šç›‘ç£å­¦ä¹ " alt="ç›‘ç£å­¦ä¹ " /><figcaption aria-hidden="true">ç›‘ç£å­¦ä¹ </figcaption></figure><h5 id="å›å½’">1.2.1.1 å›å½’</h5><p>å½“æ ‡ç­¾å–ä»»æ„æ•°å€¼æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå›å½’é—®é¢˜ï¼Œå³è®­ç»ƒä¸€ä¸ªå›å½’å‡½æ•°æ¥è¾“å‡ºä¸€ä¸ªæ•°å€¼ã€‚ä¾‹å¦‚ï¼Œç»™å®šä¸€ç»„æˆ¿å±‹çš„ç‰¹å¾ï¼Œæˆ‘ä»¬å¯ä»¥è®­ç»ƒä¸€ä¸ªæ¨¡å‹æ¥é¢„æµ‹æˆ¿å±‹çš„ä»·æ ¼ã€‚å›å½’é—®é¢˜çš„å¸¸è§æŸå¤±å‡½æ•°ä¸º<strong>å¹³æ–¹è¯¯å·®</strong>ã€‚</p><h5 id="åˆ†ç±»">1.2.1.2 åˆ†ç±»</h5><p>åˆ†ç±»é—®é¢˜å¸Œæœ›æ¨¡å‹èƒ½å¤Ÿé¢„æµ‹æ ·æœ¬å±äºå“ªä¸ªç±»åˆ«ã€‚ä¾‹å¦‚ï¼Œç»™å®šä¸€ç»„çŒ«å’Œç‹—çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥è®­ç»ƒä¸€ä¸ªæ¨¡å‹æ¥é¢„æµ‹å›¾ç‰‡ä¸­æ˜¯çŒ«è¿˜æ˜¯ç‹—ã€‚åˆ†ç±»é—®é¢˜çš„å¸¸è§æŸå¤±å‡½æ•°ä¸º<strong>äº¤å‰ç†µ</strong>ã€‚</p><h5 id="æ ‡è®°é—®é¢˜">1.2.1.3 æ ‡è®°é—®é¢˜</h5><p>ç±»ä¼¼äºå¤šæ ‡ç­¾åˆ†ç±»ï¼Œæ¯”å¦‚è¯†åˆ«ä¸€å¼ å›¾ä¸­æ‰€æœ‰çš„ç‰©ä½“å¹¶ç»™å‡ºæ ‡è®°ã€‚</p><h5 id="æœç´¢">1.2.1.4 æœç´¢</h5><p>åœ¨ä¿¡æ¯æ£€ç´¢é¢†åŸŸï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹ä¸€ç»„é¡¹ç›®è¿›è¡Œæ’åºã€‚ä»¥ç½‘ç»œæœç´¢ä¸ºä¾‹ï¼Œç›®æ ‡ä¸æ˜¯ç®€å•çš„â€œæŸ¥è¯¢ï¼ˆqueryï¼‰-ç½‘é¡µï¼ˆpageï¼‰â€åˆ†ç±»ï¼Œè€Œæ˜¯åœ¨æµ·é‡æœç´¢ç»“æœä¸­æ‰¾åˆ°ç”¨æˆ·æœ€éœ€è¦çš„é‚£éƒ¨åˆ†ã€‚å¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯é¦–å…ˆä¸ºé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ åˆ†é…ç›¸åº”çš„ç›¸å…³æ€§åˆ†æ•°ï¼Œç„¶åæ£€ç´¢è¯„çº§æœ€é«˜çš„å…ƒç´ ã€‚</p><h5 id="æ¨èç³»ç»Ÿ">1.2.1.5 æ¨èç³»ç»Ÿ</h5><p>ç›®æ ‡æ˜¯å‘ç‰¹å®šç”¨æˆ·è¿›è¡Œâ€œä¸ªæ€§åŒ–â€æ¨è</p><h5 id="åºåˆ—å­¦ä¹ ">1.2.1.6 åºåˆ—å­¦ä¹ </h5><p>å¦‚æœè¾“å…¥æ˜¯è¿ç»­çš„ï¼Œæ¨¡å‹å¯èƒ½å°±éœ€è¦æ‹¥æœ‰â€œè®°å¿†â€åŠŸèƒ½ã€‚å› ä¸ºé¢„æµ‹åè€…éœ€è¦å‰è€…çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯­éŸ³è¯†åˆ«ï¼Œæœºå™¨ç¿»è¯‘ç­‰ã€‚</p><h4 id="æ— ç›‘ç£å­¦ä¹ ">1.2.2 æ— ç›‘ç£å­¦ä¹ </h4><ol type="1"><li><strong>èšç±»</strong>ï¼ˆclusteringï¼‰é—®é¢˜ï¼šæ²¡æœ‰æ ‡ç­¾çš„æƒ…å†µä¸‹ï¼Œç»™æ•°æ®åˆ†ç±»ã€‚</li><li><strong>ä¸»æˆåˆ†åˆ†æ</strong>ï¼ˆprincipal componentanalysisï¼‰é—®é¢˜ï¼šæˆ‘ä»¬èƒ½å¦æ‰¾åˆ°å°‘é‡çš„å‚æ•°æ¥å‡†ç¡®åœ°æ•æ‰æ•°æ®çš„çº¿æ€§ç›¸å…³å±æ€§ï¼Ÿæ¯”å¦‚ï¼Œä¸€ä¸ªçƒçš„è¿åŠ¨è½¨è¿¹å¯ä»¥ç”¨çƒçš„é€Ÿåº¦ã€ç›´å¾„å’Œè´¨é‡æ¥æè¿°ã€‚</li><li><strong>å› æœå…³ç³»</strong>ï¼ˆcausalityï¼‰å’Œ<strong>æ¦‚ç‡å›¾</strong>æ¨¡å‹ï¼ˆprobabilisticgraphicalmodelsï¼‰é—®é¢˜ï¼šæˆ‘ä»¬èƒ½å¦æè¿°è§‚å¯Ÿåˆ°çš„è®¸å¤šæ•°æ®çš„æ ¹æœ¬åŸå› ï¼Ÿä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å…³äºæˆ¿ä»·ã€æ±¡æŸ“ã€çŠ¯ç½ªã€åœ°ç†ä½ç½®ã€æ•™è‚²å’Œå·¥èµ„çš„äººå£ç»Ÿè®¡æ•°æ®ï¼Œæˆ‘ä»¬èƒ½å¦ç®€å•åœ°æ ¹æ®ç»éªŒæ•°æ®å‘ç°å®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼Ÿ</li><li><strong>ç”Ÿæˆå¯¹æŠ—æ€§ç½‘ç»œ</strong>ï¼ˆgenerative adversarialnetworksï¼‰ï¼šä¸ºæˆ‘ä»¬æä¾›ä¸€ç§åˆæˆæ•°æ®çš„æ–¹æ³•ï¼Œç”šè‡³åƒå›¾åƒå’ŒéŸ³é¢‘è¿™æ ·å¤æ‚çš„éç»“æ„åŒ–æ•°æ®ã€‚æ½œåœ¨çš„ç»Ÿè®¡æœºåˆ¶æ˜¯æ£€æŸ¥çœŸå®å’Œè™šå‡æ•°æ®æ˜¯å¦ç›¸åŒçš„æµ‹è¯•ã€‚</li></ol><h4 id="ä¸ç¯å¢ƒäº’åŠ¨">1.2.3 ä¸ç¯å¢ƒäº’åŠ¨</h4><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸ç®¡æ˜¯ç›‘ç£å­¦ä¹ è¿˜æ˜¯æ— ç›‘ç£å­¦ä¹ ï¼Œæˆ‘ä»¬éƒ½ä¼šé¢„å…ˆè·å–å¤§é‡æ•°æ®ï¼Œç„¶åå¯åŠ¨æ¨¡å‹ï¼Œä¸å†ä¸ç¯å¢ƒäº¤äº’ã€‚<strong>è¿™é‡Œæ‰€æœ‰å­¦ä¹ éƒ½æ˜¯åœ¨ç®—æ³•ä¸ç¯å¢ƒæ–­å¼€åè¿›è¡Œçš„ï¼Œè¢«ç§°ä¸ºç¦»çº¿å­¦ä¹ </strong>ã€‚</p><h4 id="å¼ºåŒ–å­¦ä¹ ">1.2.4 å¼ºåŒ–å­¦ä¹ </h4><p>æ™ºèƒ½ä½“ï¼ˆagentï¼‰åœ¨ä¸€ç³»åˆ—çš„æ—¶é—´æ­¥éª¤ä¸Šä¸ç¯å¢ƒäº¤äº’ã€‚åœ¨æ¯ä¸ªç‰¹å®šæ—¶é—´ç‚¹ï¼Œæ™ºèƒ½ä½“ä»ç¯å¢ƒæ¥æ”¶ä¸€äº›è§‚å¯Ÿï¼ˆobservationï¼‰ï¼Œå¹¶ä¸”å¿…é¡»é€‰æ‹©ä¸€ä¸ªåŠ¨ä½œï¼ˆactionï¼‰ï¼Œç„¶åé€šè¿‡æŸç§æœºåˆ¶å°†å…¶ä¼ è¾“å›ç¯å¢ƒï¼Œæœ€åæ™ºèƒ½ä½“ä»ç¯å¢ƒä¸­è·å¾—å¥–åŠ±ï¼ˆrewardï¼‰ã€‚æ­¤åæ–°ä¸€è½®å¾ªç¯å¼€å§‹ï¼Œæ™ºèƒ½ä½“æ¥æ”¶åç»­è§‚å¯Ÿï¼Œå¹¶é€‰æ‹©åç»­æ“ä½œï¼Œä¾æ­¤ç±»æ¨ã€‚å¼ºåŒ–å­¦ä¹ çš„è¿‡ç¨‹åœ¨å›¾1.2ä¸­è¿›è¡Œäº†è¯´æ˜ã€‚è¯·æ³¨æ„ï¼Œå¼ºåŒ–å­¦ä¹ çš„ç›®æ ‡æ˜¯äº§ç”Ÿä¸€ä¸ªå¥½çš„ç­–ç•¥ï¼ˆpolicyï¼‰ã€‚å¼ºåŒ–å­¦ä¹ æ™ºèƒ½ä½“é€‰æ‹©çš„â€œåŠ¨ä½œâ€å—ç­–ç•¥æ§åˆ¶ï¼Œå³ä¸€ä¸ªä»ç¯å¢ƒè§‚å¯Ÿæ˜ å°„åˆ°è¡ŒåŠ¨çš„åŠŸèƒ½ã€‚</p><figure><img src="./images/1.2_reinforcement-learning.svg#70x70"title="å›¾1.2ï¼šå¼ºåŒ–å­¦ä¹ " alt="å¼ºåŒ–å­¦ä¹ " /><figcaption aria-hidden="true">å¼ºåŒ–å­¦ä¹ </figcaption></figure><ul><li><strong>å½“ç¯å¢ƒå¯è¢«å®Œå…¨è§‚å¯Ÿåˆ°æ—¶ï¼Œå¼ºåŒ–å­¦ä¹ é—®é¢˜è¢«ç§°ä¸ºé©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹</strong>ï¼ˆmarkovdecision processï¼‰ã€‚</li><li>å½“çŠ¶æ€ä¸ä¾èµ–äºä¹‹å‰çš„æ“ä½œæ—¶ï¼Œæˆ‘ä»¬ç§°è¯¥é—®é¢˜ä¸ºä¸Šä¸‹æ–‡èµŒåšæœºï¼ˆcontextualbandit problemï¼‰ã€‚</li><li>å½“æ²¡æœ‰çŠ¶æ€ï¼Œåªæœ‰ä¸€ç»„æœ€åˆæœªçŸ¥å›æŠ¥çš„å¯ç”¨åŠ¨ä½œæ—¶ï¼Œè¿™ä¸ªé—®é¢˜å°±æ˜¯ç»å…¸çš„å¤šè‡‚èµŒåšæœºï¼ˆmulti-armedbandit problemï¼‰ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> æ·±åº¦å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Winåº”ç”¨æ¸…å•æ–‡ä»¶</title>
      <link href="/2024/06/20/TechnicalNotes/win%E5%BA%94%E7%94%A8%E6%B8%85%E5%8D%95/"/>
      <url>/2024/06/20/TechnicalNotes/win%E5%BA%94%E7%94%A8%E6%B8%85%E5%8D%95/</url>
      
        <content type="html"><![CDATA[<h2 id="package.appxmanifest-æ–‡ä»¶æ¦‚è¿°">1. Package.appxmanifestæ–‡ä»¶æ¦‚è¿°</h2><p>Package.appxmanifest æ–‡ä»¶æ˜¯ Windowsåº”ç”¨ç¨‹åºçš„æ¸…å•æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³åº”ç”¨ç¨‹åºçš„å…ƒæ•°æ®å’Œé…ç½®ä¿¡æ¯ã€‚å®ƒå®šä¹‰äº†åº”ç”¨ç¨‹åºçš„åç§°ã€ç‰ˆæœ¬ã€æè¿°ã€å›¾æ ‡ã€æƒé™ç­‰ä¿¡æ¯ã€‚Package.appxmanifestæ–‡ä»¶æ˜¯ Windows åº”ç”¨ç¨‹åºæ‰“åŒ…å’Œéƒ¨ç½²çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p>åœ¨VS2022ä¸­åˆ›å»º WinUI3 é¡¹ç›®æ—¶ï¼ŒPackage.appxmanifestæ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚å¯ä»¥åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰¾åˆ°è¯¥æ–‡ä»¶ã€‚ è¯¥æ–‡ä»¶æ˜¯ XMLæ ¼å¼çš„ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æˆ– Visual Studio çš„å›¾å½¢åŒ–ç•Œé¢è¿›è¡Œç¼–è¾‘ã€‚</p><h2 id="package.appxmanifest-æ–‡ä»¶çš„ç»“æ„">2. Package.appxmanifestæ–‡ä»¶çš„ç»“æ„</h2><h3 id="åº”ç”¨èµ„äº§">2.1 åº”ç”¨èµ„äº§</h3><ol type="1"><li>æ˜¾ç¤ºåç§°ï¼šåº”ç”¨ç¨‹åºçš„åç§°ï¼Œåœ¨ Windows å¼€å§‹èœå•å’Œä»»åŠ¡æ ä¸­æ˜¾ç¤ºã€‚</li><li>å…¥å£ç‚¹ï¼šæŒ‡å®šåº”ç”¨å¯åŠ¨æ—¶è¦æ‰§è¡Œçš„ç±»æˆ–æ–‡ä»¶ã€‚é»˜è®¤ä¸º<code>$targetentrypoint$</code>ï¼Œé€šå¸¸åœ¨ WinUI 3 åº”ç”¨ä¸­æŒ‡å‘ App.xaml.csæ–‡ä»¶ä¸­çš„ OnLaunched æ–¹æ³•ã€‚</li><li>é»˜è®¤è¯­è¨€ï¼šæŒ‡å®šåº”ç”¨ç¨‹åºçš„é»˜è®¤è¯­è¨€ã€‚å¯ä»¥ä½¿ç”¨è¯­è¨€ä»£ç ï¼ˆå¦‚<code>en-US</code>ã€<code>zh-CN</code> ç­‰ï¼‰æ¥è¡¨ç¤ºä¸åŒçš„è¯­è¨€ã€‚</li><li>è¯´æ˜ï¼šåº”ç”¨ç¨‹åºçš„ç®€çŸ­æè¿°ï¼Œé€šå¸¸åœ¨ Windowsåº”ç”¨å•†åº—ä¸­æ˜¾ç¤ºã€‚å®ƒåº”è¯¥æ¸…æ™°åœ°ä¼ è¾¾åº”ç”¨ç¨‹åºçš„åŠŸèƒ½å’Œç‰¹ç‚¹ã€‚</li><li>ä¿¡ä»»çº§åˆ«ï¼šæŒ‡å®šåº”ç”¨çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚<ol type="1"><li><code>AppContainer</code>ï¼šæ²™ç›’ç¯å¢ƒï¼Œé™åˆ¶åº”ç”¨è®¿é—®ç³»ç»Ÿèµ„æºï¼Œæä¾›æ›´é«˜çš„å®‰å…¨æ€§ã€‚</li><li><code>MediumIL</code>ï¼šè¾ƒé«˜æƒé™ï¼Œå…è®¸è®¿é—®æ›´å¤šç³»ç»Ÿèµ„æºã€‚</li></ol></li><li>è¿è¡Œæ—¶è¡Œä¸ºï¼š<ol type="1"><li><code>WindowsApp</code>ï¼šä¼ ç»Ÿ UWP åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œéµå¾ª Windowsåº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</li><li><code>PackagedClassicApp</code>ï¼šæ‰“åŒ…çš„ä¼ ç»Ÿåº”ç”¨ç¨‹åºï¼Œé€šå¸¸æ˜¯é€šè¿‡Desktop Bridge æ‰“åŒ…çš„ Win32 åº”ç”¨ï¼Œä¿ç•™ Win32 è¡Œä¸ºä½†äº«å—ç°ä»£åŒ…è£…ã€‚</li><li><code>Win32App</code>ï¼šæ ‡å‡† Win32åº”ç”¨ç¨‹åºè¡Œä¸ºï¼Œé€‚ç”¨äºä¼ ç»Ÿæ¡Œé¢åº”ç”¨ç¨‹åºã€‚</li><li><code>AppSilo</code>ï¼šæä¾›éš”ç¦»ç¯å¢ƒï¼Œå…è®¸åº”ç”¨åœ¨éš”ç¦»çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ï¼Œå¢å¼ºå®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</li></ol></li><li>æ”¯æŒçš„æ—‹è½¬ï¼šæŒ‡ç¤ºåº”ç”¨ç¨‹åºé¦–é€‰çš„å±å¹•æ–¹å‘ã€‚</li><li>é”å®šå±å¹•é€šçŸ¥ï¼š<ol type="1"><li>å¾½ç« ï¼šå°å›¾æ ‡é€šçŸ¥ï¼Œå¯åœ¨é”å±ç•Œé¢æ˜¾ç¤ºæ•°å­—æˆ–å›¾æ ‡ï¼Œé€šå¸¸ç”¨äºæ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°é‡æˆ–åº”ç”¨çŠ¶æ€ã€‚</li><li>å¾½ç« å’Œç£è´´æ–‡æœ¬ï¼šé™¤å¾½ç« å¤–ï¼Œè¿˜å¯æ˜¾ç¤ºæ–‡å­—é€šçŸ¥ï¼Œæä¾›æ›´ä¸°å¯Œçš„ä¿¡æ¯å†…å®¹ã€‚</li></ol></li><li>èµ„æºç»„ï¼šç”¨äºç»„ç»‡å’Œç®¡ç†åº”ç”¨èµ„æºï¼ˆå¦‚å›¾æ ‡ã€è¯­è¨€æ–‡ä»¶ï¼‰ã€‚</li><li>ç£è´´æ›´æ–°ï¼šé…ç½®åŠ¨æ€ç£è´´çš„æ›´æ–°æ–¹å¼ã€‚<ul><li>é‡å¤(æ—¶é—´)ï¼šå®šä¹‰ç£è´´å†…å®¹æ›´æ–°çš„é¢‘ç‡ï¼ˆå¦‚æ¯30åˆ†é’Ÿã€æ¯å°æ—¶ï¼‰ã€‚</li><li>URIæ¨¡æ¿ï¼šæŒ‡å®šè·å–ç£è´´æ›´æ–°å†…å®¹çš„ç½‘ç»œåœ°å€ï¼Œç”¨äºåŠ¨æ€æ›´æ–°ç£è´´å†…å®¹ã€‚</li></ul></li></ol><h2 id="è§†è§‰å¯¹è±¡èµ„äº§">2.2 è§†è§‰å¯¹è±¡èµ„äº§</h2><p>è§†è§‰å¯¹è±¡èµ„äº§å®šä¹‰äº†åº”ç”¨çš„å›¾å½¢æ ‡è¯†å…ƒç´ ã€‚</p><h2 id="åŠŸèƒ½">2.3 åŠŸèƒ½</h2><p>åŠŸèƒ½å®šä¹‰åº”ç”¨å¯ä»¥è®¿é—®çš„ç³»ç»Ÿèµ„æºå’ŒAPIæƒé™ã€‚</p><h2 id="å£°æ˜">2.4 å£°æ˜</h2><p>å£°æ˜å®šä¹‰åº”ç”¨å¯ä»¥ä¸Windowsæ“ä½œç³»ç»Ÿå’Œå…¶ä»–åº”ç”¨è¿›è¡Œæ·±åº¦é›†æˆçš„æ–¹å¼ã€‚</p><h2 id="å†…å®¹uri">2.5 å†…å®¹URI</h2><p>å†…å®¹URIè§„åˆ™å®šä¹‰äº†åº”ç”¨å†…WebViewæ§ä»¶å¯ä»¥å¯¼èˆªåˆ°çš„ç½‘ç«™ã€‚</p><h2 id="æ‰“åŒ…">2.6 æ‰“åŒ…</h2><ol type="1"><li>åŒ…å: åº”ç”¨ç¨‹åºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªåå‘åŸŸåæ ¼å¼çš„å­—ç¬¦ä¸²ï¼ˆå¦‚<code>com.example.app</code>ï¼‰ã€‚</li><li>åŒ…æ˜¾ç¤ºåç§°ï¼šåº”ç”¨ç¨‹åºåœ¨ Windows ç³»ç»Ÿä¸­çš„æ˜¾ç¤ºåç§°ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æœºå™¨å­¦ä¹ ä»‹ç»</title>
      <link href="/2024/06/05/ML/introduction/"/>
      <url>/2024/06/05/ML/introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="æœºå™¨å­¦ä¹ ä»‹ç»">æœºå™¨å­¦ä¹ ä»‹ç»</h1><h2 id="æœºå™¨å­¦ä¹ çš„å®šä¹‰">1 æœºå™¨å­¦ä¹ çš„å®šä¹‰</h2><p>æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œç ”ç©¶å¦‚ä½•è®©è®¡ç®—æœºç³»ç»Ÿåˆ©ç”¨æ•°æ®å’Œç»éªŒï¼Œæ¥ä¸æ–­æ”¹å–„å’Œä¼˜åŒ–è‡ªèº«çš„æ€§èƒ½ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ç®—æ³•å’Œæ¨¡å‹è®©è®¡ç®—æœºä»æ•°æ®ä¸­å­¦ä¹ ï¼Œè€Œä¸æ˜¯é€šè¿‡æ˜ç¡®çš„ç¼–ç¨‹è§„åˆ™æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><h2 id="æœºå™¨å­¦ä¹ çš„åˆ†ç±»">2 æœºå™¨å­¦ä¹ çš„åˆ†ç±»</h2><p>æœºå™¨å­¦ä¹ çš„ä¸»è¦åˆ†æ”¯æœ‰ç›‘ç£å­¦ä¹ ã€æ— ç›‘ç£å­¦ä¹ ã€åŠç›‘ç£å­¦ä¹ ã€å¼ºåŒ–å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ç­‰ã€‚</p><ol type="1"><li>æ ¹æ®å­¦ä¹ æ–¹å¼ï¼š<ol type="1"><li>ç›‘ç£å­¦ä¹ (Supervised Learning)</li><li>æ— ç›‘ç£å­¦ä¹ (Unsupervised Learning)</li><li>åŠç›‘ç£å­¦ä¹ (Semi-supervised Learning)</li><li>å¼ºåŒ–å­¦ä¹ (Reinforcement Learning)</li></ol></li><li>æ ¹æ®å­¦ä¹ ä»»åŠ¡ï¼š<ol type="1"><li>åˆ†ç±»(Classification)</li><li>å›å½’(Regression)</li><li>èšç±»(Clustering)</li><li>é™ç»´(Dimensionality Reduction)</li></ol></li></ol><p>å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[æœºå™¨å­¦ä¹ ] --&gt; B[ç›‘ç£å­¦ä¹ ]    A --&gt; C[æ— ç›‘ç£å­¦ä¹ ]    B --&gt; D[åŠç›‘ç£å­¦ä¹ ]    C --&gt; D[åŠç›‘ç£å­¦ä¹ ]    A --&gt; E[å¼ºåŒ–å­¦ä¹ ]    A --&gt; F[æ·±åº¦å­¦ä¹ ]    A --&gt; G[è¿ç§»å­¦ä¹ ]    E --&gt; H[æ·±åº¦å¼ºåŒ–å­¦ä¹ ]    F --&gt; H  </pre></div><figure><img src="./images/ML_Categories.webp" alt="æœºå™¨å­¦ä¹ åˆ†ç±»" /><figcaption aria-hidden="true">æœºå™¨å­¦ä¹ åˆ†ç±»</figcaption></figure><h3 id="ç›‘ç£å­¦ä¹ supervised-learning">2.1 ç›‘ç£å­¦ä¹ (SupervisedLearning)</h3><p>åœ¨ç›‘ç£å­¦ä¹ ä¸­ï¼Œæ¨¡å‹é€šè¿‡ä½¿ç”¨å¸¦æ ‡ç­¾çš„è®­ç»ƒæ•°æ®è¿›è¡Œå­¦ä¹ ï¼Œå³æ¯ä¸ªè¾“å…¥æ•°æ®éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„è¾“å‡ºæ ‡ç­¾ã€‚ç›®æ ‡æ˜¯å­¦ä¹ ä»è¾“å…¥åˆ°è¾“å‡ºçš„æ˜ å°„å…³ç³»ï¼Œèƒ½å¤Ÿå¯¹æ–°æ•°æ®è¿›è¡Œé¢„æµ‹ã€‚</p><ol type="1"><li>ä¸»è¦ç±»åˆ«/ä»»åŠ¡ï¼š<ol type="1"><li>åˆ†ç±»(Classification): å°†è¾“å…¥æ•°æ®åˆ†ç±»åˆ°é¢„å®šä¹‰çš„ç±»åˆ«ä¸­ã€‚</li><li>å›å½’(Regression): é¢„æµ‹è¿ç»­çš„æ•°å€¼ã€‚</li></ol></li><li>ä¸»è¦ç®—æ³•<ol type="1"><li>é€»è¾‘å›å½’(Logistic Regression)</li><li>çº¿æ€§å›å½’(Linear Regression)</li><li>æ”¯æŒå‘é‡æœº(Support Vector Machine, SVM)</li><li>å†³ç­–æ ‘(Decision Tree)</li><li>éšæœºæ£®æ—(Random Forest)</li><li>æ·±åº¦ç¥ç»ç½‘ç»œ(Deep Neural Networks, DNN)</li></ol></li></ol><h3 id="æ— ç›‘ç£å­¦ä¹ unsupervised-learning">2.2 æ— ç›‘ç£å­¦ä¹ (UnsupervisedLearning)</h3><p>åœ¨æ— ç›‘ç£å­¦ä¹ ä¸­ï¼Œæ¨¡å‹ä½¿ç”¨æœªæ ‡è®°çš„æ•°æ®è¿›è¡Œå­¦ä¹ ï¼Œè¯•å›¾ä»æ•°æ®ä¸­å‘ç°éšè—çš„ç»“æ„æˆ–æ¨¡å¼ã€‚æ— ç›‘ç£å­¦ä¹ ä¸ä¾èµ–äºè¾“å‡ºæ ‡ç­¾ã€‚</p><ol type="1"><li>ä¸»è¦ç±»åˆ«/ä»»åŠ¡ï¼š<ol type="1"><li>èšç±»(Clustering):å°†æ•°æ®åˆ†ç»„åˆ°ä¸åŒçš„ç±»åˆ«ä¸­ï¼Œä½¿å¾—åŒä¸€ç±»åˆ«å†…çš„æ•°æ®ç›¸ä¼¼åº¦è¾ƒé«˜ï¼Œä¸åŒç±»åˆ«ä¹‹é—´çš„æ•°æ®ç›¸ä¼¼åº¦è¾ƒä½ã€‚</li><li>é™ç»´(Dimensionality Reduction):å‡å°‘æ•°æ®çš„ç‰¹å¾æ•°é‡ï¼ŒåŒæ—¶å°½å¯èƒ½ä¿ç•™é‡è¦ä¿¡æ¯ã€‚</li></ol></li><li>ä¸»è¦ç®—æ³•<ol type="1"><li>Kå‡å€¼èšç±»(K-means Clustering)</li><li>å±‚æ¬¡èšç±»(Hierarchical Clustering)</li><li>ä¸»æˆåˆ†åˆ†æ(Principal Component Analysis, PCA)</li><li>ç‹¬ç«‹æˆåˆ†åˆ†æ(Independent Component Analysis, ICA)</li><li>t-åˆ†å¸ƒé‚»åŸŸåµŒå…¥(t-Distributed Stochastic Neighbor Embedding,t-SNE)</li><li>è‡ªç¼–ç å™¨(Autoencoder)</li><li>ç”Ÿæˆå¯¹æŠ—ç½‘ç»œ(Generative Adversarial Networks, GAN)</li></ol></li></ol><h3 id="åŠç›‘ç£å­¦ä¹ semi-supervised-learning">2.3åŠç›‘ç£å­¦ä¹ (Semi-supervised Learning)</h3><p>åŠç›‘ç£å­¦ä¹ ç»“åˆäº†ç›‘ç£å­¦ä¹ å’Œæ— ç›‘ç£å­¦ä¹ çš„ç‰¹ç‚¹ï¼Œä½¿ç”¨å°‘é‡æ ‡è®°æ•°æ®å’Œå¤§é‡æœªæ ‡è®°æ•°æ®è¿›è¡Œè®­ç»ƒã€‚è¿™ç§æ–¹æ³•åœ¨æ ‡è®°æ•°æ®éš¾ä»¥è·å–ä½†æœªæ ‡è®°æ•°æ®ä¸°å¯Œçš„æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ã€‚</p><ol type="1"><li>å›¾åŠç›‘ç£å­¦ä¹ (Graph-based Semi-supervised Learning)</li><li>åŠç›‘ç£æ”¯æŒå‘é‡æœº(Semi-supervised Support Vector Machine)</li><li>åŠç›‘ç£æ·±åº¦å­¦ä¹ (Semi-supervised Deep Learning)</li></ol><h3 id="å¼ºåŒ–å­¦ä¹ reinforcement-learning">2.4 å¼ºåŒ–å­¦ä¹ (ReinforcementLearning)</h3><p>é€šè¿‡æ™ºèƒ½ä½“/æœºå™¨äºº/ä»£ç†ï¼ˆAgentï¼‰ä¸ç¯å¢ƒï¼ˆEnvironmentï¼‰è¿›è¡Œäº¤äº’å­¦ä¹ çš„æ–¹æ³•ã€‚åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œä»£ç†æ ¹æ®ç¯å¢ƒçš„çŠ¶æ€ï¼ˆStateï¼‰é€‰æ‹©åŠ¨ä½œï¼ˆActionï¼‰ï¼Œå¹¶é€šè¿‡è§‚å¯Ÿç¯å¢ƒçš„åé¦ˆï¼ˆå¥–åŠ±ï¼ˆRewardï¼‰æˆ–æƒ©ç½šï¼‰æ¥è°ƒæ•´è‡ªå·±çš„è¡Œä¸ºç­–ç•¥ï¼Œä»¥è¾¾åˆ°æœ€å¤§åŒ–é•¿æœŸç´¯ç§¯å¥–åŠ±çš„ç›®æ ‡ã€‚</p><ol type="1"><li>ä¸»è¦ç±»åˆ«/ä»»åŠ¡ï¼š<ol type="1"><li>åŸºäºå€¼å‡½æ•°çš„å¼ºåŒ–å­¦ä¹ (Value-based Reinforcement Learning):é€šè¿‡å­¦ä¹ å€¼å‡½æ•°ï¼ˆValueFunctionï¼‰æ¥æŒ‡å¯¼ä»£ç†çš„å†³ç­–ï¼Œä»¥è·å¾—æœ€å¤§çš„é•¿æœŸç´¯ç§¯å¥–åŠ±ã€‚</li><li>åŸºäºç­–ç•¥çš„å¼ºåŒ–å­¦ä¹ (Policy-based Reinforcement Learning):ç›´æ¥å­¦ä¹ æœ€ä¼˜ç­–ç•¥ï¼ˆPolicyï¼‰ï¼Œä»¥è·å¾—æœ€å¤§çš„é•¿æœŸç´¯ç§¯å¥–åŠ±ã€‚</li><li>åŸºäºæ¨¡å‹çš„å¼ºåŒ–å­¦ä¹ (Model-based Reinforcement Learning):é€šè¿‡å­¦ä¹ ç¯å¢ƒçš„æ¨¡å‹æ¥æŒ‡å¯¼ä»£ç†çš„å†³ç­–ï¼Œä»¥è·å¾—æœ€å¤§çš„é•¿æœŸç´¯ç§¯å¥–åŠ±ã€‚</li></ol></li><li>ä¸»è¦ç®—æ³•<ol type="1"><li>Qå­¦ä¹ (Q-Learning)</li><li>æ·±åº¦Qç½‘ç»œ(Deep Q-Network, DQN)</li><li>æ·±åº¦ç¡®å®šæ€§ç­–ç•¥æ¢¯åº¦(Deep Deterministic Policy Gradient, DDPG)</li><li>è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–(Proximal Policy Optimization, PPO)</li></ol></li></ol><h3 id="æ·±åº¦å­¦ä¹ deep-learning">2.5 æ·±åº¦å­¦ä¹ (Deep Learning)</h3><p>ä½¿ç”¨äººå·¥ç¥ç»ç½‘ç»œæ¨¡å‹æ¥å­¦ä¹ æ•°æ®çš„è¡¨å¾ã€‚ä¸ä¼ ç»Ÿæœºå™¨å­¦ä¹ ç®—æ³•ç›¸æ¯”ï¼Œæ·±åº¦å­¦ä¹ æ¨¡å‹å¯ä»¥è‡ªåŠ¨åœ°ä»æ•°æ®ä¸­å­¦ä¹ æ›´åŠ å¤æ‚ã€é«˜é˜¶çš„ç‰¹å¾è¡¨ç¤ºï¼Œå› æ­¤åœ¨å¤„ç†å¤§è§„æ¨¡ã€é«˜ç»´åº¦æ•°æ®æ—¶å…·æœ‰å¾ˆå¼ºçš„è¡¨è¾¾èƒ½åŠ›ã€‚</p><ol type="1"><li>ä¸»è¦ç±»åˆ«/ä»»åŠ¡ï¼š<ol type="1"><li>å›¾åƒè¯†åˆ«(Image Recognition)</li><li>è¯­éŸ³è¯†åˆ«(Speech Recognition)</li><li>è‡ªç„¶è¯­è¨€å¤„ç†(Natural Language Processing, NLP)</li></ol></li><li>ä¸»è¦ç®—æ³•<ol type="1"><li>å·ç§¯ç¥ç»ç½‘ç»œ(Convolutional Neural Networks, CNN)</li><li>å¾ªç¯ç¥ç»ç½‘ç»œ(Recurrent Neural Networks, RNN)</li><li>é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œ(Long Short-Term Memory, LSTM)</li><li>ç”Ÿæˆå¯¹æŠ—ç½‘ç»œ(Generative Adversarial Networks, GAN)</li></ol></li></ol><h3 id="æ·±åº¦å¼ºåŒ–å­¦ä¹ deep-reinforcement-learning">2.6 æ·±åº¦å¼ºåŒ–å­¦ä¹ (DeepReinforcement Learning)</h3><p>å°†æ·±åº¦å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ç»“åˆèµ·æ¥ï¼Œä½¿ç”¨æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹æ¥å­¦ä¹ ä»£ç†çš„ç­–ç•¥æˆ–å€¼å‡½æ•°ï¼Œä»¥è·å¾—æœ€å¤§çš„é•¿æœŸç´¯ç§¯å¥–åŠ±ã€‚</p><ol type="1"><li>ä¸»è¦ç±»åˆ«/ä»»åŠ¡ï¼š<ol type="1"><li>æ¸¸æˆç©æ³•(Game Playing)</li><li>æœºå™¨äººæ§åˆ¶(Robot Control)</li><li>è‡ªåŠ¨é©¾é©¶(Autonomous Driving)</li></ol></li><li>ä¸»è¦ç®—æ³•<ol type="1"><li>æ·±åº¦Qç½‘ç»œ(Deep Q-Network, DQN)</li><li>æ·±åº¦ç¡®å®šæ€§ç­–ç•¥æ¢¯åº¦(Deep Deterministic Policy Gradient, DDPG)</li><li>è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–(Proximal Policy Optimization, PPO)</li></ol></li></ol><h3 id="è¿ç§»å­¦ä¹ transfer-learning">2.7 è¿ç§»å­¦ä¹ (Transfer Learning)</h3><p>åˆ©ç”¨ä¸€ä¸ªä»»åŠ¡çš„å­¦ä¹ ç»éªŒæ¥åŠ é€Ÿå¦ä¸€ä¸ªç›¸å…³ä»»åŠ¡å­¦ä¹ çš„æ–¹æ³•ã€‚åœ¨è¿ç§»å­¦ä¹ ä¸­ï¼Œæ¨¡å‹é€šè¿‡å­¦ä¹ ä¸€ä¸ªä»»åŠ¡çš„ç‰¹å¾è¡¨ç¤ºï¼Œå¯ä»¥æ›´å¿«åœ°é€‚åº”æ–°çš„ä»»åŠ¡ï¼Œç‰¹åˆ«æ˜¯å½“æ–°ä»»åŠ¡çš„æ•°æ®è¾ƒå°‘æˆ–è€…æ–°ä»»åŠ¡ä¸åŸä»»åŠ¡æœ‰ä¸€å®šçš„ç›¸å…³æ€§æ—¶ã€‚</p><ol type="1"><li>å¾®è°ƒ(Fine-tuning):åœ¨é¢„è®­ç»ƒæ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨æ–°ä»»åŠ¡çš„æ•°æ®è¿›è¡Œå¾®è°ƒï¼Œä»¥é€‚åº”æ–°ä»»åŠ¡ã€‚</li><li>ç‰¹å¾æå–(Feature Extraction):ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹æå–ç‰¹å¾ï¼Œç„¶ååœ¨æ–°ä»»åŠ¡ä¸Šè®­ç»ƒä¸€ä¸ªç®€å•çš„åˆ†ç±»å™¨ã€‚</li><li>é¢†åŸŸé€‚åº”(Domain Adaptation):åœ¨æºé¢†åŸŸå’Œç›®æ ‡é¢†åŸŸä¹‹é—´è¿›è¡Œè¿ç§»ï¼Œä»¥æé«˜æ¨¡å‹åœ¨ç›®æ ‡é¢†åŸŸçš„æ€§èƒ½ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æœºå™¨å­¦ä¹  </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythonç³»åˆ—ä¹‹datetime</title>
      <link href="/2024/03/05/Python/datetime/"/>
      <url>/2024/03/05/Python/datetime/</url>
      
        <content type="html"><![CDATA[<h1 id="datetime">datetime</h1><p><code>datetime</code>æ¨¡å—æä¾›äº†å¤„ç†æ—¥æœŸå’Œæ—¶é—´çš„ç±»ã€‚å®ƒæ”¯æŒæ—¥æœŸã€æ—¶é—´ã€æ—¶åŒºç­‰æ“ä½œã€‚</p><h2 id="è·å–æ—¥æœŸå’Œæ—¶é—´">1 è·å–æ—¥æœŸå’Œæ—¶é—´</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime<span class="token keyword">def</span> <span class="token function">get_time</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> hours_offset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    :param delta: delta time    :param unit: options: 'minutes', 'hours', 'days' or 'seconds' or 'none'    :param hours_offset: East 8 time zone offset (Default value = 8)    """</span>    <span class="token comment"># åˆ›å»ºä¸œå…«åŒºæ—¶åŒºå¯¹è±¡ï¼Œåç§»é‡ä¸º8å°æ—¶</span>    tz_east_8 <span class="token operator">=</span> datetime<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span>hours_offset<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># è·å–å½“å‰æ—¶é—´</span>    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>tz_east_8<span class="token punctuation">)</span>    <span class="token comment"># è®¡ç®—æœªæ¥æ—¶é—´</span>    <span class="token keyword">if</span> unit <span class="token operator">==</span> <span class="token string">"none"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> now    <span class="token keyword">elif</span> unit <span class="token operator">==</span> <span class="token string">"seconds"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> now <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>delta<span class="token punctuation">)</span>    <span class="token keyword">elif</span> unit <span class="token operator">==</span> <span class="token string">"minutes"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> now <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span>delta<span class="token punctuation">)</span>    <span class="token keyword">elif</span> unit <span class="token operator">==</span> <span class="token string">"hours"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> now <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span>delta<span class="token punctuation">)</span>    <span class="token keyword">elif</span> unit <span class="token operator">==</span> <span class="token string">"days"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> now <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>delta<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Unsupported unit. Please use 'seconds', 'minutes', 'hours', 'days' or 'none'."</span><span class="token punctuation">)</span><span class="token comment"># ç¤ºä¾‹</span><span class="token comment"># è·å–å½“å‰æ—¶é—´</span>current_time <span class="token operator">=</span> get_time<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"none"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Current time:"</span><span class="token punctuation">,</span> current_time<span class="token punctuation">)</span><span class="token comment"># è·å–æœªæ¥æ—¶é—´</span>future_time <span class="token operator">=</span> get_time<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"minutes"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Future time:"</span><span class="token punctuation">,</span> future_time<span class="token punctuation">)</span></code></pre><h2 id="å½“å‰æ—¶é—´è½¬ä¸ºå­—ç¬¦ä¸²">2 å½“å‰æ—¶é—´è½¬ä¸ºå­—ç¬¦ä¸²</h2><p>å°† datetime.datetime æˆ– datetime.date ç±»å‹è½¬åŒ–ä¸ºå­—ç¬¦ä¸²æ ¼å¼</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime<span class="token keyword">def</span> <span class="token function">datetime_to_string</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    :param dt: datetime.datetime or datetime.date    :param format: format string    :return: formatted string    """</span>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> dt<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> dt<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Unsupported type. Please use datetime.datetime or datetime.date."</span><span class="token punctuation">)</span><span class="token comment"># ç¤ºä¾‹</span><span class="token comment"># è·å–å½“å‰æ—¶é—´</span>current_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>current_time_str <span class="token operator">=</span> datetime_to_string<span class="token punctuation">(</span>current_time<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Current time as string:"</span><span class="token punctuation">,</span> current_time_str<span class="token punctuation">)</span><span class="token comment"># è½¬æ¢ä¸ºæ—¥æœŸ</span>current_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>current_date_str <span class="token operator">=</span> datetime_to_string<span class="token punctuation">(</span>current_date<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Current date as string:"</span><span class="token punctuation">,</span> current_date_str<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythonç³»åˆ—ä¹‹qrcode</title>
      <link href="/2024/03/03/Python/qrcode/"/>
      <url>/2024/03/03/Python/qrcode/</url>
      
        <content type="html"><![CDATA[<p><code>qrcode</code> æ˜¯ä¸€ä¸ªç”¨äºç”ŸæˆäºŒç»´ç çš„ Pythonåº“ã€‚å®ƒå¯ä»¥è½»æ¾åœ°å°†æ–‡æœ¬ã€URL æˆ–å…¶ä»–æ•°æ®ç¼–ç ä¸ºäºŒç»´ç å›¾åƒã€‚</p><h2 id="å®‰è£…">1 å®‰è£…</h2><pre class="language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> qrcode</code></pre><h2 id="ä½¿ç”¨">2 ä½¿ç”¨</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> qrcode<span class="token comment"># æ•°æ®</span>download_link <span class="token operator">=</span> <span class="token string">"https://example.com/download"</span><span class="token comment"># åˆ›å»ºäºŒç»´ç å¯¹è±¡</span>qr <span class="token operator">=</span> qrcode<span class="token punctuation">.</span>QRCode<span class="token punctuation">(</span>    version<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>    error_correction<span class="token operator">=</span>qrcode<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>ERROR_CORRECT_L<span class="token punctuation">,</span>    box_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>    border<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment"># æ·»åŠ æ•°æ®åˆ°äºŒç»´ç </span>qr<span class="token punctuation">.</span>add_data<span class="token punctuation">(</span>download_link<span class="token punctuation">)</span>qr<span class="token punctuation">.</span>make<span class="token punctuation">(</span>fit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># è‡ªåŠ¨è°ƒæ•´äºŒç»´ç å¤§å°ä»¥é€‚åº”æ•°æ®</span><span class="token comment"># åˆ›å»ºäºŒç»´ç å›¾ç‰‡</span>qr_image <span class="token operator">=</span> qr<span class="token punctuation">.</span>make_image<span class="token punctuation">(</span>fill_color<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">,</span> back_color<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">)</span><span class="token comment"># ä¿å­˜äºŒç»´ç å›¾ç‰‡</span><span class="token comment"># qr_image.save("qr_code.png")</span><span class="token comment"># ä¿å­˜ä¸ºwebpæ ¼å¼</span>qr_image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"qr_code.webp"</span><span class="token punctuation">,</span> <span class="token string">"WEBP"</span><span class="token punctuation">)</span></code></pre><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ol type="1"><li>version:äºŒç»´ç çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å·è¶Šé«˜ï¼ŒäºŒç»´ç å¯ä»¥å­˜å‚¨çš„ä¿¡æ¯é‡å°±è¶Šå¤§ï¼Œä½†äºŒç»´ç çš„å°ºå¯¸ä¹Ÿä¼šå¢åŠ <ul><li>ç‰ˆæœ¬å·ä»1åˆ°40ï¼Œ1ä»£è¡¨æœ€å°å°ºå¯¸ï¼Œ40ä»£è¡¨æœ€å¤§å°ºå¯¸</li><li>æ¯ä¸ªç‰ˆæœ¬çš„äºŒç»´ç éƒ½æ˜¯ä¸€ä¸ªæ­£æ–¹å½¢ï¼Œç‰ˆæœ¬å·ä¸º1æ—¶ï¼ŒäºŒç»´ç çš„å°ºå¯¸ä¸º21x21ä¸ªå°æ ¼å­ï¼Œæ¯å¢åŠ ä¸€ä¸ªç‰ˆæœ¬ï¼ŒäºŒç»´ç çš„å°ºå¯¸å°±å¢åŠ 4ä¸ªå°æ ¼å­</li></ul></li><li>error_correction: äºŒç»´ç çš„çº é”™çº§åˆ«ï¼Œç”¨äºæé«˜äºŒç»´ç çš„å®¹é”™èƒ½åŠ›<ul><li>åˆ†åˆ«ä»£è¡¨äº†ä»ä½åˆ°é«˜çš„çº é”™èƒ½åŠ›ï¼Œä½†äºŒç»´ç çš„å°ºå¯¸ä¹Ÿä¼šå¢åŠ <ul><li>ERROR_CORRECT_L: 7% çš„æ•°æ®å¯ä»¥è¢«çº æ­£</li><li>ERROR_CORRECT_M: 15% çš„æ•°æ®å¯ä»¥è¢«çº æ­£</li><li>ERROR_CORRECT_Q: 25% çš„æ•°æ®å¯ä»¥è¢«çº æ­£</li><li>ERROR_CORRECT_H: 30% çš„æ•°æ®å¯ä»¥è¢«çº æ­£</li></ul></li></ul></li><li>box_size:æ¯ä¸ªå°æ ¼å­ï¼ˆæˆ–ç§°ä¸ºåƒç´ ï¼‰çš„å°ºå¯¸ã€‚å€¼è¶Šå¤§ï¼Œç”Ÿæˆçš„äºŒç»´ç å›¾åƒè¶Šå¤§ã€‚box_sizeè¢«è®¾ç½®ä¸º 10ï¼Œè¡¨ç¤ºæ¯ä¸ªå°æ ¼å­çš„å°ºå¯¸ä¸º 10 ä¸ªåƒç´ </li><li>border:äºŒç»´ç å›¾åƒçš„è¾¹æ¡†å®½åº¦ï¼Œå³å›´ç»•äºŒç»´ç å†…å®¹çš„ç©ºç™½è¾¹ç¼˜çš„å®½åº¦ã€‚border è¢«è®¾ç½®ä¸º4ï¼Œè¡¨ç¤ºäºŒç»´ç å›¾åƒçš„è¾¹æ¡†å®½åº¦ä¸º 4 ä¸ªåƒç´ </li></ol>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®åº“</title>
      <link href="/2024/03/03/Web/database/"/>
      <url>/2024/03/03/Web/database/</url>
      
        <content type="html"><![CDATA[<h1 id="æ•°æ®åº“">æ•°æ®åº“</h1><h2 id="mysql">1. MySQL</h2><p>ç”¨äºå­˜å‚¨ç½‘ç«™æ•°æ®</p><h3 id="æ•°æ®åº“æ“ä½œ">1.1 æ•°æ®åº“æ“ä½œ</h3><p>æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span><span class="token punctuation">;</span></code></pre><p>åˆ›å»ºæ•°æ®åº“</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> xxxxx <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span></code></pre><p>åˆ é™¤æ•°æ®åº“</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> xxxxx<span class="token punctuation">;</span></code></pre><p>è¿›å…¥æ•°æ®åº“</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> xxxxx<span class="token punctuation">;</span></code></pre><p>æŸ¥çœ‹æ•°æ®åº“ä¸‹çš„æ•°æ®è¡¨</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span></code></pre><h3 id="æ•°æ®è¡¨æ“ä½œ">1.2 æ•°æ®è¡¨æ“ä½œ</h3><p>åˆ›å»ºæ•°æ®è¡¨</p><p>ä¾‹auth</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> auth<span class="token punctuation">(</span>     id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>     username <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>     password <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>     email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>     user_auth_token <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     expires <span class="token keyword">datetime</span> <span class="token punctuation">)</span><span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></code></pre><p>æŸ¥çœ‹æ•°æ®è¡¨ç»“æ„</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">desc</span> xxxx<span class="token punctuation">;</span></code></pre><p>æŸ¥çœ‹æ•°æ®è¡¨æ•°æ®</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> xxxx<span class="token punctuation">;</span></code></pre><p>åˆ é™¤æ•°æ®è¡¨</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> xxxx<span class="token punctuation">;</span></code></pre><h2 id="sqlite">2. SQLite</h2><p>ç”¨äºå­˜å‚¨æœ¬åœ°appæ•°æ®</p><h2 id="æ•°æ®åº“è½¬æ¢">3. æ•°æ®åº“è½¬æ¢</h2><p>SQLiteè½¬MySQL</p><ol type="1"><li>MTç®¡ç†å™¨å¯¼å‡ºæ•°æ®åº“æ–‡ä»¶xxx.dbæˆ–è€…xxx.database(éœ€è¦é‡å‘½åä¸ºxxx.db)</li><li>DB Browser for SQLiteå°†xxx.dbå¯¼å‡ºä¸ºxxx.csvæˆ–è€…xxx.sql</li></ol>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Flaskå»ºç«™æ•™ç¨‹</title>
      <link href="/2024/03/03/Web/flasksite/"/>
      <url>/2024/03/03/Web/flasksite/</url>
      
        <content type="html"><![CDATA[<h1 id="flaskå»ºç«™æ•™ç¨‹">Flaskå»ºç«™æ•™ç¨‹</h1><p>ä»…é’ˆå¯¹å®å¡”é¢æ¿çš„å»ºç«™æ•™ç¨‹ã€‚</p><h2 id="å»ºç«™ç±»å‹">å»ºç«™ç±»å‹</h2><ol type="1"><li>é™æ€èµ„æºç«™é€‰æ‹©HTMLé¡¹ç›®</li><li>æœ‰å¯æ‰§è¡Œæ–‡ä»¶çš„é€‰æ‹©å¯¹åº”çš„é¡¹ç›®ï¼Œå¦‚PHPé¡¹ç›®ã€Nodeé¡¹ç›®ã€Pythoné¡¹ç›®ã€Javaé¡¹ç›®ã€Goé¡¹ç›®ã€å…¶ä»–é¡¹ç›®</li><li>éé™æ€èµ„æºç«™ï¼Œä¹Ÿæ²¡æœ‰å¯æ‰§è¡Œæ–‡ä»¶çš„é€‰æ‹©çº¯é™æ€PHPé¡¹ç›®ï¼Œå¯ä»¥é…ç½®åå‘ä»£ç†ç­‰</li></ol><h2 id="å»ºç«™é€šç”¨é…ç½®">å»ºç«™é€šç”¨é…ç½®</h2><h3 id="ssl">SSL</h3><ol type="1"><li>Letâ€™s Encrypt è¯ä¹¦</li><li>DNS éªŒè¯-æ‰‹åŠ¨è§£æ-è‡ªåŠ¨ç»„åˆæ³›åŸŸå</li><li>æŒ‰ç…§æç¤ºä¿®æ”¹å¯¹åº”çš„ CloudFlare çš„ DNS è§£æ</li><li>éªŒè¯å³å¯</li></ol><h3 id="nginx">Nginx</h3><p>Nginx åŒ…å«åå‘ä»£ç†ç­‰é…ç½®ï¼Œå¯ä»¥åœ¨å®å¡”é¢æ¿ä¸­é…ç½®ï¼Œä»…è¯´æ˜serveréƒ¨åˆ†ã€‚Nginxserveré€šå¸¸åŒ…å«åŸºæœ¬é…ç½®ã€æ—¥å¿—é…ç½®ã€Locationå—ã€åå‘ä»£ç†ã€HTTPSé…ç½®ã€é‡å®šå‘ã€ç¼“å­˜é…ç½®ç­‰</p><p>å…³é”®ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>    åŸºç¡€é…ç½®    Locationå—-ç”¨äºåŒ¹é…è¯·æ±‚çš„è·¯å¾„ï¼Œå¹¶å®šä¹‰å…¶å¤„ç†æ–¹å¼-ä¾‹å¦‚è‡ªå®šä¹‰å¯ä»¥è®¿é—®çš„ç›®å½•    åå‘ä»£ç†-å…¶å®å¯ä»¥çœ‹åšç‰¹æ®Šçš„Locationå—<span class="token punctuation">&#125;</span></code></pre><h3 id="å…·ä½“æ­¥éª¤">å…·ä½“æ­¥éª¤</h3><h4 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h4><ol type="1"><li>å®‰è£…Python</li><li>å‡†å¤‡requirements.txt</li><li>åŸŸåéœ€è¦å…ˆåœ¨CloudFlareä¸­è§£æ</li></ol><h4 id="é…ç½®">é…ç½®</h4><ol type="1"><li>åˆå§‹åŒ–é…ç½®ï¼Œå¯åŠ¨æ–¹å¼gunicornï¼Œé€šä¿¡åè®®wsgiï¼Œç¯å¢ƒå˜é‡æ— ï¼Œå¯åŠ¨ç”¨æˆ·www</li><li>ç­‰å¾…å®‰è£…requirements.txtä¸­çš„ä¾èµ–</li><li>è¿›å…¥é…ç½®ç•Œé¢</li><li>é¡¹ç›®ä¿¡æ¯åŠ å…¥å¼€æœºå¯åŠ¨</li><li>åŸŸåç®¡ç†-æ·»åŠ åŸŸå</li><li>å¤–ç½‘æ˜ å°„æ‰“å¼€-å¯èƒ½éœ€è¦æå‰é…ç½®SSL</li><li>æ·»åŠ Nginxé…ç½®</li><li>é…ç½®SSLè¯ä¹¦ï¼Œæ‰“å¼€å¼ºåˆ¶HTTPS</li><li>é‡å®šå‘ï¼Œä¾‹å¦‚éwwwé‡å®šå‘åˆ°www</li><li>åœ¨<strong>è‡ªå®šä¹‰çš„ä¸‹æ–¹</strong>æ·»åŠ guniconé…ç½®</li><li>æµ‹è¯•è®¿é—®</li></ol>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Mailgunç”¨æˆ·æ‰‹å†Œ</title>
      <link href="/2024/03/03/Web/mailgun/"/>
      <url>/2024/03/03/Web/mailgun/</url>
      
        <content type="html"><![CDATA[<h1 id="mailgunç”¨æˆ·æ‰‹å†Œ">Mailgunç”¨æˆ·æ‰‹å†Œ</h1><p>ä¸ªäººä¿¡æ¯ç•Œé¢è¯·å‚è€ƒ<ahref="https://app.mailgun.com/mg/dashboard">Mailguné¢æ¿</a>ä»…ä»‹ç»httpæ¥å£çš„ä½¿ç”¨ï¼Œä¸æ¶‰åŠsmtpåè®®ã€‚ æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<ahref="https://documentation.mailgun.com/">å®˜æ–¹æ–‡æ¡£</a></p><h2 id="å‘é€é‚®ä»¶">2. å‘é€é‚®ä»¶</h2><h3 id="å‘é€åŸºæœ¬æ–‡æœ¬">2.1 å‘é€åŸºæœ¬æ–‡æœ¬</h3><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient-1@example.com \    -F to&#x3D;recipient-2@example.com \    -F subject&#x3D;&#39;Hello there!&#39; \    -F text&#x3D;&#39;Testing some Mailgun awesomeness!&#39;</code></pre><h3 id="ä»¥æ–‡æœ¬å’Œ-html-ç‰ˆæœ¬å‘é€">2.2 ä»¥æ–‡æœ¬å’Œ HTML ç‰ˆæœ¬å‘é€</h3><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient@example.com \    -F subject&#x3D;&quot;Hello there!&quot; \    -F text&#x3D;&#39;This will be the text-only version&#39; \    --form-string html&#x3D;&#39;&lt;html&gt;&lt;body&gt;&lt;p&gt;This is the HTML version&lt;&#x2F;p&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;&#39;</code></pre><h3 id="å‘é€é™„ä»¶">2.3 å‘é€é™„ä»¶</h3><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient@example.com \    -F subject&#x3D;&quot;Hello there!&quot; \    -F text&#x3D;&#39;Testing some Mailgun awesomeness!&#39; \    -F attachment&#x3D;@tps-report.txt \    -F attachment&#x3D;@cover-letter.txt</code></pre><h3 id="å‘é€å†…è”æ–‡ä»¶">2.4 å‘é€å†…è”æ–‡ä»¶</h3><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient@example.com \    -F subject&#x3D;&quot;Hello there!&quot; \    -F inline&#x3D;@logo.jpg \    --form-string html&#x3D;&#39;&lt;html&gt;&lt;body&gt;&lt;p&gt;Hello from &lt;img src&#x3D;&quot;cid:email.webp&quot;&#x2F;&gt;&lt;&#x2F;p&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;&#39;</code></pre><h3 id="è‡ªå®šä¹‰åŠŸèƒ½">2.5 è‡ªå®šä¹‰åŠŸèƒ½</h3><h4 id="ä»…å¯¹ç‰¹å®šæ¶ˆæ¯å¯ç”¨è·Ÿè¸ª">2.5.1 ä»…å¯¹ç‰¹å®šæ¶ˆæ¯å¯ç”¨è·Ÿè¸ª</h4><p>è™½ç„¶å¯ä»¥ä¸ºä»ªè¡¨æ¿ä¸­çš„æ‰€æœ‰æ¶ˆæ¯å¯ç”¨è·Ÿè¸ªï¼Œä½†ä½ ä¹Ÿå¯ä»¥æœ‰é€‰æ‹©åœ°é’ˆå¯¹æ¯æ¡æ¶ˆæ¯å¯ç”¨è·Ÿè¸ªã€‚è¦å¯ç”¨æ‰€æœ‰è·Ÿè¸ªç±»å‹ï¼Œè¯·ä½¿ç”¨â€œo:tracking=â€œyesâ€â€å‚æ•°ã€‚å¦åˆ™ï¼Œä½ å¯ä»¥ä»…å¯ç”¨å¯¹æ‰“å¼€ï¼ˆâ€˜o:tracking-opensâ€™ï¼‰æˆ–ç‚¹å‡»ï¼ˆâ€˜o:tracking-clicksâ€™ï¼‰çš„ç‰¹å®šè·Ÿè¸ªï¼š</p><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient@example.com \    -F subject&#x3D;&quot;Hello there!&quot; \    -F text&#x3D;&#39;Testing some Mailgun awesomeness!&#39; \    -F o:tracking-opens&#x3D;&quot;yes&quot;</code></pre><h4 id="ç‰¹å®šæ—¶é—´å‘é€">2.5.2 ç‰¹å®šæ—¶é—´å‘é€</h4><p>â€œo:deliverytimeâ€é€‰é¡¹å…è®¸ä½ æŒ‡å®šä½•æ—¶å‘é€ç”µå­é‚®ä»¶ã€‚ å®ƒä½¿ç”¨ RFC822æ—¥æœŸæ ¼å¼ï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡æœªæ¥ 3 å¤©ï¼ˆé™¤éè®¡è´¹è®¡åˆ’æ”¯æŒ 7å¤©æˆ–æ›´å¤šå¤©çš„å­˜å‚¨èƒ½åŠ›ï¼‰ï¼š</p><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient@example.com \    -F subject&#x3D;&quot;Hello there!&quot; \    -F text&#x3D;&#39;Testing some Mailgun awesomeness!&#39; \    -F o:deliverytime&#x3D;&#39;Fri, 14 Oct 2011 23:10:10 -0000&#39;</code></pre><h4 id="æ ‡è®°ç”µå­é‚®ä»¶">2.5.3 æ ‡è®°ç”µå­é‚®ä»¶</h4><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; \    https:&#x2F;&#x2F;api.mailgun.net&#x2F;v3&#x2F;YOUR_DOMAIN_NAME&#x2F;messages \    -F from&#x3D;&#39;Excited User &lt;postmaster@YOUR_DOMAIN_NAME&gt;&#39; \    -F to&#x3D;recipient@example.com \    -F subject&#x3D;&quot;Hello there!&quot; \    -F text&#x3D;&#39;Testing some Mailgun awesomeness!&#39; \    -F o:tag&#x3D;&#39;September newsletter&#39; \    -F o:tag&#x3D;&#39;newsletters&#39;</code></pre><h4 id="é‡æ–°å‘é€ä¹‹å‰å‘é€çš„ç”µå­é‚®ä»¶">2.5.4é‡æ–°å‘é€ä¹‹å‰å‘é€çš„ç”µå­é‚®ä»¶</h4><pre class="language-MiME" data-language="MiME"><code class="language-MiME">curl -s --user &#39;api:YOUR_API_KEY&#39; &#123;&#123;STORAGE.URL&#125;&#125; \    -F to&#x3D;&#39;bob@example.com, john@example.com&#39;</code></pre><h4 id="æ‰¹é‡å‘é€">2.5.5 æ‰¹é‡å‘é€</h4><p>Mailgun æ”¯æŒé€šè¿‡å•ä¸ª API è°ƒç”¨æˆ– SMTPä¼šè¯å‘é€ç»™ä¸€ç»„æ”¶ä»¶äººçš„åŠŸèƒ½ã€‚è¿™æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°çš„ï¼š</p><ol type="1"><li>é€šè¿‡æŒ‡å®šå¤šä¸ªæ”¶ä»¶äººç”µå­é‚®ä»¶åœ°å€ä½œä¸º toå‚æ•°å¹¶ä½¿ç”¨æ”¶ä»¶äººå˜é‡æ¥ä½¿ç”¨æ‰¹é‡å‘é€ã€‚</li><li>å°†é‚®ä»¶åˆ—è¡¨ä¸æ¨¡æ¿å˜é‡ç»“åˆä½¿ç”¨</li></ol><p>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<ahref="https://documentation.mailgun.com/docs/mailgun/user-manual/sending-messages/#batch-sending">æ‰¹é‡å‘é€</a></p><h4 id="é‚®ä»¶åˆ—è¡¨">2.5.6 é‚®ä»¶åˆ—è¡¨</h4><p>é‚®ä»¶åˆ—è¡¨æ˜¯ä½¿ç”¨ç”µå­é‚®ä»¶åˆ«åå‘å¤šä¸ªæ”¶ä»¶äººå‘é€é‚®ä»¶çš„å¥½æ–¹æ³•ã€‚å½“ä½ ä½¿ç”¨é‚®ä»¶åˆ—è¡¨æ—¶ï¼ŒMailgunå°†ä½¿ç”¨ç”µå­é‚®ä»¶åˆ«åå‘æ¯ä¸ªè®¢é˜…æˆå‘˜å‘é€é‚®ä»¶å‰¯æœ¬ã€‚ä½ å¯ä»¥ä½¿ç”¨ APIæˆ–æ§åˆ¶é¢æ¿åˆ›å»ºå’Œç»´æŠ¤è®¢é˜…è€…åˆ—è¡¨ã€‚æ­¤å¤–ï¼Œä½ å¯ä»¥ä½¿ç”¨æ¨¡æ¿å˜é‡ä¸ºé‚®ä»¶åˆ—è¡¨çš„æ¯ä¸ªæˆå‘˜åˆ›å»ºå”¯ä¸€çš„æ¶ˆæ¯ã€‚</p><p>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<ahref="https://documentation.mailgun.com/docs/mailgun/user-manual/sending-messages/#mailing-lists">é‚®ä»¶åˆ—è¡¨</a></p><h2 id="è¿½è¸ªæ¶ˆæ¯">3. è¿½è¸ªæ¶ˆæ¯</h2><h3 id="å¯ç”¨è·Ÿè¸ª">3.1 å¯ç”¨è·Ÿè¸ª</h3><p>äº‹ä»¶è·Ÿè¸ªä¼šè‡ªåŠ¨å¯ç”¨ï¼Œä½†å–æ¶ˆè®¢é˜…ã€æ‰“å¼€å’Œç‚¹å‡»é™¤å¤–ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡æ§åˆ¶é¢æ¿çš„â€œåŸŸâ€é€‰é¡¹å¡ä¸ºä½ çš„åŸŸå¯ç”¨å–æ¶ˆè®¢é˜…è·Ÿè¸ªã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨å–æ¶ˆè®¢é˜…å˜é‡æ¥ç®¡ç†æ¯æ¡æ¶ˆæ¯çš„å–æ¶ˆè®¢é˜…ã€‚</p><p>ä½ å¯ä»¥åœ¨ä¸¤ä¸ªçº§åˆ«å¯ç”¨æ‰“å¼€å’Œç‚¹å‡»è·Ÿè¸ª - æ¯ä¸ªå‘é€åŸŸå’Œæ¯ä¸ªæ¶ˆæ¯ã€‚</p><ul><li>ä½ å¯ä»¥åœ¨ç‰¹å®šåŸŸè®¾ç½®é¡µé¢çš„ â€œè·Ÿè¸ªè®¾ç½®â€éƒ¨åˆ†ä¸‹é’ˆå¯¹æ¯ä¸ªåŸŸå¯ç”¨æ‰“å¼€å’Œç‚¹å‡»è·Ÿè¸ª ã€‚</li><li>å‘é€æ¶ˆæ¯æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡è®¾ç½® o:trackingã€o:tracking-clicks å’Œo:tracking-opens å‚æ•°æ¥åˆ‡æ¢è·Ÿè¸ªã€‚è¿™å°†è¦†ç›–åŸŸçº§åˆ«è®¾ç½®ã€‚</li></ul><p>ä½ éœ€è¦å°† CNAME è®°å½•æŒ‡å‘ mailgun.orgï¼Œä»¥ä¾¿ Mailguné‡å†™é“¾æ¥å¹¶è·Ÿè¸ªæ‰“å¼€æƒ…å†µã€‚æ­¤å¤–ï¼Œé‚®ä»¶ä¸­éœ€è¦æœ‰ä¸€ä¸ª HTML éƒ¨åˆ†ï¼Œä»¥ä¾¿ Mailgunè·Ÿè¸ªæ‰“å¼€æƒ…å†µã€‚</p><h3 id="äº‹ä»¶è·Ÿè¸ª">3.2 äº‹ä»¶è·Ÿè¸ª</h3><p>Mailgun ä¼šè‡ªåŠ¨è·Ÿè¸ªä»¥ä¸‹äº‹ä»¶ï¼š</p><ol type="1"><li>acceptedï¼šMailgunæ¥å—äº†å‘é€/è½¬å‘ç”µå­é‚®ä»¶çš„è¯·æ±‚ï¼Œå¹¶ä¸”é‚®ä»¶å·²æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚</li><li>rejectedï¼šMailgun æ‹’ç»äº†å‘é€/è½¬å‘ç”µå­é‚®ä»¶çš„è¯·æ±‚ã€‚</li><li>deliveredï¼šMailgunå‘é€äº†ç”µå­é‚®ä»¶ï¼Œå¹¶è¢«æ”¶ä»¶äººç”µå­é‚®ä»¶æœåŠ¡å™¨æ¥å—ã€‚</li><li>failedï¼šMailgun æ— æ³•å°†ç”µå­é‚®ä»¶ä¼ é€åˆ°æ”¶ä»¶äººç”µå­é‚®ä»¶æœåŠ¡å™¨ã€‚</li><li>openedï¼šç”µå­é‚®ä»¶æ”¶ä»¶äººæ‰“å¼€ç”µå­é‚®ä»¶å¹¶å¯ç”¨å›¾åƒæŸ¥çœ‹ã€‚å¿…é¡»åœ¨ Mailgunæ§åˆ¶é¢æ¿ä¸­å¯ç”¨å¼€æ”¾å¼è·Ÿè¸ªï¼Œå¹¶ä¸” CNAME è®°å½•å¿…é¡»æŒ‡å‘ mailgun.orgã€‚</li><li>clickedï¼šç”µå­é‚®ä»¶æ”¶ä»¶äººå•å‡»äº†ç”µå­é‚®ä»¶ä¸­çš„é“¾æ¥ã€‚å¿…é¡»åœ¨ Mailgunæ§åˆ¶é¢æ¿ä¸­å¯ç”¨ç‚¹å‡»è·Ÿè¸ªï¼Œå¹¶ä¸” CNAME è®°å½•å¿…é¡»æŒ‡å‘ mailgun.orgã€‚</li><li>unsubscribedï¼šç”µå­é‚®ä»¶æ”¶ä»¶äººå•å‡»å–æ¶ˆè®¢é˜…é“¾æ¥ã€‚å¿…é¡»åœ¨ Mailgunæ§åˆ¶é¢æ¿ä¸­å¯ç”¨å–æ¶ˆè®¢é˜…è·Ÿè¸ªã€‚</li><li>complainedï¼šç”µå­é‚®ä»¶æ”¶ä»¶äººå•å‡»å…¶ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ä¸­çš„åƒåœ¾é‚®ä»¶æŠ•è¯‰æŒ‰é’®ã€‚åé¦ˆå¾ªç¯ä½¿Mailgun èƒ½å¤Ÿæ¥æ”¶é€šçŸ¥ã€‚</li><li>storedï¼šMail å·²å­˜å‚¨ä¼ å…¥æ¶ˆæ¯ã€‚</li><li>list_member_uploadedï¼šæ­¤äº‹ä»¶åœ¨æˆåŠŸå°†æˆå‘˜æ·»åŠ åˆ°é‚®ä»¶åˆ—è¡¨åå‘ç”Ÿã€‚</li><li>list_member_upload_errorï¼šå¦‚æœå°†æˆå‘˜æ·»åŠ åˆ°é‚®ä»¶åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯ï¼Œç”šè‡³ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</li><li>list_uploadedï¼šæ­¤äº‹ä»¶åœ¨æˆåŠŸå°†å¤§é‡æˆå‘˜ä¸Šä¼ åˆ°é‚®ä»¶åˆ—è¡¨åå‘ç”Ÿã€‚</li></ol><p>ä½ å¯ä»¥é€šè¿‡å‡ ä¸ªæ¥å£è®¿é—®äº‹ä»¶ï¼š</p><ol type="1"><li>Webhooksï¼ˆæˆ‘ä»¬å°†æ•°æ®å‘å¸ƒåˆ°ä½ çš„ URLï¼‰</li><li>äº‹ä»¶ APIï¼ˆä½ é€šè¿‡ API è·å–æ•°æ®ï¼‰</li><li>æ§åˆ¶é¢æ¿ (GUI) çš„ æ—¥å¿—é€‰é¡¹ å¡</li></ol><h3 id="ç½‘ç»œé’©å­">3.3 ç½‘ç»œé’©å­</h3><p>å½“ä½ çš„é‚®ä»¶å‘ç”Ÿäº‹ä»¶æ—¶ï¼ŒMailgun å¯ä»¥å‘ä½ çš„ URL å‘å‡º HTTP/HTTPSPOSTã€‚å¦‚æœä½ å¸Œæœ› Mailgunç”šè‡³å¯ä»¥å‘å¸ƒé€šçŸ¥ï¼Œä½ éœ€è¦åœ¨æ§åˆ¶é¢æ¿çš„Webhooksé€‰é¡¹å¡ä¸­æä¾›å›è°ƒ URLã€‚Webhook ä½äºåŸŸçº§åˆ«ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨åŸŸä¸‹æ‹‰é€‰æ‹©å™¨ä¸ºæ¯ä¸ªåŸŸæä¾›å”¯ä¸€çš„URLã€‚</p><ul><li>æ³¨æ„ï¼šå¦‚æœè¦åŒ…å« HTTPS ç«¯ç‚¹ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å—ä¿¡ä»»çš„CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ç­¾åçš„ SSL è¯ä¹¦ï¼ˆè€Œä¸æ˜¯è‡ªç­¾åè¯ä¹¦ï¼‰å¯¹å…¶è¿›è¡Œé…ç½®ã€‚</li></ul><p>ä½ å¯ä»¥é˜…è¯»æœ‰å…³ä¸‹é¢ç›¸åº”éƒ¨åˆ†ä¸­å‘å¸ƒçš„æ•°æ®çš„æ›´å¤šä¿¡æ¯ï¼ˆè·Ÿè¸ªæ‰“å¼€ã€è·Ÿè¸ªç‚¹å‡»ã€è·Ÿè¸ªé€€è®¢ã€è·Ÿè¸ªåƒåœ¾é‚®ä»¶æŠ•è¯‰ã€è·Ÿè¸ªå¤±è´¥ã€è·Ÿè¸ªé€’é€ï¼‰ã€‚æˆ‘ä»¬å»ºè®®ä½¿ç”¨<ahref="http://bin.mailgun.net/" class="uri">http://bin.mailgun.net/</a>åˆ›å»ºä¸´æ—¶ URL æ¥æµ‹è¯•å’Œè°ƒè¯•ä½ çš„ Webhooksã€‚</p><p>å¯¹äº Webhook POSTï¼ŒMailgunä¼šä¾¦å¬æ¥è‡ªæœåŠ¡å™¨çš„ä»¥ä¸‹ä»£ç å¹¶åšå‡ºç›¸åº”ååº”ï¼š</p><ol type="1"><li>å¦‚æœ Mailgun æ”¶åˆ° 200ï¼ˆæˆåŠŸï¼‰ä»£ç ï¼Œå®ƒå°†ç¡®å®š Webhook POSTæˆåŠŸå¹¶ä¸”ä¸ä¼šé‡è¯•ã€‚</li><li>å¦‚æœ Mailgun æ”¶åˆ° 406ï¼ˆä¸å¯æ¥å—ï¼‰ä»£ç ï¼ŒMailgun å°†ç¡®å®š POSTè¢«æ‹’ç»å¹¶ä¸”ä¸ä¼šé‡è¯•ã€‚</li><li>å¯¹äºä»»ä½•å…¶ä»–ä»£ç ï¼ŒMailgun å°†æ ¹æ®ä»¥ä¸‹ Webhooks çš„æ—¶é—´è¡¨é‡è¯•POSTingï¼ˆé€è¾¾é€šçŸ¥é™¤å¤–ï¼‰ã€‚</li></ol><p>å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ— æ³•å¤„ç† Webhook è¯·æ±‚ï¼Œä½†ä½ æ²¡æœ‰è¿”å› 406é”™è¯¯ä»£ç ï¼ŒMailgun å°†åœ¨ 8å°æ—¶å†…æŒ‰ä»¥ä¸‹æ—¶é—´é—´éš”é‡è¯•ï¼ˆé€è¾¾é€šçŸ¥é™¤å¤–ï¼‰ï¼Œç„¶ååœæ­¢å°è¯•ï¼š5 åˆ†é’Ÿã€10åˆ†é’Ÿã€15 åˆ†é’Ÿåˆ†é’Ÿã€1å°æ—¶ã€2å°æ—¶ã€4å°æ—¶ã€‚</p><h3 id="æ£€æµ‹æœºå™¨äºº">3.4 æ£€æµ‹æœºå™¨äºº</h3><p>Mailgun ä½¿ç”¨è·Ÿè¸ªåƒç´ å’Œ URLé‡å®šå‘æ¥è·Ÿè¸ªç”¨æˆ·ä½•æ—¶æ‰“å¼€é‚®ä»¶å¹¶å•å‡»ç”µå­é‚®ä»¶ä¸­çš„é“¾æ¥ã€‚ä½†æ˜¯ï¼Œæœ‰å„ç§ç¬¬ä¸‰æ–¹è‡ªåŠ¨åŒ–ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å¼€å¹¶å‘é€æ¶ˆæ¯å¹¶è·Ÿè¸ªé“¾æ¥ä»¥è¿›è¡Œç—…æ¯’æ‰«æå’Œç”¨æˆ·æ´»åŠ¨æ··æ·†ï¼Œä¾‹å¦‚AppleMail Privacy Protectionã€‚</p><p>ç”±äºè‡ªåŠ¨åŒ–ç³»ç»Ÿå¯èƒ½ä¼šå½±å“æ‰“å¼€å’Œç‚¹å‡»è·Ÿè¸ªçš„å‡†ç¡®æ€§ï¼Œå› æ­¤ Mailgunå°†å°è¯•æ£€æµ‹å…¶ä¸­ä¸€ä¸ªç³»ç»Ÿä½•æ—¶æ£€ç´¢è·Ÿè¸ªåƒç´ æˆ–å•å‡»é“¾æ¥ã€‚å½“æ£€æµ‹åˆ°æœºå™¨äººæ‰“å¼€æˆ–å•å‡»ç”µå­é‚®ä»¶ä¸­çš„é“¾æ¥æ—¶ï¼ŒMailgunå°†é€šè¿‡æ‰“å¼€/å•å‡»äº‹ä»¶ä¸­çš„ client-info.bot å­—æ®µè¿›è¡ŒæŒ‡ç¤ºã€‚</p><pre class="language-MIME" data-language="MIME"><code class="language-MIME">&#123;    &quot;client-info&quot;: &#123;      &quot;client-name&quot;: &quot;unknown&quot;,      &quot;client-type&quot;: &quot;unknown&quot;,      &quot;user-agent&quot;: &quot;Mozilla&#x2F;5.0&quot;,      &quot;device-type&quot;: &quot;unknown&quot;,      &quot;client-os&quot;: &quot;unknown&quot;,      &quot;bot&quot;: &quot;apple&quot;    &#125;,    &quot;tags&quot;: [],    &quot;timestamp&quot;: 1652883435.279025,    &quot;recipient&quot;: &quot;bot@apple.com&quot;,    &quot;geolocation&quot;: &#123;      &quot;region&quot;: &quot;Unknown&quot;,      &quot;country&quot;: &quot;US&quot;,      &quot;city&quot;: &quot;Unknown&quot;    &#125;,    &quot;event&quot;: &quot;opened&quot;,&#125;</code></pre><p>bot å­—æ®µå¯ä»¥å…·æœ‰ä»¥ä¸‹å¯èƒ½å€¼ä¹‹ä¸€ï¼š</p><ol type="1"><li>apple:è¡¨ç¤º Apple MPP æœºå™¨äºº</li><li>gmail:è¡¨ç¤º Gmail æœºå™¨äºº</li><li>generic:è¡¨ç¤ºæœªçŸ¥æœºå™¨äººï¼ˆå¾ˆå¯èƒ½æ˜¯é˜²ç«å¢™æˆ–é˜²ç—…æ¯’æ‰«æï¼‰</li><li>(empty):å¦‚æœæœºå™¨äººå­—æ®µä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæœªæ£€æµ‹åˆ°æœºå™¨äººã€‚</li></ol><h2 id="æ¥æ”¶è½¬å‘å’Œå­˜å‚¨æ¶ˆæ¯">4. æ¥æ”¶ã€è½¬å‘å’Œå­˜å‚¨æ¶ˆæ¯</h2><p>Mailgun å°†å…è®¸ä½ é€šè¿‡è·¯ç”±æ¥æ”¶ç”µå­é‚®ä»¶ï¼Œè¯¥è·¯ç”±å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>å°†ç”µå­é‚®ä»¶è½¬å‘åˆ°ä¸åŒçš„ç”µå­é‚®ä»¶åœ°å€</li><li>å°†ç”µå­é‚®ä»¶ä¸­çš„æ•°æ®å‘å¸ƒåˆ° URL</li><li>æš‚æ—¶å­˜å‚¨ç”µå­é‚®ä»¶ä»¥ä¾›åç»­é€šè¿‡ GET è¯·æ±‚æ£€ç´¢</li></ul><p>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<ahref="https://documentation.mailgun.com/docs/mailgun/user-manual/receive-forward-store/">æ¥æ”¶ã€è½¬å‘å’Œå­˜å‚¨æ¶ˆæ¯</a></p><h2 id="æµ‹è¯•è„šæœ¬">æµ‹è¯•è„šæœ¬</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json<span class="token keyword">import</span> os<span class="token keyword">import</span> random<span class="token keyword">import</span> re<span class="token keyword">import</span> requests<span class="token keyword">import</span> threading<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Environment<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> FileSystemLoader<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> select_autoescape<span class="token keyword">def</span> <span class="token function">send_email</span><span class="token punctuation">(</span>        to_addresses<span class="token punctuation">,</span>        subject<span class="token punctuation">,</span>        text<span class="token punctuation">,</span>        tag<span class="token punctuation">,</span>        html_template<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>        attachments<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>        tracking_opens<span class="token operator">=</span><span class="token string">"no"</span><span class="token punctuation">,</span>        tracking_clicks<span class="token operator">=</span><span class="token string">"no"</span><span class="token punctuation">,</span>        from_address<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"MAILGUN_FROM_ADDRESS"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"MAILGUN_API_KEY"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    domain <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"MAILGUN_DOMAIN"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> api_key <span class="token keyword">or</span> <span class="token keyword">not</span> domain <span class="token keyword">or</span> <span class="token keyword">not</span> from_address<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">None</span>    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://api.mailgun.net/v3/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>domain<span class="token punctuation">&#125;</span></span><span class="token string">/messages"</span></span>    auth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"api"</span><span class="token punctuation">,</span> api_key<span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"from"</span><span class="token punctuation">:</span> from_address<span class="token punctuation">,</span>        <span class="token string">"to"</span><span class="token punctuation">:</span> to_addresses<span class="token punctuation">,</span>        <span class="token string">"subject"</span><span class="token punctuation">:</span> subject<span class="token punctuation">,</span>        <span class="token string">"text"</span><span class="token punctuation">:</span> text<span class="token punctuation">,</span>        <span class="token string">"o:tracking-opens"</span><span class="token punctuation">:</span> tracking_opens<span class="token punctuation">,</span>        <span class="token string">"o:tracking-clicks"</span><span class="token punctuation">:</span> tracking_clicks<span class="token punctuation">,</span>        <span class="token string">"o:tag"</span><span class="token punctuation">:</span> tag<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>    <span class="token comment"># å¦‚æœæœ‰HTMLå†…å®¹ï¼Œæ·»åŠ åˆ°dataä¸­</span>    <span class="token keyword">if</span> html_template<span class="token punctuation">:</span>        data<span class="token punctuation">[</span><span class="token string">"html"</span><span class="token punctuation">]</span> <span class="token operator">=</span> html_template    <span class="token comment"># å¤„ç†é™„ä»¶</span>    files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> attachments<span class="token punctuation">:</span>        <span class="token comment"># ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ‰“å¼€æ–‡ä»¶</span>        files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"attachment"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>attachment<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>attachment<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token keyword">for</span> attachment <span class="token keyword">in</span> attachments<span class="token punctuation">]</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token comment"># å‘é€è¯·æ±‚å¹¶æ£€æŸ¥é”™è¯¯</span>        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> auth<span class="token operator">=</span>auth<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">)</span>        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è¿™å°†æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœå“åº”çŠ¶æ€ç è¡¨æ˜ä¸€ä¸ªé”™è¯¯</span>    <span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>RequestException <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token comment"># å¯¹äºæ‰€æœ‰è¯·æ±‚ç›¸å…³çš„å¼‚å¸¸</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error sending email: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">None</span>    <span class="token keyword">finally</span><span class="token punctuation">:</span>        <span class="token comment"># æ— è®ºè¯·æ±‚æˆåŠŸè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œç¡®ä¿æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶éƒ½è¢«å…³é—­</span>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> file_tuple <span class="token keyword">in</span> files<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>file_tuple<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                file_tuple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> response<span class="token keyword">def</span> <span class="token function">get_email_id</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> response <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">None</span>    response_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>    <span class="token comment"># å¦‚æœå­˜åœ¨idï¼Œè¿”å›id</span>    <span class="token keyword">if</span> <span class="token string">"id"</span> <span class="token keyword">in</span> response_dict<span class="token punctuation">:</span>        email_id <span class="token operator">=</span> response_dict<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span>        email_id_cleaned <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r"[&lt;>]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> email_id<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        email_id_cleaned <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">return</span> email_id_cleaned<span class="token comment"># å‘é€æ³¨å†ŒéªŒè¯ç </span><span class="token keyword">def</span> <span class="token function">send_email_register_code</span><span class="token punctuation">(</span>to_addresses<span class="token punctuation">,</span> code<span class="token punctuation">,</span> created_at<span class="token punctuation">)</span><span class="token punctuation">:</span>    subject <span class="token operator">=</span> <span class="token string">"æ³¨å†ŒéªŒè¯ç "</span>    text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ä½ çš„æ³¨å†ŒéªŒè¯ç ä¸ºï¼š\n"</span></span>            <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>            <span class="token string-interpolation"><span class="token string">f"æœ‰æ•ˆæœŸä¸º5åˆ†é’Ÿ\n"</span></span>            <span class="token string-interpolation"><span class="token string">f"è¯·æ³¨æ„ï¼Œå¦‚æœè¿™ä¸æ˜¯ä½ æœ¬äººçš„æ“ä½œï¼Œè¯·å¿½ç•¥å¹¶å…³é—­æ­¤é‚®ä»¶ã€‚\n"</span></span><span class="token punctuation">)</span>    tag <span class="token operator">=</span> <span class="token string">"register"</span>  <span class="token comment"># æ ‡ç­¾</span>    html_template <span class="token operator">=</span> render_template_direct<span class="token punctuation">(</span><span class="token string">"email/register.html"</span><span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">)</span>    <span class="token comment"># å‘é€é‚®ä»¶</span>    response <span class="token operator">=</span> send_email<span class="token punctuation">(</span>to_addresses<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> text<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> html_template<span class="token punctuation">)</span>    email_id <span class="token operator">=</span> get_email_id<span class="token punctuation">(</span>response<span class="token punctuation">)</span>    <span class="token keyword">return</span> email_id<span class="token comment"># jinja2æ¨¡æ¿æ¸²æŸ“</span><span class="token keyword">def</span> <span class="token function">render_template_direct</span><span class="token punctuation">(</span>template_name<span class="token punctuation">,</span> <span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># è®¾ç½®æ¨¡æ¿ç¯å¢ƒ</span>    env <span class="token operator">=</span> Environment<span class="token punctuation">(</span>        loader<span class="token operator">=</span>FileSystemLoader<span class="token punctuation">(</span><span class="token string">"templates"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        autoescape<span class="token operator">=</span>select_autoescape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"html"</span><span class="token punctuation">,</span> <span class="token string">"xml"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    template <span class="token operator">=</span> env<span class="token punctuation">.</span>get_template<span class="token punctuation">(</span>template_name<span class="token punctuation">)</span>    <span class="token keyword">return</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    send_email_register_code<span class="token punctuation">(</span><span class="token string">"xx@xx"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç«™æ­å»ºä¸­ä¸€äº›è®°å½•</title>
      <link href="/2024/03/03/Web/tracks/"/>
      <url>/2024/03/03/Web/tracks/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰ç«¯">1 å‰ç«¯</h2><h3 id="idå’Œnameçš„åŒºåˆ«">1.1 idå’Œnameçš„åŒºåˆ«</h3><p><strong>id</strong></p><ol type="1"><li>åœ¨ä¸€ä¸ªHTMLæ–‡æ¡£ä¸­ï¼Œæ¯ä¸ªå…ƒç´ çš„idå±æ€§å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚è¿™æ„å‘³ç€åŒä¸€ä¸ªé¡µé¢ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªå…ƒç´ å…·æœ‰ç›¸åŒçš„idå€¼ã€‚</li><li>idå±æ€§ä¸»è¦ç”¨äºJavaScriptå’ŒCSSã€‚åœ¨JavaScriptä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨document.getElementById()æ¥è·å–å…·æœ‰ç‰¹å®šidçš„å…ƒç´ ã€‚åœ¨CSSä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨#åè·Ÿidå€¼æ¥æŒ‡å®šæ ·å¼è§„åˆ™åº”ç”¨äºå“ªä¸ªå…ƒç´ ã€‚</li><li>idå±æ€§è¿˜å¯ç”¨äºåˆ›å»ºé¡µé¢å†…çš„é“¾æ¥é”šç‚¹ã€‚é€šè¿‡åœ¨URLåæ·»åŠ #å’Œå…ƒç´ çš„idï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°é¡µé¢ä¸Šå…·æœ‰è¯¥idçš„å…ƒç´ ã€‚</li></ol><p><strong>name</strong></p><p>nameå±æ€§ä¸»è¦ç”¨äºHTMLè¡¨å•å…ƒç´ ã€‚å½“è¡¨å•æäº¤æ—¶ï¼Œnameå±æ€§çš„å€¼ä½œä¸ºæäº¤æ•°æ®çš„é”®ï¼Œå…ƒç´ çš„å€¼ä½œä¸ºæäº¤æ•°æ®çš„å€¼ã€‚</p><h2 id="åç«¯">2 åç«¯</h2><h3 id="è·å–postæ•°æ®">2.1 è·å–postæ•°æ®</h3><ol type="1"><li>ä½¿ç”¨request.json.get(â€˜timeâ€™) å¦‚æœå‘é€çš„æ˜¯JSONæ•°æ®</li><li>ä½¿ç”¨request.form.get(â€˜timeâ€™) å¦‚æœå‘é€çš„æ˜¯è¡¨å•æ•°æ®</li><li>ä½¿ç”¨request.args.get(â€˜timeâ€™) å¦‚æœå‘é€çš„æ˜¯URLå‚æ•°</li></ol><h2 id="ç»¼åˆ">3 ç»¼åˆ</h2><h3 id="ç›®å½•é—®é¢˜">3.1 ç›®å½•é—®é¢˜</h3><p><strong>åœ¨åç«¯ä½¿ç”¨çš„æ˜¯python</strong></p><ol type="1"><li>â€œ/â€ï¼š æŒ‡çš„æ˜¯ç³»ç»Ÿæ ¹ç›®å½•ï¼Œå³ç£ç›˜æ ¹ç›®å½•</li><li>â€œ./â€ï¼š æŒ‡çš„æ˜¯å½“å‰æ–‡ä»¶ç›®å½•ï¼ŒåŒä¸åŠ ä»»ä½•ç¬¦å·(./xxxå’Œxxxæ˜¯ä¸€æ ·çš„)</li><li>â€œ../â€ï¼šæŒ‡çš„æ˜¯å½“å‰æ–‡ä»¶çš„ä¸Šä¸€çº§ç›®å½•</li></ol><p><strong>åœ¨å‰ç«¯</strong></p><ol type="1"><li>â€œ/â€ï¼š ä»åŸŸçš„æ ¹å¼€å§‹æŸ¥æ‰¾èµ„æº</li><li>â€œ./â€ï¼šä»å½“å‰é¡µé¢çš„ç›¸å¯¹ä½ç½®æŸ¥æ‰¾èµ„æº</li></ol>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç«™æ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythonç³»åˆ—ä¹‹requests</title>
      <link href="/2024/02/28/Python/requests/"/>
      <url>/2024/02/28/Python/requests/</url>
      
        <content type="html"><![CDATA[<h1 id="requests">requests</h1><p><code>requests</code> æ˜¯ä¸€ä¸ªç”¨äºå‘é€ HTTP è¯·æ±‚çš„ Pythonåº“ã€‚å®ƒæä¾›äº†ç®€å•æ˜“ç”¨çš„ APIï¼Œå¯ä»¥è½»æ¾åœ°ä¸ Web æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ å®ƒæ”¯æŒGETã€POSTã€PUTã€DELETE ç­‰å¤šç§ HTTP æ–¹æ³•ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†Cookiesã€ä¼šè¯ã€æ–‡ä»¶ä¸Šä¼ ç­‰å¸¸è§çš„ Web æ“ä½œã€‚</p><h2 id="å®‰è£…">1 å®‰è£…</h2><pre class="language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> requests</code></pre><h2 id="ä½¿ç”¨">2 ä½¿ç”¨</h2><h3 id="get-è¯·æ±‚">2.1 GET è¯·æ±‚</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"https://api.example.com/data"</span>  <span class="token comment"># æ›¿æ¢ä¸ºå®é™…çš„ API URL</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>response_time <span class="token operator">=</span> response<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–å“åº”æ—¶é—´</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å°†å“åº”å†…å®¹è§£æä¸º JSON æ ¼å¼</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å“åº”æ—¶é—´ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response_time<span class="token punctuation">&#125;</span></span><span class="token string"> ç§’"</span></span><span class="token punctuation">)</span></code></pre><h3 id="post-è¯·æ±‚">2.2 POST è¯·æ±‚</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"https://api.example.com/data"</span>  <span class="token comment"># æ›¿æ¢ä¸ºå®é™…çš„ API URL</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"key1"</span><span class="token punctuation">:</span> <span class="token string">"value1"</span><span class="token punctuation">,</span>    <span class="token string">"key2"</span><span class="token punctuation">:</span> <span class="token string">"value2"</span><span class="token punctuation">&#125;</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> json<span class="token operator">=</span>data<span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨ json å‚æ•°è‡ªåŠ¨å°†æ•°æ®è½¬æ¢ä¸º JSON æ ¼å¼</span>response_time <span class="token operator">=</span> response<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–å“åº”æ—¶é—´</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">201</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ•°æ®å·²æˆåŠŸå‘é€"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å“åº”å†…å®¹ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>text<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å“åº”æ—¶é—´ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response_time<span class="token punctuation">&#125;</span></span><span class="token string"> ç§’"</span></span><span class="token punctuation">)</span></code></pre><h3 id="å¤„ç†-cookies">2.3 å¤„ç† Cookies</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"https://api.example.com/login"</span>  <span class="token comment"># æ›¿æ¢ä¸ºå®é™…çš„ç™»å½• URL</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"your_username"</span><span class="token punctuation">,</span>    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"your_password"</span><span class="token punctuation">&#125;</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>response_time <span class="token operator">=</span> response<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–å“åº”æ—¶é—´</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>    <span class="token comment"># ç™»å½•æˆåŠŸï¼Œè·å– Cookies</span>    cookies <span class="token operator">=</span> response<span class="token punctuation">.</span>cookies    <span class="token comment"># ä½¿ç”¨ Cookies å‘é€åç»­è¯·æ±‚</span>    url <span class="token operator">=</span> <span class="token string">"https://api.example.com/user_data"</span>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">)</span>    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>        user_data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ç™»å½•å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre><h3 id="ä¸Šä¼ æ–‡ä»¶">2.4 ä¸Šä¼ æ–‡ä»¶</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"https://api.example.com/upload"</span>  <span class="token comment"># æ›¿æ¢ä¸ºå®é™…çš„æ–‡ä»¶ä¸Šä¼  URL</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>    files <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"file"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"filename.txt"</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">"text/plain"</span><span class="token punctuation">)</span>  <span class="token comment"># (æ–‡ä»¶å, æ–‡ä»¶å¯¹è±¡, MIMEç±»å‹)</span>    <span class="token punctuation">&#125;</span>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">)</span>    response_time <span class="token operator">=</span> response<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–å“åº”æ—¶é—´</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å“åº”æ—¶é—´ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response_time<span class="token punctuation">&#125;</span></span><span class="token string"> ç§’"</span></span><span class="token punctuation">)</span></code></pre><h3 id="è®¾ç½®è¯·æ±‚å¤´">2.5 è®¾ç½®è¯·æ±‚å¤´</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"https://api.example.com/data"</span>  <span class="token comment"># æ›¿æ¢ä¸ºå®é™…çš„ API URL</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string">"Bearer your_token_here"</span><span class="token punctuation">,</span>  <span class="token comment"># æ›¿æ¢ä¸ºå®é™…çš„è®¤è¯ä»¤ç‰Œ</span>    <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>    <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"My Python App"</span><span class="token punctuation">&#125;</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>response_time <span class="token operator">=</span> response<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–å“åº”æ—¶é—´</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å“åº”æ—¶é—´ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>response_time<span class="token punctuation">&#125;</span></span><span class="token string"> ç§’"</span></span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntuæ¡Œé¢å›¾æ ‡</title>
      <link href="/2023/11/21/Linux/DesktopIcon/"/>
      <url>/2023/11/21/Linux/DesktopIcon/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆ›å»ºä¸€ä¸ªå¯åŠ¨å™¨.desktopæ–‡ä»¶">åˆ›å»ºä¸€ä¸ªå¯åŠ¨å™¨ï¼ˆ.desktopæ–‡ä»¶ï¼‰</h1><p>å°†æ­¤æ–‡ä»¶ä¿å­˜åˆ° ~/.local/share/applications/ ç›®å½•ä¸‹</p><h2 id="ç©ºç™½æ–‡ä»¶">ç©ºç™½æ–‡ä»¶</h2><pre class="language-conf" data-language="conf"><code class="language-conf">[Desktop Entry]Version&#x3D;1.0Type&#x3D;ApplicationName&#x3D;Icon&#x3D;Exec&#x3D;&quot; &quot; %fComment&#x3D;Keywords&#x3D;;Categories&#x3D;;Terminal&#x3D;falseStartupWMClass&#x3D;StartupNotify&#x3D;true</code></pre><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><pre class="language-conf" data-language="conf"><code class="language-conf">[Desktop Entry]Version&#x3D;1.0Type&#x3D;ApplicationName&#x3D;PyCharm Professional EditionIcon&#x3D;&#x2F;home&#x2F;xx&#x2F;software&#x2F;pycharm-2023.2.4&#x2F;bin&#x2F;pycharm.svgExec&#x3D;&quot;&#x2F;home&#x2F;xx&#x2F;software&#x2F;pycharm-2023.2.4&#x2F;bin&#x2F;pycharm.sh&quot; %fComment&#x3D;Python IDE for Professional DevelopersKeywords&#x3D;python;ide;development;coding;programming;Categories&#x3D;Development;IDE;Terminal&#x3D;falseStartupWMClass&#x3D;jetbrains-pycharmStartupNotify&#x3D;true</code></pre><h4 id="è¯æ¡è¯´æ˜">è¯æ¡è¯´æ˜</h4><ol type="1"><li>Versionï¼šæ¡Œé¢æ¡ç›®è§„èŒƒçš„ç‰ˆæœ¬ã€‚</li><li>Typeï¼šæŒ‡å®šè¿™ä¸ªæ¡Œé¢æ¡ç›®çš„ç±»å‹ã€‚</li><li>Nameï¼šæŒ‡å®šåº”ç”¨ç¨‹åºçš„åç§°ï¼Œå³ç”¨æˆ·åœ¨èœå•æˆ–æ¡Œé¢ä¸Šçœ‹åˆ°çš„åç§°ã€‚</li><li>Iconï¼šæŒ‡å®šåº”ç”¨ç¨‹åºçš„å›¾æ ‡è·¯å¾„ã€‚</li><li>Execï¼šæŒ‡å®šå¯åŠ¨åº”ç”¨ç¨‹åºçš„å‘½ä»¤ã€‚</li><li>Commentï¼šæä¾›æœ‰å…³åº”ç”¨ç¨‹åºçš„é¢å¤–æè¿°ã€‚</li><li>Keywordsï¼šæä¾›ä¸€ç»„å…³é”®è¯ï¼Œå¸®åŠ©åœ¨æ¡Œé¢ç¯å¢ƒçš„åº”ç”¨ç¨‹åºèœå•ä¸­æ›´å®¹æ˜“åœ°æœç´¢åˆ°è¿™ä¸ªåº”ç”¨ã€‚</li><li>Categoriesï¼šå®šä¹‰äº†è¿™ä¸ªåº”ç”¨ç¨‹åºå±äºå“ªäº›åˆ†ç±»ã€‚ AudioVideo -éŸ³é¢‘å’Œè§†é¢‘ç›¸å…³çš„åº”ç”¨ç¨‹åºã€‚ Audio - åªå’ŒéŸ³é¢‘ç›¸å…³çš„åº”ç”¨ç¨‹åºã€‚ Video -åªå’Œè§†é¢‘ç›¸å…³çš„åº”ç”¨ç¨‹åºã€‚ Development - å¼€å‘å·¥å…·ï¼Œå¦‚IDEsã€ç¼–è¯‘å™¨ç­‰ã€‚ IDE- é›†æˆå¼€å‘ç¯å¢ƒ Education - æ•™è‚²ç›¸å…³çš„è½¯ä»¶ã€‚ Game - æ¸¸æˆã€‚ Graphics -å›¾å½¢å¤„ç†è½¯ä»¶ï¼Œå¦‚å›¾åƒç¼–è¾‘å™¨ã€æŸ¥çœ‹å™¨ç­‰ã€‚ Network -ç½‘ç»œç›¸å…³çš„åº”ç”¨ç¨‹åºï¼Œå¦‚æµè§ˆå™¨ã€èŠå¤©å®¢æˆ·ç«¯ç­‰ã€‚ Office -åŠå…¬è½¯ä»¶ï¼Œå¦‚æ–‡å­—å¤„ç†ã€è¡¨æ ¼åˆ¶ä½œç­‰ã€‚ Science -ç§‘å­¦ç›¸å…³è½¯ä»¶ï¼Œå¦‚æ•°å­¦ã€å¤©æ–‡å­¦ç­‰ã€‚ Settings - ç³»ç»Ÿè®¾ç½®æˆ–é…ç½®å·¥å…·ã€‚ System- ç³»ç»Ÿå·¥å…·æˆ–å®ç”¨ç¨‹åºã€‚ Utility - å°å·¥å…·æˆ–è¾…åŠ©åº”ç”¨ç¨‹åºã€‚</li><li>Terminalï¼šæŒ‡å®šå¯åŠ¨åº”ç”¨ç¨‹åºæ—¶æ˜¯å¦éœ€è¦æ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ã€‚</li><li>StartupWMClassï¼šæŒ‡å®šçª—å£ç®¡ç†å™¨ç±»ï¼ˆWMClassï¼‰ï¼Œç”¨äºå°†åº”ç”¨ç¨‹åºçª—å£ä¸è¿™ä¸ª .desktop æ–‡ä»¶å…³è”ã€‚ä»»åŠ¡æ ä¸­æ˜¾ç¤º</li><li>StartupNotifyï¼šå¯åŠ¨è¿™ä¸ªåº”ç”¨ç¨‹åºæ—¶æ¡Œé¢ç¯å¢ƒä¼šæ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥ï¼Œé€šå¸¸æ˜¯ä¸€ç§è§†è§‰åé¦ˆï¼Œè¡¨æ˜åº”ç”¨æ­£åœ¨å¯åŠ¨ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Android-ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰</title>
      <link href="/2023/10/05/Android/MainThread/"/>
      <url>/2023/10/05/Android/MainThread/</url>
      
        <content type="html"><![CDATA[<h1 id="android-ä¸»çº¿ç¨‹uiçº¿ç¨‹">Android ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰</h1><p>æœ¬æ–‡ä»‹ç»äº†Androidä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰çš„æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œæ“ä½œã€‚</p><h2 id="ä¸»çº¿ç¨‹uiçº¿ç¨‹">ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰</h2><p>åœ¨Androidåº”ç”¨ä¸­ï¼Œä¸»çº¿ç¨‹æ˜¯è´Ÿè´£ç®¡ç†ç”¨æˆ·ç•Œé¢çš„çº¿ç¨‹ã€‚æ‰€æœ‰çš„UIæ›´æ–°ï¼ˆå¦‚è®¾ç½®æ–‡æœ¬è§†å›¾çš„æ–‡æœ¬ã€æ›´æ”¹è§†å›¾çš„å¯è§æ€§ç­‰ï¼‰éƒ½å¿…é¡»åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œã€‚è¿™æ˜¯å› ä¸ºAndroidçš„UIå·¥å…·åŒ…ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä»å…¶ä»–çº¿ç¨‹ç›´æ¥æ“ä½œUIå¯èƒ½å¯¼è‡´åº”ç”¨å´©æºƒæˆ–ä¸å¯é¢„è§çš„è¡Œä¸ºã€‚</p><h2 id="åå°çº¿ç¨‹éuiçº¿ç¨‹">åå°çº¿ç¨‹ï¼ˆéUIçº¿ç¨‹ï¼‰</h2><p>ç”¨äºæ‰§è¡Œè€—æ—¶æ“ä½œï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œç­‰ï¼Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œè¿™äº›è€—æ—¶æ“ä½œä¼šå¯¼è‡´åº”ç”¨æ— å“åº”ã€‚</p><ol type="1"><li>æ•°æ®å¤„ç†å’Œè½¬æ¢</li><li>å†™å…¥æˆ–è¯»å–æ–‡ä»¶ï¼ˆéUIæ“ä½œï¼‰</li><li>å‘é€ç½‘ç»œè¯·æ±‚ï¼ˆå¦‚æœæœ‰ç‰¹æ®Šçš„å®ç°ï¼Œéœ€è¦åœ¨ç‰¹å®šçº¿ç¨‹ä¸Šæ‰§è¡Œï¼‰</li><li>è®°å½•æˆ–åˆ†ææ•°æ®</li></ol><h2id="ä¸ºä»€ä¹ˆéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œuiæ“ä½œ">ä¸ºä»€ä¹ˆéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡ŒUIæ“ä½œï¼Ÿ</h2><p>å¦‚æœåœ¨åå°çº¿ç¨‹ä¸Šç›´æ¥æ›´æ–°UIï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š</p><ol type="1"><li>åº”ç”¨å´©æºƒï¼šç”±äºAndroidUIç»„ä»¶ä¸æ”¯æŒä»éUIçº¿ç¨‹è®¿é—®ï¼Œç›´æ¥åœ¨åå°çº¿ç¨‹ä¸Šæ“ä½œUIå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å´©æºƒã€‚</li><li>ä¸ä¸€è‡´å’Œä¸å¯é¢„æµ‹çš„è¡Œä¸ºï¼šUIå¯èƒ½ä¸ä¼šæŒ‰ç…§é¢„æœŸæ›´æ–°ï¼Œæˆ–è€…å®Œå…¨ä¸æ›´æ–°ã€‚</li></ol><h2 id="å¦‚ä½•åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œæ“ä½œ">å¦‚ä½•åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œæ“ä½œï¼Ÿ</h2><p>åœ¨Androidä¸­ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥ç¡®ä¿ä»£ç åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œ</p><h3 id="runonuithreadæ–¹æ³•">1 runOnUiThreadæ–¹æ³•</h3><h4 id="activity-ä¸­">1.1 Activity ä¸­</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// UIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="fragment-ä¸­">2.2 Fragment ä¸­</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// UIæ“ä½œ</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="handler">2 Handler</h3><p>Handler ç»‘å®šåˆ°ä¸»çº¿ç¨‹çš„ Looper å¯ä»¥ç”¨æ¥åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»£ç ã€‚ è¿™ç§æ–¹æ³•åœ¨Activity, Fragment, æˆ–ä»»ä½•å…¶ä»–ä¸Šä¸‹æ–‡ä¸­éƒ½å¾ˆæœ‰ç”¨ã€‚</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// UIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åŠ å…¥å»¶è¿Ÿ</span><span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// éUIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>å¦å¤–å¦‚æœéä¸»çº¿ç¨‹ä½¿ç”¨ Handler</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// UIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åŠ å…¥å»¶è¿Ÿ</span><span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// éUIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="viewçš„-post-æ–¹æ³•">3 Viewçš„ post æ–¹æ³•</h3><p>ä»»ä½•ç»§æ‰¿è‡ª View çš„ç±»ï¼Œå¦‚ Button æˆ– TextViewï¼Œéƒ½æœ‰ä¸€ä¸ª post(Runnableaction) æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»£ç ã€‚</p><pre class="language-java" data-language="java"><code class="language-java">myView<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// UIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="viewmodelçš„-livedata">4 ViewModelçš„ LiveData</h3><p>å½“ä½¿ç”¨ LiveData ä¸ ViewModel ç»“åˆæ—¶ï¼Œè§‚å¯Ÿ LiveDataçš„ä»£ç é»˜è®¤åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚å› æ­¤ï¼Œæ›´æ–° LiveDataé€šå¸¸ä¼šå¯¼è‡´åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡ŒUIæ“ä½œã€‚</p><pre class="language-java" data-language="java"><code class="language-java">myLiveData<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// UIæ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> å®‰å“ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythonç³»åˆ—ä¹‹pyinstaller</title>
      <link href="/2023/04/20/Python/py2exe/"/>
      <url>/2023/04/20/Python/py2exe/</url>
      
        <content type="html"><![CDATA[<h1 id="pyinstaller">PyInstaller</h1><p>PyInstaller æ˜¯ä¸€ä¸ªå°† Python ç¨‹åºæ‰“åŒ…æˆç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶çš„å·¥å…·ï¼Œæ”¯æŒWindowsã€Linux å’Œ macOS ç­‰å¹³å°ã€‚å®ƒå¯ä»¥å°†Pythonè§£é‡Šå™¨å’Œæ‰€æœ‰ä¾èµ–çš„åº“æ‰“åŒ…åˆ°ä¸€ä¸ªå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä½¿å¾—ç”¨æˆ·æ— éœ€å®‰è£…Python ç¯å¢ƒå³å¯è¿è¡Œç¨‹åºã€‚</p><p>åœ¨ Python ä¸­æ‰“åŒ…æˆ EXE ä¸”è¦æ±‚æ— å¼¹çª—ã€ä½“ç§¯å°ï¼Œæ¨èä½¿ç”¨ PyInstaller +UPX å‹ç¼©ã€‚</p><h2 id="å®‰è£…å¿…è¦å·¥å…·">1. å®‰è£…å¿…è¦å·¥å…·</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å®‰è£… PyInstaller</span>pip <span class="token function">install</span> pyinstaller</code></pre><p>ä¸‹è½½ <a href="https://github.com/upx/upx/releases">UPX</a>å¹¶è§£å‹åˆ°ä»»æ„ç›®å½•</p><h2 id="æ‰“åŒ…å‘½ä»¤">2. æ‰“åŒ…å‘½ä»¤</h2><pre class="language-bash" data-language="bash"><code class="language-bash">pyinstaller <span class="token parameter variable">--onefile</span> <span class="token parameter variable">--noconsole</span> <span class="token parameter variable">--name</span> app <span class="token parameter variable">--icon</span><span class="token operator">=</span>logo.ico --add-data<span class="token operator">=</span><span class="token string">"xxx;."</span> --upx-dir<span class="token operator">=</span><span class="token string">"D:\upx-5.0.0-win64"</span> <span class="token parameter variable">--clean</span> --exclude-module<span class="token operator">=</span>tests app.py</code></pre><p><strong>å‚æ•°è¯´æ˜</strong>ï¼š</p><ul><li><code>--onefile</code>ï¼šç”Ÿæˆå•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶</li><li><code>--noconsole</code>ï¼šç¦ç”¨æ§åˆ¶å°çª—å£ï¼ˆGUIç¨‹åºå¿…é€‰ï¼‰</li><li><code>--name</code>ï¼šæŒ‡å®šç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åç§°</li><li><code>--icon</code>ï¼šæŒ‡å®šå›¾æ ‡æ–‡ä»¶è·¯å¾„</li><li><code>--add-data</code>ï¼šæ·»åŠ é¢å¤–æ•°æ®æ–‡ä»¶ï¼ˆå¦‚å›¾æ ‡ç­‰ï¼‰</li><li><code>--upx-dir</code>ï¼šæŒ‡å®š UPX è·¯å¾„è¿›è¡ŒäºŒè¿›åˆ¶å‹ç¼©ï¼ˆä½“ç§¯å‡å°‘30-50%ï¼‰</li><li><code>--clean</code>ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶</li><li><code>--exclude-module</code>ï¼šæ’é™¤ä¸éœ€è¦çš„æ¨¡å—</li></ul><p><strong>æ³¨æ„äº‹é¡¹</strong>:</p><ol type="1"><li>è‹¥å›¾æ ‡ä»…ä½œä¸ºEXEæ–‡ä»¶çš„æ˜¾ç¤ºå›¾æ ‡ä½¿ç”¨ï¼Œæ— éœ€<code>--add-data</code>å‚æ•°ã€‚</li><li><code>--add-data</code>å‚æ•°åœ¨Windowså’ŒLinuxä¸‹çš„åˆ†éš”ç¬¦ä¸åŒï¼š<ul><li>Windowsï¼šä½¿ç”¨åˆ†å· <code>;</code> ä½œä¸ºè·¯å¾„åˆ†éš”ç¬¦</li><li>Linuxï¼šä½¿ç”¨å†’å· <code>:</code> ä½œä¸ºè·¯å¾„åˆ†éš”ç¬¦</li></ul></li><li>å¯ä½¿ç”¨æ›´å°çš„ Python åŸºç¡€ç¯å¢ƒï¼ˆæ¨è Python3.11+ï¼Œè‡ªå¸¦æ›´å°çš„åµŒå…¥åŒ…ï¼‰</li></ol><h2 id="æ‰“åŒ…ç¤ºä¾‹">3. æ‰“åŒ…ç¤ºä¾‹</h2><h3 id="æ‰“åŒ…å¸¦å›¾æ ‡çš„-exe-æ–‡ä»¶">3.1. æ‰“åŒ…å¸¦å›¾æ ‡çš„ EXE æ–‡ä»¶</h3><pre class="language-bash" data-language="bash"><code class="language-bash">pyinstaller <span class="token parameter variable">--onefile</span> <span class="token parameter variable">--noconsole</span> <span class="token parameter variable">--name</span> app <span class="token parameter variable">--icon</span><span class="token operator">=</span>logo.ico --upx-dir<span class="token operator">=</span><span class="token string">"D:\upx-5.0.0-win64"</span> <span class="token parameter variable">--clean</span> app.py</code></pre><h3 id="æ‰“åŒ…å¸¦æ•°æ®æ–‡ä»¶çš„-exe-æ–‡ä»¶">3.2. æ‰“åŒ…å¸¦æ•°æ®æ–‡ä»¶çš„ EXE æ–‡ä»¶</h3><pre class="language-bash" data-language="bash"><code class="language-bash">pyinstaller <span class="token parameter variable">--onefile</span> <span class="token parameter variable">--noconsole</span> <span class="token parameter variable">--name</span> app <span class="token parameter variable">--icon</span><span class="token operator">=</span>logo.ico --add-data<span class="token operator">=</span><span class="token string">"logo.ico;."</span> --upx-dir<span class="token operator">=</span><span class="token string">"D:\upx-5.0.0-win64"</span> <span class="token parameter variable">--clean</span> app.py</code></pre><p>ç„¶ååœ¨ä»£ç ä¸­ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è·å–èµ„æºæ–‡ä»¶è·¯å¾„ï¼š</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># è·å–å½“å‰å¯æ‰§è¡Œæ–‡ä»¶çš„ç›®å½•</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token comment"># å½“ç”¨ PyInstaller æ‰“åŒ…æ—¶ï¼Œå¦‚æœç¨‹åºè¢«â€œå†»ç»“â€ï¼ˆä¹Ÿå°±æ˜¯è¢«æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œsys.frozen çš„å€¼ä¸º Trueï¼Œå¦åˆ™ä¸º Falseã€‚</span><span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token string">'frozen'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># å½“å‰ç›®å½•ä¸ºå½“å‰å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•</span>    application_path <span class="token operator">=</span> sys<span class="token punctuation">.</span>_MEIPASS<span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token comment"># å½“å‰ç›®å½•ä¸ºå½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•</span>    application_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token comment"># è·å–èµ„æºæ–‡ä»¶çš„è·¯å¾„</span>icon_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>application_path<span class="token punctuation">,</span> <span class="token string">'example.ico'</span><span class="token punctuation">)</span></code></pre><h2 id="æ›¿ä»£æ–¹æ¡ˆnuitka">4. æ›¿ä»£æ–¹æ¡ˆNuitka</h2><p><a href="https://github.com/Nuitka/Nuitka">Nuitka</a> æ˜¯ä¸€ä¸ª Pythonåˆ° C++ çš„ç¼–è¯‘å™¨ï¼Œå¯ä»¥å°† Pythonä»£ç ç¼–è¯‘æˆç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯å¯ä»¥ç”Ÿæˆæ›´é«˜æ•ˆçš„ä»£ç ï¼Œæ‰“åŒ…åçš„ç¨‹åºè¿è¡Œé€Ÿåº¦æ›´å¿«ã€‚ä½†æ˜¯Nuitka çš„ä½¿ç”¨ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦å®‰è£… C++ ç¼–è¯‘å™¨ï¼Œå¹¶ä¸”ç¼–è¯‘é€Ÿåº¦è¾ƒæ…¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Conda</title>
      <link href="/2023/03/22/TechnicalNotes/Conda/"/>
      <url>/2023/03/22/TechnicalNotes/Conda/</url>
      
        <content type="html"><![CDATA[<h2 id="condaå®‰è£…">1 Condaå®‰è£…</h2><p>æ¨èä½¿ç”¨<ahref="https://www.anaconda.com/download">Miniconda</a>ã€‚</p><h2 id="condaå¸¸ç”¨å‘½ä»¤">2 Condaå¸¸ç”¨å‘½ä»¤</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ›å»ºç¯å¢ƒ</span>conda create <span class="token parameter variable">-n</span> myenv <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.8</span><span class="token comment"># æ¿€æ´»ç¯å¢ƒ</span>conda activate myenv<span class="token comment"># å…³é—­ç¯å¢ƒ</span>conda deactivate<span class="token comment"># åˆ é™¤ç¯å¢ƒ</span>conda remove <span class="token parameter variable">-n</span> myenv <span class="token parameter variable">--all</span></code></pre><h2 id="condaæ›´æ–°">3 Condaæ›´æ–°</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ›´æ–°conda</span>conda update conda<span class="token comment"># æœç´¢Pythonç‰ˆæœ¬</span>conda search python<span class="token comment"># å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Python</span>conda <span class="token function">install</span> <span class="token assign-left variable">python</span><span class="token operator">=</span>x.x.x<span class="token comment"># æ›´æ–°Pythonåˆ°æœ€æ–°ç‰ˆæœ¬</span>conda update python</code></pre><h2 id="condaå®‰è£…åŒ…">4 Condaå®‰è£…åŒ…</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æœç´¢åŒ…</span>conda search numpy<span class="token comment"># å®‰è£…åŒ…</span>conda <span class="token function">install</span> numpy<span class="token comment"># å¸è½½åŒ…</span>conda remove numpy</code></pre><h2 id="condaæŸ¥çœ‹ä¿¡æ¯">5 CondaæŸ¥çœ‹ä¿¡æ¯</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æŸ¥çœ‹å·²å®‰è£…çš„åŒ…</span>conda list<span class="token comment"># æŸ¥çœ‹æ‰€æœ‰ç¯å¢ƒ</span>conda <span class="token function">env</span> list<span class="token comment"># æŸ¥çœ‹å½“å‰ç¯å¢ƒä¿¡æ¯</span>conda info</code></pre><h2 id="condaå¯¼å‡ºç¯å¢ƒ">6 Condaå¯¼å‡ºç¯å¢ƒ</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å¯¼å‡ºç¯å¢ƒåˆ°æ–‡ä»¶</span>conda <span class="token function">env</span> <span class="token builtin class-name">export</span> <span class="token operator">></span> environment.yml<span class="token comment"># ä»æ–‡ä»¶åˆ›å»ºç¯å¢ƒ</span>conda <span class="token function">env</span> create <span class="token parameter variable">-f</span> environment.yml</code></pre><h2 id="condaæ¸…ç†">7 Condaæ¸…ç†</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ¸…ç†æœªä½¿ç”¨çš„åŒ…å’Œç¼“å­˜</span>conda clean <span class="token parameter variable">-a</span><span class="token comment"># æ¸…ç†ç´¢å¼•ç¼“å­˜</span>conda clean <span class="token parameter variable">-i</span><span class="token comment"># æ¸…ç†åŒ…ç¼“å­˜</span>conda clean <span class="token parameter variable">-p</span><span class="token comment"># æ¸…ç†taråŒ…ç¼“å­˜</span>conda clean <span class="token parameter variable">-t</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>PowerShellå‘½ä»¤</title>
      <link href="/2023/03/01/TechnicalNotes/Commands/"/>
      <url>/2023/03/01/TechnicalNotes/Commands/</url>
      
        <content type="html"><![CDATA[<h2 id="cdnä¸‹è½½æ–‡ä»¶">1 CDNä¸‹è½½æ–‡ä»¶</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-o</span> jquery.min.js https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js<span class="token comment"># -o: æŒ‡å®šè¾“å‡ºæ–‡ä»¶åœ°å€å’Œåç§°</span></code></pre><h2 id="windows-powershell-æ›´æ–°">2 Windows PowerShell æ›´æ–°</h2><h3 id="æ˜¾ç¤ºå½“å‰çš„-powershell-ç‰ˆæœ¬å·">æ˜¾ç¤ºå½“å‰çš„ PowerShell ç‰ˆæœ¬å·</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$PSVersionTable</span>.PSVersion</code></pre><h3id="æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬å®˜æ–¹æ­£ç‰ˆçš„æ˜¯-id-å¸¦æœ‰-microsoft-å‰ç¼€">æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ï¼ˆå®˜æ–¹æ­£ç‰ˆçš„æ˜¯ID å¸¦æœ‰ Microsoft å‰ç¼€ï¼‰</h3><pre class="language-bash" data-language="bash"><code class="language-bash">winget search powershell</code></pre><h3 id="ä½¿ç”¨-winget-å®‰è£…-powershell">ä½¿ç”¨ Winget å®‰è£… PowerShell</h3><pre class="language-bash" data-language="bash"><code class="language-bash">winget <span class="token function">install</span> <span class="token parameter variable">--id</span> Microsoft.Powershell <span class="token parameter variable">--source</span> winget</code></pre>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Android-çŸ¥è¯†åˆé›†</title>
      <link href="/2021/11/26/Android/AndroidKnowledgeCollection/"/>
      <url>/2021/11/26/Android/AndroidKnowledgeCollection/</url>
      
        <content type="html"><![CDATA[<h1 id="androidçŸ¥è¯†åˆé›†">AndroidçŸ¥è¯†åˆé›†</h1><p>è¿™é‡Œæ˜¯AndroidçŸ¥è¯†åˆé›†ï¼ŒåŒ…å«äº†Androidå¼€å‘çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚</p><h2 id="å…³äºç»„ä»¶">å…³äºç»„ä»¶</h2><h3 id="å…³äºfragment">å…³äºFragment</h3><ol type="1"><li><p>è·å–ä¸Šä¸‹æ–‡</p><p><pre class="language-java" data-language="java"><code class="language-java"><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> è·å–çš„æ˜¯ <span class="token class-name">Fragment</span> çš„ä¸Šä¸‹æ–‡ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦ä¸ºç©º<span class="token function">requireContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> è·å–çš„æ˜¯ <span class="token class-name">Fragment</span> çš„ä¸Šä¸‹æ–‡ï¼Œå¿…é¡»æœ‰å†…å®¹ï¼Œä¸ºç©ºåˆ™æŠ¥é”™ã€‚</code></pre></p></li><li><p>è·å–ä¾é™„çš„ Activity</p><p><pre class="language-java" data-language="java"><code class="language-java"><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> è·å–çš„æ˜¯ <span class="token class-name">Fragment</span> ä¾é™„çš„ <span class="token class-name">Activity</span>ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦ä¸ºç©º<span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> è·å–çš„æ˜¯ <span class="token class-name">Fragment</span> ä¾é™„çš„ <span class="token class-name">Activity</span>ï¼Œå¿…é¡»æœ‰å†…å®¹ï¼Œä¸ºç©ºåˆ™æŠ¥é”™ã€‚</code></pre></p></li></ol><h2 id="å…³äºæ§ä»¶">å…³äºæ§ä»¶</h2><h3 id="å…³äºcheckbox">å…³äºCheckBox</h3><p>CheckBoxæŒ‰é’®å“åº”äº‹ä»¶</p><h4 id="ä½¿ç”¨-oncheckedchangelistener">1. ä½¿ç”¨OnCheckedChangeListener</h4><p>ä½¿ç”¨OnCheckedChangeListener å¯ä»¥çŸ¥é“ CheckBox çš„é€‰ä¸­çŠ¶æ€ä½•æ—¶æ›´æ”¹ã€‚è¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œå°¤å…¶æ˜¯å…³å¿ƒ CheckBox æ˜¯å¦è¢«é€‰ä¸­æ—¶ã€‚</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">CheckBox</span> checkBox <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CheckBox</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>your_checkbox_id<span class="token punctuation">)</span><span class="token punctuation">;</span>checkBox<span class="token punctuation">.</span><span class="token function">setOnCheckedChangeListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompoundButton<span class="token punctuation">.</span>OnCheckedChangeListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCheckedChanged</span><span class="token punctuation">(</span><span class="token class-name">CompoundButton</span> buttonView<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isChecked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isChecked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// å¤„ç†é€‰ä¸­çŠ¶æ€</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// å¤„ç†éé€‰ä¸­çŠ¶æ€</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="ä½¿ç”¨-onclicklistener">2. ä½¿ç”¨ OnClickListener</h4><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ OnClickListenerï¼Œåœ¨ç”¨æˆ·ç‚¹å‡» CheckBoxæ—¶è§¦å‘äº‹ä»¶ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨å…¶çŠ¶æ€æ”¹å˜æ—¶ã€‚</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">CheckBox</span> checkBox <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CheckBox</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>your_checkbox_id<span class="token punctuation">)</span><span class="token punctuation">;</span>checkBox<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// æ£€æŸ¥æ˜¯å¦é€‰ä¸­</span>        <span class="token keyword">boolean</span> checked <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CheckBox</span><span class="token punctuation">)</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>checked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// å¤„ç†é€‰ä¸­çŠ¶æ€</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// å¤„ç†éé€‰ä¸­çŠ¶æ€</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="å…³äºandroidmanifest.xml">å…³äºAndroidManifest.xml</h2><ol type="1"><li>android:exported=â€œtrueâ€: å…è®¸å…¶ä»–åº”ç”¨è®¿é—®è¯¥ç»„ä»¶</li></ol>]]></content>
      
      
      <categories>
          
          <category> å®‰å“ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Android-ROOMç»„ä»¶</title>
      <link href="/2021/11/05/Android/Room/"/>
      <url>/2021/11/05/Android/Room/</url>
      
        <content type="html"><![CDATA[<h1 id="room">ROOM</h1><p>æœ¬æ–‡ä»‹ç»äº† ROOM æ•°æ®åº“çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ã€‚</p><h2 id="room-æ•°æ®åº“">ROOM æ•°æ®åº“</h2><p>ä¸€ä¸ªdatabaseå¯ä»¥åŒæ—¶å­˜åœ¨ï¼š Nä¸ª@DAO, Nä¸ª@Entity, 1ä¸ª@Database,1ä¸ªDBEngine</p><h2 id="æŸ¥è¯¢å›è°ƒçš„ä¸¤ç§æ–¹å¼">æŸ¥è¯¢å›è°ƒçš„ä¸¤ç§æ–¹å¼</h2><p>Java 8æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨ Consumer æ¥å£çš„æ–¹æ³•ã€‚</p><h3 id="ä½¿ç”¨-consumer-æ¥å£">ä½¿ç”¨ Consumer æ¥å£</h3><p>Consumer<AccountData> æ¥å£æ˜¯ Java 8 ä¸­å¼•å…¥çš„å‡½æ•°å¼æ¥å£çš„ä¸€éƒ¨åˆ†ã€‚è¿™ç§æ–¹å¼å…è®¸ç›´æ¥åœ¨è°ƒç”¨æ–¹æ³•æ—¶å®šä¹‰å¯¹ç»“æœçš„å¤„ç†é€»è¾‘ï¼Œé€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ª lambdaè¡¨è¾¾å¼æˆ–æ–¹æ³•å¼•ç”¨ã€‚</p><p>ç‰¹ç‚¹:</p><p>çµæ´»æ€§: ç›´æ¥åœ¨è°ƒç”¨ç‚¹å®šä¹‰å¦‚ä½•å¤„ç†æ•°æ®ã€‚ ç®€æ´æ€§: ä½¿ç”¨ lambdaè¡¨è¾¾å¼å¯ä»¥ä½¿ä»£ç æ›´åŠ ç®€æ´å’Œç›´è§‚ã€‚ ä¾èµ–äº Java 8: ä¾èµ–äº Java 8çš„ç‰¹æ€§ï¼Œå¦‚å‡½æ•°å¼æ¥å£å’Œ lambda è¡¨è¾¾å¼ã€‚</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryAllDatas</span><span class="token punctuation">(</span><span class="token class-name">DataQueryCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        databaseExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">></span></span> allDatas <span class="token operator">=</span> dataDao<span class="token punctuation">.</span><span class="token function">getAllDatas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// ç¡®ä¿å›è°ƒåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼ˆå¦‚æœæ¶‰åŠUIæ“ä½œï¼‰</span>            <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> callback<span class="token punctuation">.</span><span class="token function">onDataRetrieved</span><span class="token punctuation">(</span>allDatas<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// ç›´æ¥åœ¨åå°çº¿ç¨‹å¤„ç†æ•°æ®</span>            callback<span class="token punctuation">.</span><span class="token function">onDataRetrieved</span><span class="token punctuation">(</span>allDatas<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">// å¦å¤–çš„æ¥å£æ–‡ä»¶</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataQueryCallback</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token function">onDataRetrieved</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">></span></span> dataList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ä½¿ç”¨</span><span class="token class-name">DBEngine</span> dbEngine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBEngine</span><span class="token punctuation">(</span><span class="token function">requireContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>dbEngine<span class="token punctuation">.</span><span class="token function">queryAllDatas</span><span class="token punctuation">(</span>dataList <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// åœ¨æ­¤å¤„å¤„ç†å’Œä½¿ç”¨ dataList       </span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="ä½¿ç”¨è‡ªå®šä¹‰å›è°ƒæ¥å£">ä½¿ç”¨è‡ªå®šä¹‰å›è°ƒæ¥å£</h3><p>å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„å›è°ƒæ¥å£(DataQueryCallback)ï¼Œå¹¶åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„ç±»ä¸­ä½¿ç”¨å®ƒã€‚è¿™ç§æ–¹å¼æ›´ä¼ ç»Ÿï¼Œé€šå¸¸åœ¨ Java 8 ä¹‹å‰çš„ä»£ç ä¸­æ›´å¸¸è§ã€‚</p><p>ç‰¹ç‚¹:</p><p>ç»“æ„åŒ–: é€šè¿‡å®šä¹‰ä¸€ä¸ªä¸“ç”¨çš„å›è°ƒæ¥å£ï¼Œä½¿å¾—ä»£ç çš„ç»“æ„æ›´åŠ æ¸…æ™°ã€‚å¯é‡ç”¨æ€§:å¦‚æœå¤šä¸ªåœ°æ–¹éœ€è¦ä½¿ç”¨ç›¸åŒçš„å›è°ƒé€»è¾‘ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æé«˜ä»£ç çš„å¯é‡ç”¨æ€§ã€‚é€‚ç”¨æ€§æ›´å¹¿: ä¸ä¾èµ–äº Java 8ï¼Œå¯ä»¥åœ¨æ›´è€çš„ Java ç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">querySingleAccountData</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccountData</span><span class="token punctuation">></span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        databaseWriteExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">AccountData</span> accountData <span class="token operator">=</span> accountDataDao<span class="token punctuation">.</span><span class="token function">getSingleAccountData</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>            callback<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>accountData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">// ä½¿ç”¨</span>dbEngine<span class="token punctuation">.</span><span class="token function">querySingleAccountData</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> accountData <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>accountData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// è¿™é‡Œå¤„ç†æŸ¥è¯¢åˆ°çš„ AccountData</span>                <span class="token comment">// æ³¨æ„ï¼šè¿™å¯èƒ½åœ¨åå°çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¦‚æœéœ€è¦æ›´æ–°UIï¼Œè¯·ç¡®ä¿åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œ</span>                <span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                    <span class="token comment">// æ›´æ–°UIï¼Œä¾‹å¦‚æ˜¾ç¤ºè´¦æˆ·æ•°æ®</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> å®‰å“ </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
